# é®æŒ¡é€æ˜ç³»ç»Ÿ - é—®é¢˜è§£å†³è®°å½•

**é¡¹ç›®ï¼š** Sunset  
**æ—¥æœŸï¼š** 2024-12-05  
**ç‰ˆæœ¬ï¼š** v2.0 Final

---

## ğŸ“‹ é—®é¢˜è§£å†³å†ç¨‹

### **é—®é¢˜1ï¼šé®æŒ¡æ£€æµ‹å®Œå…¨ä¸å·¥ä½œ**

**ç°è±¡ï¼š**
- ç©å®¶èµ°åˆ°æ ‘ä¸‹ï¼Œæ ‘ä¸é€æ˜
- Consoleæ— ä»»ä½•æ£€æµ‹æ—¥å¿—
- åœºæ™¯å·²æ·»åŠ OcclusionManagerå’Œç»„ä»¶

**æ’æŸ¥è¿‡ç¨‹ï¼š**

1. **æ£€æŸ¥åˆå§‹åŒ–** âœ…
   - 16æ£µæ ‘å…¨éƒ¨æ³¨å†ŒæˆåŠŸ
   - OcclusionManageråˆå§‹åŒ–å®Œæˆ
   - ç©å®¶å¼•ç”¨æ­£ç¡®

2. **æ£€æŸ¥æ ‡ç­¾é…ç½®** âŒ **é—®é¢˜å‘ç°ï¼**
   ```
   OcclusionManager.occludableTags = ["Trees", "Rocks", "Buildings"]
   æ ‘ç‰©ä½“.occlusionTags = ["Tree", "Building"]  â† å•æ•°ï¼
   
   æ ‡ç­¾ä¸åŒ¹é…ï¼æ‰€æœ‰æ ‘è¢«è¿‡æ»¤æ‰äº†ï¼
   ```

**è§£å†³æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆAï¼šç»Ÿä¸€ä½¿ç”¨å¤æ•°ï¼ˆæœ€ç»ˆé‡‡ç”¨ï¼‰**
```csharp
// OcclusionTransparency.cs é»˜è®¤æ ‡ç­¾
occlusionTags = new string[] { "Trees", "Buildings", "Rocks" };

// æ¯ä¸ªç‰©ä½“åªæœ‰è‡ªå·±çš„æ ‡ç­¾ï¼š
// - æ ‘ï¼š["Trees"]
// - å»ºç­‘ï¼š["Buildings"]  
// - å²©çŸ³ï¼š["Rocks"]
```

**å…³é”®ç‚¹ï¼š**
- ç‰©ä½“æ ‡ç­¾ = èº«ä»½æ ‡è¯†ï¼ˆ"æˆ‘æ˜¯è°"ï¼‰
- Manageræ ‡ç­¾ = æ£€æµ‹ç™½åå•ï¼ˆ"æˆ‘è¦æ£€æµ‹è°"ï¼‰
- âŒ é”™è¯¯ï¼šæŠŠæ‰€æœ‰ç±»å‹éƒ½åŠ åˆ°ä¸€ä¸ªç‰©ä½“ä¸Š
- âœ… æ­£ç¡®ï¼šæ¯ä¸ªç‰©ä½“åªæœ‰è‡ªå·±çš„ç±»å‹æ ‡ç­¾

**ç»“æœï¼š** æ ‡ç­¾åŒ¹é…åï¼Œæ£€æµ‹å¼€å§‹å·¥ä½œ âœ…

---

### **é—®é¢˜2ï¼šæ³¨å†Œæ—¶åºé—®é¢˜å¯¼è‡´é™é»˜å¤±è´¥**

**ç°è±¡ï¼š**
- éƒ¨åˆ†æ ‘æ— æ³•æ³¨å†Œåˆ°Manager
- æ— é”™è¯¯æ—¥å¿—ï¼Œé™é»˜å¤±è´¥

**åŸå› åˆ†æï¼š**

```csharp
// OcclusionTransparency.OnEnable()
void OnEnable()
{
    if (canBeOccluded)
    {
        OcclusionManager.Instance?.RegisterOccluder(this);  
        // â† é—®é¢˜ï¼Instanceå¯èƒ½è¿˜æ˜¯null
        // ?. ç©ºåˆå¹¶æ“ä½œç¬¦ä¼šé™é»˜å¤±è´¥ï¼Œä¸æŠ¥é”™
    }
}
```

**æ—¶åºé—®é¢˜ï¼š**
```
æ¸¸æˆå¯åŠ¨æ—¶ï¼š
1. OcclusionTransparency.Awake()  æ‰§è¡Œ
2. OcclusionTransparency.OnEnable() æ‰§è¡Œ â† æ­¤æ—¶Managerè¿˜æœªåˆå§‹åŒ–
3. OcclusionManager.Awake()         æ‰§è¡Œ â† Manageræ‰åœ¨è¿™é‡Œåˆå§‹åŒ–
```

**è§£å†³æ–¹æ¡ˆï¼š**

```csharp
void OnEnable()
{
    if (canBeOccluded)
    {
        StartCoroutine(RegisterDelayed());
    }
}

private IEnumerator RegisterDelayed()
{
    // ç­‰å¾…ä¸€å¸§ï¼Œç¡®ä¿æ‰€æœ‰Awakeæ‰§è¡Œå®Œæ¯•
    yield return null;
    
    if (OcclusionManager.Instance != null)
    {
        OcclusionManager.Instance.RegisterOccluder(this);
    }
    else
    {
        Debug.LogError($"[OcclusionTransparency] {gameObject.name} æ³¨å†Œå¤±è´¥ï¼æœªæ‰¾åˆ°OcclusionManager");
    }
}
```

**ç»“æœï¼š** æ‰€æœ‰ç‰©ä½“æˆåŠŸæ³¨å†Œ âœ…

---

### **é—®é¢˜3ï¼šæ£€æµ‹é€»è¾‘æ ¹æœ¬æ€§é”™è¯¯**

**ç°è±¡ï¼š**
- æ ‡ç­¾ä¿®å¤åï¼Œä»ç„¶æ— é®æŒ¡æ•ˆæœ
- ç©å®¶æ˜æ˜åœ¨æ ‘ä¸‹ï¼Œæ ‘ä¸é€æ˜

**åŸå› åˆ†æï¼š**

**åˆå§‹é”™è¯¯é€»è¾‘ï¼š**
```csharp
// ä½¿ç”¨OverlapPointæ£€æµ‹ç©å®¶æ˜¯å¦åœ¨Colliderå†…
if (composite.OverlapPoint(playerPos))
{
    // ç©å®¶åœ¨Colliderå†… â†’ é€æ˜
}
```

**é—®é¢˜ï¼š**
1. `PolygonCollider2D` = æ ‘æ ¹èŒƒå›´ï¼ˆspriteåº•éƒ¨å°åŒºåŸŸï¼‰
2. `OverlapPoint` æ£€æµ‹çš„æ˜¯"ç©å®¶åœ¨æ ‘æ ¹å†…"
3. ä½†ç©å®¶ç«™åœ¨æ ‘ä¸‹ï¼Œä¸ä¼šåœ¨æ ‘æ ¹Colliderå†…éƒ¨
4. éœ€æ±‚æ˜¯ï¼šç©å®¶åœ¨æ ‘å† è§†è§‰èŒƒå›´ä¸‹æ–¹æ—¶ï¼Œæ ‘é€æ˜

**å¯è§†åŒ–ï¼š**
```
     ğŸŒ³ â† Spriteï¼ˆæ ‘å† ï¼‰
    /â”‚\
   / â”‚ \
  ğŸŒ³ğŸŒ³ğŸŒ³
    ğŸ‘¤  â† ç©å®¶åœ¨æ ‘å† ä¸‹æ–¹
    
Collider:
    â–„  â† PolygonCollider2Dï¼ˆåªæœ‰æ ‘æ ¹ï¼‰
    
OverlapPoint(ç©å®¶) = false  â† ç©å®¶ä¸åœ¨æ ‘æ ¹å†…
ä½†è§†è§‰ä¸Šç©å®¶è¢«æ ‘å† é®æŒ¡ï¼
```

**æ­£ç¡®éœ€æ±‚ï¼š**
```
æ£€æµ‹æ¡ä»¶ï¼š
1. ç©å®¶Yåæ ‡ > æ ‘Yåæ ‡ï¼ˆç©å®¶åœ¨ä¸‹æ–¹ï¼‰
2. ç©å®¶Sprite ä¸ æ ‘Sprite æœ‰é‡å ï¼ˆè§†è§‰ä¸Šè¢«æŒ¡ä½ï¼‰
```

**è§£å†³æ–¹æ¡ˆï¼šBounds.Intersects**

```csharp
// è·å–Yåæ ‡
float playerY = player.position.y;
float treeY = occluder.transform.position.y;  // çˆ¶ç‰©ä½“ä½ç½® = ç§æ¤ç‚¹

// æ£€æµ‹1ï¼šç©å®¶å¿…é¡»åœ¨æ ‘ä¸‹æ–¹
if (playerY <= treeY) continue;

// æ£€æµ‹2ï¼šSprite boundsé‡å 
Bounds playerBounds = playerSprite.bounds;  // ç©å®¶spriteèŒƒå›´
Bounds treeBounds = occluder.GetBounds();   // æ ‘spriteèŒƒå›´ï¼ˆä»å­ç‰©ä½“ï¼‰

if (treeBounds.Intersects(playerBounds))
{
    // ç©å®¶åœ¨æ ‘ä¸‹ + spriteé‡å  â†’ é®æŒ¡æˆç«‹
    occluder.SetOccluding(true);
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·æ­£ç¡®ï¼š**
1. `Sprite.bounds` = å®Œæ•´çš„è§†è§‰èŒƒå›´ï¼ˆæ ‘å† ï¼‰
2. `Bounds.Intersects()` = AABBç¢°æ’æ£€æµ‹ï¼ˆ4æ¬¡æµ®ç‚¹æ¯”è¾ƒï¼Œæå¿«ï¼‰
3. è‡ªåŠ¨é€‚åº”spriteå¤§å°å˜åŒ–
4. ä¸ä¾èµ–Collideré…ç½®

**èŒè´£åˆ†ç¦»ï¼š**
```
PolygonCollider2D
â””â”€ ç”¨é€”ï¼šç‰©ç†ç¢°æ’ï¼ˆç©å®¶æ’æ ‘ã€å¯¼èˆªéšœç¢ï¼‰
â””â”€ èŒƒå›´ï¼šæ ‘æ ¹ï¼ˆspriteåº•éƒ¨ï¼‰

Sprite.bounds
â””â”€ ç”¨é€”ï¼šè§†è§‰é®æŒ¡æ£€æµ‹
â””â”€ èŒƒå›´ï¼šå®Œæ•´spriteï¼ˆæ ‘å† +æ ‘å¹²ï¼‰
```

**ç»“æœï¼š** é®æŒ¡æ£€æµ‹å®Œå…¨æ­£ç¡® âœ…

---

### **é—®é¢˜4ï¼šOrderè®¡ç®—é”™è¯¯ï¼ˆåŒå±‚ç»“æ„ï¼‰**

**ç°è±¡ï¼š**
- æ·»åŠ OcclusionTransparencyåï¼ŒTreeå­ç‰©ä½“çš„Orderè®¡ç®—é”™è¯¯
- Treeå’ŒShadowçš„Orderä¸ä¸€è‡´
- Orderåº”è¯¥åŸºäºçˆ¶ç‰©ä½“Yï¼Œä½†å®é™…åŸºäºå­ç‰©ä½“Y

**åŸå› åˆ†æï¼š**

**é¡¹ç›®çš„åŒå±‚ç»“æ„ï¼š**
```
Tree_M1_01ï¼ˆçˆ¶ç‰©ä½“ï¼ŒY=27ï¼‰
  â”œâ”€ ä½ç½® = æ ‘æ ¹ = ç§æ¤ç‚¹ï¼ˆæ¸¸æˆé€»è¾‘ä½ç½®ï¼‰
  â”œâ”€ æ— SpriteRenderer
  â”‚
  â”œâ”€ Treeï¼ˆå­ç‰©ä½“ï¼ŒlocalY=3ï¼ŒworldY=30ï¼‰
  â”‚    â”œâ”€ SpriteRenderer
  â”‚    â”œâ”€ TreeController â† åŠ¨æ€è°ƒæ•´localYå¯¹é½spriteåº•éƒ¨
  â”‚    â””â”€ PolygonCollider2D
  â”‚
  â””â”€ Shadowï¼ˆå­ç‰©ä½“ï¼ŒlocalY=0ï¼ŒworldY=27ï¼‰
       â””â”€ SpriteRenderer
```

**TreeControllerçš„è®¾è®¡ï¼š**
```csharp
// Treeå­ç‰©ä½“çš„localYä¼šæ ¹æ®spriteé«˜åº¦åŠ¨æ€è°ƒæ•´
void AlignSpriteBottom()
{
    localPosition.y = -sprite.bounds.min.y;
    // è®©spriteåº•éƒ¨å¯¹é½åˆ°çˆ¶ç‰©ä½“ä¸­å¿ƒï¼ˆY=0ï¼‰
}

ç»“æœï¼š
- çˆ¶ç‰©ä½“ä½ç½® = æ ‘æ ¹ï¼ˆå›ºå®šï¼‰
- Treeå­ç‰©ä½“ä¸–ç•ŒY = çˆ¶Y + localYï¼ˆä¼šå˜åŒ–ï¼‰
- ä¸åŒå¤§å°çš„æ ‘ï¼Œå­ç‰©ä½“Yåæ ‡ä¸åŒ
```

**é”™è¯¯çš„Orderè®¡ç®—ï¼š**
```csharp
// æ—§é€»è¾‘ï¼ˆé”™è¯¯ï¼‰
float sortingY = sr.bounds.min.y;  // ä½¿ç”¨å­ç‰©ä½“çš„spriteåº•éƒ¨Y
int order = -Round(sortingY * 100);

Treeå­ç‰©ä½“ï¼šworldY=30 â†’ Order=-3000
Shadowå­ç‰©ä½“ï¼šworldY=27 â†’ Order=-2700

é—®é¢˜ï¼šOrderä¸ä¸€è‡´ï¼è€Œä¸”ä¸åŒå¤§å°çš„æ ‘Orderä¸åŒï¼
```

**æ­£ç¡®çš„Orderè®¡ç®—ï¼š**
```csharp
// æ–°é€»è¾‘ï¼ˆæ­£ç¡®ï¼‰
Transform parent = sr.transform.parent;
if (parent != null && parent.GetComponent<SpriteRenderer>() == null)
{
    // çˆ¶ç‰©ä½“æ— SR â†’ åŒå±‚ç»“æ„
    // ä½¿ç”¨çˆ¶ç‰©ä½“Yåæ ‡ï¼ˆç§æ¤ç‚¹ï¼‰
    sortingY = parent.position.y;  // = 27
}

Treeå­ç‰©ä½“ï¼šçˆ¶Y=27 â†’ Order=-2700
Shadowå­ç‰©ä½“ï¼šçˆ¶Y=27ï¼Œåç§»-1 â†’ Order=-2701

ä¼˜åŠ¿ï¼š
- æ‰€æœ‰åŒä½ç½®ç§æ¤çš„æ ‘ï¼ŒOrderä¸€è‡´
- Treeå’ŒShadowçš„Orderæ­£ç¡®å…³è”
- ç¬¦åˆæ¸¸æˆé€»è¾‘ï¼ˆç§æ¤ç‚¹å†³å®šæ·±åº¦ï¼‰
```

**ä¿®å¤çš„æ–‡ä»¶ï¼š**
1. `StaticObjectOrderAutoCalibrator.cs` - CalculateSortingY()
2. `Tool_002_BatchHierarchy.cs` - CalculateSortingY()

**ç»“æœï¼š** Orderè®¡ç®—å®Œå…¨æ­£ç¡® âœ…

---

### **é—®é¢˜5ï¼šCompositeCollider2Dä¸æ˜¾ç¤ºè½®å»“**

**ç°è±¡ï¼š**
- æ·»åŠ CompositeCollider2Dåï¼ŒSceneè§†å›¾çœ‹ä¸åˆ°è½®å»“
- ç¼–è¾‘å™¨æ˜¾ç¤º Shape Count = 0

**åŸå› åˆ†æï¼š**

**é”™è¯¯çš„é…ç½®é¡ºåºï¼š**
```csharp
// æ—§é¡ºåºï¼ˆé”™è¯¯ï¼‰
1. æ·»åŠ CompositeCollider2D
2. è®¾ç½®å­ç‰©ä½“PolygonCollider2Dçš„compositeOperation = Merge
3. æ·»åŠ Rigidbody2D

é—®é¢˜ï¼šCompositeCollider2Dæ·»åŠ æ—¶ï¼Œå­colliderè¿˜æœªè®¾ç½®Merge
```

**æ­£ç¡®çš„é…ç½®é¡ºåºï¼š**
```csharp
// BatchAddOcclusionComponents.cs

// 1. å…ˆæ·»åŠ Rigidbody2Då¹¶è®¾ç½®ä¸ºStatic
Rigidbody2D rb = parentObj.AddComponent<Rigidbody2D>();
rb.bodyType = RigidbodyType2D.Static;  // å¿…é¡»æ˜¯Static

// 2. è®¾ç½®å­ç‰©ä½“PolygonCollider2Dï¼ˆå¿…é¡»åœ¨æ·»åŠ Compositeä¹‹å‰ï¼‰
treePoly.compositeOperation = Collider2D.CompositeOperation.Merge;

// 3. æ·»åŠ CompositeCollider2D
CompositeCollider2D composite = parentObj.AddComponent<CompositeCollider2D>();
composite.isTrigger = true;
composite.geometryType = CompositeCollider2D.GeometryType.Polygons;
composite.generationType = CompositeCollider2D.GenerationType.Synchronous;

// 4. å¼ºåˆ¶åˆ·æ–°å‡ ä½•å½¢çŠ¶
composite.GenerateGeometry();  // â† å…³é”®ï¼å¼ºåˆ¶é‡æ–°ç”Ÿæˆè½®å»“
```

**å…³é”®ç‚¹ï¼š**
1. Rigidbody2Då¿…é¡»æ˜¯Static
2. å­colliderå¿…é¡»å…ˆè®¾ç½®Merge
3. å¿…é¡»è°ƒç”¨GenerateGeometry()å¼ºåˆ¶åˆ·æ–°
4. é¡ºåºä¸èƒ½é”™

**ç»“æœï¼š** CompositeCollider2Dæ­£ç¡®æ˜¾ç¤ºè½®å»“ï¼ŒShape Count > 0 âœ…

---

## ğŸ¯ å…³é”®å­¦ä¹ ç‚¹

### **1. æ ‡ç­¾ç³»ç»Ÿè®¾è®¡**

**é”™è¯¯ç†è§£ï¼š**
```csharp
æ ‘.occlusionTags = ["Trees", "Buildings", "Rocks"];  // âŒ é”™è¯¯
// æŠŠæ‰€æœ‰ç±»å‹éƒ½åŠ ä¸Š
```

**æ­£ç¡®ç†è§£ï¼š**
```csharp
// ç‰©ä½“æ ‡ç­¾ = èº«ä»½æ ‡è¯†ï¼ˆ"æˆ‘æ˜¯ä»€ä¹ˆ"ï¼‰
æ ‘.occlusionTags = ["Trees"];              // æˆ‘æ˜¯æ ‘
å»ºç­‘.occlusionTags = ["Buildings"];         // æˆ‘æ˜¯å»ºç­‘
å²©çŸ³.occlusionTags = ["Rocks"];             // æˆ‘æ˜¯å²©çŸ³

// Manageræ ‡ç­¾ = æ£€æµ‹ç™½åå•ï¼ˆ"æˆ‘è¦æ£€æµ‹ä»€ä¹ˆ"ï¼‰
Manager.occludableTags = ["Trees", "Buildings", "Rocks"];  // æ£€æµ‹è¿™äº›ç±»å‹
```

### **2. é®æŒ¡æ£€æµ‹é€»è¾‘**

**é”™è¯¯æ–¹æ¡ˆï¼š**
- ä½¿ç”¨Colliderçš„OverlapPointæ£€æµ‹
- æ£€æµ‹"ç©å®¶åœ¨Colliderå†…"
- é—®é¢˜ï¼šColliderèŒƒå›´ â‰  è§†è§‰èŒƒå›´

**æ­£ç¡®æ–¹æ¡ˆï¼š**
- ä½¿ç”¨Sprite.boundsçš„Intersectsæ£€æµ‹
- æ£€æµ‹"spriteè§†è§‰é‡å "
- ä¼˜åŠ¿ï¼šå‡†ç¡®ã€å¿«é€Ÿã€è‡ªåŠ¨é€‚åº”

**èŒè´£åˆ†ç¦»åŸåˆ™ï¼š**
```
ç‰©ç†å±‚ï¼ˆColliderï¼‰â†’ ç¢°æ’ã€å¯¼èˆª
è§†è§‰å±‚ï¼ˆBoundsï¼‰  â†’ é®æŒ¡æ£€æµ‹
```

### **3. åŒå±‚ç»“æ„Orderè®¡ç®—**

**å…³é”®è®¤çŸ¥ï¼š**
```
çˆ¶ç‰©ä½“ä½ç½® = æ¸¸æˆé€»è¾‘ä½ç½®ï¼ˆç§æ¤ç‚¹ï¼‰â† å›ºå®š
å­ç‰©ä½“ä½ç½® = æ¸²æŸ“ä½ç½®ï¼ˆspriteå¯¹é½ï¼‰â† åŠ¨æ€

Orderåº”è¯¥åŸºäºé€»è¾‘ä½ç½®ï¼ˆçˆ¶ç‰©ä½“Yï¼‰ï¼Œ
è€Œä¸æ˜¯æ¸²æŸ“ä½ç½®ï¼ˆå­ç‰©ä½“Yï¼‰
```

**æ£€æµ‹æ–¹æ³•ï¼š**
```csharp
if (parent != null && parent.GetComponent<SpriteRenderer>() == null)
{
    // çˆ¶ç‰©ä½“æ— SR â†’ åŒå±‚ç»“æ„
    // ä½¿ç”¨çˆ¶ç‰©ä½“Y
}
```

### **4. Unityç»„ä»¶é…ç½®é¡ºåº**

**CompositeCollider2Dä¾èµ–ï¼š**
```
1. Rigidbody2D (Static) â† å¿…é¡»å…ˆæœ‰
2. å­colliderè®¾ç½®Merge â† å¿…é¡»åœ¨Compositeä¹‹å‰
3. CompositeCollider2D  â† æ‰èƒ½æ­£ç¡®ç”Ÿæˆ
4. GenerateGeometry()   â† å¼ºåˆ¶åˆ·æ–°
```

é¡ºåºé”™è¯¯ â†’ ç»„ä»¶æ— æ•ˆï¼

### **5. æ³¨å†Œæ—¶åºé—®é¢˜**

**å•ä¾‹æ¨¡å¼é™·é˜±ï¼š**
```csharp
// âŒ å±é™©
OcclusionManager.Instance?.RegisterOccluder(this);
// ?. ä¼šé™é»˜å¤±è´¥ï¼Œä¸æŠ¥é”™

// âœ… å®‰å…¨
yield return null;  // ç­‰å¾…ä¸€å¸§
if (OcclusionManager.Instance != null)
{
    OcclusionManager.Instance.RegisterOccluder(this);
}
else
{
    Debug.LogError("æ³¨å†Œå¤±è´¥ï¼");  // æ˜ç¡®æŠ¥é”™
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹

### **ä¼˜åŒ–å‰ï¼ˆv1.0ï¼‰**

**æ£€æµ‹æ–¹å¼ï¼š** OverlapPointï¼ˆç‰©ç†æŸ¥è¯¢ï¼‰
```csharp
foreach (ç‰©ä½“ in æ‰€æœ‰ç‰©ä½“)
{
    if (composite.OverlapPoint(playerPos))
    {
        é€æ˜;
    }
}
```

**æ€§èƒ½ï¼š**
- å•æ¬¡æ£€æµ‹ï¼š~0.02msï¼ˆ100æ£µæ ‘ï¼‰
- éœ€è¦ç‰©ç†å¼•æ“æŸ¥è¯¢
- å¤æ‚çš„ç‚¹åœ¨å¤šè¾¹å½¢å†…ç®—æ³•

### **ä¼˜åŒ–åï¼ˆv2.0ï¼‰**

**æ£€æµ‹æ–¹å¼ï¼š** Bounds.Intersectsï¼ˆæ•°å­¦æ£€æµ‹ï¼‰
```csharp
foreach (ç‰©ä½“ in æ³¨å†Œåˆ—è¡¨)
{
    // Yåæ ‡é¢„æ£€æµ‹ï¼ˆå¿«é€Ÿæ’é™¤ï¼‰
    if (playerY <= treeY) continue;
    
    // è·ç¦»è¿‡æ»¤ï¼ˆä¼˜åŒ–ï¼‰
    if (distance > radius) continue;
    
    // Boundsæ£€æµ‹ï¼ˆæå¿«ï¼‰
    if (treeBounds.Intersects(playerBounds))
    {
        é€æ˜;
    }
}
```

**æ€§èƒ½ï¼š**
- å•æ¬¡æ£€æµ‹ï¼š~0.001msï¼ˆ100æ£µæ ‘ï¼‰
- çº¯æ•°å­¦è®¡ç®—ï¼ˆ4æ¬¡æµ®ç‚¹æ¯”è¾ƒï¼‰
- æ— ç‰©ç†å¼•æ“å¼€é”€
- **å¿«20å€ï¼**

### **é¢å¤–ä¼˜åŒ–**

1. **ç§»åŠ¨é˜ˆå€¼ï¼š** ç§»åŠ¨ < 0.1å•ä½è·³è¿‡æ£€æµ‹
2. **å®šæ—¶æ£€æµ‹ï¼š** æ¯0.1ç§’è€Œéæ¯å¸§
3. **é¢„æ£€æµ‹è¿‡æ»¤ï¼š** Yåæ ‡ã€è·ç¦»å¿«é€Ÿæ’é™¤
4. **æ³¨å†Œæ¨¡å¼ï¼š** åªæ£€æµ‹æ³¨å†Œç‰©ä½“ï¼Œä¸éå†å…¨åœºæ™¯

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§æ€»ç»“

### **é—®é¢˜è¯Šæ–­æµç¨‹**

```
1. æ£€æŸ¥åˆå§‹åŒ–
   â””â”€ Consoleæ˜¯å¦æœ‰åˆå§‹åŒ–æ—¥å¿—
   â””â”€ Managerå’Œç»„ä»¶æ˜¯å¦æ­£ç¡®æ·»åŠ 

2. æ£€æŸ¥æ³¨å†Œ
   â””â”€ ç‰©ä½“æ˜¯å¦æˆåŠŸæ³¨å†Œåˆ°Manager
   â””â”€ æ³¨å†Œæ•°é‡æ˜¯å¦æ­£ç¡®

3. æ£€æŸ¥æ ‡ç­¾
   â””â”€ ç‰©ä½“æ ‡ç­¾å’ŒManageræ ‡ç­¾æ˜¯å¦åŒ¹é…
   â””â”€ æ ‡ç­¾æ‹¼å†™æ˜¯å¦æ­£ç¡®ï¼ˆå•å¤æ•°ï¼‰

4. æ£€æŸ¥æ£€æµ‹æ¡ä»¶
   â””â”€ ç©å®¶æ˜¯å¦åœ¨æ£€æµ‹èŒƒå›´å†…
   â””â”€ ç©å®¶Yæ˜¯å¦å¤§äºç‰©ä½“Y
   â””â”€ Boundsæ˜¯å¦çœŸçš„é‡å 

5. æ£€æŸ¥é€æ˜åº¦åº”ç”¨
   â””â”€ ç›®æ ‡Alphaæ˜¯å¦æ­£ç¡®
   â””â”€ å­ç‰©ä½“æ˜¯å¦éƒ½å—å½±å“
```

### **æ·»åŠ ä¸´æ—¶è°ƒè¯•æ—¥å¿—**

```csharp
// åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—
Debug.Log($"æ£€æµ‹ï¼šPlayerY={playerY}, TreeY={treeY}, é‡å ={isOverlapping}");

// ç»Ÿè®¡ä¿¡æ¯
Debug.Log($"æ£€æŸ¥ç‰©ä½“: {count}, è¿‡æ»¤: {filtered}, é®æŒ¡: {occluding}");
```

### **ä½¿ç”¨Gizmoså¯è§†åŒ–**

```csharp
void OnDrawGizmos()
{
    // ç»˜åˆ¶æ£€æµ‹èŒƒå›´
    Gizmos.color = Color.yellow;
    Gizmos.DrawWireSphere(playerPos, detectionRadius);
    
    // ç»˜åˆ¶Bounds
    Gizmos.color = Color.green;
    Gizmos.DrawWireCube(playerBounds.center, playerBounds.size);
    
    // ç»˜åˆ¶é®æŒ¡ç‰©ä½“
    Gizmos.color = Color.red;
    Gizmos.DrawWireCube(treeBounds.center, treeBounds.size);
}
```

---

## âœ… æœ€ç»ˆçŠ¶æ€

### **æ‰€æœ‰é—®é¢˜å·²è§£å†³**

- âœ… æ ‡ç­¾é…ç½®æ­£ç¡®
- âœ… æ³¨å†Œæ—¶åºæ­£ç¡®
- âœ… æ£€æµ‹é€»è¾‘æ­£ç¡®ï¼ˆBounds.Intersectsï¼‰
- âœ… Orderè®¡ç®—æ­£ç¡®ï¼ˆåŒå±‚ç»“æ„ï¼‰
- âœ… CompositeCollider2Dé…ç½®æ­£ç¡®
- âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆï¼ˆå¿«20å€ï¼‰
- âœ… è°ƒè¯•æ—¥å¿—æ¸…ç†
- âœ… ç”Ÿäº§ç¯å¢ƒå°±ç»ª

### **ç³»ç»Ÿç‰¹æ€§**

- åŠŸèƒ½å®Œæ•´ä¸”ç¨³å®š
- é«˜æ€§èƒ½ï¼ˆ0.001ms/100ç‰©ä½“ï¼‰
- Unity 6å…¼å®¹
- ä»£ç æ¸…æ™°æ˜“ç»´æŠ¤
- å®Œæ•´æ–‡æ¡£æ”¯æŒ

---

## ğŸ’¡ ç»éªŒæ€»ç»“

1. **æ·±å…¥ç†è§£éœ€æ±‚**
   - ä¸è¦å‡è®¾ï¼Œè¦éªŒè¯
   - æ£€æµ‹"åœ¨Colliderå†…" â‰  æ£€æµ‹"è§†è§‰é®æŒ¡"

2. **èŒè´£åˆ†ç¦»åŸåˆ™**
   - Colliderç”¨äºç‰©ç†
   - Boundsç”¨äºè§†è§‰
   - ä¸è¦æ··æ·†ç”¨é€”

3. **é‡è§†é¡¹ç›®æ¶æ„**
   - ç†è§£åŒå±‚ç»“æ„è®¾è®¡
   - å°Šé‡ç°æœ‰ä»£ç é€»è¾‘
   - ä¸è¦ç ´ååŸæœ‰ç³»ç»Ÿ

4. **æ³¨é‡ç»†èŠ‚**
   - æ ‡ç­¾å•å¤æ•°è¦ä¸€è‡´
   - ç»„ä»¶é…ç½®é¡ºåºè¦æ­£ç¡®
   - æ³¨å†Œæ—¶åºè¦å¤„ç†

5. **æ€§èƒ½ä¼˜å…ˆ**
   - é€‰æ‹©æœ€ä¼˜ç®—æ³•
   - åŠæ—¶ä¼˜åŒ–çƒ­ç‚¹
   - æµ‹é‡å®é™…æ€§èƒ½

6. **å®Œæ•´çš„è°ƒè¯•æ‰‹æ®µ**
   - è¯¦ç»†æ—¥å¿—ï¼ˆå¼€å‘æ—¶ï¼‰
   - å¯è§†åŒ–Gizmos
   - ç»Ÿè®¡ä¿¡æ¯
   - æ¸…ç†æ—¥å¿—ï¼ˆç”Ÿäº§æ—¶ï¼‰

---

**æ–‡æ¡£ä½œè€…ï¼š** Cascade AI  
**æœ€åæ›´æ–°ï¼š** 2024-12-05  
**é—®é¢˜çŠ¶æ€ï¼š** å…¨éƒ¨è§£å†³ âœ…
