# 遮挡透明系统 - 快速开始指南

**适用对象**: 需要快速配置遮挡透明和云影系统的开发者  
**预计时间**: 30-45 分钟

---

## 📋 前置检查

在开始之前，请确认：
- [ ] Unity 版本：6000.0.62f1
- [ ] 已有玩家物体（带 Player 标签）
- [ ] 已有树木/房屋/岩石预制体
- [ ] 已有 WeatherSystem（用于云影联动）

---

## 🚀 快速配置流程

### 第一步：添加 Sorting Layer（2 分钟）

1. 打开 `Edit → Project Settings → Tags and Layers`
2. 展开 `Sorting Layers`
3. 点击 `+` 添加新层，命名为 `CloudShadow`
4. 拖动调整顺序，确保在 `Objects` 之上、`UI` 之下

**推荐顺序**：
```
Background
Ground
Objects
CloudShadow  ← 新增
Characters
Effects
UI
```

---

### 第二步：创建树木渐变材质（5 分钟）

1. 在 `Assets/Shaders/Material/` 文件夹右键
2. 选择 `Create → Material`
3. 命名为 `TreeOcclusion`
4. 在 Inspector 中：
   - Shader 选择 `Custom/VerticalGradientOcclusion`
   - 配置参数：
     ```
     Bottom Alpha = 0.8
     Middle Alpha = 0.5
     Top Alpha = 0.3
     Split1 = 0.33
     Split2 = 0.66
     Softness = 0.05
     Tint = (1, 1, 1, 1) 白色
     ```

**验证**：材质预览应该显示从下到上的渐变透明效果

---

### 第三步：场景配置 - OcclusionManager（5 分钟）

1. 在 Hierarchy 中创建空物体，命名为 `OcclusionManager`
2. 移动到 `─── MANAGERS ───` 分组下
3. 添加 `OcclusionManager` 组件
4. 配置参数：

```
玩家引用：
  Player: [留空，自动查找 Player 标签]
  Player Sprite: [留空，自动获取]
  Player Collider: [留空，自动获取]  ← 新增，用于获取中心点
  Player Sorting: [留空，自动获取]

检测设置：
  Detection Radius: 8
  Detection Interval: 0.1

全局透明度设置：
  Global Occluded Alpha: 0.3
  Global Fade Speed: 8

标签自定义参数（可选）：
  Use Tag Custom Params: ✗  ← 默认关闭，使用全局参数
  Tag Params: [如果启用，可为不同标签配置独立参数]
    - Tree: Alpha=0.3, Speed=8
    - Building: Alpha=0.4, Speed=10
    - Rock: Alpha=0.5, Speed=6

过滤设置：
  Use Tag Filter: ✓
  Occludable Tags: 
    - Tree
    - Building
    - Rock
  Same Sorting Layer Only: ✓

调试：
  Show Debug Gizmos: ✓
  Enable Detailed Debug: ✗
```

**💡 新功能说明**：
- **Player Collider**：用于获取玩家视觉中心点，解决"玩家还在房屋上方就触发透明"的问题
- **标签自定义参数**：可选功能，允许不同标签有不同的透明度和渐变速度（例如树木更透明，房屋稍微不透明）

---

### 第四步：批量应用树木材质（5 分钟）

1. 在 Project 窗口选中所有树木预制体（可多选）
2. 打开 `Tools → 遮挡透明 → 树木材质批量应用`
3. 拖入刚创建的 `TreeOcclusion` 材质
4. 确认选项：
   - 应用到 Tree 子物体: ✓
   - 保持 Shadow 材质: ✓
   - 添加遮挡组件: ✓
5. 点击 `✓ 应用材质到选中物体`
6. 查看执行结果，确认成功

**预期结果**：
- Tree 子物体使用 TreeOcclusion 材质
- Shadow 子物体保持默认材质
- 自动添加了 OcclusionTransparency 组件

---

### 第五步：配置房屋和岩石（5 分钟）

#### 房屋配置
1. 选中所有房屋预制体
2. 在 Inspector 中添加 `OcclusionTransparency` 组件
3. 设置物体 Tag 为 `Building`
4. 不需要应用渐变材质（使用默认材质）

#### 岩石配置
1. 选中所有岩石预制体
2. 在 Inspector 中添加 `OcclusionTransparency` 组件
3. 设置物体 Tag 为 `Rock`
4. 不需要应用渐变材质（使用默认材质）

---

### 第六步：测试遮挡透明（5 分钟）

1. 进入 Play Mode
2. 控制玩家走到树下
3. 观察树木是否渐变透明（根→干→叶）
4. 观察 Shadow 是否保持不透明
5. 走到房屋/岩石下，观察是否统一透明
6. 离开遮挡物，观察是否恢复不透明

**调试技巧**：
- 启用 `Show Debug Gizmos` 查看检测范围
- 启用 `Enable Detailed Debug` 查看日志
- 在 Scene 视图观察 Gizmos 显示

---

### 第七步：准备云影素材（需要美术资源）

**如果你已有云影素材**：
1. 准备 3-5 张云影 PNG 图片（灰度/Alpha）
2. 导入到 `Assets/Sprites/Environment/CloudShadows/`
3. 设置导入参数：
   - Texture Type: Sprite (2D and UI)
   - Sprite Mode: Single
   - Alpha Is Transparency: ✓
   - Filter Mode: Bilinear

**如果暂时没有素材**：
- 可以先跳过云影配置
- 遮挡透明系统已经可以正常工作
- 后续有素材后再配置云影

---

### 第八步：创建云影材质（可选，3 分钟）

1. 在 `Assets/Shaders/Material/` 右键
2. 选择 `Create → Material`
3. 命名为 `CloudShadow`
4. Shader 选择 `Sprites/Default`
5. 如需 Multiply 效果，可使用自定义 Shader

---

### 第九步：场景配置 - CloudShadowManager（可选，5 分钟）

1. 在 Hierarchy 中创建空物体，命名为 `CloudShadowManager`
2. 移动到 `─── MANAGERS ───` 分组下
3. 添加 `CloudShadowManager` 组件
4. 配置参数：

```
Enable:
  Enable Cloud Shadows: ✓

Appearance:
  Intensity: 0.3
  Density: 0.6
  Scale Range: (1.0, 2.0)
  Cloud Sprites: [拖入云影精灵数组]
  Cloud Material: [拖入 CloudShadow 材质]

Movement:
  Direction: (1, 0)
  Speed: 0.4

Area:
  Area Size: (40, 24)

Sorting:
  Sorting Layer Name: CloudShadow
  Sorting Order: 0

Weather Gate:
  Use Weather Gate: ✓
  Enable In Sunny: ✓
  Enable In Partly Cloudy: ✓
  Enable In Overcast: ✗
  Enable In Rain: ✗
  Enable In Snow: ✗

Seed & Preview:
  Seed: 12345
  Randomize On Start: ✓
  Preview In Editor: ✓

Limits:
  Max Clouds: 8
```

5. 点击 `🔄 立即重建 (Rebuild Now)` 预览效果

---

### 第十步：测试云影系统（可选，5 分钟）

1. 启用 `Preview In Editor` 在编辑器中预览
2. 观察云影是否移动
3. 调整 `Intensity` 和 `Density` 查看效果
4. 进入 Play Mode 测试天气联动
5. 切换天气，观察云影是否自动开关

---

## ✅ 完成检查清单

### 遮挡透明系统
- [ ] Sorting Layer `CloudShadow` 已添加
- [ ] 树木渐变材质 `TreeOcclusion` 已创建
- [ ] OcclusionManager 已添加到场景
- [ ] 树木已应用渐变材质和遮挡组件
- [ ] 房屋已添加遮挡组件和 Building 标签
- [ ] 岩石已添加遮挡组件和 Rock 标签
- [ ] 玩家走到树下，树变透明 ✓
- [ ] Shadow 不受透明影响 ✓
- [ ] 房屋/岩石统一透明 ✓

### 云影系统（可选）
- [ ] 云影素材已导入
- [ ] 云影材质已创建
- [ ] CloudShadowManager 已添加到场景
- [ ] 云影精灵已配置
- [ ] 云影移动流畅 ✓
- [ ] 天气联动正常 ✓

---

## 🔧 常见问题

### Q1: 树木没有变透明？
**检查**：
- 物体是否有 `Tree` 标签？
- OcclusionTransparency 组件是否已添加？
- OcclusionManager 的 `Occludable Tags` 是否包含 `Tree`？
- **玩家中心是否真的进入了遮挡物范围**（查看 Gizmos 中的蓝色球体）？
- 玩家是否有 Collider2D 组件？

### Q2: 树木变透明但 Shadow 也透明了？
**检查**：
- Shadow 子物体是否使用了渐变材质？
- 应该使用默认材质或"忽略顶点 Alpha"材质
- 使用批量工具重新应用材质

### Q3: 云影不显示？
**检查**：
- Sorting Layer `CloudShadow` 是否已添加？
- Cloud Sprites 数组是否为空？
- Enable Cloud Shadows 是否勾选？
- 天气是否允许云影显示？

### Q4: 出现绿色/矩形罩子？
**检查**：
- 材质 Tint 是否为白色 (1,1,1,1)？
- Shader 是否正确（Custom/VerticalGradientOcclusion）？
- 贴图是否开启 Alpha Is Transparency？

### Q5: 性能问题/卡顿？
**优化**：
- 减少 Max Clouds 数量（建议 6-8）
- 增加 Detection Interval（0.15-0.2）
- 关闭 Enable Detailed Debug
- 减少检测半径（6-8）

### Q6: 玩家还在房屋上方时就触发透明？
**解决**：
- 确保 OcclusionManager 的 `Player Collider` 字段已正确配置
- 系统现在使用玩家 Collider 中心作为检测点，而不是脚底位置
- 启用 `Show Debug Gizmos` 查看蓝色球体（玩家中心点）是否进入遮挡物范围

### Q7: 想让不同物体有不同的透明度？
**配置**：
- 启用 OcclusionManager 的 `Use Tag Custom Params`
- 在 `Tag Params` 列表中为不同标签配置独立参数
- 例如：树木 Alpha=0.3（更透明），房屋 Alpha=0.5（稍微不透明）

---

## 📚 进阶功能

### 使用编辑器工具
- `Tools → 遮挡透明 → 树木材质批量应用`：批量应用材质
- `Tools → 遮挡透明 → 🧹 清理无效的遮挡组件`：清理无效组件

### 调试技巧
- 启用 `Show Debug Gizmos` 查看检测范围
- 启用 `Enable Detailed Debug` 查看详细日志
- 在 Scene 视图观察 Gizmos 颜色编码：
  - **黄色圆圈**：检测范围
  - **蓝色球体**：玩家中心点（检测点）
  - **绿色方框**：玩家 bounds
  - **红色方框**：正在遮挡的物体 bounds

### 参数调优
- **遮挡透明度**：调整 `Global Occluded Alpha`（0.2-0.4）
- **渐变速度**：调整 `Global Fade Speed`（6-10）
- **标签自定义参数**：为不同物体类型配置独立的透明度
- **云影强度**：调整 `Intensity`（0.2-0.4）
- **云影密度**：调整 `Density`（0.4-0.8）

---

## 🎉 完成！

恭喜！你已经完成了遮挡透明和云影系统的基础配置。

**下一步**：
- 根据实际效果调整参数
- 测试不同场景和天气
- 优化性能和视觉效果

**需要帮助**：
- 查看 `Docx/Plan/遮挡透明 + 云朵阴影 交接文档.md`
- 查看 `Docx/Solutions/遮挡透明系统-开发进度报告.md`
- 使用编辑器工具中的帮助提示

---

---

## 🆕 最新更新 (2025-12-09)

### 遮挡检测优化
- ✅ 使用玩家 Collider 中心作为检测点（而不是脚底位置）
- ✅ 解决了"玩家还在房屋上方就触发透明"的问题
- ✅ Gizmos 显示玩家中心点（蓝色球体）

### 标签自定义参数功能
- ✅ 支持不同标签有不同的透明度和渐变速度
- ✅ 可选功能，默认关闭（使用全局参数）
- ✅ 适用于需要精细控制不同物体透明度的场景

---

**文档版本**: v1.1  
**最后更新**: 2025-12-09
