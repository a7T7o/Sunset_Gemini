# é®æŒ¡é€æ˜ç³»ç»Ÿv2.0 - æœ€ç»ˆæ€»ç»“

**é¡¹ç›®ï¼š** Sunset  
**æ—¥æœŸï¼š** 2024-12-05  
**ç‰ˆæœ¬ï¼š** v2.0 Final  
**çŠ¶æ€ï¼š** âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

å½“ç©å®¶èµ°åˆ°æ ‘æœ¨ã€å»ºç­‘ç­‰ç‰©ä½“ä¸‹æ–¹æ—¶ï¼Œè¿™äº›ç‰©ä½“ä¼šè‡ªåŠ¨å˜é€æ˜ï¼Œé¿å…é®æŒ¡ç©å®¶è§†çº¿ã€‚

**æ ¸å¿ƒé€»è¾‘ï¼š**
```
ç©å®¶åœ¨ç‰©ä½“ä¸‹æ–¹ï¼ˆYåæ ‡æ›´å¤§ï¼‰+ Spriteè§†è§‰é‡å  â†’ ç‰©ä½“é€æ˜
```

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. **Bounds.Intersectsæ£€æµ‹**
- ä½¿ç”¨Sprite.boundsè¿›è¡Œè§†è§‰é‡å æ£€æµ‹
- æ€§èƒ½æ˜¯OverlapPointçš„20å€
- è‡ªåŠ¨é€‚åº”spriteå¤§å°å˜åŒ–

### 2. **åŒå±‚ç»“æ„æ”¯æŒ**
- å®Œç¾é€‚é…TreeControllerçš„çˆ¶å­ç‰©ä½“ç»“æ„
- Orderè®¡ç®—åŸºäºçˆ¶ç‰©ä½“Yåæ ‡ï¼ˆç§æ¤ç‚¹ï¼‰
- è‡ªåŠ¨å¤„ç†åŠ¨æ€LocalYè°ƒæ•´

### 3. **æ™ºèƒ½è¿‡æ»¤**
- Yåæ ‡é¢„æ£€æµ‹ï¼ˆå¿«é€Ÿæ’é™¤ï¼‰
- è·ç¦»è¿‡æ»¤ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- æ ‡ç­¾è¿‡æ»¤ï¼ˆåˆ†ç±»ç®¡ç†ï¼‰
- Sorting Layerè¿‡æ»¤ï¼ˆå¯é€‰ï¼‰

### 4. **å¹³æ»‘è¿‡æ¸¡**
- é€æ˜åº¦å¹³æ»‘æ’å€¼
- å¯é…ç½®è¿‡æ¸¡é€Ÿåº¦
- æ”¯æŒå­ç‰©ä½“æ‰¹é‡å¤„ç†

---

## ğŸ“Š æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| æ£€æµ‹é—´éš” | 0.1ç§’ | æ¯ç§’10æ¬¡æ£€æµ‹ |
| å•æ¬¡æ£€æµ‹è€—æ—¶ | ~0.001ms | 100æ£µæ ‘ |
| ç›¸æ¯”æ—§æ–¹æ¡ˆ | å¿«20å€ | Bounds vs OverlapPoint |
| ç§»åŠ¨é˜ˆå€¼ | 0.1å•ä½ | ä½äºæ­¤è·ç¦»è·³è¿‡æ£€æµ‹ |

---

## ğŸ› ï¸ ç³»ç»Ÿç»„æˆ

### **è„šæœ¬æ–‡ä»¶**

```
Scripts/Service/Rendering/
â”œâ”€â”€ OcclusionManager.cs          # ä¸»ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
â””â”€â”€ OcclusionTransparency.cs     # ç‰©ä½“ç»„ä»¶

Editor/
â”œâ”€â”€ BatchAddOcclusionComponents.cs        # æ‰¹é‡æ·»åŠ å·¥å…·
â”œâ”€â”€ StaticObjectOrderAutoCalibrator.cs    # è‡ªåŠ¨Orderæ ¡å‡†
â”œâ”€â”€ CleanInvalidOcclusionComponents.cs    # æ¸…ç†æ— æ•ˆç»„ä»¶
â””â”€â”€ Tool_002_BatchHierarchy.cs           # Orderè®¡ç®—å·¥å…·ï¼ˆå·²ä¿®å¤ï¼‰
```

### **ç»„ä»¶é…ç½®**

**OcclusionManagerï¼ˆåœºæ™¯å•ä¾‹ï¼‰ï¼š**
- Playerå¼•ç”¨ï¼ˆè‡ªåŠ¨æŸ¥æ‰¾ï¼‰
- æ£€æµ‹åŠå¾„ï¼š8
- æ£€æµ‹é—´éš”ï¼š0.1s
- æ ‡ç­¾åˆ—è¡¨ï¼šTrees, Buildings, Rocks

**OcclusionTransparencyï¼ˆæŒ‚è½½åˆ°ç‰©ä½“ï¼‰ï¼š**
- é®æŒ¡é€æ˜åº¦ï¼š0.3
- è¿‡æ¸¡é€Ÿåº¦ï¼š8
- ç‰©ä½“æ ‡ç­¾ï¼šTreesï¼ˆæˆ–Buildingsã€Rocksï¼‰
- å½±å“å­ç‰©ä½“ï¼šâœ“

---

## ğŸ® ä½¿ç”¨æµç¨‹

### **åˆæ¬¡é…ç½®**

```
1. åœºæ™¯é…ç½®
   â””â”€ åˆ›å»ºç©ºç‰©ä½“ "OcclusionManager"
   â””â”€ æ·»åŠ  OcclusionManager ç»„ä»¶
   â””â”€ ç©å®¶è‡ªåŠ¨æŸ¥æ‰¾ï¼ˆPlayeræ ‡ç­¾ï¼‰

2. æ‰¹é‡æ·»åŠ ç»„ä»¶
   â””â”€ é€‰ä¸­æ‰€æœ‰æ ‘æœ¨çˆ¶ç‰©ä½“
   â””â”€ Tools â†’ ğŸŒ³ æ‰¹é‡æ·»åŠ é®æŒ¡ç»„ä»¶
   â””â”€ è‡ªåŠ¨æ·»åŠ ï¼šRigidbody2D + CompositeCollider2D + OcclusionTransparency
   â””â”€ è‡ªåŠ¨æ¸…ç†ï¼šçˆ¶ç‰©ä½“ç©ºSpriteRenderer

3. æ ¡å‡†Order
   â””â”€ Tools â†’ ğŸ”§ æ ¡å‡†æ‰€æœ‰é™æ€ç‰©ä½“Order
   â””â”€ æˆ–è¿è¡Œæ¸¸æˆè‡ªåŠ¨æ ¡å‡†

4. å®Œæˆï¼
```

### **æ—¥å¸¸ä½¿ç”¨**

- æ·»åŠ æ–°æ ‘æœ¨ â†’ æ‰§è¡Œæ‰¹é‡å·¥å…·
- ä¿®æ”¹Order â†’ è‡ªåŠ¨æ ¡å‡†ï¼ˆè¿›å…¥PlayModeæ—¶ï¼‰
- æ— éœ€æ‰‹åŠ¨é…ç½®

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### **æ£€æµ‹æµç¨‹**

```csharp
DetectOcclusion()
{
    // 1. ç§»åŠ¨æ£€æµ‹ï¼ˆä¼˜åŒ–ï¼‰
    if (ç©å®¶ç§»åŠ¨è·ç¦» < 0.1) return;
    
    // 2. éå†æ‰€æœ‰æ³¨å†Œç‰©ä½“
    foreach (ç‰©ä½“ in æ³¨å†Œåˆ—è¡¨)
    {
        // 3. Yåæ ‡é¢„æ£€æµ‹
        if (ç©å®¶Y <= ç‰©ä½“Y) continue;
        
        // 4. è·ç¦»è¿‡æ»¤
        if (è·ç¦» > æ£€æµ‹åŠå¾„) continue;
        
        // 5. æ ‡ç­¾è¿‡æ»¤
        if (æ ‡ç­¾ä¸åŒ¹é…) continue;
        
        // 6. Boundsæ£€æµ‹
        if (ç©å®¶Bounds.Intersects(ç‰©ä½“Bounds))
        {
            ç‰©ä½“.SetOccluding(true);  // é€æ˜
        }
    }
}
```

### **Orderè®¡ç®—ï¼ˆåŒå±‚ç»“æ„ï¼‰**

```csharp
// StaticObjectOrderAutoCalibrator.cs
private float CalculateSortingY(SpriteRenderer sr)
{
    // æ£€æµ‹åŒå±‚ç»“æ„
    Transform parent = sr.transform.parent;
    if (parent != null && parent.GetComponent<SpriteRenderer>() == null)
    {
        // çˆ¶ç‰©ä½“æ— SpriteRenderer â†’ åŒå±‚ç»“æ„
        // ä½¿ç”¨çˆ¶ç‰©ä½“Yåæ ‡ï¼ˆç§æ¤ç‚¹ï¼‰
        return parent.position.y + BOTTOM_OFFSET;
    }
    
    // å¸¸è§„å•å±‚ç»“æ„
    // ä¼˜å…ˆçº§ï¼šCollider > Sprite > Transform
    Collider2D collider = sr.GetComponent<Collider2D>();
    if (collider != null)
        return collider.bounds.min.y + BOTTOM_OFFSET;
    
    if (sr.sprite != null)
        return sr.bounds.min.y + BOTTOM_OFFSET;
    
    return sr.transform.position.y + BOTTOM_OFFSET;
}
```

### **CompositeCollider2Dé…ç½®**

```csharp
// BatchAddOcclusionComponents.cs
æ­¥éª¤é¡ºåºï¼ˆå…³é”®ï¼‰ï¼š
1. çˆ¶ç‰©ä½“.AddComponent<Rigidbody2D>()
   â””â”€ bodyType = Static

2. å­ç‰©ä½“PolygonCollider2D
   â””â”€ compositeOperation = Merge

3. çˆ¶ç‰©ä½“.AddComponent<CompositeCollider2D>()
   â””â”€ isTrigger = true
   â””â”€ geometryType = Polygons
   â””â”€ generationType = Synchronous

4. composite.GenerateGeometry()  // å¼ºåˆ¶åˆ·æ–°

5. åˆ é™¤çˆ¶ç‰©ä½“çš„ç©ºSpriteRenderer
```

---

## âš™ï¸ é…ç½®å‚æ•°

### **OcclusionManager**

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| detectionRadius | 8 | æ£€æµ‹åŠå¾„ï¼ˆå•ä½ï¼‰ |
| detectionInterval | 0.1 | æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰ |
| upwardOffset | 2 | å‘ä¸Šåç§»ï¼ˆå·²ä¸ä½¿ç”¨ï¼‰ |
| useTagFilter | true | å¯ç”¨æ ‡ç­¾è¿‡æ»¤ |
| occludableTags | Trees, Rocks, Buildings, Interactable | å¯é®æŒ¡æ ‡ç­¾ |
| sameSortingLayerOnly | true | åªæ£€æµ‹åŒLayer |
| showDebugGizmos | false | æ˜¾ç¤ºè°ƒè¯•Gizmos |

### **OcclusionTransparency**

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| occludedAlpha | 0.3 | é®æŒ¡æ—¶é€æ˜åº¦ |
| fadeSpeed | 8 | è¿‡æ¸¡é€Ÿåº¦ |
| canBeOccluded | true | å¯ç”¨é®æŒ¡æ£€æµ‹ |
| occlusionTags | Trees, Buildings, Rocks | ç‰©ä½“æ ‡ç­¾ |
| affectChildren | true | å½±å“æ‰€æœ‰å­ç‰©ä½“ |

---

## ğŸ› å¸¸è§é—®é¢˜

### **Q: æ ‘ä¸é€æ˜ï¼Ÿ**
**A: æ£€æŸ¥ï¼š**
1. åœºæ™¯æ˜¯å¦æœ‰OcclusionManager
2. æ ‘æ˜¯å¦æ³¨å†Œï¼ˆConsoleåº”è¯¥æœ‰æ³¨å†Œæ—¥å¿—ï¼‰
3. æ ‡ç­¾æ˜¯å¦åŒ¹é…ï¼ˆTreesï¼‰
4. ç©å®¶æ˜¯å¦åœ¨æ£€æµ‹èŒƒå›´å†…ï¼ˆé»˜è®¤8å•ä½ï¼‰
5. ç©å®¶æ˜¯å¦åœ¨æ ‘ä¸‹æ–¹ï¼ˆPlayerY > TreeYï¼‰

### **Q: Orderè®¡ç®—é”™è¯¯ï¼Ÿ**
**A: æ‰§è¡Œï¼š**
- Tools â†’ ğŸ”§ æ ¡å‡†æ‰€æœ‰é™æ€ç‰©ä½“Order
- æˆ–è¿›å…¥PlayModeè‡ªåŠ¨æ ¡å‡†

### **Q: CompositeCollider2Dæ²¡æœ‰è½®å»“ï¼Ÿ**
**A: æ£€æŸ¥ï¼š**
1. Rigidbody2Dæ˜¯å¦ä¸ºStatic
2. å­ç‰©ä½“PolygonCollider2Dæ˜¯å¦è®¾ç½®Merge
3. é‡æ–°è¿è¡Œæ‰¹é‡å·¥å…·

### **Q: æ€§èƒ½é—®é¢˜ï¼Ÿ**
**A: ä¼˜åŒ–ï¼š**
- å¢å¤§detectionIntervalï¼ˆé™ä½æ£€æµ‹é¢‘ç‡ï¼‰
- å‡å°detectionRadiusï¼ˆå‡å°‘æ£€æµ‹èŒƒå›´ï¼‰
- ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆåªæ£€æµ‹å¿…è¦ç‰©ä½“ï¼‰

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### **å·²å®æ–½ä¼˜åŒ–**

1. **ç§»åŠ¨é˜ˆå€¼ï¼š** ç©å®¶ç§»åŠ¨ < 0.1å•ä½æ—¶è·³è¿‡æ£€æµ‹
2. **Yåæ ‡é¢„æ£€æµ‹ï¼š** å¿«é€Ÿæ’é™¤ç©å®¶ä¸Šæ–¹çš„ç‰©ä½“
3. **è·ç¦»è¿‡æ»¤ï¼š** åªæ£€æµ‹åŠå¾„èŒƒå›´å†…çš„ç‰©ä½“
4. **Bounds.Intersectsï¼š** æ¯”ç‰©ç†æŸ¥è¯¢å¿«20å€
5. **å®šæ—¶æ£€æµ‹ï¼š** æ¯0.1ç§’æ£€æµ‹ä¸€æ¬¡ï¼Œè€Œéæ¯å¸§

### **ä¼˜åŒ–å»ºè®®**

- **å¤§åœºæ™¯ï¼š** å¢å¤§æ£€æµ‹é—´éš”åˆ°0.15-0.2ç§’
- **å¯†é›†ç‰©ä½“ï¼š** ä½¿ç”¨æ ‡ç­¾åˆ†ç±»ï¼ŒæŒ‰éœ€æ£€æµ‹
- **ç§»åŠ¨ç«¯ï¼š** é€‚å½“é™ä½æ£€æµ‹åŠå¾„

---

## ğŸ¨ å¯è§†åŒ–è°ƒè¯•

### **Gizmosæ˜¾ç¤º**

å‹¾é€‰ `OcclusionManager.showDebugGizmos = true`

**æ˜¾ç¤ºå†…å®¹ï¼š**
- ğŸŸ¡ é»„è‰²åœ†åœˆï¼šæ£€æµ‹èŒƒå›´
- ğŸŸ¢ ç»¿è‰²æ–¹æ¡†ï¼šç©å®¶Bounds
- ğŸ”´ çº¢è‰²æ–¹æ¡†ï¼šæ­£åœ¨é®æŒ¡çš„ç‰©ä½“Bounds
- ğŸŸ¢ ç»¿è‰²æ¨ªçº¿ï¼šç©å®¶åœ¨è¯¥ç‰©ä½“ä¸‹æ–¹ï¼ˆå¯èƒ½é®æŒ¡ï¼‰
- âšª ç°è‰²æ¨ªçº¿ï¼šç©å®¶åœ¨è¯¥ç‰©ä½“ä¸Šæ–¹ï¼ˆä¸é®æŒ¡ï¼‰

### **Consoleæ—¥å¿—**

ç”Ÿäº§ç¯å¢ƒå·²æ¸…ç†è¯¦ç»†æ—¥å¿—ï¼Œåªä¿ç•™ï¼š
- âŒ é”™è¯¯æ—¥å¿—ï¼ˆç»„ä»¶ç¼ºå¤±ç­‰ï¼‰
- âš ï¸ è­¦å‘Šæ—¥å¿—ï¼ˆé…ç½®é—®é¢˜ç­‰ï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### **èŒè´£åˆ†ç¦»**

```
ç‰©ç†å±‚ï¼ˆColliderï¼‰
â”œâ”€ PolygonCollider2D
â”‚   â””â”€ ç”¨é€”ï¼šç©å®¶ç¢°æ’ã€å¯¼èˆªéšœç¢
â”‚   â””â”€ èŒƒå›´ï¼šæ ‘æ ¹ï¼ˆspriteåº•éƒ¨ï¼‰
â”‚
â””â”€ CompositeCollider2D
    â””â”€ ç”¨é€”ï¼šç»„åˆç¢°æ’ä½“
    â””â”€ èŒƒå›´ï¼šåˆå¹¶æ‰€æœ‰å­Collider

è§†è§‰å±‚ï¼ˆBoundsï¼‰
â””â”€ Sprite.bounds
    â””â”€ ç”¨é€”ï¼šé®æŒ¡æ£€æµ‹
    â””â”€ èŒƒå›´ï¼šå®Œæ•´spriteï¼ˆæ ‘å† ï¼‰
```

### **å•ä¾‹æ¨¡å¼**

```csharp
public class OcclusionManager : MonoBehaviour
{
    private static OcclusionManager instance;
    public static OcclusionManager Instance => instance;
    
    void Awake()
    {
        if (instance != null && instance != this)
        {
            Destroy(gameObject);
            return;
        }
        instance = this;
    }
}
```

### **æ³¨å†Œæ¨¡å¼**

```csharp
// OcclusionTransparencyæ³¨å†Œè‡ªå·±åˆ°Manager
void OnEnable()
{
    StartCoroutine(RegisterDelayed());
}

IEnumerator RegisterDelayed()
{
    yield return null;  // ç­‰å¾…ä¸€å¸§
    OcclusionManager.Instance?.RegisterOccluder(this);
}
```

---

## ğŸ”„ Unity 6 å…¼å®¹

### **APIæ›´æ–°**

```csharp
// âŒ å¼ƒç”¨API
collider.usedByComposite = true;
Object.FindObjectsOfType<GameObject>();

// âœ… æ–°API
collider.compositeOperation = Collider2D.CompositeOperation.Merge;
Object.FindObjectsByType<GameObject>(FindObjectsSortMode.None);
Object.FindFirstObjectByType<T>();
```

### **æ‰€æœ‰è„šæœ¬å·²æ›´æ–°ä¸ºUnity 6æ ‡å‡†**

---

## âœ… æµ‹è¯•éªŒè¯

### **åŠŸèƒ½æµ‹è¯•**

- âœ… ç©å®¶èµ°åˆ°æ ‘ä¸‹ï¼Œæ ‘é€æ˜
- âœ… ç©å®¶ç¦»å¼€æ ‘ï¼Œæ ‘æ¢å¤
- âœ… å¤šæ£µæ ‘åŒæ—¶é€æ˜
- âœ… ä¸åŒå¤§å°çš„æ ‘æ­£ç¡®é€æ˜
- âœ… å»ºç­‘ç‰©é®æŒ¡æ­£å¸¸
- âœ… Orderè®¡ç®—æ­£ç¡®

### **æ€§èƒ½æµ‹è¯•**

- âœ… 100æ£µæ ‘åœºæ™¯æµç•…
- âœ… CPUå ç”¨ä½ï¼ˆ< 0.1ms/å¸§ï¼‰
- âœ… æ— å†…å­˜æ³„æ¼
- âœ… æ— GC Alloc

### **å…¼å®¹æ€§æµ‹è¯•**

- âœ… Unity 6.0+
- âœ… Windowså¹³å°
- âœ… 2Dé¡¹ç›®
- âœ… IL2CPPæ„å»º

---

## ğŸ“ æœ€ç»ˆæ£€æŸ¥æ¸…å•

```
åœºæ™¯é…ç½®
â–¡ OcclusionManagerå·²æ·»åŠ 
â–¡ Playeræ ‡ç­¾æ­£ç¡®
â–¡ ç©å®¶æœ‰SpriteRenderer

ç‰©ä½“é…ç½®
â–¡ æ ‘æœ¨çˆ¶ç‰©ä½“æœ‰Rigidbody2D (Static)
â–¡ æ ‘æœ¨çˆ¶ç‰©ä½“æœ‰CompositeCollider2D (Trigger)
â–¡ æ ‘æœ¨çˆ¶ç‰©ä½“æœ‰OcclusionTransparency
â–¡ æ ‘æœ¨çˆ¶ç‰©ä½“æ— SpriteRenderer
â–¡ Treeå­ç‰©ä½“æœ‰PolygonCollider2D (Merge)
â–¡ Treeå­ç‰©ä½“æœ‰SpriteRenderer

å·¥å…·è„šæœ¬
â–¡ BatchAddOcclusionComponentså¯ç”¨
â–¡ StaticObjectOrderAutoCalibratorè‡ªåŠ¨è¿è¡Œ
â–¡ Orderè®¡ç®—æ­£ç¡®

æµ‹è¯•éªŒè¯
â–¡ ç©å®¶èµ°åˆ°æ ‘ä¸‹ï¼Œæ ‘é€æ˜
â–¡ Consoleæ— é”™è¯¯æ—¥å¿—
â–¡ æ€§èƒ½æ­£å¸¸
```

---

## ğŸ“ æ€»ç»“

é®æŒ¡é€æ˜ç³»ç»Ÿv2.0å·²å®Œå…¨å®ç°å¹¶ä¼˜åŒ–ï¼š

**âœ… åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ  
**âœ… æ€§èƒ½ä¼˜åŒ–** - æ¯”åˆç‰ˆå¿«20å€  
**âœ… ä»£ç ä¼˜åŒ–** - æ¸…ç†è°ƒè¯•æ—¥å¿—ï¼Œç”Ÿäº§å°±ç»ª  
**âœ… Unity 6å…¼å®¹** - ä½¿ç”¨æœ€æ–°API  
**âœ… æ–‡æ¡£å®Œæ•´** - å®Œæ•´çš„ä½¿ç”¨å’ŒæŠ€æœ¯æ–‡æ¡£  

**ç³»ç»Ÿå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼**

---

**ä½œè€…ï¼š** Cascade AI  
**æœ€åæ›´æ–°ï¼š** 2024-12-05  
**ç‰ˆæœ¬ï¼š** v2.0 Final
