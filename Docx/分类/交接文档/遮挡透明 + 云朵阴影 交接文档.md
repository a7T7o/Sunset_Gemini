# Sunset 遮挡透明 + 云朵阴影 交接文档

版本：v2.x  
日期：2025-12-07

---

## 目录
- **项目目标与范围**
- **核心架构概览**
- **文件与路径**
- **运行时流程与关键逻辑**
- **编辑器交互与可视化**
- **树木渐变透明 Shader 设计与使用规范**
- **云朵阴影系统（设计方案）**
- **标签/材质/结构规范**
- **测试与验证清单**
- **常见问题与排查**
- **性能与参数建议**
- **后续扩展与待办**
- **变更记录（近期重要变更）**

---

## 项目目标与范围

- **[遮挡透明]** 玩家被遮挡时，遮挡物透明：
  - 树木：渐变透明（根0.8→干0.5→叶0.3）
  - 其他物体（房子、岩石等）：统一透明（不渐变）
  - 阴影（Shadow）不受透明影响
- **[云朵阴影]** 晴天/多云时渲染“移动的云影”：
  - 置于世界物体之上（UI 之下）
  - 与遮挡透明系统解耦
  - 后续可选“只落地面”方案

---

## 核心架构概览

- **[OcclusionManager.cs]**
  - 负责玩家周围遮挡检测、过滤（标签/同层）、状态切换、调试输出、Gizmos
  - 集中管理全局透明参数 `globalOccludedAlpha`、`globalFadeSpeed`
- **[OcclusionTransparency.cs]**
  - 组件挂在“会被用于遮挡检测”的渲染对象上
  - `OnEnable` 一次性读取 Manager 全局参数（不做运行时参数热更新）
  - 逐帧平滑过渡到目标透明度，`SetOccluding(true/false)` 切换状态
  - 主渲染器 bounds 用于精确检测
  - `HasTag(tag)` 直接使用 `CompareTag`（不再维护组件内字符串数组）
- **[Editor 脚本]**
  - `OcclusionManagerEditor`：标准化 ReorderableList 标签选择、全局透明度设置、调试项
  - `OcclusionTransparencyEditor`：零参数，仅信息提示 + 跳转到 Manager

---

## 文件与路径

- **脚本**
  - `Assets/Scripts/Service/Rendering/OcclusionManager.cs`
  - `Assets/Scripts/Service/Rendering/OcclusionTransparency.cs`
- **编辑器**
  - `Assets/Editor/OcclusionManagerEditor.cs`
  - `Assets/Editor/OcclusionTransparencyEditor.cs`
- **材质与 Shader（树木渐变）**
  - Shader：`Custom/VerticalGradientOcclusion`（建议存放 `Assets/Shaders/VerticalGradientOcclusion.shader`）
  - 材质示例：`Assets/Shaders/Material/TreeOcclusion.mat`（用户自建）
  - 说明：若 Shader 不在项目中，请根据本文“树木渐变透明 Shader 设计与使用规范”创建

---

## 运行时流程与关键逻辑

- **[检测频率]**
  - 由 `detectionInterval` 控制（默认 0.1s），避免每帧检测
- **[检测流程]**
  - 获取玩家 `Bounds`（优先 `playerSprite.bounds`）
  - 按检测半径过滤
  - 标签过滤：`useTagFilter` + `occludableTags`
    - `occluder.HasTag(tag)` → `CompareTag(tag)`（需给对象设置 Unity Tag）
  - 同 Sorting Layer 过滤（可选）：`sameSortingLayerOnly`
  - `Bounds.Intersects` 判定是否遮挡
  - 遮挡成立 → `occluder.SetOccluding(true)`，退出遮挡 → `SetOccluding(false)`
- **[透明参数]**
  - 集中在 Manager：
    - `globalOccludedAlpha`（遮挡时透明度）
    - `globalFadeSpeed`（过渡速度）
  - `OcclusionTransparency.OnEnable()` 读取一次，运行中不热更新

---

## 编辑器交互与可视化

- **[OcclusionManager Inspector]**
  - **玩家引用**：`player`、`playerSorting`（用于获取 Sorting Layer）
  - **检测设置**：`detectionRadius`、`detectionInterval`
  - **透明度设置（全局）**：`globalOccludedAlpha`、`globalFadeSpeed`
  - **过滤设置**：
    - `useTagFilter`：启用/关闭
    - `occludableTags`：ReorderableList + Tag Popup（Unity 标准）
    - `sameSortingLayerOnly`：只检测同层（避免跨楼层影响）
  - **调试**：`showDebugGizmos`、`enableDetailedDebug`（限流输出）
- **[OcclusionTransparency Inspector]**
  - 零参数，提示信息 + 跳转按钮（集中在 Manager 调参）
- **[Gizmos]**
  - 玩家 bounds（绿）、检测圈（黄）、遮挡物 bounds（红半透明 + 线框）
  - Game 视图的“黄色线”通常来自 Gizmos，必要时关闭

---

## 树木渐变透明 Shader 设计与使用规范

- **[目标]**
  - 未遮挡时与 `Sprites/Default` 完全一致
  - 遮挡时才使用垂直渐变（根→干→叶）
- **[关键点]**
  - 使用“预乘输出”（`rgb *= finalAlpha`），避免整块矩形罩子/边线
  - 顶点色 alpha（`SpriteRenderer.color.a`）仅作为“遮挡强度”信号，不直接乘到基底 alpha
  - 混合：`Blend One OneMinusSrcAlpha`，`ZWrite Off`
- **[参数建议]**
  - `Bottom Alpha = 0.8`、`Middle Alpha = 0.5`、`Top Alpha = 0.3`
  - `Split1 = 0.33`、`Split2 = 0.66`、`Softness = 0.05`
  - 材质 Tint = 白色(1,1,1,1)
- **[使用步骤]**
  - 渐变材质仅赋给“树”的 `Tree` 子物体的 `SpriteRenderer`
  - 阴影 `Shadow` 子物体使用默认 Sprite 材质（或“忽略顶点 Alpha”材质），不受透明影响
  - 房子/岩石等不使用渐变材质（按统一透明即可）
- **[常见坑]**
  - 出现“绿色罩子/矩形”：Shader 非预乘、或材质/贴图带色；改为预乘输出
  - 出现重复 Shader/同名文件：只保留单份 Shader 资产，避免编译冲突
  - 未遮挡也变暗：检查 `SpriteRenderer.color.a` 是否为 1、材质 Tint 是否为白色

---

## 云朵阴影系统（设计方案）

- **[目标]**
  - 晴天/多云出现移动云影（全局光照变化效果）
  - 与遮挡透明解耦，不影响 `OcclusionTransparency`
- **[推荐实现：CloudShadowManager]**
  - **渲染方式（二选一或叠加）**
    - **方案 A：精灵云影（推荐）**
      - 若干张大号“云影遮罩精灵”（灰度/Alpha 贴图），使用 Multiply 材质
      - 随机缩放/位置/速度横向移动，可用对象池循环
      - Sorting Layer：`CloudShadow`（在世界物体之上、UI 之下）
    - **方案 B：全屏平铺遮罩**
      - 1~2 张覆盖屏幕的全屏精灵，材质里平铺云影纹理 + UV 偏移模拟移动
      - 对象极少、性能更稳，形态更“整体光照”
  - **天气控制**
    - WeatherManager 状态：Sunny、PartlyCloudy、Overcast、Rain、Snow
    - Sunny：开启，Intensity=0.25~0.4、Speed=0.2~0.6
    - PartlyCloudy：低强度/低密度
    - Overcast / Rain / Snow：关闭
  - **公开参数（Inspector）**
    - **Intensity**（0~1）、**Density**、**ScaleRange**、**Speed/Direction**、**Seed**、**Sorting Layer/Order**、**Weather Gate**
  - **只落地面（可选）**
    - **双相机分层**：CamGround 渲染地面+云影；CamActors 渲染人物/树/房子（不受云影影响）
    - **地面材质采样全局云影**：仅地面材质采样云影纹理，其他材质不采样（复杂度较高）

---

## 标签/材质/结构规范

- **[标签]**
  - Manager 过滤：`useTagFilter` + `occludableTags`
  - 典型值：`"Tree"`, `"Building"`, `"Rock"`（注意与项目实际 Tag 一致）
- **[树的层级结构]**
  - 父物体（种植点）
  - 子物体 `Tree`：SpriteRenderer（赋“渐变材质”）
  - 子物体 `Shadow`：SpriteRenderer（默认材质或“忽略顶点 Alpha”材质）
  - `OcclusionTransparency` 建议挂在 `Tree` 子物体上（最简单、不影响 Shadow）
- **[房子/岩石]**
  - 使用默认 Sprite 材质，不用渐变；仍由 `OcclusionTransparency` 控制统一透明
- **[云影]**
  - Sorting Layer：`CloudShadow`
  - 材质：Multiply（不依赖 `SpriteRenderer.color.a`，不与遮挡透明耦合）

---

## 测试与验证清单

- **[遮挡透明]**
  - 树：未遮挡时外观=原图；遮挡时渐变透明；Shadow 不透明
  - 房子/岩石：遮挡时统一透明（不渐变）
  - 标签过滤正确：仅 `occludableTags` 内对象参与检测
  - 同层过滤：跨楼层不互相影响
- **[编辑器]**
  - Manager Inspector：标签 ReorderableList + 全局透明参数 + 调试项
  - Component Inspector：零参数，仅信息提示与跳转
  - 无 `NullReferenceException`、无引用不存在字段
- **[云影]**
  - 晴天出现、雨雪关闭、阴天弱/关闭
  - 云影连续移动、循环无卡顿
  - 不影响遮挡透明行为
- **[稳定性]**
  - 删除重复 Shader，不报编译错
  - Gizmos 开关正常

---

## 常见问题与排查

- **[出现矩形罩子/边线]**
  - Shader 未做预乘输出或材质 Tint/贴图边缘异常 → 使用预乘输出；Tint=白色；贴图开启 Alpha Is Transparency
- **[无论遮挡与否都变暗]**
  - `SpriteRenderer.color.a` 未恢复到 1；或材质 Tint alpha < 1
- **[阴影跟着透明]**
  - `OcclusionTransparency` 挂在父物体会影响所有子 SR → 把组件挂在 `Tree` 子物体；或给 Shadow 用“忽略顶点 Alpha”材质
- **[Shader 报错 unexpected $end / TOK_SHADER]**
  - Shader 文件被清空/重复 → 只保留一份完整文件，路径与名字唯一；材质引用正确 Shader

---

## 性能与参数建议

- **检测**
  - `detectionInterval=0.1s`、`detectionRadius=8` 初始较稳
  - 仅在玩家位置明显变化时检测（已有距离阈值）
- **云影**
  - 控制精灵数量（1~3 张即可有层次）
  - 使用对象池，限制同时活跃的云影数量/覆盖率
- **日志**
  - `enableDetailedDebug` 默认关闭；开启后有频率限制（每秒一次）

---

## 后续扩展与待办

- **云影只落地面**
  - 转“双相机分层”或“地面材质采样全局云影”方案
- **云影与昼夜/天气联动**
  - 与全局光照、色调、雾效联动过渡
- **材质批量赋予工具**
  - 一键把“渐变材质”应用于选中树的 `Tree` 子物体；避免手动操作

---

## 变更记录（近期重要变更）

- **[编辑器稳定性]**
  - 修复 `OcclusionTransparencyEditor.cs` 的 `NullReferenceException`（移除不存在字段、增加防御性检查）
  - `OcclusionManagerEditor.cs` 增加防御性检查与标准标签交互（ReorderableList + Tag Popup）
- **[参数集中化]**
  - `OccludedAlpha` / `FadeSpeed` 全部集中在 `OcclusionManager`（组件端隐藏，不再在 Inspector 显示）
  - `OcclusionTransparency` 在 `OnEnable` 一次性读取 Manager 参数；不做运行时热更新
- **[标签逻辑]**
  - 组件端删除 `occlusionTags` 数组，使用 `CompareTag`；管理器端保留 `occludableTags` 作为过滤来源
- **[检测准确性]**
  - 删除过度的 Y 方向过滤，采用 `Bounds.Intersects` 精确视觉遮挡
- **[树的渐变透明]**
  - 设计并规范了“垂直渐变透明” Shader/材质的使用方式与参数；明确仅用于树的 `Tree` 子物体
- **[云朵阴影]**
  - 输出了可落地的“Multiply 顶层云影”设计方案（A 精灵云影 / B 全屏平铺），与天气系统联动；提出“只落地面”的两种可选实现

---

# 交付状态

- **遮挡透明系统**：稳定可用，编辑器交互简洁，日志与 Gizmos 可控  
- **树木渐变透明**：设计与规范已确定（Shader/材质使用说明完整）  
- **云朵阴影**：设计方案已给出（可按 A/B 方案落地），与天气联动明确、参数可控

如需我进一步：
- 提交 CloudShadowManager + Multiply 材质 + Inspector（按本文方案）  
- 提供“一键给树应用渐变材质”的 Editor 工具

请告知你的优先级与取舍。
