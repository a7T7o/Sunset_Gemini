# 遮挡透明 + 云朵阴影 交接文档 v2.0

#Create Spec: 云朵素材已就绪；按方案A（精灵云影+Multiply材质）推进 CloudShadowManager，实现参数 Intensity/Density/ScaleRange/Speed/Direction/Seed/SortingLayer/WeatherGate，并与 WeatherManager 联动；遮挡透明继续保持单一真相源于 OcclusionManager，OcclusionTransparency 组件无参数、仅 OnEnable 读取一次。

## 1. 系统概述

### 1.1 核心功能
- **遮挡透明系统**：当玩家被物体遮挡时，自动调整物体透明度
- **云朵阴影系统**：动态生成移动的云影效果，支持天气联动

### 1.2 技术方案
- 使用 `OcclusionManager` 管理遮挡检测
- 采用 `CloudShadowManager` 实现云影效果（方案A：精灵云影）
- 支持编辑器实时预览与调试

## 2. 文件结构

### 2.1 核心脚本
```
Assets/
├── Scripts/Service/Rendering/
│   ├── OcclusionManager.cs    # 遮挡管理主逻辑
│   ├── OcclusionTransparency.cs  # 可遮挡物体组件
│   └── CloudShadowManager.cs  # 云影效果实现（新增）
└── Editor/
    └── CloudShadowManagerEditor.cs  # 云影编辑器扩展（新增）
```

### 2.2 材质与着色器
```
Assets/Shaders/
├── VerticalGradientOcclusion.shader  # 树木渐变透明（待实现）
└── Material/
    └── CloudShadow.mat  # 云影材质（待创建）
```

## 3. 云影系统（方案A）

### 3.1 功能特性
- ✅ 精灵云影对象池
- ✅ 随机位置/缩放/速度
- ✅ 循环移动与自动回收
- ✅ 编辑器实时预览
- ⏳ 天气系统联动（待接入）

### 3.2 参数说明
| 参数 | 类型 | 说明 |
|------|------|------|
| `enableCloudShadows` | bool | 总开关 |
| `intensity` | [0-1] | 云影透明度 |
| `density` | [0-1] | 云影密度 |
| `scaleRange` | Vector2 | 随机缩放范围 |
| `direction` | Vector2 | 移动方向 |
| `speed` | float | 移动速度 |
| `areaSize` | Vector2 | 云影活动区域 |
| `sortingLayerName` | string | 渲染层级 |
| `maxClouds` | int | 最大云影数量 |

## 4. 使用说明

### 4.1 场景配置
1. 创建空物体并添加 `CloudShadowManager` 组件
2. 在 Inspector 中配置云影参数
3. 拖入云影精灵到 `Cloud Sprites` 数组
4. 点击 `Rebuild Now` 预览效果

### 4.2 常用操作
- `Randomize Seed`：重新随机云影分布
- `Preview In Editor`：在编辑器中模拟移动
- `Weather Gate`：配置天气联动参数

## 5. 待办事项

### 5.1 核心功能
- [ ] 导入云影贴图并配置 (cs-01)
- [ ] 添加 Sorting Layer (cs-02)
- [ ] 接入天气系统 (cs-05)
- [ ] 场景验证与性能调优 (cs-08, cs-09)

### 5.2 增强功能
- [ ] 实现方案B：全屏平铺遮罩 (cs-07)
- [ ] 添加树木渐变材质工具 (cs-10, cs-11)
- [ ] 优化 Shader 资源 (cs-15)

## 6. 技术细节

### 6.1 对象池实现
```csharp
private readonly Stack<GameObject> pool = new Stack<GameObject>();
private void SpawnOne() {
    GameObject go = pool.Count > 0 ? pool.Pop() : CreateNewCloud();
    // 初始化云影...
}
```

### 6.2 编辑器扩展
- 自定义 Inspector 布局
- 实时预览开关
- 调试辅助功能

## 7. 注意事项
1. 云影系统独立于遮挡透明系统
2. 建议云影层级设置在世界物体之上、UI之下
3. 性能敏感参数：maxClouds、Update 频率

## 8. 更新日志
- v2.0 (2025-12-09)
  - 新增 CloudShadowManager 核心逻辑
  - 添加编辑器扩展工具
  - 完善对象池与性能优化
  - 更新文档与待办事项
