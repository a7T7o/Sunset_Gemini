# Sunset é¡¹ç›®å…¨å±€åŠŸèƒ½éœ€æ±‚æ€»ç»“æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024å¹´12æœˆ11æ—¥  
**ç›®çš„**: åœ¨è¿›è¡Œæ¶æ„é‡æ„å‰ï¼Œè¯¦ç»†è®°å½•æ‰€æœ‰ç°æœ‰è„šæœ¬çš„åŠŸèƒ½ã€å®ç°é€»è¾‘å’Œä¾èµ–å…³ç³»ï¼Œç¡®ä¿é‡æ„ååŠŸèƒ½å®Œæ•´æ€§

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°é¡¹ç›®ä¸­æ¯ä¸ªè„šæœ¬æ–‡ä»¶çš„ï¼š
1. **åŠŸèƒ½æè¿°** - è„šæœ¬çš„æ ¸å¿ƒèŒè´£
2. **å®ç°çš„éœ€æ±‚** - è¯¥è„šæœ¬æ»¡è¶³çš„ä¸šåŠ¡éœ€æ±‚
3. **å­˜åœ¨çš„æ„ä¹‰** - ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè„šæœ¬
4. **æ ¸å¿ƒå®ç°é€»è¾‘** - å…³é”®ç®—æ³•å’Œä»£ç é€»è¾‘
5. **ä¾èµ–å…³ç³»** - ä¸å…¶ä»–è„šæœ¬çš„äº¤äº’
6. **äº‹ä»¶ç³»ç»Ÿ** - å‘å¸ƒ/è®¢é˜…çš„äº‹ä»¶

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒæœåŠ¡å±‚ (Service)

### 1.1 TimeManager.cs

**è·¯å¾„**: `Assets/Scripts/Service/TimeManager.cs`

**åŠŸèƒ½æè¿°**:
- æ¸¸æˆæ—¶é—´ç®¡ç†å™¨ï¼Œå®ç°æ˜Ÿéœ²è°·ç‰©è¯­é£æ ¼çš„æ—¶é—´ç³»ç»Ÿ
- ç®¡ç†å¹´/å­£/æ—¥/æ—¶/åˆ†çš„æ—¶é—´æµé€
- 1æ¸¸æˆå¤© = 20åˆ†é’Ÿç°å®æ—¶é—´ï¼ˆå¯é…ç½®ï¼‰
- æ¸¸æˆæ—¶é—´èŒƒå›´ï¼š06:00 - 02:00ï¼ˆå‡Œæ™¨2ç‚¹å¼ºåˆ¶ç¡è§‰ï¼‰

**å®ç°çš„éœ€æ±‚**:
- æ¸¸æˆå†…æ—¶é—´æµé€
- æ—¥å¤œå¾ªç¯
- å­£èŠ‚å˜åŒ–è§¦å‘
- ç¡çœ /è·³è¿‡ä¸€å¤©åŠŸèƒ½

**å­˜åœ¨çš„æ„ä¹‰**:
- ä½œä¸ºæ¸¸æˆæ ¸å¿ƒç³»ç»Ÿï¼Œé©±åŠ¨æ‰€æœ‰æ—¶é—´ç›¸å…³çš„æ¸¸æˆé€»è¾‘
- å†œä½œç‰©ç”Ÿé•¿ã€NPCæ—¥ç¨‹ã€å•†åº—è¥ä¸šç­‰éƒ½ä¾èµ–æ­¤ç³»ç»Ÿ

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ—¶é—´ç´¯ç§¯æœºåˆ¶
gameTimeAccumulator += Time.deltaTime * timeScale;
if (gameTimeAccumulator >= realSecondsPerGameMinute)
{
    gameTimeAccumulator -= realSecondsPerGameMinute;
    AdvanceMinute(); // æ¯10åˆ†é’Ÿè§¦å‘ä¸€æ¬¡
}

// æ—¶é—´æ­¥è¿›è®¡ç®—
int totalMinuteSteps = hoursPerDay * minuteStepsPerHour; // 20 * 6 = 120æ­¥/å¤©
realSecondsPerGameMinute = realSecondsPerGameDay / totalMinuteSteps;
```

**äº‹ä»¶ç³»ç»Ÿ**:
- `OnMinuteChanged(int hour, int minute)` - æ¯10åˆ†é’Ÿè§¦å‘
- `OnHourChanged(int hour)` - æ¯å°æ—¶è§¦å‘
- `OnDayChanged(int year, int seasonDay, int totalDays)` - æ¯å¤©è§¦å‘
- `OnSeasonChanged(Season newSeason, int year)` - å­£èŠ‚å˜åŒ–è§¦å‘
- `OnYearChanged(int year)` - å¹´ä»½å˜åŒ–è§¦å‘
- `OnSleep` - ç¡è§‰æ—¶è§¦å‘

**ä¾èµ–å…³ç³»**:
- è¢« `SeasonManager` è®¢é˜…å­£èŠ‚å˜åŒ–
- è¢« `WeatherSystem` è®¢é˜…æ—¥æœŸå˜åŒ–
- è¢« `FarmingManager` è®¢é˜…æ—¥æœŸå˜åŒ–ï¼ˆä½œç‰©ç”Ÿé•¿ï¼‰
- è¢« `TreeController` é—´æ¥ä¾èµ–ï¼ˆé€šè¿‡ SeasonManagerï¼‰

**å…³é”®å‚æ•°**:
- `realSecondsPerGameDay = 1200f` (20åˆ†é’Ÿ)
- `daysPerSeason = 28` (æ¯å­£28å¤©)
- `dayStartHour = 6`, `dayEndHour = 26` (06:00-02:00)

---

### 1.2 SeasonManager.cs

**è·¯å¾„**: `Assets/Scripts/Service/SeasonManager.cs`

**åŠŸèƒ½æè¿°**:
- å­£èŠ‚ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†æ—¥å†å­£èŠ‚å’Œæ¤è¢«å­£èŠ‚
- æ”¯æŒ4ä¸ªæ—¥å†å­£èŠ‚ï¼ˆæ˜¥/å¤/ç§‹/å†¬ï¼‰
- æ”¯æŒ5ä¸ªæ¤è¢«å­£èŠ‚ï¼ˆç”¨äºæ¸å˜æ¢å­£æ•ˆæœï¼‰
- è®¡ç®—å­£èŠ‚è¿‡æ¸¡è¿›åº¦ï¼ˆ0.0-1.0ï¼‰

**å®ç°çš„éœ€æ±‚**:
- å­£èŠ‚æ˜¾ç¤ºå’Œåˆ‡æ¢
- æ¤è¢«æ¸å˜æ¢å­£ï¼ˆæ ‘æœ¨é€æ­¥å˜è‰²ï¼‰
- å­£èŠ‚ç›¸å…³æ¸¸æˆé€»è¾‘è§¦å‘

**å­˜åœ¨çš„æ„ä¹‰**:
- å°†æ—¥å†å­£èŠ‚ä¸æ¤è¢«å­£èŠ‚åˆ†ç¦»ï¼Œå®ç°æ›´è‡ªç„¶çš„æ¢å­£æ•ˆæœ
- æä¾›ç»Ÿä¸€çš„å­£èŠ‚æŸ¥è¯¢æ¥å£

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ¤è¢«å­£èŠ‚è®¡ç®—ï¼ˆ5ä¸ªç»†åˆ†å­£èŠ‚ï¼‰
// æ—©æ˜¥(æ˜¥1-14) â†’ æ™šæ˜¥æ—©å¤(æ˜¥15-å¤14) â†’ æ™šå¤æ—©ç§‹(å¤15-ç§‹14) â†’ æ™šç§‹(ç§‹15-28) â†’ å†¬å­£

// å­£èŠ‚è¿‡æ¸¡è¿›åº¦è®¡ç®—
int dayInTransition = dayInSeason - 14; // 1-14
newProgress = 0.2f + (dayInTransition - 1) / 27f * 0.6f;
// è¿›åº¦èŒƒå›´ï¼š0.2 â†’ 0.8ï¼Œè¡¨ç¤º20%-80%çš„æ¤è¢«æ˜¾ç¤ºæ–°å­£èŠ‚
```

**äº‹ä»¶ç³»ç»Ÿ**:
- `OnSeasonChanged(Season)` - æ—¥å†å­£èŠ‚å˜åŒ–
- `OnVegetationSeasonChanged` - æ¤è¢«å­£èŠ‚å˜åŒ–ï¼ˆæ ‘æœ¨æ›´æ–°æ˜¾ç¤ºï¼‰

**ä¾èµ–å…³ç³»**:
- è®¢é˜… `TimeManager.OnSeasonChanged`
- è®¢é˜… `TimeManager.OnDayChanged`
- è¢« `TreeController` è®¢é˜…æ¤è¢«å­£èŠ‚å˜åŒ–

---

### 1.3 WeatherSystem.cs

**è·¯å¾„**: `Assets/Scripts/Service/WeatherSystem.cs`

**åŠŸèƒ½æè¿°**:
- å¤©æ°”ç³»ç»Ÿï¼Œç®¡ç†æ™´å¤©ã€é›¨å¤©ã€æ¯èå¤©ç­‰æ°”å€™äº‹ä»¶
- æ ¹æ®å­£èŠ‚å’Œæ—¥æœŸè‡ªåŠ¨åˆ‡æ¢å¤©æ°”
- è§¦å‘æ¤ç‰©æ¯è/æ¢å¤äº‹ä»¶

**å®ç°çš„éœ€æ±‚**:
- å¤©æ°”å˜åŒ–æ˜¾ç¤º
- å¤å­£é«˜æ¸©æ¯èæ—¥
- é›¨å¤©è‡ªåŠ¨æµ‡æ°´
- å†¬å­£ä¸‹é›ª/èåŒ–

**å­˜åœ¨çš„æ„ä¹‰**:
- å¢åŠ æ¸¸æˆéšæœºæ€§å’Œç­–ç•¥æ€§
- å½±å“å†œä½œç‰©ç”Ÿé•¿å’Œç©å®¶å†³ç­–

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// å¤å­£å¤©æ°”è§„åˆ™
summerWitheringDays = { 8, 14, 20 }; // æ¯èæ—¥
summerRainyDays = { 1, 4, 6, 10, 18, 26 }; // é›¨å¤©

// é›¨åæ¢å¤æœºåˆ¶
if (lastRainyDay >= 0 && totalDays == lastRainyDay + 1)
{
    TriggerPlantsRecover("é›¨åæ¢å¤");
}
```

**äº‹ä»¶ç³»ç»Ÿ**:
- `OnWeatherChanged(Weather)` - å¤©æ°”å˜åŒ–
- `OnPlantsWither` - æ¤ç‰©æ¯è
- `OnPlantsRecover` - æ¤ç‰©æ¢å¤
- `OnWinterSnow` - å†¬å­£ä¸‹é›ª
- `OnWinterMelt` - å†¬å­£èåŒ–

**ä¾èµ–å…³ç³»**:
- è®¢é˜… `TimeManager.OnDayChanged`
- è®¢é˜… `TimeManager.OnSeasonChanged`
- è¢« `CloudShadowManager` è®¢é˜…å¤©æ°”å˜åŒ–
- è¢« `TreeController` è®¢é˜…æ¯è/æ¢å¤äº‹ä»¶

---

### 1.4 DynamicSortingOrder.cs

**è·¯å¾„**: `Assets/Scripts/Service/DynamicSortingOrder.cs`

**åŠŸèƒ½æè¿°**:
- åŠ¨æ€æ’åºç»„ä»¶ï¼Œæ ¹æ®Yåæ ‡è‡ªåŠ¨è®¡ç®—SortingOrder
- æ”¯æŒCollider/Spriteè¾¹ç•Œè®¡ç®—
- è‡ªåŠ¨å¤„ç†Shadowå­ç‰©ä½“æ’åº

**å®ç°çš„éœ€æ±‚**:
- 2Dæ¸¸æˆä¸­ç‰©ä½“çš„æ­£ç¡®é®æŒ¡å…³ç³»
- ç©å®¶åœ¨ç‰©ä½“å‰åç§»åŠ¨æ—¶çš„æ­£ç¡®æ˜¾ç¤º

**å­˜åœ¨çš„æ„ä¹‰**:
- è§£å†³2Dæ¸¸æˆä¸­çš„æ·±åº¦æ’åºé—®é¢˜
- ç»Ÿä¸€çš„æ’åºè®¡ç®—é€»è¾‘

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ’åºYåæ ‡è®¡ç®—ä¼˜å…ˆçº§
// 1. Collider2D.bounds.min.yï¼ˆæœ€å‡†ç¡®ï¼‰
// 2. Sprite.bounds.min.yï¼ˆå›é€€ï¼‰
// 3. Transform.position.yï¼ˆæœ€åå›é€€ï¼‰

// Orderè®¡ç®—å…¬å¼
int calculatedOrder = -Mathf.RoundToInt(sortingY * sortingOrderMultiplier) + sortingOrderOffset;
// Yè¶Šå°ï¼ˆè¶Šä¸‹é¢ï¼‰â†’ Orderè¶Šå¤§ â†’ æ˜¾ç¤ºåœ¨å‰é¢

// Shadowå¤„ç†
shadowRenderer.sortingOrder = calculatedOrder + shadowOrderOffset; // é€šå¸¸-1
```

**ä¾èµ–å…³ç³»**:
- æŒ‚è½½åœ¨éœ€è¦åŠ¨æ€æ’åºçš„ç‰©ä½“ä¸Š
- ä¸ `OcclusionTransparency` é…åˆä½¿ç”¨

---



## ç¬¬äºŒéƒ¨åˆ†ï¼šç©å®¶ç³»ç»Ÿ (Player)

### 2.1 PlayerMovement.cs

**è·¯å¾„**: `Assets/Scripts/Service/Player/PlayerMovement.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶ç§»åŠ¨æ§åˆ¶ï¼Œå¤„ç†WASDè¾“å…¥
- æ”¯æŒè¡Œèµ°å’Œè·‘æ­¥ä¸¤ç§é€Ÿåº¦
- ä¸åŠ¨ç”»ç³»ç»Ÿè”åŠ¨

**å®ç°çš„éœ€æ±‚**:
- ç©å®¶å…«æ–¹å‘ç§»åŠ¨
- è¡Œèµ°/è·‘æ­¥åˆ‡æ¢
- åŠ¨ä½œæ‰§è¡Œæ—¶ç¦æ­¢ç§»åŠ¨

**å­˜åœ¨çš„æ„ä¹‰**:
- åˆ†ç¦»ç§»åŠ¨é€»è¾‘ä¸è¾“å…¥æ£€æµ‹
- ç»Ÿä¸€çš„ç§»åŠ¨é€Ÿåº¦ç®¡ç†

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// ç§»åŠ¨é€Ÿåº¦åˆ‡æ¢
float currentSpeed = isShiftHeld ? RunSpeed : WalkSpeed;
rb.linearVelocity = movementInput.normalized * currentSpeed;

// æ–¹å‘åˆ¤æ–­
if (Mathf.Abs(movementInput.y) > Mathf.Abs(movementInput.x))
    return movementInput.y > 0 ? Up : Down;
else
    return movementInput.x > 0 ? Right : Left;

// åŠ¨ä½œä¸­ç¦æ­¢ç§»åŠ¨
if (playerInteraction.IsPerformingAction())
{
    rb.linearVelocity = Vector2.zero;
    return;
}
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `PlayerAnimController` æ’­æ”¾åŠ¨ç”»
- ä¾èµ– `PlayerInteraction` æ£€æŸ¥åŠ¨ä½œçŠ¶æ€
- ä¾èµ– `SprintStateManager` è·å–ç–¾è·‘çŠ¶æ€
- è¢« `GameInputManager` è°ƒç”¨è®¾ç½®è¾“å…¥

**å…³é”®å‚æ•°**:
- `RunSpeed = 4f`
- `WalkSpeed = 2f`

---

### 2.2 PlayerInteraction.cs

**è·¯å¾„**: `Assets/Scripts/Service/Player/PlayerInteraction.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶äº¤äº’ç³»ç»Ÿï¼Œå¤„ç†å„ç§åŠ¨ä½œï¼ˆç æ ‘ã€æŒ–çŸ¿ã€æµ‡æ°´ç­‰ï¼‰
- ç®¡ç†åŠ¨ä½œçŠ¶æ€ï¼ˆæ˜¯å¦æ­£åœ¨æ‰§è¡ŒåŠ¨ä½œï¼‰
- ç®¡ç†æ¬è¿çŠ¶æ€

**å®ç°çš„éœ€æ±‚**:
- å·¥å…·ä½¿ç”¨åŠ¨ä½œ
- åŠ¨ä½œå®Œæˆæ£€æµ‹
- æ¬è¿ç‰©å“çŠ¶æ€

**å­˜åœ¨çš„æ„ä¹‰**:
- ç»Ÿä¸€ç®¡ç†ç©å®¶çš„æ‰€æœ‰äº¤äº’åŠ¨ä½œ
- é˜²æ­¢åŠ¨ä½œé‡å å’Œå†²çª

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// åŠ¨ä½œæ‰§è¡Œ
private void PerformAction(AnimState action)
{
    if (isPerformingAction) return;
    
    isPerformingAction = true;
    currentAction = action;
    actionStartTime = Time.time;
    
    playerMovement.StopMovement();
    animController.PlayAnimation(action, direction, shouldFlip);
}

// åŠ¨ä½œå®Œæˆæ£€æµ‹
if (timeElapsed && animController.IsAnimationFinished())
{
    OnActionComplete();
}
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `PlayerAnimController` æ’­æ”¾åŠ¨ç”»
- ä¾èµ– `PlayerMovement` åœæ­¢ç§»åŠ¨
- è¢« `GameInputManager` è°ƒç”¨è¯·æ±‚åŠ¨ä½œ

---

### 2.3 PlayerAnimController.cs

**è·¯å¾„**: `Assets/Scripts/Anim/Player/PlayerAnimController.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶åŠ¨ç”»æ§åˆ¶å™¨ï¼Œç®¡ç†æ‰€æœ‰ç©å®¶åŠ¨ç”»çŠ¶æ€
- æ”¯æŒ12ç§åŠ¨ç”»çŠ¶æ€ï¼ˆIdle/Walk/Run/Carry/Collect/Hit/Slice/Pierce/Crush/Fish/Watering/Deathï¼‰
- æ”¯æŒ4ä¸ªæ–¹å‘ï¼ˆDown/Up/Right/Leftï¼‰
- å¤„ç†ç²¾çµç¿»è½¬å’Œé˜´å½±åŒæ­¥

**å®ç°çš„éœ€æ±‚**:
- ç©å®¶åŠ¨ç”»æ’­æ”¾
- æ–¹å‘åˆ‡æ¢
- åŠ¨ç”»å®Œæˆæ£€æµ‹

**å­˜åœ¨çš„æ„ä¹‰**:
- ç»Ÿä¸€çš„åŠ¨ç”»æ’­æ”¾æ¥å£
- å°è£…Animatorå‚æ•°è®¾ç½®

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// åŠ¨ç”»çŠ¶æ€æšä¸¾
public enum AnimState
{
    Idle = 0, Walk = 1, Run = 2, Carry = 3, Collect = 4,
    Hit = 5, Slice = 6, Pierce = 7, Crush = 8, Fish = 9,
    Watering = 10, Death = 11
}

// æ–¹å‘è½¬æ¢ï¼ˆLeftä½¿ç”¨RightåŠ¨ç”»+ç¿»è½¬ï¼‰
private int ConvertToAnimatorDirection(AnimDirection direction)
{
    return direction switch
    {
        Down => 0, Up => 1, Right => 2, Left => 2, _ => 0
    };
}

// åŠ¨ç”»å®Œæˆæ£€æµ‹
public bool IsAnimationFinished()
{
    AnimatorStateInfo stateInfo = animator.GetCurrentAnimatorStateInfo(0);
    return stateInfo.normalizedTime >= 1.0f && !animator.IsInTransition(0);
}
```

**ä¾èµ–å…³ç³»**:
- è¢« `PlayerMovement` è°ƒç”¨æ’­æ”¾ç§»åŠ¨åŠ¨ç”»
- è¢« `PlayerInteraction` è°ƒç”¨æ’­æ”¾åŠ¨ä½œåŠ¨ç”»
- è¢« `LayerAnimSync` è¯»å–çŠ¶æ€è¿›è¡Œå·¥å…·åŒæ­¥

---

### 2.4 PlayerToolController.cs

**è·¯å¾„**: `Assets/Scripts/Anim/Player/PlayerToolController.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶å·¥å…·æ§åˆ¶å™¨ï¼Œç®¡ç†å½“å‰è£…å¤‡çš„å·¥å…·
- è®¾ç½®å·¥å…·Animatorå‚æ•°
- ä¸åŠ¨ç”»åŒæ­¥ç³»ç»Ÿé…åˆ

**å®ç°çš„éœ€æ±‚**:
- å·¥å…·åˆ‡æ¢
- å·¥å…·åŠ¨ç”»å‚æ•°è®¾ç½®
- å·¥å…·å“è´¨æ˜ å°„

**å­˜åœ¨çš„æ„ä¹‰**:
- åˆ†ç¦»å·¥å…·ç®¡ç†ä¸ç©å®¶åŠ¨ç”»
- æ”¯æŒå·¥å…·å“è´¨ç³»ç»Ÿ

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// è£…å¤‡å·¥å…·
public void EquipToolData(ToolData toolData, int quality)
{
    currentToolData = toolData;
    currentQuality = quality;
    
    // è®¾ç½®Animatorå‚æ•°
    toolAnimator.SetInteger("ToolItemId", toolData.GetAnimationKeyId());
    toolAnimator.SetInteger("ToolQuality", quality);
}

// åŠ¨ç”»IDæ˜ å°„
int animId = toolData.GetAnimationKeyId();
// å¦‚æœå¯ç”¨å“è´¨æ˜ å°„ï¼Œä¸åŒå“è´¨å·¥å…·ä½¿ç”¨ç›¸åŒåŠ¨ç”»ID
```

**ä¾èµ–å…³ç³»**:
- è¢« `HotbarSelectionService` è°ƒç”¨è£…å¤‡å·¥å…·
- ä¸ `LayerAnimSync` é…åˆå®ç°å¸§åŒæ­¥

---

### 2.5 LayerAnimSync.cs

**è·¯å¾„**: `Assets/Scripts/Anim/_...._/LayerAnimSync.cs`

**åŠŸèƒ½æè¿°**:
- å·¥å…·åŠ¨ç”»åŒæ­¥ç³»ç»Ÿï¼ˆMode A++ å¸§ç´¢å¼•ç¡¬é”ï¼‰
- å®ç°ç©å®¶ä¸å·¥å…·åŠ¨ç”»çš„é›¶å¸§å»¶è¿ŸåŒæ­¥
- å¤„ç†æ˜¾éšã€æ’åºã€ç¿»è½¬åŒæ­¥

**å®ç°çš„éœ€æ±‚**:
- å·¥å…·åŠ¨ç”»ä¸ç©å®¶åŠ¨ç”»å®Œç¾åŒæ­¥
- æ¶ˆé™¤åŠ¨ç”»æ‹–å½±
- æ­£ç¡®çš„æ¸²æŸ“é¡ºåº

**å­˜åœ¨çš„æ„ä¹‰**:
- è§£å†³å·¥å…·åŠ¨ç”»å»¶è¿Ÿé—®é¢˜
- å®ç°ä¸“ä¸šçº§çš„åŠ¨ç”»åŒæ­¥æ•ˆæœ

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// å¸§ç´¢å¼•ç¡¬é”åŒæ­¥
// 1. ä»ç©å®¶Spriteåç§°è§£æå¸§å·
int playerFrame = ParseFrameFromSpriteName(playerSprite.sprite.name);

// 2. æŒ‰å¸§æ•°æ¯”ä¾‹æ˜ å°„åˆ°å·¥å…·å¸§å·
float toolNormalized = (playerFrame + 1e-6f) / totalFrames;

// 3. å¼ºåˆ¶åŒæ­¥
toolAnimator.Play(targetHash, 0, toolNormalized);
toolAnimator.Update(0);

// 4. åŒæ­¥æ˜¾éšå’Œæ’åº
toolRenderer.sortingOrder = playerRenderer.sortingOrder - 1;
toolRenderer.flipX = playerRenderer.flipX;
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `PlayerAnimController` è¯»å–ç©å®¶çŠ¶æ€
- ä¾èµ– `PlayerToolController` è·å–å·¥å…·æ•°æ®
- è¯»å–ç©å®¶ `SpriteRenderer` çš„spriteåç§°

---

### 2.6 PlayerController.cs

**è·¯å¾„**: `Assets/Scripts/Controller/Player/PlayerController.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶ä¸»æ§åˆ¶å™¨ï¼Œç®¡ç†ç©å®¶å±æ€§
- å¯é€‰çš„ä¼ ç»Ÿè¾“å…¥å¤„ç†ï¼ˆå·²å¼ƒç”¨ï¼Œä½¿ç”¨GameInputManagerï¼‰

**å®ç°çš„éœ€æ±‚**:
- ç©å®¶å±æ€§ç®¡ç†ï¼ˆHPã€Energyï¼‰
- ç»„ä»¶å¼•ç”¨ç®¡ç†

**å­˜åœ¨çš„æ„ä¹‰**:
- ä½œä¸ºç©å®¶çš„ä¸»å…¥å£ç»„ä»¶
- ç®¡ç†ç©å®¶æ ¸å¿ƒå±æ€§

**å…³é”®å‚æ•°**:
- `HpMax = 5`
- `EnergyMax = 180`

---

### 2.7 SprintStateManager.cs

**è·¯å¾„**: `Assets/Scripts/Service/Player/SprintStateManager.cs`

**åŠŸèƒ½æè¿°**:
- ç–¾è·‘çŠ¶æ€ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†ç–¾è·‘çŠ¶æ€
- æ”¯æŒæŒ‰ä½Shiftç–¾è·‘å’Œåˆ‡æ¢ç–¾è·‘æ¨¡å¼

**å®ç°çš„éœ€æ±‚**:
- ç–¾è·‘çŠ¶æ€ç»Ÿä¸€ç®¡ç†
- å¤šç§ç–¾è·‘æ¨¡å¼æ”¯æŒ

**å­˜åœ¨çš„æ„ä¹‰**:
- é¿å…å¤šä¸ªç»„ä»¶å„è‡ªç®¡ç†ç–¾è·‘çŠ¶æ€
- æä¾›ç»Ÿä¸€çš„ç–¾è·‘æŸ¥è¯¢æ¥å£

---

### 2.8 PlayerAutoNavigator.cs

**è·¯å¾„**: `Assets/Scripts/Service/Player/PlayerAutoNavigator.cs`

**åŠŸèƒ½æè¿°**:
- ç©å®¶è‡ªåŠ¨å¯¼èˆªç³»ç»Ÿï¼Œå®ç°ç‚¹å‡»ç§»åŠ¨
- ä½¿ç”¨A*å¯»è·¯ç®—æ³•
- æ”¯æŒè·¯å¾„å¯è§†åŒ–

**å®ç°çš„éœ€æ±‚**:
- ç‚¹å‡»åœ°é¢è‡ªåŠ¨ç§»åŠ¨
- ç»•è¿‡éšœç¢ç‰©
- è·¯å¾„æ˜¾ç¤º

**å­˜åœ¨çš„æ„ä¹‰**:
- æä¾›ä¾¿æ·çš„ç§»åŠ¨æ–¹å¼
- ä¸NavGrid2Dé…åˆå®ç°å¯»è·¯

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `NavGrid2D` è¿›è¡Œå¯»è·¯
- ä¾èµ– `PlayerMovement` æ§åˆ¶ç§»åŠ¨

---

### 2.9 AutoPickupService.cs

**è·¯å¾„**: `Assets/Scripts/Service/Player/AutoPickupService.cs`

**åŠŸèƒ½æè¿°**:
- è‡ªåŠ¨æ‹¾å–æœåŠ¡ï¼Œæ£€æµ‹å¹¶æ‹¾å–é™„è¿‘çš„æ‰è½ç‰©

**å®ç°çš„éœ€æ±‚**:
- è‡ªåŠ¨æ‹¾å–æ‰è½ç‰©å“
- æ‹¾å–èŒƒå›´é…ç½®

---



## ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾“å…¥ç³»ç»Ÿ (Input)

### 3.1 GameInputManager.cs

**è·¯å¾„**: `Assets/Scripts/Controller/Input/GameInputManager.cs`

**åŠŸèƒ½æè¿°**:
- é›†ä¸­å¼è¾“å…¥ç®¡ç†å™¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰æ¸¸æˆè¾“å…¥
- ç®¡ç†ç§»åŠ¨ã€å·¥å…·ä½¿ç”¨ã€UIå¿«æ·é”®ç­‰
- ä¸æ–°ç‰ˆInput Systemé›†æˆ

**å®ç°çš„éœ€æ±‚**:
- ç»Ÿä¸€çš„è¾“å…¥å¤„ç†å…¥å£
- å¿«æ·é”®ç³»ç»Ÿ
- å·¥å…·æ åˆ‡æ¢

**å­˜åœ¨çš„æ„ä¹‰**:
- é¿å…è¾“å…¥é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªè„šæœ¬ä¸­
- ä¾¿äºä¿®æ”¹æŒ‰é”®ç»‘å®š
- æ”¯æŒå¤šç§è¾“å…¥è®¾å¤‡

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// ç§»åŠ¨è¾“å…¥å¤„ç†
Vector2 moveInput = inputActions.Player.Move.ReadValue<Vector2>();
playerMovement.SetMovementInput(moveInput, isShiftHeld);

// å·¥å…·ä½¿ç”¨
if (inputActions.Player.UseCurrentTool.triggered)
{
    HandleUseCurrentTool();
}

// UIå¿«æ·é”®
if (Input.GetKeyDown(KeyCode.Tab) || Input.GetKeyDown(KeyCode.B))
    TogglePackagePanel(0); // Propsé¡µ
if (Input.GetKeyDown(KeyCode.M))
    TogglePackagePanel(3); // Mapé¡µ
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `PlayerMovement` è®¾ç½®ç§»åŠ¨è¾“å…¥
- ä¾èµ– `PlayerInteraction` è¯·æ±‚åŠ¨ä½œ
- ä¾èµ– `HotbarSelectionService` åˆ‡æ¢å·¥å…·æ 
- ä¾èµ– `PackagePanelTabsUI` æ§åˆ¶UIé¢æ¿

---

## ç¬¬å››éƒ¨åˆ†ï¼šç‰©å“ä¸èƒŒåŒ…ç³»ç»Ÿ (Inventory)

### 4.1 ItemData.cs (åŸºç±»)

**è·¯å¾„**: `Assets/Scripts/Data/Items/ItemData.cs`

**åŠŸèƒ½æè¿°**:
- ç‰©å“æ•°æ®åŸºç±»ï¼ˆScriptableObjectï¼‰
- å®šä¹‰æ‰€æœ‰ç‰©å“çš„é€šç”¨å±æ€§

**å®ç°çš„éœ€æ±‚**:
- ç‰©å“åŸºç¡€å±æ€§å®šä¹‰
- ç‰©å“åˆ†ç±»ç³»ç»Ÿ

**æ ¸å¿ƒå­—æ®µ**:
```csharp
int itemID;           // å”¯ä¸€ID
string itemName;      // ç‰©å“åç§°
string description;   // æè¿°
Sprite icon;          // å›¾æ ‡
ItemCategory category; // åˆ†ç±»
int buyPrice;         // è´­ä¹°ä»·æ ¼
int sellPrice;        // å‡ºå”®ä»·æ ¼
int maxStackSize;     // æœ€å¤§å †å æ•°
```

---

### 4.2 ToolData.cs

**è·¯å¾„**: `Assets/Scripts/Data/Items/ToolData.cs`

**åŠŸèƒ½æè¿°**:
- å·¥å…·æ•°æ®ç±»ï¼Œç»§æ‰¿ItemData
- å®šä¹‰å·¥å…·ç‰¹æœ‰å±æ€§

**æ ¸å¿ƒå­—æ®µ**:
```csharp
ToolType toolType;           // å·¥å…·ç±»å‹ï¼ˆAxe/Pickaxe/Hoe/WateringCan/Sickle/FishingRodï¼‰
ToolLevel toolLevel;         // å·¥å…·ç­‰çº§
float energyCost;            // ç²¾åŠ›æ¶ˆè€—
int effectRadius;            // ä½œç”¨èŒƒå›´
bool useQualityIdMapping;    // åŠ¨ç”»IDæ˜ å°„å¼€å…³
int animationDefaultId;      // é»˜è®¤åŠ¨ç”»ID

// è·å–åŠ¨ç”»åŒ¹é…ID
public int GetAnimationKeyId()
{
    return useQualityIdMapping ? animationDefaultId : itemID;
}
```

---

### 4.3 WeaponData.cs

**è·¯å¾„**: `Assets/Scripts/Data/Items/WeaponData.cs`

**åŠŸèƒ½æè¿°**:
- æ­¦å™¨æ•°æ®ç±»ï¼Œç»§æ‰¿ItemData
- å®šä¹‰æ­¦å™¨æˆ˜æ–—å±æ€§

**æ ¸å¿ƒå­—æ®µ**:
```csharp
WeaponType weaponType;       // æ­¦å™¨ç±»å‹
int attackPower;             // æ”»å‡»åŠ›
float attackSpeed;           // æ”»å‡»é€Ÿåº¦
float criticalChance;        // æš´å‡»ç‡
float criticalDamage;        // æš´å‡»ä¼¤å®³
float attackRange;           // æ”»å‡»èŒƒå›´
float knockbackForce;        // å‡»é€€åŠ›åº¦
float energyCostPerAttack;   // æ¯æ¬¡æ”»å‡»ç²¾åŠ›æ¶ˆè€—
```

---

### 4.4 SeedData.cs

**è·¯å¾„**: `Assets/Scripts/Data/Items/SeedData.cs`

**åŠŸèƒ½æè¿°**:
- ç§å­æ•°æ®ç±»ï¼Œç»§æ‰¿ItemData
- å®šä¹‰ç§å­å’Œä½œç‰©ç”Ÿé•¿å±æ€§

**æ ¸å¿ƒå­—æ®µ**:
```csharp
int growthDays;              // ç”Ÿé•¿å¤©æ•°
Season season;               // é€‚åˆå­£èŠ‚
int harvestCropID;           // æ”¶è·ä½œç‰©ID
Vector2Int harvestAmountRange; // æ”¶è·æ•°é‡èŒƒå›´
```

---

### 4.5 ItemDatabase.cs

**è·¯å¾„**: `Assets/Scripts/Data/Database/ItemDatabase.cs`

**åŠŸèƒ½æè¿°**:
- ç‰©å“æ•°æ®åº“ï¼Œå­˜å‚¨æ‰€æœ‰ç‰©å“æ•°æ®çš„å¼•ç”¨
- æä¾›ç‰©å“æŸ¥è¯¢æ¥å£

**å®ç°çš„éœ€æ±‚**:
- ç‰©å“æ•°æ®é›†ä¸­ç®¡ç†
- é€šè¿‡IDå¿«é€ŸæŸ¥è¯¢ç‰©å“

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// é€šè¿‡IDè·å–ç‰©å“
public ItemData GetItemById(int itemId)
{
    return allItems.Find(item => item.itemID == itemId);
}

// é€šè¿‡ç±»å‹è·å–ç‰©å“åˆ—è¡¨
public List<T> GetItemsByType<T>() where T : ItemData
{
    return allItems.OfType<T>().ToList();
}
```

**æ³¨æ„äº‹é¡¹**:
- ItemDatabaseæ˜¯ScriptableObjectï¼Œä¸æ˜¯å•ä¾‹
- ä¸èƒ½ä½¿ç”¨FindFirstObjectByTypeè·å–
- åº”é€šè¿‡å·²æœ‰å¼•ç”¨çš„MonoBehaviourè·å–

---

### 4.6 ItemStack.cs

**è·¯å¾„**: `Assets/Scripts/Service/Inventory/ItemStack.cs`

**åŠŸèƒ½æè¿°**:
- ç‰©å“å †å ç»“æ„ï¼Œè¡¨ç¤ºèƒŒåŒ…ä¸­çš„ä¸€æ ¼ç‰©å“

**æ ¸å¿ƒç»“æ„**:
```csharp
public struct ItemStack
{
    public int itemId;    // ç‰©å“ID
    public int quality;   // å“è´¨ç­‰çº§
    public int amount;    // æ•°é‡
    public bool IsEmpty => itemId < 0 || amount <= 0;
}
```

---

### 4.7 InventoryService.cs

**è·¯å¾„**: `Assets/Scripts/Service/Inventory/InventoryService.cs`

**åŠŸèƒ½æè¿°**:
- èƒŒåŒ…æœåŠ¡ï¼Œç®¡ç†ç©å®¶èƒŒåŒ…æ•°æ®
- å¤„ç†ç‰©å“æ·»åŠ ã€ç§»é™¤ã€å †å 

**å®ç°çš„éœ€æ±‚**:
- èƒŒåŒ…ç‰©å“ç®¡ç†
- ç‰©å“å †å é€»è¾‘
- èƒŒåŒ…å®¹é‡é™åˆ¶

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ·»åŠ ç‰©å“
public bool AddItem(int itemId, int quality, int amount)
{
    // 1. å°è¯•å †å åˆ°å·²æœ‰æ ¼å­
    // 2. å¦‚æœå †å æ»¡äº†ï¼Œæ”¾å…¥ç©ºæ ¼å­
    // 3. å¦‚æœæ²¡æœ‰ç©ºæ ¼å­ï¼Œè¿”å›false
}

// ç§»é™¤ç‰©å“
public bool RemoveItem(int itemId, int quality, int amount)
{
    // ä»èƒŒåŒ…ä¸­ç§»é™¤æŒ‡å®šæ•°é‡çš„ç‰©å“
}
```

**å®¹é‡é…ç½®**:
- ä¸»èƒŒåŒ…ï¼š20æ ¼
- å¿«æ·æ ï¼š8æ ¼

---

### 4.8 HotbarSelectionService.cs

**è·¯å¾„**: `Assets/Scripts/Service/Inventory/HotbarSelectionService.cs`

**åŠŸèƒ½æè¿°**:
- å¿«æ·æ é€‰æ‹©æœåŠ¡ï¼Œç®¡ç†å½“å‰é€‰ä¸­çš„å·¥å…·æ æ§½ä½
- è§¦å‘å·¥å…·è£…å¤‡

**å®ç°çš„éœ€æ±‚**:
- å·¥å…·æ æ§½ä½é€‰æ‹©
- å·¥å…·è£…å¤‡è§¦å‘

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// é€‰æ‹©æ§½ä½
public void SelectIndex(int index)
{
    currentIndex = index;
    EquipCurrentTool();
}

// è£…å¤‡å½“å‰å·¥å…·
private void EquipCurrentTool()
{
    ItemStack stack = inventoryService.GetHotbarSlot(currentIndex);
    if (stack.IsEmpty) return;
    
    ItemData itemData = database.GetItemById(stack.itemId);
    if (itemData is ToolData toolData)
    {
        playerToolController.EquipToolData(toolData, stack.quality);
    }
}
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `InventoryService` è·å–æ§½ä½æ•°æ®
- ä¾èµ– `PlayerToolController` è£…å¤‡å·¥å…·
- è¢« `GameInputManager` è°ƒç”¨åˆ‡æ¢æ§½ä½

---

### 4.9 EquipmentService.cs

**è·¯å¾„**: `Assets/Scripts/Service/Equipment/EquipmentService.cs`

**åŠŸèƒ½æè¿°**:
- è£…å¤‡æœåŠ¡ï¼Œç®¡ç†ç©å®¶è£…å¤‡æ§½ä½

**å®ç°çš„éœ€æ±‚**:
- è£…å¤‡ç©¿æˆ´/å¸ä¸‹
- è£…å¤‡å±æ€§åŠ æˆ

---



## ç¬¬äº”éƒ¨åˆ†ï¼šå¯¼èˆªç³»ç»Ÿ (Navigation)

### 5.1 NavGrid2D.cs

**è·¯å¾„**: `Assets/Scripts/Service/Navigation/NavGrid2D.cs`

**åŠŸèƒ½æè¿°**:
- 2Då¯¼èˆªç½‘æ ¼ç³»ç»Ÿï¼Œå®ç°A*å¯»è·¯ç®—æ³•
- æ”¯æŒå…«æ–¹å‘ç§»åŠ¨å’Œä¸¥æ ¼å¯¹è§’çº¿æ£€æµ‹
- è‡ªåŠ¨æ£€æµ‹ä¸–ç•Œè¾¹ç•Œå’Œéšœç¢ç‰©

**å®ç°çš„éœ€æ±‚**:
- A*å¯»è·¯ç®—æ³•
- åŠ¨æ€éšœç¢ç‰©æ£€æµ‹
- ä¸–ç•Œè¾¹ç•Œè‡ªåŠ¨æ£€æµ‹

**å­˜åœ¨çš„æ„ä¹‰**:
- ä¸ºç©å®¶è‡ªåŠ¨å¯¼èˆªå’ŒNPC AIæä¾›å¯»è·¯æ”¯æŒ
- ç»Ÿä¸€çš„éšœç¢ç‰©ç®¡ç†

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// A*å¯»è·¯æ ¸å¿ƒ
public List<Vector2> FindPath(Vector2 start, Vector2 end)
{
    // 1. åˆå§‹åŒ–å¼€æ”¾åˆ—è¡¨å’Œå…³é—­åˆ—è¡¨
    // 2. è®¡ç®—å¯å‘å¼è·ç¦»ï¼ˆæ›¼å“ˆé¡¿æˆ–æ¬§å‡ é‡Œå¾—ï¼‰
    // 3. æ‰©å±•èŠ‚ç‚¹ï¼Œæ£€æŸ¥å…«ä¸ªæ–¹å‘
    // 4. ä¸¥æ ¼å¯¹è§’çº¿æ£€æµ‹ï¼ˆé˜²æ­¢ç©¿å¢™ï¼‰
    // 5. å›æº¯è·¯å¾„
}

// å¤šç‚¹éšœç¢ç‰©æ£€æµ‹ï¼ˆä¸­å¿ƒ+å››è§’äº”ç‚¹é‡‡æ ·ï¼‰
private bool IsWalkable(Vector2Int gridPos)
{
    Vector2 worldPos = GridToWorld(gridPos);
    // æ£€æµ‹ä¸­å¿ƒç‚¹å’Œå››ä¸ªè§’ç‚¹
    // ä»»ä¸€ç‚¹æœ‰éšœç¢ç‰©åˆ™ä¸å¯é€šè¡Œ
}

// ä¸–ç•Œè¾¹ç•Œè‡ªåŠ¨æ£€æµ‹
private void CalculateWorldBounds()
{
    // æ‰«ææ‰€æœ‰Tilemapçš„è”åˆè¾¹ç•Œ
    // å±‚çº§è¿‡æ»¤ï¼šåªåŒ…å«LAYER 1/2/3ä¸‹çš„å¯¹è±¡
    // æ’é™¤ç©å®¶å’Œä¸´æ—¶ç‰©ä½“
}
```

**äº‹ä»¶ç³»ç»Ÿ**:
- `OnRequestGridRefresh` - è¯·æ±‚åˆ·æ–°å¯¼èˆªç½‘æ ¼ï¼ˆé™æ€äº‹ä»¶ï¼‰

**å…³é”®å‚æ•°**:
- `cellSize = 0.5f` - ç½‘æ ¼å•å…ƒå¤§å°
- `boundsPadding = 5` - è¾¹ç•Œæ‰©å±•
- æ¨èåœºæ™¯å¤§å°ï¼š100x80ï¼ˆ~150msé‡å»ºï¼‰

**ä¾èµ–å…³ç³»**:
- è¢« `PlayerAutoNavigator` è°ƒç”¨å¯»è·¯
- è¢« `TreeController` è§¦å‘åˆ·æ–°ï¼ˆç¢°æ’ä½“çŠ¶æ€å˜åŒ–æ—¶ï¼‰

---

### 5.2 INavigationUnit.cs

**è·¯å¾„**: `Assets/Scripts/Service/Navigation/INavigationUnit.cs`

**åŠŸèƒ½æè¿°**:
- å¯¼èˆªå•å…ƒæ¥å£ï¼Œå®šä¹‰å¯å¯¼èˆªå¯¹è±¡çš„é€šç”¨æ¥å£

**å®ç°çš„éœ€æ±‚**:
- ç»Ÿä¸€çš„å¯¼èˆªå¯¹è±¡æ¥å£
- æ”¯æŒå¤šç§å¯¼èˆªå•å…ƒç±»å‹

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæ¸²æŸ“ç³»ç»Ÿ (Rendering)

### 6.1 OcclusionManager.cs

**è·¯å¾„**: `Assets/Scripts/Service/Rendering/OcclusionManager.cs`

**åŠŸèƒ½æè¿°**:
- é®æŒ¡ç®¡ç†å™¨ï¼Œæ£€æµ‹ç©å®¶è¢«é®æŒ¡æƒ…å†µ
- ç®¡ç†æ‰€æœ‰å¯é®æŒ¡ç‰©ä½“çš„é€æ˜åº¦
- å®ç°æ ‘æ—æ•´ä½“é€æ˜ï¼ˆFlood Fillç®—æ³•ï¼‰

**å®ç°çš„éœ€æ±‚**:
- ç©å®¶è¢«é®æŒ¡æ—¶ç‰©ä½“é€æ˜
- æ ‘æ—è¿é€šæ€§åˆ¤å®š
- æ ‡ç­¾è¿‡æ»¤å’Œè·ç¦»è¿‡æ»¤

**å­˜åœ¨çš„æ„ä¹‰**:
- è§£å†³2Dæ¸¸æˆä¸­ç©å®¶è¢«é®æŒ¡çœ‹ä¸è§çš„é—®é¢˜
- æä¾›è‡ªç„¶çš„è§†è§‰æ•ˆæœ

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// é®æŒ¡æ£€æµ‹æ ¸å¿ƒ
bool isOccluding = occluderBounds.Contains(playerCenterPos);

// æ ‘æ—è¿é€šæ€§åˆ¤å®šï¼ˆåŒé‡æ¡ä»¶ï¼‰
private bool AreTreesConnected(OcclusionTransparency a, OcclusionTransparency b)
{
    // æ¡ä»¶1ï¼šæ ‘æ ¹è·ç¦» <= rootConnectionDistance (2.5m)
    float rootDistance = Vector2.Distance(rootA, rootB);
    if (rootDistance <= rootConnectionDistance) return true;
    
    // æ¡ä»¶2ï¼šæ ‘å† é‡å  >= 15%
    float overlapRatio = CalculateOverlapRatio(boundsA, boundsB);
    return overlapRatio >= 0.15f;
}

// Flood FillæŸ¥æ‰¾è¿é€šæ ‘æ—
private void FindConnectedForest(OcclusionTransparency startTree, Vector2 playerPos)
{
    Queue<OcclusionTransparency> queue = new Queue<OcclusionTransparency>();
    // BFSéå†æ‰€æœ‰è¿é€šçš„æ ‘æœ¨
    // é™åˆ¶ï¼šmaxForestSearchDepth=50, maxForestSearchRadius=15f
}
```

**å…³é”®å‚æ•°**:
- `detectionRadius = 8f` - æ£€æµ‹åŠå¾„
- `detectionInterval = 0.1f` - æ£€æµ‹é—´éš”
- `rootConnectionDistance = 2.5f` - æ ‘æ ¹è¿é€šè·ç¦»
- `maxForestSearchDepth = 50` - æœ€å¤§æœç´¢æ·±åº¦
- `maxForestSearchRadius = 15f` - æœ€å¤§æœç´¢åŠå¾„

**ä¾èµ–å…³ç³»**:
- ç®¡ç†æ‰€æœ‰ `OcclusionTransparency` ç»„ä»¶
- è‡ªåŠ¨æŸ¥æ‰¾Playeræ ‡ç­¾çš„ç©å®¶å¯¹è±¡

---

### 6.2 OcclusionTransparency.cs

**è·¯å¾„**: `Assets/Scripts/Service/Rendering/OcclusionTransparency.cs`

**åŠŸèƒ½æè¿°**:
- é®æŒ¡é€æ˜ç»„ä»¶ï¼ŒæŒ‚è½½åœ¨å¯é®æŒ¡ç‰©ä½“ä¸Š
- å¤„ç†é€æ˜åº¦æ¸å˜åŠ¨ç”»
- å‘OcclusionManageræ³¨å†Œ/æ³¨é”€

**å®ç°çš„éœ€æ±‚**:
- å•ä¸ªç‰©ä½“çš„é€æ˜åº¦æ§åˆ¶
- å¹³æ»‘çš„é€æ˜åº¦è¿‡æ¸¡

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// é€æ˜åº¦æ¸å˜
void Update()
{
    float targetAlpha = isOccluding ? occludedAlpha : 1f;
    currentAlpha = Mathf.Lerp(currentAlpha, targetAlpha, fadeSpeed * Time.deltaTime);
    spriteRenderer.color = new Color(1, 1, 1, currentAlpha);
}

// æ³¨å†Œåˆ°Manager
void OnEnable()
{
    OcclusionManager.Instance?.RegisterOccluder(this);
    // ä»Managerè¯»å–å‚æ•°
    OcclusionManager.Instance?.GetOcclusionParams(tag, out occludedAlpha, out fadeSpeed);
}
```

**ä¾èµ–å…³ç³»**:
- ä¾èµ– `OcclusionManager` è·å–å‚æ•°å’ŒçŠ¶æ€
- è¢« `TreeController` æ§åˆ¶æ˜¯å¦å¯è¢«é®æŒ¡

---

### 6.3 CloudShadowManager.cs

**è·¯å¾„**: `Assets/Scripts/Service/Rendering/CloudShadowManager.cs`

**åŠŸèƒ½æè¿°**:
- äº‘æœµé˜´å½±ç®¡ç†å™¨ï¼Œåˆ›å»ºç§»åŠ¨çš„äº‘å½±æ•ˆæœ
- æ”¯æŒå¯¹è±¡æ± å’Œå¤©æ°”è”åŠ¨
- æ”¯æŒç¼–è¾‘å™¨é¢„è§ˆ

**å®ç°çš„éœ€æ±‚**:
- äº‘å½±è§†è§‰æ•ˆæœ
- å¤©æ°”è”åŠ¨ï¼ˆæ™´å¤©æ˜¾ç¤ºï¼Œé›¨å¤©éšè—ï¼‰
- æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯¹è±¡æ± ï¼‰

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// äº‘æœµå¾ªç¯ç§»åŠ¨
public void SimulateStep(float dt)
{
    // ç§»åŠ¨äº‘æœµ
    p += (Vector3)(dir * spd * dt);
    
    // è¾¹ç•Œå¾ªç¯
    if (dir.x > 0f && p.x > right)
    {
        p.x = left;
        p.y = Mathf.Lerp(bottom, top, Next01());
    }
}

// å¯¹è±¡æ± ç®¡ç†
private void SpawnOne()
{
    GameObject go = pool.Count > 0 ? pool.Pop() : Instantiate(prefab);
    // é…ç½®äº‘æœµ...
    active.Add(cloud);
}

private void DespawnLast()
{
    pool.Push(go);
    active.RemoveAt(last);
}
```

**å¤©æ°”è”åŠ¨**:
- è®¢é˜… `WeatherSystem.OnWeatherChanged`
- æ™´å¤©/å¤šäº‘ï¼šæ˜¾ç¤ºäº‘å½±
- é˜´å¤©/é›¨å¤©/é›ªå¤©ï¼šéšè—äº‘å½±

**å…³é”®å‚æ•°**:
- `intensity = 0.3f` - äº‘å½±é€æ˜åº¦
- `density = 0.6f` - äº‘å½±å¯†åº¦
- `speed = 0.4f` - ç§»åŠ¨é€Ÿåº¦
- `maxClouds = 8` - æœ€å¤§äº‘æœµæ•°é‡

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå†œç”°ç³»ç»Ÿ (Farm)

### 7.1 FarmingManager.cs

**è·¯å¾„**: `Assets/Scripts/Farm/FarmingManager.cs`

**åŠŸèƒ½æè¿°**:
- å†œç”°ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰è€•åœ°å’Œä½œç‰©
- è®¢é˜…æ—¶é—´äº‹ä»¶å¤„ç†æ¯æ—¥æ›´æ–°
- æä¾›è€•åœ°/ç§æ¤/æµ‡æ°´/æ”¶è·æ¥å£

**å®ç°çš„éœ€æ±‚**:
- å†œç”°çŠ¶æ€ç®¡ç†
- ä½œç‰©ç”Ÿé•¿é€»è¾‘
- æ—¶é—´ç³»ç»Ÿè”åŠ¨

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ¯æ—¥æ›´æ–°
private void OnDayChanged(int year, int day, int totalDays)
{
    foreach (var tileData in farmTiles.Values)
    {
        // ä½œç‰©ç”Ÿé•¿ï¼ˆå¦‚æœæ˜¨å¤©æµ‡æ°´ï¼‰
        if (tileData.crop != null && tileData.wateredYesterday)
        {
            tileData.crop.currentGrowthDay++;
        }
        
        // é‡ç½®æµ‡æ°´çŠ¶æ€
        tileData.wateredYesterday = tileData.wateredToday;
        tileData.wateredToday = false;
        tileData.moistureState = SoilMoistureState.Dry;
    }
}
```

**ä¾èµ–å…³ç³»**:
- è®¢é˜… `TimeManager.OnDayChanged`
- è®¢é˜… `TimeManager.OnHourChanged`

---

### 7.2 FarmTileData.cs

**è·¯å¾„**: `Assets/Scripts/Farm/FarmTileData.cs`

**åŠŸèƒ½æè¿°**:
- å†œç”°æ ¼å­æ•°æ®ï¼Œå­˜å‚¨å•ä¸ªè€•åœ°çš„çŠ¶æ€

**æ ¸å¿ƒå­—æ®µ**:
```csharp
public bool isTilled;              // æ˜¯å¦å·²è€•ä½œ
public bool wateredToday;          // ä»Šå¤©æ˜¯å¦æµ‡æ°´
public bool wateredYesterday;      // æ˜¨å¤©æ˜¯å¦æµ‡æ°´
public float waterTime;            // æµ‡æ°´æ—¶é—´ï¼ˆå°æ—¶ï¼‰
public SoilMoistureState moistureState;  // å½“å‰æ¹¿åº¦çŠ¶æ€
public CropInstance crop;          // ä½œç‰©å®ä¾‹
```

---

### 7.3 CropInstance.cs

**è·¯å¾„**: `Assets/Scripts/Farm/CropInstance.cs`

**åŠŸèƒ½æè¿°**:
- ä½œç‰©å®ä¾‹ï¼Œå­˜å‚¨å•ä¸ªä½œç‰©çš„è¿è¡Œæ—¶æ•°æ®

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
public int GetCurrentGrowthStage()
{
    if (currentGrowthDay >= seedData.growthDays) 
        return seedData.growthStageSprites.Length - 1;
        
    float growthPercent = (float)currentGrowthDay / seedData.growthDays;
    return Mathf.FloorToInt(growthPercent * (seedData.growthStageSprites.Length - 1));
}

public bool IsMature()
{
    return currentGrowthDay >= seedData.growthDays;
}
```

---

### 7.4 SoilMoistureState.cs

**è·¯å¾„**: `Assets/Scripts/Farm/SoilMoistureState.cs`

**åŠŸèƒ½æè¿°**:
- åœŸå£¤æ¹¿åº¦çŠ¶æ€æšä¸¾

**çŠ¶æ€å®šä¹‰**:
```csharp
public enum SoilMoistureState
{
    Dry,           // å¹²ç‡¥
    WetWithPuddle, // æ¹¿æ¶¦å¸¦æ°´æ´¼ï¼ˆæµ‡æ°´å2å°æ—¶å†…ï¼‰
    WetDark        // æ¹¿æ¶¦æ·±è‰²ï¼ˆæµ‡æ°´2å°æ—¶åï¼‰
}
```

---



## ç¬¬å…«éƒ¨åˆ†ï¼šç¯å¢ƒç³»ç»Ÿ (Environment)

### 8.1 TreeController.cs

**è·¯å¾„**: `Assets/Scripts/Controller/TreeController.cs`

**åŠŸèƒ½æè¿°**:
- æ ‘æœ¨æ§åˆ¶å™¨ï¼Œç®¡ç†æ ‘æœ¨çš„ç”Ÿé•¿ã€å­£èŠ‚å˜åŒ–ã€çŠ¶æ€åˆ‡æ¢
- å¤„ç†ç¢°æ’ä½“å¯ç”¨/ç¦ç”¨
- è§¦å‘å¯¼èˆªç½‘æ ¼åˆ·æ–°

**å®ç°çš„éœ€æ±‚**:
- æ ‘æœ¨ç”Ÿé•¿é˜¶æ®µï¼ˆSapling/Small/Largeï¼‰
- æ ‘æœ¨çŠ¶æ€ï¼ˆNormal/Withered/Frozen/Melted/Stumpï¼‰
- å­£èŠ‚å¤–è§‚å˜åŒ–
- ç¢°æ’ä½“ç®¡ç†

**å­˜åœ¨çš„æ„ä¹‰**:
- ç»Ÿä¸€ç®¡ç†æ ‘æœ¨çš„æ‰€æœ‰è¡Œä¸º
- ä¸é®æŒ¡ç³»ç»Ÿã€å¯¼èˆªç³»ç»Ÿè”åŠ¨

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// ç”Ÿé•¿é˜¶æ®µ
public enum GrowthStage { Sapling, Small, Large }

// æ ‘æœ¨çŠ¶æ€
public enum TreeState { Normal, Withered, Frozen, Melted, Stump }

// ç¢°æ’ä½“ç®¡ç†
private void UpdateColliderState()
{
    bool shouldEnable = (currentStage == GrowthStage.Small || 
                         currentStage == GrowthStage.Large) && 
                        currentState != TreeState.Stump;
    
    polygonCollider.enabled = shouldEnable;
    
    // ç¢°æ’ä½“çŠ¶æ€å˜åŒ–æ—¶è§¦å‘å¯¼èˆªç½‘æ ¼åˆ·æ–°
    if (hadEnabledCollider != hasEnabledCollider)
    {
        RequestNavGridRefresh();
    }
}

// å¯¼èˆªç½‘æ ¼åˆ·æ–°ï¼ˆå»¶è¿Ÿ0.2ç§’ï¼‰
private void RequestNavGridRefresh()
{
    CancelInvoke(nameof(DoNavGridRefresh));
    Invoke(nameof(DoNavGridRefresh), 0.2f);
}

private void DoNavGridRefresh()
{
    NavGrid2D.OnRequestGridRefresh?.Invoke();
}

// Spriteåº•éƒ¨å¯¹é½
private void AlignSpriteBottom()
{
    // è‡ªåŠ¨è®¡ç®—sprite bounds
    // å¯¹é½çˆ¶ç‰©ä½“ä¸­å¿ƒï¼ˆæ ‘æ ¹ä½ç½®ï¼‰
    // é˜´å½±ç¼©æ”¾ä¸ä½ç½®åŒæ­¥
}
```

**ä¾èµ–å…³ç³»**:
- è®¢é˜… `SeasonManager.OnVegetationSeasonChanged`
- è®¢é˜… `WeatherSystem.OnPlantsWither`
- è®¢é˜… `WeatherSystem.OnPlantsRecover`
- è§¦å‘ `NavGrid2D.OnRequestGridRefresh`
- æ§åˆ¶ `OcclusionTransparency.SetCanBeOccluded`

**æ ‘æœ¨å±‚çº§ç»“æ„**:
```
Tree_M1_00ï¼ˆçˆ¶ç‰©ä½“ï¼ŒY=æ ‘æ ¹ä½ç½®ï¼‰
  â”œâ”€ Rigidbody2D (Static)
  â”œâ”€ CompositeCollider2D
  â”œâ”€ OcclusionTransparency
  â”‚
  â”œâ”€ Treeï¼ˆå­ç‰©ä½“ï¼‰
  â”‚    â”œâ”€ SpriteRenderer
  â”‚    â”œâ”€ PolygonCollider2D (Merge)
  â”‚    â””â”€ TreeController
  â”‚
  â””â”€ Shadowï¼ˆå­ç‰©ä½“ï¼‰
       â””â”€ SpriteRenderer
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šUIç³»ç»Ÿ (UI)

### 9.1 PackagePanelTabsUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Tabs/PackagePanelTabsUI.cs`

**åŠŸèƒ½æè¿°**:
- é¢æ¿Tabç®¡ç†å™¨ï¼Œæ§åˆ¶PackagePanelçš„é¡µé¢åˆ‡æ¢
- å¤„ç†å¿«æ·é”®ä¸ToggleçŠ¶æ€åŒæ­¥
- å®ç°é¢æ¿æ‰“å¼€/å…³é—­é€»è¾‘

**å®ç°çš„éœ€æ±‚**:
- å¤šé¡µé¢Tabåˆ‡æ¢
- å¿«æ·é”®ç³»ç»Ÿ
- é¢æ¿çŠ¶æ€ç®¡ç†

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// é¢æ¿åˆ‡æ¢é€»è¾‘
public void TogglePage(int pageIndex)
{
    if (!packagePanel.activeSelf)
    {
        // é¢æ¿å…³é—­ + æŒ‰é”® â†’ æ‰“å¼€é¢æ¿å¹¶æ˜¾ç¤ºå¯¹åº”é¡µ
        OpenPanel(pageIndex);
    }
    else if (lastPageIndex == pageIndex)
    {
        // é¢æ¿æ‰“å¼€ + æŒ‰ç›¸åŒé”® â†’ å…³é—­é¢æ¿
        ClosePanel();
    }
    else
    {
        // é¢æ¿æ‰“å¼€ + æŒ‰ä¸åŒé”® â†’ åˆ‡æ¢é¡µé¢
        SwitchToPage(pageIndex);
    }
}

// ESCé”®ç‰¹æ®Šå¤„ç†
if (Input.GetKeyDown(KeyCode.Escape))
{
    if (packagePanel.activeSelf)
        SwitchToPage(5); // Settingsé¡µ
    else
        OpenPanel(5);
}
```

**å¿«æ·é”®æ˜ å°„**:
- Tab/B â†’ Propsé¡µ(0)
- M â†’ Mapé¡µ(3)
- L â†’ Relationshipé¡µ(4)
- O â†’ Settingsé¡µ(5)
- ESC â†’ Settingsé¡µï¼ˆç‰¹æ®Šå¤„ç†ï¼‰

---

### 9.2 InventoryPanelUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Inventory/InventoryPanelUI.cs`

**åŠŸèƒ½æè¿°**:
- èƒŒåŒ…é¢æ¿UIï¼Œæ˜¾ç¤ºèƒŒåŒ…æ ¼å­
- å¤„ç†ç‰©å“æ‹–æ‹½å’Œç‚¹å‡»

**å®ç°çš„éœ€æ±‚**:
- èƒŒåŒ…æ ¼å­æ˜¾ç¤º
- ç‰©å“å›¾æ ‡å’Œæ•°é‡æ˜¾ç¤º
- ç‰©å“äº¤äº’

---

### 9.3 InventorySlotUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Inventory/InventorySlotUI.cs`

**åŠŸèƒ½æè¿°**:
- èƒŒåŒ…æ ¼å­UIç»„ä»¶
- æ˜¾ç¤ºå•ä¸ªç‰©å“çš„å›¾æ ‡ã€æ•°é‡ã€å“è´¨

**å®ç°çš„éœ€æ±‚**:
- å•æ ¼ç‰©å“æ˜¾ç¤º
- å“è´¨æ˜Ÿæ˜Ÿæ˜¾ç¤º
- ç‚¹å‡»/æ‹–æ‹½äº¤äº’

---

### 9.4 ToolbarUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Toolbar/ToolbarUI.cs`

**åŠŸèƒ½æè¿°**:
- å·¥å…·æ UIå®¹å™¨ï¼Œç®¡ç†æ‰€æœ‰å·¥å…·æ æ§½ä½
- æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€

**å®ç°çš„éœ€æ±‚**:
- å·¥å…·æ æ˜¾ç¤º
- é€‰ä¸­é«˜äº®

---

### 9.5 ToolbarSlotUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Toolbar/ToolbarSlotUI.cs`

**åŠŸèƒ½æè¿°**:
- å·¥å…·æ æ§½ä½UIï¼Œå¤„ç†ç‚¹å‡»é€‰æ‹©

**å®ç°çš„éœ€æ±‚**:
- æ§½ä½ç‚¹å‡»é€‰æ‹©
- ç‰©å“æ˜¾ç¤º

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
public void OnPointerClick(PointerEventData eventData)
{
    HotbarSelectionService.Instance.SelectIndex(slotIndex);
}
```

---

### 9.6 EquipmentSlotUI.cs

**è·¯å¾„**: `Assets/Scripts/UI/Inventory/EquipmentSlotUI.cs`

**åŠŸèƒ½æè¿°**:
- è£…å¤‡æ§½ä½UIï¼Œæ˜¾ç¤ºè£…å¤‡ç‰©å“

---

### 9.7 UIItemIconScaler.cs

**è·¯å¾„**: `Assets/Scripts/UI/Utility/UIItemIconScaler.cs`

**åŠŸèƒ½æè¿°**:
- UIç‰©å“å›¾æ ‡ç¼©æ”¾å™¨ï¼Œè‡ªåŠ¨è°ƒæ•´å›¾æ ‡å¤§å°

---

## ç¬¬åéƒ¨åˆ†ï¼šä¸–ç•Œç³»ç»Ÿ (World)

### 10.1 WorldSpawnService.cs

**è·¯å¾„**: `Assets/Scripts/World/WorldSpawnService.cs`

**åŠŸèƒ½æè¿°**:
- ä¸–ç•Œç”ŸæˆæœåŠ¡ï¼Œç®¡ç†ç‰©å“æ‰è½å’Œç”Ÿæˆ

**å®ç°çš„éœ€æ±‚**:
- ç‰©å“æ‰è½ç”Ÿæˆ
- æ‰è½ç‰©ç®¡ç†

---

### 10.2 WorldItemPickup.cs

**è·¯å¾„**: `Assets/Scripts/World/WorldItemPickup.cs`

**åŠŸèƒ½æè¿°**:
- ä¸–ç•Œç‰©å“æ‹¾å–ç»„ä»¶ï¼ŒæŒ‚è½½åœ¨æ‰è½ç‰©ä¸Š
- å¤„ç†æ‹¾å–é€»è¾‘

**å®ç°çš„éœ€æ±‚**:
- æ‰è½ç‰©æ‹¾å–
- æ‹¾å–åŠ¨ç”»

---

### 10.3 WorldSpawnDebug.cs

**è·¯å¾„**: `Assets/Scripts/World/WorldSpawnDebug.cs`

**åŠŸèƒ½æè¿°**:
- ä¸–ç•Œç”Ÿæˆè°ƒè¯•å·¥å…·ï¼Œç”¨äºæµ‹è¯•ç‰©å“ç”Ÿæˆ

---

## ç¬¬åä¸€éƒ¨åˆ†ï¼šå·¥å…·ç±» (Utils)

### 11.1 AssetLocator.cs

**è·¯å¾„**: `Assets/Scripts/Utils/AssetLocator.cs`

**åŠŸèƒ½æè¿°**:
- èµ„æºå®šä½å™¨ï¼Œå¸®åŠ©æŸ¥æ‰¾é¡¹ç›®èµ„æº

---

### 11.2 TagSelectorAttribute.cs

**è·¯å¾„**: `Assets/Scripts/Utils/Attributes/TagSelectorAttribute.cs`

**åŠŸèƒ½æè¿°**:
- Tagé€‰æ‹©å™¨å±æ€§ï¼Œç”¨äºInspectorä¸­æ˜¾ç¤ºTagä¸‹æ‹‰æ¡†

---

### 11.3 SceneOrganizer.cs

**è·¯å¾„**: `Assets/Scripts/Utils/Editor/SceneOrganizer.cs`

**åŠŸèƒ½æè¿°**:
- åœºæ™¯ç»„ç»‡å™¨ï¼Œç¼–è¾‘å™¨å·¥å…·

---

## ç¬¬åäºŒéƒ¨åˆ†ï¼šæšä¸¾å®šä¹‰ (Enums)

### 12.1 ItemEnums.cs

**è·¯å¾„**: `Assets/Scripts/Data/Enums/ItemEnums.cs`

**åŠŸèƒ½æè¿°**:
- ç‰©å“ç›¸å…³æšä¸¾å®šä¹‰

**æšä¸¾åˆ—è¡¨**:
```csharp
// ç‰©å“åˆ†ç±»
public enum ItemCategory { Tool, Weapon, Seed, Crop, Material, Food, Potion, Furniture, Special }

// å·¥å…·ç±»å‹
public enum ToolType { Axe, Pickaxe, Hoe, WateringCan, Sickle, FishingRod }

// å·¥å…·ç­‰çº§
public enum ToolLevel { Basic, Copper, Iron, Gold, Iridium }

// æ­¦å™¨ç±»å‹
public enum WeaponType { Sword, Dagger, Club, Bow, Staff }

// å“è´¨ç­‰çº§
public enum ItemQuality { Normal, Copper, Silver, Gold, Iridium }

// å­£èŠ‚
public enum Season { Spring, Summer, Fall, Winter, AllSeason }
```

---

## ç¬¬åä¸‰éƒ¨åˆ†ï¼šå“è´¨ç³»ç»Ÿ

### 13.1 QualityHelper.cs

**è·¯å¾„**: `Assets/Scripts/Data/Items/QualityHelper.cs`

**åŠŸèƒ½æè¿°**:
- å“è´¨è¾…åŠ©ç±»ï¼Œæä¾›å“è´¨ç›¸å…³è®¡ç®—

**æ ¸å¿ƒå®ç°**:
```csharp
// å“è´¨ä»·æ ¼å€ç‡
public static float GetPriceMultiplier(ItemQuality quality)
{
    return quality switch
    {
        ItemQuality.Normal => 1.0f,
        ItemQuality.Copper => 1.25f,
        ItemQuality.Silver => 1.5f,
        ItemQuality.Gold => 2.0f,
        ItemQuality.Iridium => 2.5f,
        _ => 1.0f
    };
}
```

---

## é™„å½•ï¼šäº‹ä»¶ç³»ç»Ÿæ€»è§ˆ

### æ—¶é—´ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnMinuteChanged | TimeManager | UIæ˜¾ç¤º |
| OnHourChanged | TimeManager | FarmingManager |
| OnDayChanged | TimeManager | FarmingManager, WeatherSystem |
| OnSeasonChanged | TimeManager | SeasonManager, WeatherSystem |
| OnYearChanged | TimeManager | - |
| OnSleep | TimeManager | - |

### å­£èŠ‚ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnSeasonChanged | SeasonManager | TreeController |
| OnVegetationSeasonChanged | SeasonManager | TreeController |

### å¤©æ°”ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnWeatherChanged | WeatherSystem | CloudShadowManager |
| OnPlantsWither | WeatherSystem | TreeController |
| OnPlantsRecover | WeatherSystem | TreeController |
| OnWinterSnow | WeatherSystem | TreeController |
| OnWinterMelt | WeatherSystem | TreeController |

### å¯¼èˆªç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnRequestGridRefresh | TreeController | NavGrid2D |

---

## ç¬¬åå››éƒ¨åˆ†ï¼šæ ¸å¿ƒæ¡†æ¶ç³»ç»Ÿ (Core)

### 14.1 EventBus.cs

**è·¯å¾„**: `Assets/Scripts/Core/Events/EventBus.cs`

**åŠŸèƒ½æè¿°**:
- ç»Ÿä¸€äº‹ä»¶æ€»çº¿ç³»ç»Ÿï¼Œæä¾›ç±»å‹å®‰å…¨çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœºåˆ¶
- æ”¯æŒäº‹ä»¶ä¼˜å…ˆçº§ï¼ˆ0-100ï¼‰
- è‡ªåŠ¨ç®¡ç†è®¢é˜…ç”Ÿå‘½å‘¨æœŸï¼ˆMonoBehaviouré”€æ¯æ—¶è‡ªåŠ¨å–æ¶ˆè®¢é˜…ï¼‰
- æä¾›äº‹ä»¶å†å²è®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// è®¢é˜…äº‹ä»¶
EventBus.Subscribe<DayChangedEvent>(OnDayChanged, priority: 50, owner: this);

// å‘å¸ƒäº‹ä»¶
EventBus.Publish(new DayChangedEvent { Year = 1, SeasonDay = 5, TotalDays = 35 });

// å–æ¶ˆè®¢é˜…
EventBus.Unsubscribe<DayChangedEvent>(OnDayChanged);
```

**å­˜åœ¨çš„æ„ä¹‰**:
- é™ä½ç³»ç»Ÿè€¦åˆåº¦
- ä¾¿äºè°ƒè¯•å’Œè¿½è¸ªäº‹ä»¶æµ
- é¿å…å†…å­˜æ³„æ¼
- æ”¯æŒæ›´å¤æ‚çš„äº‹ä»¶é€»è¾‘

---

### 14.2 ServiceLocator.cs

**è·¯å¾„**: `Assets/Scripts/Core/Services/ServiceLocator.cs`

**åŠŸèƒ½æè¿°**:
- æœåŠ¡å®šä½å™¨ï¼Œæä¾›ç»Ÿä¸€çš„æœåŠ¡æ³¨å†Œã€è·å–ã€ç®¡ç†åŠŸèƒ½
- æ”¯æŒæœåŠ¡ä½œç”¨åŸŸï¼ˆGlobal/Scene/Temporaryï¼‰
- æ”¯æŒæœåŠ¡æ›¿æ¢ï¼ˆç”¨äºæµ‹è¯•å’Œè°ƒè¯•ï¼‰

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// æ³¨å†ŒæœåŠ¡
ServiceLocator.Register<ITimeService>(timeManager, ServiceScope.Global);

// è·å–æœåŠ¡
var timeService = ServiceLocator.Get<ITimeService>();

// åœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†
ServiceLocator.ClearScope(ServiceScope.Scene);
```

**å­˜åœ¨çš„æ„ä¹‰**:
- é™ä½è€¦åˆï¼Œæé«˜å¯æµ‹è¯•æ€§
- ä¾¿äºåœºæ™¯åˆ‡æ¢ç®¡ç†
- æ”¯æŒæœåŠ¡çƒ­æ›¿æ¢ï¼ˆè°ƒè¯•ç”¨ï¼‰

---

### 14.3 ObjectPool.cs / PoolManager.cs

**è·¯å¾„**: `Assets/Scripts/Core/Pool/`

**åŠŸèƒ½æè¿°**:
- é€šç”¨å¯¹è±¡æ± ç³»ç»Ÿï¼Œå‡å°‘é¢‘ç¹åˆ›å»º/é”€æ¯å¯¹è±¡çš„å¼€é”€
- æ”¯æŒé¢„çƒ­ï¼ˆPrewarmï¼‰å’ŒåŠ¨æ€æ‰©å®¹
- æ”¯æŒå¯¹è±¡é‡ç½®æ¥å£ï¼ˆIPoolableï¼‰

**æ ¸å¿ƒå®ç°é€»è¾‘**:
```csharp
// å®ç° IPoolable æ¥å£
public class DroppedItem : MonoBehaviour, IPoolable
{
    public void OnSpawn() { /* åˆå§‹åŒ– */ }
    public void OnDespawn() { /* æ¸…ç† */ }
}

// ä½¿ç”¨å¯¹è±¡æ± 
var pool = PoolManager.Instance.GetOrCreatePool(prefab, initialSize: 10);
var item = pool.Spawn(position, rotation);
pool.Despawn(item);
```

**å­˜åœ¨çš„æ„ä¹‰**:
- å‡å°‘ GC å‹åŠ›ï¼Œå¸§ç‡æ›´ç¨³å®š
- å‡å°‘ Instantiate å¼€é”€
- å†…å­˜ä½¿ç”¨æ›´å¯æ§

---

### 14.4 GameEvents.cs

**è·¯å¾„**: `Assets/Scripts/Core/Events/GameEvents.cs`

**åŠŸèƒ½æè¿°**:
- å®šä¹‰æ‰€æœ‰æ¸¸æˆäº‹ä»¶ç±»å‹
- åŒ…æ‹¬æ—¶é—´ã€å¤©æ°”ã€å­£èŠ‚ã€å¯¼èˆªã€èƒŒåŒ…ã€ç©å®¶ã€UIç­‰äº‹ä»¶

**äº‹ä»¶åˆ†ç±»**:
- æ—¶é—´ç³»ç»Ÿäº‹ä»¶ï¼šMinuteChangedEvent, HourChangedEvent, DayChangedEvent, SeasonChangedEvent
- å¤©æ°”ç³»ç»Ÿäº‹ä»¶ï¼šWeatherChangedEvent, PlantsWitherEvent, PlantsRecoverEvent
- å¯¼èˆªç³»ç»Ÿäº‹ä»¶ï¼šNavGridRefreshRequestEvent
- èƒŒåŒ…ç³»ç»Ÿäº‹ä»¶ï¼šInventoryChangedEvent, HotbarSelectionChangedEvent, ToolEquippedEvent
- ç©å®¶äº‹ä»¶ï¼šPlayerActionStartEvent, PlayerActionCompleteEvent
- UIäº‹ä»¶ï¼šPanelOpenedEvent, PanelClosedEvent

---

## é™„å½•ï¼šäº‹ä»¶ç³»ç»Ÿæ€»è§ˆ

### æ—¶é—´ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnMinuteChanged | TimeManager | UIæ˜¾ç¤º |
| OnHourChanged | TimeManager | FarmingManager |
| OnDayChanged | TimeManager | FarmingManager, WeatherSystem |
| OnSeasonChanged | TimeManager | SeasonManager, WeatherSystem |
| OnYearChanged | TimeManager | - |
| OnSleep | TimeManager | - |

### å­£èŠ‚ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnSeasonChanged | SeasonManager | TreeController |
| OnVegetationSeasonChanged | SeasonManager | TreeController |

### å¤©æ°”ç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnWeatherChanged | WeatherSystem | CloudShadowManager |
| OnPlantsWither | WeatherSystem | TreeController |
| OnPlantsRecover | WeatherSystem | TreeController |
| OnWinterSnow | WeatherSystem | TreeController |
| OnWinterMelt | WeatherSystem | TreeController |

### å¯¼èˆªç›¸å…³äº‹ä»¶
| äº‹ä»¶ | å‘å¸ƒè€… | è®¢é˜…è€… |
|------|--------|--------|
| OnRequestGridRefresh | TreeController | NavGrid2D |

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ11æ—¥
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ11æ—¥ - æ·»åŠ æ ¸å¿ƒæ¡†æ¶ç³»ç»Ÿè¯´æ˜

