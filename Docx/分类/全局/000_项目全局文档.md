# 项目全局文档

**版本**: v1.0  
**日期**: 2025-12-16  
**状态**: ✅ 已完成  
**合并来源**: 全局功能需求总结文档.md、整体项目改进计划以及后续开发任务细则.md

---

## 第一部分：项目概述

**项目名称**: Sunset  
**类型**: 2D 农场模拟游戏  
**引擎**: Unity 6000.0.62f1  
**当前阶段**: 第一阶段完成（约40%）

---

## 第二部分：核心系统清单

### 时间系统
| 文件 | 职责 |
|------|------|
| TimeManager.cs | 游戏时间管理（年/季/日/时/分） |
| SeasonManager.cs | 季节管理（4日历季节 + 5植被季节） |
| WeatherSystem.cs | 天气系统（晴/雨/枯萎/雪） |

### 玩家系统
| 文件 | 职责 |
|------|------|
| PlayerMovement.cs | 移动控制（WASD、行走/跑步） |
| PlayerInteraction.cs | 交互系统（动作触发、状态管理） |
| PlayerAnimController.cs | 动画控制（12种状态、4方向） |
| PlayerToolController.cs | 工具管理（装备、参数设置） |
| LayerAnimSync.cs | 工具动画同步（Mode A++ 帧锁定） |
| SprintStateManager.cs | 疾跑状态管理 |
| PlayerAutoNavigator.cs | 自动导航 |

### 物品系统
| 文件 | 职责 |
|------|------|
| ItemData.cs | 物品基类（ScriptableObject） |
| ToolData.cs | 工具数据 |
| WeaponData.cs | 武器数据 |
| SeedData.cs | 种子数据 |
| ItemDatabase.cs | 物品数据库 |
| InventoryService.cs | 背包服务 |
| HotbarSelectionService.cs | 快捷栏选择 |

### 导航系统
| 文件 | 职责 |
|------|------|
| NavGrid2D.cs | 导航网格（A*寻路） |
| PlayerAutoNavigator.cs | 路径执行 |

### 渲染系统
| 文件 | 职责 |
|------|------|
| OcclusionManager.cs | 遮挡管理器 |
| OcclusionTransparency.cs | 遮挡透明组件 |
| DynamicSortingOrder.cs | 动态排序 |
| CloudShadowManager.cs | 云朵阴影 |

### 环境系统
| 文件 | 职责 |
|------|------|
| TreeController.cs | 树木控制（生长、季节、碰撞） |

### UI系统
| 文件 | 职责 |
|------|------|
| PackagePanelTabsUI.cs | 面板Tab管理 |
| InventoryPanelUI.cs | 背包面板 |
| ToolbarUI.cs | 工具栏 |
| UIItemIconScaler.cs | 图标缩放 |

---

## 第三部分：事件系统总览

### 时间事件
| 事件 | 发布者 | 订阅者 |
|------|--------|--------|
| OnMinuteChanged | TimeManager | UI显示 |
| OnHourChanged | TimeManager | FarmingManager |
| OnDayChanged | TimeManager | FarmingManager, WeatherSystem |
| OnSeasonChanged | TimeManager | SeasonManager, WeatherSystem |

### 季节事件
| 事件 | 发布者 | 订阅者 |
|------|--------|--------|
| OnSeasonChanged | SeasonManager | TreeController |
| OnVegetationSeasonChanged | SeasonManager | TreeController |

### 天气事件
| 事件 | 发布者 | 订阅者 |
|------|--------|--------|
| OnWeatherChanged | WeatherSystem | CloudShadowManager |
| OnPlantsWither | WeatherSystem | TreeController |
| OnPlantsRecover | WeatherSystem | TreeController |

### 导航事件
| 事件 | 发布者 | 订阅者 |
|------|--------|--------|
| OnRequestGridRefresh | TreeController | NavGrid2D |

---

## 第四部分：架构改进方案

### 4.1 事件总线系统（推荐）

```csharp
// 订阅
EventBus.Subscribe<DayChangedEvent>(OnDayChanged, priority: 50, owner: this);

// 发布
EventBus.Publish(new DayChangedEvent { Year = 1, SeasonDay = 5, TotalDays = 35 });

// 取消订阅
EventBus.Unsubscribe<DayChangedEvent>(OnDayChanged);
```

### 4.2 服务定位器模式

```csharp
// 注册服务
ServiceLocator.Register<ITimeService>(timeManager, ServiceScope.Global);

// 获取服务
var timeService = ServiceLocator.Get<ITimeService>();

// 场景切换时清理
ServiceLocator.ClearScope(ServiceScope.Scene);
```

### 4.3 对象池系统

```csharp
public interface IPoolable
{
    void OnSpawn();
    void OnDespawn();
}

// 使用
var pool = PoolManager.Instance.GetOrCreatePool(prefab, initialSize: 10);
var item = pool.Spawn(position, rotation);
pool.Despawn(item);
```

---

## 第五部分：物品ID分配规则

```
0XXX: 工具和武器
    00XX: 农业工具 (锄头、水壶、镰刀、钓鱼竿)
    01XX: 采集工具 (镐子、斧头)
    02XX: 武器 (剑、弓、法杖)

1XXX: 种植类
    10XX: 种子
    11XX: 作物

2XXX: 动物产品
3XXX: 矿物和材料
4XXX: 消耗品
5XXX: 食品
6XXX: 家具
7XXX: 特殊物品
```

---

## 第六部分：性能基准

### 目标性能
- FPS：60（PC）、30（移动）
- 内存：< 500MB（PC）
- 加载时间：< 3秒
- 存档大小：< 1MB

### 导航系统性能
| 场景大小 | 格子数量 | 重建时间 |
|---------|---------|---------|
| 50×50 | 10,000 | ~50ms |
| 100×80 | 32,000 | ~150ms |
| 200×200 | 160,000 | ~800ms |

---

## 第七部分：Unity 6 API 更新

```csharp
// ❌ 弃用
collider.usedByComposite = true;
FindObjectsOfType<T>();

// ✅ 新 API
collider.compositeOperation = Collider2D.CompositeOperation.Merge;
FindObjectsByType<T>(FindObjectsSortMode.None);
FindFirstObjectByType<T>();
```

---

## 第八部分：代码规范

### 命名规范
- 类名：PascalCase（`TimeManager`）
- 私有字段：camelCase + 下划线（`_currentTime`）
- 公共属性：PascalCase（`CurrentSeason`）
- 常量：UPPER_CASE（`MAX_HEALTH`）

### 事件订阅规范
```csharp
// ✅ 正确：使用静态事件
TimeManager.OnDayChanged += OnDayChanged;

// ❌ 错误：使用实例方法
timeManager.OnDayChanged += OnDayChanged;
```

### ItemDatabase 访问规范
```csharp
// ✅ 正确：从已有引用获取
database = inventory.Database;

// ❌ 错误：永远返回 null
database = FindFirstObjectByType<ItemDatabase>();
```

---

## 第九部分：文件夹结构

```
Assets/Scripts/
├── Core/          # 核心框架（Events、Services、Pool）
├── Service/       # 游戏服务（Time、Weather、Inventory、Navigation）
├── Controller/    # 控制器（Player、NPC、Input）
├── Data/          # 数据定义（Items、Enums、Database）
├── UI/            # UI系统
├── Farm/          # 农田系统
├── World/         # 世界系统
└── Utils/         # 工具类
```

---

*文档结束 - 本文档合并了全局文件夹的所有内容*
