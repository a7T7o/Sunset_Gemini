# 树木系统完整文档

**版本**: v2.0  
**日期**: 2025-12-19  
**状态**: 🚧 重构中  
**重大变更**: 从3阶段系统重构为6阶段系统

---

## 第一部分：系统概述

### 设计变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2025-12-16 | 初始3阶段系统（Sapling/Small/Large） |
| v2.0 | 2025-12-19 | 重构为6阶段系统（Stage0-Stage5） |

### v2.0 核心变更

1. **树木种类简化**: 从12种树木简化为3种树木类型
2. **成长阶段扩展**: 从3阶段扩展为6阶段（0-5）
3. **工具交互分离**: 阶段0只能锄头挖，阶段1-5只能斧头砍
4. **独立配置系统**: 每个阶段有独立的血量、天数、掉落表配置
5. **树桩分级**: 只有阶段3-5有独立树桩

---

## 第二部分：6阶段成长系统

### 阶段配置表

| 阶段 | 名称 | 成长天数 | 血量 | 碰撞体 | 遮挡 | 树桩 | 树桩血量 | 工具 |
|------|------|----------|------|--------|------|------|----------|------|
| 0 | 树苗 | 1天 | 0 | ✗ | ✗ | ✗ | - | 锄头 |
| 1 | 幼苗 | 2天 | 4 | ✗ | ✗ | ✗ | - | 斧头 |
| 2 | 小树 | 2天 | 9 | ✓ | ✓ | ✗ | 4 | 斧头 |
| 3 | 中树 | 4天 | 17 | ✓ | ✓ | ✓ | 9 | 斧头 |
| 4 | 大树 | 5天 | 28 | ✓ | ✓ | ✓ | 12 | 斧头 |
| 5 | 巨树 | - | 40 | ✓ | ✓ | ✓ | 16 | 斧头 |

### 成长时间线

```
种植 → 阶段0 → (1天) → 阶段1 → (2天) → 阶段2 → (2天) → 阶段3 → (4天) → 阶段4 → (5天) → 阶段5
       树苗          幼苗          小树          中树          大树          巨树
       
总计: 1+2+2+4+5 = 14天 从树苗成长为巨树
```

### GrowthStage 枚举

```csharp
/// <summary>
/// 成长阶段（6个）
/// </summary>
public enum GrowthStage
{
    Stage0 = 0,  // 树苗（血量0，只能锄头挖）
    Stage1 = 1,  // 幼苗（血量4）
    Stage2 = 2,  // 小树（血量9，启用碰撞）
    Stage3 = 3,  // 中树（血量17，有独立树桩）
    Stage4 = 4,  // 大树（血量28，有独立树桩）
    Stage5 = 5   // 巨树（血量40，有独立树桩）
}
```

---

## 第三部分：工具交互系统

### 工具类型判定

```csharp
/// <summary>
/// 检查是否接受此工具类型
/// </summary>
public bool CanAccept(ToolHitContext ctx)
{
    // 树桩状态：只接受斧头（用于砍树桩）
    if (currentState == TreeState.Stump)
    {
        int stageIndex = (int)currentStage;
        // 只有阶段2-5的树桩可以被砍（有stumpHealth）
        if (stageIndex >= 2 && stageConfigs[stageIndex].stumpHealth > 0)
        {
            return ctx.toolType == ToolType.Axe;
        }
        return false;
    }
    
    // 阶段0（树苗）：只接受锄头
    if (currentStage == GrowthStage.Stage0)
    {
        return ctx.toolType == ToolType.Hoe;
    }
    
    // 阶段1-5：只接受斧头
    return ctx.toolType == ToolType.Axe;
}
```

### 交互矩阵

| 工具 | 阶段0 | 阶段1-5 | 树桩(阶段2-5) |
|------|-------|---------|---------------|
| 斧头 | ✗ 无效果 | ✓ 造成伤害 | ✓ 砍树桩 |
| 锄头 | ✓ 挖出树苗 | ✗ 只抖动 | ✗ 无效果 |
| 其他 | ✗ 无效果 | ✗ 只抖动 | ✗ 无效果 |

### 树苗挖出逻辑

```csharp
/// <summary>
/// 处理锄头挖出树苗
/// </summary>
private void HandleHoeDigSapling(ToolHitContext ctx)
{
    // 消耗精力
    if (EnergySystem.Instance != null)
    {
        float energyCost = GetToolEnergyCost(ctx);
        if (!EnergySystem.Instance.TryConsumeEnergy(Mathf.RoundToInt(energyCost)))
        {
            // 精力不足
            return;
        }
    }
    
    // 生成掉落物
    SpawnDrops();
    
    // 移除树苗
    Destroy(transform.parent.gameObject);
}
```

---

## 第四部分：树桩系统

### 树桩生成条件

| 阶段 | 砍倒后行为 |
|------|------------|
| 0-2 | 直接销毁，不留树桩 |
| 3-5 | 显示对应阶段的树桩 |

### 树桩Sprite配置

每个阶段（3-5）的树桩有3种季节外观：
- `stumpSpringSummer` - 春夏共用
- `stumpFall` - 秋季
- `stumpWinter` - 冬季

### 树桩砍伐系统

树桩也可以被砍伐清除，获得额外掉落物：

| 阶段 | 树桩血量 | 砍伐后行为 |
|------|----------|------------|
| 0-1 | - | 无树桩 |
| 2 | 4 | 生成树桩掉落物，销毁整个树木 |
| 3 | 9 | 生成树桩掉落物，销毁整个树木 |
| 4 | 12 | 生成树桩掉落物，销毁整个树木 |
| 5 | 16 | 生成树桩掉落物，销毁整个树木 |

### 砍伐流程说明

砍树干和砍树桩是**两个独立的过程**，各自有独立的掉落表：

```
┌─────────────────────────────────────────────────────────────┐
│                      砍伐完整流程                            │
├─────────────────────────────────────────────────────────────┤
│  1. 砍树干                                                   │
│     树干血量归零 → 生成树干掉落物(dropTable)                  │
│                 → 播放倒下动画                               │
│                 → 转换为树桩状态                             │
├─────────────────────────────────────────────────────────────┤
│  2. 砍树桩（可选）                                           │
│     树桩血量归零 → 生成树桩掉落物(stumpDropTable)            │
│                 → 销毁整个树木GameObject                     │
└─────────────────────────────────────────────────────────────┘
```

**重要**：玩家必须先砍倒树干才能出现树桩，然后才能砍树桩获得额外掉落物。

```csharp
/// <summary>
/// 处理树桩被砍伐
/// </summary>
private void HandleStumpHit(ToolHitContext ctx)
{
    // 消耗精力
    ConsumeEnergy(ctx);
    
    // 播放抖动和音效
    PlayHitEffect(ctx.hitDir);
    PlayChopHitSound();
    
    // 扣血
    int damage = Mathf.Max(1, Mathf.RoundToInt(ctx.baseDamage));
    currentStumpHealth -= damage;
    
    if (currentStumpHealth <= 0)
    {
        // 生成树桩独立掉落物（与树干掉落物分开）
        SpawnStumpDrops();
        
        // 销毁整个树木GameObject
        Destroy(transform.parent.gameObject);
    }
}
```

---

## 第五部分：季节外观系统

### 5种植被季节

| 植被季节 | 对应日历 | 外观特征 |
|----------|----------|----------|
| 早春 | 春季前半 | 嫩绿色 |
| 晚春早夏 | 春季后半+夏季前半 | 渐变到深绿 |
| 晚夏早秋 | 夏季后半+秋季前半 | 渐变到橙黄 |
| 晚秋 | 秋季后半 | 枯黄色 |
| 冬季 | 冬季全程 | 挂冰/融化 |

### Sprite数据结构

```csharp
[System.Serializable]
public class SeasonSpriteSet
{
    public Sprite earlySpring;           // 早春
    public Sprite lateSpringEarlySummer; // 晚春早夏
    public Sprite lateSummerEarlyFall;   // 晚夏早秋
    public Sprite lateFall;              // 晚秋
    public Sprite winter;                // 冬季
}

[System.Serializable]
public class StageSpriteData
{
    [Header("正常状态（5季节）")]
    public SeasonSpriteSet normal;
    
    [Header("枯萎状态")]
    public Sprite witheredSummer;
    public Sprite witheredFall;
    
    [Header("冬季特殊状态")]
    public Sprite frozenWinter;   // 挂冰
    public Sprite meltedWinter;   // 融化
    
    [Header("树桩（仅阶段3-5）")]
    public Sprite stumpSpringSummer;
    public Sprite stumpFall;
    public Sprite stumpWinter;
}
```

### Sprite总数计算

每个阶段：
- 正常状态：5个（5季节）
- 枯萎状态：2个（夏、秋）
- 冬季特殊：2个（挂冰、融化）
- 树桩（仅3-5）：3个（3季节）

总计：
- 阶段0-2：每个 5+2+2 = 9个，共 27个
- 阶段3-5：每个 5+2+2+3 = 12个，共 36个
- **总计：63个Sprite/树木类型**

---

## 第六部分：树木层级结构

```
Tree_M1_00（父物体，Y=树根位置）
  ├─ 位置 = 树根 = 种植点（游戏逻辑位置）
  ├─ Rigidbody2D (Static)
  ├─ CompositeCollider2D (物理碰撞用)
  ├─ OcclusionTransparency
  │
  ├─ Tree（子物体，localY动态调整）
  │    ├─ SpriteRenderer（渲染位置）
  │    ├─ PolygonCollider2D (Merge)
  │    └─ TreeController（AlignSpriteBottom）
  │
  └─ Shadow（子物体）
       └─ SpriteRenderer（阴影）
```

---

## 第七部分：碰撞体与遮挡管理

### 状态管理规则

| 阶段 | 碰撞体 | 遮挡透明 | 说明 |
|------|--------|----------|------|
| 0-1 | 禁用 | 禁用 | 树苗/幼苗太小 |
| 2-5 | 启用 | 启用 | 足够大的树木 |
| 树桩 | 启用 | 禁用 | 树桩不遮挡玩家 |

### 导航网格同步

```csharp
private void UpdateColliderState()
{
    bool hadEnabledCollider = /* 之前状态 */;
    bool hasEnabledCollider = /* 当前状态 */;
    
    // 根据阶段设置碰撞体状态
    int stageIndex = (int)currentStage;
    bool shouldEnableCollider = stageConfigs[stageIndex].enableCollider;
    
    foreach (Collider2D collider in colliders)
    {
        collider.enabled = shouldEnableCollider;
    }
    
    // 如果碰撞体状态改变，通知NavGrid2D刷新
    if (hadEnabledCollider != hasEnabledCollider)
    {
        RequestNavGridRefresh();
    }
}
```

---

## 第八部分：掉落系统

### 阶段独立掉落表

每个阶段有独立的 DropTable，配置在 StageConfig 中：

```csharp
[System.Serializable]
public class StageConfig
{
    // ... 其他字段 ...
    
    [Header("掉落设置")]
    [Tooltip("该阶段的掉落表")]
    public DropTable dropTable;
}
```

### 掉落物生成

```csharp
private void SpawnDrops()
{
    int stageIndex = (int)currentStage;
    DropTable dropTable = stageConfigs[stageIndex].dropTable;
    
    if (dropTable == null)
    {
        Debug.LogWarning($"[TreeController] 阶段{stageIndex}的掉落表为空");
        return;
    }
    
    // 使用掉落表生成物品
    dropTable.SpawnDrops(GetPosition());
}
```

---

## 第九部分：相关文件

| 文件 | 职责 |
|------|------|
| `Assets/Scripts/Controller/TreeController.cs` | 树木控制器 |
| `Assets/Scripts/Data/StageConfig.cs` | 阶段配置类（待创建） |
| `Assets/Scripts/Data/TreeSpriteData.cs` | 树木Sprite数据类（待创建） |
| `Assets/Scripts/Combat/PlayerToolHitEmitter.cs` | 命中发射器 |
| `Assets/Scripts/Combat/ResourceNodeRegistry.cs` | 资源节点注册表 |
| `Assets/Scripts/Service/Rendering/OcclusionManager.cs` | 遮挡管理器 |
| `Assets/Scripts/Service/Navigation/NavGrid2D.cs` | 导航网格 |

---

## 第十部分：历史文档记录

### v1.0 旧设计（已过时）

原有的3阶段系统：
- Sapling（树苗）：无碰撞
- Small（小树）：启用碰撞
- Large（大树）：启用碰撞

**状态**: ❌ 已过时，被v2.0的6阶段系统替代

### 保留的设计

以下设计在v2.0中保持不变：
- ✅ 树木层级结构（父物体+Tree子物体+Shadow子物体）
- ✅ 5种植被季节外观系统
- ✅ 遮挡透明系统
- ✅ 导航网格同步机制
- ✅ 倒下动画系统

---

*文档结束 - 本文档记录树木系统v2.0的完整设计*
