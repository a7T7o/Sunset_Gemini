# æ ‘æœ¨æˆé•¿åŠ¨æ€éšœç¢ç‰©åŒæ­¥æ–¹æ¡ˆ

**é—®é¢˜ç¼–å·**: ISSUE-004  
**ä¸¥é‡ç¨‹åº¦**: P1ï¼ˆæ¸¸æˆé€»è¾‘æ­£ç¡®æ€§ï¼‰  
**è§£å†³çŠ¶æ€**: âœ… å·²å®Œå…¨è§£å†³  
**è§£å†³æ—¶é—´**: 2024å¹´12æœˆ  
**ç›¸å…³æ–‡ä»¶**: `TreeController.cs`, `NavGrid2D.cs`

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç°è±¡
- **è·¯å¾„ç©¿é€æ ‘æœ¨**ï¼šæ ‘è‹—æˆé•¿ä¸ºå°æ ‘/å¤§æ ‘åï¼Œå¯¼èˆªè·¯å¾„ä»ç©¿é€æ ‘æœ¨
- **å¯¼èˆªè§„åˆ’ä¸æ›´æ–°**ï¼šç¢°æ’ä½“å¯ç”¨åï¼Œå¯¼èˆªç½‘æ ¼æœªåˆ·æ–°
- **ç©å®¶å¡åœ¨æ ‘ä¸­**ï¼šè‡ªåŠ¨å¯¼èˆªæ—¶å¯èƒ½èµ°åˆ°æ ‘æœ¨å†…éƒ¨æ— æ³•ç§»åŠ¨

### å½±å“èŒƒå›´
- æ‰€æœ‰ä¼šæˆé•¿çš„æ ‘æœ¨
- è‡ªåŠ¨å¯¼èˆªåŠŸèƒ½
- æ¸¸æˆçœŸå®æ„Ÿä¸é€»è¾‘æ­£ç¡®æ€§

### å¤ç°æ¡ä»¶
1. åœºæ™¯ä¸­æ”¾ç½®ä¸€æ£µæ ‘è‹—ï¼ˆGrowthStage.Saplingï¼‰
2. æ ‘è‹—æ— ç¢°æ’ä½“ï¼Œç©å®¶å¯ç©¿è¿‡
3. æ‰‹åŠ¨è°ƒç”¨`tree.Grow()`æˆ–ç­‰å¾…è‡ªåŠ¨æˆé•¿
4. æ ‘è‹—æˆé•¿ä¸ºå°æ ‘ï¼Œç¢°æ’ä½“å¯ç”¨
5. å³é”®ç‚¹å‡»æ ‘æœ¨å¦ä¸€ä¾§ â†’ è·¯å¾„ç©¿é€æ ‘æœ¨
6. ç©å®¶è·Ÿéšè·¯å¾„ â†’ å¡åœ¨æ ‘æœ¨å†…éƒ¨

---

## ğŸ” æ ¹å› åˆ†æ

### TreeControllerçš„ç¢°æ’ä½“ç®¡ç†

```csharp
// TreeController.cs åŸæœ‰é€»è¾‘
private void UpdateColliderState()
{
    Collider2D[] colliders = GetComponents<Collider2D>();
    if (colliders.Length == 0) return;

    // æ ‘è‹—é˜¶æ®µï¼šç¦ç”¨æ‰€æœ‰Collider
    if (currentStage == GrowthStage.Sapling)
    {
        foreach (Collider2D collider in colliders)
        {
            collider.enabled = false;
        }
        return;
    }

    // Small/Largeé˜¶æ®µï¼šå¯ç”¨Colliderå¹¶åˆ·æ–°
    foreach (Collider2D collider in colliders)
    {
        collider.enabled = true;
        // æ›´æ–°PolygonColliderå½¢çŠ¶...
    }
    
    // âŒ é—®é¢˜ï¼šæ²¡æœ‰é€šçŸ¥NavGrid2Dåˆ·æ–°ç½‘æ ¼
}
```

### é—®é¢˜æ ¹æº

#### 1. ç¢°æ’ä½“çŠ¶æ€å˜åŒ–æœªåŒæ­¥
- **æ ‘è‹—æˆé•¿æ—¶æœº**ï¼š
  - ç”±`OnDayChangedByTimeManager()`è§¦å‘
  - æˆ–æ‰‹åŠ¨è°ƒç”¨`Grow()`
  - ç¢°æ’ä½“çŠ¶æ€ä»`disabled`å˜ä¸º`enabled`
- **NavGrid2Dä¸çŸ¥æƒ…**ï¼š
  - ç½‘æ ¼åœ¨Startæ—¶æ„å»ºï¼Œè®°å½•äº†æ ‘è‹—ä½ç½®ä¸º"å¯é€šè¡Œ"
  - æ ‘æœ¨æˆé•¿åç¢°æ’ä½“å¯ç”¨ï¼Œä½†ç½‘æ ¼æœªæ›´æ–°
  - å¯¼è‡´è·¯å¾„è§„åˆ’ä»è®¤ä¸ºè¯¥ä½ç½®å¯é€šè¡Œ

#### 2. ç¼ºä¹é€šä¿¡æœºåˆ¶
- **TreeControlleræ˜¯ç‹¬ç«‹çš„**ï¼šä¸åº”ç›´æ¥å¼•ç”¨NavGrid2D
- **NavGrid2Dæ˜¯å•ä¾‹**ï¼šä½†TreeControllerä¸çŸ¥é“å¦‚ä½•é€šçŸ¥å®ƒ
- **äº‹ä»¶ç³»ç»Ÿç¼ºå¤±**ï¼šæ²¡æœ‰"ç¢°æ’ä½“çŠ¶æ€å˜åŒ–"çš„å…¨å±€äº‹ä»¶

#### 3. æ€§èƒ½è€ƒè™‘
- **å¤šæ£µæ ‘åŒæ—¶æˆé•¿**ï¼šå¯èƒ½åŒä¸€å¤©æœ‰10æ£µæ ‘æˆé•¿
- **é‡å¤åˆ·æ–°æµªè´¹**ï¼šæ¯æ£µæ ‘éƒ½è§¦å‘åˆ·æ–°ä¼šå¯¼è‡´é‡å¤æ„å»ºç½‘æ ¼
- **éœ€è¦å»¶è¿Ÿåˆå¹¶**ï¼šåº”è¯¥å°†å¤šä¸ªåˆ·æ–°è¯·æ±‚åˆå¹¶ä¸ºä¸€æ¬¡

---

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³
1. **å…¨å±€äº‹ä»¶ç³»ç»Ÿ**ï¼šNavGrid2Dæä¾›é™æ€äº‹ä»¶ï¼Œä»»ä½•è„šæœ¬éƒ½å¯è§¦å‘åˆ·æ–°
2. **ç¢°æ’ä½“çŠ¶æ€æ£€æµ‹**ï¼šTreeControlleræ£€æµ‹ç¢°æ’ä½“çŠ¶æ€å˜åŒ–ï¼ˆç¦ç”¨â†’å¯ç”¨ æˆ– å¯ç”¨â†’ç¦ç”¨ï¼‰
3. **å»¶è¿Ÿåˆ·æ–°æœºåˆ¶**ï¼šå»¶è¿Ÿ0.2ç§’æ‰§è¡Œï¼Œç»™ç¢°æ’ä½“è¶³å¤Ÿæ›´æ–°æ—¶é—´ï¼Œå¹¶è‡ªåŠ¨åˆå¹¶é‡å¤è¯·æ±‚

### å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      NavGrid2Dï¼ˆå•ä¾‹ + å…¨å±€äº‹ä»¶ï¼‰                 â”‚
â”‚  - OnRequestGridRefresh é™æ€äº‹ä»¶                 â”‚
â”‚  - RefreshGrid() å…¬å…±æ–¹æ³•                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
                     â”‚ Invoke äº‹ä»¶
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TreeControllerï¼ˆå¤šä¸ªå®ä¾‹ï¼‰                â”‚
â”‚  - UpdateColliderState() æ£€æµ‹çŠ¶æ€å˜åŒ–             â”‚
â”‚  - RequestNavGridRefresh() å»¶è¿Ÿè§¦å‘              â”‚
â”‚  - TriggerNavGridRefresh() å®é™…è§¦å‘              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
                     â”‚ è§¦å‘æ—¶æœº
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ ‘æœ¨æˆé•¿äº‹ä»¶                           â”‚
â”‚  - OnDayChangedByTimeManager()                  â”‚
â”‚  - Grow() æ‰‹åŠ¨è°ƒç”¨                               â”‚
â”‚  - å­£èŠ‚å˜åŒ– / å¤©æ°”å½±å“                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç å®ç°

#### 1. NavGrid2Dæ·»åŠ å…¨å±€äº‹ä»¶

```csharp
// NavGrid2D.cs
public class NavGrid2D : MonoBehaviour
{
    private static NavGrid2D s_instance;

    // å…¬å…±äº‹ä»¶ï¼šå¤–éƒ¨å¯è°ƒç”¨ä»¥é€šçŸ¥ç½‘æ ¼éœ€è¦åˆ·æ–°
    public static System.Action OnRequestGridRefresh;

    void Awake()
    {
        s_instance = this;
        ValidateParameters();
        
        // è®¢é˜…å¤–éƒ¨åˆ·æ–°è¯·æ±‚
        OnRequestGridRefresh += RefreshGrid;
    }

    void OnDestroy()
    {
        if (s_instance == this) s_instance = null;
        OnRequestGridRefresh -= RefreshGrid;
    }

    /// <summary>
    /// æ‰‹åŠ¨åˆ·æ–°ç½‘æ ¼ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼Œè§£å†³è¿è¡Œæ—¶éšœç¢ç‰©å˜åŒ–å¯¼è‡´çš„å¯¼èˆªå¤±æ•ˆï¼‰
    /// </summary>
    public void RefreshGrid()
    {
        RebuildGrid();
    }
}
```

#### 2. TreeControlleræ£€æµ‹ç¢°æ’ä½“çŠ¶æ€å˜åŒ–

```csharp
// TreeController.cs
private void UpdateColliderState()
{
    Collider2D[] colliders = GetComponents<Collider2D>();
    if (colliders.Length == 0) return;
    
    bool hadEnabledCollider = false;
    bool hasEnabledCollider = false;
    
    // === è®°å½•çŠ¶æ€å˜åŒ–å‰çš„ç¢°æ’ä½“çŠ¶æ€ ===
    foreach (Collider2D collider in colliders)
    {
        if (collider.enabled) hadEnabledCollider = true;
    }
    
    // === æ ‘è‹—é˜¶æ®µï¼šç¦ç”¨æ‰€æœ‰Collider ===
    if (currentStage == GrowthStage.Sapling)
    {
        foreach (Collider2D collider in colliders)
        {
            collider.enabled = false;
        }
    }
    else
    {
        // === Small/Largeé˜¶æ®µï¼šå¯ç”¨Colliderå¹¶åˆ·æ–° ===
        foreach (Collider2D collider in colliders)
        {
            collider.enabled = true;
            hasEnabledCollider = true;
            
            // æ›´æ–°PolygonColliderå½¢çŠ¶
            if (collider is PolygonCollider2D poly && 
                spriteRenderer != null && 
                spriteRenderer.sprite != null)
            {
                UpdatePolygonColliderFromSprite(poly, spriteRenderer.sprite);
            }
        }
    }
    
    // === âœ… å¦‚æœç¢°æ’ä½“çŠ¶æ€æ”¹å˜ï¼Œé€šçŸ¥NavGrid2Dåˆ·æ–° ===
    if (hadEnabledCollider != hasEnabledCollider)
    {
        RequestNavGridRefresh();
    }
}
```

#### 3. å»¶è¿Ÿåˆ·æ–°æœºåˆ¶

```csharp
// TreeController.cs
/// <summary>
/// è¯·æ±‚NavGrid2Dåˆ·æ–°ç½‘æ ¼ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é‡å¤åˆ·æ–°ï¼‰
/// </summary>
private void RequestNavGridRefresh()
{
    // å»¶è¿Ÿ0.2ç§’åˆ·æ–°ï¼Œç»™ç¢°æ’ä½“è¶³å¤Ÿçš„æ—¶é—´æ›´æ–°
    if (IsInvoking(nameof(TriggerNavGridRefresh)))
    {
        // å¦‚æœå·²ç»æœ‰æŒ‚èµ·çš„åˆ·æ–°è¯·æ±‚ï¼Œå–æ¶ˆå®ƒ
        CancelInvoke(nameof(TriggerNavGridRefresh));
    }
    
    // æŒ‚èµ·æ–°çš„åˆ·æ–°è¯·æ±‚
    Invoke(nameof(TriggerNavGridRefresh), 0.2f);
}

/// <summary>
/// å®é™…è§¦å‘NavGrid2Dåˆ·æ–°
/// </summary>
private void TriggerNavGridRefresh()
{
    // è°ƒç”¨å…¨å±€äº‹ä»¶
    NavGrid2D.OnRequestGridRefresh?.Invoke();
    
    if (showDebugInfo)
    {
        Debug.Log($"<color=cyan>[TreeController] {gameObject.name} é€šçŸ¥NavGrid2Dåˆ·æ–°ç½‘æ ¼</color>");
    }
}
```

---

## ğŸ“Š æ‰§è¡Œæµç¨‹

### åœºæ™¯1ï¼šå•æ£µæ ‘æˆé•¿

```
æ—¶é—´è½´ï¼š
T=0s    æ ‘è‹—æˆé•¿ â†’ UpdateColliderState()
        æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–ï¼ˆdisabledâ†’enabledï¼‰
        è°ƒç”¨ RequestNavGridRefresh()
        
T=0.0s  CancelInvoke("TriggerNavGridRefresh")ï¼ˆæ— æŒ‚èµ·è¯·æ±‚ï¼Œè·³è¿‡ï¼‰
        Invoke("TriggerNavGridRefresh", 0.2s)
        
T=0.2s  TriggerNavGridRefresh() æ‰§è¡Œ
        NavGrid2D.OnRequestGridRefresh?.Invoke()
        NavGrid2D.RefreshGrid() æ‰§è¡Œ
        ç½‘æ ¼é‡å»ºï¼Œéšœç¢ç‰©æ•°é‡ +1
```

### åœºæ™¯2ï¼šå¤šæ£µæ ‘åŒæ—¶æˆé•¿

```
æ—¶é—´è½´ï¼š
T=0.00s  æ ‘1æˆé•¿ â†’ RequestNavGridRefresh() â†’ Invoke(0.2s)
T=0.05s  æ ‘2æˆé•¿ â†’ RequestNavGridRefresh() 
         CancelInvoke() å–æ¶ˆæ ‘1çš„è¯·æ±‚
         Invoke(0.2s)  â† æ–°çš„0.2ç§’ä»ç°åœ¨å¼€å§‹
         
T=0.10s  æ ‘3æˆé•¿ â†’ RequestNavGridRefresh()
         CancelInvoke() å–æ¶ˆæ ‘2çš„è¯·æ±‚
         Invoke(0.2s)  â† æ–°çš„0.2ç§’ä»ç°åœ¨å¼€å§‹
         
T=0.30s  TriggerNavGridRefresh() æ‰§è¡Œï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
         NavGrid2D.RefreshGrid() æ‰§è¡Œ
         ç½‘æ ¼é‡å»ºï¼Œéšœç¢ç‰©æ•°é‡ +3
         
ç»“æœï¼š3æ£µæ ‘çš„åˆ·æ–°è¯·æ±‚åˆå¹¶ä¸º1æ¬¡ç½‘æ ¼é‡å»º
```

### åœºæ™¯3ï¼šæ ‘æœ¨è¢«ç ä¼ï¼ˆç¢°æ’ä½“ç¦ç”¨ï¼‰

```
æ—¶é—´è½´ï¼š
T=0s    æ ‘æœ¨è¢«ç ä¼ â†’ ChopDown() â†’ currentState = TreeState.Stump
        UpdateSprite() â†’ UpdateColliderState()
        æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–ï¼ˆenabledâ†’disabledï¼‰
        è°ƒç”¨ RequestNavGridRefresh()
        
T=0.2s  TriggerNavGridRefresh() æ‰§è¡Œ
        NavGrid2D.RefreshGrid() æ‰§è¡Œ
        ç½‘æ ¼é‡å»ºï¼Œéšœç¢ç‰©æ•°é‡ -1
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®æ”¹NavGrid2D.cs

```csharp
public class NavGrid2D : MonoBehaviour
{
    private static NavGrid2D s_instance;
    public static System.Action OnRequestGridRefresh;

    void Awake()
    {
        s_instance = this;
        ValidateParameters();
        OnRequestGridRefresh += RefreshGrid;
    }

    void OnDestroy()
    {
        if (s_instance == this) s_instance = null;
        OnRequestGridRefresh -= RefreshGrid;
    }

    public void RefreshGrid()
    {
        RebuildGrid();
    }
}
```

### æ­¥éª¤2ï¼šä¿®æ”¹TreeController.cs

1. ä¿®æ”¹`UpdateColliderState()`ï¼ˆå¦‚ä¸Šæ–‡ä»£ç ï¼‰
2. æ·»åŠ `RequestNavGridRefresh()`æ–¹æ³•
3. æ·»åŠ `TriggerNavGridRefresh()`æ–¹æ³•

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯

1. **å•æ£µæ ‘æˆé•¿æµ‹è¯•**ï¼š
   - æ”¾ç½®æ ‘è‹—ï¼Œå¯ç”¨`showDebugInfo`
   - æ‰‹åŠ¨è°ƒç”¨`Grow()`
   - è§‚å¯ŸConsoleè¾“å‡ºï¼š
     ```
     [TreeController] Tree_M1_00/Tree é€šçŸ¥NavGrid2Dåˆ·æ–°ç½‘æ ¼
     [NavGrid2D] ç½‘æ ¼é‡å»ºå®Œæ¯•: 32000 å•å…ƒï¼Œéšœç¢ç‰©=1524
     ```

2. **å¤šæ£µæ ‘æˆé•¿æµ‹è¯•**ï¼š
   - æ”¾ç½®10æ£µæ ‘è‹—
   - åŒæ—¶è°ƒç”¨æ‰€æœ‰`Grow()`
   - è§‚å¯ŸConsoleè¾“å‡ºï¼ˆåº”åªæœ‰1æ¬¡ç½‘æ ¼é‡å»ºï¼‰

3. **è·¯å¾„éªŒè¯æµ‹è¯•**ï¼š
   - æ ‘è‹—æˆé•¿å‰ï¼šå³é”®ç‚¹å‡»æ ‘è‹—å¦ä¸€ä¾§ â†’ è·¯å¾„ç©¿è¿‡
   - æ ‘è‹—æˆé•¿åï¼šå³é”®ç‚¹å‡»æ ‘è‹—å¦ä¸€ä¾§ â†’ è·¯å¾„ç»•è¿‡

---

## ğŸ“š å®Œæ•´ä»£ç ç¤ºä¾‹

### TreeController.csï¼ˆä¿®æ”¹éƒ¨åˆ†ï¼‰

```csharp
public class TreeController : MonoBehaviour
{
    [SerializeField] private bool showDebugInfo = false;

    /// <summary>
    /// æ›´æ–°ColliderçŠ¶æ€
    /// </summary>
    private void UpdateColliderState()
    {
        Collider2D[] colliders = GetComponents<Collider2D>();
        if (colliders.Length == 0) return;
        
        bool hadEnabledCollider = false;
        bool hasEnabledCollider = false;
        
        foreach (Collider2D collider in colliders)
        {
            if (collider.enabled) hadEnabledCollider = true;
        }
        
        if (currentStage == GrowthStage.Sapling)
        {
            foreach (Collider2D collider in colliders)
            {
                collider.enabled = false;
            }
        }
        else
        {
            foreach (Collider2D collider in colliders)
            {
                collider.enabled = true;
                hasEnabledCollider = true;
                
                if (collider is PolygonCollider2D poly && 
                    spriteRenderer != null && 
                    spriteRenderer.sprite != null)
                {
                    UpdatePolygonColliderFromSprite(poly, spriteRenderer.sprite);
                }
            }
        }
        
        if (hadEnabledCollider != hasEnabledCollider)
        {
            RequestNavGridRefresh();
        }
    }
    
    private void RequestNavGridRefresh()
    {
        if (IsInvoking(nameof(TriggerNavGridRefresh)))
        {
            CancelInvoke(nameof(TriggerNavGridRefresh));
        }
        Invoke(nameof(TriggerNavGridRefresh), 0.2f);
    }
    
    private void TriggerNavGridRefresh()
    {
        NavGrid2D.OnRequestGridRefresh?.Invoke();
        
        if (showDebugInfo)
        {
            Debug.Log($"<color=cyan>[TreeController] {gameObject.name} é€šçŸ¥NavGrid2Dåˆ·æ–°ç½‘æ ¼</color>");
        }
    }
}
```

---

## ğŸ“ ç»éªŒæ•™è®­

### æŠ€æœ¯å±‚é¢

1. **äº‹ä»¶ç³»ç»Ÿçš„ä¼˜åŠ¿**
   - **è§£è€¦**ï¼šTreeControllerä¸éœ€è¦å¼•ç”¨NavGrid2D
   - **çµæ´»**ï¼šä»»ä½•è„šæœ¬éƒ½å¯ä»¥è§¦å‘åˆ·æ–°
   - **å•ä¾‹æ¨¡å¼**ï¼šNavGrid2Dè‡ªåŠ¨ç®¡ç†è®¢é˜…å’Œæ¸…ç†

2. **å»¶è¿Ÿåˆ·æ–°çš„å¿…è¦æ€§**
   - **ç»™ç¢°æ’ä½“æ—¶é—´æ›´æ–°**ï¼š0.2ç§’è¶³å¤ŸPhysics2Dæ›´æ–°ç¢°æ’ä¿¡æ¯
   - **åˆå¹¶é‡å¤è¯·æ±‚**ï¼š`CancelInvoke + Invoke`è‡ªåŠ¨å®ç°å»æŠ–åŠ¨
   - **æ€§èƒ½ä¼˜åŒ–**ï¼š10æ£µæ ‘åŒæ—¶æˆé•¿åªåˆ·æ–°1æ¬¡

3. **çŠ¶æ€æ£€æµ‹çš„å‡†ç¡®æ€§**
   - **åŒå‘æ£€æµ‹**ï¼šä¸ä»…æ£€æµ‹å¯ç”¨ï¼Œä¹Ÿæ£€æµ‹ç¦ç”¨ï¼ˆç æ ‘æ—¶ï¼‰
   - **å¸ƒå°”æ ‡è®°**ï¼š`hadEnabledCollider != hasEnabledCollider`ç®€æ´æ˜äº†
   - **åªåœ¨çœŸæ­£å˜åŒ–æ—¶è§¦å‘**ï¼šé¿å…æ— è°“çš„åˆ·æ–°

4. **å†…å­˜ç®¡ç†**
   - **OnDestroyæ¸…ç†**ï¼šç¡®ä¿äº‹ä»¶è®¢é˜…è¢«æ­£ç¡®ç§»é™¤
   - **å•ä¾‹æ£€æŸ¥**ï¼š`if (s_instance == this)`é¿å…é‡å¤æ¸…ç†
   - **é¿å…å†…å­˜æ³„æ¼**ï¼šé™æ€äº‹ä»¶å¿…é¡»æ‰‹åŠ¨æ¸…ç†

### æ¶æ„å±‚é¢

1. **å…¨å±€äº‹ä»¶æ¨¡å¼**
   - **é€‚ç”¨åœºæ™¯**ï¼šè·¨ç³»ç»Ÿé€šä¿¡ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦
   - **æ³¨æ„äº‹é¡¹**ï¼šå¿…é¡»åœ¨OnDestroyä¸­æ¸…ç†è®¢é˜…
   - **æ€§èƒ½è€ƒè™‘**ï¼šäº‹ä»¶è°ƒç”¨å¼€é”€æå°ï¼Œå¯æ”¾å¿ƒä½¿ç”¨

2. **å»¶è¿Ÿæ‰§è¡Œæ¨¡å¼**
   - **Invokeçš„ä¼˜åŠ¿**ï¼šè‡ªåŠ¨å¤„ç†æ—¶é—´ï¼Œæ— éœ€Updateæ£€æŸ¥
   - **CancelInvokeå»æŠ–**ï¼šè‡ªåŠ¨åˆå¹¶é‡å¤è¯·æ±‚
   - **æ—¶é—´é€‰æ‹©**ï¼š0.2ç§’æ˜¯ç»éªŒå€¼ï¼Œå¯æ ¹æ®å®é™…è°ƒæ•´

3. **èŒè´£åˆ†ç¦»**
   - TreeControllerï¼šç®¡ç†æ ‘æœ¨çŠ¶æ€å’Œç¢°æ’ä½“
   - NavGrid2Dï¼šç®¡ç†å¯¼èˆªç½‘æ ¼
   - äº‹ä»¶ï¼šä½œä¸ºä¸¤è€…çš„æ¡¥æ¢

### æµç¨‹å±‚é¢

1. **æµ‹è¯•é©±åŠ¨**
   - å…ˆå¤ç°é—®é¢˜ï¼ˆæ ‘æœ¨æˆé•¿åè·¯å¾„ç©¿é€ï¼‰
   - å†è®¾è®¡æ–¹æ¡ˆï¼ˆäº‹ä»¶ç³»ç»Ÿ + å»¶è¿Ÿåˆ·æ–°ï¼‰
   - æœ€åéªŒè¯æ•ˆæœï¼ˆè·¯å¾„æ­£ç¡®ç»•è¿‡ï¼‰

2. **æ—¥å¿—è°ƒè¯•**
   - æ·»åŠ `showDebugInfo`å¼€å…³
   - è¾“å‡ºå…³é”®äº‹ä»¶å’ŒçŠ¶æ€å˜åŒ–
   - ä¾¿äºè·Ÿè¸ªå’ŒéªŒè¯

3. **æ€§èƒ½æµ‹è¯•**
   - æµ‹è¯•æç«¯æƒ…å†µï¼ˆ50æ£µæ ‘åŒæ—¶æˆé•¿ï¼‰
   - ç¡®è®¤åˆ·æ–°æ¬¡æ•°ï¼ˆåº”åªæœ‰1æ¬¡ï¼‰
   - æµ‹é‡åˆ·æ–°æ—¶é—´ï¼ˆ< 200mså¯æ¥å—ï¼‰

---

## ğŸš€ æ‰©å±•å»ºè®®

### 1. æ”¯æŒå…¶ä»–åŠ¨æ€éšœç¢ç‰©

åŒæ ·çš„æœºåˆ¶å¯ä»¥åº”ç”¨åˆ°å…¶ä»–ç±»å‹çš„åŠ¨æ€éšœç¢ç‰©ï¼š

```csharp
// å¯ç ´åçš„å¢™
public class DestructibleWall : MonoBehaviour
{
    void OnDestroyed()
    {
        GetComponent<Collider2D>().enabled = false;
        NavGrid2D.OnRequestGridRefresh?.Invoke();
    }
}

// å¯ç§»åŠ¨çš„çŸ³å¤´
public class MovableRock : MonoBehaviour
{
    void OnMoved(Vector3 newPosition)
    {
        // ç§»åŠ¨ååˆ·æ–°ç½‘æ ¼
        NavGrid2D.OnRequestGridRefresh?.Invoke();
    }
}
```

### 2. åŒºåŸŸåˆ·æ–°ä¼˜åŒ–

å¦‚æœåªæœ‰å±€éƒ¨åŒºåŸŸå˜åŒ–ï¼Œå¯ä»¥åªåˆ·æ–°è¯¥åŒºåŸŸï¼š

```csharp
// NavGrid2D.cs
public static System.Action<Bounds> OnRequestRegionRefresh;

void Awake()
{
    OnRequestRegionRefresh += RefreshRegion;
}

public void RefreshRegion(Bounds region)
{
    Vector2Int minCell = WorldToGrid(region.min);
    Vector2Int maxCell = WorldToGrid(region.max);

    for (int x = minCell.x; x <= maxCell.x; x++)
    {
        for (int y = minCell.y; y <= maxCell.y; y++)
        {
            if (x >= 0 && x < gridW && y >= 0 && y < gridH)
            {
                Vector2 worldPos = GridToWorld(x, y);
                walkable[x, y] = !IsPointBlocked(worldPos, probeRadius);
            }
        }
    }
}

// TreeController.cs
private void TriggerNavGridRefresh()
{
    // è®¡ç®—æ ‘æœ¨å½±å“çš„åŒºåŸŸ
    Bounds treeBounds = GetComponent<Collider2D>().bounds;
    treeBounds.Expand(1f);  // æ‰©å±•ä¸€ç‚¹ä½™é‡
    
    NavGrid2D.OnRequestRegionRefresh?.Invoke(treeBounds);
}
```

### 3. åˆ·æ–°é¢‘ç‡é™åˆ¶

å¦‚æœéœ€è¦æ›´ä¸¥æ ¼çš„æ€§èƒ½æ§åˆ¶ï¼š

```csharp
// NavGrid2D.cs
private float lastRefreshTime = 0f;
private const float minRefreshInterval = 0.5f;  // æœ€å°åˆ·æ–°é—´éš”

public void RefreshGrid()
{
    if (Time.time - lastRefreshTime < minRefreshInterval)
    {
        return;  // å¤ªé¢‘ç¹ï¼Œè·³è¿‡
    }
    
    lastRefreshTime = Time.time;
    RebuildGrid();
}
```

### 4. è°ƒè¯•å¯è§†åŒ–

```csharp
// TreeController.cs
void OnDrawGizmos()
{
    if (showDebugInfo && Application.isPlaying)
    {
        // æ˜¾ç¤ºç¢°æ’ä½“çŠ¶æ€
        Collider2D[] colliders = GetComponents<Collider2D>();
        foreach (var col in colliders)
        {
            if (col.enabled)
            {
                Gizmos.color = Color.red;
                Gizmos.DrawWireCube(col.bounds.center, col.bounds.size);
            }
        }
    }
}
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **å¯¼èˆªç³»ç»Ÿä¿®å¤è¯¦è§£**ï¼š`Docx/å¯¼èˆªç³»ç»Ÿä¸–ç•Œè¾¹ç•Œä¿®å¤.md`
- **ç¬¬ä¸€é˜¶æ®µå®Œç»“æŠ¥å‘Š**ï¼š`Docx/Summary/ç¬¬ä¸€é˜¶æ®µå®Œç»“æŠ¥å‘Š.md`
- **ä»£ç æ–‡ä»¶**ï¼š
  - `Assets/Scripts/Controller/TreeController.cs`
  - `Assets/Scripts/Service/Navigation/NavGrid2D.cs`

---

## ğŸ‰ æ€»ç»“

é€šè¿‡**å…¨å±€äº‹ä»¶ç³»ç»Ÿ**å’Œ**å»¶è¿Ÿåˆ·æ–°æœºåˆ¶**ï¼Œå®Œå…¨è§£å†³äº†æ ‘æœ¨æˆé•¿åå¯¼èˆªè·¯å¾„ç©¿é€çš„é—®é¢˜ã€‚è¯¥æ–¹æ¡ˆï¼š

- âœ… **å®Œå…¨è§£è€¦**ï¼šTreeControlleræ— éœ€å¼•ç”¨NavGrid2D
- âœ… **è‡ªåŠ¨åŒæ­¥**ï¼šç¢°æ’ä½“çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ç½‘æ ¼åˆ·æ–°
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå»¶è¿Ÿ0.2ç§’å¹¶è‡ªåŠ¨åˆå¹¶é‡å¤è¯·æ±‚
- âœ… **æ˜“äºæ‰©å±•**ï¼šå¯åº”ç”¨åˆ°å…¶ä»–åŠ¨æ€éšœç¢ç‰©
- âœ… **åŒå‘æ”¯æŒ**ï¼šæ—¢æ”¯æŒéšœç¢ç‰©å‡ºç°ï¼Œä¹Ÿæ”¯æŒéšœç¢ç‰©æ¶ˆå¤±

ç©å®¶çš„å¯¼èˆªè·¯å¾„å§‹ç»ˆå‡†ç¡®åæ˜ å½“å‰åœºæ™¯çŠ¶æ€ï¼Œæä¾›çœŸå®å¯é çš„è‡ªåŠ¨å¯¼èˆªä½“éªŒã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ1æ—¥  
**ç»´æŠ¤è€…**: Cascade
