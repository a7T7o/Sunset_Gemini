# UI系统完整文档

**版本**: v1.0  
**日期**: 2025-12-16  
**状态**: ✅ 已完成  
**合并来源**: 工具栏工具装备与使用分离修复方案.md、UI面板切换与快捷键系统优化方案.md、UI物品图标自适应缩放方案.md

---

## 第一部分：面板层级结构

```
UI
└── PackagePanel
    ├── Main（主面板容器）
    │   ├── 0_Props（道具页）
    │   ├── 1_Recipes（配方页）
    │   ├── 2_Ex（扩展页）
    │   ├── 3_Map（地图页）
    │   ├── 4_Relationship_NPC（关系页）
    │   └── 5_Settings（设置页）
    └── Top（顶部Tab栏）
        ├── Tab_Props
        ├── Tab_Recipes
        ├── Tab_Map
        ├── Tab_Relationship
        └── Tab_Settings
```

---

## 第二部分：快捷键系统

### 按键映射

| 按键 | 功能 |
|------|------|
| Tab/B | 切换显示 Props 页 |
| M | 切换显示 Map 页 |
| L | 切换显示 Relationship 页 |
| O | 切换显示 Settings 页 |
| ESC | 已打开任意页面→打开Settings页；未打开→打开Settings面板 |
| J | 保留给任务面板（当前无功能） |
| 1-8 | 快捷栏槽位选择 |
| 滚轮 | 快捷栏上下切换 |

### 面板切换状态机

```
状态机：
┌─────────────────────────────────────────────────────────┐
│ 初始状态：面板关闭，所有Toggle未选中                      │
└─────────────────────────────────────────────────────────┘
                     │
                     │ 按任意快捷键（Tab/B/M/L/O）
                     ↓
┌─────────────────────────────────────────────────────────┐
│ 状态A：面板打开，显示对应页面，对应Toggle选中              │
└─────────────────────────────────────────────────────────┘
                     │
                     │ 再按相同快捷键
                     ↓
┌─────────────────────────────────────────────────────────┐
│ 状态B：面板关闭，Toggle保持选中（记录最后查看的页面）       │
└─────────────────────────────────────────────────────────┘
```

### 核心实现

```csharp
public void SwitchPageWithToggle(int targetPageIndex)
{
    // 面板关闭 → 打开面板并显示目标页面
    if (!packagePanel.activeSelf)
    {
        packagePanel.SetActive(true);
        ShowPage(targetPageIndex);
        EnsureToggleOn(targetPageIndex);
        return;
    }

    // 同一页面 → 关闭面板（双击逻辑）
    if (lastPageIndex == targetPageIndex)
    {
        packagePanel.SetActive(false);
        return;
    }

    // 切换到不同页面
    ShowPage(targetPageIndex);
    EnsureToggleOn(targetPageIndex);
}
```

---

## 第三部分：工具栏系统

### 组件职责

| 组件 | 职责 |
|------|------|
| ToolbarUI | 工具栏容器，管理所有槽位 |
| ToolbarSlotUI | 单个槽位 UI，处理点击事件 |
| HotbarSelectionService | 管理选中索引，触发装备 |
| InventoryService | 背包数据管理 |
| GameInputManager | 输入检测，触发工具使用 |

### 工具选中流程

```
用户点击工具栏槽位
    ↓
ToolbarSlotUI.OnPointerClick()
    ↓
HotbarSelectionService.SelectIndex(index)
    ↓
EquipCurrentTool()
    ↓
playerToolController.EquipToolData(toolData, quality)
```

### 工具使用流程

```
用户左键点击世界空间
    ↓
GameInputManager.HandleUseCurrentTool()
    ↓
检测 IsPointerOverGameObject() → 如果在UI上则返回
    ↓
playerInteraction.RequestAction(action)
    ↓
animController.PlayAnimation(action, direction, flip)
```

### 装备与使用分离修复

**问题**：点击ToolBar选择工具后，左键点击无法触发工具使用动画

**原因**：
1. `HandleUseCurrentTool()`中`IsPointerOverGameObject()`检测导致方法提前返回
2. `ItemDatabase`是ScriptableObject，`FindFirstObjectByType`无法找到

**解决方案**：
1. 职责分离：装备在`HotbarSelectionService.SelectIndex()`中完成
2. 使用在`GameInputManager.HandleUseCurrentTool()`中只触发动画
3. 从`InventoryService.Database`获取ItemDatabase引用

```csharp
// HotbarSelectionService.cs
public void SelectIndex(int index)
{
    selectedIndex = index;
    EquipCurrentTool();  // ✅ 选中时立即装备
    OnSelectedChanged?.Invoke(selectedIndex);
}

// GameInputManager.cs
void HandleUseCurrentTool()
{
    if (IsPointerOverGameObject()) return;  // UI上不触发
    // ✅ 只触发动画，不再装备
    playerInteraction.RequestAction(action);
}
```

---

## 第四部分：物品图标自适应缩放

### 问题背景
- 物品栏规格：64x64像素，边框4像素，实际显示区域56x56像素
- 不同物品切片大小不一致（32x48、48x64、16x16等）
- 直接设置sprite导致显示比例错乱

### 解决方案：UIItemIconScaler

```csharp
public static void SetIconWithAutoScale(Image image, Sprite sprite)
{
    if (sprite == null) { image.enabled = false; return; }
    
    // 计算sprite像素尺寸
    float spriteWidth = sprite.rect.width;
    float spriteHeight = sprite.rect.height;
    
    // 计算缩放比例（保持宽高比）
    float scaleX = DISPLAY_AREA / spriteWidth;
    float scaleY = DISPLAY_AREA / spriteHeight;
    float scale = Mathf.Min(scaleX, scaleY);
    
    // 应用缩放
    image.sprite = sprite;
    image.rectTransform.sizeDelta = new Vector2(
        spriteWidth * scale, 
        spriteHeight * scale
    );
    image.rectTransform.anchoredPosition = Vector2.zero;  // 居中
    image.preserveAspect = true;
    image.enabled = true;
}
```

### 使用方式

```csharp
// 旧代码
iconImage.sprite = itemData.icon;

// 新代码
UIItemIconScaler.SetIconWithAutoScale(iconImage, itemData.icon);
```

### 配置参数

```csharp
private const float SLOT_SIZE = 64f;        // 槽位总大小
private const float BORDER_SIZE = 4f;       // 边框大小
private const float DISPLAY_AREA = 56f;     // 实际显示区域
private const float PIXELS_PER_UNIT = 16f;  // PPU
```

---

## 第五部分：工具类型到动画映射

| 工具类型 | 动画状态 | 说明 |
|---------|---------|------|
| Axe（斧头） | Slice (6) | 挥砍动作 |
| Sickle（镰刀） | Slice (6) | 挥砍动作 |
| Pickaxe（镐子） | Crush (8) | 挖掘动作 |
| Hoe（锄头） | Crush (8) | 挖掘动作（与镐子共用） |
| WateringCan（洒水壶） | Watering (10) | 浇水动作 |
| FishingRod（鱼竿） | Fish (9) | 钓鱼动作 |
| Sword（长剑） | Pierce (7) | 刺出动作 |

---

## 第六部分：相关文件

| 文件 | 职责 |
|------|------|
| `Assets/Scripts/UI/Tabs/PackagePanelTabsUI.cs` | 面板Tab管理 |
| `Assets/Scripts/UI/Toolbar/ToolbarUI.cs` | 工具栏容器 |
| `Assets/Scripts/UI/Toolbar/ToolbarSlotUI.cs` | 工具栏槽位 |
| `Assets/Scripts/UI/Inventory/InventorySlotUI.cs` | 背包槽位 |
| `Assets/Scripts/UI/Utility/UIItemIconScaler.cs` | 图标缩放工具 |
| `Assets/Scripts/Service/Inventory/HotbarSelectionService.cs` | 快捷栏选择服务 |
| `Assets/Scripts/Controller/Input/GameInputManager.cs` | 输入管理 |

---

*文档结束 - 本文档合并了界面UI文件夹的所有内容*
