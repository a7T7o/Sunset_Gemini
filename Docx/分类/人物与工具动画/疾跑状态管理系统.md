# 疾跑状态管理系统

**日期**: 2025-12-09  
**状态**: ✅ 已完成

---

## 功能概述

统一管理 WASD 移动和导航的疾跑状态，支持：
1. **3秒疾跑记忆** - 3秒内有过疾跑，新导航默认疾跑
2. **双击切换模式** - 双击右键切换疾跑/行走（原有功能保留）
3. **长按疾跑模式** - 长按右键疾跑，松开停止（新增）
4. **体力系统预留** - 为后续体力消耗系统预留接口

---

## 核心设计

### 疾跑记忆机制

**原理**：
- 记录上次疾跑的时间戳
- 任何疾跑行为（WASD 或导航）都会更新时间戳
- 3秒内开始新导航，自动使用疾跑

**好处**：
- 玩家不需要频繁切换疾跑状态
- 符合玩家直觉（刚才在跑，现在也想跑）
- 减少操作负担

### 双模式支持

#### Toggle 模式（切换模式）
- 双击右键切换疾跑开关
- 开关状态持续生效
- 适合长时间探索

#### HoldToSprint 模式（长按模式）
- 长按右键时疾跑
- 松开右键停止疾跑
- 适合战斗场景（体力管理）

---

## 技术实现

### 新增文件

**SprintStateManager.cs**
- 位置：`Assets/Scripts/Service/Player/SprintStateManager.cs`
- 单例模式管理全局疾跑状态
- 提供统一的疾跑判定接口

### 修改文件

1. **PlayerMovement.cs**
   - 集成疾跑状态管理器
   - WASD 疾跑时通知管理器

2. **GameInputManager.cs**
   - 处理右键按下/松开事件
   - 传递给疾跑状态管理器

3. **PlayerAutoNavigator.cs**
   - 导航开始时查询疾跑状态
   - 导航结束时通知管理器
   - 双击切换时通知管理器

---

## 使用方法

### 场景配置

1. **自动创建**：
   - 系统会在玩家 Awake 时自动创建 SprintStateManager
   - 无需手动添加到场景

2. **手动配置**（可选）：
   - 在场景中创建空物体 `SprintStateManager`
   - 添加 `SprintStateManager` 组件
   - 配置参数：
     - 疾跑记忆时间：3秒（默认）
     - 导航模式：Toggle 或 HoldToSprint

### 参数说明

**疾跑记忆持续时间**：
- 默认：3秒
- 范围：1-10秒
- 建议：3-5秒

**导航疾跑模式**：
- **Toggle**：双击切换，适合探索
- **HoldToSprint**：长按疾跑，适合战斗

---

## 工作流程

### 场景 1：WASD 移动后导航

```
1. 玩家按住 Shift + WASD 疾跑
2. 疾跑状态管理器记录时间戳
3. 2秒后，玩家右键点击导航
4. 系统检测到有疾跑记忆 → 自动疾跑
```

### 场景 2：导航后再导航

```
1. 玩家右键导航（疾跑状态）
2. 疾跑状态管理器记录时间戳
3. 1秒后，玩家右键点击新位置
4. 系统检测到有疾跑记忆 → 继续疾跑
```

### 场景 3：长按疾跑模式

```
1. 切换到 HoldToSprint 模式
2. 玩家右键点击并按住
3. 导航开始，角色疾跑
4. 玩家松开右键
5. 角色停止疾跑，改为行走
```

---

## 体力系统接口

### IStaminaSystem 接口

```csharp
public interface IStaminaSystem
{
    bool CanSprint();              // 是否有足够体力
    void ConsumeStamina(float amount);  // 消耗体力
    void RegenerateStamina(float amount); // 恢复体力
}
```

### 集成方式

后续实现体力系统时：
1. 创建体力管理器类
2. 实现 `IStaminaSystem` 接口
3. 调用 `SprintStateManager.Instance.SetStaminaSystem(staminaSystem)`
4. 系统会自动检查体力

---

## 调试功能

### 调试信息

在 Inspector 中启用 `Show Debug Info`：
- 实时显示 WASD 疾跑状态
- 实时显示导航疾跑状态
- 显示疾跑记忆状态
- 显示当前模式

### 日志输出

```
[疾跑状态] WASD:True | 导航:False | 记忆:True | 模式:Toggle | Toggle:True
```

---

## 常见问题

### Q1: 为什么导航时没有疾跑？

**检查**：
1. 是否在 3秒内有过疾跑？
2. Toggle 模式下，疾跑开关是否开启？
3. HoldToSprint 模式下，是否按住右键？

### Q2: 如何切换导航模式？

**方法 1**：在 Inspector 中修改 `Navigation Mode`
**方法 2**：代码调用 `SprintStateManager.Instance.SetNavigationMode(mode)`

### Q3: 疾跑记忆时间可以调整吗？

可以，在 Inspector 中修改 `Sprint Memory Duration`（1-10秒）

### Q4: 体力系统什么时候实现？

预留了接口，后续实现体力系统时直接集成即可。

---

## 优势总结

### 用户体验
- ✅ 减少操作负担（自动记忆疾跑状态）
- ✅ 符合直觉（刚才在跑，现在也跑）
- ✅ 灵活控制（支持两种模式）

### 技术架构
- ✅ 统一管理（单一职责）
- ✅ 易于扩展（体力系统接口）
- ✅ 解耦设计（各模块独立）

### 后续扩展
- ✅ 体力系统集成
- ✅ 疲劳系统集成
- ✅ Buff/Debuff 系统集成

---

**文档版本**: v1.0  
**最后更新**: 2025-12-09
