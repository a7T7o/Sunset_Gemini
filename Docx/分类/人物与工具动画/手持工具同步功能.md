# æ‰‹æŒå·¥å…·åŒæ­¥åŠŸèƒ½ - å®Œæ•´å¼€å‘æ–‡æ¡£

ç‰ˆæœ¬: v3.0  
æ—¥æœŸ: 2025-12-16  
çŠ¶æ€: **å·²å®Œæˆ**

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£ç³…åˆäº†æ‰€æœ‰æ‰‹æŒå·¥å…·ç›¸å…³çš„å†å²æ–‡æ¡£ï¼ŒæŒ‰æ—¶é—´çº¿è®°å½•å®Œæ•´å¼€å‘å†ç¨‹ï¼Œæœ€åæ€»ç»“å½“å‰æœ€ç»ˆæ–¹æ¡ˆã€‚

**ç³…åˆçš„å†å²æ–‡æ¡£**ï¼š
- `Plan/æ‰‹æŒç‰©å“åŠ¨ç”»åŒæ­¥æ”¹è¿›æ–¹æ¡ˆ.md` (2025-11-13)
- `Plan/æ‰‹æŒç‰©å“åŠ¨ç”»åŒæ­¥æ”¹è¿›æ–¹æ¡ˆ_v2.md` (2025-11-13)
- `Plan/ä¸‰å‘åŠ¨ç”»ç”Ÿæˆå™¨è§„åˆ’.md` (2025-11-13)
- `Docx/Plan/æ‰‹æŒç‰©å“åŠ¨ç”»åŒæ­¥ä¸ä¸‰å‘ç”Ÿæˆå™¨æ€»ä½“è§„åˆ’.md` (2025-11-13)
- `Docx/Plan/æ‰‹æŒç‰©å“çš„è¿›ä¸€æ­¥è§„åˆ’å®ç°æ–¹æ¡ˆ.md` (2025-11-13)
- `Docx/Solutions/æ‰‹æŒç‰©å“åŠ¨ç”»ç³»ç»Ÿæ•°æ®é©±åŠ¨ä¼˜åŒ–æ–¹æ¡ˆ.md` (2025-12-12)
- `Docx/Summary/äººç‰©ä¸å·¥å…·åŠ¨ç”»åŒæ­¥æ–¹æ¡ˆæ€»ç»“.md` (2025-11-13)

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šå†å²å¼€å‘æ—¥å¿—

---

## ğŸ“… 2025-11-13ï¼šæ—©æœŸæ–¹æ¡ˆæ¢ç´¢

### 1.1 èƒŒæ™¯ä¸é—®é¢˜

é¡¹ç›®é‡‡ç”¨"äººç‰©(Player) + å·¥å…·(Tool)"çš„åˆ†å±‚åŠ¨ç”»æ¶æ„ã€‚æ—©æœŸé—®é¢˜ï¼š
- å·¥å…·åŠ¨ç”»ä¸äººç‰©åŠ¨ç”»å­˜åœ¨ 1~2 å¸§çš„å¯è§å»¶è¿Ÿ
- ç‰¹åˆ«åœ¨å¤§ä½ç§»å¸§å‡ºç°æ‹–å½±
- ç¼–è¾‘å™¨å¶å‘ UnityEditor.Graphs ç›¸å…³æŠ¥é”™

### 1.2 å°è¯•çš„åŒæ­¥æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Mode Aï¼šçº¯å‚æ•°é•œåƒ + æ—¶é—´å¯¹é½
```csharp
// é•œåƒ State/Direction åˆ°å·¥å…· Animator
// ä»¥ Player çš„ normalizedTime å¯¹é½å·¥å…·
toolAnimator.Play(hash, 0, playerNormalizedTime);
```
**ç»“æœ**ï¼šâŒ å¤±è´¥ - Sprite åŠ¨ç”»æ˜¯ç¦»æ•£å–æ ·ï¼Œè¾¹ç•Œå¤„ä¸¤ä¾§å¯èƒ½å–åˆ°ä¸åŒå¸§ï¼Œä»ä¼šå‡ºç° 1 å¸§æ‹–å½±

#### æ–¹æ¡ˆ Mode A+ï¼šå‚æ•°é•œåƒ + å½“å¸§è¯„ä¼° + æ—¶é—´å¯¹é½
```csharp
// é•œåƒå‚æ•°åç«‹åˆ» Update(0)ï¼Œå¼ºåˆ¶å½“å¸§å®Œæˆè¿‡æ¸¡
toolAnimator.SetInteger("State", playerState);
toolAnimator.Update(0);
toolAnimator.Play(hash, 0, playerNormalizedTime);
toolAnimator.Update(0);
```
**ç»“æœ**ï¼šâš ï¸ éƒ¨åˆ†æ”¹å–„ - é¿å…äº†"ä¸‹ä¸€å¸§æ‰è½ä½"çš„é—®é¢˜ï¼Œä½†ä»åŸºäºè¿ç»­æ—¶é—´ï¼Œç¦»æ•£è¾¹ç•Œä¸å®Œå…¨ä¸€è‡´æ—¶ä¼šå‡ºç° 1 å¸§æ‹–å½±

#### æ–¹æ¡ˆ Mode A++ï¼šå¸§ç´¢å¼•ç¡¬é” ğŸ’¡
```csharp
// ä» Player å½“å‰ Sprite åè§£æå¸§å·
if (TryGetPlayerFrameIndex(out int frameIndex))
{
    // æŒ‰å¸§æ•°æ¯”ä¾‹æ˜ å°„åˆ°å·¥å…·å¸§å·
    int mappedToolIndex = Mathf.RoundToInt(frameIndex * (toolCount - 1f) / (playerCount - 1f));
    float toolNorm = (mappedToolIndex / (float)(toolCount - 1)) + EPSILON;
    toolAnimator.Play(targetHash, 0, toolNorm);
    toolAnimator.Update(0);
}
```
**ç»“æœ**ï¼šâœ… æˆåŠŸ - å½»åº•æ¶ˆé™¤ç¦»æ•£è¾¹ç•Œçš„ä¸ä¸€è‡´ï¼Œæ‹–å½±é—®é¢˜æ¶ˆå¤±

### 1.3 æ—©æœŸæ¶æ„è§„åˆ’ï¼ˆå·²åºŸå¼ƒï¼‰

å½“æ—¶è§„åˆ’çš„å¤æ‚åˆ†ç»„æ¶æ„ï¼š
```
Player
â”œâ”€â”€ SliceGroup (åŠ¨ä½œç±»å‹å®¹å™¨)
â”‚   â”œâ”€â”€ SliceToolManager (åˆ†ç»„ç®¡ç†å™¨)
â”‚   â””â”€â”€ Axe (æ–§å¤´)
â”œâ”€â”€ CrushGroup
â”‚   â”œâ”€â”€ CrushToolManager
â”‚   â””â”€â”€ Pickaxe (é•å­)
â””â”€â”€ PierceGroup
    â”œâ”€â”€ PierceToolManager
    â””â”€â”€ Sword (å‰‘)
```

**è¯„ä¼°ç»“è®º**ï¼š
- å¤æ‚åº¦æ”¶ç›Šæ¯”è¿‡ä½
- å½“å‰ä»…æ–§å¤´ä¸€ç§å·¥å…·ï¼Œæš‚æ— éœ€å¦‚æ­¤å¤æ‚çš„åˆ†å±‚
- å‘½åé€»è¾‘ä¸ç°æœ‰ Mode A++ æ–¹æ¡ˆå†²çª

### 1.4 æ¨èçš„æ¸è¿›å¼æ–¹æ¡ˆ

å½“æ—¶æ¨èçš„æ‰å¹³åŒ–å¤šå·¥å…·ç®¡ç†ï¼š
```
Player
â”œâ”€â”€ PlayerToolManager (æ ¸å¿ƒç®¡ç†å™¨)
â”œâ”€â”€ LayerAnimSync (åŒæ­¥æ§åˆ¶å™¨)
â””â”€â”€ å·¥å…·GameObjects (æ‰å¹³å­˜æ”¾)
    â”œâ”€â”€ Axe_Quality_0
    â”œâ”€â”€ Axe_Quality_1
    â””â”€â”€ ...
```

### 1.5 å‘½åè§„èŒƒç¡®å®š

ç»Ÿä¸€å‘½åè§„åˆ™ï¼š`{åŠ¨ä½œç±»å‹}_{æ–¹å‘}_Clip_{itemId}_{quality}`
- åŠ¨ä½œç±»å‹ï¼šSlice/Crush/Pierce
- æ–¹å‘ï¼šDown/Side/Up
- itemIdï¼šå·¥å…·å”¯ä¸€ID
- qualityï¼šå“è´¨ï¼ˆåŸºç¡€ç‰©å“å¤šå“è´¨ï¼›æ— å“è´¨ç‰©å“å›ºå®šä¸º0ï¼‰

ç¤ºä¾‹ï¼š`Slice_Down_Clip_1_0`ã€`Crush_Side_Clip_3_0`

---

## ğŸ“… 2025-11-13ï¼šä¸‰å‘åŠ¨ç”»ç”Ÿæˆå™¨è§„åˆ’

### 2.1 å·¥å…·èŒè´£åˆ’åˆ†

**äº¤ä»˜æ–¹ï¼ˆä¸‰å‘åŠ¨ç”»ç”Ÿæˆå™¨ï¼‰**ï¼š
- è¯»å–æº Aseprite pivot æ•°æ®
- è¯»å–åˆ‡å‰²å sprite æ–‡ä»¶å¤¹
- è¿›è¡Œ pivot è½¬æ¢ä¸ dry-run æ ¡éªŒ
- ç”Ÿæˆ AnimationClips
- è¾“å‡º manifest.json ä¾›æ¥æ”¶æ–¹ä½¿ç”¨

**æ¥æ”¶æ–¹ï¼ˆSliceAnimControllerToolï¼‰**ï¼š
- æ ¹æ® manifest ç”Ÿæˆ AnimatorController
- é…ç½®çŠ¶æ€æœºã€çŠ¶æ€åã€å‚æ•°ä¸ transitions
- æŠŠ clips ä¸ Controller åšæœ€ç»ˆç»‘å®š

### 2.2 Manifest æ•°æ®å¥‘çº¦

```json
{
  "itemId": 1,
  "quality": 0,
  "actionType": "Slice",
  "clips": {
    "Down": "Assets/.../Slice_Down_Clip_1_0.anim",
    "Side": "...",
    "Up": "..."
  },
  "spriteMap": {"Down": ["sprite_000.png", "sprite_001.png"]},
  "pivotMap": {"Down": [[0.5,0.1],[0.52,0.12]]},
  "totalFrames": 18,
  "lastFrame": 17
}
```

### 2.3 éªŒæ”¶æ ‡å‡†

- å¸§æ•°ä¸ totalFrames/lastFrame åŒ¹é…
- manifest ä¸ clip æ•°é‡ä¸€è‡´
- pivot åº”ç”¨åæœ€å¤§åå·® â‰¤ 1 åƒç´ 

---

## ğŸ“… 2025-12-12ï¼šæ•°æ®é©±åŠ¨ä¼˜åŒ–

### 3.1 ä¼˜åŒ–ç›®æ ‡

1. å°†åŠ¨ç”»èµ„æºç´¢å¼•ç›´æ¥å­˜å‚¨åœ¨ ToolData ä¸­ï¼Œæ¶ˆé™¤ç¡¬ç¼–ç 
2. é¢„ç¼“å­˜çŠ¶æ€ Hashï¼Œé¿å…è¿è¡Œæ—¶å­—ç¬¦ä¸²æ‹¼æ¥
3. ä¿®å¤åˆ‡æ¢å·¥å…·æ—¶ Sprite ä¸æ›´æ–°çš„é—®é¢˜
4. æ–°å¢å·¥å…·åªéœ€é…ç½® ScriptableObjectï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

### 3.2 ToolData æ–°å¢å­—æ®µ

```csharp
[Header("=== åŠ¨ç”»èµ„æºç›´æ¥å¼•ç”¨ ===")]
public RuntimeAnimatorController animatorController;  // ç›´æ¥å¼•ç”¨Controller
public int animationFrameCount = 8;                   // åŠ¨ç”»å¸§æ•°
public AnimActionType animActionType;                 // åŠ¨ä½œç±»å‹æšä¸¾

public enum AnimActionType
{
    Slice = 6,      // æ–§å¤´/é•°åˆ€
    Pierce = 7,     // é•¿å‰‘
    Crush = 8,      // é•å­/é”„å¤´
    Fish = 9,       // é±¼ç«¿
    Watering = 10   // æ°´å£¶
}
```

### 3.3 æ€§èƒ½å¯¹æ¯”

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| Controller æ˜ å°„ | æ¯æ¬¡ switch åˆ¤æ–­ | ç›´æ¥å¼•ç”¨ |
| çŠ¶æ€ Hash | æ¯å¸§å­—ç¬¦ä¸²æ‹¼æ¥ | é¢„ç¼“å­˜ |
| å¸§æ•°é…ç½® | ç¡¬ç¼–ç  switch | ToolData é…ç½® |
| GC åˆ†é… | æ¯å¸§äº§ç”Ÿå­—ç¬¦ä¸² | é›¶åˆ†é… |

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šæœ¬æ¬¡å¯¹è¯å¼€å‘å†ç¨‹ï¼ˆ2025-12-16ï¼‰

---

## ğŸ“… ä»»åŠ¡ï¼šå·¥å…·åŠ¨ä½œé”å®šä¸è¾“å…¥ç¼“å­˜ç³»ç»Ÿ

### 4.1 ç”¨æˆ·éœ€æ±‚

1. åŠ¨ç”»æ’­æ”¾æœŸé—´é”å®š toolbar å’Œç§»åŠ¨
2. ç¼“å­˜æ–¹å‘é”®å’Œ hotbar åˆ‡æ¢è¾“å…¥ï¼ˆåªä¿ç•™æœ€åä¸€æ¬¡ï¼‰
3. æ”¯æŒé•¿æŒ‰è¿ç»­ä½¿ç”¨å·¥å…·
4. æ–¹å‘åˆ‡æ¢å¹³æ»‘
5. åŠ¨ç”»ç»“æŸå¹²å‡€ï¼Œæ— é—ªçƒ/é¬¼ç•œ

### 4.2 é˜¶æ®µä¸€ï¼šåŸºç¡€å®ç°

**å®ç°å†…å®¹**ï¼š
- åˆ›å»º `ToolActionLockManager` å•ä¾‹ç®¡ç†é”å®šçŠ¶æ€
- `PlayerInteraction` ä¸­æ·»åŠ åŠ¨ä½œè§¦å‘å’Œå®Œæˆæ£€æµ‹é€»è¾‘
- å®ç°æ–¹å‘ç¼“å­˜å’Œ Hotbar ç¼“å­˜

**ç»“æœ**ï¼šâœ… åŸºç¡€åŠŸèƒ½å®Œæˆ

---

### 4.3 é˜¶æ®µäºŒï¼šé•¿æŒ‰è¿ç»­ä½¿ç”¨å‡ºç°ä¸¥é‡é¬¼ç•œ âŒ

**é—®é¢˜ç°è±¡**ï¼š
- é•¿æŒ‰ä½¿ç”¨å·¥å…·æ—¶ï¼ŒåŠ¨ç”»å‡ºç°æ˜æ˜¾çš„æŠ–åŠ¨/è·³å¸§
- ä¸Šä¸‹æ–¹å‘é•¿æŒ‰æ—¶ä¼šå¡ä½ï¼Œæ— æ³•åœæ­¢æˆ–åˆ‡æ¢æ¨¡å¼

**ç”¨æˆ·åé¦ˆ**ï¼š
> "ä½ ç°åœ¨ç»™æˆ‘å»è·å–æ§åˆ¶å°è¾“å‡ºã€‚ã€‚ã€‚ä½ è‡ªå·±çœ‹çœ‹ä½ å¡äº†å¤šä¹…ï¼Œä¸Šä¸‹æ–¹å‘çš„é•¿æ‘æ—¶è¾“å‡ºæ–¹å‘é”®ä½ ä¼šè«åå…¶å¦™å¡åœ¨è¿™ä¸ªåŠ¨ç”»æ— è®ºæˆ‘è¾“å…¥æ–¹å‘è¿˜æ˜¯å†æ‘ä¸‹å·¦é”®éƒ½æ²¡åŠæ³•è®©ç©å®¶åœä¸‹æ¥æˆ–è€…æ¢æˆå…¶ä»–æ¨¡å¼ï¼Œè¿™å¾ˆæœ‰æ¯›ç—…ã€‚ã€‚ã€‚è€Œä¸”ä½ è¿˜æ˜¯æœ‰é¬¼ç•œé‚£ä¸€ä¸‹"

**é”™è¯¯å°è¯•**ï¼šä½¿ç”¨ `normalizedTime` è¿½è¸ªåŠ¨ç”»è¿›åº¦
```csharp
// âŒ é—®é¢˜ï¼šnormalizedTime åœ¨åŠ¨ç”»è¾¹ç•Œå¤„ä¸ç¨³å®š
AnimatorStateInfo stateInfo = animator.GetCurrentAnimatorStateInfo(0);
if (stateInfo.normalizedTime >= 1.0f) { /* åŠ¨ç”»å®Œæˆ */ }
```

**å¤±è´¥åŸå› **ï¼š`normalizedTime` åœ¨åŠ¨ç”»è¾¹ç•Œå¤„å€¼ä¸ç²¾ç¡®ï¼Œå¯¼è‡´åˆ¤æ–­é”™è¯¯

---

### 4.4 é˜¶æ®µä¸‰ï¼šç»§ç»­å°è¯•ä¿®å¤ä½†æ–¹å‘é”™è¯¯ âŒ

**ç”¨æˆ·åé¦ˆ**ï¼š
> "è¿˜æ˜¯æœ‰å¾ˆå¤§çš„é—®é¢˜ç”šè‡³ç°åœ¨ä¼šå‡ºç°å¡é¡¿ï¼Œä½ çœ‹æ§åˆ¶å°å§ï¼Œè¿™ä¸ªç°åœ¨æ˜¯å‡ºç°ä¸ç²¾ç¡®çš„é—®é¢˜äº†ï¼Œæˆ‘ç»™ä½ å›æ»šåˆ°å‰é¢çš„æƒ…å†µäº†ï¼Œè¿™ä¸ªä½ çš„æ–¹å‘å…¨é”™äº†ï¼Œé‡æ–°æ€è€ƒç»™æˆ‘æœ€æµç•…çš„åŠ¨ç”»æ•ˆæœå¤„ç†"

**å¤±è´¥åŸå› **ï¼šç»§ç»­ä¾èµ– Animator çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ–¹å‘å®Œå…¨é”™è¯¯

---

### 4.5 é˜¶æ®µå››ï¼šğŸ’¡ çªç ´ - ç®€å•æ—¶é—´è®¡æ—¶å™¨

**ğŸ’¡ æ ¸å¿ƒçªç ´**ï¼šæ”¾å¼ƒä¾èµ– Animator çš„ `normalizedTime`ï¼Œæ”¹ç”¨ç®€å•çš„æ—¶é—´è®¡æ—¶å™¨ï¼

```csharp
// PlayerAnimController.cs
[SerializeField] private float toolAnimationDuration = 0.8f;  // å›ºå®šæ—¶é•¿
private float _actionStartTime = 0f;
private bool _isPerformingToolAction = false;

public void StartAnimationTracking()
{
    _actionStartTime = Time.time;
    _isPerformingToolAction = true;
}

public bool IsAnimationFinished()
{
    if (!_isPerformingToolAction) return true;
    return Time.time - _actionStartTime >= toolAnimationDuration;
}
```

**ç”¨æˆ·åé¦ˆ**ï¼š
> "ç°åœ¨éå¸¸æ— æ•Œå®Œç¾ï¼Œä½†æ˜¯ç¾ä¸­ä¸è¶³å°±æ˜¯å”¯ä¸€çš„ä¸€ä¸¢ä¸¢ç‘•ç–µï¼Œå½“æˆ‘é•¿æ‘æ—¶å†æ¾å¼€ä¼šå‡ºç°æœ€å¼€å§‹å’Œä½ æè¿°çš„é‚£ä¸ªæœ€åä¸€å¸§çš„é¬¼ç•œ"

**ç»“æœ**ï¼šâœ… é•¿æŒ‰æœŸé—´çš„é¬¼ç•œå®Œå…¨æ¶ˆé™¤ï¼ä½†åŠ¨ç”»ç»“æŸæ—¶è¿˜æœ‰é—®é¢˜

---

### 4.6 é˜¶æ®µäº”ï¼šæ–¹å‘ç¼“å­˜åº”ç”¨æ—¶æœºé—®é¢˜ âš ï¸

**é—®é¢˜ç°è±¡**ï¼šæ–¹å‘åˆ‡æ¢æœ‰å»¶è¿Ÿæ„Ÿ

**ç”¨æˆ·åé¦ˆ**ï¼š
> "ä¸å¯¹ï¼Œè¿™ä¸ªè¿˜æ˜¯ä¸å¯¹ï¼Œè¿˜æ˜¯ä¸å¯¹ï¼Œä½ ç°åœ¨æ˜¯åœ¨æ’­æ”¾ç¬¬äºŒä¸ªåŠ¨ç”»çš„ç¬¬ä¸€å¸§çš„æ—¶å€™æ‰å¼€å§‹åˆ‡æ¢åˆ°ç¼“å­˜çš„æ–¹å‘ï¼Œè¿™æ ·å°±æ˜¯ä¼šæœ‰å»¶è¿Ÿä¸€æ ·çš„æ—¶é—´æ•ˆæœï¼Œè¿™æ ·ä¸å¯¹"

**ä¿®å¤**ï¼šåœ¨åŠ¨ç”»ç»“æŸæ—¶ã€æ–°åŠ¨ç”»å¼€å§‹å‰åº”ç”¨ç¼“å­˜æ–¹å‘
```csharp
private void OnActionComplete()
{
    // â˜… å…³é”®ï¼šå…ˆåº”ç”¨ç¼“å­˜çš„æ–¹å‘ï¼ˆåªæ›´æ–°æœå‘æ•°æ®ï¼Œä¸æ’­æ”¾åŠ¨ç”»ï¼‰
    ApplyCachedDirectionToFacing();
    
    // ç„¶åæ£€æŸ¥æ˜¯å¦ç»§ç»­é•¿æŒ‰...
}
```

---

### 4.7 é˜¶æ®µå…­ï¼šåŠ¨ç”»ç»“æŸæ—¶çš„é¬¼ç•œ/é—ªçƒ âš ï¸

**é—®é¢˜ç°è±¡**ï¼š
1. æ¾å¼€æŒ‰é”®åï¼ŒåŠ¨ç”»æœ€åä¸€å¸§ä¼šå‡ºç°çŸ­æš‚é—ªçƒ
2. é¢„è¾“å…¥åˆ‡æ¢æ­¦å™¨æ—¶ï¼Œä¼šçœ‹åˆ°æ–°æ­¦å™¨çš„ sprite é—ªç°ä¸€å¸§

**ç”¨æˆ·åé¦ˆ**ï¼š
> "å½“æˆ‘é•¿æ‘æ—¶å†æ¾å¼€ä¼šå‡ºç°æœ€å¼€å§‹å’Œä½ æè¿°çš„é‚£ä¸ªæœ€åä¸€å¸§çš„é¬¼ç•œ...è€Œä¸”å½“æˆ‘åœ¨æœ€åä¸€ä¸ªåŠ¨ç”»ç»“æŸå‰é¢„è¾“å…¥åˆ‡æ¢æ­¦å™¨çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°æœ€å¼€å§‹æè¿°çš„é¬¼ç•œï¼Œç”šè‡³é¬¼ç•œå‡ºç°çš„é‚£å¸§æ˜¯åˆ‡æ¢åçš„æ­¦å™¨çš„spriteï¼Œè¿™å¾ˆæ€ªå¼‚"

**ç”¨æˆ·æç¤º**ï¼š
> "æˆ‘çŸ¥é“äº†è¿™ä¸ªé¬¼ç•œåº”è¯¥æ˜¯åŠ¨ç”»ç»“æŸæå¾—é¬¼"

---

### 4.8 é˜¶æ®µä¸ƒï¼šğŸ’¡ æœ€ç»ˆè§£å†³ - å¼ºåˆ¶éšè—æœºåˆ¶

**ğŸ’¡ æ ¸å¿ƒçªç ´**ï¼šåœ¨åŠ¨ä½œç»“æŸæ—¶å¼ºåˆ¶éšè—å·¥å…·ï¼Œæ–°åŠ¨ä½œå¼€å§‹æ—¶æ‰å…è®¸æ˜¾ç¤ºï¼

```csharp
// LayerAnimSync.cs
private bool _forceHideUntilNextAction = false;

public void ForceHideTool()
{
    _forceHideUntilNextAction = true;
    if (toolSpriteRenderer != null)
        toolSpriteRenderer.enabled = false;
}

public void AllowToolShow()
{
    _forceHideUntilNextAction = false;
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
```csharp
// PlayerInteraction.cs
private void StartAction(...)
{
    layerAnimSync?.AllowToolShow();  // â˜… å…è®¸å·¥å…·æ˜¾ç¤º
    // ...
}

private void OnActionComplete()
{
    if (shouldContinue) {
        // é•¿æŒ‰ç»§ç»­...
    } else {
        layerAnimSync?.ForceHideTool();  // â˜… å¼ºåˆ¶éšè—å·¥å…·
        // ...
    }
}
```

**ç”¨æˆ·åé¦ˆ**ï¼š
> "å®Œç¾ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼"

**ç»“æœ**ï¼šâœ… æ‰€æœ‰é—®é¢˜å®Œç¾è§£å†³ï¼

---

### 4.9 æ™ºèƒ½æ–¹å‘æ£€æµ‹ï¼ˆè¿ç»­åŠ¨ä½œä¼˜åŒ–ï¼‰

**éœ€æ±‚**ï¼šé•¿æŒ‰æœŸé—´æ–¹å‘ä¸å˜æ—¶ï¼ŒåŠ¨ç”»åº”è¯¥è‡ªç„¶å¾ªç¯ï¼Œä¸é‡ç½®

```csharp
// PlayerAnimController.cs
public void ForcePlayAnimation(AnimState state, AnimDirection direction, bool shouldFlip)
{
    bool directionChanged = (direction != currentDirection) || (shouldFlip != isFlipped);
    
    if (directionChanged)
    {
        PlayAnimationInternal(state, direction, shouldFlip);
    }
    // æ–¹å‘ä¸å˜ï¼šä»€ä¹ˆéƒ½ä¸åšï¼Œè®©åŠ¨ç”»è‡ªç„¶å¾ªç¯
}
```

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæœ€ç»ˆæ–¹æ¡ˆæ€»ç»“

---

## 5.1 å½“å‰æ¶æ„ï¼ˆæœ€æ–°ï¼‰

```
Player
â””â”€â”€ Tool    â† å•ä¸€å·¥å…·å­å¯¹è±¡ï¼ŒåŠ¨æ€åˆ‡æ¢ Controller
```

è¿™æ˜¯å½“å‰å®é™…ä½¿ç”¨çš„ç®€åŒ–æ¶æ„ï¼Œæ—©æœŸè§„åˆ’çš„å¤æ‚åˆ†ç»„æ¶æ„å·²åºŸå¼ƒã€‚

## 5.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `PlayerInteraction` | åŠ¨ä½œè§¦å‘ã€å®Œæˆæ£€æµ‹ã€è¾“å…¥ç¼“å­˜åº”ç”¨ |
| `PlayerAnimController` | ç©å®¶åŠ¨ç”»æ’­æ”¾ã€æ—¶é—´è®¡æ—¶å™¨ |
| `LayerAnimSync` | å·¥å…·å¸§åŒæ­¥ã€æ˜¾éšæ§åˆ¶ã€flipXåŒæ­¥ |
| `PlayerToolController` | å·¥å…·åˆ‡æ¢ã€Controllerç®¡ç†ã€å‚æ•°è®¾ç½® |
| `ToolActionLockManager` | è¾“å…¥é”å®šã€æ–¹å‘/Hotbarç¼“å­˜ |

## 5.3 ä¸‰ä¸ªæ ¸å¿ƒçªç ´ç‚¹

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| é•¿æŒ‰æœŸé—´é¬¼ç•œ | æ—¶é—´è®¡æ—¶å™¨æ›¿ä»£ normalizedTime |
| æ–¹å‘åˆ‡æ¢æŠ½æ | ForcePlayAnimation æ™ºèƒ½æ–¹å‘æ£€æµ‹ |
| åŠ¨ç”»ç»“æŸé—ªçƒ | ForceHideTool / AllowToolShow æœºåˆ¶ |

## 5.4 åŠ¨ç”»çŠ¶æ€æ˜ å°„

| å·¥å…·ç±»å‹ | AnimState | å€¼ |
|---------|-----------|-----|
| æ–§å¤´ (Axe) | Slice | 6 |
| é•°åˆ€ (Sickle) | Slice | 6 |
| é•å­ (Pickaxe) | Crush | 8 |
| é”„å¤´ (Hoe) | Crush | 8 |
| é•¿å‰‘ (Sword) | Pierce | 7 |
| é±¼ç«¿ (FishingRod) | Fish | 9 |
| æ´’æ°´å£¶ (WateringCan) | Watering | 10 |

> âš ï¸ **æ³¨æ„**ï¼šé”„å¤´ä½¿ç”¨ Crush (8)ï¼Œä¸é•å­å…±ç”¨æŒ–æ˜åŠ¨ç”»ï¼

## 5.5 æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ï¼ˆé¼ æ ‡å·¦é”®ï¼‰
    â”‚
    â–¼
PlayerInteraction.PerformAction()
    â”œâ”€â”€ ToolActionLockManager.BeginAction()
    â”œâ”€â”€ LayerAnimSync.AllowToolShow()  â† å…è®¸æ˜¾ç¤º
    â””â”€â”€ PlayerAnimController.PlayAnimation()
                â”‚
                â–¼
          åŠ¨ç”»æ’­æ”¾ä¸­...
          ï¼ˆLayerAnimSync å¸§åŒæ­¥ï¼‰
          ï¼ˆæ—¶é—´è®¡æ—¶å™¨è®¡æ—¶ï¼‰
                â”‚
                â–¼
PlayerAnimController.IsAnimationFinished()  â† åŸºäºæ—¶é—´è®¡æ—¶å™¨
    â”‚
    â–¼
PlayerInteraction.OnActionComplete()
    â”œâ”€â”€ ApplyCachedDirectionToFacing()  â† å…ˆåº”ç”¨ç¼“å­˜æ–¹å‘
    â”‚
    â”œâ”€â”€ [ç»§ç»­é•¿æŒ‰] â†’ ForcePlayAnimation()
    â”‚
    â””â”€â”€ [æ¾å¼€] â†’ LayerAnimSync.ForceHideTool()  â† å¼ºåˆ¶éšè—
```

---

## 5.6 å…³é”®ä»£ç 

### æ—¶é—´è®¡æ—¶å™¨
```csharp
// PlayerAnimController.cs
private float toolAnimationDuration = 0.8f;
private float _actionStartTime = 0f;

public void StartAnimationTracking() {
    _actionStartTime = Time.time;
    _isPerformingToolAction = true;
}

public bool IsAnimationFinished() {
    return Time.time - _actionStartTime >= toolAnimationDuration;
}
```

### æ™ºèƒ½æ–¹å‘æ£€æµ‹
```csharp
// PlayerAnimController.cs
public void ForcePlayAnimation(AnimState state, AnimDirection direction, bool shouldFlip) {
    bool directionChanged = (direction != currentDirection) || (shouldFlip != isFlipped);
    if (directionChanged) {
        PlayAnimationInternal(state, direction, shouldFlip);
    }
}
```

### å¼ºåˆ¶éšè—æœºåˆ¶
```csharp
// LayerAnimSync.cs
private bool _forceHideUntilNextAction = false;

public void ForceHideTool() {
    _forceHideUntilNextAction = true;
    toolSpriteRenderer.enabled = false;
}

public void AllowToolShow() {
    _forceHideUntilNextAction = false;
}
```

### å¸§ç´¢å¼•ç¡¬é”ï¼ˆMode A++ï¼‰
```csharp
// LayerAnimSync.cs
if (TryGetPlayerFrameIndex(out int frameIndex)) {
    int mappedToolIndex = Mathf.RoundToInt(frameIndex * (toolCount - 1f) / (playerCount - 1f));
    float toolNorm = (mappedToolIndex / (float)(toolCount - 1)) + EPSILON;
    toolAnimator.Play(targetHash, 0, toolNorm);
    toolAnimator.Update(0);
}
```

---

## 5.7 é…ç½®è¦ç‚¹

| å‚æ•° | ä½ç½® | è¯´æ˜ |
|------|------|------|
| toolAnimationDuration | PlayerAnimController | â˜… å¿…é¡»ä¸åŠ¨ç”»å‰ªè¾‘æ—¶é•¿åŒ¹é…ï¼ˆé»˜è®¤0.8ç§’ï¼‰ |
| lastFrameLockThreshold | LayerAnimSync | æœ€åä¸€å¸§é”å®šé˜ˆå€¼ï¼ˆé»˜è®¤0.85ï¼‰ |
| enableLastFrameLock | LayerAnimSync | å¯ç”¨æœ€åä¸€å¸§é”å®š |

---

## 5.8 ç»éªŒæ•™è®­

1. **ä¸è¦ä¾èµ– normalizedTime** - ç”¨ç®€å•æ—¶é—´è®¡æ—¶å™¨æ›´å¯é 
2. **æ–¹å‘ä¸å˜æ—¶ä¸é‡ç½®åŠ¨ç”»** - é¿å…æŠ½æ
3. **ä¸»åŠ¨æ§åˆ¶å·¥å…·æ˜¾éš** - é¿å…é—ªçƒ
4. **ç¼“å­˜åœ¨åŠ¨ç”»ç»“æŸæ—¶åº”ç”¨** - é¿å…å»¶è¿Ÿæ„Ÿ
5. **æ¶æ„ä»ç®€** - æ—©æœŸå¤æ‚åˆ†ç»„æ¶æ„å·²åºŸå¼ƒï¼Œç®€å•çš„ Player â†’ Tool ç»“æ„è¶³å¤Ÿ

---

## 5.9 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `Assets/Scripts/Service/Player/PlayerInteraction.cs` | åŠ¨ä½œè§¦å‘ã€å®Œæˆæ£€æµ‹ |
| `Assets/Scripts/Anim/Player/PlayerAnimController.cs` | åŠ¨ç”»æ’­æ”¾ã€æ—¶é—´è®¡æ—¶å™¨ |
| `Assets/Scripts/Anim/_...._/LayerAnimSync.cs` | å¸§åŒæ­¥ã€æ˜¾éšæ§åˆ¶ |
| `Assets/Scripts/Service/Player/ToolActionLockManager.cs` | è¾“å…¥é”å®šã€ç¼“å­˜ |
| `Assets/Scripts/Anim/Player/PlayerToolController.cs` | å·¥å…·åˆ‡æ¢ã€å‚æ•°è®¾ç½® |

---

*æ–‡æ¡£ç»“æŸ - æœ¬æ–‡æ¡£å¯æ›¿ä»£æ‰€æœ‰å†å²æ–‡æ¡£*
