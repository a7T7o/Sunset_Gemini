# é¡¹ç›®è®°å¿†ç‚¹å®Œæ•´æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-16  
**çŠ¶æ€**: å·²åˆå¹¶

---

## ç›®å½•

1. [æ ¸å¿ƒäº¤äº’åŸåˆ™](#1-æ ¸å¿ƒäº¤äº’åŸåˆ™)
2. [é®æŒ¡é€æ˜ç³»ç»Ÿ](#2-é®æŒ¡é€æ˜ç³»ç»Ÿ)
3. [é¢æ¿å¼€å…³é€»è¾‘](#3-é¢æ¿å¼€å…³é€»è¾‘)
4. [ç‰©å“è®¾è®¡äº¤æ¥](#4-ç‰©å“è®¾è®¡äº¤æ¥)
5. [Orderè®¡ç®—ä¸è‡ªåŠ¨æ ¡å‡†](#5-orderè®¡ç®—ä¸è‡ªåŠ¨æ ¡å‡†)
6. [æ··åˆå¯¼èˆªç³»ç»Ÿ](#6-æ··åˆå¯¼èˆªç³»ç»Ÿ)
7. [äº‘æœµä¸å¤©æ°”ç³»ç»Ÿ](#7-äº‘æœµä¸å¤©æ°”ç³»ç»Ÿ)
8. [æ‰‹æŒç‰©å“åŠ¨ç”»ç³»ç»Ÿ](#8-æ‰‹æŒç‰©å“åŠ¨ç”»ç³»ç»Ÿ)
9. [ç»å¯¹ç¦æ­¢äº‹é¡¹](#9-ç»å¯¹ç¦æ­¢äº‹é¡¹)

---

## 1. æ ¸å¿ƒäº¤äº’åŸåˆ™

### Tag/Layer é€‰æ‹©å™¨è§„èŒƒ

**âœ… æ­£ç¡®åšæ³•**ï¼šReorderableList + Tag Popup ä¸‹æ‹‰æ¡†ï¼ˆUnity æ ‡å‡†ï¼‰

```csharp
[CustomEditor(typeof(XXX))]
public class XXXEditor : Editor
{
    private ReorderableList tagsList;
    private string[] allTags;
    
    void OnEnable()
    {
        allTags = InternalEditorUtility.tags;
        SetupReorderableList();
    }
    
    void SetupReorderableList()
    {
        tagsList = new ReorderableList(serializedObject, tagsProperty, true, true, true, true);
        
        tagsList.drawElementCallback = (Rect rect, int index, bool isActive, bool isFocused) =>
        {
            SerializedProperty element = tagsList.serializedProperty.GetArrayElementAtIndex(index);
            int currentIndex = System.Array.IndexOf(allTags, element.stringValue);
            if (currentIndex < 0) currentIndex = 0;
            
            int newIndex = EditorGUI.Popup(rect, currentIndex, allTags);
            if (newIndex >= 0 && newIndex < allTags.Length)
            {
                element.stringValue = allTags[newIndex];
            }
        };
    }
}
```

**âŒ é”™è¯¯åšæ³•**ï¼š
- æ‰‹åŠ¨è¾“å…¥å­—ç¬¦ä¸²æ•°ç»„ï¼ˆå®¹æ˜“æ‹¼å†™é”™è¯¯ï¼‰
- ä½¿ç”¨å‹¾é€‰æ¡†åˆ—è¡¨ï¼ˆä¸ç¬¦åˆUnityæ ‡å‡†ï¼‰

---

## 2. é®æŒ¡é€æ˜ç³»ç»Ÿ

### æ ¸å¿ƒé€»è¾‘
ç©å®¶åœ¨æ ‘ä¸‹æ–¹ï¼ˆY > TreeYï¼‰+ Sprite Bounds é‡å  â†’ æ ‘é€æ˜

### æ£€æµ‹æ–¹æ¡ˆï¼šBounds.Intersects
```csharp
// OcclusionManager.DetectOcclusion()
float playerY = player.position.y;
float treeY = occluder.transform.position.y;

// 1. Yåæ ‡æ£€æµ‹ï¼ˆç©å®¶åœ¨æ ‘ä¸‹æ–¹ï¼‰
if (playerY <= treeY) continue;

// 2. è·ç¦»è¿‡æ»¤ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
if (Vector2.Distance(playerPos, treePos) > detectionRadius) continue;

// 3. Sprite Boundsé‡å æ£€æµ‹
if (treeBounds.Intersects(playerBounds))
{
    occluder.SetOccluding(true);
}
```

### åŒå±‚ç»“æ„ Order è®¡ç®—
```csharp
private float CalculateSortingY(SpriteRenderer sr)
{
    Transform parent = sr.transform.parent;
    if (parent != null && parent.GetComponent<SpriteRenderer>() == null)
    {
        // çˆ¶ç‰©ä½“æ— SR â†’ ç”¨çˆ¶ç‰©ä½“Yï¼ˆç§æ¤ç‚¹ï¼‰
        return parent.position.y + bottomOffset;
    }
    // å¸¸è§„ï¼šCollider > Sprite > Transform
}
```

### æ€§èƒ½ä¼˜åŠ¿
| é¡¹ç›® | OverlapPointï¼ˆæ—§ï¼‰ | Bounds.Intersectsï¼ˆæ–°ï¼‰ |
|------|------------------|----------------------|
| æ£€æµ‹æ–¹å¼ | ç‰©ç†å¼•æ“æŸ¥è¯¢ | 4æ¬¡æµ®ç‚¹æ¯”è¾ƒ |
| é€Ÿåº¦æå‡ | - | **20å€** |

---

## 3. é¢æ¿å¼€å…³é€»è¾‘

### å¿«æ·é”®
| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| Tab/B | åˆ‡æ¢æ˜¾ç¤º Props é¡µ |
| M | åˆ‡æ¢æ˜¾ç¤º Map é¡µ |
| L | åˆ‡æ¢æ˜¾ç¤º Relationship é¡µ |
| O | åˆ‡æ¢æ˜¾ç¤º Settings é¡µ |
| ESC | å·²æ‰“å¼€â†’Settingsé¡µï¼›æœªæ‰“å¼€â†’æ‰“å¼€Settingsé¢æ¿ |
| J | ä¿ç•™ç»™ä»»åŠ¡é¢æ¿ï¼ˆå½“å‰æ— åŠŸèƒ½ï¼‰ |
| 1-8 | å¿«æ·æ æ§½ä½é€‰æ‹© |

### åˆå§‹çŠ¶æ€
- æ¸¸æˆå¼€å§‹æ—¶ï¼šUI æ ¹ç‰©ä½“å¯ç”¨/æ¿€æ´»
- PackagePanelï¼šé»˜è®¤ä¸æ¿€æ´»ï¼Œè¿è¡Œæ—¶æŒ‰é”®æ‰æ¿€æ´»

### å±‚çº§ç»“æ„
```
UI > PackagePanel > Main > [0_Props, 1_Recipes, 2_Ex, 3_Map, 4_Relationship_NPC, 5_Settings] + Top
```

---

## 4. ç‰©å“è®¾è®¡äº¤æ¥

### æ‰¹é‡åˆ›å»ºå·¥å…·
- èœå•ï¼š`Farm â†’ Items â†’ æ‰¹é‡åˆ›å»ºç‰©å“æ•°æ® (SO)`
- æ”¯æŒå¤š Sprite é‡æ’ã€å¹¶è¡Œ ID/åç§°è¾“å…¥ã€é¦– ID è‡ªå¢

### åŠ¨ç”» ID æ˜ å°„
- `ToolData/WeaponData` æ–°å¢ï¼š
  - `useQualityIdMapping`
  - `animationDefaultId`
  - `GetAnimationKeyId()`
- `PlayerToolController` è®¾ç½® `ToolItemId` æ”¹ä¸ºä½¿ç”¨ `GetAnimationKeyId()`

---

## 5. Orderè®¡ç®—ä¸è‡ªåŠ¨æ ¡å‡†

### æ ¸å¿ƒåŸåˆ™
1. æ ‘æœ¨/æˆ¿å±‹ç­‰é™æ€ç‰©ä½“ä¸ä½¿ç”¨ `DynamicSortingOrder`
2. ä½¿ç”¨ `Tool_002_BatchHierarchy` å·¥å…·æ‰‹åŠ¨è°ƒæ•´ Order
3. è¿è¡Œå‰è‡ªåŠ¨æ ¡å‡†æ‰€æœ‰é™æ€ç‰©ä½“ Order

### ç»Ÿä¸€æ ‡å‡†
```
ä¼˜å…ˆçº§ï¼š
1. Collider2D.bounds.min.y + bottomOffset
2. Sprite.bounds.min.y + bottomOffset  
3. Transform.position.y + bottomOffset

Order = -Round(sortingY Ã— 100) + 0
```

### è‡ªåŠ¨æ ¡å‡†ç³»ç»Ÿ
- æ–‡ä»¶ï¼š`StaticObjectOrderAutoCalibrator.cs`
- è§¦å‘æ—¶æœºï¼šè¿›å…¥ Play æ¨¡å¼å‰è‡ªåŠ¨æ‰§è¡Œ
- æ‰‹åŠ¨è§¦å‘ï¼š`Tools â†’ ğŸ”§ æ ¡å‡†æ‰€æœ‰é™æ€ç‰©ä½“Order`

---

## 6. æ··åˆå¯¼èˆªç³»ç»Ÿ

### æ ¸å¿ƒç‰¹æ€§
1. **åŒæ¨¡å¼å¯¼èˆª**ï¼šGridæ¨¡å¼ + Continuousæ¨¡å¼
2. **è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢**ï¼šæ ¹æ®éšœç¢ç‰©å¯†åº¦åŠ¨æ€åˆ‡æ¢
3. **åŠ¿åœºæ³•å¯¼èˆª**ï¼šç›®æ ‡å¸å¼•åŠ› + éšœç¢ç‰©æ’æ–¥åŠ›
4. **CircleCastç²¾ç¡®ç¢°æ’æ£€æµ‹**

### é…ç½®å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| enableHybridNavigation | false | å¯ç”¨å¼€å…³ |
| complexAreaThreshold | 3 | å¤æ‚åŒºåŸŸé˜ˆå€¼ |
| continuousNavRadius | 3.0 | æ£€æµ‹åŠå¾„ |
| obstacleRepulsionStrength | 2.0 | æ’æ–¥åŠ›å¼ºåº¦ |

---

## 7. äº‘æœµä¸å¤©æ°”ç³»ç»Ÿ

### äº‘æœµé˜´å½±å®ç°ï¼ˆæ–¹æ¡ˆAï¼šç²¾çµäº‘å½±ï¼‰
- ä½¿ç”¨ Multiply æè´¨çš„äº‘å½±ç²¾çµ
- éšæœºç¼©æ”¾/ä½ç½®/é€Ÿåº¦æ¨ªå‘ç§»åŠ¨
- Sorting Layerï¼š`CloudShadow`

### CloudShadowManager å‚æ•°
- `Intensity`ï¼šäº‘å½±é€æ˜åº¦
- `Density`ï¼šäº‘å½±å¯†åº¦
- `ScaleRange`ï¼šéšæœºç¼©æ”¾èŒƒå›´
- `Speed/Direction`ï¼šç§»åŠ¨é€Ÿåº¦å’Œæ–¹å‘
- `WeatherGate`ï¼šå¤©æ°”è”åŠ¨å¼€å…³

### å¤©æ°”è”åŠ¨
- Sunnyï¼šå¼€å¯ï¼ŒIntensity=0.25~0.4
- PartlyCloudyï¼šä½å¼ºåº¦/ä½å¯†åº¦
- Overcast/Rain/Snowï¼šå…³é—­

---

## 8. æ‰‹æŒç‰©å“åŠ¨ç”»ç³»ç»Ÿ

### ä¸‰å‘åŠ¨ç”»ç”Ÿæˆå™¨
- ä¸­æ–‡ UIï¼Œæ‹–æ”¾æ–‡ä»¶å¤¹æ”¯æŒ
- å›ºå®š 8 å¸§
- å‘½åï¼š`{Action}_{Dir}_Clip_{itemId}_{quality}`

### è¾“å‡ºç»“æ„
```
Clips: Assets/Animations/Clips/{Action}/{id}_{itemName}/{Down|Side|Up}/
Controllers: Assets/Animations/Controllers/{Action}/{id}_{itemName}/
```

### æ§åˆ¶å™¨é…ç½®
- ä»…ä½¿ç”¨ Any State â†’ state è½¬æ¢
- å‚æ•°ï¼š`State`, `Direction`, `ToolItemId`, `ToolQuality`

### è¿è¡Œæ—¶
- `LayerAnimSync` ä½¿ç”¨ `ToolItemId` + å“è´¨å›é€€
- `PlayerToolController` åœ¨è£…å¤‡æ—¶è®¾ç½® `ToolItemId`

---

## 9. ç»å¯¹ç¦æ­¢äº‹é¡¹

### ç ´ååŸæœ‰åŠŸèƒ½
1. ä¿®æ”¹ bug æ—¶ï¼šå¿…é¡»ä¿è¯ä¿®æ”¹åå’ŒåŸæœ‰ä¸šåŠ¡é€»è¾‘ä¿æŒä¸€è‡´
2. ä¿®æ”¹ä¸šåŠ¡é€»è¾‘æ—¶ï¼šå¿…é¡»ç¡®ä¿å’Œç°æœ‰æ¨¡å—ã€å…¶ä»–è„šæœ¬è”åŠ¨å’Œé€‚é…
3. **ä¿®æ”¹ä»»ä½•éƒ¨åˆ†å‰**ï¼šå…ˆè®°ä½è¦åšçš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä»å…¨å±€å¤§ä½“æ¥æ€è€ƒ

### å¿½è§†é¡¹ç›®æ•´ä½“è®¾è®¡
- å¿…é¡»ç»“åˆé¡¹ç›®çš„æ•´ä½“è®¾è®¡ï¼ˆå¤šå±‚çº§+æ ‡ç­¾åˆ†ç±»ã€Sorting Layer ç­‰ï¼‰
- æµ‹è¯•ç‚¹ï¼šå¦‚æœåŸåŠŸèƒ½æ˜¯"æ»šè½®åˆ‡æ¢æ˜¾ç¤ºçº¢æ¡†"ï¼Œä¿®æ”¹åå¿…é¡»ä»ç„¶æ˜¾ç¤ºçº¢æ¡†

### é”™è¯¯çš„åæ ‡/å±‚çº§å¤„ç†
- ä¸­å¿ƒç‚¹é—®é¢˜ï¼šä½¿ç”¨ Player çš„ Collider ä¸­å¿ƒï¼Œä¸æ˜¯æ‘„åƒæœº/å±å¹•ä¸­å¿ƒ
- å›¾å±‚é—®é¢˜ï¼šæ ¹æ®ç‚¹å‡»åŒºåŸŸçš„ Sorting Layer åˆ›å»ºç‰©ä½“ï¼Œä¸æ˜¯ Default
- æ¨¡æ¿å¯¹è±¡ï¼šåˆ›å»ºåœ¨ UI ä¸­å¿ƒï¼ˆåœºæ™¯å¤–ï¼‰ï¼Œä¸æ˜¯ Systems ä¸‹

---

## å†å²æ–‡æ¡£è®°å½•

| åŸæ–‡æ¡£ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| `windsurfè®°å¿†ç‚¹.md` | å·²åˆå¹¶ | å†…å®¹å·²æ•´åˆåˆ°æœ¬æ–‡æ¡£ |
| `Windsurfè®°å¿†å¤åˆ¶.md` | å·²åˆå¹¶ | å†…å®¹å·²æ•´åˆåˆ°æœ¬æ–‡æ¡£ |

---

*æœ€åæ›´æ–°ï¼š2025-12-16*
