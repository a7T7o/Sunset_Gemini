# SO 设计概要（2026-01-07）

**版本**: v2.0  
**日期**: 2026-01-07  
**状态**: ✅ 已规划，待实施  
**作者**: Kiro AI  
**工作区**: `.kiro/specs/SO设计系统/0_字段优化重构/`

---

## 文档说明

本文档是对当前 SO 系统的全面审查和总结，基于：
- `Docx/设计/SO/SO参数设计.md` (v1.1)
- `.kiro/specs/SO设计系统/memory.md`
- 实际代码实现分析

**目的**：
1. 识别所有 SO 类型中不合理的字段配置
2. 明确哪些字段应该属于基类，哪些应该属于子类
3. 为后续优化提供清晰的指导

---

## 核心问题总结

### 🔴 问题 1：基类字段过于臃肿

`ItemData` 基类包含了两个不应该在所有物品中都存在的字段：

| 字段 | 类型 | 问题 |
|------|------|------|
| **equipmentType** | EquipmentType | 只有装备类物品需要（头盔、盔甲、裤子、鞋子、戒指） |
| **consumableType** | ConsumableType | 只有消耗品需要（食物、药水） |

**影响范围**：
- ❌ SeedData（种子）- 不需要这两个字段
- ❌ CropData（作物）- 不需要这两个字段
- ❌ MaterialData（材料）- 不需要这两个字段
- ❌ KeyLockData（钥匙/锁）- 不需要这两个字段
- ✅ ToolData（工具）- 可能需要 equipmentType（如果工具可装备）
- ✅ WeaponData（武器）- 可能需要 equipmentType（如果武器可装备）
- ✅ FoodData（食物）- 需要 consumableType
- ✅ PotionData（药水）- 需要 consumableType

**用户截图证据**：
用户提供的截图显示，在 SeedData 或其他非装备/非消耗品的 SO 中，Inspector 显示了：
- `=== 装备配置 ===` 区域（Equipment Type 下拉框）
- `=== 消耗品配置 ===` 区域（Consumable Type 下拉框）

这些字段对于种子、材料等物品完全没有意义。

---

## 所有 SO 类型字段分析

### 1. ItemData（基类）

#### ✅ 合理的基类字段

| 分类 | 字段 | 说明 |
|------|------|------|
| **基础识别** | itemID, itemName, description, category | 所有物品都需要 |
| **视觉资源** | icon, bagSprite, rotateBagIcon, worldPrefab | 所有物品都需要 |
| **经济属性** | buyPrice, sellPrice | 所有物品都需要 |
| **堆叠属性** | maxStackSize | 所有物品都需要 |
| **显示尺寸** | useCustomBagDisplaySize, bagDisplayPixelSize, bagDisplayOffset | 所有物品都需要 |
| **显示尺寸** | useCustomDisplaySize, displayPixelSize, worldDisplayOffset | 所有物品都需要 |
| **功能标记** | canBeDiscarded, isQuestItem | 所有物品都需要 |
| **放置配置** | isPlaceable, placementType, placementPrefab, buildingSize | 所有物品都需要（可选功能） |

#### ❌ 不合理的基类字段

| 字段 | 类型 | 问题 | 建议 |
|------|------|------|------|
| **equipmentType** | EquipmentType | 只有装备类物品需要 | 移除，或创建 EquipmentData 基类 |
| **consumableType** | ConsumableType | 只有消耗品需要 | 移除，或在 FoodData/PotionData 中定义 |

---

### 2. ToolData（工具）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| toolType | 工具类型（Hoe/Axe/Pickaxe 等） |
| energyCost | 使用消耗精力 |
| effectRadius | 作用范围 |
| efficiencyMultiplier | 效率加成 |
| hasDurability, maxDurability | 耐久度系统 |
| canDealDamage, damageAmount | 伤害系统 |
| animatorController, animationFrameCount, animActionType | 动画配置 |
| useSound | 音效 |

#### ⚠️ 可能需要的字段

- **equipmentType**：如果工具可以装备到装备栏（如武器槽），则需要此字段
- 当前设计中工具不装备，所以不需要

---

### 3. WeaponData（武器）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| weaponType | 武器类型（Sword/Bow/Staff） |
| attackPower, attackSpeed | 攻击属性 |
| criticalChance, criticalDamageMultiplier | 暴击系统 |
| attackRange, knockbackForce | 战斗属性 |
| energyCostPerAttack | 精力消耗 |
| hasDurability, maxDurability | 耐久度系统 |
| animatorController, animationFrameCount, animActionType | 动画配置 |
| attackSound, hitSound | 音效 |

#### ⚠️ 可能需要的字段

- **equipmentType**：如果武器可以装备到装备栏，则需要此字段
- 当前设计中武器可能需要装备，所以可能需要

---

### 4. SeedData（种子）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| growthDays, season | 生长属性 |
| harvestCropID, harvestAmountRange | 收获属性 |
| isReHarvestable, reHarvestDays, maxHarvestCount | 重复收获 |
| growthStageSprites | 生长阶段图 |
| needsTrellis, needsWatering | 种植需求 |
| plantingExp, harvestingExp | 经验值 |

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 种子不是装备
- **consumableType** - 种子不是消耗品

---

### 5. CropData（作物）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| seedID | 对应的种子ID |
| harvestExp | 收获经验值 |
| canBeCrafted, usedInRecipes | 制作用途 |

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 作物不是装备
- **consumableType** - 作物不是消耗品（虽然可以吃，但不是直接消耗品）

---

### 6. FoodData（食物）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| energyRestore, healthRestore | 恢复属性 |
| consumeTime | 食用时间 |
| buffType, buffValue, buffDuration | Buff 系统 |
| recipeID | 配方ID |

#### ✅ 需要的字段（继承自基类）

- **consumableType** - 食物是消耗品，需要此字段

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 食物不是装备

---

### 7. MaterialData（材料）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| materialSubType | 材料子类型 |
| sourceDescription | 来源描述 |
| canBeSmelt, smeltResultID, smeltTime | 熔炼系统 |
| craftingUse | 用途说明 |

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 材料不是装备
- **consumableType** - 材料不是消耗品

---

### 8. PotionData（药水）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| healthRestore, energyRestore | 恢复属性 |
| useTime | 使用时间 |
| buffType, buffValue, buffDuration | Buff 系统 |
| recipeID | 配方ID |
| useEffectPrefab, useSound | 特效和音效 |

#### ✅ 需要的字段（继承自基类）

- **consumableType** - 药水是消耗品，需要此字段

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 药水不是装备

---

### 9. KeyLockData（钥匙/锁）

#### ✅ 合理的专属字段

| 字段 | 说明 |
|------|------|
| keyLockType | 钥匙或锁 |
| material | 材质类型 |
| unlockChance | 开锁概率 |
| isSpecial, targetChestId | 特殊钥匙/锁 |

#### ❌ 不需要的字段（继承自基类）

- **equipmentType** - 钥匙/锁不是装备
- **consumableType** - 钥匙/锁不是消耗品（虽然钥匙失败时消耗，但不是通过 consumableType 系统）

---

## 优化建议

### 方案 A：移除基类中的特定字段（推荐）

**优点**：
- 清晰的职责分离
- 减少不必要的字段显示
- 更好的代码可维护性

**实施步骤**：
1. 从 `ItemData` 基类中移除 `equipmentType` 和 `consumableType`
2. 在需要的子类中添加这些字段：
   - `FoodData` 添加 `consumableType`
   - `PotionData` 添加 `consumableType`
   - 如果需要，在 `ToolData`/`WeaponData` 中添加 `equipmentType`
3. 更新所有使用这些字段的代码
4. 更新批量生成工具

**影响范围**：
- ✅ 代码修改量：中等
- ✅ 现有 SO 资产：需要重新保存（字段会自动丢失）
- ✅ UI 代码：需要更新快速装备和右键使用逻辑

---

### 方案 B：创建中间基类（备选）

**结构**：
```
ItemData（基类）
├── EquipmentData（装备基类）
│   ├── ToolData
│   ├── WeaponData
│   └── ArmorData（未来）
├── ConsumableData（消耗品基类）
│   ├── FoodData
│   └── PotionData
├── PlantData（植物基类）
│   ├── SeedData
│   └── CropData
└── MaterialData（材料）
```

**优点**：
- 更清晰的类型层级
- 便于添加新的装备/消耗品类型

**缺点**：
- 增加了类型层级复杂度
- 需要大量重构现有代码

---

### 方案 C：保持现状，添加条件显示（不推荐）

使用 `[HideInInspector]` 或自定义 Editor 隐藏不需要的字段。

**缺点**：
- 字段仍然存在，只是隐藏
- 增加了代码复杂度
- 不解决根本问题

---

## 字段使用统计

| SO 类型 | 需要 equipmentType | 需要 consumableType |
|---------|-------------------|---------------------|
| ToolData | ❓ 可能 | ❌ 否 |
| WeaponData | ❓ 可能 | ❌ 否 |
| SeedData | ❌ 否 | ❌ 否 |
| CropData | ❌ 否 | ❌ 否 |
| FoodData | ❌ 否 | ✅ 是 |
| MaterialData | ❌ 否 | ❌ 否 |
| PotionData | ❌ 否 | ✅ 是 |
| KeyLockData | ❌ 否 | ❌ 否 |

**统计结果**：
- **equipmentType**：8 个类型中，0-2 个需要（0-25%）
- **consumableType**：8 个类型中，2 个需要（25%）

**结论**：这两个字段不应该在基类中。

---

## 其他发现

### 1. bagSprite 字段已废弃

根据 memory.md（2025-12-24）：
- `bagSprite` 字段已废弃，不再使用
- 背包图标统一使用 `icon` + 45° 旋转
- 字段保留是为了兼容性，但不应该再设置

**建议**：
- 在文档中明确标注为废弃
- 批量生成工具不再设置此字段
- 考虑在未来版本中完全移除

---

### 2. 放置配置字段合理性

`isPlaceable`, `placementType`, `placementPrefab`, `buildingSize` 这些字段在基类中是合理的，因为：
- 任何物品都可能需要放置功能（树苗、工作台、箱子、装饰品等）
- 通过 `isPlaceable` 开关控制是否启用
- 不会造成 Inspector 混乱

---

### 3. 显示尺寸配置合理性

`useCustomBagDisplaySize`, `bagDisplayPixelSize`, `useCustomDisplaySize`, `displayPixelSize` 等字段在基类中是合理的，因为：
- 所有物品都需要在背包和世界中显示
- 通过开关控制是否启用自定义尺寸
- 提供了灵活的尺寸控制

---

## 推荐的优化优先级

### 高优先级（立即处理）

1. **移除基类中的 equipmentType 和 consumableType**
   - 影响：所有 SO 类型
   - 工作量：中等
   - 收益：显著提升 Inspector 清晰度

2. **在需要的子类中添加这些字段**
   - FoodData 添加 consumableType
   - PotionData 添加 consumableType
   - 根据需要在 ToolData/WeaponData 中添加 equipmentType

3. **更新批量生成工具**
   - 移除对这两个字段的设置
   - 在对应的子类生成方法中添加

### 中优先级（后续处理）

1. **标注 bagSprite 为废弃**
   - 在代码注释中添加 `[Obsolete]` 标记
   - 在文档中明确说明

2. **创建 SO 字段清理工具**
   - 批量清除所有 SO 中的 bagSprite
   - 批量清除不需要的 equipmentType/consumableType

### 低优先级（可选）

1. **考虑创建中间基类**
   - 如果未来有更多装备/消耗品类型
   - 需要更清晰的类型层级

---

## 相关文件

### 核心数据类
| 文件 | 说明 |
|------|------|
| `Assets/YYY_Scripts/Data/Items/ItemData.cs` | 基类（需要修改） |
| `Assets/YYY_Scripts/Data/Items/FoodData.cs` | 需要添加 consumableType |
| `Assets/YYY_Scripts/Data/Items/PotionData.cs` | 需要添加 consumableType |

### 编辑器工具
| 文件 | 说明 |
|------|------|
| `Assets/Editor/Tool_BatchItemSOGenerator.cs` | 需要更新 |
| `Assets/Editor/Tool_BatchItemSOModifier.cs` | 需要更新 |

### 文档
| 文件 | 说明 |
|------|------|
| `Docx/设计/SO/SO参数设计.md` | 需要更新到 v2.0 |
| `.kiro/steering/so-design.md` | 需要更新 |

---

## 后续行动

1. **用户确认优化方案**
2. **执行代码重构**
3. **更新所有相关文档**
4. **测试现有功能**
5. **更新批量生成工具**

---

*文档结束*
