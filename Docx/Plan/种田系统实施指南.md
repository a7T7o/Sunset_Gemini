# 种田系统实施指南

**文档版本**: v1.0  
**创建时间**: 2024年12月1日  
**适用对象**: 开发者  
**预计完成时间**: 2-3天

---

## 📋 概述

本指南将指导你一步步实现完整的种田系统，从场景设置到功能测试。

---

## 🎯 第一步：场景设置（30分钟）

### 1.1 创建Tilemap层级

1. **在你的主场景中找到Grid对象**（如果没有，创建一个）
   ```
   Hierarchy右键 → 2D Object → Tilemap → Rectangular
   ```

2. **设置Tilemap层级结构**：
   ```
   Grid
   ├── Ground_Base (已有)
   ├── Ground_Detail (已有)
   ├── Farmland ← 新建这个
   └── Objects (可选，用于组织作物)
   ```

3. **配置Farmland Tilemap**：
   - `Tilemap Renderer`:
     - Sorting Layer: 选择合适的层（如Default）
     - Order in Layer: 2（在地面之上，在角色之下）
   - `Tilemap Collider 2D`: 可选，用于检测点击

### 1.2 创建管理器对象

1. **在Hierarchy中创建空对象**：
   ```
   右键 → Create Empty → 命名为"FarmingSystem"
   ```

2. **添加组件**：
   - `FarmingManager`
   - `CropGrowthSystem`
   - `WaterEvaporationSystem`

3. **在FarmingManager的Inspector中设置引用**：
   - `Farmland Tilemap`: 拖入你创建的Farmland Tilemap
   - `Ground Tilemap`: 拖入Ground_Base（用于检测可耕作区域）
   - 其他字段稍后设置

---

## 🎨 第二步：准备农田Tile（1小时）

### 方案A：使用Tilemap转Sprite工具（推荐）

#### 1. 在临时Scene中画Tilemap

1. 创建新Scene（`Temp_FarmTiles`）
2. 创建Grid和Tilemap
3. 使用你的农田素材画出：
   - 干燥的耕地样式（棕色土地）
   - 湿润的耕地样式（深色土地）

#### 2. 使用工具导出Sprite

1. 选中你画好的Tilemap
2. 打开工具：`Tools → Tilemap转Sprite工具`
3. 点击"获取选中的Tilemap"
4. 设置参数：
   - 文件名: `Farmland_Dry`
   - Pixels Per Unit: 16（根据你的项目设置）
   - 紧凑模式: ✅ 勾选
5. 点击"生成Sprite"
6. 重复步骤画湿润土地，导出为`Farmland_Wet`

#### 3. 创建Tile资产

1. 打开：`Farm → 创建农田Tile工具`
2. 拖入你导出的两个Sprite
3. 设置保存路径：`Assets/Tiles/Farm`
4. 点击"创建Tile资产"

✅ 完成！现在你有了：
- `Assets/Tiles/Farm/Farmland_Dry.asset`
- `Assets/Tiles/Farm/Farmland_Wet.asset`

### 方案B：使用纯色测试Tile（快速测试）

1. 打开：`Farm → 创建农田Tile工具`
2. 点击"创建纯色测试Tile"
3. 完成！会自动创建棕色和深棕色的测试Tile

**⚠️ 注意**：纯色Tile仅用于测试，后续应替换为美术资源。

---

## 🌱 第三步：准备作物Sprite（2小时）

### 3.1 作物Sprite需求

每种作物需要**4-5个生长阶段的Sprite**：

```
番茄为例：
Stage0: Tomato_Stage0.png (种子/小苗)
Stage1: Tomato_Stage1.png (小植株)
Stage2: Tomato_Stage2.png (生长中)
Stage3: Tomato_Stage3.png (即将成熟)
Stage4: Tomato_Stage4.png (成熟，有红色番茄)
```

### 3.2 准备Sprite（两种方案）

#### 方案1：使用现有素材

1. 找到你的作物素材（可能在`ZZZ_00_Package`或`Prefabs/Farm`中）
2. 使用Sprite Editor切片
3. 按照命名规范重命名
4. 放入`Assets/Sprites/Crops/`文件夹

#### 方案2：临时占位（推荐快速开始）

1. 创建5个不同颜色的方块作为占位Sprite：
   - 灰色（种子）
   - 浅绿色（幼苗）
   - 绿色（生长中）
   - 黄绿色（即将成熟）
   - 红色/黄色（成熟）

2. 使用Unity的Default Sprite或简单画布绘制

---

## 📦 第四步：创建作物数据（30分钟）

### 4.1 创建SeedData

1. 在Project窗口：`Assets/Data/Items/Seeds/`
2. 右键 → `Create → Farm/Items/Seed`
3. 命名：`Seed_Tomato`
4. 配置参数：
   ```
   基础属性：
   - Item ID: 1001
   - Item Name: 番茄种子
   - Icon: (选择一个种子图标)
   - Description: 夏季作物，可重复收获
   - Max Stack: 99
   - Sell Price: 50
   - Buy Price: 25
   
   种植属性：
   - Growth Days: 9
   - Season: Summer
   - Harvest Crop ID: 1101
   - Harvest Amount Range: (1, 3)
   - Is ReHarvestable: ✅
   - Re Harvest Days: 3
   - Max Harvest Count: 0 (无限次)
   
   生长阶段：
   - Growth Stage Sprites: 拖入5个阶段的Sprite
   
   需求：
   - Needs Watering: ✅
   - Planting Exp: 5
   - Harvesting Exp: 10
   ```

### 4.2 创建CropData

1. 右键 → `Create → Farm/Items/Crop`
2. 命名：`Crop_Tomato`
3. 配置参数：
   ```
   - Item ID: 1101
   - Item Name: 番茄
   - Icon: (选择番茄图标，即Stage4的Sprite)
   - Description: 新鲜多汁的番茄
   - Sell Price: 80
   - Seed ID: 1001
   - Harvest Exp: 15
   ```

### 4.3 重复创建更多作物

建议创建3-5种测试作物：
- 萝卜（春季，4天，不可重复）
- 番茄（夏季，9天，可重复）
- 小麦（春/秋季，7天，不可重复）
- 南瓜（秋季，12天，不可重复）
- 草莓（春季，8天，可重复）

---

## 🎮 第五步：创建作物预制体（15分钟）

### 5.1 创建基础预制体

1. Hierarchy右键 → `Create Empty` → 命名"Crop"
2. 添加组件：
   - `Sprite Renderer`
     - Sorting Layer: 选择合适的层
     - Order in Layer: 3（在农田之上）
   - `Box Collider 2D`
     - Is Trigger: ✅
   - `CropController`（你创建的脚本）
3. 拖到Project窗口创建预制体：`Assets/Prefabs/Farm/Crop.prefab`
4. 删除Hierarchy中的临时对象

### 5.2 分配预制体到Manager

1. 选中`FarmingSystem`对象
2. 在`FarmingManager`组件中：
   - `Crop Prefab`: 拖入你创建的Crop.prefab
   - `Crops Container`: 可留空（会自动创建）

---

## 🔧 第六步：分配Tile到Manager（5分钟）

1. 选中`FarmingSystem`对象
2. 在`FarmingManager`组件中：
   - `Dry Farmland Tile`: 拖入`Farmland_Dry.asset`
   - `Wet Farmland Tile`: 拖入`Farmland_Wet.asset`

---

## 🎵 第七步：音效和粒子（可选，30分钟）

### 7.1 音效

找到或创建以下音效：
- `Tilling_Sound.wav` - 锄地声
- `Watering_Sound.wav` - 浇水声
- `Harvest_Sound.wav` - 收获声

放入`Assets/Audio/SFX/Farming/`

分配到FarmingManager：
- `Tilling Sound Clip`
- `Watering Sound Clip`
- `Harvest Sound Clip`

### 7.2 粒子效果（可选）

1. 创建泥土飞溅粒子：
   - Hierarchy右键 → `Effects → Particle System`
   - 配置为棕色小粒子，向上飞溅
   - 创建预制体：`TillingParticles.prefab`

2. 创建水流粒子：
   - 配置为蓝色水滴粒子
   - 创建预制体：`WateringParticles.prefab`

3. 分配到FarmingManager

---

## ⚙️ 第八步：工具集成（1小时）

### 方案A：简单测试（直接调用Manager）

创建测试脚本`FarmingTestInput.cs`：

```csharp
using UnityEngine;
using FarmGame.Farm;
using FarmGame.Data;

public class FarmingTestInput : MonoBehaviour
{
    public SeedData testSeed; // 在Inspector中分配
    
    void Update()
    {
        Vector3 mousePos = Camera.main.ScreenToWorldPoint(Input.mousePosition);
        
        // T键 - 锄地
        if (Input.GetKeyDown(KeyCode.T))
        {
            FarmingManager.Instance?.TillSoil(mousePos);
        }
        
        // Y键 - 种植
        if (Input.GetKeyDown(KeyCode.Y) && testSeed != null)
        {
            FarmingManager.Instance?.PlantSeed(mousePos, testSeed);
        }
        
        // U键 - 浇水
        if (Input.GetKeyDown(KeyCode.U))
        {
            FarmingManager.Instance?.WaterTile(mousePos);
        }
        
        // I键 - 收获
        if (Input.GetKeyDown(KeyCode.I))
        {
            FarmingManager.Instance?.HarvestCrop(mousePos, out var crop, out int amount);
            if (crop != null)
            {
                Debug.Log($"收获: {crop.itemName} x{amount}");
            }
        }
    }
}
```

1. 将此脚本附加到任意GameObject
2. 在Inspector中分配`testSeed`
3. 运行游戏测试！

### 方案B：集成到现有工具系统（完整版）

等你的工具系统（Hoe、WateringCan）准备好后：
1. 在`PlayerToolController`的工具使用回调中调用FarmingManager
2. 参考设计文档中的"工具集成"部分

---

## 🧪 第九步：测试系统（30分钟）

### 9.1 使用编辑器调试工具

1. 打开：`Farm → 农田系统调试工具`
2. 点击"创建FarmingManager"（如果还没创建）
3. 运行游戏，使用测试脚本：
   - 按T键锄地
   - 按Y键种植
   - 按U键浇水
4. 在调试工具中查看统计信息

### 9.2 测试生长系统

1. 在Hierarchy中找到`TimeManager`
2. 加速时间或手动推进日期
3. 观察作物生长变化
4. 或在调试工具中点击"手动触发每日生长"

### 9.3 测试完整流程

```
完整测试流程：
1. 锄地（T键）
2. 种植（Y键）
3. 浇水（U键）
4. 推进时间（等待几天或手动触发）
5. 观察作物生长到不同阶段
6. 测试不浇水：作物停滞→枯萎
7. 收获成熟作物（I键）
8. 可重复收获作物：检查是否重生
```

---

## 🎉 第十步：完善与优化

### 10.1 UI集成

- 显示土地状态（鼠标悬停）
- 显示作物信息（生长进度、浇水状态）
- 种子Tooltip显示季节和天数

### 10.2 与背包系统集成

在FarmingManager中启用被注释的代码：
```csharp
// 种植时
InventoryService.Instance.RemoveItem(seedData.itemID, 1);

// 收获时
InventoryService.Instance.AddItem(harvestedCrop.itemID, harvestAmount);
```

### 10.3 与精力系统集成

启用精力消耗检查：
```csharp
if (!StaminaSystem.Instance.ConsumeStamina(tillingStaminaCost))
{
    // 精力不足提示
    return false;
}
```

### 10.4 创建更多作物

- 春季作物3种
- 夏季作物3种
- 秋季作物3种
- 全季节作物1-2种

---

## 🛠️ 快速参考

### 常用编辑器工具

```
Farm菜单：
├── 创建农田Tile工具       - 创建Tile资产
├── 农田系统调试工具        - 调试和测试
└── Items/Seed             - 创建种子数据
    └── Items/Crop         - 创建作物数据
```

### 快捷键（测试脚本）

```
T - 锄地
Y - 种植
U - 浇水
I - 收获
```

### 文件结构

```
Assets/
├── Scripts/
│   └── Farm/
│       ├── FarmingManager.cs           - 核心管理器
│       ├── CropGrowthSystem.cs         - 生长系统
│       ├── WaterEvaporationSystem.cs   - 蒸发系统
│       ├── FarmTileData.cs            - 数据结构
│       ├── CropInstance.cs            - 数据结构
│       └── CropController.cs          - 作物控制器
├── Editor/
│   ├── FarmingSystemEditor.cs         - 调试工具
│   └── FarmlandTileCreator.cs         - Tile创建工具
├── Data/
│   └── Items/
│       ├── Seeds/                     - 种子数据
│       └── Crops/                     - 作物数据
├── Prefabs/
│   └── Farm/
│       └── Crop.prefab                - 作物预制体
├── Tiles/
│   └── Farm/
│       ├── Farmland_Dry.asset         - 干燥Tile
│       └── Farmland_Wet.asset         - 湿润Tile
└── Sprites/
    └── Crops/                         - 作物Sprite
```

---

## ❓ 常见问题

### Q1: 点击锄地/种植没反应？

**检查清单**：
1. FarmingManager的所有引用是否已分配？
2. Tilemap是否正确设置？
3. 测试脚本是否附加到GameObject上？
4. Console有没有错误信息？

### Q2: 作物不生长？

**检查清单**：
1. TimeManager是否存在并运行？
2. CropGrowthSystem是否已添加？
3. 是否订阅了OnDayChanged事件？（检查Console日志）
4. 作物的growthDays是否 > 0？
5. 作物是否有浇水？

### Q3: 浇水后土地不变色？

**检查清单**：
1. Wet Farmland Tile是否已分配？
2. Tile的Sprite是否正确？
3. FarmlandTilemap是否是正确的对象？

### Q4: 作物Sprite不显示？

**检查清单**：
1. SeedData的growthStageSprites数组是否已填充？
2. Crop预制体的SpriteRenderer是否存在？
3. Sorting Layer和Order是否正确？

---

## 📚 下一步

完成基础系统后，可以继续添加：
1. **肥料系统** - 加速生长
2. **季节限制** - 非当前季节无法种植
3. **品质系统** - 根据护理情况判定品质
4. **自动洒水器** - 自动浇水建筑
5. **温室** - 无视季节限制

---

## 🎊 完成！

恭喜你完成了种田系统的实施！现在你可以：
- ✅ 锄地、种植、浇水、收获
- ✅ 作物自动生长
- ✅ 水分蒸发系统
- ✅ 可重复收获作物
- ✅ 完整的调试工具

接下来可以开始制作锄头和浇水壶的动画，并集成到你的工具系统中！

---

**文档完成时间**: 2024年12月1日  
**如有问题请参考**: `Docx/Plan/种田系统完整设计方案.md`
