# 世界物体设计

版本: v1.0
日期: 2025-11-25
作者: Cascade

---

## 1. 设计目标

- 将现有 ScriptableObject 物品数据（ItemData/ToolData/WeaponData 等）与场景世界中的实体/掉落/资源点建立稳定的运行时映射。
- 与背包/ToolBar/UI、玩家动作/动画、保存/加载深度联动。
- 统一交互协议，支撑后续“右键自动导航”“空格最近动作”等高阶交互。

---

## 2. 分层与契约

- **数据层（SO）**
  - `ItemData`（icon、stack、sellPrice、worldPrefab）
  - `ToolData`（toolType、energyCost、GetAnimationKeyId）
  - `WeaponData`（略）
- **实体层（World）**
  - `WorldItemPickup`：场景掉落/拾取物（来自 `ItemData.worldPrefab` 或运行时生成）。
  - `ResourceNode`：树/矿石等可采集物，掉落 `DropTable`。
  - `InteractableXxx`：其他可交互体（箱子、作物地块、传送点等）。
- **服务层（Runtime Services）**
  - `InventoryService`、`EquipmentService`、`HotbarSelectionService`（已实现）。
  - `DropService`（掉落生成与对象池）、`WorldSpawnService`（关卡初始生成/刷新规则）。
  - `SaveService`（保存场景实体状态、背包、装备、时间）。
- **表现层（UI/Anim）**
  - `ToolbarUI/InventoryPanelUI`（已接入事件刷新）。
  - `PlayerToolController + LayerAnimSync`（A++ 同步与品质回退）。

---

## 3. 世界物体类型（统一接口）

- **IInteractable**（所有交互体通用）
  - `bool CanInteract(PlayerContext ctx)`
  - `float GetStopRadius()`（自动导航停靠半径）
  - `void Interact(PlayerContext ctx)`（玩家触发时执行）
  - `Vector3 GetInteractPoint()`（可选：用于对准/站位）
- **IPickup**（拾取物）
  - `ItemStack GetStack()` / `void SetStack(ItemStack)`
  - `void OnPicked(PlayerContext ctx)`（播放特效、回收到对象池）
- **IResourceNode**（资源点）
  - `bool CanHit(ToolType type)`
  - `void Hit(PlayerContext ctx, ToolType type, int power)`
  - `bool IsDepleted()`
  - `IEnumerable<ItemStack> GetDrops()`

说明：`PlayerContext` 持有 `InventoryService/EquipmentService/PlayerToolController/StatsService/Transform` 等引用，避免各组件相互找对象。

---

## 4. Prefab 与碰撞体规范

- 所有世界可交互体挂 `Collider2D`（勾选 IsTrigger 用于 OverlapPoint 命中）。
- 图层：统一放入 `Interactable` 层（供右键自动导航与选择）。
- 节点结构建议：
  - `Root`
    - `Sprite`
    - `Trigger (Collider2D)`
    - `Shadow/FX`（可选）
    - 脚本：`WorldItemPickup` 或 `ResourceNode_Xxx`

---

## 5. WorldItemPickup（拾取物）

- 字段：`itemId, quality, amount`（与 `ItemStack` 对齐）。
- 生成：
  - 关卡预置：直接在场景放置并配置堆叠。
  - 运行时掉落：由 `DropService.Spawn(worldPos, ItemStack)`，优先复用对象池。
  - 来自 SO：若 `ItemData.worldPrefab` 指向该拾取物预制体，可用通用工厂：`WorldSpawnService.SpawnFromItemData(itemData, pos, stack)`。
- 交互：
  - 与玩家碰撞/点击均可触发 `TryPickup()`：
    - `int rem = InventoryService.AddItem(itemId, quality, amount)`
    - 若 `rem==0` 收回对象（回池/销毁），并触发拾取特效。
- UI 联动：
  - `OnSlotChanged` → 背包刷新；0..11 槽同步 ToolBar（已实现）。

---

## 6. ResourceNode（资源点）

- 字段：生命/阶段、可用工具类型、`DropTable`（ItemId/Quality/数量分布）。
- 命中流程：
  1) 玩家左键 → `GameInputManager` 根据 Hotbar 选中装备工具 → `PlayerInteraction.RequestAction(AnimState)`
  2) 动画事件或命中检测触发 `node.Hit(ctx, toolType, power)`
  3) 生命归零 → `DropService.Spawn` 多个 `WorldItemPickup` 堆叠或散落。
- 保存：
  - 每个节点有 `UniqueId`（基于场景名+路径或手动配置）。
  - 保存 `hp/stage/respawnTimer`，加载时恢复或根据刷新规则重新产出。

---

## 7. 保存/加载（最小方案）

- SaveData：
  - `inventory`（36格），`hotbarSelected`（索引），`equips(6)`
  - `time`（年/季/日/时/分），`gold`，`stats`（hp/stamina）
  - `worldPickups`: `[ {scene,itemId,quality,amount,position} ... ]`
  - `resourceNodes`: `[ {scene,uniqueId,hp,stage,respawn} ... ]`
- 加载：
  - 先恢复 `Time/Currency/Stats` → `Inventory/Equipment/Hotbar` → 生成世界拾取物与资源点状态。
- 清理：
  - 切换场景时回收对象池；按需复原节点。

---

## 8. 与 UI/ToolBar/动画联动

- 拾取/消耗 → `InventoryService` 发出事件，UI 局部刷新。
- 选中 ToolBar 槽位 → `GameInputManager` 左键触发：
  - `PlayerToolController.Equip*` 写 `ToolItemId/ToolQuality`（使用 `GetAnimationKeyId()`）
  - `PlayerInteraction.RequestAction(...)` 播放对应动作（Slice/Crush/Watering/Fish/Pierce）。
- 右键导航 → `PlayerAutoNavigator` 目标为 `IInteractable` 时停于 `GetStopRadius()` 附近，后续空格自动动作将以此为基础扩展。

---

## 9. Stats/消耗/使用规则（摘要）

- 工具使用消耗：由 `ToolData.energyCost` 扣减 `StatsService.Stamina`（低于阈值时禁止触发或播放疲劳反馈）。
- 食物/药水：`ConsumableData` 使用时通过 `StatsService` 增减 hp/stamina/buff，然后从 `InventoryService` 扣减堆叠。
- 金币变化：`CurrencyService.GoldChanged` → HUD 刷新。

---

## 10. 运行时事件（建议）

- `InventoryService.OnSlotChanged(int idx)`（已）
- `HotbarSelectionService.OnSelectedChanged(int idx)`（已）
- `EquipmentService.OnEquipSlotChanged(int idx)`（已）
- `WorldEvents.OnPickup(ItemStack, Vector3)`
- `WorldEvents.OnResourceDepleted(UniqueId)`

---

## 11. 目录与命名

- `Assets/Prefabs/World/Pickups/`（世界掉落实例）
- `Assets/Prefabs/World/Resources/`（树、矿点等）
- `Assets/Scripts/World/`（IInteractable/IPickup/IResourceNode、实现类）
- 图层：`Interactable`，用于 `GameInputManager.interactableMask`

---

## 12. 实现里程碑

1) 拾取物：`WorldItemPickup` + DropService + 对象池
2) 资源点：`ResourceNode_Tree`（命中→掉落木材）
3) 保存：拾取物与资源点最小状态
4) 交互统一：`IInteractable` 与右键导航停靠半径
5) 扩展：箱子/商店/种植地块

---

## 13. 验收清单

- 场景内放置的拾取物点击/碰撞可进入背包，上排同步 ToolBar。
- 斧头/镐子左键能对树/矿点生效，击破后掉落生成拾取物；动画与工具帧同步正确。
- 右键地面移动/右键对象跟随停靠；WASD 打断导航立即生效。
- 存档后重进：拾取物/资源点状态、背包/装备/ToolBar 选中恢复。

以上方案与当前项目结构兼容，后续“空格最近动作”将在此基础上利用 IInteractable 与 HotbarSelection 自动选择工具并触发动作。
