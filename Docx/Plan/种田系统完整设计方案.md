# Sunset 种田系统完整设计方案

**文档版本**: v1.0  
**创建时间**: 2024年12月1日  
**设计目标**: 实现星露谷物语风格的完整种田循环

---

## 📋 目录

1. [系统概述](#系统概述)
2. [技术架构](#技术架构)
3. [核心系统设计](#核心系统设计)
4. [资源准备方案](#资源准备方案)
5. [实现步骤](#实现步骤)
6. [与现有系统集成](#与现有系统集成)

---

## 🎯 系统概述

### 核心玩法循环
```
锄地（Hoe）→ 种植（Plant）→ 浇水（Water）→ 等待生长（Growth）→ 收获（Harvest）
                ↑______________________________________________|（可重复收获作物）
```

### 关键特性
- ✅ 基于Tilemap的动态土地状态管理
- ✅ 多生长阶段的作物系统
- ✅ 浇水与湿度管理
- ✅ 季节限制与天气影响
- ✅ 作物品质系统
- ✅ 可重复收获作物支持

---

## 🏗️ 技术架构

### 1. Tilemap层级设计

```
场景层级结构：
Grid (父对象)
├── Ground_Base (地面基础层, Order in Layer: 0)
├── Ground_Detail (地面装饰层, Order in Layer: 1)
├── Farmland (耕地层, Order in Layer: 2) ← 核心农田层
│   └── Tilemap组件
│       └── Tilemap Collider 2D (可选，用于检测)
└── Objects (放置作物GameObject的层, Order in Layer: 3)
```

### 2. Tile状态系统

**方案选择**：使用**Rule Tile**或**自定义Tile**

#### 方案A：Rule Tile（推荐）
- **优点**：自动处理边缘过渡，美观
- **适用**：有完整的tile set（包含边角、边缘等）

#### 方案B：简单Tile切换（适合当前）
- **优点**：简单直接，适合初期开发
- **所需Tile**：
  - `Farmland_Dry.png` - 已耕作（干燥）
  - `Farmland_Wet.png` - 已耕作（湿润）

### 3. 数据结构设计

#### FarmTileData（单个耕地格子的数据）
```csharp
public class FarmTileData
{
    public Vector3Int position;           // 格子坐标
    public bool isTilled;                 // 是否已耕作
    public bool isWatered;                // 是否已浇水
    public float lastWateredTime;         // 上次浇水时间（游戏时间）
    public CropInstance crop;             // 当前种植的作物实例
}
```

#### CropInstance（作物实例）
```csharp
public class CropInstance
{
    public SeedData seedData;             // 种子数据
    public GameObject cropObject;         // 场景中的作物GameObject
    public int currentStage;              // 当前生长阶段（0-N）
    public float plantedTime;             // 种植时间
    public float nextGrowthTime;          // 下次生长时间
    public int harvestCount;              // 已收获次数（可重复收获用）
    public Quality quality;               // 作物品质
}
```

---

## 🛠️ 核心系统设计

### 1. FarmingManager（农田管理器）

**职责**：
- 管理所有耕地数据（Dictionary<Vector3Int, FarmTileData>）
- 处理锄地、种植、浇水、收获请求
- 定期检查土地湿度并更新Tile
- 保存/加载农田状态

**核心方法**：
```csharp
// 锄地
public bool TillSoil(Vector3Int position)
// 检查是否可种植
public bool CanPlant(Vector3Int position)
// 种植种子
public bool PlantSeed(Vector3Int position, SeedData seed)
// 浇水
public bool WaterTile(Vector3Int position)
// 收获作物
public CropData HarvestCrop(Vector3Int position)
// 清除枯萎作物
public void ClearCrop(Vector3Int position)
```

### 2. CropGrowthSystem（作物生长系统）

**职责**：
- 监听时间系统的OnDayChanged事件
- 更新所有作物的生长进度
- 处理生长阶段切换
- 检测枯萎条件（未浇水）

**生长逻辑**：
```
每天检查：
  如果已浇水：
    - 生长进度 +1
    - 检查是否进入下一阶段
    - 更新作物外观
  如果未浇水：
    - 连续未浇水天数 +1
    - 达到2天：生长停滞（不增长）
    - 达到3天：作物枯萎（变黄，不可收获）
```

### 3. WaterEvaporationSystem（水分蒸发系统）

**职责**：
- 监听时间系统的OnDayChanged事件
- 每天检查所有已浇水的土地
- 24小时后土地变干（切换Tile）

**逻辑**：
```csharp
void OnDayChanged()
{
    foreach (var tile in wateredTiles)
    {
        if (已超过24小时)
        {
            tile.isWatered = false;
            farmlandTilemap.SetTile(tile.position, dryTile);
        }
    }
}
```

### 4. 工具集成

#### 锄头（Hoe）
- **动画**：`Hoe_Down/Side/Up_Clip` (复用Slice动画骨架)
- **精力消耗**：3点
- **音效**：锄地声 + 泥土飞溅粒子
- **逻辑**：检测面前格子 → 切换Tile → 记录数据

#### 浇水壶（WateringCan）
- **动画**：`WateringCan_Down/Side/Up_Clip`
- **精力消耗**：2点
- **音效**：水流声 + 水滴粒子效果
- **逻辑**：检测面前格子 → 切换Tile → 更新浇水时间

---

## 🎨 资源准备方案

### 方案1：使用Tilemap→Sprite工具（当前推荐）

#### 步骤：
1. **在Unity中创建临时Tilemap**：
   - 画出耕地的各种状态（干燥、湿润）
   - 使用现有的农田素材

2. **使用TilemapToSprite工具导出**：
   - 导出单个tile的sprite（16x16或32x32）
   - 命名：`Farmland_Dry.png`, `Farmland_Wet.png`

3. **创建Tile资产**：
   - 在`Assets/Tiles/Farm/`创建Tile资产
   - 分配对应的Sprite

#### 所需Sprite清单：
```
必需（最小集）：
- Farmland_Dry.png         (已耕作-干燥)
- Farmland_Wet.png         (已耕作-湿润)

可选（美化）：
- Farmland_Planted_Dry.png (有作物-干燥)
- Farmland_Planted_Wet.png (有作物-湿润)
```

### 方案2：直接使用现有素材

如果你的`ZZZ_00_Package`中有农田素材，可以：
1. 找到对应的sprite sheet
2. 使用Sprite Editor切片
3. 创建Tile资产

### 作物Sprite准备

#### 作物生长阶段设计（以番茄为例）：
```
阶段0: Seed        (种子)        - 1天
阶段1: Sprout      (幼苗)        - 2天
阶段2: Small       (小植株)      - 3天
阶段3: Growing     (生长中)      - 3天
阶段4: Mature      (成熟)        - 可收获
```

#### Sprite命名规范：
```
Crops/Tomato_Stage0.png  (种子/幼苗)
Crops/Tomato_Stage1.png  (小植株)
Crops/Tomato_Stage2.png  (生长中)
Crops/Tomato_Stage3.png  (即将成熟)
Crops/Tomato_Stage4.png  (成熟-可收获，带红色番茄)
```

---

## 📝 实现步骤

### 阶段1：基础框架（第1天）

**任务**：
1. ✅ 创建FarmingManager.cs
2. ✅ 创建CropGrowthSystem.cs
3. ✅ 创建WaterEvaporationSystem.cs
4. ✅ 设置Farmland Tilemap层
5. ✅ 准备2个基础Tile（干燥、湿润）

**测试目标**：
- 可以切换土地状态（通过代码）
- Tilemap正确显示

### 阶段2：锄地系统（第1天下午）

**任务**：
1. ✅ 创建锄头动画（复用Slice动画，3方向）
2. ✅ 实现HoeTool.cs（继承BaseTool或作为PlayerToolController的功能）
3. ✅ 实现FarmingManager.TillSoil()
4. ✅ 添加锄地音效和粒子效果

**测试目标**：
- 按E键使用锄头
- 土地从普通变为耕作状态
- 有音效和粒子反馈

### 阶段3：种植系统（第2天）

**任务**：
1. ✅ 创建Crop.prefab基础模板
   - SpriteRenderer
   - CropController.cs脚本
   - Collider2D（用于鼠标检测）
2. ✅ 实现FarmingManager.PlantSeed()
3. ✅ 实现CropController.cs（管理单个作物实例）
4. ✅ 创建3-5种测试作物的SeedData

**测试目标**：
- 在耕地上使用种子，生成作物GameObject
- 作物显示初始阶段的Sprite
- 背包中种子数量减少

### 阶段4：浇水系统（第2天下午）

**任务**：
1. ✅ 创建浇水壶动画
2. ✅ 实现WateringCanTool.cs
3. ✅ 实现FarmingManager.WaterTile()
4. ✅ 添加水流粒子效果
5. ✅ 实现WaterEvaporationSystem

**测试目标**：
- 浇水后土地变湿润（Tile切换）
- 24小时后土地变干

### 阶段5：生长系统（第3天）

**任务**：
1. ✅ 实现CropGrowthSystem
2. ✅ 连接TimeManager的OnDayChanged事件
3. ✅ 实现生长逻辑（浇水检查、阶段更新）
4. ✅ 实现枯萎系统
5. ✅ 创建完整的作物Sprite（4-5个阶段）

**测试目标**：
- 作物每天自动生长
- 未浇水会枯萎
- 外观正确切换

### 阶段6：收获系统（第3天下午）

**任务**：
1. ✅ 实现FarmingManager.HarvestCrop()
2. ✅ 实现可重复收获逻辑
3. ✅ 添加收获动画和音效
4. ✅ 生成掉落物品（使用现有的DroppedItem系统）
5. ✅ 实现作物品质判定

**测试目标**：
- 成熟作物可交互收获
- 获得正确的作物物品
- 可重复收获作物正确重生

### 阶段7：完善与优化（第4天）

**任务**：
1. ✅ 季节限制检查
2. ✅ UI提示（种子信息、土地状态）
3. ✅ 保存/加载系统集成
4. ✅ 性能优化（对象池、批处理）
5. ✅ 创建10种作物数据

**测试目标**：
- 完整流程无Bug
- 季节限制生效
- 保存后重新加载数据正确

---

## 🔗 与现有系统集成

### 1. 时间系统集成

```csharp
// CropGrowthSystem.cs
void Start()
{
    // 订阅时间系统事件
    TimeManager.OnDayChanged += OnDayChanged;
}

void OnDayChanged(int day, Season season)
{
    UpdateAllCrops();
}
```

### 2. 背包系统集成

```csharp
// 种植时
if (InventoryService.RemoveItem(seedData.itemID, 1))
{
    PlantSeed(position, seedData);
}

// 收获时
CropData crop = HarvestCrop(position);
InventoryService.AddItem(crop.itemID, harvestAmount);
```

### 3. 工具系统集成

```csharp
// PlayerToolController.cs
public void OnToolUse()
{
    ToolData currentTool = GetCurrentTool();
    
    if (currentTool.toolType == ToolType.Hoe)
    {
        FarmingManager.Instance.TillSoil(GetTargetPosition());
    }
    else if (currentTool.toolType == ToolType.WateringCan)
    {
        FarmingManager.Instance.WaterTile(GetTargetPosition());
    }
}
```

### 4. 精力系统集成

```csharp
// FarmingManager.cs
public bool TillSoil(Vector3Int position)
{
    if (!StaminaSystem.Instance.ConsumeStamina(3f))
    {
        // 精力不足提示
        return false;
    }
    
    // 执行锄地逻辑...
}
```

### 5. 动画同步集成

**锄头和浇水壶动画**使用现有的LayerAnimSync系统：
- 创建工具动画时遵循命名规范：`Hoe_{Direction}_Clip_{id}_{quality}`
- 在PlayerToolController中设置正确的ToolItemId
- 自动同步到手持层

---

## 📊 数据配置示例

### SeedData配置（番茄种子）

```
Item ID: 1001
Item Name: 番茄种子
Icon: Tomato_Seed_Icon.png
Description: 夏季作物，可重复收获
Price: 50金币

生长天数: 9天
适合季节: Summer
收获作物ID: 1101
收获数量: 1-3个
可重复收获: true
重复收获间隔: 3天

生长阶段Sprite:
  [0] Tomato_Stage0.png
  [1] Tomato_Stage1.png
  [2] Tomato_Stage2.png
  [3] Tomato_Stage3.png
  [4] Tomato_Stage4.png
```

### CropData配置（番茄）

```
Item ID: 1101
Item Name: 番茄
Icon: Tomato_Icon.png
Description: 新鲜多汁的番茄
Price: 80金币

对应种子ID: 1001
收获经验值: 15
```

---

## 🎨 美术资源需求清单

### 必需资源：

#### Tile资源（2个）
- ✅ Farmland_Dry.png (16x16 或 32x32)
- ✅ Farmland_Wet.png (16x16 或 32x32)

#### 作物资源（5种 × 5阶段 = 25个Sprite）
```
基础作物：
1. 萝卜 (Radish) - 春季，4天成熟
2. 番茄 (Tomato) - 夏季，9天成熟，可重复收获
3. 小麦 (Wheat) - 春/秋季，7天成熟
4. 南瓜 (Pumpkin) - 秋季，12天成熟
5. 草莓 (Strawberry) - 春季，8天成熟，可重复收获
```

每种作物5个阶段Sprite：
- Stage0: 种子/幼苗 (1-2天)
- Stage1: 小植株 (3-4天)
- Stage2: 生长中 (5-6天)
- Stage3: 即将成熟 (7-8天)
- Stage4: 成熟可收获

#### 工具动画（2个工具 × 3方向 × 8帧 = 48帧）
- ✅ Hoe_Down/Side/Up (可复用Slice骨架)
- ✅ WateringCan_Down/Side/Up

#### 粒子效果（2个）
- ✅ TillingSoil_Particles (泥土飞溅)
- ✅ Watering_Particles (水流/水滴)

### 可选资源（后期优化）：
- 枯萎作物Sprite（变黄）
- 更多生长阶段（6-8阶段，更细腻）
- 不同品质的视觉效果（发光边缘）
- 季节性变化（同一作物不同季节外观略有不同）

---

## 🎯 开发优先级

### P0 - 核心功能（必须完成）
1. ✅ Tilemap耕地系统
2. ✅ 基础锄地功能
3. ✅ 种植与生长系统
4. ✅ 浇水系统
5. ✅ 简单收获

### P1 - 重要功能
1. ✅ 可重复收获
2. ✅ 枯萎系统
3. ✅ 作物品质
4. ✅ 季节限制

### P2 - 优化功能（可延后）
1. 🔲 肥料系统
2. 🔲 温室种植
3. 🔲 自动洒水器
4. 🔲 作物杂交

---

## 📈 性能考虑

### 优化策略：
1. **对象池**：作物GameObject使用对象池，避免频繁创建销毁
2. **批处理更新**：生长检查每天只执行一次
3. **空间分区**：大量作物时使用空间哈希表加速检测
4. **延迟加载**：只加载玩家视野附近的作物
5. **数据压缩**：保存时只存储必要数据，不保存GameObject引用

### 预期性能：
- 100个耕地格子 + 50个作物：稳定60FPS
- 500个耕地格子 + 200个作物：稳定30-60FPS

---

## 📚 参考资料

- **星露谷物语Wiki**：作物数据、成长时间
- **Unity Tilemap文档**：Tile系统最佳实践
- **项目现有系统**：
  - `Docx/Summary/第一阶段完结报告.md` - 现有系统说明
  - `Assets/Scripts/Data/Items/SeedData.cs` - 种子数据结构
  - `Assets/Scripts/Service/TimeManager.cs` - 时间系统

---

## ✅ 验收标准

### 最小可玩版本（MVP）：
- [x] 可以用锄头耕地
- [x] 可以在耕地上种植种子
- [x] 可以用浇水壶浇水
- [x] 作物自动生长（每天检查）
- [x] 成熟后可以收获
- [x] 获得正确的作物物品

### 完整版本：
- [x] 支持5种以上作物
- [x] 可重复收获作物正常工作
- [x] 未浇水会枯萎
- [x] 季节限制生效
- [x] 有完整的音效和粒子反馈
- [x] 可保存/加载

---

**文档状态**: ✅ 完成  
**下一步**: 开始实现阶段1 - 基础框架
