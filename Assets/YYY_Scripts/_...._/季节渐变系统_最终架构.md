# å­£èŠ‚æ¸å˜ç³»ç»Ÿ - æœ€ç»ˆæ¶æ„è®¾è®¡

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

**å•ä¸€èŒè´£ + å…¨å±€ç®¡ç† + æ€§èƒ½ä¼˜åŒ–**

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
TimeManager (æ—¶é—´æº)
    â†“ æ¯å¤©/æ¯å­£è§¦å‘äº‹ä»¶
SeasonManager (å…¨å±€å­£èŠ‚ç®¡ç†å™¨)
    â”œâ”€ æ—¥å†å­£èŠ‚ï¼ˆSpring/Summer/Autumn/Winterï¼‰
    â”œâ”€ æ¤è¢«å­£èŠ‚ï¼ˆ5ä¸ªç»†åˆ†ï¼‰
    â””â”€ å­£èŠ‚è¿‡æ¸¡è¿›åº¦ï¼ˆ0.0-1.0ï¼‰
    â†“ é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
TreeController (ä¸ªä½“æ ‘æœ¨)
    â”œâ”€ ç›‘å¬ OnSeasonChanged
    â”œâ”€ ç›‘å¬ OnVegetationSeasonChanged
    â””â”€ ä»…è´Ÿè´£æ˜¾ç¤ºsprite
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. **SeasonManager** (å…¨å±€å•ä¾‹)

**èŒè´£**ï¼š
- ç®¡ç†æ—¥å†å­£èŠ‚ï¼ˆ4ä¸ªï¼‰
- è®¡ç®—æ¤è¢«å­£èŠ‚ï¼ˆ5ä¸ªï¼‰
- è®¡ç®—å­£èŠ‚è¿‡æ¸¡è¿›åº¦ï¼ˆ0.0-1.0ï¼‰
- è®¢é˜… `TimeManager` çš„æ¯æ—¥/æ¯å­£äº‹ä»¶
- å¹¿æ’­å­£èŠ‚å˜åŒ–äº‹ä»¶

**å…³é”®API**ï¼š
```csharp
// è·å–å½“å‰æ¤è¢«å­£èŠ‚
public VegetationSeason GetCurrentVegetationSeason()

// è·å–å­£èŠ‚è¿‡æ¸¡è¿›åº¦ï¼ˆ0.0-1.0ï¼‰
// 0.2 = 20%çš„æ ‘æ˜¾ç¤ºæ–°å­£èŠ‚
// 0.8 = 80%çš„æ ‘æ˜¾ç¤ºæ–°å­£èŠ‚
public float GetTransitionProgress()

// äº‹ä»¶
public static event Action<Season> OnSeasonChanged;
public static event Action OnVegetationSeasonChanged;
```

**æ¤è¢«å­£èŠ‚æšä¸¾**ï¼š
```csharp
public enum VegetationSeason
{
    EarlySpring,            // æ—©æ˜¥ (æ˜¥1-14)
    LateSpringEarlySummer,  // æ™šæ˜¥æ—©å¤ (æ˜¥15-å¤14)
    LateSummerEarlyFall,    // æ™šå¤æ—©ç§‹ (å¤15-ç§‹14)
    LateFall,               // æ™šç§‹ (ç§‹15-28)
    Winter                  // å†¬å­£ (å†¬1-28)
}
```

**è¿›åº¦è®¡ç®—é€»è¾‘**ï¼š
```csharp
// æ™šæ˜¥æ—©å¤ï¼ˆæ˜¥15-å¤14ï¼Œå…±28å¤©ï¼‰
// è¿›åº¦ä» 0.2 çº¿æ€§å¢é•¿åˆ° 0.8
int dayInTransition = dayInSeason - 14; // æ˜¥15å¤© â†’ dayInTransition=1
progress = 0.2f + (dayInTransition - 1) / 27f * 0.6f;
```

---

### 2. **TreeController** (ä¸ªä½“ç»„ä»¶)

**èŒè´£**ï¼š
- è®¢é˜… `SeasonManager` äº‹ä»¶
- æŸ¥è¯¢ `SeasonManager` è·å–å½“å‰æ¤è¢«å­£èŠ‚å’Œè¿›åº¦
- åŸºäºæ ‘æœ¨IDç”Ÿæˆå›ºå®šéšæœºå€¼
- æ ¹æ®è¿›åº¦å’Œéšæœºå€¼å†³å®šæ˜¾ç¤ºå“ªä¸ªå­£èŠ‚çš„sprite
- ç®¡ç†è‡ªèº«çš„æˆé•¿é˜¶æ®µå’ŒçŠ¶æ€

**æ ‘æœ¨IDç”Ÿæˆ**ï¼š
```csharp
// åŸºäºInstanceIDç”Ÿæˆ0-9999çš„IDï¼ˆç æ ‘åIDå¯å¤ç”¨ï¼‰
treeID = Mathf.Abs(gameObject.GetInstanceID()) % 10000;
```

**å…³é”®æ–¹æ³•**ï¼š
```csharp
// è·å–è¿‡æ¸¡å­£èŠ‚sprite
private Sprite GetTransitionSprite(SeasonGrowthData season1, SeasonGrowthData season2)
{
    // ä½¿ç”¨treeIDç”Ÿæˆå›ºå®šéšæœºå€¼
    int seed = treeID + (int)currentStage * 100;
    Random.InitState(seed);
    float treeSeedValue = Random.value; // 0.0-1.0
    
    // ä»SeasonManagerè·å–å…¨å±€è¿›åº¦
    float progress = SeasonManager.Instance.GetTransitionProgress();
    
    // åˆ¤æ–­ï¼šå¦‚æœéšæœºå€¼ < è¿›åº¦ï¼Œæ˜¾ç¤ºæ–°å­£èŠ‚
    if (treeSeedValue < progress)
        return GetSeasonSprite(season2); // æ–°å­£èŠ‚
    else
        return GetSeasonSprite(season1); // æ—§å­£èŠ‚
}
```

---

## ğŸŒ³ æ¸å˜åŸç†

### åœºæ™¯æ¯”ä¾‹æ¸å˜ï¼ˆéé¢œè‰²æ··åˆï¼‰

**ç¤ºä¾‹**ï¼šåœºæ™¯ä¸­æœ‰100æ£µæ ‘

| æ—¥æœŸ | æ¤è¢«å­£èŠ‚ | è¿›åº¦ | æ•ˆæœ |
|------|---------|------|------|
| æ˜¥15å¤© | æ™šæ˜¥æ—©å¤å¼€å§‹ | 0.2 | 20æ£µæ ‘æ˜¾ç¤ºå¤å­£ï¼Œ80æ£µæ˜¾ç¤ºæ˜¥å­£ |
| æ˜¥22å¤© | æ™šæ˜¥æ—©å¤ä¸­æœŸ | 0.42 | 42æ£µæ ‘æ˜¾ç¤ºå¤å­£ï¼Œ58æ£µæ˜¾ç¤ºæ˜¥å­£ |
| å¤1å¤© | æ™šæ˜¥æ—©å¤ä¸­æœŸ | 0.53 | 53æ£µæ ‘æ˜¾ç¤ºå¤å­£ï¼Œ47æ£µæ˜¾ç¤ºæ˜¥å­£ |
| å¤14å¤© | æ™šæ˜¥æ—©å¤ç»“æŸ | 0.8 | 80æ£µæ ‘æ˜¾ç¤ºå¤å­£ï¼Œ20æ£µæ˜¾ç¤ºæ˜¥å­£ |
| å¤15å¤© | æ™šå¤æ—©ç§‹å¼€å§‹ | 0.2 | **100%åˆ‡æ¢åˆ°å¤å­£** â†’ ç„¶å20æ£µæ˜¾ç¤ºæ—©ç§‹ |

### éšæœºå€¼ä¸€è‡´æ€§

**å…³é”®**ï¼šæ¯æ£µæ ‘çš„éšæœºå€¼æ°¸è¿œä¸å˜ï¼

```csharp
// æ ‘A: treeID=123, stage=Small
// â†’ seed = 123 + 1*100 = 223
// â†’ Random.value = 0.35ï¼ˆå›ºå®šï¼‰

// è¿›åº¦=0.2æ—¶ï¼š0.35 > 0.2 â†’ æ˜¾ç¤ºæ—§å­£èŠ‚
// è¿›åº¦=0.4æ—¶ï¼š0.35 < 0.4 â†’ æ˜¾ç¤ºæ–°å­£èŠ‚âœ… ï¼ˆé¦–æ¬¡åˆ‡æ¢ï¼‰
// è¿›åº¦=0.8æ—¶ï¼š0.35 < 0.8 â†’ æ˜¾ç¤ºæ–°å­£èŠ‚
```

**ä¼˜åŠ¿**ï¼š
- æ ‘ä¸ä¼šé—ªçƒ
- è§†è§‰ä¸Šæ˜¯"é€æ¸æ¢å­£"
- æ€§èƒ½ä¼˜åŒ–ï¼šåªè®¡ç®—ä¸€æ¬¡éšæœºå€¼

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å•æ¬¡è®¡ç®—ï¼Œå…¨å±€å…±äº«
- âœ… `SeasonManager` æ¯å¤©è®¡ç®—ä¸€æ¬¡æ¤è¢«å­£èŠ‚å’Œè¿›åº¦
- âœ… æ‰€æœ‰æ ‘æœ¨å…±äº«åŒä¸€ä¸ªè¿›åº¦å€¼
- âŒ é¿å…æ¯æ£µæ ‘é‡å¤è®¡ç®—æ—¥æœŸ

### 2. äº‹ä»¶é©±åŠ¨
- âœ… åªåœ¨å­£èŠ‚å˜åŒ–æ—¶è§¦å‘ `OnVegetationSeasonChanged`
- âœ… æ ‘æœ¨åªåœ¨æ”¶åˆ°äº‹ä»¶æ—¶æ›´æ–°sprite
- âŒ é¿å…æ¯å¸§Updateæ£€æŸ¥

### 3. å›ºå®šéšæœºå€¼
- âœ… åŸºäºtreeIDç”Ÿæˆä¸€æ¬¡ï¼Œæ°¸ä¹…æœ‰æ•ˆ
- âœ… ä½¿ç”¨`Random.InitState(seed)`ä¿è¯ä¸€è‡´æ€§
- âŒ é¿å…æ¯æ¬¡è°ƒç”¨Randomæ—¶æ±¡æŸ“å…¨å±€éšæœºçŠ¶æ€

---

## ğŸ”— äº‹ä»¶è®¢é˜…é“¾

```
TimeManager.OnDayChanged
    â†“
SeasonManager.OnDayChangedByTimeManager()
    â†“ è®¡ç®—æ–°çš„æ¤è¢«å­£èŠ‚å’Œè¿›åº¦
SeasonManager.OnVegetationSeasonChanged â—
    â†“ å¹¿æ’­
TreeController.OnVegetationSeasonChangedByManager()
    â†“
TreeController.UpdateSprite()
    â†“ æŸ¥è¯¢SeasonManager
GetCurrentSprite() â†’ GetNormalSprite() â†’ GetTransitionSprite()
    â†“ ä½¿ç”¨progressåˆ¤æ–­
æ˜¾ç¤ºå¯¹åº”sprite
```

---

## ğŸ¨ æ¯èæ¤ç‰©çš„å­£èŠ‚æ›´æ›¿

**ç‰¹æ€§**ï¼šæ¯èçš„æ ‘ä¹Ÿå‚ä¸å­£èŠ‚æ¸å˜

```csharp
// GetWitheredSprite() ä¸­
case SeasonManager.VegetationSeason.LateSummerEarlyFall:
    // ä½¿ç”¨treeIDç”Ÿæˆå›ºå®šéšæœºå€¼
    int seed = treeID + (int)currentStage * 100;
    Random.InitState(seed);
    float treeSeedValue = Random.value;
    
    // è·å–è¿›åº¦
    float progress = SeasonManager.Instance.GetTransitionProgress();
    
    if (treeSeedValue < progress)
        return fall_Early.withered_Small; // ç§‹å­£æ¯èå¤–è§‚
    else
        return summer.withered_Small;     // å¤å­£æ¯èå¤–è§‚
```

**æ•ˆæœ**ï¼š
- å¤å­£æ¯èçš„æ ‘ â†’ é€æ¸å˜æˆç§‹å­£æ¯èå¤–è§‚
- æ¢å¤åç«‹å³æ˜¾ç¤ºå½“å‰å­£èŠ‚çš„æ­£å¸¸å¤–è§‚

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### åœºæ™¯è®¾ç½®

1. **åˆ›å»ºSeasonManager**
   ```
   åœºæ™¯ä¸­åˆ›å»ºç©ºç‰©ä½“ï¼šGameManager
   æ·»åŠ ç»„ä»¶ï¼šSeasonManager
   å‹¾é€‰ï¼šUse Time Manager
   ```

2. **åˆ›å»ºTimeManager**
   ```
   åœºæ™¯ä¸­åˆ›å»ºç©ºç‰©ä½“ï¼šTimeManager
   æ·»åŠ ç»„ä»¶ï¼šTimeManager
   è®¾ç½®ï¼šDays Per Season = 28
   ```

3. **æ ‘æœ¨é¢„åˆ¶ä½“**
   ```
   æ ‘æœ¨ä¸Šæ·»åŠ ï¼šTreeController
   é…ç½®spritesï¼ˆæ˜¥/å¤/æ—©ç§‹/æ™šç§‹/å†¬å­£ï¼‰
   Auto Grow = true
   Days To Stage1 = 2
   Days To Stage2 = 3
   ```

### è°ƒè¯•

**æŸ¥çœ‹å½“å‰çŠ¶æ€**ï¼š
- `SeasonManager` Inspectorï¼š
  - Current Vegetation Season
  - Season Transition Progressï¼ˆ0.0-1.0ï¼‰
- `TreeController` Inspectorï¼š
  - Tree IDï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰
  - Current Stage, Current State

**æµ‹è¯•å­£èŠ‚åˆ‡æ¢**ï¼š
- ä½¿ç”¨ `TimeManagerDebugger`ï¼š
  - å³ç®­å¤´ï¼šè·³è½¬ä¸‹ä¸€å¤©
  - ä¸‹ç®­å¤´ï¼šè·³è½¬ä¸‹ä¸€å­£
  - è§‚å¯Ÿæ ‘æœ¨é€æ¸æ¢å­£

---

## âœ… ä¼˜åŠ¿æ€»ç»“

| æ–¹é¢ | æ—§è®¾è®¡ï¼ˆâŒï¼‰ | æ–°è®¾è®¡ï¼ˆâœ…ï¼‰ |
|------|------------|------------|
| **èŒè´£åˆ’åˆ†** | æ¯æ£µæ ‘è‡ªå·±è®¡ç®— | SeasonManagerç»Ÿä¸€è®¡ç®— |
| **æ€§èƒ½** | Næ£µæ ‘ = Næ¬¡è®¡ç®— | 1æ¬¡è®¡ç®—ï¼ŒNæ£µæ ‘å…±äº« |
| **è®¢é˜…** | æ¯æ£µæ ‘è®¢é˜…TimeManager | åªæœ‰SeasonManagerè®¢é˜… |
| **ç»´æŠ¤æ€§** | é€»è¾‘åˆ†æ•£åœ¨TreeController | é€»è¾‘é›†ä¸­åœ¨SeasonManager |
| **æ‰©å±•æ€§** | éœ€ä¿®æ”¹æ‰€æœ‰TreeController | åªéœ€ä¿®æ”¹SeasonManager |
| **æ ‘æœ¨ID** | éœ€è¦TreeRegistryç®¡ç† | ç›´æ¥ç”¨InstanceID % 10000 |

---

## ğŸ› å¸¸è§é—®é¢˜

**Qï¼šæ ‘æœ¨æ²¡æœ‰æ¢å­£ï¼Ÿ**
Aï¼šæ£€æŸ¥ `SeasonManager.OnVegetationSeasonChanged` æ˜¯å¦è§¦å‘ï¼Œä»¥åŠ `TreeController` æ˜¯å¦æ­£ç¡®è®¢é˜…ã€‚

**Qï¼šæ‰€æœ‰æ ‘åŒæ—¶æ¢å­£ï¼Ÿ**
Aï¼šæ£€æŸ¥ `GetTransitionProgress()` æ˜¯å¦æ­£ç¡®è¿”å›0.2-0.8ä¹‹é—´çš„å€¼ã€‚

**Qï¼šæ ‘æœ¨é—ªçƒï¼Ÿ**
Aï¼šæ£€æŸ¥ `treeID` æ˜¯å¦æ¯æ¬¡éƒ½ç›¸åŒï¼ˆåº”è¯¥åœ¨Startæ—¶å›ºå®šï¼‰ã€‚

**Qï¼šè¿›åº¦å§‹ç»ˆæ˜¯0ï¼Ÿ**
Aï¼šæ£€æŸ¥ `TimeManager` çš„ `Days Per Season` æ˜¯å¦è®¾ç½®ä¸º28ã€‚

---

âœ… **ç³»ç»Ÿå·²å®Œæˆï¼** 

ç”± AI Assistant äº 2025å¹´ è®¾è®¡å¹¶å®ç°

