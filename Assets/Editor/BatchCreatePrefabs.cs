using UnityEngine;
using UnityEditor;
using System.IO;
using System.Collections.Generic;
using System.Linq;

/// <summary>
/// é«˜çº§æ‰¹é‡é¢„åˆ¶ä½“åˆ›å»ºå·¥å…· - å¯è§†åŒ–ç¼–è¾‘å™¨çª—å£
/// ä½œè€…ï¼šAIåŠ©æ‰‹
/// åŠŸèƒ½ï¼šæ‰¹é‡ä»Spriteåˆ›å»ºé¢„åˆ¶ä½“ï¼Œæ”¯æŒç»„ä»¶é…ç½®ã€æ¨¡æ¿é¢„è®¾ã€è‡ªåŠ¨åˆ†ç±»ç­‰
/// </summary>
public class AdvancedPrefabCreator : EditorWindow
{
    #region æ•°æ®ç»“æ„
    
    [System.Serializable]
    public class PrefabSettings
    {
        public string prefabName = "NewPrefab";
        public string savePath = "Assets/Prefabs/AutoGenerated";
        
        // Sprite Renderer è®¾ç½®
        public string sortingLayerName = "Default";
        public int sortingOrder = 0;
        public Material material;
        
        // ç»„ä»¶é€‰é¡¹
        public bool addBoxCollider2D = false;
        public bool addCircleCollider2D = false;
        public bool addPolygonCollider2D = false;
        public bool addRigidbody2D = false;
        public bool addDynamicSorting = false;
        public bool addAnimator = false;
        
        // Collider è®¾ç½®
        public bool isTrigger = false;
        
        // Rigidbody2D è®¾ç½®
        public RigidbodyType2D bodyType = RigidbodyType2D.Static;
    }
    
    public enum PrefabTemplate
    {
        Custom,          // è‡ªå®šä¹‰
        StaticProp,      // é™æ€è£…é¥°ç‰©ï¼ˆæ ‘ã€çŸ³å¤´ï¼‰
        InteractiveProp, // å¯äº¤äº’é“å…·ï¼ˆå®ç®±ã€é—¨ï¼‰
        AnimatedProp,    // åŠ¨ç”»é“å…·ï¼ˆç¯ç«ã€æ°´é¢ï¼‰
        Building,        // å»ºç­‘
        Vegetation,      // æ¤è¢«
        Collision        // ç¢°æ’ç‰©
    }
    
    #endregion
    
    #region å˜é‡
    
    private List<Sprite> selectedSprites = new List<Sprite>();
    private PrefabSettings settings = new PrefabSettings();
    private PrefabTemplate currentTemplate = PrefabTemplate.Custom;
    private Vector2 scrollPos;
    
    private bool showComponentSettings = true;
    private bool showAdvancedSettings = false;
    
    // æ’åºå±‚åˆ—è¡¨
    private string[] sortingLayerNames;
    private int selectedSortingLayerIndex = 0;
    
    #endregion
    
    #region Unity ç”Ÿå‘½å‘¨æœŸ
    
    [MenuItem("Tools/é«˜çº§é¢„åˆ¶ä½“åˆ›å»ºå·¥å…·")]
    static void OpenWindow()
    {
        var window = GetWindow<AdvancedPrefabCreator>("é¢„åˆ¶ä½“åˆ›å»ºå·¥å…·");
        window.minSize = new Vector2(400, 600);
        window.Show();
    }
    
    void OnEnable()
    {
        // è·å–æ‰€æœ‰æ’åºå±‚
        RefreshSortingLayers();
        
        // åŠ è½½é€‰ä¸­çš„Sprite
        LoadSelectedSprites();
        
        // åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„è·¯å¾„
        LoadSettings();
    }
    
    void OnDisable()
    {
        // ä¿å­˜å½“å‰è®¾ç½®
        SaveSettings();
    }
    
    void OnSelectionChange()
    {
        LoadSelectedSprites();
        Repaint();
    }
    
    #endregion
    
    #region GUI ç»˜åˆ¶
    
    void OnGUI()
    {
        scrollPos = EditorGUILayout.BeginScrollView(scrollPos);
        
        DrawHeader();
        DrawSpriteSelection();
        DrawTemplateSelection();
        DrawBasicSettings();
        DrawComponentSettings();
        DrawAdvancedSettings();
        DrawActionButtons();
        
        EditorGUILayout.EndScrollView();
    }
    
    void DrawHeader()
    {
        EditorGUILayout.Space(10);
        EditorGUILayout.LabelField("ğŸ¨ é«˜çº§é¢„åˆ¶ä½“æ‰¹é‡åˆ›å»ºå·¥å…·", EditorStyles.boldLabel);
        EditorGUILayout.Space(5);
        EditorGUILayout.HelpBox(
            "ä½¿ç”¨æ–¹æ³•ï¼š\n" +
            "1. åœ¨Projectçª—å£é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªSprite\n" +
            "2. é€‰æ‹©é¢„è®¾æ¨¡æ¿æˆ–è‡ªå®šä¹‰é…ç½®\n" +
            "3. ç‚¹å‡»\"åˆ›å»ºé¢„åˆ¶ä½“\"æŒ‰é’®",
            MessageType.Info
        );
        EditorGUILayout.Space(10);
    }
    
    void DrawSpriteSelection()
    {
        EditorGUILayout.LabelField("ğŸ“¦ é€‰ä¸­çš„Sprite", EditorStyles.boldLabel);
        
        if (selectedSprites.Count == 0)
        {
            EditorGUILayout.HelpBox("è¯·åœ¨Projectçª—å£ä¸­é€‰æ‹©è‡³å°‘ä¸€ä¸ªSprite", MessageType.Warning);
        }
        else
        {
            EditorGUILayout.LabelField($"å·²é€‰æ‹© {selectedSprites.Count} ä¸ªSprite:");
            
            // æ˜¾ç¤ºå‰5ä¸ª
            int displayCount = Mathf.Min(5, selectedSprites.Count);
            for (int i = 0; i < displayCount; i++)
            {
                EditorGUILayout.LabelField($"  â€¢ {selectedSprites[i].name}");
            }
            
            if (selectedSprites.Count > 5)
            {
                EditorGUILayout.LabelField($"  ... è¿˜æœ‰ {selectedSprites.Count - 5} ä¸ª");
            }
        }
        
        EditorGUILayout.Space(10);
    }
    
    void DrawTemplateSelection()
    {
        EditorGUILayout.LabelField("ğŸ¯ é¢„è®¾æ¨¡æ¿", EditorStyles.boldLabel);
        
        PrefabTemplate newTemplate = (PrefabTemplate)EditorGUILayout.EnumPopup("æ¨¡æ¿ç±»å‹", currentTemplate);
        
        if (newTemplate != currentTemplate)
        {
            currentTemplate = newTemplate;
            ApplyTemplate(currentTemplate);
        }
        
        // æ¨¡æ¿è¯´æ˜
        string templateDescription = GetTemplateDescription(currentTemplate);
        if (!string.IsNullOrEmpty(templateDescription))
        {
            EditorGUILayout.HelpBox(templateDescription, MessageType.Info);
        }
        
        EditorGUILayout.Space(10);
    }
    
    void DrawBasicSettings()
    {
        EditorGUILayout.LabelField("âš™ï¸ åŸºç¡€è®¾ç½®", EditorStyles.boldLabel);
        
        // ä¿å­˜è·¯å¾„
        EditorGUILayout.BeginHorizontal();
        settings.savePath = EditorGUILayout.TextField("ä¿å­˜è·¯å¾„", settings.savePath);
        if (GUILayout.Button("æµè§ˆ", GUILayout.Width(60)))
        {
            string path = EditorUtility.OpenFolderPanel("é€‰æ‹©ä¿å­˜è·¯å¾„", "Assets", "");
            if (!string.IsNullOrEmpty(path))
            {
                settings.savePath = "Assets" + path.Replace(Application.dataPath, "");
            }
        }
        EditorGUILayout.EndHorizontal();
        
        // Sorting Layer
        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.LabelField("Sorting Layer", GUILayout.Width(146));
        selectedSortingLayerIndex = EditorGUILayout.Popup(selectedSortingLayerIndex, sortingLayerNames);
        settings.sortingLayerName = sortingLayerNames[selectedSortingLayerIndex];
        EditorGUILayout.EndHorizontal();
        
        // Sorting Order
        settings.sortingOrder = EditorGUILayout.IntField("Order in Layer", settings.sortingOrder);
        
        // Material
        settings.material = (Material)EditorGUILayout.ObjectField("Material", settings.material, typeof(Material), false);
        
        EditorGUILayout.Space(10);
    }
    
    void DrawComponentSettings()
    {
        showComponentSettings = EditorGUILayout.Foldout(showComponentSettings, "ğŸ”§ ç»„ä»¶é…ç½®", true, EditorStyles.foldoutHeader);
        
        if (showComponentSettings)
        {
            EditorGUI.indentLevel++;
            
            // ç¢°æ’å™¨
            EditorGUILayout.LabelField("ç¢°æ’å™¨ Colliders:", EditorStyles.boldLabel);
            settings.addBoxCollider2D = EditorGUILayout.Toggle("  Box Collider 2D", settings.addBoxCollider2D);
            settings.addCircleCollider2D = EditorGUILayout.Toggle("  Circle Collider 2D", settings.addCircleCollider2D);
            settings.addPolygonCollider2D = EditorGUILayout.Toggle("  Polygon Collider 2D", settings.addPolygonCollider2D);
            
            if (settings.addBoxCollider2D || settings.addCircleCollider2D || settings.addPolygonCollider2D)
            {
                EditorGUI.indentLevel++;
                settings.isTrigger = EditorGUILayout.Toggle("Is Trigger", settings.isTrigger);
                EditorGUI.indentLevel--;
            }
            
            EditorGUILayout.Space(5);
            
            // ç‰©ç†
            EditorGUILayout.LabelField("ç‰©ç† Physics:", EditorStyles.boldLabel);
            settings.addRigidbody2D = EditorGUILayout.Toggle("  Rigidbody 2D", settings.addRigidbody2D);
            
            if (settings.addRigidbody2D)
            {
                EditorGUI.indentLevel++;
                settings.bodyType = (RigidbodyType2D)EditorGUILayout.EnumPopup("Body Type", settings.bodyType);
                EditorGUI.indentLevel--;
            }
            
            EditorGUILayout.Space(5);
            
            // å…¶ä»–ç»„ä»¶
            EditorGUILayout.LabelField("å…¶ä»–ç»„ä»¶ Others:", EditorStyles.boldLabel);
            settings.addDynamicSorting = EditorGUILayout.Toggle("  åŠ¨æ€æ’åºè„šæœ¬", settings.addDynamicSorting);
            settings.addAnimator = EditorGUILayout.Toggle("  Animator", settings.addAnimator);
            
            EditorGUI.indentLevel--;
        }
        
        EditorGUILayout.Space(10);
    }
    
    void DrawAdvancedSettings()
    {
        showAdvancedSettings = EditorGUILayout.Foldout(showAdvancedSettings, "ğŸ”¬ é«˜çº§è®¾ç½®", true, EditorStyles.foldoutHeader);
        
        if (showAdvancedSettings)
        {
            EditorGUI.indentLevel++;
            EditorGUILayout.HelpBox("é«˜çº§åŠŸèƒ½å¼€å‘ä¸­...", MessageType.Info);
            EditorGUI.indentLevel--;
        }
        
        EditorGUILayout.Space(10);
    }
    
    void DrawActionButtons()
    {
        EditorGUILayout.BeginHorizontal();
        
        GUI.enabled = selectedSprites.Count > 0;
        if (GUILayout.Button("ğŸš€ åˆ›å»ºé¢„åˆ¶ä½“", GUILayout.Height(40)))
        {
            CreatePrefabs();
        }
        GUI.enabled = true;
        
        if (GUILayout.Button("ğŸ”„ åˆ·æ–°é€‰æ‹©", GUILayout.Height(40), GUILayout.Width(100)))
        {
            LoadSelectedSprites();
        }
        
        EditorGUILayout.EndHorizontal();
    }
    
    #endregion
    
    #region æ ¸å¿ƒé€»è¾‘
    
    void LoadSelectedSprites()
    {
        selectedSprites.Clear();
        
        foreach (Object obj in Selection.objects)
        {
            if (obj is Sprite sprite)
            {
                selectedSprites.Add(sprite);
            }
            else if (obj is Texture2D)
            {
                // å¦‚æœé€‰ä¸­çš„æ˜¯Textureï¼Œå°è¯•åŠ è½½å…¶æ‰€æœ‰å­Sprite
                string path = AssetDatabase.GetAssetPath(obj);
                Object[] assets = AssetDatabase.LoadAllAssetsAtPath(path);
                
                foreach (Object asset in assets)
                {
                    if (asset is Sprite subSprite)
                    {
                        selectedSprites.Add(subSprite);
                    }
                }
            }
        }
    }
    
    void RefreshSortingLayers()
    {
        sortingLayerNames = SortingLayer.layers.Select(l => l.name).ToArray();
        
        // å°è¯•æ‰¾åˆ°"Default"æˆ–ç¬¬ä¸€ä¸ª
        selectedSortingLayerIndex = System.Array.IndexOf(sortingLayerNames, settings.sortingLayerName);
        if (selectedSortingLayerIndex < 0) selectedSortingLayerIndex = 0;
    }
    
    void ApplyTemplate(PrefabTemplate template)
    {
        switch (template)
        {
            case PrefabTemplate.StaticProp:
                // é™æ€è£…é¥°ç‰©ï¼šæ ‘ã€çŸ³å¤´ç­‰
                settings.sortingLayerName = "Props";
                settings.sortingOrder = 2;
                settings.addPolygonCollider2D = true;
                settings.addBoxCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = false;
                settings.addRigidbody2D = false;
                settings.addDynamicSorting = true;
                settings.addAnimator = false;
                settings.savePath = "Assets/Prefabs/Environment/StaticProps";
                break;
                
            case PrefabTemplate.InteractiveProp:
                // å¯äº¤äº’é“å…·ï¼šé—¨ã€å®ç®±ç­‰
                settings.sortingLayerName = "Props";
                settings.sortingOrder = 5;
                settings.addBoxCollider2D = true;
                settings.addPolygonCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = true;
                settings.addRigidbody2D = false;
                settings.addDynamicSorting = true;
                settings.addAnimator = true;
                settings.savePath = "Assets/Prefabs/Interactive";
                break;
                
            case PrefabTemplate.AnimatedProp:
                // åŠ¨ç”»é“å…·ï¼šç¯ç«ã€æ°´é¢ç­‰
                settings.sortingLayerName = "Props";
                settings.sortingOrder = 3;
                settings.addBoxCollider2D = false;
                settings.addPolygonCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = false;
                settings.addRigidbody2D = false;
                settings.addDynamicSorting = false;
                settings.addAnimator = true;
                settings.savePath = "Assets/Prefabs/Environment/AnimatedProps";
                break;
                
            case PrefabTemplate.Building:
                // å»ºç­‘
                settings.sortingLayerName = "Props";
                settings.sortingOrder = 1;
                settings.addPolygonCollider2D = true;
                settings.addBoxCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = false;
                settings.addRigidbody2D = false;
                settings.addDynamicSorting = true;
                settings.addAnimator = false;
                settings.savePath = "Assets/Prefabs/Environment/Buildings";
                break;
                
            case PrefabTemplate.Vegetation:
                // æ¤è¢«ï¼šè‰ã€èŠ±ç­‰
                settings.sortingLayerName = "Ground";
                settings.sortingOrder = 5;
                settings.addBoxCollider2D = false;
                settings.addPolygonCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = false;
                settings.addRigidbody2D = false;
                settings.addDynamicSorting = false;
                settings.addAnimator = false;
                settings.savePath = "Assets/Prefabs/Environment/Vegetation";
                break;
                
            case PrefabTemplate.Collision:
                // ç¢°æ’ç‰©ï¼ˆä¸å¯è§ï¼‰
                settings.sortingLayerName = "Default";
                settings.sortingOrder = 0;
                settings.addBoxCollider2D = true;
                settings.addPolygonCollider2D = false;
                settings.addCircleCollider2D = false;
                settings.isTrigger = false;
                settings.addRigidbody2D = true;
                settings.bodyType = RigidbodyType2D.Static;
                settings.addDynamicSorting = false;
                settings.addAnimator = false;
                settings.savePath = "Assets/Prefabs/Collision";
                break;
        }
        
        // åˆ·æ–°æ’åºå±‚ç´¢å¼•
        RefreshSortingLayers();
    }
    
    string GetTemplateDescription(PrefabTemplate template)
    {
        switch (template)
        {
            case PrefabTemplate.StaticProp:
                return "é™æ€è£…é¥°ç‰©ï¼šæ ‘æœ¨ã€çŸ³å¤´ã€æ …æ ç­‰ã€‚åŒ…å«ç¢°æ’å™¨å’ŒåŠ¨æ€æ’åºã€‚";
            case PrefabTemplate.InteractiveProp:
                return "å¯äº¤äº’é“å…·ï¼šé—¨ã€å®ç®±ã€å¼€å…³ç­‰ã€‚åŒ…å«è§¦å‘å™¨å’ŒåŠ¨ç”»å™¨ã€‚";
            case PrefabTemplate.AnimatedProp:
                return "åŠ¨ç”»é“å…·ï¼šç¯ç«ã€æ°´é¢ã€æ——å¸œç­‰ã€‚åªåŒ…å«åŠ¨ç”»å™¨ã€‚";
            case PrefabTemplate.Building:
                return "å»ºç­‘ç»“æ„ï¼šæˆ¿å±‹ã€æ¡¥æ¢ç­‰å¤§å‹ç»“æ„ã€‚åŒ…å«ç¢°æ’å™¨ã€‚";
            case PrefabTemplate.Vegetation:
                return "å°å‹æ¤è¢«ï¼šè‰ä¸›ã€èŠ±æœµç­‰åœ°é¢è£…é¥°ã€‚æ— ç¢°æ’å™¨ã€‚";
            case PrefabTemplate.Collision:
                return "éšå½¢ç¢°æ’ä½“ï¼šç”¨äºé˜»æŒ¡ç©å®¶çš„é€æ˜å¢™ã€‚";
            default:
                return "";
        }
    }
    
    void CreatePrefabs()
    {
        if (selectedSprites.Count == 0)
        {
            EditorUtility.DisplayDialog("é”™è¯¯", "è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªSpriteï¼", "ç¡®å®š");
            return;
        }
        
        // ç¡®ä¿ä¿å­˜è·¯å¾„å­˜åœ¨
        if (!Directory.Exists(settings.savePath))
        {
            Directory.CreateDirectory(settings.savePath);
            AssetDatabase.Refresh();
        }
        
        int successCount = 0;
        float progress = 0;
        
        foreach (Sprite sprite in selectedSprites)
        {
            progress++;
            EditorUtility.DisplayProgressBar("åˆ›å»ºé¢„åˆ¶ä½“", $"æ­£åœ¨å¤„ç†: {sprite.name}", progress / selectedSprites.Count);
            
            if (CreateSinglePrefab(sprite))
            {
                successCount++;
            }
        }
        
        EditorUtility.ClearProgressBar();
        AssetDatabase.Refresh();
        
        EditorUtility.DisplayDialog(
            "å®Œæˆ",
            $"æˆåŠŸåˆ›å»ºäº† {successCount}/{selectedSprites.Count} ä¸ªé¢„åˆ¶ä½“ï¼\nä¿å­˜è·¯å¾„ï¼š{settings.savePath}",
            "ç¡®å®š"
        );
        
        Debug.Log($"âœ… æ‰¹é‡åˆ›å»ºé¢„åˆ¶ä½“å®Œæˆï¼æˆåŠŸï¼š{successCount}ï¼Œå¤±è´¥ï¼š{selectedSprites.Count - successCount}");
    }
    
    bool CreateSinglePrefab(Sprite sprite)
    {
        try
        {
            // åˆ›å»ºGameObject
            GameObject go = new GameObject(sprite.name);
            
            // æ·»åŠ SpriteRenderer
            SpriteRenderer sr = go.AddComponent<SpriteRenderer>();
            sr.sprite = sprite;
            sr.sortingLayerName = settings.sortingLayerName;
            sr.sortingOrder = settings.sortingOrder;
            
            if (settings.material != null)
            {
                sr.material = settings.material;
            }
            
            // æ·»åŠ ç¢°æ’å™¨
            if (settings.addBoxCollider2D)
            {
                BoxCollider2D collider = go.AddComponent<BoxCollider2D>();
                collider.isTrigger = settings.isTrigger;
            }
            
            if (settings.addCircleCollider2D)
            {
                CircleCollider2D collider = go.AddComponent<CircleCollider2D>();
                collider.isTrigger = settings.isTrigger;
            }
            
            if (settings.addPolygonCollider2D)
            {
                PolygonCollider2D collider = go.AddComponent<PolygonCollider2D>();
                collider.isTrigger = settings.isTrigger;
            }
            
            // æ·»åŠ Rigidbody2D
            if (settings.addRigidbody2D)
            {
                Rigidbody2D rb = go.AddComponent<Rigidbody2D>();
                rb.bodyType = settings.bodyType;
            }
            
            // æ·»åŠ Animator
            if (settings.addAnimator)
            {
                go.AddComponent<Animator>();
            }
            
            // æ·»åŠ åŠ¨æ€æ’åºè„šæœ¬
            if (settings.addDynamicSorting)
            {
                go.AddComponent<DynamicSortingOrder>();
            }
            
            // ä¿å­˜ä¸ºé¢„åˆ¶ä½“
            string prefabPath = $"{settings.savePath}/{sprite.name}.prefab";
            PrefabUtility.SaveAsPrefabAsset(go, prefabPath);
            
            // åˆ é™¤ä¸´æ—¶GameObject
            DestroyImmediate(go);
            
            return true;
        }
        catch (System.Exception e)
        {
            Debug.LogError($"åˆ›å»ºé¢„åˆ¶ä½“å¤±è´¥: {sprite.name}\né”™è¯¯: {e.Message}");
            return false;
        }
    }
    
    #endregion
    
    #region è®¾ç½®ä¿å­˜ä¸åŠ è½½
    
    const string PREF_SAVE_PATH = "AdvancedPrefabCreator_SavePath";
    const string PREF_SORTING_LAYER = "AdvancedPrefabCreator_SortingLayer";
    const string PREF_SORTING_ORDER = "AdvancedPrefabCreator_SortingOrder";
    const string PREF_TEMPLATE = "AdvancedPrefabCreator_Template";
    
    void SaveSettings()
    {
        EditorPrefs.SetString(PREF_SAVE_PATH, settings.savePath);
        EditorPrefs.SetString(PREF_SORTING_LAYER, settings.sortingLayerName);
        EditorPrefs.SetInt(PREF_SORTING_ORDER, settings.sortingOrder);
        EditorPrefs.SetInt(PREF_TEMPLATE, (int)currentTemplate);
    }
    
    void LoadSettings()
    {
        if (EditorPrefs.HasKey(PREF_SAVE_PATH))
        {
            settings.savePath = EditorPrefs.GetString(PREF_SAVE_PATH, "Assets/Prefabs/AutoGenerated");
        }
        
        if (EditorPrefs.HasKey(PREF_SORTING_LAYER))
        {
            settings.sortingLayerName = EditorPrefs.GetString(PREF_SORTING_LAYER, "Default");
        }
        
        if (EditorPrefs.HasKey(PREF_SORTING_ORDER))
        {
            settings.sortingOrder = EditorPrefs.GetInt(PREF_SORTING_ORDER, 0);
        }
        
        if (EditorPrefs.HasKey(PREF_TEMPLATE))
        {
            currentTemplate = (PrefabTemplate)EditorPrefs.GetInt(PREF_TEMPLATE, 0);
        }
    }
    
    #endregion
}

