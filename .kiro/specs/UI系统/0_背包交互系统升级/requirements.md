# 需求文档 - 背包交互系统升级

## 简介

本需求文档描述背包 UI 交互系统的全面升级，包括物品拖拽、分割、快速装备、整理、丢弃等功能。该系统需要支持复杂的键鼠组合操作，并与现有的背包、装备、掉落物系统无缝集成。

## 术语表

- **背包系统 (Inventory System)**：管理玩家物品存储的核心系统
- **物品槽 (Slot)**：背包或装备栏中的单个格子
- **物品栈 (ItemStack)**：包含物品ID、品质、数量的数据结构
- **拿起状态 (Held State)**：物品被玩家"拿在手上"跟随鼠标移动的状态，图标和数量跟随鼠标
- **放置状态 (Placed State)**：物品在槽位中静止的状态
- **拖拽状态 (Dragging State)**：长按左键拖拽物品的状态，与拿起状态不同
- **PackagePanel**：背包主面板，包含 Up（物品栏）和 Down（装备栏）两个区域
- **Up 区域**：物品栏，36格（3行×12列），索引 0-35
- **Down 区域**：装备栏，6格（0=头盔，1=裤子，2=盔甲，3=鞋子，4=戒指1，5=戒指2）
- **BT_Sort**：整理按钮
- **BT_TrashCan**：垃圾桶按钮
- **WorldItemPickup**：世界中的可拾取物品
- **原槽位 (Source Slot)**：物品被拿起前所在的槽位，用于放置失败时返回

## 需求

### 需求 1：物品拖拽交换

**用户故事**：作为玩家，我想要通过拖拽来调换物品位置，以便更好地整理背包。

#### 验收标准

1. WHEN 玩家在物品槽上长按左键超过 0.15 秒并移动鼠标 THEN 背包系统 SHALL 进入拖拽状态，物品图标和数量跟随鼠标移动
2. WHEN 玩家在拖拽状态下松开左键于另一个有物品的槽位上 THEN 背包系统 SHALL 交换两个槽位的物品内容
3. WHEN 玩家在拖拽状态下松开左键于空槽位上 THEN 背包系统 SHALL 将物品移动到该空槽位（本质也是交换，空与非空交换）
4. WHEN 玩家在拖拽状态下松开左键于 PackagePanel 外部 THEN 背包系统 SHALL 触发丢弃机制
5. WHEN 拖拽状态激活时 THEN 背包系统 SHALL 完全禁用 Shift 和 Ctrl 的分割/拿取逻辑
6. WHEN 拖拽状态下松开左键 THEN 背包系统 SHALL 立即执行放置判定（与 Shift/Ctrl 拿起状态不同）

### 需求 2：Shift+左键 二分拿取

**用户故事**：作为玩家，我想要通过 Shift+左键 拿起一半数量的物品，以便精确分配物品。

#### 验收标准

1. WHEN 玩家按住 Shift 并左键单击有物品的槽位 THEN 背包系统 SHALL 拿起该物品一半数量（向下取整），原槽位保留另一半
2. WHEN 玩家在拿起状态下继续按住 Shift 并再次左键单击同一槽位 THEN 背包系统 SHALL 将手上物品数量再次减半（向下取整），减少的数量返回原槽位
3. WHEN 玩家松开 Shift 后再次按下 Shift 并左键单击同一槽位 THEN 背包系统 SHALL 同样执行二分逻辑（两种操作方式等效）
4. WHEN 手上物品数量为 1 时再次 Shift+左键单击同一槽位 THEN 背包系统 SHALL 不执行任何操作（无法再分）
5. WHEN 玩家在拿起状态下左键单击空槽位（无需按 Shift） THEN 背包系统 SHALL 将手上物品放置到该槽位
6. WHEN 玩家在拿起状态下左键单击有其他物品的槽位 THEN 背包系统 SHALL 将手上物品返回原槽位并恢复数量
7. WHEN 物品处于拿起状态 THEN 背包系统 SHALL 显示物品图标和数量跟随鼠标移动（与槽位内显示样式一致）
8. WHEN Shift 长按左键 THEN 背包系统 SHALL 不触发快速二分（只能单击触发）

### 需求 3：Ctrl+左键 单个拿取

**用户故事**：作为玩家，我想要通过 Ctrl+左键 精确拿取单个物品，以便进行精细操作。

#### 验收标准

1. WHEN 玩家按住 Ctrl 并左键单击有物品的槽位 THEN 背包系统 SHALL 拿起 1 个物品，原槽位数量减 1
2. WHEN 玩家按住 Ctrl 并长按左键 THEN 背包系统 SHALL 以可配置的速度（默认约每秒 3-4 个）持续拿取物品
3. WHEN 玩家松开左键 THEN 背包系统 SHALL 停止持续拿取
4. WHEN 玩家松开 Ctrl 键 THEN 背包系统 SHALL 停止持续拿取
5. WHEN 原槽位物品数量降为 0 THEN 背包系统 SHALL 停止拿取并清空该槽位
6. WHEN 玩家在拿起状态下左键单击空槽位（无需按 Ctrl） THEN 背包系统 SHALL 将手上物品放置到该槽位
7. WHEN 玩家在拿起状态下左键单击有其他物品的槽位 THEN 背包系统 SHALL 将手上物品返回原槽位

### 需求 4：键位冲突处理

**用户故事**：作为玩家，我希望不同的键位组合能够独立工作，不会产生冲突。

#### 验收标准

1. WHEN Shift 和 Ctrl 同时按下 THEN 背包系统 SHALL 不触发任何拿取逻辑
2. WHEN 拖拽状态激活时 THEN 背包系统 SHALL 完全忽略 Shift 和 Ctrl 的输入
3. WHEN 拿起状态激活时（通过 Shift 或 Ctrl 触发） THEN 背包系统 SHALL 禁用拖拽逻辑
4. WHEN 玩家不按任何修饰键单击槽位 THEN 背包系统 SHALL 不拿起物品（仅选中效果）
5. WHEN Shift 和 Ctrl 交替不规律触发 THEN 背包系统 SHALL 正确处理各自独立的逻辑

### 需求 5：物品丢弃机制

**用户故事**：作为玩家，我想要能够丢弃不需要的物品，并且有机会重新拾取。

#### 验收标准

1. WHEN 玩家在拿起状态下左键单击 PackagePanel 外部区域 THEN 背包系统 SHALL 在玩家位置生成掉落物
2. WHEN 玩家在拿起状态下将物品放置到 BT_TrashCan 上 THEN 背包系统 SHALL 丢弃该物品（生成掉落物）
3. WHEN 物品被丢弃后 THEN 世界物品系统 SHALL 设置 5 秒的拾取冷却时间
4. WHEN 玩家在冷却时间内离开拾取范围后重新进入 THEN 世界物品系统 SHALL 允许重新拾取该物品（满足任一条件即可拾取）
5. WHEN 丢弃冷却时间结束 THEN 世界物品系统 SHALL 恢复物品的可拾取状态
6. WHEN 拖拽状态下松开于 PackagePanel 外部 THEN 背包系统 SHALL 同样触发丢弃机制
7. WHEN 拖拽状态下松开于 BT_TrashCan 上 THEN 背包系统 SHALL 同样触发丢弃机制

### 需求 6：掉落物生成冷却

**用户故事**：作为玩家，我希望砍树/挖矿掉落的物品有短暂的落地动画，不会立即被拾取。

#### 验收标准

1. WHEN 资源节点（树木/矿石）生成掉落物 THEN 世界物品系统 SHALL 设置 1 秒的不可拾取时间（硬编码）
2. WHEN 不可拾取时间内玩家进入拾取范围 THEN 世界物品系统 SHALL 不触发拾取逻辑
3. WHEN 不可拾取时间结束 THEN 世界物品系统 SHALL 恢复正常拾取检测

### 需求 7：背包整理功能

**用户故事**：作为玩家，我想要一键整理背包，让物品按类型排序。

#### 验收标准

1. WHEN 玩家点击 BT_Sort 按钮 THEN 背包系统 SHALL 对 Up 区域物品进行排序
2. WHEN 执行排序 THEN 背包系统 SHALL 按以下优先级排列：工具 > 可放置物品 > 消耗品 > 其他
3. WHEN 执行排序 THEN 背包系统 SHALL 不影响 Down 区域（装备栏）
4. WHEN 同类物品存在多个 THEN 背包系统 SHALL 按物品 ID 升序排列

### 需求 8：快速装备功能

**用户故事**：作为玩家，我想要通过 Ctrl+左键 快速装备物品，而不需要拖拽。

#### 验收标准

1. WHEN 玩家在 Up 区域对装备类物品按 Ctrl+左键（非拿起状态） THEN 背包系统 SHALL 尝试装备该物品
2. WHEN 对应装备槽为空 THEN 背包系统 SHALL 将物品移动到装备槽，原位置清空
3. WHEN 对应装备槽已有装备 THEN 背包系统 SHALL 交换两个物品的位置
4. WHEN 物品为戒指且槽位 4 为空 THEN 背包系统 SHALL 优先装备到槽位 4
5. WHEN 物品为戒指且槽位 4 已满但槽位 5 为空 THEN 背包系统 SHALL 装备到槽位 5
6. WHEN 物品为戒指且两个槽位都有装备 THEN 背包系统 SHALL 替换最近未被替换的戒指槽位
7. WHEN 物品不是装备类 THEN 背包系统 SHALL 不执行装备操作（执行普通 Ctrl 拿取逻辑）

### 需求 9：装备槽位限制

**用户故事**：作为玩家，我希望装备栏只能放置对应类型的装备。

#### 验收标准

1. WHEN 玩家尝试将非装备物品拖拽到 Down 区域 THEN 背包系统 SHALL 拒绝放置并返回原位
2. WHEN 玩家尝试将错误类型装备拖拽到不匹配的槽位 THEN 背包系统 SHALL 拒绝放置并返回原位
3. WHEN 装备类型与槽位匹配 THEN 背包系统 SHALL 允许放置或交换
4. WHEN 装备槽位对应关系 THEN 背包系统 SHALL 遵循：0=头盔，1=裤子，2=盔甲，3=鞋子，4=戒指1，5=戒指2

### 需求 10：槽位数量为零时清空

**用户故事**：作为系统，当槽位物品数量变为 0 时，需要正确清空该槽位。

#### 验收标准

1. WHEN 槽位物品数量变为 0 THEN 背包系统 SHALL 将该槽位设置为空状态（ItemStack.Empty）
2. WHEN 槽位被清空 THEN 背包系统 SHALL 清除图标和数量显示
3. WHEN 槽位被清空 THEN 背包系统 SHALL 触发槽位变更事件

### 需求 11：物品状态管理

**用户故事**：作为系统，需要正确管理物品在背包中的多种状态。

#### 验收标准

1. WHEN 物品处于放置状态 THEN 背包系统 SHALL 在对应槽位显示图标和数量
2. WHEN 物品处于拿起状态 THEN 背包系统 SHALL 显示跟随鼠标的图标和数量，原槽位显示剩余数量
3. WHEN 物品处于拖拽状态 THEN 背包系统 SHALL 显示跟随鼠标的图标和数量，原槽位暂时清空显示
4. WHEN 拿起状态的物品成功放置 THEN 背包系统 SHALL 清除跟随鼠标的显示，更新目标槽位
5. WHEN 拿起状态的物品放置失败 THEN 背包系统 SHALL 将物品返回原槽位并恢复数量

### 需求 12：Up 和 Down 区域交互一致性

**用户故事**：作为玩家，我希望 Up（物品栏）和 Down（装备栏）的交互逻辑保持一致。

#### 验收标准

1. WHEN 在 Down 区域执行 Shift+左键 THEN 背包系统 SHALL 执行与 Up 区域相同的二分拿取逻辑
2. WHEN 在 Down 区域执行 Ctrl+左键 THEN 背包系统 SHALL 执行与 Up 区域相同的单个拿取逻辑
3. WHEN 在 Down 区域执行拖拽 THEN 背包系统 SHALL 执行与 Up 区域相同的拖拽交换逻辑
4. WHEN Down 区域参与整理 THEN 背包系统 SHALL 不对 Down 区域进行排序
