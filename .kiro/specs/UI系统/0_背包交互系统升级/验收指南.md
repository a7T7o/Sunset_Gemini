# 背包交互系统升级 V2 - 验收指南

## 概述

本文档提供背包交互系统升级 V2 的验收测试清单。

**实现日期**: 2026-01-05
**设计版本**: V2（基于错误反省重构）

---

## 前置准备

### 1. 在 Unity 中设置 InventoryInteractionManager

1. 在 PackagePanel 上添加 `InventoryInteractionManager` 组件
2. 配置以下引用：
   - `inventory` - 拖入 InventoryService
   - `equipment` - 拖入 EquipmentService
   - `database` - 会自动从 inventory 获取
   - `panelRect` - 拖入 PackagePanel 的 RectTransform
   - `trashCanRect` - 拖入 BT_TrashCan 的 RectTransform（如果有）
   - `playerTransform` - 会自动查找 Player 标签

### 2. HeldItemDisplay 会自动创建

- 如果场景中没有 HeldItemDisplay，Manager 会自动创建
- 也可以手动创建预制体并拖入 `heldDisplay` 字段

---

## 功能验收清单

### ✅ 基础显示（最重要！）

- [ ] 打开背包面板，所有 36 个槽位正确显示物品图标
- [ ] 物品数量文本正确显示（数量 > 1 时显示）
- [ ] 关闭背包再打开，物品仍正常显示
- [ ] Toolbar 物品正常显示（不受影响）

### ✅ 拖拽功能

- [ ] 长按槽位 0.15 秒，物品图标跟随鼠标
- [ ] 拖拽到另一个有物品的槽位，两个物品交换
- [ ] 拖拽到空槽位，物品移动到该槽位
- [ ] 拖拽相同物品到已有堆叠，自动合并（不超过最大堆叠）
- [ ] 拖拽到面板外，物品丢弃（在玩家位置生成掉落物）
- [ ] 拖拽到面板内空白区域，物品返回原位

### ✅ Shift 二分拿取

- [ ] Shift+点击有物品的槽位，拿起一半数量
- [ ] 再次 Shift+点击同一槽位，手上数量继续减半
- [ ] 数量为 1 时 Shift+点击，无反应
- [ ] 点击空槽位，放置手上物品
- [ ] 点击有其他物品的槽位，返回原位
- [ ] ESC 键取消拿取，返回原位

### ✅ Ctrl 单个拿取

- [ ] Ctrl+点击有物品的槽位，拿起 1 个
- [ ] Ctrl+长按，持续拿取（约 3.5 个/秒）
- [ ] 松开 Ctrl 或左键，停止持续拿取
- [ ] 原槽位数量为 0 时，停止拿取并清空槽位
- [ ] 点击空槽位，放置手上物品
- [ ] 点击有其他物品的槽位，返回原位

### ✅ 键位冲突

- [ ] Shift+Ctrl 同时按下，无反应
- [ ] 拖拽中按 Shift/Ctrl，无反应
- [ ] 无修饰键点击槽位，不拿起物品

### ✅ 丢弃机制

- [ ] 丢弃物品后，在玩家位置生成掉落物
- [ ] 丢弃后 5 秒内，物品不可拾取
- [ ] 离开拾取范围后重新进入，可以拾取
- [ ] 5 秒后，物品可以拾取

### ✅ 快速装备

- [ ] Ctrl+点击装备类物品（非拿起状态），快速装备到对应槽位
- [ ] 装备槽已有装备，交换位置
- [ ] 戒指优先装备到槽位 4，其次槽位 5
- [ ] 两个戒指槽都有装备，替换最近未被替换的
- [ ] Ctrl+点击非装备物品，执行普通 Ctrl 拿取

### ✅ 装备槽位限制

- [ ] 非装备物品无法放入装备槽
- [ ] 装备类型不匹配无法放入（如头盔不能放到鞋子槽）
- [ ] 放置失败时返回原位

### ✅ 背包整理

- [ ] 点击整理按钮，物品按优先级排序
- [ ] 相同物品自动合并
- [ ] 装备栏不受影响

### ✅ Down 区域（装备栏）

- [ ] 装备栏支持 Shift 二分拿取
- [ ] 装备栏支持 Ctrl 单个拿取
- [ ] 装备栏支持拖拽交换
- [ ] 装备栏物品可以拖拽到物品栏

---

## 已知限制

1. **整理按钮需要手动绑定** - 需要在 Unity 中将 BT_Sort 按钮的 OnClick 事件绑定到 InventorySortService.SortInventory()

2. **HeldItemDisplay 样式** - 自动创建的 HeldItemDisplay 使用默认样式，如需自定义可手动创建预制体

3. **音效未实现** - 当前版本未实现音效反馈，可后续添加

---

## 调试日志

在 Console 中可以看到以下日志：

- `[Interaction] 开始拖拽: index=X, isEquip=Y, item=Z`
- `[Interaction] Shift拿取: index=X, pickup=Y, remain=Z`
- `[Interaction] Ctrl拿取: index=X, item=Y`
- `[Interaction] 丢弃物品: id=X, amount=Y, cooldown=5s`
- `[Interaction] 快速装备: item=X -> slot=Y`
- `[Interaction] 返回原位: index=X`
- `[HeldItemDisplay] 显示物品: sprite=X, amount=Y`

---

## 回滚方案

如果出现问题，可以：

1. 删除 `InventoryInteractionManager` 组件
2. 删除 `HeldItemDisplay` 组件
3. 背包将恢复到只有显示功能的状态

**核心文件不受影响**：
- `InventorySlotUI.cs` - 只添加了 Index 属性
- `EquipmentSlotUI.cs` - 只添加了 Index 属性
- `InventoryPanelUI.cs` - 未修改

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `Assets/YYY_Scripts/UI/Inventory/InventoryInteractionManager.cs` | 核心交互管理器 |
| `Assets/YYY_Scripts/UI/Inventory/HeldItemDisplay.cs` | 跟随鼠标显示 |
| `Assets/YYY_Scripts/Service/Inventory/InventorySortService.cs` | 背包整理服务 |
| `.kiro/specs/UI系统/0_背包交互系统升级/design_v2.md` | V2 设计文档 |
| `.kiro/specs/UI系统/0_背包交互系统升级/tasks_v2.md` | V2 任务列表 |
| `.kiro/specs/UI系统/0_背包交互系统升级/错误反省.md` | V1 错误分析 |
