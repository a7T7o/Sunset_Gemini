# 输入场景矩阵 - 完整厘清

## 概述

本文档厘清所有输入在不同场景下的行为，确保逻辑清晰、无冲突。

**核心原则**：输入只对当前最上层的 UI 生效，被遮挡的 UI 和世界不响应输入。

---

## 场景定义

### 场景 1：世界（无 UI 打开）
- Toolbar 可见但不是"打开的面板"
- 玩家可以移动、使用工具、导航

### 场景 2：背包面板打开
- PackagePanel 激活，有 Background 覆盖整个视野
- Toolbar 被遮挡（在背包下层）
- 世界被遮挡

### 场景 3：箱子面板打开
- BoxPanelUI 激活
- 类似背包，有独立的交互逻辑

### 场景 4：工具动作锁定中
- 玩家正在执行工具动作（砍树、挖矿等）
- 输入被缓存，动作结束后执行

---

## 输入矩阵

### 场景 1：世界（无 UI 打开）

| 输入 | 行为 | 当前实现 | 状态 |
|------|------|----------|------|
| **WASD** | 玩家移动 | ✅ GameInputManager.HandleMovement | 正常 |
| **Shift** | 疾跑 | ✅ SprintStateManager | 正常 |
| **左键（世界）** | 使用当前工具 | ✅ HandleUseCurrentTool | 正常 |
| **左键（Toolbar）** | 选中槽位 | ✅ ToolbarSlotUI.OnPointerClick | 正常 |
| **右键（世界）** | 自动导航到点击位置 | ✅ HandleRightClickAutoNav | 正常 |
| **右键（Toolbar）** | 无操作 | - | 正常 |
| **滚轮** | 切换 Toolbar 槽位 | ✅ HandleHotbarSelection | 正常 |
| **1-5** | 选中 Toolbar 槽位 | ✅ HandleHotbarSelection | 正常 |
| **Tab** | 打开背包 Props 页 | ✅ HandlePanelHotkeys | 正常 |
| **B** | 打开背包 Recipes 页 | ✅ HandlePanelHotkeys | 正常 |
| **M** | 打开背包 Map 页 | ✅ HandlePanelHotkeys | 正常 |
| **L** | 打开背包 Ex 页 | ✅ HandlePanelHotkeys | 正常 |
| **O** | 打开背包 Relations 页 | ✅ HandlePanelHotkeys | 正常 |
| **ESC** | 打开背包 Settings 页 | ✅ HandlePanelHotkeys | 正常 |

---

### 场景 2：背包面板打开

| 输入 | 期望行为 | 当前实现 | 状态 |
|------|----------|----------|------|
| **WASD** | ❌ 禁用（不移动） | ✅ IsAnyPanelOpen 检查 | 正常 |
| **Shift** | 用于 Shift+左键 | - | 正常 |
| **Ctrl** | 用于 Ctrl+左键 | - | 正常 |
| **左键（背包槽位）** | 开始拖拽检测 | ✅ InventoryInteractionManager | 正常 |
| **左键（装备槽位）** | 开始拖拽检测 | ✅ InventoryInteractionManager | 正常 |
| **左键（Toolbar）** | ❌ 禁用（被遮挡） | ⚠️ **问题：仍然响应** | **需修复** |
| **左键（面板空白）** | 无操作 | ✅ | 正常 |
| **左键（面板外/Background）** | 无操作（不丢弃） | ⚠️ **问题：可能触发丢弃** | **需确认** |
| **右键（背包槽位）** | 无操作（或使用消耗品） | - | 待定 |
| **右键（装备槽位）** | 卸下装备 | ✅ EquipmentSlotUI.OnPointerClick | 正常 |
| **右键（Toolbar）** | ❌ 禁用（被遮挡） | ⚠️ **问题：可能响应** | **需确认** |
| **右键（世界）** | ❌ 禁用（不导航） | ✅ IsAnyPanelOpen 检查 | 正常 |
| **长按左键（槽位）** | 触发拖拽 | ✅ dragThreshold | 正常 |
| **Shift+左键（槽位）** | 二分拿取 | ✅ ShiftPickup | 正常 |
| **Ctrl+左键（槽位）** | 单个拿取/快速装备 | ✅ CtrlPickup/QuickEquip | 正常 |
| **长按Ctrl+左键** | 持续拿取 | ✅ ContinueCtrlPickup | 正常 |
| **Shift+Ctrl+左键** | ❌ 无操作 | ✅ 检查 shift && ctrl | 正常 |
| **滚轮** | ❌ 禁用（不切换 Toolbar） | ✅ pointerOverUI 检查 | 正常 |
| **1-5** | ❌ 禁用（不切换 Toolbar） | ⚠️ **问题：仍然响应** | **需修复** |
| **Tab** | 关闭背包（如果在 Props 页） | ✅ OpenOrToggle | 正常 |
| **B** | 切换到 Recipes 页 | ✅ OpenOrToggle | 正常 |
| **M** | 切换到 Map 页 | ✅ OpenOrToggle | 正常 |
| **L** | 切换到 Ex 页 | ✅ OpenOrToggle | 正常 |
| **O** | 切换到 Relations 页 | ✅ OpenOrToggle | 正常 |
| **ESC** | 关闭背包（或切换到 Settings） | ✅ OpenSettings | 正常 |

---

### 场景 2.1：背包打开 + 拿起物品状态

| 输入 | 期望行为 | 当前实现 | 状态 |
|------|----------|----------|------|
| **左键（空槽位）** | 放置物品 | ✅ TryPlace | 正常 |
| **左键（有物品槽位）** | 返回原位 | ✅ ReturnToSource | 正常 |
| **左键（面板外）** | 丢弃物品 | ✅ DropItem | 正常 |
| **左键（垃圾桶）** | 丢弃物品 | ✅ IsOverTrashCan | 正常 |
| **Shift+左键（同一槽位）** | 继续二分 | ✅ ContinueShiftSplit | 正常 |
| **ESC** | 取消拿取，返回原位 | ✅ ReturnToSource | 正常 |
| **Tab/B/M/L/O** | ❓ 应该取消拿取并切换页面 | ⚠️ **未处理** | **需确认** |

---

### 场景 3：箱子面板打开

| 输入 | 期望行为 | 当前实现 | 状态 |
|------|----------|----------|------|
| **WASD** | ❌ 禁用 | ✅ IsAnyPanelOpen | 正常 |
| **左键（箱子槽位）** | 交互 | BoxPanelUI | 待确认 |
| **右键（世界）** | ❌ 禁用 | ✅ IsAnyPanelOpen | 正常 |
| **ESC** | 关闭箱子 | ✅ HandlePanelHotkeys | 正常 |
| **Tab/B/M/L/O** | 关闭箱子，打开背包 | ✅ CloseBoxPanelIfOpen | 正常 |

---

## 发现的问题

### 问题 1：Toolbar 在背包打开时仍然响应点击 ✅ 已修复

**原因**：
- `ToolbarSlotUI.OnPointerClick` 没有检查背包是否打开
- Unity 的 EventSystem 会穿透到下层 UI

**解决方案**：
在 `ToolbarSlotUI.OnPointerClick` 中添加检查：
```csharp
public void OnPointerClick(PointerEventData eventData)
{
    // 检查是否有面板打开（背包/箱子）
    var packageTabs = FindFirstObjectByType<PackagePanelTabsUI>();
    if (packageTabs != null && packageTabs.IsPanelOpen()) return;
    if (BoxPanelUI.Instance != null && BoxPanelUI.Instance.IsOpen) return;
    
    // 原有逻辑...
}
```

### 问题 2：数字键 1-5 在背包打开时仍然切换 Toolbar ✅ 已修复

**原因**：
- `GameInputManager.HandleHotbarSelection` 中数字键没有检查 `IsAnyPanelOpen()`

**解决方案**：
```csharp
void HandleHotbarSelection()
{
    bool uiOpen = IsAnyPanelOpen();
    
    // 数字键切换 - 面板打开时禁用
    if (uiOpen) return;  // 添加这行
    
    int keyIndex = -1;
    if (Input.GetKeyDown(KeyCode.Alpha1)) keyIndex = 0;
    // ...
}
```

### 问题 3：InventoryInteractionManager 的 panelRect 检测范围 ⚠️ 待确认

**原因**：
- `IsInsidePanel` 检测的是 `panelRect`，但如果 Background 是独立的，可能检测不到
- 需要确认 `panelRect` 是否包含整个可见区域

**解决方案**：
- 确保 `panelRect` 引用的是包含 Background 的最外层 RectTransform
- 或者添加单独的 `backgroundRect` 引用

### 问题 4：拿起物品时切换页面的行为未定义 ✅ 已修复

**原因**：
- 用户在拿起物品状态下按 Tab/B/M/L/O 切换页面
- 当前没有处理这种情况

**解决方案**：
- 切换页面时自动取消拿取状态（调用 `Cancel()`）
- 在 `PackagePanelTabsUI.OpenOrToggle()` 和 `ClosePanel()` 中添加 `CancelInteractionIfNeeded()`

---

## 修复计划

### 优先级 1：Toolbar 点击穿透 ✅ 已完成
1. 修改 `ToolbarSlotUI.OnPointerClick` 添加面板检查

### 优先级 2：数字键穿透 ✅ 已完成
2. 修改 `GameInputManager.HandleHotbarSelection` 添加面板检查

### 优先级 3：拿起状态下的页面切换 ✅ 已完成
3. 在 `PackagePanelTabsUI` 的页面切换方法中调用 `InventoryInteractionManager.Cancel()`

### 优先级 4：panelRect 范围确认 ⚠️ 待测试
4. 确认 `panelRect` 是否正确覆盖整个背包区域

---

## 正确的输入层级设计

```
┌─────────────────────────────────────────────────────────────┐
│                     输入层级（从上到下）                      │
├─────────────────────────────────────────────────────────────┤
│ 1. 全局快捷键（始终生效）                                    │
│    - ESC：关闭当前面板 / 打开设置                            │
│    - Tab/B/M/L/O：打开/切换面板                              │
├─────────────────────────────────────────────────────────────┤
│ 2. 当前最上层 UI（互斥）                                     │
│    ┌─────────────────────────────────────────────────────┐  │
│    │ 背包面板打开时：                                     │  │
│    │ - 左键/右键/Shift/Ctrl 只对背包槽位生效              │  │
│    │ - Toolbar 不响应                                     │  │
│    │ - 世界不响应                                         │  │
│    └─────────────────────────────────────────────────────┘  │
│    ┌─────────────────────────────────────────────────────┐  │
│    │ 箱子面板打开时：                                     │  │
│    │ - 左键/右键只对箱子槽位生效                          │  │
│    │ - 背包/Toolbar/世界不响应                            │  │
│    └─────────────────────────────────────────────────────┘  │
│    ┌─────────────────────────────────────────────────────┐  │
│    │ 无面板打开时：                                       │  │
│    │ - 左键：Toolbar 选中 / 世界使用工具                  │  │
│    │ - 右键：世界导航                                     │  │
│    │ - WASD：移动                                         │  │
│    │ - 滚轮/数字键：切换 Toolbar                          │  │
│    └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 实现检查清单

- [x] `ToolbarSlotUI.OnPointerClick` 添加面板检查
- [x] `GameInputManager.HandleHotbarSelection` 数字键添加面板检查
- [x] `PackagePanelTabsUI` 页面切换时取消拿取状态
- [ ] 确认 `panelRect` 范围正确
- [ ] 测试所有场景的输入行为
