# UI äº¤äº’ç³»ç»Ÿæ¶æ„é‡æ„æ–¹æ¡ˆ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-20  
**æ–‡æ¡£ç±»å‹**: æ¶æ„è®¾è®¡ä¸é‡æ„æ–¹æ¡ˆ  
**å…³è”æ–‡æ¡£**: `å…¨é¢å®¡æ ¸æŠ¥å‘Š.md`, `æ”¹è¿›æ–¹æ¡ˆ.md`

---

## ä¸€ã€å½“å‰æ¶æ„è¯„ä¼°

### 1.1 ç°æœ‰æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI å±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  InventorySlotUI          BoxPanelUI          InventoryPanelUI  â”‚
â”‚       â†“                       â†“                      â†“          â”‚
â”‚  InventorySlotInteraction                                       â”‚
â”‚       â†“                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      äº¤äº’ç®¡ç†å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  InventoryInteractionManager    SlotDragContext                 â”‚
â”‚  (çŠ¶æ€æœºï¼šIdle/HeldByShift/     (é™æ€ç±»ï¼šè·¨å®¹å™¨æ‹–æ‹½)            â”‚
â”‚   HeldByCtrl/Dragging)                                          â”‚
â”‚       â†“                              â†“                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       æ•°æ®å±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  InventoryService              ChestInventory                   â”‚
â”‚  (IItemContainer)              (IItemContainer)                 â”‚
â”‚       â†“                              â†“                          â”‚
â”‚                    ItemStack (å€¼ç±»å‹)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å½“å‰æ¶æ„çš„é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ |
|------|---------|------|
| ä¸¤å¥— Held çŠ¶æ€ç³»ç»Ÿå¹¶å­˜ | ğŸ”´ é«˜ | äº’æ–¥æ€§ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´ç‰©å“ä¸¢å¤± |
| `InventoryInteractionManager` åªæ”¯æŒ `InventoryService` | ğŸ”´ é«˜ | æ— æ³•æ‰©å±•åˆ°å…¶ä»–å®¹å™¨ç±»å‹ |
| `SlotDragContext` æ˜¯é™æ€ç±» | ğŸŸ¡ ä¸­ | æ— æ³•æ”¯æŒå¤šå®ä¾‹åœºæ™¯ï¼ˆå¦‚åˆ†å±ï¼‰ |
| ä¸¢å¼ƒé€»è¾‘é‡å¤ä¸‰å¤„ | ğŸŸ¡ ä¸­ | ç»´æŠ¤æˆæœ¬é«˜ï¼Œå®¹æ˜“ä¸ä¸€è‡´ |
| é¢‘ç¹ä½¿ç”¨ `FindFirstObjectByType` | ğŸŸ¡ ä¸­ | æ€§èƒ½é—®é¢˜ï¼Œä¾èµ–å…³ç³»ä¸æ˜ç¡® |

### 1.3 å¯æ‰©å±•æ€§è¯„ä¼°

**å‡è®¾åœºæ™¯**ï¼šåç»­éœ€è¦æ¥å…¥ä»¥ä¸‹æ–°çš„å­˜å‚¨ UIï¼š
- å•†åº— UIï¼ˆShopInventoryï¼‰
- åˆ¶ä½œå° UIï¼ˆCraftingInventoryï¼‰
- é“¶è¡Œ UIï¼ˆBankInventoryï¼‰
- NPC äº¤æ˜“ UIï¼ˆTradeInventoryï¼‰

**å½“å‰æ¶æ„èƒ½å¦æ”¯æŒï¼Ÿ**

| éœ€æ±‚ | å½“å‰æ”¯æŒåº¦ | é—®é¢˜ |
|------|-----------|------|
| æ–°å®¹å™¨ç±»å‹ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | éœ€è¦ä¿®æ”¹ `InventorySlotInteraction` æ·»åŠ æ–°çš„ `is` åˆ¤æ–­ |
| æ–° UI é¢æ¿ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | éœ€è¦å¤åˆ¶ `BoxPanelUI` çš„å¤§é‡ä»£ç  |
| è·¨å®¹å™¨æ‹–æ‹½ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | éœ€è¦åœ¨ `HandleSlotDragContextDrop` ä¸­æ·»åŠ æ–°çš„åˆ†æ”¯ |
| ä¿®é¥°é”®äº¤äº’ | âŒ ä¸æ”¯æŒ | `InventoryInteractionManager` åªè®¤è¯† `InventoryService` |

**ç»“è®º**ï¼šå½“å‰æ¶æ„**ä¸å¤Ÿçµæ´»**ï¼Œæ¯æ¬¡æ–°å¢å®¹å™¨ç±»å‹éƒ½éœ€è¦ä¿®æ”¹å¤šå¤„ä»£ç ã€‚

---

## äºŒã€ç†æƒ³æ¶æ„è®¾è®¡

### 2.1 è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»åªåšä¸€ä»¶äº‹
2. **å¼€æ”¾å°é—­**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
3. **ä¾èµ–å€’ç½®**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
4. **æ¥å£éš”ç¦»**ï¼šä½¿ç”¨å°è€Œä¸“çš„æ¥å£

### 2.2 é‡æ„åçš„æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI å±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ContainerSlotUI (é€šç”¨æ§½ä½ UI)                                   â”‚
â”‚       â†“                                                         â”‚
â”‚  ContainerPanelBase (é¢æ¿åŸºç±»)                                   â”‚
â”‚       â†“                                                         â”‚
â”‚  InventoryPanel / ChestPanel / ShopPanel / ...                  â”‚
â”‚       â†“                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ç»Ÿä¸€äº¤äº’ç®¡ç†å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ContainerInteractionManager                        â”‚
â”‚              (ç»Ÿä¸€çŠ¶æ€æœºï¼Œæ”¯æŒä»»æ„ IItemContainer)               â”‚
â”‚                          â†“                                      â”‚
â”‚              InteractionContext (å®ä¾‹ç±»ï¼Œéé™æ€)                 â”‚
â”‚              - SourceContainer: IItemContainer                  â”‚
â”‚              - SourceIndex: int                                 â”‚
â”‚              - HeldItem: ItemStack                              â”‚
â”‚                          â†“                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æœåŠ¡å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ItemDropService (ç»Ÿä¸€ä¸¢å¼ƒ)                                      â”‚
â”‚  ItemTransferService (ç»Ÿä¸€è½¬ç§»)                                  â”‚
â”‚  ContainerRegistry (å®¹å™¨æ³¨å†Œè¡¨)                                  â”‚
â”‚                          â†“                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æ•°æ®å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              IItemContainer (æ¥å£)                               â”‚
â”‚                    â†“                                            â”‚
â”‚  InventoryService / ChestInventory / ShopInventory / ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ ¸å¿ƒæ¥å£è®¾è®¡

#### IItemContainerï¼ˆå·²å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•ï¼‰

```csharp
/// <summary>
/// ç‰©å“å®¹å™¨æ¥å£ - æ‰€æœ‰å­˜å‚¨ç±»å‹çš„ç»Ÿä¸€æŠ½è±¡
/// </summary>
public interface IItemContainer
{
    // åŸºç¡€æ“ä½œï¼ˆå·²æœ‰ï¼‰
    int Capacity { get; }
    ItemStack GetSlot(int index);
    void SetSlot(int index, ItemStack item);
    void ClearSlot(int index);
    int GetMaxStack(int itemId);
    
    // ğŸ”¥ æ–°å¢ï¼šå®¹å™¨å…ƒæ•°æ®
    string ContainerType { get; }  // "Inventory", "Chest", "Shop", etc.
    bool IsReadOnly { get; }       // å•†åº—å¯èƒ½æ˜¯åªè¯»çš„
    bool AllowDrop { get; }        // æ˜¯å¦å…è®¸ä¸¢å¼ƒ
    
    // ğŸ”¥ æ–°å¢ï¼šäº‹ä»¶
    event System.Action<int> OnSlotChanged;
    event System.Action OnInventoryChanged;
    
    // ğŸ”¥ æ–°å¢ï¼šé«˜çº§æ“ä½œ
    bool CanAcceptItem(int index, ItemStack item);  // æ§½ä½é™åˆ¶æ£€æŸ¥
    TransferResult TransferTo(IItemContainer target, int sourceIndex, int targetIndex);
}
```

#### IContainerPanelï¼ˆæ–°å¢ï¼‰

```csharp
/// <summary>
/// å®¹å™¨é¢æ¿æ¥å£ - æ‰€æœ‰å®¹å™¨ UI çš„ç»Ÿä¸€æŠ½è±¡
/// </summary>
public interface IContainerPanel
{
    bool IsOpen { get; }
    IItemContainer Container { get; }
    
    void Open(IItemContainer container);
    void Close();
    void Refresh();
    
    // ğŸ”¥ æ§½ä½ UI è®¿é—®
    ContainerSlotUI GetSlotUI(int index);
    IEnumerable<ContainerSlotUI> GetAllSlotUIs();
}
```

### 2.4 ç»Ÿä¸€äº¤äº’ç®¡ç†å™¨è®¾è®¡

```csharp
/// <summary>
/// ç»Ÿä¸€å®¹å™¨äº¤äº’ç®¡ç†å™¨ - æ›¿ä»£ InventoryInteractionManager + SlotDragContext
/// </summary>
public class ContainerInteractionManager : MonoBehaviour
{
    public static ContainerInteractionManager Instance { get; private set; }
    
    // çŠ¶æ€
    private enum State { Idle, Holding, Dragging }
    private State _state = State.Idle;
    
    // ğŸ”¥ æ ¸å¿ƒæ”¹å˜ï¼šä½¿ç”¨ IItemContainer è€Œéå…·ä½“ç±»å‹
    private InteractionContext _context;
    
    /// <summary>
    /// äº¤äº’ä¸Šä¸‹æ–‡ - è®°å½•å½“å‰æ“ä½œçš„æ‰€æœ‰ä¿¡æ¯
    /// </summary>
    public class InteractionContext
    {
        public IItemContainer SourceContainer { get; set; }
        public int SourceIndex { get; set; } = -1;
        public ItemStack HeldItem { get; set; }
        public ContainerSlotUI SourceSlotUI { get; set; }
        public PickupMode Mode { get; set; }  // Shift, Ctrl, Drag
        
        public bool IsValid => SourceContainer != null && SourceIndex >= 0;
        public void Clear() { /* ... */ }
    }
    
    public enum PickupMode { None, Shift, Ctrl, Drag }
    
    // ğŸ”¥ ç»Ÿä¸€å…¥å£ï¼šæ‹¿èµ·ç‰©å“
    public bool TryPickup(IItemContainer container, int index, PickupMode mode)
    {
        if (_state != State.Idle) return false;
        if (container == null) return false;
        
        var item = container.GetSlot(index);
        if (item.IsEmpty) return false;
        
        // æ ¹æ®æ¨¡å¼è®¡ç®—æ‹¿å–æ•°é‡
        ItemStack pickupItem = CalculatePickupAmount(item, mode);
        ItemStack remaining = CalculateRemainingAmount(item, pickupItem);
        
        // æ›´æ–°æºæ§½ä½
        if (remaining.IsEmpty)
            container.ClearSlot(index);
        else
            container.SetSlot(index, remaining);
        
        // è®°å½•ä¸Šä¸‹æ–‡
        _context = new InteractionContext
        {
            SourceContainer = container,
            SourceIndex = index,
            HeldItem = pickupItem,
            Mode = mode
        };
        
        _state = mode == PickupMode.Drag ? State.Dragging : State.Holding;
        ShowHeldIcon(pickupItem);
        return true;
    }
    
    // ğŸ”¥ ç»Ÿä¸€å…¥å£ï¼šæ”¾ç½®ç‰©å“
    public bool TryPlace(IItemContainer targetContainer, int targetIndex)
    {
        if (_state == State.Idle) return false;
        if (!_context.IsValid) return false;
        
        // æ£€æŸ¥ç›®æ ‡å®¹å™¨æ˜¯å¦æ¥å—è¯¥ç‰©å“
        if (!targetContainer.CanAcceptItem(targetIndex, _context.HeldItem))
        {
            return false;
        }
        
        var targetSlot = targetContainer.GetSlot(targetIndex);
        
        // ç©ºæ§½ä½ï¼šç›´æ¥æ”¾ç½®
        if (targetSlot.IsEmpty)
        {
            targetContainer.SetSlot(targetIndex, _context.HeldItem);
            ResetState();
            return true;
        }
        
        // ç›¸åŒç‰©å“ï¼šå †å 
        if (targetSlot.CanStackWith(_context.HeldItem))
        {
            return TryStack(targetContainer, targetIndex, targetSlot);
        }
        
        // ä¸åŒç‰©å“ï¼šäº¤æ¢ï¼ˆå¦‚æœå…è®¸ï¼‰
        return TrySwap(targetContainer, targetIndex, targetSlot);
    }
    
    // ğŸ”¥ ç»Ÿä¸€å…¥å£ï¼šä¸¢å¼ƒç‰©å“
    public void Drop()
    {
        if (_state == State.Idle) return;
        if (!_context.IsValid) return;
        
        ItemDropService.DropAtPlayer(_context.HeldItem);
        ResetState();
    }
    
    // ğŸ”¥ ç»Ÿä¸€å…¥å£ï¼šå–æ¶ˆæ“ä½œ
    public void Cancel()
    {
        if (_state == State.Idle) return;
        if (!_context.IsValid) return;
        
        // è¿”å›ç‰©å“åˆ°æºæ§½ä½
        ReturnToSource();
        ResetState();
    }
    
    // ... å…¶ä»–è¾…åŠ©æ–¹æ³•
}
```

### 2.5 æœåŠ¡å±‚è®¾è®¡

#### ItemDropServiceï¼ˆç»Ÿä¸€ä¸¢å¼ƒï¼‰

```csharp
/// <summary>
/// ç‰©å“ä¸¢å¼ƒæœåŠ¡ - ç»Ÿä¸€æ‰€æœ‰ä¸¢å¼ƒé€»è¾‘
/// </summary>
public static class ItemDropService
{
    public static void DropAtPlayer(ItemStack item, float cooldown = 5f)
    {
        if (item.IsEmpty) return;
        
        var dropPos = GetPlayerDropPosition();
        SpawnWorldItem(item, dropPos, cooldown);
    }
    
    public static void DropAtPosition(ItemStack item, Vector3 position, float cooldown = 5f)
    {
        if (item.IsEmpty) return;
        SpawnWorldItem(item, position, cooldown);
    }
    
    private static Vector3 GetPlayerDropPosition()
    {
        // ä½¿ç”¨ç©å®¶ Collider ä¸­å¿ƒ
        var player = PlayerController.Instance;  // å‡è®¾æœ‰å•ä¾‹
        if (player == null) return Vector3.zero;
        
        var collider = player.GetComponent<Collider2D>();
        return collider != null ? collider.bounds.center : player.transform.position;
    }
    
    private static void SpawnWorldItem(ItemStack item, Vector3 position, float cooldown)
    {
        if (WorldItemPool.Instance == null)
        {
            Debug.LogError("[ItemDropService] WorldItemPool.Instance ä¸º null");
            return;
        }
        
        var pickup = WorldItemPool.Instance.SpawnById(
            item.itemId, item.quality, item.amount, position, true, false);
        pickup?.SetDropCooldown(cooldown);
    }
}
```

#### ContainerRegistryï¼ˆå®¹å™¨æ³¨å†Œè¡¨ï¼‰

```csharp
/// <summary>
/// å®¹å™¨æ³¨å†Œè¡¨ - ç®¡ç†æ‰€æœ‰æ´»è·ƒçš„å®¹å™¨
/// </summary>
public class ContainerRegistry : MonoBehaviour
{
    public static ContainerRegistry Instance { get; private set; }
    
    private Dictionary<string, IItemContainer> _containers = new();
    private Dictionary<string, IContainerPanel> _panels = new();
    
    // æ³¨å†Œå®¹å™¨
    public void Register(string id, IItemContainer container)
    {
        _containers[id] = container;
    }
    
    // æ³¨å†Œé¢æ¿
    public void RegisterPanel(string id, IContainerPanel panel)
    {
        _panels[id] = panel;
    }
    
    // è·å–å®¹å™¨
    public IItemContainer GetContainer(string id)
    {
        return _containers.TryGetValue(id, out var c) ? c : null;
    }
    
    // è·å–å½“å‰æ‰“å¼€çš„é¢æ¿
    public IContainerPanel GetOpenPanel()
    {
        return _panels.Values.FirstOrDefault(p => p.IsOpen);
    }
    
    // å…³é—­æ‰€æœ‰é¢æ¿
    public void CloseAllPanels()
    {
        foreach (var panel in _panels.Values)
        {
            if (panel.IsOpen) panel.Close();
        }
    }
}
```

---

## ä¸‰ã€å¼€å‘è¿ç»­æ€§ä¿éšœ

### 3.1 é—®é¢˜ï¼šå¦‚ä½•ä¿è¯å¼€å‘è¿ç»­æ€§ï¼Ÿ

ä½ æåˆ°çš„é—®é¢˜éå¸¸å…³é”®ï¼š
> "åç»­ä¹Ÿæ˜¯ä½ è¿›è¡Œå¼€å‘ï¼Œå¦‚æœæ˜¯æ¢äº†ä¸€ä¸ªæ¨¡å—å’Œå†…å®¹è¿›æ¥è¿˜æ˜¯éœ€è¦é˜…è¯»å¤§é‡å†…å®¹ï¼Œè¯¥å¦‚ä½•ä¿è¯å¼€å‘çš„è¿ç»­æ€§å’Œå¯é æ€§ï¼Ÿ"

### 3.2 è§£å†³æ–¹æ¡ˆï¼šåˆ†å±‚æ–‡æ¡£ä½“ç³»

```
.kiro/
â”œâ”€â”€ steering/                    # å…¨å±€è§„åˆ™ï¼ˆæ¯æ¬¡å¯¹è¯è‡ªåŠ¨åŠ è½½ï¼‰
â”‚   â”œâ”€â”€ rules.md                 # å¼€å‘ç¦æ­¢äº‹é¡¹
â”‚   â”œâ”€â”€ layers.md                # å±‚çº§è®¾è®¡è§„èŒƒ
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ specs/                       # åŠŸèƒ½è§„æ ¼ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
â”‚   â”œâ”€â”€ UIç³»ç»Ÿ/
â”‚   â”‚   â”œâ”€â”€ memory.md            # æ¨¡å—çº§è®°å¿†ï¼ˆè½»é‡ï¼‰
â”‚   â”‚   â””â”€â”€ architecture.md      # ğŸ”¥ æ–°å¢ï¼šæ¶æ„è®¾è®¡æ–‡æ¡£
â”‚   â”‚
â”‚   â””â”€â”€ ç®±å­ç³»ç»Ÿ/
â”‚       â”œâ”€â”€ memory.md
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ architecture/                # ğŸ”¥ æ–°å¢ï¼šå…¨å±€æ¶æ„æ–‡æ¡£
    â”œâ”€â”€ container-system.md      # å®¹å™¨ç³»ç»Ÿæ¶æ„
    â”œâ”€â”€ interaction-system.md    # äº¤äº’ç³»ç»Ÿæ¶æ„
    â””â”€â”€ service-layer.md         # æœåŠ¡å±‚æ¶æ„
```

### 3.3 æ¶æ„æ–‡æ¡£æ¨¡æ¿

æ¯ä¸ªæ ¸å¿ƒç³»ç»Ÿåº”è¯¥æœ‰ä¸€ä»½æ¶æ„æ–‡æ¡£ï¼ŒåŒ…å«ï¼š

```markdown
# {ç³»ç»Ÿåç§°} æ¶æ„æ–‡æ¡£

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°
- èŒè´£æè¿°
- æ ¸å¿ƒç±»å›¾
- ä¾èµ–å…³ç³»

## äºŒã€æ ¸å¿ƒæ¥å£
- æ¥å£å®šä¹‰
- ä½¿ç”¨ç¤ºä¾‹

## ä¸‰ã€æ‰©å±•æŒ‡å—
- å¦‚ä½•æ·»åŠ æ–°çš„ XXX
- éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•
- æµ‹è¯•è¦ç‚¹

## å››ã€å¸¸è§é—®é¢˜
- Q1: ...
- Q2: ...

## äº”ã€å˜æ›´å†å²
| æ—¥æœŸ | å˜æ›´å†…å®¹ | å½±å“èŒƒå›´ |
|------|---------|---------|
```

### 3.4 ä»£ç è‡ªæ–‡æ¡£åŒ–

é™¤äº†å¤–éƒ¨æ–‡æ¡£ï¼Œä»£ç æœ¬èº«ä¹Ÿåº”è¯¥æ˜¯è‡ªè§£é‡Šçš„ï¼š

```csharp
/// <summary>
/// å®¹å™¨äº¤äº’ç®¡ç†å™¨
/// 
/// ã€èŒè´£ã€‘
/// ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å®¹å™¨ï¼ˆèƒŒåŒ…ã€ç®±å­ã€å•†åº—ç­‰ï¼‰çš„äº¤äº’é€»è¾‘
/// 
/// ã€ä½¿ç”¨æ–¹å¼ã€‘
/// 1. æ‹¿èµ·ç‰©å“ï¼šContainerInteractionManager.Instance.TryPickup(container, index, mode)
/// 2. æ”¾ç½®ç‰©å“ï¼šContainerInteractionManager.Instance.TryPlace(container, index)
/// 3. ä¸¢å¼ƒç‰©å“ï¼šContainerInteractionManager.Instance.Drop()
/// 4. å–æ¶ˆæ“ä½œï¼šContainerInteractionManager.Instance.Cancel()
/// 
/// ã€æ‰©å±•æ–°å®¹å™¨ã€‘
/// 1. å®ç° IItemContainer æ¥å£
/// 2. åœ¨ ContainerRegistry ä¸­æ³¨å†Œ
/// 3. æ— éœ€ä¿®æ”¹æœ¬ç±»
/// 
/// ã€ç›¸å…³æ–‡æ¡£ã€‘
/// - æ¶æ„è®¾è®¡ï¼š.kiro/architecture/container-system.md
/// - äº¤äº’çŸ©é˜µï¼š.kiro/specs/ç®±å­ç³»ç»Ÿ/äº¤äº’åœºæ™¯çŸ©é˜µ.md
/// </summary>
public class ContainerInteractionManager : MonoBehaviour
{
    // ...
}
```

### 3.5 æµ‹è¯•é©±åŠ¨çš„å¯é æ€§

```csharp
/// <summary>
/// å®¹å™¨äº¤äº’æµ‹è¯•
/// 
/// ã€æµ‹è¯•è¦†ç›–ã€‘
/// - èƒŒåŒ…å†…æ‹–æ‹½
/// - ç®±å­å†…æ‹–æ‹½
/// - è·¨å®¹å™¨æ‹–æ‹½ï¼ˆèƒŒåŒ…â†”ç®±å­ï¼‰
/// - ä¿®é¥°é”®æ‹¿å–ï¼ˆShift/Ctrlï¼‰
/// - ä¸¢å¼ƒï¼ˆåƒåœ¾æ¡¶/é¢æ¿å¤–ï¼‰
/// - å–æ¶ˆï¼ˆESCï¼‰
/// - è¾¹ç•Œæƒ…å†µï¼ˆç©ºæ§½ä½ã€æ»¡æ§½ä½ã€å †å æº¢å‡ºï¼‰
/// </summary>
[TestFixture]
public class ContainerInteractionTests
{
    [Test]
    public void TryPickup_EmptySlot_ReturnsFalse()
    {
        var container = CreateMockContainer(capacity: 10);
        var manager = new ContainerInteractionManager();
        
        var result = manager.TryPickup(container, 0, PickupMode.Shift);
        
        Assert.IsFalse(result);
    }
    
    [Test]
    public void TryPlace_ToEmptySlot_Succeeds()
    {
        // ...
    }
    
    // ... æ›´å¤šæµ‹è¯•
}
```

---

## å››ã€é‡æ„è·¯çº¿å›¾

### 4.1 é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | å†…å®¹ | å·¥ä½œé‡ | é£é™© |
|------|------|--------|------|
| Phase 0 | æœ€å°ä¾µå…¥ä¿®å¤ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰ | 1-2 å¤© | æä½ |
| Phase 1 | æå–æœåŠ¡å±‚ï¼ˆItemDropServiceï¼‰ | 1 å¤© | ä½ |
| Phase 2 | ç»Ÿä¸€äº¤äº’ç®¡ç†å™¨ | 3-5 å¤© | ä¸­ |
| Phase 3 | é‡æ„ UI å±‚ï¼ˆContainerPanelBaseï¼‰ | 3-5 å¤© | ä¸­ |
| Phase 4 | å®Œå–„æ–‡æ¡£å’Œæµ‹è¯• | 2-3 å¤© | ä½ |

### 4.2 Phase 0ï¼šæœ€å°ä¾µå…¥ä¿®å¤ï¼ˆæ¨èç«‹å³æ‰§è¡Œï¼‰

**ç›®æ ‡**ï¼šä¿®å¤å½“å‰é—®é¢˜ï¼Œä¸æ”¹å˜æ¶æ„

**å†…å®¹**ï¼š
1. ç¼“å­˜ `FindFirstObjectByType` è°ƒç”¨
2. æ·»åŠ ä¸¤å¥— Held ç³»ç»Ÿäº’æ–¥æ£€æŸ¥
3. åˆ é™¤æ³¨é‡Šæ‰çš„æ—¥å¿—ä»£ç 
4. æå– `ItemDropHelper`ï¼ˆä¸º Phase 1 åšå‡†å¤‡ï¼‰

**å·¥ä½œé‡**ï¼š1-2 å¤©

### 4.3 Phase 1ï¼šæå–æœåŠ¡å±‚

**ç›®æ ‡**ï¼šå°†å…¬å…±é€»è¾‘æå–ä¸ºç‹¬ç«‹æœåŠ¡

**å†…å®¹**ï¼š
1. åˆ›å»º `ItemDropService`
2. åˆ›å»º `ItemTransferService`
3. ä¿®æ”¹ç°æœ‰ä»£ç è°ƒç”¨æœåŠ¡

**å·¥ä½œé‡**ï¼š1 å¤©

### 4.4 Phase 2ï¼šç»Ÿä¸€äº¤äº’ç®¡ç†å™¨

**ç›®æ ‡**ï¼šåˆå¹¶ `InventoryInteractionManager` å’Œ `SlotDragContext`

**å†…å®¹**ï¼š
1. åˆ›å»º `ContainerInteractionManager`
2. åˆ›å»º `InteractionContext`
3. è¿ç§»ç°æœ‰é€»è¾‘
4. åˆ é™¤ `SlotDragContext`
5. ä¿®æ”¹ `InventorySlotInteraction` ä½¿ç”¨æ–°ç®¡ç†å™¨

**å·¥ä½œé‡**ï¼š3-5 å¤©

### 4.5 Phase 3ï¼šé‡æ„ UI å±‚

**ç›®æ ‡**ï¼šç»Ÿä¸€å®¹å™¨é¢æ¿å®ç°

**å†…å®¹**ï¼š
1. åˆ›å»º `IContainerPanel` æ¥å£
2. åˆ›å»º `ContainerPanelBase` åŸºç±»
3. é‡æ„ `BoxPanelUI` ç»§æ‰¿åŸºç±»
4. é‡æ„ `InventoryPanelUI` ç»§æ‰¿åŸºç±»

**å·¥ä½œé‡**ï¼š3-5 å¤©

### 4.6 Phase 4ï¼šå®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

**ç›®æ ‡**ï¼šä¿éšœå¼€å‘è¿ç»­æ€§

**å†…å®¹**ï¼š
1. ç¼–å†™æ¶æ„æ–‡æ¡£
2. ç¼–å†™æ‰©å±•æŒ‡å—
3. ç¼–å†™å•å…ƒæµ‹è¯•
4. æ›´æ–° steering è§„åˆ™

**å·¥ä½œé‡**ï¼š2-3 å¤©

---

## äº”ã€å†³ç­–å»ºè®®

### 5.1 çŸ­æœŸï¼ˆæœ¬æ¬¡è¿­ä»£ï¼‰

**æ¨è**ï¼šæ‰§è¡Œ Phase 0ï¼ˆæœ€å°ä¾µå…¥ä¿®å¤ï¼‰

**ç†ç”±**ï¼š
- é£é™©æœ€ä½
- å·¥ä½œé‡æœ€å°
- ç«‹å³è§£å†³å½“å‰é—®é¢˜
- ä¸ºåç»­é‡æ„åšå‡†å¤‡

### 5.2 ä¸­æœŸï¼ˆä¸‹æ¬¡å¤§ç‰ˆæœ¬ï¼‰

**æ¨è**ï¼šæ‰§è¡Œ Phase 1 + Phase 2

**ç†ç”±**ï¼š
- ç»Ÿä¸€äº¤äº’ç®¡ç†å™¨æ˜¯æœ€æ ¸å¿ƒçš„æ”¹è¿›
- æ¶ˆé™¤ä¸¤å¥— Held ç³»ç»Ÿ
- ä¸ºæ–°å®¹å™¨ç±»å‹åšå¥½å‡†å¤‡

### 5.3 é•¿æœŸï¼ˆé¡¹ç›®æˆç†ŸæœŸï¼‰

**æ¨è**ï¼šæ‰§è¡Œ Phase 3 + Phase 4

**ç†ç”±**ï¼š
- UI å±‚é‡æ„éœ€è¦æ›´å¤šæ—¶é—´
- æ–‡æ¡£å’Œæµ‹è¯•æ˜¯é•¿æœŸæŠ•èµ„
- åœ¨é¡¹ç›®ç¨³å®šåè¿›è¡Œæ›´å®‰å…¨

---

## å…­ã€æ€»ç»“

### 6.1 å½“å‰æ¶æ„çš„æ ¸å¿ƒé—®é¢˜

1. **ä¸¤å¥— Held ç³»ç»Ÿå¹¶å­˜**ï¼š`InventoryInteractionManager` + `SlotDragContext`
2. **æ‰©å±•æ€§ä¸è¶³**ï¼šæ–°å¢å®¹å™¨ç±»å‹éœ€è¦ä¿®æ”¹å¤šå¤„ä»£ç 
3. **ä»£ç é‡å¤**ï¼šä¸¢å¼ƒé€»è¾‘ã€åƒåœ¾æ¡¶æ£€æµ‹ç­‰

### 6.2 ç†æƒ³æ¶æ„çš„æ ¸å¿ƒç‰¹ç‚¹

1. **ç»Ÿä¸€äº¤äº’ç®¡ç†å™¨**ï¼š`ContainerInteractionManager` æ”¯æŒä»»æ„ `IItemContainer`
2. **æœåŠ¡å±‚æŠ½è±¡**ï¼š`ItemDropService`ã€`ItemTransferService` ç­‰
3. **æ¥å£é©±åŠ¨**ï¼š`IItemContainer`ã€`IContainerPanel`
4. **æ–‡æ¡£å®Œå–„**ï¼šæ¶æ„æ–‡æ¡£ã€æ‰©å±•æŒ‡å—ã€æµ‹è¯•ç”¨ä¾‹

### 6.3 å¼€å‘è¿ç»­æ€§ä¿éšœ

1. **åˆ†å±‚æ–‡æ¡£ä½“ç³»**ï¼šsteeringï¼ˆå…¨å±€ï¼‰â†’ specsï¼ˆæ¨¡å—ï¼‰â†’ architectureï¼ˆæ¶æ„ï¼‰
2. **ä»£ç è‡ªæ–‡æ¡£åŒ–**ï¼šè¯¦ç»†çš„ XML æ³¨é‡Šï¼ŒåŒ…å«ä½¿ç”¨æ–¹å¼å’Œæ‰©å±•æŒ‡å—
3. **æµ‹è¯•é©±åŠ¨**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
4. **æ¸è¿›å¼é‡æ„**ï¼šåˆ†é˜¶æ®µæ‰§è¡Œï¼Œæ¯é˜¶æ®µå¯ç‹¬ç«‹éªŒæ”¶

---

**æ–‡æ¡£å®Œæˆ**
