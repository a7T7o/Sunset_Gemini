# èƒŒåŒ…ä¸ç®±å­ç³»ç»Ÿ - å…¨é¢æ·±åº¦å®¡æ ¸æŠ¥å‘Š

**å®¡æ ¸æ—¥æœŸ**: 2026-01-21  
**å®¡æ ¸èŒƒå›´**: èƒŒåŒ…æœåŠ¡å±‚ã€ç®±å­ç³»ç»Ÿã€UI äº¤äº’å±‚  
**å®¡æ ¸äºº**: Code Reaperï¼ˆç¬¬ä¸‰æ–¹è§†è§’ï¼‰

---

## ä¸€ã€å®¡æ ¸æ¦‚è¿°

æœ¬æ¬¡å®¡æ ¸ä»¥"æ¢äº†ä¸€ä¸ªäºº"çš„è§†è§’ï¼Œå¯¹æ•´ä¸ªèƒŒåŒ…å’Œç®±å­ç³»ç»Ÿè¿›è¡Œæ— æ¯”ä¸¥è°¨çš„å…¨é¢å®¡è§†ã€‚

### å®¡æ ¸èŒƒå›´

| å±‚çº§ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **æœåŠ¡å±‚** | `IItemContainer.cs` | å®¹å™¨æ¥å£ |
| | `InventoryService.cs` | èƒŒåŒ…æœåŠ¡ï¼ˆ36æ ¼ï¼‰ |
| | `ChestInventory.cs` | ç®±å­åº“å­˜ |
| **ä¸–ç•Œå±‚** | `ChestController.cs` | ç®±å­æ§åˆ¶å™¨ |
| **UIå±‚** | `BoxPanelUI.cs` | ç®±å­é¢æ¿ |
| | `InventorySlotUI.cs` | æ§½ä½ UI |
| | `InventorySlotInteraction.cs` | æ§½ä½äº¤äº’ |
| | `InventoryInteractionManager.cs` | äº¤äº’ç®¡ç†å™¨ |
| | `SlotDragContext.cs` | æ‹–æ‹½ä¸Šä¸‹æ–‡ |

---

## äºŒã€æ¶æ„åˆ†æ

### 2.1 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥                                  â”‚
â”‚  (å·¦é”®/å³é”®/Shift/Ctrl/æ‹–æ‹½/ESC)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     UI äº¤äº’å±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  InventorySlotInteraction                                       â”‚
â”‚  â”œâ”€â”€ èƒŒåŒ…æ§½ä½ â†’ InventoryInteractionManager                     â”‚
â”‚  â””â”€â”€ ç®±å­æ§½ä½ â†’ SlotDragContext                                 â”‚
â”‚                                                                 â”‚
â”‚  InventoryInteractionManager (çŠ¶æ€æœº)                           â”‚
â”‚  â”œâ”€â”€ Idle â†’ HeldByShift/HeldByCtrl/Dragging                    â”‚
â”‚  â””â”€â”€ åªè®¤è¯† InventoryService                                    â”‚
â”‚                                                                 â”‚
â”‚  SlotDragContext (é™æ€ç±»)                                       â”‚
â”‚  â””â”€â”€ è·¨å®¹å™¨æ‹–æ‹½ï¼Œæ”¯æŒ IItemContainer                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®å±‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IItemContainer (æ¥å£)                                          â”‚
â”‚  â”œâ”€â”€ InventoryService (36æ ¼ï¼Œ0-11=Hotbar)                       â”‚
â”‚  â””â”€â”€ ChestInventory (12/24/36/48æ ¼)                             â”‚
â”‚                                                                 â”‚
â”‚  ItemStack (å€¼ç±»å‹)                                             â”‚
â”‚  â””â”€â”€ itemId, quality, amount                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.2 æ ¸å¿ƒé—®é¢˜ï¼šä¸¤å¥— Held ç³»ç»Ÿå¹¶å­˜

**è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€ä¸¥é‡çš„æ¶æ„é—®é¢˜ã€‚**

| ç³»ç»Ÿ | ç®¡ç†èŒƒå›´ | çŠ¶æ€å­˜å‚¨ | é—®é¢˜ |
|------|---------|---------|------|
| `InventoryInteractionManager` | èƒŒåŒ…æ§½ä½ | å®ä¾‹å­—æ®µ `heldItem` | åªè®¤è¯† `InventoryService` |
| `SlotDragContext` | ç®±å­æ§½ä½ + è·¨å®¹å™¨ | é™æ€å­—æ®µ | ä¸ Manager ä¸äº’é€š |

**åæœ**ï¼š
1. ç®±å­æ§½ä½çš„ Shift/Ctrl æ‹¿å–æ— æ³•ä½¿ç”¨ Manager çš„çŠ¶æ€æœº
2. ä¸¤å¥—ç³»ç»Ÿçš„"Held çŠ¶æ€"å¯èƒ½åŒæ—¶å­˜åœ¨
3. ä»£ç é‡å¤ï¼ˆä¸¢å¼ƒé€»è¾‘ã€åƒåœ¾æ¡¶æ£€æµ‹ç­‰ï¼‰

---

## ä¸‰ã€æœåŠ¡å±‚å®¡æ ¸

### 3.1 IItemContainer æ¥å£

**è¯„ä»·ï¼šâœ… è®¾è®¡è‰¯å¥½**

```csharp
public interface IItemContainer
{
    int Capacity { get; }
    ItemDatabase Database { get; }
    event Action<int> OnSlotChanged;
    event Action OnInventoryChanged;
    ItemStack GetSlot(int index);
    bool SetSlot(int index, ItemStack stack);
    void ClearSlot(int index);
    bool SwapOrMerge(int a, int b);
    int GetMaxStack(int itemId);
    void Sort();
}
```

**ä¼˜ç‚¹**ï¼š
- ç»Ÿä¸€äº† `InventoryService` å’Œ `ChestInventory` çš„è®¿é—®æ–¹å¼
- æä¾›äº†äº‹ä»¶ç³»ç»Ÿæ”¯æŒ UI å“åº”
- æ¥å£ç®€æ´ï¼ŒèŒè´£æ˜ç¡®

**ç¼ºå¤±**ï¼š
- æ²¡æœ‰ `ContainerType` å±æ€§ï¼ˆæ— æ³•åŒºåˆ†å®¹å™¨ç±»å‹ï¼‰
- æ²¡æœ‰ `IsReadOnly` å±æ€§ï¼ˆå•†åº—ç­‰åªè¯»å®¹å™¨ï¼‰
- æ²¡æœ‰ `CanAcceptItem()` æ–¹æ³•ï¼ˆæ§½ä½é™åˆ¶æ£€æŸ¥ï¼‰

---

### 3.2 InventoryService

**è¯„ä»·ï¼šâ­â­â­â­ è‰¯å¥½**

**ä¼˜ç‚¹**ï¼š
1. æ¸…æ™°çš„ 36 æ ¼å¸ƒå±€ï¼ˆ0-11 = Hotbarï¼‰
2. `AddItem` ä¼˜å…ˆçº§æ­£ç¡®ï¼ˆå…ˆå åŠ ç¬¬ä¸€è¡Œï¼Œå†ç©ºä½ç¬¬ä¸€è¡Œï¼Œå†å…¶ä½™ï¼‰
3. `CanAddItem` é¢„æ£€æŸ¥æ–¹æ³•ï¼ˆæ‹¾å–å‰æ£€æŸ¥ç©ºé—´ï¼‰
4. `Sort` åªæ’åºç¬¬äºŒã€ä¸‰è¡Œï¼Œä¿æŠ¤ Hotbar

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `Sort()` æœ«å°¾çš„ `Debug.Log` | ğŸŸ¡ P1 | åº”å—å¼€å…³æ§åˆ¶ |
| æ²¡æœ‰ `TransferTo()` æ–¹æ³• | ğŸŸ¢ P2 | è·¨å®¹å™¨è½¬ç§»éœ€è¦å¤–éƒ¨å®ç° |

---

### 3.3 ChestInventory

**è¯„ä»·ï¼šâ­â­â­â­ è‰¯å¥½**

**ä¼˜ç‚¹**ï¼š
1. é MonoBehaviourï¼Œç”± `ChestController` æŒæœ‰
2. å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿï¼ˆ`OnSlotChanged`, `OnInventoryChanged`ï¼‰
3. `TransferFromInventory` / `TransferToInventory` è·¨å®¹å™¨æ–¹æ³•
4. `Sort()` å®ç°ä¸ `InventoryService` ä¸€è‡´

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `_database` å¯èƒ½ä¸º null | ğŸŸ¡ P1 | æ„é€ æ—¶å¯é€‰ï¼Œéœ€è¦åç»­ `SetDatabase()` |
| `Sort()` æœ«å°¾æ— æ—¥å¿— | ğŸŸ¢ P2 | ä¸ `InventoryService` ä¸ä¸€è‡´ |

---

## å››ã€ä¸–ç•Œå±‚å®¡æ ¸

### 4.1 ChestController

**è¯„ä»·ï¼šâ­â­â­ ä¸­ç­‰**

**ä¼˜ç‚¹**ï¼š
1. å®ç° `IResourceNode` å’Œ `IInteractable` æ¥å£
2. å®Œæ•´çš„é”ç³»ç»Ÿï¼ˆä¸Šé”/è§£é”/å½’å±ï¼‰
3. Sprite åº•éƒ¨å¯¹é½ï¼ˆ`ApplySpriteWithBottomAlign`ï¼‰
4. Collider åŒæ­¥æ›´æ–°ï¼ˆ`UpdateColliderShape`ï¼‰
5. NavGrid åˆ·æ–°è¯·æ±‚

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `FindFirstObjectByType` åœ¨ `OpenBoxUI()` | ğŸ”´ P0 | æ¯æ¬¡æ‰“å¼€éƒ½æŸ¥æ‰¾ |
| 948 è¡Œä»£ç ï¼ŒèŒè´£è¿‡å¤š | ğŸŸ¡ P1 | åº”æ‹†åˆ†ä¸ºå¤šä¸ªç»„ä»¶ |
| `showDebugInfo` é»˜è®¤ false ä½†æ—¥å¿—ä»è¾“å‡º | ğŸŸ¡ P1 | éƒ¨åˆ†æ—¥å¿—æœªå—æ§åˆ¶ |

**ä»£ç ç‰‡æ®µé—®é¢˜**ï¼š

```csharp
// ChestController.OpenBoxUI() ä¸­
var packageTabs = FindFirstObjectByType<PackagePanelTabsUI>(FindObjectsInactive.Include);
var canvas = FindFirstObjectByType<Canvas>();
```

**å»ºè®®**ï¼šç¼“å­˜è¿™äº›å¼•ç”¨ï¼Œæˆ–ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚

---

## äº”ã€UI å±‚å®¡æ ¸

### 5.1 BoxPanelUI

**è¯„ä»·ï¼šâ­â­â­ ä¸­ç­‰**

**ä¼˜ç‚¹**ï¼š
1. åªåšæ•°æ®ç»‘å®šï¼Œä¸ç”Ÿæˆ/é”€æ¯æ§½ä½ï¼ˆæ­£ç¡®çš„è®¾è®¡ï¼‰
2. è®¢é˜… `ChestInventory` å’Œ `InventoryService` äº‹ä»¶
3. `EnsureDatabaseReference` é˜²å¾¡æ€§è·å– `_database`
4. Sort åæ¸…ç©ºé€‰ä¸­çŠ¶æ€

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `FindFirstObjectByType` å¤šå¤„è°ƒç”¨ | ğŸ”´ P0 | `Start()`, `RefreshInventorySlots()` ç­‰ |
| `_hasLoggedBindFailure` é™æ€æ ‡å¿— | ğŸŸ¡ P1 | åœºæ™¯åˆ‡æ¢åä¸é‡ç½® |
| `DropItemFromContext()` é‡å¤å®ç° | ğŸŸ¡ P1 | ä¸ `InventorySlotInteraction` é‡å¤ |

---

### 5.2 InventorySlotUI

**è¯„ä»·ï¼šâ­â­â­â­ è‰¯å¥½**

**ä¼˜ç‚¹**ï¼š
1. æ”¯æŒ `IItemContainer` æ¥å£ï¼ˆ`BindContainer` æ–¹æ³•ï¼‰
2. è‡ªåŠ¨æ·»åŠ  `InventorySlotInteraction` ç»„ä»¶
3. äº‹ä»¶è®¢é˜…/å–æ¶ˆè®¢é˜…æ­£ç¡®
4. `Select()` / `Deselect()` æ–¹æ³•æ”¯æŒé€‰ä¸­çŠ¶æ€

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `OnEnable` ä¸è‡ªåŠ¨åˆ·æ–° | ğŸŸ¢ P2 | æ³¨é‡Šè¯´æ˜æ˜¯æ•…æ„çš„ï¼Œä½†å¯èƒ½å¯¼è‡´æ˜¾ç¤ºä¸åŒæ­¥ |

---

### 5.3 InventorySlotInteraction

**è¯„ä»·ï¼šâ­â­â­ ä¸­ç­‰**

**ä¼˜ç‚¹**ï¼š
1. å®ç° Unity åŸç”Ÿäº‹ä»¶æ¥å£ï¼ˆIPointerDownHandler ç­‰ï¼‰
2. å››è±¡é™æ‹–æ‹½æ”¯æŒï¼ˆUpâ†’Up, Upâ†’Down, Downâ†’Up, Downâ†’Downï¼‰
3. é€‰ä¸­çŠ¶æ€ä¼˜åŒ–ï¼ˆè·¨åŒºåŸŸæ”¾ç½®æ—¶æ¸…ç©ºæºåŒºåŸŸé€‰ä¸­ï¼‰

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| `FindFirstObjectByType` å¤šå¤„è°ƒç”¨ | ğŸ”´ P0 | `ShowDragIcon`, `DropItemFromContext`, `IsOverTrashCan` ç­‰ |
| ç®±å­æ§½ä½ä¿®é¥°é”®å¤„ç†ç‹¬ç«‹äº Manager | ğŸ”´ P0 | `HandleChestSlotModifierClick` ç»•è¿‡ Manager |
| åƒåœ¾æ¡¶æ£€æµ‹é€»è¾‘å¤æ‚ | ğŸŸ¡ P1 | éœ€è¦æŸ¥æ‰¾ä¸¤ä¸ªé¢æ¿ |

**å…³é”®ä»£ç é—®é¢˜**ï¼š

```csharp
// HandleChestSlotModifierClick - ç®±å­æ§½ä½çš„ Shift/Ctrl æ‹¿å–
// è¿™æ®µä»£ç ç»•è¿‡äº† InventoryInteractionManagerï¼Œä½¿ç”¨ SlotDragContext
private void HandleChestSlotModifierClick(bool shift, bool ctrl)
{
    // ...
    SlotDragContext.Begin(chest, index, pickupItem);
    ShowDragIcon(pickupItem);
}
```

**é—®é¢˜**ï¼šè¿™å¯¼è‡´ç®±å­æ§½ä½çš„ Shift/Ctrl æ‹¿å–ä¸èƒŒåŒ…æ§½ä½è¡Œä¸ºä¸ä¸€è‡´ã€‚

---

### 5.4 InventoryInteractionManager

**è¯„ä»·ï¼šâ­â­â­â­ è‰¯å¥½**

**ä¼˜ç‚¹**ï¼š
1. æ¸…æ™°çš„çŠ¶æ€æœºï¼ˆIdle, HeldByShift, HeldByCtrl, Draggingï¼‰
2. ç»Ÿä¸€çš„ Held å›¾æ ‡æ¥å£ï¼ˆ`ShowHeldIcon`, `HideHeldIcon`ï¼‰
3. å®Œæ•´çš„æ”¾ç½®é€»è¾‘ï¼ˆç©ºæ§½ä½ã€å †å ã€äº¤æ¢ï¼‰
4. Sort åæ¸…ç©ºé€‰ä¸­çŠ¶æ€

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| åªè®¤è¯† `InventoryService` | ğŸ”´ P0 | æ— æ³•å¤„ç† `ChestInventory` |
| `FindFirstObjectByType` åœ¨ `DropItem()` | ğŸŸ¡ P1 | æ¯æ¬¡ä¸¢å¼ƒéƒ½æŸ¥æ‰¾ |
| å¤§é‡æ³¨é‡Šæ‰çš„æ—¥å¿—ä»£ç  | ğŸŸ¡ P1 | å½±å“å¯è¯»æ€§ |

**æ ¸å¿ƒé™åˆ¶**ï¼š

```csharp
// Manager çš„ GetSlot/SetSlot åªæ”¯æŒ InventoryService å’Œ EquipmentService
private ItemStack GetSlot(int index, bool isEquip)
{
    return isEquip ? equipment.GetEquip(index) : inventory.GetSlot(index);
}
```

**è¿™æ˜¯ Manager æ— æ³•å¤„ç†ç®±å­æ§½ä½çš„æ ¹æœ¬åŸå› ã€‚**

---

### 5.5 SlotDragContext

**è¯„ä»·ï¼šâ­â­â­ ä¸­ç­‰**

**ä¼˜ç‚¹**ï¼š
1. æ”¯æŒ `IItemContainer` æ¥å£
2. é™æ€ç±»ï¼Œå…¨å±€è®¿é—®
3. `Cancel()` æ–¹æ³•æ­£ç¡®è¿”å›ç‰©å“

**é—®é¢˜**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| é™æ€ç±»æ— æ³•æ”¯æŒå¤šå®ä¾‹ | ğŸŸ¡ P1 | åˆ†å±åœºæ™¯æ— æ³•ä½¿ç”¨ |
| ä¸ Manager ä¸äº’é€š | ğŸ”´ P0 | ä¸¤å¥— Held ç³»ç»Ÿ |


---

## å…­ã€é—®é¢˜æ±‡æ€»

### 6.1 P0 - ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ |
|---|------|------|------|
| 1 | **ä¸¤å¥— Held ç³»ç»Ÿå¹¶å­˜** | æ¶æ„å±‚é¢ | ç®±å­æ§½ä½äº¤äº’ä¸èƒŒåŒ…ä¸ä¸€è‡´ |
| 2 | **`FindFirstObjectByType` æ»¥ç”¨** | å¤šå¤„ | æ€§èƒ½é—®é¢˜ï¼Œä¾èµ–å…³ç³»ä¸æ˜ç¡® |
| 3 | **Manager åªè®¤è¯† InventoryService** | `InventoryInteractionManager` | æ— æ³•æ‰©å±•åˆ°å…¶ä»–å®¹å™¨ |
| 4 | **ç®±å­æ§½ä½ä¿®é¥°é”®ç»•è¿‡ Manager** | `InventorySlotInteraction` | è¡Œä¸ºä¸ä¸€è‡´ |

### 6.2 P1 - ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ |
|---|------|------|------|
| 5 | ä¸¢å¼ƒé€»è¾‘é‡å¤ä¸‰å¤„ | å¤šå¤„ | ç»´æŠ¤æˆæœ¬é«˜ |
| 6 | åƒåœ¾æ¡¶æ£€æµ‹é€»è¾‘å¤æ‚ | `InventorySlotInteraction` | ä»£ç å†—ä½™ |
| 7 | é™æ€æ ‡å¿—åœºæ™¯åˆ‡æ¢ä¸é‡ç½® | `BoxPanelUI` | é”™è¯¯è¢«é™é»˜ |
| 8 | æ³¨é‡Šæ‰çš„æ—¥å¿—ä»£ç  | `InventoryInteractionManager` | å¯è¯»æ€§å·® |
| 9 | `ChestController` èŒè´£è¿‡å¤š | `ChestController` | 948 è¡Œä»£ç  |

### 6.3 P2 - è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ |
|---|------|------|------|
| 10 | `Sort()` æ—¥å¿—ä¸ä¸€è‡´ | `InventoryService` vs `ChestInventory` | è°ƒè¯•ä¸ä¾¿ |
| 11 | `SlotDragContext` é™æ€ç±» | `SlotDragContext` | æ— æ³•æ”¯æŒå¤šå®ä¾‹ |
| 12 | `IItemContainer` ç¼ºå°‘æ‰©å±•å±æ€§ | `IItemContainer` | æœªæ¥æ‰©å±•å—é™ |

---

## ä¸ƒã€æ ¹æœ¬åŸå› åˆ†æ

### 7.1 ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤å¥— Held ç³»ç»Ÿï¼Ÿ

**å†å²æ¼”è¿›**ï¼š

1. **åˆæœŸ**ï¼šåªæœ‰èƒŒåŒ…ï¼Œ`InventoryInteractionManager` ç®¡ç†æ‰€æœ‰äº¤äº’
2. **ä¸­æœŸ**ï¼šç®±å­éœ€æ±‚å‡ºç°ï¼ŒManager åªè®¤è¯† `InventoryService`
3. **åæœŸ**ï¼šä¸ºäº†"æœ€å°ä¾µå…¥"ï¼Œæ–°å»º `SlotDragContext` å¤„ç†ç®±å­

**æ ¹æœ¬åŸå› **ï¼š`InventoryInteractionManager` è®¾è®¡æ—¶æ²¡æœ‰é¢„ç•™æ‰©å±•ç‚¹ã€‚

### 7.2 ä¸ºä»€ä¹ˆ `FindFirstObjectByType` è¢«æ»¥ç”¨ï¼Ÿ

1. **å¿«é€Ÿå¼€å‘**ï¼šæœ€ç®€å•çš„è·å–å¼•ç”¨æ–¹å¼
2. **è¯¯è§£è§£è€¦**ï¼šè®¤ä¸º"ä¸æŒæœ‰å¼•ç”¨ = è§£è€¦"
3. **ç¼ºä¹æ€§èƒ½æ„è¯†**ï¼šå°åœºæ™¯ä¸­é—®é¢˜ä¸æ˜æ˜¾

### 7.3 ä¸ºä»€ä¹ˆä¸¢å¼ƒé€»è¾‘é‡å¤ä¸‰å¤„ï¼Ÿ

1. **ç¬¬ä¸€æ¬¡**ï¼š`InventoryInteractionManager.DropItem()` - èƒŒåŒ…ä¸¢å¼ƒ
2. **ç¬¬äºŒæ¬¡**ï¼š`InventorySlotInteraction.DropItemFromContext()` - ä¸ºæ”¯æŒ `SlotDragContext`
3. **ç¬¬ä¸‰æ¬¡**ï¼š`BoxPanelUI.DropItemFromContext()` - ä¸ºæ”¯æŒåƒåœ¾æ¡¶ç‚¹å‡»

**æ ¹æœ¬åŸå› **ï¼šç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶æ²¡æœ‰æå–å…¬å…±æ–¹æ³•ã€‚

---

## å…«ã€æ”¹è¿›å»ºè®®

### 8.1 çŸ­æœŸï¼ˆæœ€å°ä¾µå…¥ï¼‰

| ä¼˜å…ˆçº§ | æ”¹è¿› | å·¥ä½œé‡ | é£é™© |
|--------|------|--------|------|
| P0 | ç¼“å­˜ `FindFirstObjectByType` è°ƒç”¨ | ä½ | æä½ |
| P0 | æ·»åŠ ä¸¤å¥— Held ç³»ç»Ÿäº’æ–¥æ£€æŸ¥ | æä½ | æä½ |
| P1 | æå–å…¬å…±ä¸¢å¼ƒæ–¹æ³• `ItemDropHelper` | ä½ | ä½ |
| P1 | åˆ é™¤æ³¨é‡Šæ‰çš„æ—¥å¿—ä»£ç  | æä½ | æ—  |

### 8.2 ä¸­æœŸï¼ˆæ¶æ„ä¼˜åŒ–ï¼‰

| ä¼˜å…ˆçº§ | æ”¹è¿› | å·¥ä½œé‡ | é£é™© |
|--------|------|--------|------|
| P0 | æ‰©å±• Manager æ”¯æŒ `IItemContainer` | ä¸­ | ä¸­ |
| P1 | åˆå¹¶ `SlotDragContext` åˆ° Manager | ä¸­ | ä¸­ |
| P1 | ç»Ÿä¸€åƒåœ¾æ¡¶æ£€æµ‹æœºåˆ¶ | ä½ | ä½ |

### 8.3 é•¿æœŸï¼ˆé‡æ„ï¼‰

| ä¼˜å…ˆçº§ | æ”¹è¿› | å·¥ä½œé‡ | é£é™© |
|--------|------|--------|------|
| P1 | åˆ›å»º `ContainerInteractionManager` | é«˜ | ä¸­ |
| P2 | å¼•å…¥ä¾èµ–æ³¨å…¥ | é«˜ | ä¸­ |
| P2 | æ‹†åˆ† `ChestController` | ä¸­ | ä½ |

---

## ä¹ã€æ•°æ®æµè¯¦è§£

### 9.1 èƒŒåŒ…æ§½ä½ç‚¹å‡»æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»èƒŒåŒ…æ§½ä½
    â†“
InventorySlotInteraction.OnPointerDown()
    â†“
æ£€æŸ¥ SlotDragContext.IsDragging? â†’ æ˜¯ â†’ HandleSlotDragContextClick()
    â†“ å¦
æ£€æŸ¥ Manager.IsHolding? â†’ æ˜¯ â†’ HandleManagerHeldClick()
    â†“ å¦
æ£€æŸ¥ IsChestSlot? â†’ æ˜¯ â†’ HandleChestSlotModifierClick() [ç»•è¿‡ Manager!]
    â†“ å¦
Manager.OnSlotPointerDown()
    â†“
Manager çŠ¶æ€æœºå¤„ç†
```

### 9.2 ç®±å­æ§½ä½ Shift æ‹¿å–æµç¨‹

```
ç”¨æˆ· Shift+ç‚¹å‡»ç®±å­æ§½ä½
    â†“
InventorySlotInteraction.OnPointerDown()
    â†“
IsChestSlot = true, shift = true
    â†“
HandleChestSlotModifierClick(shift=true, ctrl=false)
    â†“
SlotDragContext.Begin(chest, index, pickupItem)  [ä¸ç»è¿‡ Manager!]
    â†“
ShowDragIcon(pickupItem)
```

**é—®é¢˜**ï¼šè¿™ä¸ªæµç¨‹å®Œå…¨ç»•è¿‡äº† `InventoryInteractionManager`ï¼Œå¯¼è‡´ï¼š
1. Manager ä¸çŸ¥é“æœ‰ç‰©å“è¢«æ‹¿èµ·
2. å¦‚æœæ­¤æ—¶ç‚¹å‡»èƒŒåŒ…æ§½ä½ï¼ŒManager ä¼šè®¤ä¸ºæ˜¯ Idle çŠ¶æ€
3. ä¸¤å¥—ç³»ç»Ÿå¯èƒ½åŒæ—¶æŒæœ‰ç‰©å“

### 9.3 è·¨å®¹å™¨æ‹–æ‹½æµç¨‹

```
ç”¨æˆ·ä»ç®±å­æ‹–æ‹½ç‰©å“åˆ°èƒŒåŒ…
    â†“
InventorySlotInteraction.OnBeginDrag()
    â†“
SlotDragContext.Begin(chest, index, item)
    â†“
ç”¨æˆ·æ‹–æ‹½åˆ°èƒŒåŒ…æ§½ä½
    â†“
InventorySlotInteraction.OnDrop()
    â†“
HandleSlotDragContextDrop()
    â†“
HandleChestToInventoryDrop()
    â†“
inventory.SetSlot(invIndex, draggedItem)
```

**è¿™ä¸ªæµç¨‹æ˜¯æ­£ç¡®çš„**ï¼Œå› ä¸ºä½¿ç”¨äº† `SlotDragContext`ã€‚

---

## åã€å®¡æ ¸ç»“è®º

### 10.1 æ•´ä½“è¯„ä»·

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | â­â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œè¾¹ç•Œæƒ…å†µå¤„ç†è‰¯å¥½ |
| **ä»£ç è´¨é‡** | â­â­â­ | èŒè´£åˆ†ç¦»æ¸…æ™°ï¼Œä½†æœ‰é‡å¤ä»£ç  |
| **æ¶æ„è®¾è®¡** | â­â­ | ä¸¤å¥— Held ç³»ç»Ÿæ˜¯ä¸¥é‡é—®é¢˜ |
| **æ€§èƒ½** | â­â­â­ | `FindFirstObjectByType` æ»¥ç”¨ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­ | æ³¨é‡Šä»£ç å¤šï¼Œéƒ¨åˆ†é€»è¾‘å¤æ‚ |
| **å¯æ‰©å±•æ€§** | â­â­ | Manager åªè®¤è¯† InventoryService |

### 10.2 æ ¸å¿ƒé—®é¢˜æ€»ç»“

1. **æ¶æ„åˆ†è£‚**ï¼šä¸¤å¥— Held ç³»ç»Ÿå¹¶å­˜ï¼Œäº’ä¸é€šä¿¡
2. **æ‰©å±•æ€§å·®**ï¼šManager æ— æ³•å¤„ç†æ–°çš„å®¹å™¨ç±»å‹
3. **ä»£ç é‡å¤**ï¼šä¸¢å¼ƒé€»è¾‘ã€åƒåœ¾æ¡¶æ£€æµ‹ç­‰
4. **æ€§èƒ½éšæ‚£**ï¼š`FindFirstObjectByType` æ»¥ç”¨

### 10.3 å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³**ï¼šæ·»åŠ äº’æ–¥æ£€æŸ¥ï¼Œé˜²æ­¢ä¸¤å¥—ç³»ç»ŸåŒæ—¶æ¿€æ´»
2. **çŸ­æœŸ**ï¼šç¼“å­˜å¼•ç”¨ï¼Œæå–å…¬å…±æ–¹æ³•
3. **ä¸­æœŸ**ï¼šæ‰©å±• Manager æ”¯æŒ `IItemContainer`
4. **é•¿æœŸ**ï¼šç»Ÿä¸€äº¤äº’ç®¡ç†å™¨ï¼Œæ¶ˆé™¤ `SlotDragContext`

---

**å®¡æ ¸å®Œæˆ**

*Code Reaper - 2026-01-21*
