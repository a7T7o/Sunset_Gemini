# 选中状态交互优化 - 验收指南

## 概述

本文档用于验收背包和箱子 UI 的选中状态（Toggle 红框）交互优化功能。

---

## 前置条件

- [ ] Unity 编译通过，无新增错误
- [ ] 背包中有多种物品（至少 2 种，每种数量 ≥ 10）
- [ ] 场景中有可交互的箱子

---

## 功能验收清单

### 1. Toggle 基础行为（P2）

- [ ] **1.1** 左键单击空槽位 → 该槽位显示红框（选中）
- [ ] **1.2** 左键单击已选中槽位 → 红框消失（取消选中）
- [ ] **1.3** 左键单击其他槽位 → 原槽位红框消失，新槽位显示红框（互斥）
- [ ] **1.4** 背包区域和箱子区域各自独立管理选中状态

### 2. 放置后选中目标槽位（P1）

#### 2.1 同区域放置

- [ ] **2.1.1** 背包内拖拽物品到空槽位 → 目标槽位显示红框
- [ ] **2.1.2** 背包内拖拽物品到有物品槽位（交换）→ 目标槽位显示红框
- [ ] **2.1.3** 背包内拖拽物品到相同物品槽位（堆叠）→ 目标槽位显示红框
- [ ] **2.1.4** 箱子内拖拽物品到空槽位 → 目标槽位显示红框
- [ ] **2.1.5** 箱子内拖拽物品到有物品槽位（交换）→ 目标槽位显示红框

#### 2.2 跨区域放置

- [ ] **2.2.1** 背包 → 箱子空槽位 → 源槽位红框消失，目标槽位显示红框
- [ ] **2.2.2** 背包 → 箱子有物品槽位（交换）→ 源槽位红框消失，目标槽位显示红框
- [ ] **2.2.3** 箱子 → 背包空槽位 → 源槽位红框消失，目标槽位显示红框
- [ ] **2.2.4** 箱子 → 背包有物品槽位（交换）→ 源槽位红框消失，目标槽位显示红框

### 3. Ctrl+长按拿取数量显示（P0）

- [ ] **3.1** Ctrl+长按槽位（10 个物品）直到拿完 → 手上显示 10 个
- [ ] **3.2** 将手上 10 个物品放置到空槽位 → 槽位显示 10 个
- [ ] **3.3** 拿取过程中数量实时更新

### 4. Sort 后清空选中状态（P1）

#### 4.1 箱子 UI

- [ ] **4.1.1** 选中箱子 Up 区域某个槽位 → 点击 Sort 按钮 → 红框消失
- [ ] **4.1.2** 选中箱子 Down 区域某个槽位 → 点击 Sort 按钮 → 红框消失

#### 4.2 背包面板

- [ ] **4.2.1** 选中背包某个槽位 → 点击 Sort 按钮 → 红框消失

### 5. 跨区域拖拽清空源区域（P1）

- [ ] **5.1** 背包 → 箱子：源区域（背包）所有红框消失
- [ ] **5.2** 箱子 → 背包：源区域（箱子）所有红框消失

---

## 测试步骤

### 测试 1：Toggle 基础行为

1. 打开背包面板（Tab 键）
2. 左键单击任意空槽位，观察红框
3. 左键单击同一槽位，观察红框消失
4. 左键单击另一个槽位，观察红框切换

### 测试 2：同区域拖拽

1. 打开背包面板
2. 拖拽一个物品到空槽位
3. 观察目标槽位是否显示红框
4. 重复测试交换和堆叠场景

### 测试 3：跨区域拖拽

1. 打开箱子 UI（右键点击箱子）
2. 从背包拖拽物品到箱子
3. 观察：背包源槽位红框消失，箱子目标槽位显示红框
4. 从箱子拖拽物品到背包
5. 观察：箱子源槽位红框消失，背包目标槽位显示红框

### 测试 4：Ctrl+长按拿取

1. 准备一个有 10 个物品的槽位
2. Ctrl+长按该槽位，直到物品全部拿完
3. 观察手上物品数量是否显示 10
4. 将物品放置到空槽位
5. 观察槽位是否显示 10 个物品

### 测试 5：Sort 后清空选中状态

1. 打开箱子 UI
2. 选中箱子 Up 区域某个槽位（显示红框）
3. 点击 Up 区域的 Sort 按钮
4. 观察红框是否消失
5. 打开背包面板（Tab 键）
6. 选中背包某个槽位（显示红框）
7. 点击背包的 Sort 按钮
8. 观察红框是否消失

### 测试 6：跨区域拖拽清空源区域

1. 打开箱子 UI
2. 选中背包某个槽位（显示红框）
3. 从背包拖拽物品到箱子
4. 观察背包区域所有红框是否消失

---

## 预期结果

| 操作 | 预期结果 |
|------|---------|
| 左键单击槽位 | Toggle 自动管理选中/取消选中 |
| 同区域拖拽放置 | 目标槽位选中 |
| 跨区域拖拽放置 | 源槽位取消选中，目标槽位选中 |
| Ctrl+长按拿完 | 手上显示正确数量 |

---

## 已知限制

1. Shift/Ctrl 拿取后点击放置的选中状态由 `InventoryInteractionManager` 处理（背包槽位）
2. 装备槽位不参与选中状态管理

---

## 修改的文件

| 文件 | 修改内容 |
|------|---------|
| `InventoryInteractionManager.cs` | `ContinueCtrlPickup()` 在 break 前添加 `ShowHeld()`；`ClearAllSelection()` 改为调用 `InventoryPanelUI.ClearUpSelection()` |
| `SlotDragContext.cs` | 添加 `SourceSlotUI` 属性 |
| `InventorySlotInteraction.cs` | 添加 `SelectTargetSlot()` 和 `DeselectSourceSlot()` 方法，`DeselectSourceSlot()` 使用 `SetAllTogglesOff()` |
| `BoxPanelUI.cs` | 添加 `ClearUpSelections()` 和 `ClearDownSelections()` 方法，在 Sort 后调用 |
| `InventoryPanelUI.cs` | 添加 `ClearUpSelection()` 方法 |

---

**创建日期**: 2026-01-20
**最后更新**: 2026-01-20
**状态**: 待验收
