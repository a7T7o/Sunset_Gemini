# 背包 V4 飞升 - 调试与验收指南

## 版本信息

- **版本**: v1.1
- **日期**: 2026-01-06
- **状态**: 待用户验收

---

## 已完成的工作

### 1. 核心组件实现 ✅

- ✅ `InventorySlotInteraction.cs` - 交互传感器组件
- ✅ `InventoryInteractionManager.cs` - 交互逻辑管理器
- ✅ `HeldItemDisplay.cs` - 手持物品显示组件
- ✅ 集成到 `InventorySlotUI.cs` 和 `EquipmentSlotUI.cs`

### 2. 核心功能实现 ✅

- ✅ Shift+左键 二分拿取
- ✅ Shift 连续二分
- ✅ Ctrl+左键 单个拿取
- ✅ Ctrl 长按持续拿取（协程）
- ✅ 拖拽交换
- ✅ 快速装备
- ✅ 装备槽位限制
- ✅ 戒指装备策略
- ✅ ESC 取消
- ✅ 面板外丢弃

### 3. 辅助功能实现 ✅

- ✅ `PackagePanelTabsUI.CancelInteractionIfNeeded()` - 切换页面/关闭面板时取消交互

### 4. 调试功能实现 ✅

- ✅ 详细的彩色日志输出
- ✅ 完整的交互流程追踪
- ✅ 错误诊断和提示

---

## 场景配置要求

### ⚠️ 必须完成以下配置才能正常工作

#### 1. 添加 InventoryInteractionManager 到场景

在 `PackagePanel` 上添加 `InventoryInteractionManager` 组件，并配置：

**服务引用**：
- Inventory → `InventoryService`（场景中）
- Equipment → `EquipmentService`（场景中）
- Database → `Assets/Data/Database/MasterItemDatabase.asset`

**UI 引用**：
- Held Display → `HeldItemDisplay`（见下方）
- Panel Rect → `PackagePanel` 的 RectTransform
- Trash Can Rect → （可选）垃圾桶 UI

#### 2. 创建 HeldItemDisplay GameObject

**⚠️ 重要：HeldItemDisplay 不是预制体，而是场景中的 GameObject！**

在 `Canvas` 或 `PackagePanel` 下创建：

```
HeldItemDisplay (GameObject)
├── HeldItemDisplay (Component)
├── CanvasGroup (Component)
├── Icon (Image)
└── Amount (Text)
```

**详细配置步骤**：见 `场景配置指南.md`

---

## 验收流程

### 第一步：检查场景配置

运行游戏前，确认：

- [ ] `PackagePanel` 上有 `InventoryInteractionManager` 组件
- [ ] Manager 的所有引用都已配置（不为 None）
- [ ] `HeldItemDisplay` GameObject 存在于场景中
- [ ] `HeldItemDisplay` 的子物体 `Icon` 和 `Amount` 都存在
- [ ] `HeldItemDisplay` 有 `CanvasGroup` 组件

### 第二步：运行游戏并查看日志

1. 运行游戏
2. 打开背包
3. 按住 Shift，点击有物品的槽位
4. 查看 Console

**预期日志**：
```
[InventorySlotInteraction] OnPointerDown - button=Left, slotIndex=X, isEquip=False
[InventorySlotInteraction] Manager found: True
[InventoryInteractionManager] OnSlotPointerDown - index=X, isEquip=False
[InventoryInteractionManager] 修饰键状态 - Shift=True, Ctrl=False
[InventoryInteractionManager] 槽位物品 - itemId=X, amount=X, isEmpty=False
[InventoryInteractionManager] 触发 Shift 二分拿取
[InventoryInteractionManager] ShiftPickup - 原数量=X, 拿起=X
[InventoryInteractionManager] 状态切换为 HeldByShift, 源槽位=X
[InventoryInteractionManager] ShowHeld - itemId=X, amount=X, icon=XXX
[HeldItemDisplay] 显示物品: itemId=X, sprite=XXX, amount=X
```

### 第三步：测试核心功能

#### 测试 1：Shift 二分拿取

1. 找一个有 10 个物品的槽位
2. 按住 Shift，点击槽位
3. **预期结果**：
   - 手上拿起 5 个
   - 原槽位剩余 5 个
   - 鼠标旁边显示物品图标和数量 "5"

#### 测试 2：Shift 连续二分

1. 继续上一步（手上有 5 个）
2. 保持按住 Shift，再次点击同一槽位
3. **预期结果**：
   - 手上变为 2 个（5 的一半向下取整）
   - 原槽位变为 8 个（5 + 3）

#### 测试 3：Shift 放置

1. 继续上一步（手上有 2 个）
2. 松开 Shift，点击空槽位
3. **预期结果**：
   - 手上物品消失
   - 目标槽位显示 2 个物品

#### 测试 4：Ctrl 单个拿取

1. 找一个有 10 个物品的槽位
2. 按住 Ctrl，点击槽位
3. **预期结果**：
   - 手上拿起 1 个
   - 原槽位剩余 9 个

#### 测试 5：Ctrl 长按持续拿取

1. 继续上一步（手上有 1 个）
2. 保持按住 Ctrl 和鼠标左键，停留在同一槽位上
3. **预期结果**：
   - 每秒拿起约 3.5 个
   - 手上数量持续增加
   - 原槽位数量持续减少

#### 测试 6：拖拽交换

1. 按住左键（不按修饰键）
2. 拖拽到另一个槽位
3. **预期结果**：
   - 两个槽位的物品交换

#### 测试 7：快速装备

1. 找一个装备类物品（如头盔）
2. 按住 Ctrl，点击该物品
3. **预期结果**：
   - 物品直接装备到对应槽位
   - 如果已有装备，旧装备返回背包

#### 测试 8：ESC 取消

1. 拿起任意物品
2. 按 ESC 键
3. **预期结果**：
   - 手上物品消失
   - 物品返回原槽位

#### 测试 9：面板外丢弃

1. 拖拽物品到面板外
2. 松开鼠标
3. **预期结果**：
   - 手上物品消失
   - 玩家位置生成掉落物

#### 测试 10：切换页面取消交互

1. 拿起任意物品
2. 点击其他页面的 Tab（如 Map）
3. **预期结果**：
   - 手上物品消失
   - 物品返回原槽位
   - 页面切换成功

---

## 常见问题诊断

### 问题 1：Manager found: False

**原因**：`InventoryInteractionManager.Instance` 为 null

**解决方案**：
1. 检查 `PackagePanel` 上是否有 `InventoryInteractionManager` 组件
2. 检查组件是否被禁用
3. 检查 `Awake()` 是否正常执行

### 问题 2：点击槽位没有任何日志

**原因**：事件系统未正常工作

**解决方案**：
1. 检查槽位上的 Image 组件的 `Raycast Target` 是否勾选
2. 检查 Canvas 的 `Graphic Raycaster` 组件是否启用
3. 检查 `EventSystem` 是否存在于场景中

### 问题 3：有日志但看不到 HeldItemDisplay

**原因**：HeldItemDisplay 配置不正确

**解决方案**：
1. 检查 HeldItemDisplay 是否在 Canvas 下（不是预制体）
2. 检查 CanvasGroup 的 Alpha 是否被设置为 1
3. 检查 Icon 的 Sprite 是否正确赋值
4. 运行时选中 HeldItemDisplay，查看 Inspector 中的状态

### 问题 4：HeldItemDisplay 不跟随鼠标

**原因**：Update() 未正常执行或 Canvas 配置问题

**解决方案**：
1. 检查 HeldItemDisplay 组件是否启用
2. 检查 Canvas 的 Render Mode（推荐 Screen Space - Overlay）
3. 检查 HeldItemDisplay 的 GameObject 是否被激活

### 问题 5：拿起物品后数据不对

**原因**：数据层交互问题

**解决方案**：
1. 检查 Manager 的 Inventory 和 Equipment 引用是否正确
2. 检查 Database 引用是否正确
3. 查看日志中的 itemId 和 amount 是否正确

---

## 日志颜色说明

运行时 Console 会输出彩色日志：

- **青色**：事件触发和状态查询
- **绿色**：成功的操作
- **黄色**：警告或跳过的操作
- **红色**：错误

---

## 下一步

### 如果所有测试通过

1. 删除调试日志（可选）
2. 更新 memory.md 记录完成情况
3. 关闭此工作区

### 如果测试失败

1. 记录失败的测试项
2. 查看 Console 日志，找到失败的环节
3. 根据日志诊断问题
4. 反馈给开发者

---

## 遗漏功能说明

根据 V4 任务列表，以下功能**未实现**（标记为可选或低优先级）：

- ❌ 背包整理功能（任务 14）- 需要创建 `InventorySortService`
- ✅ PackagePanelTabsUI 取消交互（任务 15）- 已实现

如果需要背包整理功能，请单独提出需求。

---

## 技术细节

### 架构设计

```
Unity EventSystem
    ↓
InventorySlotInteraction (传感器 + 状态控制)
    ↓
InventoryInteractionManager (大脑)
    ↓
数据层 (InventoryService / EquipmentService)
    ↓
InventorySlotUI (显示) ← 监听数据变化自动刷新
```

### 状态机

```csharp
enum InteractionState
{
    None,           // 无交互
    Dragging,       // 拖拽中
    HeldByShift,    // Shift 拿取
    HeldByCtrl      // Ctrl 拿取
}
```

### 关键参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| dragTimeThreshold | 0.15f | 拖拽触发时间阈值（秒） |
| dragMoveThreshold | 5f | 拖拽触发移动阈值（像素） |
| ctrlPickupRate | 3.5f | Ctrl 长按拿取速度（个/秒） |
| dropCooldown | 5f | 丢弃冷却时间（秒） |

---

## 相关文档

- `场景配置指南.md` - 详细的场景配置步骤
- `design.md` - 设计文档
- `tasks.md` - 任务列表
- `memory.md` - 开发记录
