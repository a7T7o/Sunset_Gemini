# 背包 V4 飞升 - 场景配置指南

## 问题诊断

**症状**：无法触发拿起操作（Shift/Ctrl+左键无效）

**原因**：`InventoryInteractionManager.Instance` 为 `null` 或 `HeldItemDisplay` 配置不正确

**日志证据**：
```
[InventorySlotInteraction] Manager found: False
```

---

## 解决方案 1：添加 InventoryInteractionManager 到场景

### 步骤 1：找到 UI 根节点

在 Hierarchy 中找到：
```
UI
└── PackagePanel
    └── Main
```

### 步骤 2：添加 Manager 组件

1. 选中 `PackagePanel` 节点
2. 在 Inspector 中点击 `Add Component`
3. 搜索并添加 `InventoryInteractionManager`

### 步骤 3：配置 Manager 引用

在 `InventoryInteractionManager` 组件的 Inspector 中配置：

#### 服务引用
- **Inventory**: 拖入场景中的 `InventoryService` 组件（通常在 Systems 或 Managers 下）
- **Equipment**: 拖入场景中的 `EquipmentService` 组件（通常在 Systems 或 Managers 下）
- **Database**: 拖入 `Assets/Data/Database/MasterItemDatabase.asset`

#### UI 引用
- **Held Display**: 拖入 `HeldItemDisplay` 组件（见下方"解决方案 2"）
- **Panel Rect**: 拖入 `PackagePanel` 的 RectTransform
- **Trash Can Rect**: （可选）如果有垃圾桶 UI，拖入其 RectTransform

#### 配置参数（使用默认值即可）
- Drag Time Threshold: `0.15`
- Drag Move Threshold: `5`
- Ctrl Pickup Rate: `3.5`
- Drop Cooldown: `5`

---

## 解决方案 2：正确创建 HeldItemDisplay

### ⚠️ 重要说明

**HeldItemDisplay 不是预制体，而是场景中的 GameObject！**

它需要作为 UI 的一部分存在，并且在 Canvas 下。

### 步骤 1：创建 HeldItemDisplay GameObject

在 Hierarchy 中：

1. 右键点击 `Canvas` 或 `PackagePanel`
2. 选择 `Create Empty`
3. 命名为 `HeldItemDisplay`

### 步骤 2：配置 RectTransform

选中 `HeldItemDisplay`，在 Inspector 中设置：

- **Anchor Presets**: 左上角（Left-Top）
- **Pivot**: (0.5, 0.5)
- **Position**: (0, 0, 0)
- **Width**: 64
- **Height**: 64

### 步骤 3：添加 HeldItemDisplay 组件

1. 选中 `HeldItemDisplay` GameObject
2. 在 Inspector 中点击 `Add Component`
3. 搜索并添加 `HeldItemDisplay` 脚本

### 步骤 4：创建子物体 - Icon

1. 右键点击 `HeldItemDisplay`
2. 选择 `UI → Image`
3. 命名为 `Icon`
4. 设置 RectTransform：
   - Anchor: 拉伸（Stretch）
   - Left/Top/Right/Bottom: 全部设为 0
5. 设置 Image 组件：
   - **Raycast Target**: 取消勾选（重要！）
   - Source Image: 留空

### 步骤 5：创建子物体 - Amount

1. 右键点击 `HeldItemDisplay`
2. 选择 `UI → Text`
3. 命名为 `Amount`
4. 设置 RectTransform：
   - Anchor: 拉伸（Stretch）
   - Left: 21.2356
   - Top: 41.568
   - Right: 3.8808
   - Bottom: 0
5. 设置 Text 组件：
   - Font: LegacyRuntime（默认字体）
   - Font Size: 18
   - Font Style: Bold And Italic
   - Color: 黑色 (#000000)
   - Alignment: 右下角（Lower Right）
   - **Raycast Target**: 取消勾选（重要！）

### 步骤 6：添加 CanvasGroup

1. 选中 `HeldItemDisplay` GameObject
2. 在 Inspector 中点击 `Add Component`
3. 搜索并添加 `Canvas Group`
4. 设置：
   - Alpha: 0（初始隐藏）
   - Interactable: 勾选
   - Block Raycasts: 取消勾选（重要！）

### 步骤 7：配置 HeldItemDisplay 组件引用

选中 `HeldItemDisplay` GameObject，在 `HeldItemDisplay` 组件中：

- **Icon Image**: 拖入 `Icon` 子物体的 Image 组件
- **Amount Text**: 拖入 `Amount` 子物体的 Text 组件
- **Canvas Group**: 拖入 `HeldItemDisplay` 自己的 CanvasGroup 组件

### 最终层级结构

```
Canvas (Environment)
└── HeldItemDisplay
    ├── Icon (Image)
    └── Amount (Text)
```

或者

```
PackagePanel
└── HeldItemDisplay
    ├── Icon (Image)
    └── Amount (Text)
```

### ⚠️ 关键配置检查

- [ ] HeldItemDisplay 在 Canvas 或 PackagePanel 下
- [ ] Icon 和 Amount 的 Raycast Target 都取消勾选
- [ ] CanvasGroup 的 Block Raycasts 取消勾选
- [ ] CanvasGroup 的 Alpha 初始为 0
- [ ] HeldItemDisplay 组件的三个引用都已配置

---

## 解决方案 3：将 HeldItemDisplay 引用赋值给 Manager

1. 选中 `PackagePanel`（有 InventoryInteractionManager 组件的那个）
2. 在 Inspector 中找到 `InventoryInteractionManager` 组件
3. 将 `HeldItemDisplay` GameObject 拖入 `Held Display` 字段

---

## 验证

配置完成后，运行游戏：

1. 打开背包
2. 按住 Shift 或 Ctrl，点击有物品的槽位
3. 查看 Console，应该看到：
   ```
   [InventorySlotInteraction] Manager found: True
   [InventoryInteractionManager] OnSlotPointerDown - index=X, isEquip=False
   [InventoryInteractionManager] 修饰键状态 - Shift=True/False, Ctrl=True/False
   [InventoryInteractionManager] 触发 Shift 二分拿取 / 触发 Ctrl 单个拿取
   [InventoryInteractionManager] ShowHeld - itemId=X, amount=X, icon=XXX
   [HeldItemDisplay] 显示物品: itemId=X, sprite=XXX, amount=X
   ```

4. 如果看到完整的日志链，说明配置成功！

---

## 常见问题

### Q: 找不到 InventoryService/EquipmentService
**A**: 这些服务应该在场景的 `Systems` 或 `Managers` 节点下。如果没有，需要先添加这些服务。

### Q: 配置后仍然 Manager found: False
**A**: 检查 `InventoryInteractionManager` 的 `Awake()` 是否正常执行。可能是组件被禁用或初始化顺序问题。

### Q: 点击槽位没有任何日志输出
**A**: 检查以下几点：
1. 槽位上的 Image 组件的 `Raycast Target` 是否勾选
2. 槽位上是否有 `InventorySlotInteraction` 组件
3. Canvas 的 `Graphic Raycaster` 组件是否启用

### Q: 有日志但看不到 HeldItemDisplay
**A**: 检查以下几点：
1. HeldItemDisplay 的 CanvasGroup Alpha 是否被设置为 1
2. HeldItemDisplay 是否在 Canvas 下（不是预制体）
3. Icon 的 Sprite 是否正确赋值
4. HeldItemDisplay 的 GameObject 是否被激活

### Q: HeldItemDisplay 不跟随鼠标
**A**: 检查以下几点：
1. HeldItemDisplay 组件的 Update() 是否正常执行
2. Canvas 的 Render Mode 设置（推荐 Screen Space - Overlay）
3. HeldItemDisplay 的 RectTransform 是否正确

---

## 下一步

配置完成并验证 Manager 正常工作后，就可以测试所有交互功能了：

- ✅ Shift+左键 二分拿取
- ✅ Shift 连续二分
- ✅ Ctrl+左键 单个拿取
- ✅ Ctrl 长按持续拿取
- ✅ 拖拽交换
- ✅ 快速装备
- ✅ ESC 取消
- ✅ 面板外丢弃

---

## 调试技巧

### 1. 查看详细日志

运行游戏后，Console 会输出详细的交互流程日志：

- 青色：事件触发和状态查询
- 绿色：成功的操作
- 黄色：警告或跳过的操作
- 红色：错误

### 2. 检查 Manager 状态

在运行时，选中 `PackagePanel`，在 Inspector 中可以看到 `InventoryInteractionManager` 的当前状态：

- Current State: 当前交互状态
- Held Item: 手上拿着的物品
- Source Index: 源槽位索引

### 3. 检查 HeldItemDisplay 状态

在运行时，选中 `HeldItemDisplay`，在 Inspector 中可以看到：

- Canvas Group Alpha: 应该在拿起物品时变为 1
- Icon Image Sprite: 应该显示物品图标
- Amount Text: 应该显示数量
