# 背包交互逻辑优化 - 需求文档

## 简介

本文档定义了背包交互系统的逻辑优化需求，主要涉及 Shift 二分拿取和 Shift/Ctrl 拿起后的放置行为改进。

## 术语表

- **背包交互管理器 (InventoryInteractionManager)**：管理背包物品拖拽、拿取、放置等交互逻辑的核心组件
- **二分拿取**：Shift+左键点击槽位时，将物品数量分成两部分的操作
- **源槽位**：执行拿取操作时物品原本所在的槽位
- **目标槽位**：执行放置操作时鼠标点击的槽位
- **Held 状态**：物品被拿起后跟随鼠标的状态（HeldByShift 或 HeldByCtrl）

---

## 需求

### 需求 1：Shift 二分拿取余数归手上

**用户故事**：作为玩家，我希望 Shift 二分拿取时余数归手上，这样我可以更精确地控制拿取数量，最坏情况下手上至少有 1 个物品。

#### 验收标准

1. WHEN 玩家对有 N 个物品的槽位执行 Shift+左键 THEN 背包交互管理器 SHALL 将 `(N+1)/2` 个物品拿到手上，剩余 `N - (N+1)/2` 个留在源槽位
2. WHEN 玩家对只有 1 个物品的槽位执行 Shift+左键 THEN 背包交互管理器 SHALL 将该物品全部拿到手上，源槽位变为空
3. WHEN 玩家在 Held 状态下对源槽位执行连续二分（Shift+左键）且手上只有 1 个物品 THEN 背包交互管理器 SHALL 不执行任何操作，手上保持 1 个物品

### 需求 2：Shift/Ctrl 拿起后源槽位为空时允许交换

**用户故事**：作为玩家，我希望当 Shift/Ctrl 拿起物品导致源槽位为空时，点击有不同物品的槽位能够执行交换，这样修饰键是为了方便我而不是限制我。

#### 验收标准

1. WHEN 玩家在 Held 状态下（源槽位为空）点击空槽位 THEN 背包交互管理器 SHALL 将手上物品放置到目标槽位
2. WHEN 玩家在 Held 状态下（源槽位为空）点击有相同物品的槽位 THEN 背包交互管理器 SHALL 尝试堆叠，溢出部分保留在手上
3. WHEN 玩家在 Held 状态下（源槽位为空）点击有不同物品的槽位 THEN 背包交互管理器 SHALL 执行交换（手上物品放到目标，目标物品放到源槽位）
4. WHEN 玩家在 Held 状态下（源槽位非空）点击有不同物品的槽位 THEN 背包交互管理器 SHALL 返回原位（不执行交换）
5. WHEN 玩家在 Held 状态下（源槽位为空）点击不匹配的装备槽位 THEN 背包交互管理器 SHALL 返回原位（装备限制优先）

### 需求 3：Ctrl 拿取全部后的状态处理

**用户故事**：作为玩家，我希望 Ctrl 长按拿取全部物品后，能够像拖拽一样自由放置或交换。

#### 验收标准

1. WHEN 玩家 Ctrl+长按拿取直到源槽位清空 THEN 背包交互管理器 SHALL 保持 HeldByCtrl 状态，允许后续交换操作
2. WHEN 玩家在 HeldByCtrl 状态下（源槽位为空）点击有不同物品的槽位 THEN 背包交互管理器 SHALL 执行交换

---

### 需求 4：交换后选中目标槽位

**用户故事**：作为玩家，我希望任何交换操作完成后，目标槽位（物品最终落下的位置）进入选中状态，这样我可以清楚地看到物品放置的位置。

#### 验收标准

1. WHEN 玩家通过拖拽完成物品交换 THEN 背包交互管理器 SHALL 将目标槽位设置为选中状态
2. WHEN 玩家通过 Shift/Ctrl 拿起后点击完成放置或交换 THEN 背包交互管理器 SHALL 将目标槽位设置为选中状态
3. WHEN 玩家通过任何方式完成物品堆叠 THEN 背包交互管理器 SHALL 将目标槽位设置为选中状态

### 需求 5：Sort 后清除选中状态

**用户故事**：作为玩家，我希望点击整理按钮后，背包内所有槽位的选中状态被清除，这样整理后的背包看起来更整洁。

#### 验收标准

1. WHEN 玩家点击整理按钮 THEN 背包交互管理器 SHALL 清除所有背包槽位的选中状态
2. WHEN 整理完成后 THEN 背包交互管理器 SHALL 确保没有任何槽位处于选中状态

---

## 边界情况

### 堆叠溢出

- 手上 5 个苹果，目标槽位 95 个苹果（最大 99）
- 预期：目标变成 99 个，手上剩余 1 个，继续保持 Held 状态

### 连续二分终止

- 手上只有 1 个物品时，连续二分应该跳过（不做任何事）
- 避免返回 0 个到源槽位的无意义操作

### 装备槽位限制

- 即使源槽位为空，如果目标是不匹配的装备槽位，也不应该交换
- 装备限制检查优先于交换逻辑
