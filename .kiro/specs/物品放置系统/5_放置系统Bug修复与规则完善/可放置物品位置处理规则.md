# 可放置物品位置处理规则

**创建日期**: 2026-01-20  
**目的**: 详细说明不同类型可放置物品的位置计算规则，特别是预览位置与实际放置位置的关系

---

## 一、核心概念定义

### 1.1 三个关键位置

| 概念 | 定义 | 计算方式 |
|------|------|---------|
| **格子中心** | 世界坐标系中某个格子的几何中心 | `Floor(worldPos) + (0.5, 0.5)` |
| **预览 UI 位置** | 预览组件 Transform 的 position | 等于格子中心 |
| **实际放置位置** | 实例化预制体时传入的 position | 等于格子中心（但预制体内部可能有偏移） |

### 1.2 位置传递链路

```
鼠标世界坐标 → 格子中心 → 预览 UI 位置 → 锁定位置 → 实际放置位置
     ↓              ↓            ↓            ↓            ↓
  (3.7, 5.2)   (3.5, 5.5)   (3.5, 5.5)   (3.5, 5.5)   (3.5, 5.5)
```

**关键点**：从格子中心开始，所有位置都是相同的 `(3.5, 5.5)`。

---

## 二、预览 UI 位置计算

### 2.1 PlacementPreviewV3 的位置更新

预览 UI 的 Transform.position 始终等于格子中心：

```
预览 UI 位置 = Floor(鼠标世界坐标) + (0.5, 0.5)
```

### 2.2 预览 Sprite 的显示位置

预览 Sprite 是 PlacementPreviewV3 的子物体，localPosition = (0, 0)，因此：

```
预览 Sprite 世界位置 = 预览 UI 位置 = 格子中心
```

### 2.3 预览与实际放置的对齐问题

**问题根源**：预览 Sprite 使用物品的 `icon`，而实际放置使用 `placementPrefab`。两者的 Sprite 可能不同，导致视觉上的偏移。

---

## 三、树苗（Sapling）位置处理

### 3.1 数据结构

```
SaplingData : PlaceableItemData
├── icon: Sprite（背包图标，用于预览）
├── treePrefab: GameObject（树木预制体）
└── heldSprite: Sprite（手持显示，可选）
```

### 3.2 树木预制体结构

```
Tree_M1_00（父物体）
├── position = 放置位置（格子中心）
├── Tree（子物体）
│   ├── SpriteRenderer
│   └── TreeControllerV2（负责底部对齐）
└── Shadow（子物体）
    └── SpriteRenderer
```

### 3.3 树苗放置位置计算

**放置流程**：
1. 用户点击位置 → 计算格子中心
2. 实例化 `treePrefab`，position = 格子中心
3. TreeControllerV2.SetStage(0) 设置为树苗阶段
4. TreeControllerV2 内部执行底部对齐

**底部对齐机制**（TreeControllerV2）：
- 树木 Sprite 的底部中心对齐到父物体 position
- 父物体 position = 格子中心
- 因此树木 Sprite 底部中心 = 格子中心

### 3.4 预览与实际放置的差异

| 项目 | 预览 | 实际放置 |
|------|------|---------|
| 使用的 Sprite | `icon`（背包图标） | `treePrefab` 中的树苗 Sprite |
| Sprite 锚点 | 默认（中心） | 底部中心（通过代码对齐） |
| 显示位置 | 格子中心 | 底部中心在格子中心 |

**潜在问题**：如果 `icon` 的锚点是中心，而树苗 Sprite 是底部对齐，预览和实际放置会有视觉偏移。

### 3.5 解决方案

**方案 A**：预览时也使用底部对齐
- 在 PlacementPreviewV3 中检测物品类型
- 如果是树苗，调整预览 Sprite 的 localPosition 使其底部对齐

**方案 B**：使用专门的预览 Sprite
- SaplingData 添加 `previewSprite` 字段
- 预览时使用 `previewSprite`，确保与实际放置一致

---

## 四、箱子（Storage）位置处理

### 4.1 数据结构

```
StorageData : PlaceableItemData
├── icon: Sprite（背包图标）
├── storagePrefab: GameObject（箱子预制体）
└── boxUiPrefab: GameObject（箱子 UI 预制体）
```

### 4.2 箱子预制体结构

```
Chest_Wood（预制体根物体）
├── SpriteRenderer
├── PolygonCollider2D
└── ChestController
```

### 4.3 箱子放置位置计算

**放置流程**：
1. 用户点击位置 → 计算格子中心
2. 实例化 `storagePrefab`，position = 格子中心
3. ChestController.Initialize() 初始化
4. ChestController 内部执行底部对齐

**底部对齐机制**（ChestController）：
- 在 Awake 时记录初始底部中心位置作为锚点
- 切换 Sprite 时（开/关状态），保持底部中心不变
- 通过调整 Transform.position 实现对齐

### 4.4 箱子的 Sprite 底部中心约束

**核心规则**：箱子的 Sprite 底部中心必须始终保持在固定的世界坐标位置。

**实现代码**（ChestController）：
```
1. Awake 时：_anchorWorldPos = GetCurrentBottomCenterWorld()
2. 切换 Sprite 时：
   - 应用新 Sprite
   - 计算新的底部中心
   - 计算偏移 delta = _anchorWorldPos - newBottomCenter
   - transform.position += delta
```

### 4.5 预览与实际放置的差异

| 项目 | 预览 | 实际放置 |
|------|------|---------|
| 使用的 Sprite | `icon`（背包图标） | `storagePrefab` 中的箱子 Sprite |
| Sprite 锚点 | 默认（中心） | 底部中心（通过代码对齐） |
| 显示位置 | 格子中心 | 底部中心在格子中心 |

**潜在问题**：与树苗相同，如果 `icon` 锚点是中心，预览和实际放置会有视觉偏移。

---

## 五、位置偏移问题分析

### 5.1 问题现象

用户报告：预览位置和实际放置位置有偏移，物品放置后会"跳动"。

### 5.2 问题根源

**原因 1**：预览 Sprite 与实际 Sprite 不同
- 预览使用 `icon`（背包图标）
- 实际使用 `placementPrefab` 中的 Sprite
- 两者尺寸、锚点可能不同

**原因 2**：锚点对齐方式不同
- 预览 Sprite：默认中心对齐
- 实际 Sprite：底部中心对齐（树苗、箱子）

**原因 3**：预制体内部有偏移
- 预制体根物体 position = 格子中心
- 但子物体 SpriteRenderer 可能有 localPosition 偏移

### 5.3 偏移量计算

假设：
- 预览 Sprite 高度 = H1，锚点在中心
- 实际 Sprite 高度 = H2，底部对齐

偏移量 = H2/2 - H1/2 = (H2 - H1) / 2

如果 H2 > H1，实际放置会比预览高出 (H2 - H1) / 2 单位。

---

## 六、其他可放置物品接口

### 6.1 PlaceableItemData 基类

所有可放置物品继承自 `PlaceableItemData`：

```
PlaceableItemData : ItemData
├── placementPrefab: GameObject（放置预制体）
├── placementType: PlacementType（放置类型枚举）
├── GetPlacementType(): PlacementType
├── GetPlacementPrefab(): GameObject
├── CanPlaceAt(Vector3 position): bool
└── OnPlaced(Vector3 position, GameObject instance): void
```

### 6.2 放置类型枚举

```
PlacementType
├── Generic（通用物品）
├── Sapling（树苗）
├── Storage（存储容器）
├── Workstation（工作台）
├── Furniture（家具）
└── Decoration（装饰物）
```

### 6.3 各类型的位置处理

| 类型 | 对齐方式 | 特殊处理 |
|------|---------|---------|
| Generic | 中心对齐 | 无 |
| Sapling | 底部中心对齐 | TreeControllerV2 处理 |
| Storage | 底部中心对齐 | ChestController 处理 |
| Workstation | 底部中心对齐 | 待实现 |
| Furniture | 底部中心对齐 | 待实现 |
| Decoration | 中心对齐 | 无 |

---

## 七、修复建议

### 7.1 统一预览对齐方式

**建议**：在 PlacementPreviewV3 中根据物品类型调整预览 Sprite 的对齐方式。

```
if (item.placementType == PlacementType.Sapling || 
    item.placementType == PlacementType.Storage)
{
    // 底部对齐：将 Sprite 向上偏移半个高度
    float spriteHeight = itemPreviewRenderer.bounds.size.y;
    itemPreviewRenderer.transform.localPosition = new Vector3(0, spriteHeight / 2, 0);
}
else
{
    // 中心对齐：无偏移
    itemPreviewRenderer.transform.localPosition = Vector3.zero;
}
```

### 7.2 使用预制体 Sprite 作为预览

**建议**：预览时直接使用 `placementPrefab` 中的 Sprite，而不是 `icon`。

```
Sprite previewSprite = GetPreviewSpriteFromPrefab(item.placementPrefab);
itemPreviewRenderer.sprite = previewSprite;
```

### 7.3 添加预览偏移配置

**建议**：在 PlaceableItemData 中添加预览偏移配置。

```
PlaceableItemData
├── previewOffset: Vector2（预览偏移量）
└── useBottomAlignment: bool（是否使用底部对齐）
```

---

## 八、验证清单

放置系统位置处理的验证点：

- [ ] 预览 UI 位置 = 格子中心
- [ ] 实际放置位置 = 格子中心
- [ ] 树苗放置后底部中心 = 格子中心
- [ ] 箱子放置后底部中心 = 格子中心
- [ ] 预览与实际放置无视觉偏移
- [ ] 切换 Sprite 状态时位置不跳动

---

## 九、相关文件

| 文件 | 说明 |
|------|------|
| `PlacementManagerV3.cs` | 放置管理器，调用 Instantiate |
| `PlacementPreviewV3.cs` | 预览 UI，位置计算 |
| `PlacementGridCalculator.cs` | 格子中心计算 |
| `SaplingData.cs` | 树苗数据 |
| `StorageData.cs` | 箱子数据 |
| `TreeControllerV2.cs` | 树木底部对齐 |
| `ChestController.cs` | 箱子底部对齐 |

---

**文档维护者**: Kiro  
**最后更新**: 2026-01-20
