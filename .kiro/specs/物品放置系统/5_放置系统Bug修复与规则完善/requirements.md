# æ”¾ç½®ç³»ç»Ÿ Bug ä¿®å¤ä¸è§„åˆ™å®Œå–„ - éœ€æ±‚æ–‡æ¡£

**åˆ›å»ºæ—¥æœŸ**: 2026-01-20  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: å¾…å®¡æ ¸

---

## ä¸€ã€èƒŒæ™¯

æ”¾ç½®ç³»ç»Ÿ V3 ç‰ˆæœ¬åœ¨å®é™…ä½¿ç”¨ä¸­å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„æ•°æ®é”™ä¹± Bugï¼šåœ¨å¯¼èˆªçŠ¶æ€ä¸‹åˆ‡æ¢æ‰‹æŒç‰©å“ä¼šå¯¼è‡´æ”¾ç½®é”™è¯¯çš„ç‰©å“ä½†æ‰£é™¤æ­£ç¡®ç‰©å“çš„æ•°é‡ã€‚

æœ¬æ¬¡ä»»åŠ¡çš„ç›®æ ‡æ˜¯ï¼š
1. ä¿®å¤è¯¥ä¸¥é‡ Bug
2. å®Œå–„æ”¾ç½®ç³»ç»Ÿçš„è§„åˆ™æ–‡æ¡£ï¼Œä½œä¸ºæƒå¨å‚è€ƒ

---

## äºŒã€ç”¨æˆ·æ•…äº‹

### US-1ï¼šå¯¼èˆªä¸­åˆ‡æ¢ç‰©å“åº”ä¸­æ–­æ”¾ç½®

**ä½œä¸º** ç©å®¶  
**æˆ‘å¸Œæœ›** åœ¨æ”¾ç½®ç‰©å“çš„å¯¼èˆªè¿‡ç¨‹ä¸­åˆ‡æ¢æ‰‹æŒç‰©å“æ—¶ï¼Œæ”¾ç½®æµç¨‹è¢«æ­£ç¡®ä¸­æ–­  
**ä»¥ä¾¿** ä¸ä¼šå‡ºç°æ”¾ç½®é”™è¯¯ç‰©å“æˆ–æ‰£é™¤é”™è¯¯æ•°é‡çš„æƒ…å†µ

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰‹æŒç‰©å“ Aï¼Œç‚¹å‡»è¿œå¤„æœ‰æ•ˆä½ç½®ï¼Œè¿›å…¥å¯¼èˆªçŠ¶æ€
- [ ] åœ¨å¯¼èˆªè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ»šè½®åˆ‡æ¢åˆ°ç‰©å“ B
- [ ] æ”¾ç½®æµç¨‹è¢«ä¸­æ–­ï¼Œä¸æ‰§è¡Œä»»ä½•æ”¾ç½®æ“ä½œ
- [ ] ç‰©å“ A å’Œç‰©å“ B çš„æ•°é‡éƒ½ä¸å˜
- [ ] å¦‚æœç‰©å“ B ä¹Ÿæ˜¯å¯æ”¾ç½®ç‰©å“ï¼Œè¿›å…¥ç‰©å“ B çš„é¢„è§ˆæ¨¡å¼
- [ ] å¦‚æœç‰©å“ B ä¸æ˜¯å¯æ”¾ç½®ç‰©å“ï¼Œé€€å‡ºæ”¾ç½®æ¨¡å¼

---

### US-2ï¼šå¯¼èˆªä¸­åˆ‡æ¢ç‰©å“ï¼ˆæ•°å­—é”®ï¼‰åº”ä¸­æ–­æ”¾ç½®

**ä½œä¸º** ç©å®¶  
**æˆ‘å¸Œæœ›** åœ¨æ”¾ç½®ç‰©å“çš„å¯¼èˆªè¿‡ç¨‹ä¸­é€šè¿‡æ•°å­—é”®åˆ‡æ¢æ‰‹æŒç‰©å“æ—¶ï¼Œæ”¾ç½®æµç¨‹è¢«æ­£ç¡®ä¸­æ–­  
**ä»¥ä¾¿** ä¸æ»šè½®åˆ‡æ¢è¡Œä¸ºä¸€è‡´

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰‹æŒç‰©å“ Aï¼Œç‚¹å‡»è¿œå¤„æœ‰æ•ˆä½ç½®ï¼Œè¿›å…¥å¯¼èˆªçŠ¶æ€
- [ ] åœ¨å¯¼èˆªè¿‡ç¨‹ä¸­ï¼ŒæŒ‰æ•°å­—é”® 2 åˆ‡æ¢åˆ°ç‰©å“ B
- [ ] æ”¾ç½®æµç¨‹è¢«ä¸­æ–­ï¼Œä¸æ‰§è¡Œä»»ä½•æ”¾ç½®æ“ä½œ
- [ ] ç‰©å“ A å’Œç‰©å“ B çš„æ•°é‡éƒ½ä¸å˜

---

### US-3ï¼šå¯¼èˆªå›è°ƒåº”éªŒè¯çŠ¶æ€ä¸€è‡´æ€§

**ä½œä¸º** ç³»ç»Ÿ  
**æˆ‘å¸Œæœ›** å¯¼èˆªåˆ°è¾¾å›è°ƒè§¦å‘æ—¶éªŒè¯å½“å‰çŠ¶æ€ä¸å¿«ç…§çš„ä¸€è‡´æ€§  
**ä»¥ä¾¿** é˜²æ­¢å¼‚æ­¥å›è°ƒåœ¨é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å¯¼èˆªå›è°ƒè§¦å‘æ—¶ï¼Œæ£€æŸ¥ `currentState == Navigating`
- [ ] å¯¼èˆªå›è°ƒè§¦å‘æ—¶ï¼Œæ£€æŸ¥ `currentSnapshot.isValid`
- [ ] å¯¼èˆªå›è°ƒè§¦å‘æ—¶ï¼Œæ£€æŸ¥ `currentPlacementItem.itemID == currentSnapshot.itemId`
- [ ] ä»»ä¸€æ£€æŸ¥å¤±è´¥ï¼Œä¸­æ–­æ”¾ç½®æµç¨‹ï¼Œä¸æ‰§è¡Œæ”¾ç½®æ“ä½œ

---

### US-4ï¼šä½¿ç”¨å¯¼èˆªä¼šè¯ ID é˜²æ­¢æ—§å›è°ƒ

**ä½œä¸º** ç³»ç»Ÿ  
**æˆ‘å¸Œæœ›** ä½¿ç”¨å¯¼èˆªä¼šè¯ ID æœºåˆ¶ä½¿æ—§çš„å¯¼èˆªå›è°ƒå¤±æ•ˆ  
**ä»¥ä¾¿** ä»æ ¹æœ¬ä¸Šé˜²æ­¢å¼‚æ­¥å›è°ƒé—®é¢˜

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ¯æ¬¡é”å®šä½ç½®æ—¶ï¼Œé€’å¢ `navigationSessionId`
- [ ] å¯¼èˆªå›è°ƒä¸­æºå¸¦åˆ›å»ºæ—¶çš„ `sessionId`
- [ ] å›è°ƒè§¦å‘æ—¶ï¼Œæ¯”è¾ƒ `sessionId` ä¸å½“å‰ `navigationSessionId`
- [ ] å¦‚æœä¸ä¸€è‡´ï¼Œå¿½ç•¥å›è°ƒï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ

---

## ä¸‰ã€Bug è¯¦ç»†æè¿°

### Bug ID: PLACEMENT-001

**æ ‡é¢˜**: å¯¼èˆªä¸­åˆ‡æ¢ç‰©å“å¯¼è‡´æ”¾ç½®é”™è¯¯ç‰©å“å¹¶æ‰£é™¤é”™è¯¯æ•°é‡

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡ï¼ˆæ•°æ®é”™ä¹±ï¼‰

**å¤ç°æ­¥éª¤**:
1. èƒŒåŒ…ä¸­æœ‰æ ‘è‹— Aï¼ˆæ•°é‡ 5ï¼‰å’Œæ ‘è‹— Bï¼ˆæ•°é‡ 3ï¼‰
2. é€‰ä¸­æ ‘è‹— Aï¼Œç‚¹å‡»è¿œå¤„çš„æœ‰æ•ˆä½ç½®
3. ç³»ç»Ÿè¿›å…¥ Navigating çŠ¶æ€ï¼Œç©å®¶å¼€å§‹èµ°å‘ç›®æ ‡
4. åœ¨ç©å®¶åˆ°è¾¾ä¹‹å‰ï¼Œæ»šè½®åˆ‡æ¢åˆ°æ ‘è‹— B
5. ç©å®¶åˆ°è¾¾ç›®æ ‡ä½ç½®ï¼Œè§¦å‘æ”¾ç½®

**é¢„æœŸç»“æœ**:
- åˆ‡æ¢ç‰©å“æ—¶åº”è¯¥ä¸­æ–­æ”¾ç½®æµç¨‹
- æˆ–è€…æ”¾ç½®ç‰©å“ A å¹¶æ‰£é™¤ç‰©å“ A

**å®é™…ç»“æœ**:
- æ”¾ç½®äº†ç‰©å“ Bï¼ˆæ–°ç‰©å“çš„é¢„åˆ¶ä½“ï¼‰
- ä½†æ‰£é™¤äº†ç‰©å“ A çš„æ•°é‡ï¼ˆæ—§å¿«ç…§çš„æ§½ä½ï¼‰

**æ ¹æœ¬åŸå› **:
```
æ—¶é—´çº¿ï¼š
T0: ç©å®¶ç‚¹å‡»æ”¾ç½®ç‰©å“ A
    - åˆ›å»ºå¿«ç…§ï¼š{ itemId: A, slotIndex: 0 }
    - è¿›å…¥ Navigating çŠ¶æ€
    - å¼€å§‹å¯¼èˆª

T1: ç©å®¶æ»šè½®åˆ‡æ¢åˆ°ç‰©å“ B
    - OnHotbarSelectionChanged() è¢«è°ƒç”¨
    - HandleInterrupt() æ‰§è¡Œ
    - ExitPlacementMode() æ‰§è¡Œ
    - ä½†å¯¼èˆªæ˜¯å¼‚æ­¥çš„ï¼Œå›è°ƒè¿˜åœ¨ç­‰å¾…

T2: HotbarSelectionService æ£€æµ‹åˆ°æ–°ç‰©å“ B æ˜¯å¯æ”¾ç½®ç‰©å“
    - è°ƒç”¨ EnterPlacementMode(itemB)
    - currentPlacementItem = itemB
    - è¿›å…¥ Preview çŠ¶æ€

T3: ç©å®¶åˆ°è¾¾åŸæ¥çš„å¯¼èˆªç›®æ ‡
    - PlacementNavigator.OnNavigationReached å›è°ƒè§¦å‘
    - æ­¤æ—¶ currentPlacementItem å·²ç»æ˜¯ itemB
    - ä½¿ç”¨ itemB çš„é¢„åˆ¶ä½“å®ä¾‹åŒ–
    - ä½¿ç”¨æ—§å¿«ç…§çš„ slotIndex æ‰£é™¤ï¼ˆç‰©å“ A çš„æ§½ä½ï¼‰
```

---

## å››ã€æŠ€æœ¯éœ€æ±‚

### TR-1ï¼šå¯¼èˆªä¼šè¯ ID æœºåˆ¶

**éœ€æ±‚æè¿°**ï¼š
å®ç°å¯¼èˆªä¼šè¯ ID æœºåˆ¶ï¼Œç¡®ä¿æ—§çš„å¯¼èˆªå›è°ƒä¸ä¼šåœ¨æ–°çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚

**å®ç°è¦ç‚¹**ï¼š
```csharp
private int navigationSessionId = 0;

private void LockPreviewPosition()
{
    navigationSessionId++;
    int currentSessionId = navigationSessionId;
    
    navigator.StartNavigation(target, () => {
        if (currentSessionId != navigationSessionId)
            return;  // ä¼šè¯å·²å¤±æ•ˆ
        OnNavigationReached();
    });
}

private void HandleInterrupt()
{
    navigationSessionId++;  // ä½¿æ—§å›è°ƒå¤±æ•ˆ
    // ...
}
```

---

### TR-2ï¼šå›è°ƒçŠ¶æ€éªŒè¯

**éœ€æ±‚æè¿°**ï¼š
åœ¨å¯¼èˆªåˆ°è¾¾å›è°ƒä¸­æ·»åŠ çŠ¶æ€ä¸€è‡´æ€§éªŒè¯ã€‚

**å®ç°è¦ç‚¹**ï¼š
```csharp
private void OnNavigationReached()
{
    if (currentState != PlacementState.Navigating)
        return;
    
    if (!currentSnapshot.isValid)
        return;
    
    if (currentPlacementItem == null || 
        currentPlacementItem.itemID != currentSnapshot.itemId)
    {
        HandleInterrupt();
        return;
    }
    
    ExecutePlacement();
}
```

---

### TR-3ï¼šä¸­æ–­åé¢„è§ˆæ¢å¤

**éœ€æ±‚æè¿°**ï¼š
ç¡®ä¿ä¸­æ–­åé¢„è§ˆ UI æ­£ç¡®æ¢å¤åˆ°è·Ÿéšé¼ æ ‡çŠ¶æ€ã€‚

**å®ç°è¦ç‚¹**ï¼š
```csharp
private void HandleInterrupt()
{
    // ...
    if (placementPreview != null)
    {
        placementPreview.UnlockPosition();
        Vector3 mousePos = GetMouseWorldPosition();
        placementPreview.ForceUpdatePosition(mousePos);
        
        if (!placementPreview.gameObject.activeSelf)
            placementPreview.gameObject.SetActive(true);
    }
    // ...
}
```

---

## äº”ã€éªŒæ”¶æ¸…å•

### åŠŸèƒ½éªŒæ”¶

- [ ] å¯¼èˆªä¸­æ»šè½®åˆ‡æ¢ç‰©å“ï¼Œæ”¾ç½®è¢«ä¸­æ–­
- [ ] å¯¼èˆªä¸­æ•°å­—é”®åˆ‡æ¢ç‰©å“ï¼Œæ”¾ç½®è¢«ä¸­æ–­
- [ ] ä¸­æ–­åç‰©å“æ•°é‡ä¸å˜
- [ ] ä¸­æ–­åé¢„è§ˆæ­£ç¡®è·Ÿéšé¼ æ ‡
- [ ] åˆ‡æ¢åˆ°å¯æ”¾ç½®ç‰©å“åè¿›å…¥æ–°çš„é¢„è§ˆæ¨¡å¼
- [ ] åˆ‡æ¢åˆ°ä¸å¯æ”¾ç½®ç‰©å“åé€€å‡ºæ”¾ç½®æ¨¡å¼

### è¾¹ç•Œæƒ…å†µéªŒæ”¶

- [ ] å¯¼èˆªå³å°†åˆ°è¾¾æ—¶åˆ‡æ¢ç‰©å“
- [ ] å¿«é€Ÿè¿ç»­åˆ‡æ¢å¤šä¸ªç‰©å“
- [ ] åˆ‡æ¢åˆ°åŒç±»å‹ä½†ä¸åŒ ID çš„ç‰©å“
- [ ] åˆ‡æ¢åˆ°åŒ ID ä½†ä¸åŒå“è´¨çš„ç‰©å“

### å›å½’æµ‹è¯•

- [ ] æ­£å¸¸æ”¾ç½®æµç¨‹ä¸å—å½±å“
- [ ] è¿ç»­æ”¾ç½®åŠŸèƒ½æ­£å¸¸
- [ ] æ’¤é”€åŠŸèƒ½æ­£å¸¸
- [ ] æœ€åä¸€ä¸ªç‰©å“æ”¾ç½®æ­£å¸¸

---

## å…­ã€ç›¸å…³æ–‡æ¡£

- `æ”¾ç½®ç³»ç»Ÿå®Œæ•´è§„åˆ™æ±‡æ€».md` - æ”¾ç½®ç³»ç»Ÿæƒå¨è§„åˆ™æ–‡æ¡£
- `.kiro/specs/ç‰©å“æ”¾ç½®ç³»ç»Ÿ/memory.md` - å¼€å‘å†å²è®°å½•
- `Assets/YYY_Scripts/Service/Placement/PlacementManagerV3.cs` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Kiro  
**æœ€åæ›´æ–°**: 2026-01-20
