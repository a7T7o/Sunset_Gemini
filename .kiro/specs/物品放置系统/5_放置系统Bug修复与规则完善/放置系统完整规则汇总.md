# æ”¾ç½®ç³»ç»Ÿå®Œæ•´è§„åˆ™æ±‡æ€»

**åˆ›å»ºæ—¥æœŸ**: 2026-01-20  
**ç‰ˆæœ¬**: V3ï¼ˆåŸºäº PlacementManagerV3ï¼‰  
**ç›®çš„**: æ±‡æ€»æ‰€æœ‰æ”¾ç½®ç³»ç»Ÿçš„è®¾è®¡è§„åˆ™ã€ä½ç½®è®¡ç®—é€»è¾‘ã€é¢„è§ˆæ˜¾ç¤ºè§„åˆ™ï¼Œä½œä¸ºæƒå¨å‚è€ƒæ–‡æ¡£

---

## ç›®å½•

1. [åæ ‡ç³»ç»Ÿä¸æ ¼å­å®šä¹‰](#ä¸€åæ ‡ç³»ç»Ÿä¸æ ¼å­å®šä¹‰)
2. [ä½ç½®è®¡ç®—è§„åˆ™](#äºŒä½ç½®è®¡ç®—è§„åˆ™)
3. [é¢„è§ˆ UI æ˜¾ç¤ºè§„åˆ™](#ä¸‰é¢„è§ˆ-ui-æ˜¾ç¤ºè§„åˆ™)
4. [æ ¼å­é¢œè‰²è§„åˆ™](#å››æ ¼å­é¢œè‰²è§„åˆ™)
5. [éšœç¢ç‰©æ£€æµ‹è§„åˆ™](#äº”éšœç¢ç‰©æ£€æµ‹è§„åˆ™)
6. [ç‚¹å‡»è¡Œä¸ºè§„åˆ™](#å…­ç‚¹å‡»è¡Œä¸ºè§„åˆ™)
7. [å¯¼èˆªä¸æ”¾ç½®è§¦å‘è§„åˆ™](#ä¸ƒå¯¼èˆªä¸æ”¾ç½®è§¦å‘è§„åˆ™)
8. [å–æ¶ˆä¸ä¸­æ–­è§„åˆ™](#å…«å–æ¶ˆä¸ä¸­æ–­è§„åˆ™)
9. [æ”¾ç½®åè¡Œä¸ºè§„åˆ™](#ä¹æ”¾ç½®åè¡Œä¸ºè§„åˆ™)
10. [ç‰¹æ®Šç‰©å“è§„åˆ™](#åç‰¹æ®Šç‰©å“è§„åˆ™)
11. [çŠ¶æ€æœºå®šä¹‰](#åä¸€çŠ¶æ€æœºå®šä¹‰)
12. [å¿«ç…§æœºåˆ¶](#åäºŒå¿«ç…§æœºåˆ¶)
13. [å·²çŸ¥ Bug ä¸å¾…ä¿®å¤é—®é¢˜](#åä¸‰å·²çŸ¥-bug-ä¸å¾…ä¿®å¤é—®é¢˜)

---

## ä¸€ã€åæ ‡ç³»ç»Ÿä¸æ ¼å­å®šä¹‰

### 1.1 ä¸–ç•Œåæ ‡ç³»

- **åæ ‡ç³»ç±»å‹**: Unity 2D ä¸–ç•Œåæ ‡ç³»
- **å•ä½**: 1 å•ä½ = 1 æ ¼å­ = 1 ä¸ª Tile
- **åŸç‚¹**: ä¸–ç•ŒåŸç‚¹ (0, 0)

### 1.2 æ ¼å­å®šä¹‰

```
æ ¼å­åæ ‡ = Floor(ä¸–ç•Œåæ ‡)
æ ¼å­ä¸­å¿ƒ = Floor(ä¸–ç•Œåæ ‡) + (0.5, 0.5)
æ ¼å­è¾¹ç•Œ = [Floor(x), Floor(x)+1) Ã— [Floor(y), Floor(y)+1)
```

**ç¤ºä¾‹**ï¼š
- ä¸–ç•Œåæ ‡ (3.7, 5.2) æ‰€åœ¨æ ¼å­åæ ‡ = (3, 5)
- è¯¥æ ¼å­ä¸­å¿ƒ = (3.5, 5.5)
- è¯¥æ ¼å­è¾¹ç•Œ = [3, 4) Ã— [5, 6)

### 1.3 Layer ç³»ç»Ÿ

- **LAYER 1**: åœ°é¢å±‚ï¼ˆç©å®¶è¡Œèµ°å±‚ï¼‰
- **LAYER 2**: é«˜å±‚ï¼ˆæ¡¥æ¢ã€å¹³å°ç­‰ï¼‰
- **Layer ä¸€è‡´æ€§**: æ”¾ç½®ä½ç½®çš„ Layer å¿…é¡»ä¸ç©å®¶å½“å‰ Layer ä¸€è‡´

---

## äºŒã€ä½ç½®è®¡ç®—è§„åˆ™

### 2.1 é¼ æ ‡ä½ç½®åˆ°æ ¼å­ä½ç½®çš„è½¬æ¢

```csharp
// PlacementGridCalculator.cs
public static Vector2Int GetCellIndex(Vector3 worldPosition)
{
    return new Vector2Int(
        Mathf.FloorToInt(worldPosition.x),
        Mathf.FloorToInt(worldPosition.y)
    );
}

public static Vector3 GetCellCenter(Vector3 worldPosition)
{
    return new Vector3(
        Mathf.Floor(worldPosition.x) + 0.5f,
        Mathf.Floor(worldPosition.y) + 0.5f,
        worldPosition.z
    );
}
```

### 2.2 é¢„è§ˆä½ç½®è®¡ç®—

**Preview çŠ¶æ€**ï¼š
```
é¢„è§ˆæ ¼å­åæ ‡ = Floor(é¼ æ ‡ä¸–ç•Œåæ ‡)
é¢„è§ˆ UI ä½ç½® = é¢„è§ˆæ ¼å­åæ ‡ + (0.5, 0.5)  // æ ¼å­ä¸­å¿ƒ
```

**Locked/Navigating çŠ¶æ€**ï¼š
```
é¢„è§ˆæ ¼å­åæ ‡ = é”å®šæ—¶çš„æ ¼å­åæ ‡ï¼ˆä¸å†è·Ÿéšé¼ æ ‡ï¼‰
é¢„è§ˆ UI ä½ç½® = é”å®šçš„æ ¼å­ä¸­å¿ƒ
```

### 2.3 æ”¾ç½®ä½ç½®è®¡ç®—

**æ™®é€šç‰©å“**ï¼š
```
æ”¾ç½®ä½ç½® = é¢„è§ˆæ ¼å­ä¸­å¿ƒ = Floor(ç‚¹å‡»ä½ç½®) + (0.5, 0.5)
```

**æ ‘è‹—ï¼ˆç‰¹æ®Šï¼‰**ï¼š
```
æ”¾ç½®ä½ç½® = Floor(ç‚¹å‡»ä½ç½®) + (0.5, 0.5)  // åŒæ ·æ˜¯æ ¼å­ä¸­å¿ƒ
```

### 2.4 å¤šæ ¼å­ç‰©å“çš„ä½ç½®è®¡ç®—

**è®¾è®¡é¢„ç•™**ï¼š
- ç‰©å“å¯ä»¥æœ‰ `placementSize` å±æ€§ï¼Œå¦‚ (2, 2) è¡¨ç¤º 2Ã—2 æ ¼å­
- é¢„è§ˆæ—¶æ˜¾ç¤ºå¤šä¸ªæ ¼å­
- æ”¾ç½®ä½ç½®ä¸ºå·¦ä¸‹è§’æ ¼å­çš„ä¸­å¿ƒ

```csharp
// PlacementGridCalculator.cs
public static List<Vector3> GetOccupiedCellCenters(Vector3 center, Vector2Int gridSize)
{
    var cells = new List<Vector3>();
    
    // è®¡ç®—èµ·å§‹åç§»ï¼ˆä½¿æ ¼å­ä»¥ center ä¸ºä¸­å¿ƒï¼‰
    float startX = center.x - (gridSize.x - 1) * 0.5f;
    float startY = center.y - (gridSize.y - 1) * 0.5f;
    
    for (int x = 0; x < gridSize.x; x++)
    {
        for (int y = 0; y < gridSize.y; y++)
        {
            Vector3 cellCenter = new Vector3(startX + x, startY + y, center.z);
            cells.Add(cellCenter);
        }
    }
    
    return cells;
}
```

---

## ä¸‰ã€é¢„è§ˆ UI æ˜¾ç¤ºè§„åˆ™

### 3.1 é¢„è§ˆ UI ç»„æˆ

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| æ ¼å­æ–¹æ¡† | 1Ã—1 å•ä½çš„æ–¹æ¡†ï¼Œè¡¨ç¤ºæ”¾ç½®åŒºåŸŸ |
| ç‰©å“å›¾æ ‡ | åŠé€æ˜çš„ç‰©å“å›¾æ ‡ï¼Œæ˜¾ç¤ºåœ¨æ ¼å­ä¸­å¿ƒ |
| é¢œè‰²æŒ‡ç¤º | ç»¿è‰²/çº¢è‰²ï¼Œè¡¨ç¤ºæ˜¯å¦å¯æ”¾ç½® |

### 3.2 é¢„è§ˆ UI ä½ç½®

**Preview çŠ¶æ€**ï¼š
- é¢„è§ˆ UI è·Ÿéšé¼ æ ‡ç§»åŠ¨
- ä½ç½® = é¼ æ ‡æ‰€åœ¨æ ¼å­çš„ä¸­å¿ƒ
- æ¯å¸§æ›´æ–°

**Locked çŠ¶æ€**ï¼š
- é¢„è§ˆ UI å›ºå®šåœ¨ç‚¹å‡»ä½ç½®
- ä½ç½® = é”å®šæ ¼å­çš„ä¸­å¿ƒ
- ä¸å†è·Ÿéšé¼ æ ‡

**Navigating çŠ¶æ€**ï¼š
- é¢„è§ˆ UI å›ºå®šåœ¨ç›®æ ‡ä½ç½®
- ä½ç½® = å¯¼èˆªç›®æ ‡æ ¼å­çš„ä¸­å¿ƒ
- ä¸å†è·Ÿéšé¼ æ ‡

### 3.3 é¢„è§ˆ UI æ ·å¼

```csharp
// PlacementPreviewV3.cs
private void UpdatePreviewStyle(bool isValid)
{
    // æ ¼å­æ–¹æ¡†é¢œè‰²
    gridOutline.color = isValid ? validColor : invalidColor;
    
    // ç‰©å“å›¾æ ‡é€æ˜åº¦
    itemIcon.color = new Color(1, 1, 1, 0.6f);  // 60% é€æ˜åº¦
}
```

### 3.4 é¢„è§ˆ UI æ˜¾ç¤º/éšè—

| çŠ¶æ€ | é¢„è§ˆ UI |
|------|--------|
| Idle | éšè— |
| Preview | æ˜¾ç¤ºï¼Œè·Ÿéšé¼ æ ‡ |
| Locked | æ˜¾ç¤ºï¼Œå›ºå®šä½ç½® |
| Navigating | æ˜¾ç¤ºï¼Œå›ºå®šä½ç½® |
| Executing | éšè—ï¼ˆæ”¾ç½®åŠ¨ç”»æ’­æ”¾ä¸­ï¼‰ |

### 3.5 Sorting Layer è®¾ç½®

```csharp
// é¢„è§ˆç‰©å“
itemPreviewRenderer.sortingLayerName = sortingLayerName; // ä¸ç©å®¶ä¸€è‡´
itemPreviewRenderer.sortingOrder = 32000; // éå¸¸é«˜çš„å€¼ç¡®ä¿åœ¨æœ€ä¸Šå±‚

// æ ¼å­
spriteRenderer.sortingLayerName = sortingLayerName;
spriteRenderer.sortingOrder = 31999; // æ¯”ç‰©å“é¢„è§ˆä½ 1
```

---

## å››ã€æ ¼å­é¢œè‰²è§„åˆ™

### 4.1 é¢œè‰²å®šä¹‰

| é¢œè‰² | å«ä¹‰ | æ¡ä»¶ |
|------|------|------|
| ğŸŸ¢ ç»¿è‰² | å¯æ”¾ç½® | Layer ä¸€è‡´ ä¸” æ— éšœç¢ç‰© |
| ğŸ”´ çº¢è‰² | ä¸å¯æ”¾ç½® | Layer ä¸ä¸€è‡´ æˆ– æœ‰éšœç¢ç‰© |

### 4.2 ğŸ”´ğŸ”´ğŸ”´ é‡è¦è¯´æ˜ï¼šè·ç¦»ä¸å½±å“é¢œè‰² ğŸ”´ğŸ”´ğŸ”´

**è®¾è®¡å†³ç­–**ï¼š
> è·ç¦»ä¸å½±å“æ ¼å­é¢œè‰²ã€‚å³ä½¿ç›®æ ‡ä½ç½®è¶…å‡ºç©å®¶å½“å‰å¯è¾¾èŒƒå›´ï¼Œåªè¦ Layer ä¸€è‡´ä¸”æ— éšœç¢ç‰©ï¼Œæ ¼å­ä»æ˜¾ç¤ºç»¿è‰²ã€‚

**åŸå› **ï¼š
- ç©å®¶å¯ä»¥é€šè¿‡å¯¼èˆªåˆ°è¾¾è¿œå¤„çš„ä½ç½®
- é¢œè‰²åªè¡¨ç¤º"è¯¥ä½ç½®æ˜¯å¦å¯ä»¥æ”¾ç½®ç‰©å“"
- ä¸è¡¨ç¤º"ç©å®¶æ˜¯å¦èƒ½ç«‹å³æ”¾ç½®"

### 4.3 é¢œè‰²åˆ¤æ–­é€»è¾‘

```csharp
// PlacementValidatorV3.cs
public bool IsValidPlacement(Vector2Int gridPos, ItemData item)
{
    // 1. Layer æ£€æŸ¥
    if (!IsLayerConsistent(gridPos))
        return false;  // çº¢è‰²
    
    // 2. éšœç¢ç‰©æ£€æŸ¥
    if (HasObstacle(gridPos))
        return false;  // çº¢è‰²
    
    // 3. ç‰¹æ®Šè§„åˆ™æ£€æŸ¥ï¼ˆå¦‚æ ‘è‹—ï¼‰
    if (!CheckSpecialRules(gridPos, item))
        return false;  // çº¢è‰²
    
    return true;  // ç»¿è‰²
}
```

---

## äº”ã€éšœç¢ç‰©æ£€æµ‹è§„åˆ™

### 5.1 éšœç¢ç‰©ç±»å‹

| ç±»å‹ | æ£€æµ‹æ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| Tree | Tag æ£€æµ‹ | æ ‘æœ¨ï¼ŒåŒ…æ‹¬æˆé•¿ä¸­çš„æ ‘è‹— |
| Rock | Tag æ£€æµ‹ | å²©çŸ³ |
| Building | Tag æ£€æµ‹ | å»ºç­‘ç‰© |
| Player | Tag æ£€æµ‹ | ç©å®¶è‡ªèº« |
| Water | Tilemap æ£€æµ‹ | æ°´åŸŸ Tile |
| å…¶ä»–å¯æ”¾ç½®ç‰© | Collider æ£€æµ‹ | å·²æ”¾ç½®çš„ç®±å­ã€å®¶å…·ç­‰ |

### 5.2 æ£€æµ‹èŒƒå›´

```csharp
// æ£€æµ‹æ ¼å­å†…çš„æ‰€æœ‰ç¢°æ’ä½“
Vector2 center = GetCellCenter(gridPos);
Vector2 size = new Vector2(0.9f, 0.9f);  // ç•¥å°äº 1x1ï¼Œé¿å…è¾¹ç•Œè¯¯åˆ¤

Collider2D[] colliders = Physics2D.OverlapBoxAll(center, size, 0);
```

### 5.3 éšœç¢ç‰©æ ‡ç­¾åˆ—è¡¨

```csharp
private static readonly string[] ObstacleTags = {
    "Tree",
    "Rock", 
    "Building",
    "Player",
    "Chest",
    "Placeable"
};
```

### 5.4 æ°´åŸŸæ£€æµ‹

```csharp
// é€šè¿‡ Tilemap æ£€æµ‹æ°´åŸŸ
public bool IsWaterTile(Vector2Int gridPos)
{
    if (waterTilemap == null) return false;
    
    Vector3Int tilePos = new Vector3Int(gridPos.x, gridPos.y, 0);
    TileBase tile = waterTilemap.GetTile(tilePos);
    
    return tile != null;  // æœ‰æ°´åŸŸ Tile åˆ™ä¸å¯æ”¾ç½®
}
```

### 5.5 æ ‘è‹—ç‰¹æ®Šæ£€æµ‹ï¼ˆæ— ç¢°æ’ä½“ï¼‰

æ ‘è‹—ï¼ˆStage 0ï¼‰æ²¡æœ‰ç¢°æ’ä½“ï¼Œéœ€è¦ç‰¹æ®Šæ£€æµ‹ï¼š

```csharp
public bool HasTreeAtPosition(Vector3 center, float checkRadius)
{
    // æ–¹æ³•1ï¼šä½¿ç”¨ Physics2D æ£€æµ‹æœ‰ç¢°æ’ä½“çš„æ ‘æœ¨ï¼ˆStage 1+ï¼‰
    Collider2D[] hits = Physics2D.OverlapCircleAll(center, checkRadius);
    foreach (var hit in hits)
    {
        var treeController = hit.GetComponentInParent<TreeControllerV2>();
        if (treeController != null)
            return true;
    }
    
    // æ–¹æ³•2ï¼šéå†åœºæ™¯ä¸­æ‰€æœ‰ TreeControllerV2ï¼Œæ£€æµ‹æ ‘è‹—ï¼ˆStage 0ï¼Œæ— ç¢°æ’ä½“ï¼‰
    var allTrees = Object.FindObjectsByType<TreeControllerV2>(FindObjectsSortMode.None);
    foreach (var tree in allTrees)
    {
        Vector3 treeRootPos = tree.transform.parent != null 
            ? tree.transform.parent.position 
            : tree.transform.position;
        
        float distance = Vector2.Distance(
            new Vector2(center.x, center.y),
            new Vector2(treeRootPos.x, treeRootPos.y)
        );
        
        if (distance < checkRadius)
            return true;
    }
    
    return false;
}
```

---

## å…­ã€ç‚¹å‡»è¡Œä¸ºè§„åˆ™

### 6.1 å·¦é”®ç‚¹å‡»

| å½“å‰çŠ¶æ€ | æ ¼å­é¢œè‰² | è¡Œä¸º |
|---------|---------|------|
| Preview | ğŸŸ¢ ç»¿è‰² | é”å®šä½ç½®ï¼Œåˆ›å»ºå¿«ç…§ï¼Œå¼€å§‹å¯¼èˆª |
| Preview | ğŸ”´ çº¢è‰² | æ— ååº”ï¼Œé¢„è§ˆç»§ç»­è·Ÿéšé¼ æ ‡ |
| Navigating | ğŸŸ¢ ç»¿è‰² | å–æ¶ˆå½“å‰å¯¼èˆªï¼Œé”å®šæ–°ä½ç½®ï¼Œé‡æ–°å¯¼èˆª |
| Navigating | ğŸ”´ çº¢è‰² | æ— ååº” |
| Locked | ä»»æ„ | æ— ååº”ï¼ˆç­‰å¾…å¯¼èˆªå¼€å§‹ï¼‰ |

### 6.2 å³é”®ç‚¹å‡»

| å½“å‰çŠ¶æ€ | è¡Œä¸º |
|---------|------|
| Preview | é€€å‡ºæ”¾ç½®æ¨¡å¼ |
| Navigating | å–æ¶ˆå¯¼èˆªï¼Œå›åˆ° Preview çŠ¶æ€ |
| Locked | å–æ¶ˆé”å®šï¼Œå›åˆ° Preview çŠ¶æ€ |

### 6.3 ESC é”®

| å½“å‰çŠ¶æ€ | è¡Œä¸º |
|---------|------|
| Preview | é€€å‡ºæ”¾ç½®æ¨¡å¼ |
| Navigating | å–æ¶ˆå¯¼èˆªï¼Œå›åˆ° Preview çŠ¶æ€ |
| Locked | å–æ¶ˆé”å®šï¼Œå›åˆ° Preview çŠ¶æ€ |

---

## ä¸ƒã€å¯¼èˆªä¸æ”¾ç½®è§¦å‘è§„åˆ™

### 7.1 å¯¼èˆªç›®æ ‡è®¡ç®—

```csharp
// PlacementNavigator.cs
public Vector3 CalculateNavigationTarget(Bounds playerBounds, Bounds previewBounds)
{
    Vector3 playerCenter = playerBounds.center;
    
    // ç›´æ¥ä½¿ç”¨é¢„è§ˆæ ¼å­è¾¹ç¼˜çš„æœ€è¿‘ç‚¹ä½œä¸ºå¯¼èˆªç›®æ ‡
    Vector3 closestPoint = previewBounds.ClosestPoint(playerCenter);
    
    // å¦‚æœç©å®¶ä¸­å¿ƒåœ¨é¢„è§ˆ Bounds å†…éƒ¨ï¼Œæ‰¾åˆ°è¾¹ç•Œä¸Šçš„æœ€è¿‘ç‚¹
    if (previewBounds.Contains(playerCenter))
    {
        // è®¡ç®—åˆ°å„è¾¹ç•Œçš„è·ç¦»ï¼Œé€‰æ‹©æœ€è¿‘çš„è¾¹ç•Œ
        float distToLeft = playerCenter.x - previewBounds.min.x;
        float distToRight = previewBounds.max.x - playerCenter.x;
        float distToBottom = playerCenter.y - previewBounds.min.y;
        float distToTop = previewBounds.max.y - playerCenter.y;
        
        float minDist = Mathf.Min(distToLeft, distToRight, distToBottom, distToTop);
        
        if (minDist == distToLeft)
            closestPoint = new Vector3(previewBounds.min.x, playerCenter.y, 0);
        else if (minDist == distToRight)
            closestPoint = new Vector3(previewBounds.max.x, playerCenter.y, 0);
        else if (minDist == distToBottom)
            closestPoint = new Vector3(playerCenter.x, previewBounds.min.y, 0);
        else
            closestPoint = new Vector3(playerCenter.x, previewBounds.max.y, 0);
    }
    
    return closestPoint;
}
```

### 7.2 æ”¾ç½®è§¦å‘æ¡ä»¶

```csharp
// æ£€æŸ¥ç©å®¶æ˜¯å¦åˆ°è¾¾æ”¾ç½®è§¦å‘è·ç¦»
public bool CheckReached()
{
    Vector3 playerCenter = playerCollider.bounds.center;
    
    // ä½¿ç”¨ ClosestPoint è®¡ç®—ç©å®¶ä¸­å¿ƒåˆ°é¢„è§ˆæ ¼å­è¾¹ç¼˜çš„è·ç¦»
    float distance = CalculateDistanceToPreview(playerCenter, targetBounds);
    
    // åˆ°è¾¾æ¡ä»¶ï¼šç©å®¶ä¸­å¿ƒåˆ°é¢„è§ˆæ ¼å­è¾¹ç¼˜çš„è·ç¦»å°äºç­‰äºè§¦å‘è·ç¦»
    return distance <= triggerDistance;  // é»˜è®¤ 0.8f
}
```

### 7.3 ç«‹å³æ”¾ç½®åˆ¤æ–­

```csharp
// å¦‚æœç©å®¶å·²ç»åœ¨æ”¾ç½®èŒƒå›´å†…ï¼Œç«‹å³æ”¾ç½®ï¼Œæ— éœ€å¯¼èˆª
public bool IsAlreadyNearTarget(Bounds playerBounds, Bounds previewBounds)
{
    Vector3 playerCenter = playerBounds.center;
    float distance = CalculateDistanceToPreview(playerCenter, previewBounds);
    
    return distance <= triggerDistance;
}
```

### 7.4 å¯¼èˆªåˆ°è¾¾å›è°ƒ

```csharp
private void OnNavigationReached()
{
    if (currentState != PlacementState.Navigating)
        return;
    
    // éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§
    if (!currentSnapshot.isValid)
    {
        HandleInterrupt();
        return;
    }
    
    // æ‰§è¡Œæ”¾ç½®
    ExecutePlacement();
}
```

---

## å…«ã€å–æ¶ˆä¸ä¸­æ–­è§„åˆ™

### 8.1 å–æ¶ˆè§¦å‘æ¡ä»¶

| è§¦å‘ | Preview çŠ¶æ€ | Navigating çŠ¶æ€ |
|------|-------------|----------------|
| ESC é”® | é€€å‡ºæ”¾ç½®æ¨¡å¼ | å–æ¶ˆå¯¼èˆªï¼Œå›åˆ° Preview |
| å³é”® | é€€å‡ºæ”¾ç½®æ¨¡å¼ | å–æ¶ˆå¯¼èˆªï¼Œå›åˆ° Preview |
| èƒŒåŒ…æ‰“å¼€ | é€€å‡ºæ”¾ç½®æ¨¡å¼ | å–æ¶ˆå¯¼èˆªï¼Œé€€å‡ºæ”¾ç½®æ¨¡å¼ |
| æ‰‹æŒç‰©å“åˆ‡æ¢ | é€€å‡ºæ”¾ç½®æ¨¡å¼ | å–æ¶ˆå¯¼èˆªï¼Œé€€å‡ºæ”¾ç½®æ¨¡å¼ |
| æ‰‹æŒç‰©å“ç”¨å®Œ | é€€å‡ºæ”¾ç½®æ¨¡å¼ | å–æ¶ˆå¯¼èˆªï¼Œé€€å‡ºæ”¾ç½®æ¨¡å¼ |

### 8.2 ä¸­æ–­å¤„ç†é€»è¾‘

```csharp
private void HandleInterrupt()
{
    // 1. å–æ¶ˆå¯¼èˆª
    if (navigator != null && navigator.IsNavigating)
    {
        navigator.CancelNavigation();
    }
    
    // 2. æ¸…é™¤å¿«ç…§
    currentSnapshot = PlacementSnapshot.Invalid;
    
    // 3. è§£é”é¢„è§ˆï¼Œæ¢å¤è·Ÿéšé¼ æ ‡
    if (placementPreview != null)
    {
        placementPreview.UnlockPosition();
        // ç¡®ä¿é¢„è§ˆæ˜¯æ¿€æ´»çš„
        if (!placementPreview.gameObject.activeSelf)
        {
            placementPreview.gameObject.SetActive(true);
        }
    }
    
    // 4. è¿”å› Preview çŠ¶æ€ï¼ˆå¦‚æœè¿˜åœ¨æ”¾ç½®æ¨¡å¼ä¸”æœ‰ç‰©å“ï¼‰
    if (currentState != PlacementState.Idle && currentPlacementItem != null)
    {
        ChangeState(PlacementState.Preview);
    }
}
```

### 8.3 ç‰©å“åˆ‡æ¢æ—¶çš„ç‰¹æ®Šå¤„ç†

```csharp
private void OnHotbarSelectionChanged(int newIndex)
{
    // å¦‚æœæ­£åœ¨æ‰§è¡Œæ”¾ç½®ï¼Œå¿½ç•¥æ­¤å›è°ƒï¼ˆé¿å…æ‰£é™¤ç‰©å“æ—¶è§¦å‘çš„äº‹ä»¶å¯¼è‡´ä¸­æ–­ï¼‰
    if (isExecutingPlacement)
        return;
    
    // å¦‚æœæ­£åœ¨æ”¾ç½®è¿‡ç¨‹ä¸­ï¼ˆLocked æˆ– Navigatingï¼‰ï¼Œä¸­æ–­å¹¶é€€å‡º
    if (currentState == PlacementState.Locked || currentState == PlacementState.Navigating)
    {
        HandleInterrupt();
        ExitPlacementMode();
    }
}
```

---

## ä¹ã€æ”¾ç½®åè¡Œä¸ºè§„åˆ™

### 9.1 æ”¾ç½®æˆåŠŸå

1. **å®ä¾‹åŒ–é¢„åˆ¶ä½“** - åœ¨é”å®šä½ç½®ç”Ÿæˆç‰©å“å®ä½“
2. **åŒæ­¥ Layer** - åŒæ­¥åˆ°çˆ¶ç‰©ä½“ã€æ‰€æœ‰å­ç‰©ä½“
3. **åŒæ­¥ Sorting Layer** - åŒæ­¥åˆ°æ‰€æœ‰ SpriteRenderer
4. **è®¾ç½® Sorting Order** - åŸºäº Y åæ ‡è®¡ç®—
5. **æ‰£é™¤èƒŒåŒ…ç‰©å“** - ä½¿ç”¨å¿«ç…§ä¸­çš„ slotIndex ç²¾ç¡®æ‰£é™¤
6. **å¹¿æ’­äº‹ä»¶** - OnItemPlacedã€OnSaplingPlantedï¼ˆæ ‘è‹—ï¼‰
7. **æ£€æŸ¥å‰©ä½™ç‰©å“**ï¼š
   - æœ‰å‰©ä½™ â†’ å›åˆ° Preview çŠ¶æ€
   - æ— å‰©ä½™ â†’ é€€å‡ºæ”¾ç½®æ¨¡å¼

### 9.2 Sorting Order è®¡ç®—

```csharp
private void SetSortingOrder(GameObject placedObject, Vector3 position)
{
    int order = -Mathf.RoundToInt(position.y * sortingOrderMultiplier) + sortingOrderOffset;
    
    var renderers = placedObject.GetComponentsInChildren<SpriteRenderer>(true);
    foreach (var renderer in renderers)
    {
        bool isShadow = renderer.gameObject.name.ToLower().Contains("shadow");
        renderer.sortingOrder = isShadow ? order - 1 : order;
    }
}
```

### 9.3 èƒŒåŒ…æ‰£é™¤é€»è¾‘

```csharp
private bool DeductItemFromInventory()
{
    // ä½¿ç”¨å¿«ç…§æ•°æ®æ‰£é™¤èƒŒåŒ…ç‰©å“
    if (inventoryService == null || !currentSnapshot.isValid)
        return false;
    
    bool success = inventoryService.RemoveFromSlot(currentSnapshot.slotIndex, 1);
    return success;
}
```

### 9.4 è¿ç»­æ”¾ç½®æ£€æŸ¥

```csharp
private bool HasMoreItems()
{
    // ä½¿ç”¨å¿«ç…§æ•°æ®æ£€æŸ¥å‰©ä½™ç‰©å“
    if (inventoryService == null || !currentSnapshot.isValid)
        return false;
    
    var slot = inventoryService.GetSlot(currentSnapshot.slotIndex);
    
    // æ£€æŸ¥æ§½ä½æ˜¯å¦è¿˜æœ‰ç›¸åŒç‰©å“
    bool hasMore = !slot.IsEmpty && 
                   slot.itemId == currentSnapshot.itemId && 
                   slot.quality == currentSnapshot.quality;
    
    return hasMore;
}
```

---

## åã€ç‰¹æ®Šç‰©å“è§„åˆ™

### 10.1 æ ‘è‹—æ”¾ç½®è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| å­£èŠ‚é™åˆ¶ | å†¬å­£æ— æ³•ç§æ¤ |
| ä½ç½®é™åˆ¶ | ä¸èƒ½æ”¾ç½®åœ¨è€•åœ°ä¸Š |
| é—´è·é™åˆ¶ | éœ€è¦æ»¡è¶³æˆé•¿è¾¹è·ï¼ˆä» StageConfig.stage0 è·å–ï¼‰ |
| ç¢°æ’ä½“ | Stage 0 æ— ç¢°æ’ä½“ï¼Œéœ€è¦ç‰¹æ®Šæ£€æµ‹ |

### 10.2 æ ‘è‹—éªŒè¯é€»è¾‘

```csharp
public CellStateV3 ValidateSaplingPlacement(SaplingData sapling, Vector3 position, Transform playerTransform)
{
    // åŸºç¡€æ ¼å­éªŒè¯
    var baseState = ValidateSingleCell(position, Vector2Int.zero, playerTransform);
    if (!baseState.isValid)
        return baseState;
    
    // æ£€æŸ¥å†¬å­£
    if (sapling != null && sapling.IsWinter())
    {
        return new CellStateV3(Vector2Int.zero, false, InvalidReasonV3.WrongSeason);
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨è€•åœ°ä¸Š
    if (IsOnFarmland(position))
    {
        return new CellStateV3(Vector2Int.zero, false, InvalidReasonV3.OnFarmland);
    }
    
    // æ£€æŸ¥æˆé•¿è¾¹è·
    if (sapling != null)
    {
        float vMargin, hMargin;
        if (!sapling.GetStage0Margins(out vMargin, out hMargin))
        {
            vMargin = 0.2f;
            hMargin = 0.15f;
        }
        
        if (HasTreeAtPosition(position, Mathf.Max(vMargin, hMargin)))
        {
            return new CellStateV3(Vector2Int.zero, false, InvalidReasonV3.TreeTooClose);
        }
    }
    
    return new CellStateV3(Vector2Int.zero, true, InvalidReasonV3.None);
}
```

### 10.3 å·¥ä½œå°/ç®±å­æ”¾ç½®è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| ç¢°æ’æ£€æµ‹ | ä½¿ç”¨ Physics2D.OverlapBox æ£€æµ‹ |
| Layer åŒæ­¥ | æ”¾ç½®ååŒæ­¥åˆ°æ­£ç¡®çš„ Layer |
| NavGrid åˆ·æ–° | æ”¾ç½®ååˆ·æ–°å¯¼èˆªç½‘æ ¼ |

---

## åä¸€ã€çŠ¶æ€æœºå®šä¹‰

### 11.1 çŠ¶æ€æšä¸¾

```csharp
public enum PlacementState
{
    Idle,       // ç©ºé—²ï¼Œæœªæ‰‹æŒå¯æ”¾ç½®ç‰©å“
    Preview,    // é¢„è§ˆæ¨¡å¼ï¼Œé¢„è§ˆ UI è·Ÿéšé¼ æ ‡
    Locked,     // ä½ç½®é”å®šï¼Œç­‰å¾…å¯¼èˆªå¼€å§‹
    Navigating  // å¯¼èˆªä¸­ï¼Œç­‰å¾…åˆ°è¾¾ç›®æ ‡
}
```

### 11.2 çŠ¶æ€è½¬æ¢å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ”¾ç½®ç³»ç»ŸçŠ¶æ€æœº                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  çŠ¶æ€ï¼š                                                             â”‚
â”‚  - Idleï¼šç©ºé—²ï¼Œæœªæ‰‹æŒå¯æ”¾ç½®ç‰©å“                                      â”‚
â”‚  - Previewï¼šé¢„è§ˆæ¨¡å¼ï¼Œé¢„è§ˆ UI è·Ÿéšé¼ æ ‡                               â”‚
â”‚  - Lockedï¼šä½ç½®é”å®šï¼Œç­‰å¾…å¯¼èˆªå¼€å§‹                                    â”‚
â”‚  - Navigatingï¼šå¯¼èˆªä¸­ï¼Œç­‰å¾…åˆ°è¾¾ç›®æ ‡                                  â”‚
â”‚                                                                     â”‚
â”‚  è½¬æ¢ï¼š                                                             â”‚
â”‚  - Idle â†’ Previewï¼šæ‰‹æŒå¯æ”¾ç½®ç‰©å“                                   â”‚
â”‚  - Preview â†’ Idleï¼šESC/å³é”®/åˆ‡æ¢ç‰©å“                                â”‚
â”‚  - Preview â†’ Lockedï¼šç‚¹å‡»å·¦é”®ï¼ˆå…¨ç»¿ï¼‰                               â”‚
â”‚  - Locked â†’ Navigatingï¼šè‡ªåŠ¨å¼€å§‹å¯¼èˆª                                â”‚
â”‚  - Navigating â†’ Previewï¼šåˆ°è¾¾å¹¶æ”¾ç½®æˆåŠŸï¼ˆè¿˜æœ‰ç‰©å“ï¼‰                  â”‚
â”‚  - Navigating â†’ Idleï¼šåˆ°è¾¾å¹¶æ”¾ç½®æˆåŠŸï¼ˆç‰©å“ç”¨å®Œï¼‰                     â”‚
â”‚  - Navigating â†’ Previewï¼šESC/å³é”®å–æ¶ˆå¯¼èˆª                           â”‚
â”‚  - Navigating â†’ Lockedï¼šç‚¹å‡»æ–°ä½ç½®ï¼ˆå…¨ç»¿ï¼‰                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 çŠ¶æ€è¡Œä¸º

| çŠ¶æ€ | é¢„è§ˆ UI | é¼ æ ‡è·Ÿéš | å¯¼èˆª | å¯ç‚¹å‡»æ”¾ç½® |
|------|--------|---------|------|----------|
| Idle | éšè— | - | - | âŒ |
| Preview | æ˜¾ç¤º | âœ… | - | âœ…ï¼ˆå…¨ç»¿æ—¶ï¼‰ |
| Locked | æ˜¾ç¤º | âŒ | å‡†å¤‡ä¸­ | âŒ |
| Navigating | æ˜¾ç¤º | âŒ | è¿›è¡Œä¸­ | âœ…ï¼ˆç‚¹å‡»æ–°ä½ç½®ï¼‰ |

---

## åäºŒã€å¿«ç…§æœºåˆ¶

### 12.1 å¿«ç…§ç»“æ„

```csharp
private struct PlacementSnapshot
{
    public int itemId;           // ç‰©å“ ID
    public int quality;          // ç‰©å“å“è´¨
    public int slotIndex;        // èƒŒåŒ…æ§½ä½ç´¢å¼•
    public Vector3 lockedPosition; // é”å®šçš„æ”¾ç½®ä½ç½®
    public bool isValid;         // å¿«ç…§æ˜¯å¦æœ‰æ•ˆ
    
    public static PlacementSnapshot Invalid => new PlacementSnapshot { isValid = false };
}
```

### 12.2 å¿«ç…§åˆ›å»ºæ—¶æœº

- **åˆ›å»ºæ—¶æœº**: ç‚¹å‡»å·¦é”®é”å®šä½ç½®æ—¶ï¼ˆ`LockPreviewPosition()`ï¼‰
- **åˆ›å»ºå†…å®¹**: è®°å½•å½“å‰ç‰©å“ IDã€å“è´¨ã€æ§½ä½ç´¢å¼•ã€é”å®šä½ç½®

```csharp
private PlacementSnapshot CreateSnapshot()
{
    if (currentPlacementItem == null || hotbarSelection == null)
        return PlacementSnapshot.Invalid;
    
    return new PlacementSnapshot
    {
        itemId = currentPlacementItem.itemID,
        quality = currentItemQuality,
        slotIndex = hotbarSelection.selectedIndex,
        lockedPosition = placementPreview != null ? placementPreview.LockedPosition : Vector3.zero,
        isValid = true
    };
}
```

### 12.3 å¿«ç…§éªŒè¯

```csharp
private bool ValidateSnapshot()
{
    if (!currentSnapshot.isValid) return false;
    if (inventoryService == null) return false;
    
    var slot = inventoryService.GetSlot(currentSnapshot.slotIndex);
    if (slot.IsEmpty) return false;
    if (slot.itemId != currentSnapshot.itemId) return false;
    if (slot.quality != currentSnapshot.quality) return false;
    
    return true;
}
```

### 12.4 å¿«ç…§æ¸…é™¤æ—¶æœº

- æ”¾ç½®æˆåŠŸå
- ä¸­æ–­æ—¶ï¼ˆ`HandleInterrupt()`ï¼‰
- é€€å‡ºæ”¾ç½®æ¨¡å¼æ—¶ï¼ˆ`ExitPlacementMode()`ï¼‰
- ç‚¹å‡»æ–°ä½ç½®æ—¶ï¼ˆå…ˆæ¸…é™¤æ—§å¿«ç…§ï¼Œå†åˆ›å»ºæ–°å¿«ç…§ï¼‰


---

## åä¸‰ã€å·²çŸ¥ Bug ä¸å¾…ä¿®å¤é—®é¢˜

### 13.1 ğŸ”´ ä¸¥é‡ Bugï¼šå¯¼èˆªä¸­åˆ‡æ¢ç‰©å“å¯¼è‡´æ•°æ®é”™ä¹±

**Bug æè¿°**ï¼š
å½“ç©å®¶æ‰‹æŒç‰©å“ A ç‚¹å‡»æ”¾ç½®ï¼ˆè¿›å…¥å¯¼èˆªçŠ¶æ€ï¼‰ï¼Œåœ¨å¯¼èˆªè¿‡ç¨‹ä¸­é€šè¿‡æ»šè½®æˆ–æ•°å­—é”®åˆ‡æ¢åˆ°ç‰©å“ Bï¼Œæ”¾ç½®ç³»ç»Ÿä¼šï¼š
- æ”¾ç½®ç‰©å“ Bï¼ˆæ–°ç‰©å“ï¼‰
- ä½†æ‰£é™¤ç‰©å“ Aï¼ˆæ—§ç‰©å“ï¼‰çš„æ•°é‡

**å¤ç°æ­¥éª¤**ï¼š
1. èƒŒåŒ…ä¸­æœ‰æ ‘è‹— Aï¼ˆæ•°é‡ 5ï¼‰å’Œæ ‘è‹— Bï¼ˆæ•°é‡ 3ï¼‰
2. é€‰ä¸­æ ‘è‹— Aï¼Œç‚¹å‡»è¿œå¤„çš„æœ‰æ•ˆä½ç½®
3. ç³»ç»Ÿè¿›å…¥ Navigating çŠ¶æ€ï¼Œç©å®¶å¼€å§‹èµ°å‘ç›®æ ‡
4. åœ¨ç©å®¶åˆ°è¾¾ä¹‹å‰ï¼Œæ»šè½®åˆ‡æ¢åˆ°æ ‘è‹— B
5. ç©å®¶åˆ°è¾¾ç›®æ ‡ä½ç½®ï¼Œè§¦å‘æ”¾ç½®

**é¢„æœŸç»“æœ**ï¼š
- åˆ‡æ¢ç‰©å“æ—¶åº”è¯¥ä¸­æ–­æ”¾ç½®æµç¨‹
- æˆ–è€…æ”¾ç½®ç‰©å“ A å¹¶æ‰£é™¤ç‰©å“ A

**å®é™…ç»“æœ**ï¼š
- æ”¾ç½®äº†ç‰©å“ B
- ä½†æ‰£é™¤äº†ç‰©å“ A çš„æ•°é‡

**æ ¹æœ¬åŸå› åˆ†æ**ï¼š

```
æ—¶é—´çº¿ï¼š
T0: ç©å®¶ç‚¹å‡»æ”¾ç½®ç‰©å“ A
    - åˆ›å»ºå¿«ç…§ï¼š{ itemId: A, slotIndex: 0 }
    - è¿›å…¥ Navigating çŠ¶æ€
    - å¼€å§‹å¯¼èˆª

T1: ç©å®¶æ»šè½®åˆ‡æ¢åˆ°ç‰©å“ B
    - HotbarSelectionService.OnSelectedChanged è§¦å‘
    - OnHotbarSelectionChanged() è¢«è°ƒç”¨
    - HandleInterrupt() æ‰§è¡Œ
    - ExitPlacementMode() æ‰§è¡Œ
    - ä½†æ˜¯ï¼å¯¼èˆªæ˜¯å¼‚æ­¥çš„ï¼ŒPlacementNavigator çš„å›è°ƒè¿˜åœ¨ç­‰å¾…

T2: HotbarSelectionService æ£€æµ‹åˆ°æ–°ç‰©å“ B æ˜¯å¯æ”¾ç½®ç‰©å“
    - è°ƒç”¨ EnterPlacementMode(itemB)
    - currentPlacementItem = itemB
    - è¿›å…¥ Preview çŠ¶æ€

T3: ç©å®¶åˆ°è¾¾åŸæ¥çš„å¯¼èˆªç›®æ ‡ï¼ˆå› ä¸ºå¯¼èˆªæ²¡æœ‰è¢«æ­£ç¡®å–æ¶ˆï¼‰
    - PlacementNavigator.OnNavigationReached å›è°ƒè§¦å‘
    - ä½†æ­¤æ—¶ currentPlacementItem å·²ç»æ˜¯ itemB
    - ä½¿ç”¨ itemB çš„é¢„åˆ¶ä½“å®ä¾‹åŒ–
    - ä½¿ç”¨æ—§å¿«ç…§çš„ slotIndex æ‰£é™¤ï¼ˆç‰©å“ A çš„æ§½ä½ï¼‰
```

**é—®é¢˜ä»£ç ä½ç½®**ï¼š

```csharp
// PlacementManagerV3.cs - OnHotbarSelectionChanged()
private void OnHotbarSelectionChanged(int newIndex)
{
    if (isExecutingPlacement)
        return;
    
    if (currentState == PlacementState.Locked || currentState == PlacementState.Navigating)
    {
        HandleInterrupt();  // â† è¿™é‡Œè°ƒç”¨äº†ä¸­æ–­
        ExitPlacementMode(); // â† è¿™é‡Œé€€å‡ºäº†æ”¾ç½®æ¨¡å¼
    }
}

// é—®é¢˜ï¼šHandleInterrupt() è°ƒç”¨äº† navigator.CancelNavigation()
// ä½† CancelNavigation() æ˜¯å¦èƒ½ä¿è¯å›è°ƒä¸å†è§¦å‘ï¼Ÿ
// å¦‚æœ HotbarSelectionService ç«‹å³è°ƒç”¨ EnterPlacementMode(newItem)
// é‚£ä¹ˆæ—§çš„å¯¼èˆªå›è°ƒå¯èƒ½åœ¨æ–°çš„æ”¾ç½®æ¨¡å¼ä¸‹è§¦å‘
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šä½¿ç”¨å¯¼èˆªä¼šè¯ ID**
```csharp
private int navigationSessionId = 0;

private void LockPreviewPosition()
{
    navigationSessionId++;  // æ¯æ¬¡é”å®šæ—¶é€’å¢
    int currentSessionId = navigationSessionId;
    
    navigator.StartNavigation(target, () => {
        // å›è°ƒä¸­æ£€æŸ¥ä¼šè¯ ID
        if (currentSessionId != navigationSessionId)
            return;  // ä¼šè¯å·²å¤±æ•ˆï¼Œå¿½ç•¥å›è°ƒ
        
        OnNavigationReached();
    });
}

private void HandleInterrupt()
{
    navigationSessionId++;  // ä¸­æ–­æ—¶é€’å¢ï¼Œä½¿æ—§å›è°ƒå¤±æ•ˆ
    // ...
}
```

**æ–¹æ¡ˆ Bï¼šåœ¨å›è°ƒä¸­éªŒè¯çŠ¶æ€ä¸€è‡´æ€§**
```csharp
private void OnNavigationReached()
{
    // éªŒè¯å½“å‰çŠ¶æ€
    if (currentState != PlacementState.Navigating)
        return;
    
    // éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§
    if (!currentSnapshot.isValid)
        return;
    
    // éªŒè¯å½“å‰ç‰©å“ä¸å¿«ç…§ä¸€è‡´
    if (currentPlacementItem == null || 
        currentPlacementItem.itemID != currentSnapshot.itemId)
    {
        HandleInterrupt();
        return;
    }
    
    ExecutePlacement();
}
```

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ A + æ–¹æ¡ˆ B ç»“åˆä½¿ç”¨ï¼ŒåŒé‡ä¿é™©ã€‚

---

### 13.2 ä¸­æ–­åé¢„è§ˆä¸è·Ÿéšé¼ æ ‡

**Bug æè¿°**ï¼š
åœ¨ Navigating çŠ¶æ€ä¸‹ä¸­æ–­æ”¾ç½®åï¼Œé¢„è§ˆ UI ä¸ä¼šæ¢å¤åˆ°è·Ÿéšé¼ æ ‡çš„çŠ¶æ€ï¼Œè€Œæ˜¯åœç•™åœ¨ä¸Šä¸€ä¸ªé”å®šä½ç½®ã€‚

**æ ¹æœ¬åŸå› **ï¼š
`HandleInterrupt()` è°ƒç”¨äº† `UnlockPosition()`ï¼Œä½†å¯èƒ½æ²¡æœ‰æ­£ç¡®è§¦å‘é¢„è§ˆæ›´æ–°ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
åœ¨ `HandleInterrupt()` ä¸­å¼ºåˆ¶æ›´æ–°é¢„è§ˆä½ç½®ï¼š
```csharp
private void HandleInterrupt()
{
    // ...
    if (placementPreview != null)
    {
        placementPreview.UnlockPosition();
        // å¼ºåˆ¶æ›´æ–°åˆ°å½“å‰é¼ æ ‡ä½ç½®
        Vector3 mousePos = GetMouseWorldPosition();
        placementPreview.ForceUpdatePosition(mousePos);
    }
    // ...
}
```

---

### 13.3 æœ€åä¸€ä¸ªç‰©å“æ”¾ç½®æ—¶å¯èƒ½æŠ¥é”™

**Bug æè¿°**ï¼š
å½“æ‰‹æŒç‰©å“åªå‰©æœ€åä¸€ä¸ªæ—¶ï¼Œæ”¾ç½®æˆåŠŸåå¯èƒ½å‡ºç°ç©ºå¼•ç”¨é”™è¯¯ã€‚

**æ ¹æœ¬åŸå› **ï¼š
æ‰£é™¤æœ€åä¸€ä¸ªç‰©å“åï¼Œ`InventoryService.OnSlotChanged` äº‹ä»¶è§¦å‘ï¼Œå¯¼è‡´ `HotbarSelectionService` æ£€æµ‹åˆ°æ§½ä½ä¸ºç©ºï¼Œè°ƒç”¨ `ExitPlacementModeIfActive()`ï¼Œæ¸…ç©ºäº† `currentPlacementItem`ã€‚

**å·²æœ‰ä¿æŠ¤**ï¼š
- `isExecutingPlacement` æ ‡å¿—ä½
- è®¢é˜… `OnSlotChanged` äº‹ä»¶å¹¶åœ¨æ‰§è¡Œä¸­å¿½ç•¥

**éªŒè¯ç‚¹**ï¼š
ç¡®ä¿ `isExecutingPlacement` æ ‡å¿—åœ¨æ•´ä¸ª `ExecutePlacement()` æ‰§è¡ŒæœŸé—´ä¿æŒä¸º trueã€‚

---

### 13.4 å¾…å®ç°åŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| å—å‡»ä¸­æ–­æ£€æµ‹ | P2 | éœ€è¦ä¸æˆ˜æ–—ç³»ç»Ÿé›†æˆ |
| NPC äº¤äº’ä¸­æ–­æ£€æµ‹ | P2 | éœ€è¦ä¸ NPC ç³»ç»Ÿé›†æˆ |
| æ”¾ç½®éŸ³æ•ˆ | P3 | æ”¾ç½®æˆåŠŸ/å¤±è´¥éŸ³æ•ˆ |
| æ”¾ç½®ç‰¹æ•ˆ | P3 | æ”¾ç½®æˆåŠŸç²’å­æ•ˆæœ |

---

## åå››ã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ |
|------|------|---------|
| V1 | 2025-12-28 | åˆç‰ˆå®ç°ï¼ŒåŸºç¡€æ”¾ç½®åŠŸèƒ½ |
| V2 | 2025-12-31 | é‡æ„é¢„è§ˆç³»ç»Ÿï¼Œæ·»åŠ æ ¼å­æ–¹æ¡† |
| V3 | 2026-01-03 | å–æ¶ˆæ”¾ç½®èŒƒå›´æ¦‚å¿µï¼Œæ”¹ä¸ºå¯¼èˆªæ”¾ç½® |
| V3.1 | 2026-01-05 | æ·»åŠ èƒŒåŒ…è”åŠ¨ï¼Œå¿«ç…§æœºåˆ¶ |
| V3.2 | 2026-01-07 | ä¿®å¤äº‹ä»¶è§¦å‘é¡ºåºé—®é¢˜ |

---

## åäº”ã€ç›¸å…³æ–‡ä»¶ç´¢å¼•

### æ ¸å¿ƒè„šæœ¬

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `PlacementManagerV3.cs` | æ”¾ç½®ç®¡ç†å™¨ï¼ŒçŠ¶æ€æœºæ ¸å¿ƒ |
| `PlacementNavigator.cs` | å¯¼èˆªå’Œåˆ°è¾¾æ£€æµ‹ |
| `PlacementPreviewV3.cs` | é¢„è§ˆ UIï¼Œä½ç½®é”å®š |
| `PlacementValidatorV3.cs` | æ”¾ç½®éªŒè¯ï¼Œçº¢è‰²åˆ¤å®š |
| `PlacementGridCalculator.cs` | æ ¼å­è®¡ç®— |
| `PlacementGridCell.cs` | å•ä¸ªæ ¼å­æ¸²æŸ“ |
| `PlacementLayerDetector.cs` | Layer æ£€æµ‹ |

### æ•°æ®ç±»

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `PlaceableItemData.cs` | å¯æ”¾ç½®ç‰©å“åŸºç±» |
| `SaplingData.cs` | æ ‘è‹—æ•°æ® |
| `StorageData.cs` | å­˜å‚¨å®¹å™¨æ•°æ® |
| `WorkstationData.cs` | å·¥ä½œå°æ•°æ® |

### æšä¸¾å’Œäº‹ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `PlacementEnums.cs` | æ”¾ç½®ç±»å‹ã€å¤±è´¥åŸå› æšä¸¾ |
| `PlacementEvents.cs` | æ”¾ç½®äº‹ä»¶æ•°æ®ç»“æ„ |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Kiro  
**æœ€åæ›´æ–°**: 2026-01-20
