# 5_放置系统Bug修复与规则完善 - 子工作区记忆

## 概述
- **创建日期**: 2026-01-20
- **状态**: 🔄 进行中
- **目标**: 修复导航中切换物品导致数据错乱的严重 Bug，并创建完整的放置系统规则文档

## 会话记录

### 会话 1 - 2026-01-20（工作区创建）

**用户需求**:
> 创建新的子工作区，记录放置系统的严重 Bug（导航中切换物品导致数据错乱），并创建完整的放置系统规则文档

**完成任务**:
1. ✅ 创建 `放置系统完整规则汇总.md` - 15 个章节的完整规则文档
2. ✅ 创建 `requirements.md` - 包含 4 个用户故事和详细的 Bug 描述

---

### 会话 2 - 2026-01-20（位置处理规则文档）

**用户需求**:
> 创建一个新文档，总结树苗、箱子等可放置物品的位置处理规则

**完成任务**:
1. ✅ 创建 `可放置物品位置处理规则.md`

---

## 🔴 严重 Bug：导航中切换物品导致数据错乱

**问题描述**：
手持物品 A 点击放置进入导航状态，导航过程中切换到物品 B，系统会放置物品 B 但扣除物品 A 的数量。

**根本原因**：
1. `OnHotbarSelectionChanged()` 调用 `HandleInterrupt()` 和 `ExitPlacementMode()`
2. 但导航是异步的，`PlacementNavigator` 的回调还在等待
3. `HotbarSelectionService` 立即调用 `EnterPlacementMode(newItem)`
4. 旧的导航回调 `OnNavigationReached` 在新的上下文中触发
5. 使用新物品的预制体实例化，但使用旧快照的槽位扣除

**修复方案**：
- 方案 A：使用 `navigationSessionId` 使旧回调失效
- 方案 B：在回调中验证状态一致性
- 推荐：两种方案结合使用

---

## 文档索引

| 文档 | 说明 |
|------|------|
| `放置系统完整规则汇总.md` | 15 章节完整规则（权威文档） |
| `可放置物品位置处理规则.md` | 位置计算和对齐规则 |
| `requirements.md` | Bug 修复需求 |

## 遗留问题
- [ ] 等待用户审核 requirements.md
- [ ] 创建 design.md 和 tasks.md
- [ ] 实现修复代码
