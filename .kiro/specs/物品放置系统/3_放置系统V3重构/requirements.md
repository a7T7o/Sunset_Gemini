# 放置系统 V3 重构 - 需求文档

## 简介

本文档定义放置系统 V3 版本的需求，核心变化是取消"放置范围"概念，改为"点击锁定 + 走过去放置"的交互模式。

## 术语表

- **预览 UI**：显示在鼠标位置的放置预览，包含格子方框和物品半透明图标
- **预览格子**：1x1 单位的方框，显示绿色（可放置）或红色（不可放置）
- **锁定位置**：玩家点击后，预览 UI 固定的目标放置位置
- **触发距离**：玩家 Collider 边界与预览格子边界的最小距离，达到此距离时触发放置
- **导航目标点**：玩家需要走到的位置，是玩家当前位置到预览格子边界的最近点

## 需求

### 需求 1

**用户故事**：作为玩家，我想要在场景中放置物品，以便建造和装饰我的农场。

#### 验收标准

1. WHEN 玩家手持可放置物品 THEN 系统 SHALL 显示预览 UI 跟随鼠标移动
2. WHEN 玩家移动鼠标到不同位置 THEN 系统 SHALL 实时更新预览 UI 的位置和格子颜色
3. WHEN 玩家按下 ESC 或右键 THEN 系统 SHALL 退出放置模式并隐藏预览 UI

---

### 需求 2

**用户故事**：作为玩家，我想要清楚地看到哪些位置可以放置物品，以便做出正确的放置决策。

#### 验收标准

1. WHEN 预览格子位置与玩家在同一 Layer 且无障碍物 THEN 系统 SHALL 显示绿色格子
2. WHEN 预览格子位置与玩家不在同一 Layer THEN 系统 SHALL 显示红色格子
3. WHEN 预览格子位置有障碍物（Tree、Rock、Building、Player 标签或水域） THEN 系统 SHALL 显示红色格子
4. WHEN 预览格子位置超出玩家当前距离 THEN 系统 SHALL 仍然显示绿色格子（距离不影响颜色）

---

### 需求 3

**用户故事**：作为玩家，我想要点击确认放置位置后自动走过去放置，以便流畅地完成放置操作。

#### 验收标准

1. WHEN 玩家点击鼠标左键且所有预览格子为绿色 THEN 系统 SHALL 锁定预览 UI 位置
2. WHEN 预览 UI 位置锁定后 THEN 系统 SHALL 计算玩家到预览格子边界的最近点作为导航目标
3. WHEN 导航目标计算完成 THEN 系统 SHALL 启动玩家自动导航到目标点
4. WHEN 玩家点击鼠标左键且有任何预览格子为红色 THEN 系统 SHALL 不执行任何操作，预览 UI 继续跟随鼠标

---

### 需求 4

**用户故事**：作为玩家，我想要在走到目标位置后自动完成放置，以便无需额外操作。

#### 验收标准

1. WHEN 玩家 Collider 边界接近预览格子边界（触发距离内）且不重叠 THEN 系统 SHALL 触发放置操作
2. WHEN 放置操作触发 THEN 系统 SHALL 在预览位置生成物品实体
3. WHEN 放置操作触发 THEN 系统 SHALL 隐藏预览 UI
4. WHEN 放置操作触发 THEN 系统 SHALL 从背包扣除一个物品
5. WHEN 玩家已经站在预览格子边界附近（极少数情况） THEN 系统 SHALL 立即触发放置，无需导航

---

### 需求 5

**用户故事**：作为玩家，我想要在导航过程中取消放置，以便改变主意。

#### 验收标准

1. WHEN 玩家在导航过程中按下 ESC 或右键 THEN 系统 SHALL 取消导航
2. WHEN 导航取消 THEN 系统 SHALL 解锁预览 UI，恢复跟随鼠标模式
3. WHEN 玩家在导航过程中点击其他位置（全绿） THEN 系统 SHALL 更新锁定位置并重新导航

---

### 需求 6

**用户故事**：作为玩家，我想要放置的物品与我所在的楼层一致，以便物品正确显示在场景中。

#### 验收标准

1. WHEN 物品放置成功 THEN 系统 SHALL 将物品的 GameObject Layer 设置为玩家脚下地面的 Layer
2. WHEN 物品放置成功 THEN 系统 SHALL 将物品的 Sorting Layer 设置为与玩家一致
3. WHEN 物品放置成功 THEN 系统 SHALL 根据 Y 坐标计算并设置 Sorting Order

---

### 需求 7

**用户故事**：作为玩家，我想要种植树苗时遵守特殊规则，以便树木能够正常生长。

#### 验收标准

1. WHEN 玩家尝试在冬季放置树苗 THEN 系统 SHALL 阻止放置并显示提示"冬天无法种植树木"
2. WHEN 玩家尝试在耕地上放置树苗 THEN 系统 SHALL 显示红色格子
3. WHEN 玩家尝试在其他树木成长边距内放置树苗 THEN 系统 SHALL 显示红色格子

