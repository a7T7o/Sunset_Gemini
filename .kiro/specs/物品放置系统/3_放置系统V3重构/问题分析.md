# æ”¾ç½®ç³»ç»Ÿ V3 é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ”´ ä¸¥é‡é—®é¢˜

### é—®é¢˜ 1ï¼šçŠ¶æ€æœºé€»è¾‘é”™è¯¯ - Update ä¸­çš„çŠ¶æ€å¤„ç†

**è®¾è®¡è¦æ±‚**ï¼š
- Preview çŠ¶æ€ï¼šé¢„è§ˆè·Ÿéšé¼ æ ‡ï¼Œå®æ—¶éªŒè¯æ ¼å­
- Locked çŠ¶æ€ï¼šé¢„è§ˆå›ºå®šï¼Œç­‰å¾…å¯¼èˆªå¼€å§‹
- Navigating çŠ¶æ€ï¼šé¢„è§ˆå›ºå®šï¼Œç­‰å¾…åˆ°è¾¾

**å½“å‰ä»£ç ï¼ˆPlacementManagerV3.cs ç¬¬ 166-170 è¡Œï¼‰**ï¼š
```csharp
if (currentState == PlacementState.Preview || currentState == PlacementState.Locked)
{
    UpdatePreview();
}
```

**é—®é¢˜**ï¼š
1. âŒ Locked çŠ¶æ€ä¸åº”è¯¥è°ƒç”¨ UpdatePreviewï¼ˆè™½ç„¶ä½ç½®ä¸æ›´æ–°ï¼Œä½†æ ¼å­çŠ¶æ€ä¼šè¢«é‡æ–°è®¡ç®—ï¼‰
2. âŒ Navigating çŠ¶æ€ä¸‹å®Œå…¨æ²¡æœ‰å¤„ç†ï¼Œé¢„è§ˆå¯èƒ½ä¸æ˜¾ç¤º

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
if (currentState == PlacementState.Preview)
{
    UpdatePreview();  // åªåœ¨ Preview çŠ¶æ€æ›´æ–°
}
// Locked å’Œ Navigating çŠ¶æ€ä¸‹é¢„è§ˆä¿æŒé”å®šï¼Œä¸éœ€è¦æ›´æ–°
```

---

### é—®é¢˜ 2ï¼šNavigating çŠ¶æ€ä¸‹ç‚¹å‡»æ–°ä½ç½®çš„é€»è¾‘é”™è¯¯

**è®¾è®¡è¦æ±‚**ï¼šå¯¼èˆªä¸­ç‚¹å‡»æ–°ä½ç½®ï¼ˆå…¨ç»¿ï¼‰åº”è¯¥æ›´æ–°é”å®šä½ç½®å¹¶é‡æ–°å¯¼èˆª

**å½“å‰ä»£ç ï¼ˆPlacementManagerV3.cs ç¬¬ 295-307 è¡Œï¼‰**ï¼š
```csharp
else if (currentState == PlacementState.Navigating)
{
    if (validator.AreAllCellsValid(currentCellStates))  // âŒ ä½¿ç”¨æ—§æ•°æ®
    {
        navigator.CancelNavigation();
        LockPreviewPosition();
    }
}
```

**é—®é¢˜**ï¼š
- `currentCellStates` åœ¨ Navigating çŠ¶æ€ä¸‹æ²¡æœ‰æ›´æ–°
- éªŒè¯çš„æ˜¯æ—§çš„æ ¼å­çŠ¶æ€ï¼Œä¸æ˜¯å½“å‰é¼ æ ‡ä½ç½®çš„çŠ¶æ€

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
else if (currentState == PlacementState.Navigating)
{
    // å…ˆè·å–å½“å‰é¼ æ ‡ä½ç½®çš„æ ¼å­çŠ¶æ€
    Vector3 mousePos = GetMouseWorldPosition();
    Vector3 cellCenter = PlacementGridCalculator.GetCellCenter(mousePos);
    var newCellStates = validator.ValidateCells(cellCenter, placementPreview.GridSize, playerTransform);
    
    if (validator.AreAllCellsValid(newCellStates))
    {
        navigator.CancelNavigation();
        placementPreview.UnlockPosition();
        placementPreview.ForceUpdatePosition(mousePos);
        currentCellStates = newCellStates;
        LockPreviewPosition();
    }
}
```

---

### é—®é¢˜ 3ï¼šé¢„è§ˆ UI å¯èƒ½ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š
1. Sorting Layer è®¾ç½®ä¸º "Default"ï¼Œä½†åœºæ™¯ä¸­å¯èƒ½ä½¿ç”¨å…¶ä»– Sorting Layer
2. Sorting Order 32000 å¤ªé«˜ï¼Œå¯èƒ½è¶…å‡ºæ¸²æŸ“èŒƒå›´
3. æ ¼å­ Sprite æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œå¯èƒ½åˆ›å»ºå¤±è´¥

**æ£€æŸ¥ç‚¹**ï¼š
- PlacementPreviewV3.cs ç¬¬ 91 è¡Œï¼š`sortingOrder = 32000`
- PlacementGridCell.cs ç¬¬ 55 è¡Œï¼š`sortingOrder = 31999`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
åº”è¯¥ä½¿ç”¨ä¸ç©å®¶ç›¸åŒçš„ Sorting Layerï¼ŒOrder ä½¿ç”¨è¾ƒé«˜ä½†åˆç†çš„å€¼ï¼ˆå¦‚ 1000ï¼‰

---

### é—®é¢˜ 4ï¼šæ ¼å­é¢œè‰²å¯èƒ½ä¸æ­£ç¡®

**PlacementGridCell.CreateGridSprite()** åˆ›å»ºçš„æ˜¯ç™½è‰² Spriteï¼Œç„¶åé€šè¿‡ `spriteRenderer.color` ç€è‰²ã€‚

**æ½œåœ¨é—®é¢˜**ï¼š
- å¦‚æœ Sprite åˆ›å»ºå¤±è´¥ï¼Œæ ¼å­ä¸ä¼šæ˜¾ç¤º
- é¢œè‰²é€æ˜åº¦å¯èƒ½å¤ªä½ï¼ˆ0.4fï¼‰

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜

### é—®é¢˜ 5ï¼šç¼ºå°‘è°ƒè¯•æ—¥å¿—

å½“å‰ä»£ç åœ¨å…³é”®ä½ç½®ç¼ºå°‘è°ƒè¯•æ—¥å¿—ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜ã€‚

**éœ€è¦æ·»åŠ æ—¥å¿—çš„ä½ç½®**ï¼š
- EnterPlacementMode æ—¶
- UpdatePreview æ—¶
- OnLeftClick æ—¶
- LockPreviewPosition æ—¶
- ExecutePlacement æ—¶

---

### é—®é¢˜ 6ï¼šPlacementLayerDetector.GetPlayerLayer å¯èƒ½è¿”å›é”™è¯¯å€¼

éœ€è¦ç¡®è®¤è¿™ä¸ªæ–¹æ³•æ˜¯å¦æ­£ç¡®æ£€æµ‹ç©å®¶è„šä¸‹çš„åœ°é¢ Layerã€‚

---

## ğŸŸ¢ å»ºè®®æ”¹è¿›

### æ”¹è¿› 1ï¼šæ·»åŠ çŠ¶æ€å¯è§†åŒ–

åœ¨ Inspector ä¸­æ˜¾ç¤ºå½“å‰çŠ¶æ€ï¼Œä¾¿äºè°ƒè¯•ã€‚

### æ”¹è¿› 2ï¼šæ·»åŠ  Gizmos è°ƒè¯•

åœ¨ Scene è§†å›¾ä¸­ç»˜åˆ¶é¢„è§ˆè¾¹ç•Œã€å¯¼èˆªç›®æ ‡ç‚¹ç­‰ã€‚

---

## ä¿®å¤ä¼˜å…ˆçº§

1. **æœ€é«˜**ï¼šé—®é¢˜ 1 - çŠ¶æ€æœºé€»è¾‘
2. **æœ€é«˜**ï¼šé—®é¢˜ 2 - Navigating çŠ¶æ€ç‚¹å‡»é€»è¾‘
3. **é«˜**ï¼šé—®é¢˜ 3 - é¢„è§ˆ UI æ˜¾ç¤º
4. **ä¸­**ï¼šé—®é¢˜ 4 - æ ¼å­é¢œè‰²
5. **ä½**ï¼šé—®é¢˜ 5ã€6 - è°ƒè¯•å’Œæ”¹è¿›
