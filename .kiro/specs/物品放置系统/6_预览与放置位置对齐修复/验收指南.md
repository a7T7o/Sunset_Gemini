# 预览与放置位置对齐修复 - 验收指南

**创建日期**: 2026-01-21  
**版本**: V2（考虑底部对齐）

---

## 验收目标

确保放置系统的预览位置与实际放置位置完全一致，预览绿框正确包裹物品 Collider。

---

## 核心验收标准

### 1. 预览显示

- [ ] 预览 Sprite 来自预制体（不是 icon）
- [ ] 预览绿框正确包裹 Collider 区域
- [ ] 预览跟随鼠标移动，吸附到格子中心

### 2. 位置对齐

- [ ] **预览位置 = 放置位置**（无跳动）
- [ ] 放置后 Collider 中心 = 格子中心
- [ ] 多格子物品正确居中

---

## 测试步骤

### 测试 1：树苗放置

1. 打开 Unity，进入游戏场景
2. 选择树苗物品，进入放置模式
3. 移动鼠标，观察预览：
   - [ ] 预览 Sprite 是树苗外观（不是 icon）
   - [ ] 绿框正确包裹树苗底部 Collider
4. 点击放置：
   - [ ] 放置后物品位置与预览位置一致（无跳动）
   - [ ] 树苗底部对齐正常执行
5. 重复放置多个树苗，验证一致性

### 测试 2：箱子放置

1. 选择箱子物品，进入放置模式
2. 移动鼠标，观察预览：
   - [ ] 预览 Sprite 是箱子外观
   - [ ] 绿框正确包裹箱子 Collider
3. 点击放置：
   - [ ] 放置后物品位置与预览位置一致（无跳动）
   - [ ] 箱子底部对齐正常执行
4. 打开/关闭箱子，验证 Sprite 切换正常

### 测试 3：导航放置

1. 选择可放置物品
2. 点击远处的有效位置
3. 观察：
   - [ ] 预览锁定在目标位置
   - [ ] 玩家自动导航到目标附近
   - [ ] 到达后自动放置
   - [ ] 放置位置与预览位置一致

### 测试 4：连续放置

1. 选择有多个数量的可放置物品
2. 连续放置多个：
   - [ ] 每次放置位置都与预览一致
   - [ ] 物品数量正确扣除
   - [ ] 用完后自动退出放置模式

---

## 调试信息

如果测试失败，请检查 Console 中的调试日志：

```
[PlacementPreviewV3] 使用预制体 Sprite: xxx, localPos=(x, y, z)
[PlacementManagerV3] InstantiatePlacementPrefab: gridCenter=xxx, finalColliderCenter=xxx, placementPos=xxx
```

关键数值：
- `localPos` - 预览 Sprite 的本地位置偏移
- `gridCenter` - 格子中心（预览位置）
- `finalColliderCenter` - 计算的底部对齐后 Collider 中心
- `placementPos` - 实际放置位置

**预期关系**：`placementPos = gridCenter - finalColliderCenter`

---

## 已知限制

1. 当前实现假设所有可放置物品都会执行底部对齐
2. 如果预制体没有 SpriteRenderer，会回退到原始 Collider 中心计算

---

## 回归验证

- [ ] 原有放置功能正常
- [ ] NavGrid 刷新正常
- [ ] 撤销功能正常
- [ ] 背包扣除正常

---

**文档维护者**: Kiro  
**最后更新**: 2026-01-21
