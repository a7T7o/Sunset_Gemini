# 物品放置系统 - 开发记忆

## 模块概述

物品放置系统，允许玩家将可放置物品（如树苗、装饰物、建筑、箱子等）放置到世界中。

**核心功能**：
- 放置管理器（PlacementManagerV3）统一管理放置逻辑
- 可放置物品 SO 类型体系（SaplingData、StorageData、WorkstationData 等）
- 放置预览 UI（格子方框 + 物品半透明预览）
- 点击锁定 + 导航放置机制
- 背包联动（扣除物品、中断处理、连续放置）

## 当前状态

- **完成度**: 95%
- **最后更新**: 2026-01-21
- **状态**: 🔄 进行中（Bug 修复阶段）
- **当前版本**: V3

---

## 子工作区索引

| 编号 | 名称 | 状态 | 说明 |
|------|------|------|------|
| 0 | [V1版本实现](./0_V1版本实现/memory.md) | ✅ 完成 | 基础框架实现 |
| 1 | [可放置物品SO设计](./1_可放置物品SO设计/memory.md) | ✅ 完成 | SO 类型体系设计 |
| 2 | [放置系统重构](./2_放置系统重构/memory.md) | ✅ 完成 | V2 版本（已被 V3 取代） |
| 3 | [放置系统V3重构](./3_放置系统V3重构/memory.md) | ✅ 完成 | 当前使用版本 |
| 4 | [放置背包联动](./4_放置背包联动/memory.md) | ✅ 完成 | 背包扣除、中断处理 |
| 5 | [Bug修复与规则完善](./5_放置系统Bug修复与规则完善/memory.md) | 🔄 进行中 | 导航切换物品 Bug |
| 6 | [预览与放置位置对齐修复](./6_预览与放置位置对齐修复/memory.md) | 🔄 进行中 | Collider 中心对齐 |
| 7 | [可放置物品开发规范](./7_可放置物品开发规范/memory.md) | 🔄 进行中 | 统一底部对齐规范 |

---

## 关键决策汇总

| 决策 | 原因 | 日期 |
|------|------|------|
| 种子与树苗保持分离 | 系统边界清晰，放置逻辑本质不同 | 2025-12-30 |
| V3 取消"放置范围"概念 | 简化逻辑，改为"点击锁定 + 走过去放置" | 2026-01-03 |
| 红色格子只有两种情况 | Layer 不一致、有障碍物（含 Player） | 2026-01-03 |
| 使用快照机制 | 避免放置过程中物品切换导致数据错乱 | 2026-01-05 |
| 使用 Collider 中心对齐 | 用户要求预览框包裹 Collider，中心统一 | 2026-01-21 |

---

## 核心文件索引

### V3 版本核心脚本
| 文件 | 说明 |
|------|------|
| `PlacementManagerV3.cs` | 放置管理器（状态机） |
| `PlacementValidatorV3.cs` | 放置验证器 |
| `PlacementPreviewV3.cs` | 预览 UI |
| `PlacementNavigator.cs` | 导航和到达检测 |
| `PlacementGridCalculator.cs` | 格子计算 |
| `PlacementLayerDetector.cs` | Layer 检测 |

### 可放置物品 SO
| 文件 | 说明 |
|------|------|
| `PlaceableItemData.cs` | 可放置物品基类 |
| `SaplingData.cs` | 树苗数据 |
| `StorageData.cs` | 存储容器数据 |
| `WorkstationData.cs` | 工作台数据 |

---

## 🔴 当前待解决问题

### 严重 Bug：导航中切换物品导致数据错乱

**问题描述**：手持物品 A 点击放置进入导航状态，导航过程中切换到物品 B，系统会放置物品 B 但扣除物品 A 的数量。

**详情**：见 [5_放置系统Bug修复与规则完善/memory.md](./5_放置系统Bug修复与规则完善/memory.md)

---

## 规则文档

| 文档 | 说明 |
|------|------|
| [放置系统完整规则汇总.md](./5_放置系统Bug修复与规则完善/放置系统完整规则汇总.md) | 15 章节完整规则（权威文档） |
| [可放置物品位置处理规则.md](./5_放置系统Bug修复与规则完善/可放置物品位置处理规则.md) | 位置计算和对齐规则 |
| [使用指南.md](./使用指南.md) | 场景配置和使用说明 |

---

## 历史归档

旧版 memory.md 已归档至 `old/memory-archive-2026-01-20.md`


---

## 会话记录

### 会话 - 2026-01-21（预览与放置位置对齐问题深度分析）

**用户需求**:
> 修改前是树苗位置不正确箱子是正确的，修改后是全部反来了...全面的专业的冷静的分析后给我一个分析结果即可，我不需要你进行修复，我需要审核你的分析内容和改进方案

**用户反思**:
> 箱子的 sprite 样式切换的对齐其实在树木和石头控制器内我都要求过呀，为什么在这里就出错了呢

**完成任务**:
1. 深度分析 TreeControllerV2 和 ChestController 的底部对齐机制差异
2. 创建详细分析报告 V2

**核心发现**:
- TreeControllerV2.AlignSpriteBottom()：修改子物体 localPosition，**初始放置时会执行**
- ChestController.ApplySpriteWithBottomAlign()：修改根物体 position，**初始放置时不会执行**
- 当前代码假设所有物品都会执行底部对齐，但箱子不会

**推荐方案**:
方案 A：在 `GetColliderCenterAfterBottomAlign()` 中检测组件类型，只对会执行底部对齐的物品（TreeControllerV2 等）计算偏移

**相关文件**:
- `.kiro/specs/物品放置系统/6_预览与放置位置对齐修复/问题分析报告-V2.md` - 详细分析报告

**状态**: 待用户审核分析报告和改进方案
