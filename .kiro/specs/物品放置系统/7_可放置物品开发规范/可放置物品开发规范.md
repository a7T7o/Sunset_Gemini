# å¯æ”¾ç½®ç‰©å“å¼€å‘è§„èŒƒ

**ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-21  
**çŠ¶æ€**: ç”Ÿæ•ˆä¸­

---

## ä¸€ã€é€‚ç”¨èŒƒå›´

æœ¬è§„èŒƒé€‚ç”¨äºæ‰€æœ‰å¯é€šè¿‡æ”¾ç½®ç³»ç»Ÿæ”¾ç½®åˆ°ä¸–ç•Œä¸­çš„ç‰©å“ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š

| ç‰©å“ç±»å‹ | æ§åˆ¶å™¨ | SO ç±»å‹ | çŠ¶æ€ |
|---------|--------|---------|------|
| æ ‘è‹— | TreeControllerV2 | SaplingData | âœ… å·²ç¬¦åˆ |
| ç®±å­ | ChestController | StorageData | âŒ éœ€ä¿®æ”¹ |
| å·¥ä½œå° | WorkstationController | WorkstationData | ğŸ“‹ å¾…å¼€å‘ |
| è£…é¥°ç‰© | DecorationController | DecorationData | ğŸ“‹ å¾…å¼€å‘ |
| ç§å­ | - | SeedData | ğŸ“‹ å¾…è®¾è®¡ |

---

## äºŒã€é¢„åˆ¶ä½“ç»“æ„è§„èŒƒ

### 2.1 æ ‡å‡†ç»“æ„

```
{ItemName}_Root (æ ¹ç‰©ä½“)
â”œâ”€â”€ Transform: position = æ”¾ç½®ä½ç½®ï¼ˆæ ¼å­ä¸­å¿ƒï¼‰
â”œâ”€â”€ Tag: å¯¹åº”æ ‡ç­¾ï¼ˆTree/Chest/Workstation ç­‰ï¼‰
â”œâ”€â”€ Rigidbody2D (Static, å¯é€‰)
â”œâ”€â”€ CompositeCollider2D (å¯é€‰ï¼Œç”¨äºåˆå¹¶å­ç‰©ä½“ç¢°æ’ä½“)
â”‚
â”œâ”€â”€ {ItemName} (å­ç‰©ä½“) â† SpriteRenderer + Collider + Controller åœ¨è¿™é‡Œ
â”‚   â”œâ”€â”€ Transform: localPosition = (0, Y, 0)  â˜… Y ç”±åº•éƒ¨å¯¹é½è®¡ç®—
â”‚   â”œâ”€â”€ SpriteRenderer
â”‚   â”œâ”€â”€ PolygonCollider2D / BoxCollider2D
â”‚   â””â”€â”€ {ItemName}Controller
â”‚
â””â”€â”€ Shadow (å­ç‰©ä½“ï¼Œå¯é€‰)
    â””â”€â”€ SpriteRenderer
```

### 2.2 å…³é”®è¦æ±‚

1. **SpriteRenderer å¿…é¡»åœ¨å­ç‰©ä½“ä¸Š**ï¼Œä¸èƒ½åœ¨æ ¹ç‰©ä½“ä¸Š
2. **Collider å¿…é¡»ä¸ SpriteRenderer åœ¨åŒä¸€å­ç‰©ä½“ä¸Š**
3. **Controller è„šæœ¬æŒ‚è½½åœ¨å­ç‰©ä½“ä¸Š**
4. **æ ¹ç‰©ä½“çš„ position ä»£è¡¨æ”¾ç½®ä½ç½®**ï¼ˆæ ¼å­ä¸­å¿ƒï¼‰

---

## ä¸‰ã€åº•éƒ¨å¯¹é½è§„èŒƒï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### 3.1 æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰å¯æ”¾ç½®ç‰©å“å¿…é¡»åœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œåº•éƒ¨å¯¹é½ï¼Œä½¿ Sprite åº•éƒ¨ä¸­å¿ƒå¯¹é½åˆ°æ ¹ç‰©ä½“ä½ç½®ã€‚**

### 3.2 ç»Ÿä¸€å®ç°æ–¹å¼

```csharp
/// <summary>
/// åº•éƒ¨å¯¹é½ - æ‰€æœ‰å¯æ”¾ç½®ç‰©å“å¿…é¡»å®ç°
/// åœ¨ Start() æˆ– Initialize() ä¸­è°ƒç”¨
/// </summary>
private void AlignSpriteBottom()
{
    if (spriteRenderer == null || spriteRenderer.sprite == null) return;
    
    // è·å– Sprite æœ¬åœ°ç©ºé—´çš„åº•éƒ¨ Y åæ ‡
    Bounds spriteBounds = spriteRenderer.sprite.bounds;
    float spriteBottomOffset = spriteBounds.min.y;
    
    // è®¾ç½®å­ç‰©ä½“çš„ localPositionï¼Œä½¿ Sprite åº•éƒ¨å¯¹é½åˆ°çˆ¶ç‰©ä½“ä½ç½®
    Vector3 localPos = spriteRenderer.transform.localPosition;
    localPos.y = -spriteBottomOffset;
    spriteRenderer.transform.localPosition = localPos;
}
```

### 3.3 è§¦å‘æ—¶æœº

| æ—¶æœº | æ˜¯å¦æ‰§è¡Œ | è¯´æ˜ |
|------|---------|------|
| Start() | âœ… å¿…é¡» | åˆå§‹æ”¾ç½®æ—¶ |
| Initialize() | âœ… å¿…é¡» | åŠ¨æ€åˆ›å»ºæ—¶ |
| Sprite åˆ‡æ¢æ—¶ | âœ… å¿…é¡» | çŠ¶æ€å˜åŒ–æ—¶ï¼ˆå¦‚ç®±å­å¼€/å…³ï¼‰ |
| æ¯å¸§ Update | âŒ ç¦æ­¢ | æ€§èƒ½æµªè´¹ |

### 3.4 å‚è€ƒå®ç°ï¼šTreeControllerV2

```csharp
// TreeControllerV2.cs - ç¬¬ 1516-1530 è¡Œ
private void AlignSpriteBottom()
{
    if (!alignSpriteBottom) return;
    if (spriteRenderer == null || spriteRenderer.sprite == null) return;
    
    Bounds spriteBounds = spriteRenderer.sprite.bounds;
    float spriteBottomOffset = spriteBounds.min.y;
    
    Vector3 localPos = spriteRenderer.transform.localPosition;
    localPos.y = -spriteBottomOffset;
    spriteRenderer.transform.localPosition = localPos;
}
```

---

## å››ã€Collider é…ç½®è§„èŒƒ

### 4.1 Collider ç±»å‹é€‰æ‹©

| ç‰©å“ç±»å‹ | æ¨è Collider | åŸå›  |
|---------|--------------|------|
| æ ‘æœ¨ | PolygonCollider2D | åªè¦†ç›–æ ‘æ ¹ï¼Œå½¢çŠ¶ä¸è§„åˆ™ |
| ç®±å­ | PolygonCollider2D | è·Ÿéš Sprite å½¢çŠ¶ |
| å·¥ä½œå° | BoxCollider2D | å½¢çŠ¶è§„åˆ™ |
| è£…é¥°ç‰© | PolygonCollider2D | å½¢çŠ¶ä¸è§„åˆ™ |

### 4.2 Collider æ›´æ–°è§„èŒƒ

å½“ Sprite åˆ‡æ¢æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–° Collider å½¢çŠ¶ï¼š

```csharp
/// <summary>
/// æ›´æ–° PolygonCollider2D å½¢çŠ¶ä»¥åŒ¹é…å½“å‰ Sprite
/// </summary>
private void UpdateColliderShape()
{
    if (polyCollider == null || spriteRenderer == null || spriteRenderer.sprite == null) 
        return;
    
    var sprite = spriteRenderer.sprite;
    int shapeCount = sprite.GetPhysicsShapeCount();
    
    if (shapeCount == 0)
    {
        polyCollider.pathCount = 0;
        return;
    }
    
    polyCollider.pathCount = shapeCount;
    
    var physicsShape = new List<Vector2>();
    for (int i = 0; i < shapeCount; i++)
    {
        physicsShape.Clear();
        sprite.GetPhysicsShape(i, physicsShape);
        polyCollider.SetPath(i, physicsShape);
    }
    
    // ç¡®ä¿ç‰©ç†ç³»ç»ŸåŒæ­¥
    Physics2D.SyncTransforms();
}
```

### 4.3 NavGrid åˆ·æ–°

Collider å˜åŒ–åå¿…é¡»é€šçŸ¥ NavGrid åˆ·æ–°ï¼š

```csharp
private void RequestNavGridRefresh()
{
    NavGrid2D.OnRequestGridRefresh?.Invoke();
}
```

---

## äº”ã€Sprite çŠ¶æ€åˆ‡æ¢è§„èŒƒ

### 5.1 å®Œæ•´é“¾è·¯

å½“ Sprite çŠ¶æ€å˜åŒ–æ—¶ï¼Œå¿…é¡»æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

```
1. æ›´æ–° Sprite
2. æ‰§è¡Œåº•éƒ¨å¯¹é½
3. æ›´æ–° Collider å½¢çŠ¶
4. åˆ·æ–° NavGrid
```

### 5.2 æ ‡å‡†å®ç°

```csharp
/// <summary>
/// æ›´æ–° Sprite çŠ¶æ€ - æ ‡å‡†å®ç°
/// </summary>
private void UpdateSpriteState(Sprite newSprite)
{
    if (spriteRenderer == null || newSprite == null) return;
    
    // 1. æ›´æ–° Sprite
    spriteRenderer.sprite = newSprite;
    
    // 2. æ‰§è¡Œåº•éƒ¨å¯¹é½
    AlignSpriteBottom();
    
    // 3. æ›´æ–° Collider å½¢çŠ¶
    UpdateColliderShape();
    
    // 4. åˆ·æ–° NavGrid
    RequestNavGridRefresh();
}
```

---

## å…­ã€æ”¾ç½®ç³»ç»Ÿé›†æˆ

### 6.1 æ”¾ç½®ç³»ç»Ÿçš„å‡è®¾

æ”¾ç½®ç³»ç»Ÿï¼ˆPlacementGridCalculatorï¼‰å‡è®¾ï¼š
- æ‰€æœ‰å¯æ”¾ç½®ç‰©å“åœ¨æ”¾ç½®åä¼šæ‰§è¡Œåº•éƒ¨å¯¹é½
- åº•éƒ¨å¯¹é½ä½¿ç”¨ `localPosition.y = -sprite.bounds.min.y`

### 6.2 ä½ç½®è®¡ç®—å…¬å¼

```csharp
// æ”¾ç½®å Collider ä¸­å¿ƒ = åŸå§‹ Collider ä¸­å¿ƒ + (0, åº•éƒ¨å¯¹é½åç§»)
float bottomAlignOffset = -sprite.bounds.min.y;
Vector2 finalColliderCenter = new Vector2(
    colliderCenter.x, 
    colliderCenter.y + bottomAlignOffset
);
```

### 6.3 é¢„è§ˆä½ç½®è®¡ç®—

```csharp
// é¢„è§ˆ Sprite çš„ localPosition
Vector3 previewLocalPos = new Vector3(
    -finalColliderCenter.x,
    bottomAlignOffset - finalColliderCenter.y,
    0
);
```

---

## ä¸ƒã€æ–°ç‰©å“å¼€å‘æ£€æŸ¥æ¸…å•

å¼€å‘æ–°çš„å¯æ”¾ç½®ç‰©å“æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

### 7.1 é¢„åˆ¶ä½“ç»“æ„
- [ ] SpriteRenderer åœ¨å­ç‰©ä½“ä¸Š
- [ ] Collider ä¸ SpriteRenderer åœ¨åŒä¸€å­ç‰©ä½“ä¸Š
- [ ] Controller è„šæœ¬åœ¨å­ç‰©ä½“ä¸Š
- [ ] æ ¹ç‰©ä½“æœ‰æ­£ç¡®çš„ Tag

### 7.2 åº•éƒ¨å¯¹é½
- [ ] å®ç°äº† `AlignSpriteBottom()` æ–¹æ³•
- [ ] åœ¨ `Start()` æˆ– `Initialize()` ä¸­è°ƒç”¨
- [ ] Sprite åˆ‡æ¢æ—¶è°ƒç”¨

### 7.3 Collider æ›´æ–°
- [ ] å®ç°äº† `UpdateColliderShape()` æ–¹æ³•
- [ ] Sprite åˆ‡æ¢æ—¶è°ƒç”¨
- [ ] è°ƒç”¨åæ‰§è¡Œ `Physics2D.SyncTransforms()`

### 7.4 NavGrid é›†æˆ
- [ ] å®ç°äº† `RequestNavGridRefresh()` æ–¹æ³•
- [ ] Collider å˜åŒ–åè°ƒç”¨
- [ ] ç‰©å“é”€æ¯æ—¶è°ƒç”¨

---

## å…«ã€ç°æœ‰ç‰©å“åˆè§„çŠ¶æ€

| ç‰©å“ | é¢„åˆ¶ä½“ç»“æ„ | åº•éƒ¨å¯¹é½ | Collider æ›´æ–° | NavGrid åˆ·æ–° | æ€»ä½“çŠ¶æ€ |
|------|-----------|---------|--------------|-------------|---------|
| TreeControllerV2 | âœ… | âœ… | âœ… | âœ… | âœ… å®Œå…¨åˆè§„ |
| ChestController | âœ… | âœ… | âœ… | âœ… | âœ… å®Œå…¨åˆè§„ |

### 8.1 ChestController ä¿®æ”¹è®°å½•ï¼ˆ2026-01-21ï¼‰

**å·²å®Œæˆä¿®æ”¹**ï¼š
1. æ–°å¢ `AlignSpriteBottom()` æ–¹æ³• - ä¸ TreeControllerV2 å®Œå…¨ä¸€è‡´
2. ä¿®æ”¹ `UpdateSpriteForState()` - ä½¿ç”¨æ–°çš„ `AlignSpriteBottom()` æ–¹æ³•
3. æ ‡è®°æ—§çš„ `ApplySpriteWithBottomAlign()` ä¸º `[Obsolete]`

**ä¿®æ”¹å‰**ï¼š
- ä¿®æ”¹æ ¹ç‰©ä½“ positionï¼ŒåŸºäºé”šç‚¹å·®å€¼è®¡ç®—
- åˆå§‹æ”¾ç½®æ—¶ä¸ä¼šæ‰§è¡Œåº•éƒ¨å¯¹é½

**ä¿®æ”¹å**ï¼š
- ä¿®æ”¹å­ç‰©ä½“ localPositionï¼Œä½¿ç”¨ `-sprite.bounds.min.y`
- åˆå§‹æ”¾ç½®æ—¶ä¼šæ‰§è¡Œåº•éƒ¨å¯¹é½ï¼ˆé€šè¿‡ Initialize â†’ UpdateSprite â†’ UpdateSpriteForState â†’ AlignSpriteBottom é“¾è·¯ï¼‰

---

## ä¹ã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| 1.0 | 2026-01-21 | åˆå§‹ç‰ˆæœ¬ï¼Œå®šä¹‰æ ¸å¿ƒè§„èŒƒ |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Kiro  
**æœ€åæ›´æ–°**: 2026-01-21
