# 2_放置系统重构 - 子工作区记忆

## 概述
- **创建日期**: 2025-12-31
- **状态**: ✅ 已完成（被 V3 取代）
- **目标**: 重构放置系统，实现方块中心放置、Layer 同步、预览 UI

## 会话记录

### 会话 1 - 2025-12-31（V2 实现）

**用户需求**:
> 1、对于树苗种植你需要获取当前的点击的部分的layer，并对种下的树苗的所有部分进行初始化
> 2、你可以同一位置种植多个树苗，并且你的种植会失败，你不应该是我点击整数位置坐标才允许放置，而是选择我点击位置举例最近的一个整数坐标
> 3、对于种植肯定要检测碰撞体以及种植部分是否与玩家图层一致
> 4、对于种植最重要的一步，也是放置物品最重要的一步，那么就是预放置的UI显示

**完成任务**:
1. ✅ 创建 PlacementGridCalculator.cs - 方块中心和格子计算
2. ✅ 创建 PlacementLayerDetector.cs - Layer 检测和同步
3. ✅ 创建 PlacementGridCell.cs - 单个格子渲染组件
4. ✅ 创建 PlacementPreviewV2.cs - 预览 UI 系统
5. ✅ 创建 PlacementValidatorV2.cs - 完整验证逻辑
6. ✅ 创建 PlacementManagerV2.cs - 重构放置管理器

**核心改进**:
- 方块中心放置：`Floor(pos) + 0.5`
- Layer 同步到所有子物体
- Order 计算：`-Round(Y × 100) + offset`
- 格子方框预览（绿色=可放置，红色=被遮挡）

---

### 会话 2-3 - 2025-12-31（问题排查与修复）

**问题**:
1. 预览 UI 不可见（Sorting Layer 设置错误）
2. 左键点击不放置（Layer 检测逻辑错误）

**修复**:
- Sorting Order 改为 32000/31999
- GetPlayerLayer() 改为检测玩家脚下地面的 Layer

---

## 关键决策

| 决策 | 原因 | 日期 |
|------|------|------|
| 使用方块中心放置 | Floor(pos) + 0.5，符合网格对齐需求 | 2025-12-31 |
| Layer 同步到所有子物体 | 确保放置物体在正确的层级显示 | 2025-12-31 |
| 创建 V2 版本而非修改原版 | 保持向后兼容，便于对比测试 | 2025-12-31 |

## 备注
此版本后被 V3 版本取代，V3 取消了"放置范围"概念，改为"点击锁定 + 走过去放置"。
