# æ”¾ç½®ç³»ç»Ÿå¤šé—®é¢˜åˆ†ææŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2026-01-21  
**åˆ†æè€…**: Kiro  
**çŠ¶æ€**: å¾…ç”¨æˆ·å®¡æ ¸

---

## ä¸€ã€é—®é¢˜æ€»è§ˆ

æ ¹æ®ç”¨æˆ·æä¾›çš„ 8 å¼ æˆªå›¾ï¼Œè¯†åˆ«å‡ºä»¥ä¸‹é—®é¢˜ï¼š

| ç¼–å· | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ |
|------|------|---------|---------|
| P1 | æ ‘è‹—é‡å¤æ”¾ç½® | ğŸ”´ ä¸¥é‡ | æ¸¸æˆé€»è¾‘ |
| P2 | å¤šæ ¼å­ç‰©å“åæ ‡ä¸å¯¹é½ | ğŸŸ¡ ä¸­ç­‰ | è§†è§‰ä¸€è‡´æ€§ |
| P3 | æ— ç¢°æ’ä½“ç‰©å“æ£€æµ‹ç¼ºå¤± | ğŸŸ¡ ä¸­ç­‰ | åç»­æ‰©å±• |
| P4 | é¢„è§ˆé€è§†é—®é¢˜ | ğŸŸ¢ è½»å¾® | è§†è§‰ä½“éªŒ |

---

## äºŒã€é—®é¢˜ 1ï¼šæ ‘è‹—é‡å¤æ”¾ç½®ï¼ˆæœ€ä¸¥é‡ï¼‰

### 2.1 ç°è±¡æè¿°

ä»æˆªå›¾ 1ã€2ã€6 å¯ä»¥çœ‹åˆ°ï¼š
- ç»¿è‰²é¢„è§ˆæ¡†å¯ä»¥æ”¾åœ¨å·²æœ‰æ ‘è‹—çš„ä½ç½®ä¸Š
- ç³»ç»Ÿæ²¡æœ‰æ£€æµ‹åˆ°å·²å­˜åœ¨çš„æ ‘è‹—ï¼Œå…è®¸é‡å¤æ”¾ç½®

### 2.2 æ ¹æœ¬åŸå› 

**ä»£ç è°ƒç”¨é“¾åˆ†æ**ï¼š

```
PlacementManagerV3.UpdatePreview()
    â†“
validator.ValidateCells(previewPos, gridSize, playerTransform)
    â†“
ValidateSingleCell(cellCenter, cellIndex, playerTransform)
    â†“
HasObstacle(cellCenter)  â† ä½¿ç”¨ Physics2D.OverlapBoxAll()
    â†“
âŒ æ ‘è‹—ï¼ˆStage 0ï¼‰æ²¡æœ‰ç¢°æ’ä½“ï¼Œæ£€æµ‹ä¸åˆ°ï¼
```

**å…³é”®å‘ç°**ï¼š

1. `PlacementValidatorV3.cs` ä¸­å­˜åœ¨ `ValidateSaplingPlacement()` æ–¹æ³•
2. è¿™ä¸ªæ–¹æ³•åŒ…å« `HasTreeAtPosition()` é€»è¾‘ï¼Œå¯ä»¥æ£€æµ‹æ— ç¢°æ’ä½“çš„æ ‘è‹—
3. **ä½†æ˜¯ `PlacementManagerV3` ä»æœªè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼**

**ä»£ç è¯æ®**ï¼š

```csharp
// PlacementValidatorV3.cs - ç¬¬ 171-203 è¡Œ
public CellStateV3 ValidateSaplingPlacement(SaplingData sapling, Vector3 position, Transform playerTransform)
{
    // åŸºç¡€æ ¼å­éªŒè¯
    var baseState = ValidateSingleCell(position, Vector2Int.zero, playerTransform);
    if (!baseState.isValid)
        return baseState;
    
    // ... å­£èŠ‚æ£€æŸ¥ã€è€•åœ°æ£€æŸ¥ ...
    
    // æ£€æŸ¥æˆé•¿è¾¹è·ï¼ˆä½¿ç”¨ä½ç½®æ£€æµ‹ï¼Œä¸ä¾èµ–ç¢°æ’ä½“ï¼‰
    if (sapling != null)
    {
        float vMargin, hMargin;
        if (!sapling.GetStage0Margins(out vMargin, out hMargin))
        {
            vMargin = 0.2f;
            hMargin = 0.15f;
        }
        
        if (HasTreeAtPosition(position, Mathf.Max(vMargin, hMargin)))
        {
            return new CellStateV3(Vector2Int.zero, false, InvalidReasonV3.TreeTooClose);
        }
    }
    
    return new CellStateV3(Vector2Int.zero, true, InvalidReasonV3.None);
}
```

```csharp
// PlacementValidatorV3.cs - ç¬¬ 213-243 è¡Œ
public bool HasTreeAtPosition(Vector3 center, float checkRadius)
{
    // æ–¹æ³•1ï¼šä½¿ç”¨ Physics2D æ£€æµ‹æœ‰ç¢°æ’ä½“çš„æ ‘æœ¨ï¼ˆStage 1+ï¼‰
    Collider2D[] hits = Physics2D.OverlapCircleAll(center, checkRadius);
    foreach (var hit in hits)
    {
        var treeController = hit.GetComponentInParent<TreeControllerV2>();
        if (treeController != null)
            return true;
    }
    
    // æ–¹æ³•2ï¼šéå†åœºæ™¯ä¸­æ‰€æœ‰ TreeControllerV2ï¼Œæ£€æµ‹æ ‘è‹—ï¼ˆStage 0ï¼Œæ— ç¢°æ’ä½“ï¼‰
    var allTrees = Object.FindObjectsByType<TreeControllerV2>(FindObjectsSortMode.None);
    foreach (var tree in allTrees)
    {
        Vector3 treeRootPos = tree.transform.parent != null 
            ? tree.transform.parent.position 
            : tree.transform.position;
        
        float distance = Vector2.Distance(
            new Vector2(center.x, center.y),
            new Vector2(treeRootPos.x, treeRootPos.y)
        );
        
        if (distance < checkRadius)
            return true;
    }
    
    return false;
}
```

### 2.3 ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šæœ€å°ä¾µå…¥ä¿®å¤**

åœ¨ `PlacementManagerV3.UpdatePreview()` ä¸­ï¼Œæ ¹æ®ç‰©å“ç±»å‹é€‰æ‹©éªŒè¯æ–¹æ³•ï¼š

```csharp
private void UpdatePreview()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // â˜… æ ¹æ®ç‰©å“ç±»å‹é€‰æ‹©éªŒè¯æ–¹æ³•
    if (currentPlacementItem is SaplingData saplingData)
    {
        // æ ‘è‹—ä½¿ç”¨ä¸“ç”¨éªŒè¯
        var saplingState = validator.ValidateSaplingPlacement(saplingData, previewPos, playerTransform);
        currentCellStates = new List<CellStateV3> { saplingState };
    }
    else
    {
        // å…¶ä»–ç‰©å“ä½¿ç”¨é€šç”¨éªŒè¯
        currentCellStates = validator.ValidateCells(previewPos, gridSize, playerTransform);
    }
    
    placementPreview.UpdateCellStates(currentCellStates);
}
```

**æ–¹æ¡ˆ Bï¼šåœ¨ ValidateCells ä¸­é›†æˆ**

ä¿®æ”¹ `ValidateCells()` æ–¹æ³•ï¼Œæ¥å—ç‰©å“ç±»å‹å‚æ•°ï¼š

```csharp
public List<CellStateV3> ValidateCells(Vector3 centerPosition, Vector2Int gridSize, 
    Transform playerTransform, ItemData item = null)
{
    // ... ç°æœ‰é€»è¾‘ ...
    
    // å¦‚æœæ˜¯æ ‘è‹—ï¼Œé¢å¤–æ£€æŸ¥æ ‘æœ¨é—´è·
    if (item is SaplingData saplingData)
    {
        if (HasTreeAtPosition(centerPosition, GetSaplingCheckRadius(saplingData)))
        {
            // æ ‡è®°ä¸ºæ— æ•ˆ
        }
    }
}
```

**æ¨è**ï¼šæ–¹æ¡ˆ Aï¼Œå› ä¸ºæ”¹åŠ¨æœ€å°ï¼Œé£é™©æœ€ä½ã€‚

---

## ä¸‰ã€é—®é¢˜ 2ï¼šå¤šæ ¼å­ç‰©å“åæ ‡ä¸å¯¹é½

### 3.1 ç°è±¡æè¿°

ä»æˆªå›¾ 7 å¯ä»¥çœ‹åˆ°ï¼š
- å¤§ç®±å­ï¼ˆ2æ ¼ Colliderï¼‰å’Œå°ç®±å­/æ ‘è‹—ï¼ˆ1æ ¼ Colliderï¼‰çš„ä½ç½®æ˜æ˜¾ä¸å¯¹é½
- å®ƒä»¬åº”è¯¥ä½¿ç”¨åŒä¸€ä¸ª GridCell åæ ‡ç³»ç»Ÿ

### 3.2 æ ¹æœ¬åŸå› 

**å½“å‰åæ ‡è®¡ç®—é€»è¾‘**ï¼š

```csharp
// PlacementGridCalculator.cs
public static Vector2 GetColliderCenterAfterBottomAlign(GameObject prefab)
{
    // è®¡ç®—åº•éƒ¨å¯¹é½åç§»ï¼š-sprite.bounds.min.y
    float bottomAlignOffset = -sr.sprite.bounds.min.y;
    
    // è·å–åŸå§‹ Collider ä¸­å¿ƒ
    Vector2 colliderCenter = GetColliderLocalCenter(prefab);
    
    // åº•éƒ¨å¯¹é½åï¼ŒCollider ä¸­å¿ƒç›¸å¯¹äºç‰©å“åŸç‚¹çš„ä½ç½®
    return new Vector2(colliderCenter.x, colliderCenter.y + bottomAlignOffset);
}
```

**é—®é¢˜**ï¼š
1. ä¸åŒå¤§å°çš„ç‰©å“ï¼ŒCollider ä¸­å¿ƒä½ç½®ä¸åŒ
2. åº•éƒ¨å¯¹é½åï¼ŒCollider ä¸­å¿ƒçš„ Y åç§»ä¹Ÿä¸åŒ
3. å¯¼è‡´æ”¾ç½®ä½ç½®è®¡ç®—ç»“æœä¸ä¸€è‡´

### 3.3 æœŸæœ›è¡Œä¸º

```
GridCell åæ ‡ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚0,3â”‚1,3â”‚2,3â”‚3,3â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚0,2â”‚1,2â”‚2,2â”‚3,2â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚0,1â”‚1,1â”‚2,1â”‚3,1â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚0,0â”‚1,0â”‚2,0â”‚3,0â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

1æ ¼ç‰©å“ï¼ˆæ ‘è‹—ã€å°ç®±å­ï¼‰ï¼š
- å ç”¨ 1 ä¸ªæ ¼å­
- æ”¾ç½®åœ¨æ ¼å­ä¸­å¿ƒ (x+0.5, y+0.5)

2æ ¼ç‰©å“ï¼ˆå¤§ç®±å­ï¼‰ï¼š
- å ç”¨ 2 ä¸ªæ ¼å­ï¼ˆå¦‚ 1,1 å’Œ 2,1ï¼‰
- æ”¾ç½®ä½ç½®åº”è¯¥ä½¿ Collider è¦†ç›–è¿™ 2 ä¸ªæ ¼å­
```

### 3.4 ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šç»Ÿä¸€ä½¿ç”¨æ ¼å­å·¦ä¸‹è§’ä½œä¸ºé”šç‚¹**

```csharp
// æ”¾ç½®ä½ç½® = å ç”¨æ ¼å­çš„å·¦ä¸‹è§’
Vector3 placementPosition = new Vector3(
    Mathf.Floor(gridCenter.x),
    Mathf.Floor(gridCenter.y),
    0
);
```

**æ–¹æ¡ˆ Bï¼šæ ¹æ®æ ¼å­æ•°é‡è®¡ç®—ä¸­å¿ƒåç§»**

```csharp
// å¯¹äº NxM æ ¼å­çš„ç‰©å“
// æ”¾ç½®ä½ç½® = å·¦ä¸‹è§’æ ¼å­ä¸­å¿ƒ + åç§»
Vector3 offset = new Vector3(
    (gridSize.x - 1) * 0.5f,
    (gridSize.y - 1) * 0.5f,
    0
);
```

**æ–¹æ¡ˆ Cï¼šé‡æ–°è®¾è®¡åæ ‡ç³»ç»Ÿ**

å¼•å…¥"å ç”¨æ ¼å­"æ¦‚å¿µï¼Œç‰©å“è®°å½•å®ƒå ç”¨çš„æ‰€æœ‰æ ¼å­ç´¢å¼•ï¼Œè€Œéå•ä¸€ä½ç½®ã€‚

**æ¨è**ï¼šæ–¹æ¡ˆ Bï¼Œå› ä¸ºä¸ç°æœ‰ç³»ç»Ÿå…¼å®¹æ€§æœ€å¥½ã€‚

---

## å››ã€é—®é¢˜ 3ï¼šæ— ç¢°æ’ä½“ç‰©å“æ£€æµ‹ç¼ºå¤±

### 4.1 ç°è±¡æè¿°

- æ ‘è‹—ï¼ˆStage 0ï¼‰æ²¡æœ‰ç¢°æ’ä½“
- åç»­çš„ç§å­ä¹Ÿæ˜¯æ— ç¢°æ’ä½“ä½†å®é™…å­˜åœ¨
- å½“å‰ `HasObstacle()` æ— æ³•æ£€æµ‹è¿™äº›ç‰©å“

### 4.2 å½“å‰æ£€æµ‹é€»è¾‘

```csharp
// PlacementValidatorV3.cs - HasObstacle()
public bool HasObstacle(Vector3 cellCenter)
{
    Vector2 boxSize = new Vector2(0.9f, 0.9f);
    Collider2D[] hits = Physics2D.OverlapBoxAll(cellCenter, boxSize, 0f);
    
    foreach (var hit in hits)
    {
        if (HasAnyTag(hit.transform, obstacleTags))
        {
            return true;
        }
    }
    
    return false;
}
```

**é—®é¢˜**ï¼šåªèƒ½æ£€æµ‹æœ‰ç¢°æ’ä½“çš„ç‰©å“ã€‚

### 4.3 ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šå¢åŠ æ ‡ç­¾æ£€æµ‹**

ä¸ºæ— ç¢°æ’ä½“ç‰©å“æ·»åŠ ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚ `Placed`ï¼‰ï¼Œç„¶åéå†åœºæ™¯æ£€æµ‹ï¼š

```csharp
public bool HasPlacedItemAtPosition(Vector3 center, float checkRadius)
{
    // æ£€æµ‹æ‰€æœ‰å¸¦ "Placed" æ ‡ç­¾çš„ç‰©å“
    var placedItems = GameObject.FindGameObjectsWithTag("Placed");
    foreach (var item in placedItems)
    {
        float distance = Vector2.Distance(center, item.transform.position);
        if (distance < checkRadius)
            return true;
    }
    return false;
}
```

**æ–¹æ¡ˆ Bï¼šç»´æŠ¤"å·²å ç”¨æ ¼å­"æ³¨å†Œè¡¨**

```csharp
public static class PlacedCellRegistry
{
    private static HashSet<Vector2Int> occupiedCells = new HashSet<Vector2Int>();
    
    public static void RegisterCell(Vector2Int cell) => occupiedCells.Add(cell);
    public static void UnregisterCell(Vector2Int cell) => occupiedCells.Remove(cell);
    public static bool IsCellOccupied(Vector2Int cell) => occupiedCells.Contains(cell);
}
```

**æ–¹æ¡ˆ Cï¼šéå†ç‰¹å®šç»„ä»¶**

ç±»ä¼¼å½“å‰ `HasTreeAtPosition()` çš„åšæ³•ï¼Œéå†æ‰€æœ‰ç›¸å…³ç»„ä»¶ï¼š

```csharp
public bool HasPlaceableAtPosition(Vector3 center, float checkRadius)
{
    // æ£€æµ‹æ ‘è‹—
    var allTrees = Object.FindObjectsByType<TreeControllerV2>(FindObjectsSortMode.None);
    // ...
    
    // æ£€æµ‹ç§å­ï¼ˆåç»­æ·»åŠ ï¼‰
    var allSeeds = Object.FindObjectsByType<SeedController>(FindObjectsSortMode.None);
    // ...
}
```

**æ¨è**ï¼šæ–¹æ¡ˆ Bï¼Œå› ä¸ºæ€§èƒ½æœ€å¥½ï¼Œä¸”æ˜“äºæ‰©å±•ã€‚

---

## äº”ã€é—®é¢˜ 4ï¼šé¢„è§ˆé€è§†é—®é¢˜

### 5.1 ç°è±¡æè¿°

ä»æˆªå›¾ 8 å¯ä»¥çœ‹åˆ°ï¼š
- å¤§ç®±å­é¢„è§ˆæ˜¾ç¤ºåœ¨æˆ¿å­ä¸Šæ–¹
- è™½ç„¶æ”¾ç½®ä½ç½®æ˜¯æœ‰æ•ˆçš„ï¼ˆæ²¡æœ‰ç¢°æ’ä½“ï¼‰
- ä½†è§†è§‰ä¸Šçœ‹èµ·æ¥åƒæ˜¯æ”¾åœ¨æˆ¿å­ä¸Šé¢

### 5.2 æ ¹æœ¬åŸå› 

```csharp
// PlacementPreviewV3.cs - Awake()
itemPreviewRenderer.sortingOrder = 32000; // éå¸¸é«˜çš„å€¼ç¡®ä¿åœ¨æœ€ä¸Šå±‚
```

é¢„è§ˆçš„ Sorting Order è®¾ç½®ä¸º 32000ï¼Œå¯¼è‡´å®ƒæ€»æ˜¯æ˜¾ç¤ºåœ¨æ‰€æœ‰ç‰©ä½“ä¸Šæ–¹ã€‚

### 5.3 ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šé™ä½ Sorting Order**

ä½¿é¢„è§ˆä¸åŒå±‚ç‰©ä½“æ­£ç¡®æ’åºï¼š

```csharp
// ä½¿ç”¨ä¸æ”¾ç½®ä½ç½®ç›¸åŒçš„ Sorting Order è®¡ç®—
int order = -Mathf.RoundToInt(position.y * sortingOrderMultiplier) + sortingOrderOffset;
itemPreviewRenderer.sortingOrder = order + 1; // æ¯”åŒä½ç½®ç‰©ä½“é«˜ 1
```

**æ–¹æ¡ˆ Bï¼šæ·»åŠ åŠé€æ˜æ•ˆæœ**

ä¿æŒé«˜ Sorting Orderï¼Œä½†å¢åŠ é€æ˜åº¦ï¼Œè®©ç©å®¶æ˜ç¡®çŸ¥é“è¿™æ˜¯é¢„è§ˆï¼š

```csharp
itemPreviewRenderer.color = new Color(1, 1, 1, 0.5f); // 50% é€æ˜
```

**æ–¹æ¡ˆ Cï¼šä¿æŒç°çŠ¶**

è¿™æ˜¯é¢„è§ˆçš„æ­£å¸¸è¡Œä¸ºï¼Œç©å®¶åº”è¯¥èƒ½çœ‹åˆ°é¢„è§ˆåœ¨å“ªé‡Œã€‚

**æ¨è**ï¼šéœ€è¦ç”¨æˆ·ç¡®è®¤ã€‚å¦‚æœç”¨æˆ·è®¤ä¸ºè¿™æ˜¯é—®é¢˜ï¼Œæ¨èæ–¹æ¡ˆ Aã€‚

---

## å…­ã€ä¿®å¤ä¼˜å…ˆçº§å’Œå·¥ä½œé‡ä¼°ç®—

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä¿®å¤æ–¹æ¡ˆ | å·¥ä½œé‡ | é£é™© |
|--------|------|---------|--------|------|
| P0 | æ ‘è‹—é‡å¤æ”¾ç½® | æ–¹æ¡ˆ A | 0.5h | ä½ |
| P1 | å¤šæ ¼å­ç‰©å“åæ ‡ä¸å¯¹é½ | æ–¹æ¡ˆ B | 2h | ä¸­ |
| P2 | æ— ç¢°æ’ä½“ç‰©å“æ£€æµ‹ | æ–¹æ¡ˆ B | 3h | ä¸­ |
| P3 | é¢„è§ˆé€è§†é—®é¢˜ | å¾…ç¡®è®¤ | 0.5h | ä½ |

---

## ä¸ƒã€å¾…ç”¨æˆ·ç¡®è®¤

1. **æ ‘è‹—é‡å¤æ”¾ç½®**ï¼šæ˜¯å¦åŒæ„ä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆæœ€å°ä¾µå…¥ä¿®å¤ï¼‰ï¼Ÿ

2. **å¤šæ ¼å­ç‰©å“åæ ‡ä¸å¯¹é½**ï¼š
   - æœŸæœ›çš„å¯¹é½è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ
   - æ˜¯å¦æ‰€æœ‰ç‰©å“éƒ½åº”è¯¥ä»¥æ ¼å­ä¸­å¿ƒä¸ºé”šç‚¹ï¼Ÿ
   - è¿˜æ˜¯ä»¥æ ¼å­å·¦ä¸‹è§’ä¸ºé”šç‚¹ï¼Ÿ

3. **æ— ç¢°æ’ä½“ç‰©å“æ£€æµ‹**ï¼š
   - æ˜¯å¦éœ€è¦å¼•å…¥"å·²å ç”¨æ ¼å­"æ³¨å†Œè¡¨æœºåˆ¶ï¼Ÿ
   - è¿˜æ˜¯ç»§ç»­ä½¿ç”¨éå†ç»„ä»¶çš„æ–¹å¼ï¼Ÿ

4. **é¢„è§ˆé€è§†é—®é¢˜**ï¼š
   - è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Ÿ
   - è¿˜æ˜¯ä¿æŒç°çŠ¶ï¼Ÿ

---

## å…«ã€ç›¸å…³å†å²è®¨è®º

åœ¨ `æ”¾ç½®ç³»ç»Ÿå®Œæ•´è§„åˆ™æ±‡æ€».md` ä¸­å·²ç»è®°å½•äº†æ ‘è‹—ç‰¹æ®Šæ£€æµ‹çš„éœ€æ±‚ï¼š

> ### 5.5 æ ‘è‹—ç‰¹æ®Šæ£€æµ‹ï¼ˆæ— ç¢°æ’ä½“ï¼‰
> 
> æ ‘è‹—ï¼ˆStage 0ï¼‰æ²¡æœ‰ç¢°æ’ä½“ï¼Œéœ€è¦ç‰¹æ®Šæ£€æµ‹

ä½†è¿™ä¸ªéœ€æ±‚åœ¨ `PlacementManagerV3` ä¸­æ²¡æœ‰è¢«æ­£ç¡®å®ç°ã€‚

