# æ”¾ç½®ç³»ç»Ÿé—®é¢˜å…¨é¢åˆ†ææŠ¥å‘Š V2

**åˆ›å»ºæ—¥æœŸ**: 2026-01-22  
**çŠ¶æ€**: ğŸ”´ éœ€è¦é‡æ–°è®¾è®¡

---

## ä¸€ã€é—®é¢˜ç°è±¡ï¼ˆä»æˆªå›¾åˆ†æï¼‰

### é—®é¢˜ 1ï¼šæ‰€æœ‰å¯æ”¾ç½®ç‰©å“éƒ½å¯ä»¥æ”¾åœ¨æ ‘æœ¨/ç®±å­ä¸Š

| æˆªå›¾ | ç°è±¡ |
|------|------|
| å›¾1-2 | ç®±å­é¢„è§ˆæ¡†ï¼ˆç»¿è‰²ï¼‰å¯ä»¥æ”¾åœ¨å·²æœ‰ç®±å­ä¸Šé¢ |
| å›¾3 | æ ‘è‹—é¢„è§ˆåœ¨ç®±å­æ—è¾¹æ˜¯ç»¿è‰²çš„ |

**ç»“è®º**ï¼šä¸ä»…æ˜¯æ ‘è‹—ï¼Œæ‰€æœ‰å¯æ”¾ç½®ç‰©å“éƒ½æ²¡æœ‰æ­£ç¡®æ£€æµ‹å·²æ”¾ç½®çš„ç‰©å“ã€‚

### é—®é¢˜ 2ï¼šæ ¼å­å¯¹é½é—®é¢˜

| æˆªå›¾ | ç°è±¡ |
|------|------|
| å›¾4-5 | å¤§ç®±å­ï¼ˆ2æ ¼ï¼‰çš„é¢„è§ˆæ¡†å’Œæ ‘è‹—ï¼ˆ1æ ¼ï¼‰æ˜æ˜¾ä¸åœ¨åŒä¸€ä¸ªç½‘æ ¼ç³»ç»Ÿä¸Š |

**ç»“è®º**ï¼šä¸åŒå¤§å°çš„ç‰©å“ä½¿ç”¨äº†ä¸åŒçš„åæ ‡åŸºå‡†ï¼Œå¯¼è‡´æ— æ³•å¯¹é½ã€‚

---

## äºŒã€æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ 1 æ ¹å› ï¼šéšœç¢ç‰©æ£€æµ‹ä¸å®Œæ•´

**å½“å‰ä»£ç **ï¼ˆ`PlacementValidatorV3.HasObstacle()`ï¼‰ï¼š
```csharp
public bool HasObstacle(Vector3 cellCenter)
{
    Vector2 boxSize = new Vector2(0.9f, 0.9f);
    Collider2D[] hits = Physics2D.OverlapBoxAll(cellCenter, boxSize, 0f);
    
    foreach (var hit in hits)
    {
        if (HasAnyTag(hit.transform, obstacleTags))
            return true;
    }
    return false;
}
```

**é—®é¢˜**ï¼š
1. åªæ£€æµ‹æœ‰ç¢°æ’ä½“çš„ç‰©ä½“
2. æ ‘è‹—ï¼ˆStage 0ï¼‰æ²¡æœ‰ç¢°æ’ä½“ï¼Œæ— æ³•è¢«æ£€æµ‹
3. æˆ‘ä¹‹å‰çš„ä¿®å¤åªé’ˆå¯¹ `SaplingData` ç±»å‹ï¼Œä½†ç®±å­ç­‰å…¶ä»–ç‰©å“ä»ç„¶ä½¿ç”¨ `ValidateCells()`

**æˆ‘ä¹‹å‰çš„ä¿®å¤ä¸ºä»€ä¹ˆæ²¡ç”¨**ï¼š
- æˆ‘åªåœ¨ `UpdatePreview()` ä¸­å¯¹ `SaplingData` åšäº†ç‰¹æ®Šå¤„ç†
- ä½†å½“æ”¾ç½®ç®±å­æ—¶ï¼Œä»ç„¶ä½¿ç”¨ `ValidateCells()`ï¼Œæ— æ³•æ£€æµ‹æ— ç¢°æ’ä½“çš„æ ‘è‹—
- è€Œä¸” `ValidateSaplingPlacement()` åªæ£€æµ‹æ ‘æœ¨ï¼Œä¸æ£€æµ‹ç®±å­

### é—®é¢˜ 2 æ ¹å› ï¼šå¤šæ ¼å­ç‰©å“çš„é”šç‚¹è®¡ç®—é”™è¯¯

**å½“å‰ä»£ç **ï¼ˆ`PlacementGridCalculator.GetOccupiedCellCenters()`ï¼‰ï¼š
```csharp
public static List<Vector3> GetOccupiedCellCenters(Vector3 center, Vector2Int gridSize)
{
    // è®¡ç®—èµ·å§‹åç§»ï¼ˆä½¿æ ¼å­ä»¥ center ä¸ºä¸­å¿ƒï¼‰
    float startX = center.x - (gridSize.x - 1) * 0.5f;
    float startY = center.y - (gridSize.y - 1) * 0.5f;
    // ...
}
```

**é—®é¢˜**ï¼š
- å¯¹äº 1x1 ç‰©å“ï¼š`startX = center.x - 0 = center.x`ï¼Œæ ¼å­ä¸­å¿ƒå°±æ˜¯ center
- å¯¹äº 2x1 ç‰©å“ï¼š`startX = center.x - 0.5`ï¼Œä¸¤ä¸ªæ ¼å­ä¸­å¿ƒåˆ†åˆ«æ˜¯ `center.x - 0.5` å’Œ `center.x + 0.5`

è¿™æ„å‘³ç€ï¼š
- 1x1 ç‰©å“çš„æ ¼å­ä¸­å¿ƒåœ¨æ•´æ•° + 0.5 çš„ä½ç½®ï¼ˆå¦‚ 0.5, 1.5, 2.5ï¼‰
- 2x1 ç‰©å“çš„ä¸¤ä¸ªæ ¼å­ä¸­å¿ƒä¹Ÿåº”è¯¥åœ¨æ•´æ•° + 0.5 çš„ä½ç½®

**ä½†å®é™…é—®é¢˜å¯èƒ½åœ¨äº**ï¼š
- `GetCellCenter()` è®¡ç®—çš„æ˜¯é¼ æ ‡æ‰€åœ¨æ ¼å­çš„ä¸­å¿ƒ
- å¯¹äº 2x1 ç‰©å“ï¼Œè¿™ä¸ªä¸­å¿ƒè¢«ç”¨ä½œ"ä¸¤ä¸ªæ ¼å­çš„å‡ ä½•ä¸­å¿ƒ"
- ä½†è¿™ä¸ªå‡ ä½•ä¸­å¿ƒä¸åœ¨ä»»ä½•ä¸€ä¸ªæ ¼å­çš„ä¸­å¿ƒä¸Šï¼

**ä¸¾ä¾‹**ï¼š
- é¼ æ ‡åœ¨ (1.3, 2.7)
- `GetCellCenter()` è¿”å› (1.5, 2.5)
- å¯¹äº 1x1 ç‰©å“ï¼šæ ¼å­ä¸­å¿ƒ = (1.5, 2.5) âœ…
- å¯¹äº 2x1 ç‰©å“ï¼šä¸¤ä¸ªæ ¼å­ä¸­å¿ƒ = (1.0, 2.5) å’Œ (2.0, 2.5) âŒ ä¸åœ¨æ•´æ•° + 0.5 çš„ä½ç½®ï¼

**æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯**ï¼š
- å¯¹äº 2x1 ç‰©å“ï¼Œä¸¤ä¸ªæ ¼å­ä¸­å¿ƒåº”è¯¥æ˜¯ (0.5, 2.5) å’Œ (1.5, 2.5)
- æˆ–è€… (1.5, 2.5) å’Œ (2.5, 2.5)

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šç»Ÿä¸€éšœç¢ç‰©æ£€æµ‹ï¼ˆè§£å†³é—®é¢˜ 1ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šæ‰€æœ‰å¯æ”¾ç½®ç‰©å“éƒ½éœ€è¦æ£€æµ‹å·²æ”¾ç½®çš„ç‰©å“ï¼Œä¸ä»…ä»…æ˜¯æ ‘è‹—ã€‚

**ä¿®æ”¹ `PlacementValidatorV3.HasObstacle()`**ï¼š
```csharp
public bool HasObstacle(Vector3 cellCenter)
{
    // 1. åŸæœ‰çš„ç¢°æ’ä½“æ£€æµ‹
    Vector2 boxSize = new Vector2(0.9f, 0.9f);
    Collider2D[] hits = Physics2D.OverlapBoxAll(cellCenter, boxSize, 0f);
    foreach (var hit in hits)
    {
        if (HasAnyTag(hit.transform, obstacleTags))
            return true;
    }
    
    // 2. æ–°å¢ï¼šæ£€æµ‹æ— ç¢°æ’ä½“çš„å·²æ”¾ç½®ç‰©å“
    // 2.1 æ£€æµ‹æ ‘è‹—ï¼ˆStage 0ï¼Œæ— ç¢°æ’ä½“ï¼‰
    if (HasTreeAtPosition(cellCenter, 0.5f))
        return true;
    
    // 2.2 æ£€æµ‹å…¶ä»–å·²æ”¾ç½®ç‰©å“ï¼ˆå¦‚æœæœ‰æ³¨å†Œè¡¨çš„è¯ï¼‰
    // TODO: å¯ä»¥è€ƒè™‘å¼•å…¥ PlacedItemRegistry
    
    return false;
}
```

**æˆ–è€…æ›´å¥½çš„æ–¹æ¡ˆ**ï¼šå¼•å…¥ `PlacedItemRegistry`ï¼Œæ‰€æœ‰æ”¾ç½®çš„ç‰©å“éƒ½æ³¨å†Œåˆ°è¿™ä¸ªè¡¨ä¸­ï¼Œæ£€æµ‹æ—¶æŸ¥è¯¢è¿™ä¸ªè¡¨ã€‚

### æ–¹æ¡ˆ Bï¼šä¿®å¤å¤šæ ¼å­ç‰©å“çš„é”šç‚¹è®¡ç®—ï¼ˆè§£å†³é—®é¢˜ 2ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šç¡®ä¿æ‰€æœ‰ç‰©å“çš„æ ¼å­ä¸­å¿ƒéƒ½åœ¨æ•´æ•° + 0.5 çš„ä½ç½®ã€‚

**ä¿®æ”¹ `PlacementGridCalculator.GetOccupiedCellCenters()`**ï¼š

å¯¹äº 2x1 ç‰©å“ï¼Œä¸åº”è¯¥ä»¥é¼ æ ‡æ‰€åœ¨æ ¼å­ä¸º"å‡ ä½•ä¸­å¿ƒ"ï¼Œè€Œåº”è¯¥ä»¥é¼ æ ‡æ‰€åœ¨æ ¼å­ä¸º"å·¦ä¸‹è§’æ ¼å­"æˆ–"é”šç‚¹æ ¼å­"ã€‚

```csharp
public static List<Vector3> GetOccupiedCellCenters(Vector3 mousePosition, Vector2Int gridSize)
{
    var cells = new List<Vector3>();
    
    // è®¡ç®—é¼ æ ‡æ‰€åœ¨æ ¼å­çš„ç´¢å¼•
    int baseX = Mathf.FloorToInt(mousePosition.x);
    int baseY = Mathf.FloorToInt(mousePosition.y);
    
    // ä»å·¦ä¸‹è§’å¼€å§‹ï¼Œå‘å³ä¸Šæ‰©å±•
    for (int x = 0; x < gridSize.x; x++)
    {
        for (int y = 0; y < gridSize.y; y++)
        {
            Vector3 cellCenter = new Vector3(
                baseX + x + 0.5f,
                baseY + y + 0.5f,
                mousePosition.z
            );
            cells.Add(cellCenter);
        }
    }
    
    return cells;
}
```

**ä½†è¿™ä¼šæ”¹å˜é¢„è§ˆçš„è¡Œä¸º**ï¼šé¢„è§ˆå°†ä»¥é¼ æ ‡æ‰€åœ¨æ ¼å­ä¸ºå·¦ä¸‹è§’ï¼Œè€Œä¸æ˜¯ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒã€‚

**æ›´å¥½çš„æ–¹æ¡ˆ**ï¼šä¿æŒä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„è¡Œä¸ºï¼Œä½†ç¡®ä¿æ ¼å­ä¸­å¿ƒåœ¨æ­£ç¡®çš„ä½ç½®ã€‚

```csharp
public static List<Vector3> GetOccupiedCellCenters(Vector3 center, Vector2Int gridSize)
{
    var cells = new List<Vector3>();
    
    // è®¡ç®—ä¸­å¿ƒæ ¼å­çš„ç´¢å¼•
    int centerX = Mathf.FloorToInt(center.x);
    int centerY = Mathf.FloorToInt(center.y);
    
    // è®¡ç®—èµ·å§‹æ ¼å­ç´¢å¼•ï¼ˆä½¿æ ¼å­ä»¥ center æ‰€åœ¨æ ¼å­ä¸ºä¸­å¿ƒï¼‰
    int startX = centerX - (gridSize.x - 1) / 2;
    int startY = centerY - (gridSize.y - 1) / 2;
    
    for (int x = 0; x < gridSize.x; x++)
    {
        for (int y = 0; y < gridSize.y; y++)
        {
            Vector3 cellCenter = new Vector3(
                startX + x + 0.5f,
                startY + y + 0.5f,
                center.z
            );
            cells.Add(cellCenter);
        }
    }
    
    return cells;
}
```

---

## å››ã€ç”¨æˆ·æ ¸å¿ƒè®¾è®¡åŸåˆ™å›é¡¾

ç”¨æˆ·æå‡ºçš„æ ¸å¿ƒç­‰å¼ï¼š**é¢„è§ˆ GridCell å‡ ä½•ä¸­å¿ƒ = æ”¾ç½®åç‰©å“ Collider å‡ ä½•ä¸­å¿ƒ**

è¿™ä¸ªç­‰å¼çš„å«ä¹‰æ˜¯ï¼š
1. é¢„è§ˆæ—¶æ˜¾ç¤ºçš„æ ¼å­ï¼Œå°±æ˜¯ç‰©å“å®é™…å ç”¨çš„æ ¼å­
2. æ”¾ç½®åï¼Œç‰©å“çš„ Collider ä¸­å¿ƒåº”è¯¥åœ¨è¿™äº›æ ¼å­çš„å‡ ä½•ä¸­å¿ƒ

**å½“å‰å®ç°çš„é—®é¢˜**ï¼š
- é¢„è§ˆæ ¼å­çš„è®¡ç®—å¯èƒ½ä¸æ­£ç¡®ï¼ˆé—®é¢˜ 2ï¼‰
- æ”¾ç½®ä½ç½®çš„è®¡ç®—ä¾èµ– `GetColliderCenterAfterBottomAlign()`ï¼Œè¿™ä¸ªæ–¹æ³•å‡è®¾æ‰€æœ‰ç‰©å“éƒ½ä¼šæ‰§è¡Œåº•éƒ¨å¯¹é½

---

## äº”ã€å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä¿®å¤æ–¹æ¡ˆ |
|--------|------|---------|
| P0 | æ‰€æœ‰ç‰©å“éƒ½å¯ä»¥æ”¾åœ¨æ ‘æœ¨/ç®±å­ä¸Š | åœ¨ `HasObstacle()` ä¸­æ·»åŠ æ— ç¢°æ’ä½“ç‰©å“æ£€æµ‹ |
| P1 | å¤šæ ¼å­ç‰©å“æ ¼å­ä¸å¯¹é½ | ä¿®å¤ `GetOccupiedCellCenters()` çš„è®¡ç®—é€»è¾‘ |

---

## å…­ã€éœ€è¦ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜

1. **å¤šæ ¼å­ç‰©å“çš„é”šç‚¹è¡Œä¸º**ï¼š
   - æ–¹æ¡ˆ Aï¼šä»¥é¼ æ ‡æ‰€åœ¨æ ¼å­ä¸ºå·¦ä¸‹è§’ï¼ˆæ›´ç®€å•ï¼Œä½†é¢„è§ˆä¼šåç§»ï¼‰
   - æ–¹æ¡ˆ Bï¼šä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒï¼Œä½†ç¡®ä¿æ ¼å­åœ¨æ­£ç¡®ä½ç½®ï¼ˆæ›´å¤æ‚ï¼Œä½†ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼‰

2. **æ˜¯å¦éœ€è¦å¼•å…¥ PlacedItemRegistry**ï¼š
   - ä¼˜ç‚¹ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å·²æ”¾ç½®ç‰©å“ï¼Œæ£€æµ‹æ›´å¯é 
   - ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„æ³¨å†Œ/æ³¨é”€é€»è¾‘

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Kiro  
**æœ€åæ›´æ–°**: 2026-01-22
