# 用户方案记录 - 多格子物品坐标对齐

**创建日期**: 2026-01-21  
**状态**: 待分析  
**目的**: 详细记录用户提出的方案，作为后续实施的参考

---

## 一、用户原话摘录

### 1.1 核心方案描述

> "在我看来应该是有一个系统坐标，就是按照系统的单位长度来划分出一个个单元格，gridcell通过计算预放置物品Collider大小后得到自身的大小和格子数量和形状，然后再严格按照单元格排列和摆放，最后把预放置物品的预制体放入预放置方框，并且与其几何中心位置一致，我认为这个是很合理且正确的逻辑和思路"

### 1.2 对分析报告的质疑

> "首先对于分析报告我需要提问，对于你的修复方案是否考察了规范以及规范产出前的问题说明？左下角为锚点这个词我听起来不是很悦耳，我需要你详细描述"

### 1.3 关于底部对齐与 Collider 中心的思考

> "我感觉和.kiro\specs\物品放置系统\7_可放置物品开发规范，里面我审核过的内容不一致，好像存在冲突，也就是我们在树木石头和箱子系统里面所做的底部中心对齐，是不是可以全部改为Collider几何中心同步，这样就能做到全部都是一致的，但是这样是否会和我们的动态排序脚本一致呢，如果是用Collider中心处理放置位置，那么动态排序处理应该是需要处理偏移"

---

## 二、用户方案详细解析

### 2.1 核心思路（四步法）

```
步骤 1：系统坐标
    ↓
按照系统单位长度划分出一个个单元格（GridCell）
    ↓
步骤 2：GridCell 计算
    ↓
通过计算预放置物品 Collider 大小，得到 GridCell 的：
- 大小（宽 × 高）
- 格子数量
- 形状
    ↓
步骤 3：严格按单元格排列
    ↓
GridCell 严格按照单元格坐标系统排列和摆放
    ↓
步骤 4：预制体放入预览框
    ↓
预放置物品的预制体与预览框几何中心位置一致
```

### 2.2 图示说明

```
【系统坐标 - 单元格划分】

世界坐标系（单位长度 = 1）：
┌───┬───┬───┬───┐
│0,3│1,3│2,3│3,3│
├───┼───┼───┼───┤
│0,2│1,2│2,2│3,2│
├───┼───┼───┼───┤
│0,1│1,1│2,1│3,1│
├───┼───┼───┼───┤
│0,0│1,0│2,0│3,0│
└───┴───┴───┴───┘

每个单元格：
- 左下角 = (x, y)
- 中心 = (x+0.5, y+0.5)
- 右上角 = (x+1, y+1)
```

```
【GridCell 计算 - 根据 Collider 大小】

1x1 Collider 物品（树苗、小箱子）：
┌───┐
│ ● │  ← Collider 中心
└───┘
GridCell 大小 = 1x1
占用 1 个单元格

2x1 Collider 物品（大箱子）：
┌───┬───┐
│   ●   │  ← Collider 中心
└───┴───┘
GridCell 大小 = 2x1
占用 2 个单元格（水平方向）
```

```
【严格按单元格排列】

1x1 物品放在单元格 (1,1)：
┌───┬───┬───┬───┐
│   │   │   │   │
├───┼───┼───┼───┤
│   │   │   │   │
├───┼───┼───┼───┤
│   │ ■ │   │   │  ← GridCell 占用 (1,1)
├───┼───┼───┼───┤     GridCell 中心 = (1.5, 1.5)
│   │   │   │   │
└───┴───┴───┴───┘

2x1 物品放在单元格 (1,1)-(2,1)：
┌───┬───┬───┬───┐
│   │   │   │   │
├───┼───┼───┼───┤
│   │   │   │   │
├───┼───┼───┼───┤
│   │ ■ │ ■ │   │  ← GridCell 占用 (1,1) 和 (2,1)
├───┼───┼───┼───┤     GridCell 中心 = (2.0, 1.5)
│   │   │   │   │
└───┴───┴───┴───┘
```

```
【预制体与预览框几何中心一致】

预览框（GridCell）：
┌─────────┐
│         │
│    ●    │  ← GridCell 几何中心
│         │
└─────────┘

预制体放入后：
┌─────────┐
│  ┌───┐  │
│  │ ● │  │  ← 预制体 Collider 中心 = GridCell 几何中心
│  └───┘  │
└─────────┘

核心等式：
预制体 Collider 几何中心 = GridCell 几何中心 = 预览框几何中心
```

### 2.3 核心等式

```
预览 GridCell 几何中心 = 放置后物品 Collider 几何中心
```

这是用户方案的核心，所有计算都围绕这个等式展开。

---

## 三、用户提出的关键问题

### 3.1 底部对齐 vs Collider 中心对齐

用户指出当前存在两种对齐机制：

| 机制 | 当前使用场景 | 描述 |
|------|-------------|------|
| 底部中心对齐 | TreeControllerV2、ChestController | Sprite 底部中心对齐到物品原点 |
| Collider 中心对齐 | 用户提出的方案 | Collider 几何中心对齐到格子中心 |

**用户的疑问**：
> "我们在树木石头和箱子系统里面所做的底部中心对齐，是不是可以全部改为Collider几何中心同步，这样就能做到全部都是一致的"

### 3.2 与动态排序的兼容性

用户担心：
> "如果是用Collider中心处理放置位置，那么动态排序处理应该是需要处理偏移"

**需要分析的问题**：
1. 当前动态排序是基于什么位置计算的？
2. 如果改为 Collider 中心对齐，动态排序需要如何调整？

### 3.3 与已有规范的冲突

用户指出：
> "我感觉和.kiro\specs\物品放置系统\7_可放置物品开发规范，里面我审核过的内容不一致，好像存在冲突"

**需要分析的问题**：
1. `7_可放置物品开发规范` 中定义的底部对齐规范是什么？
2. 用户的 Collider 中心对齐方案与该规范是否冲突？
3. 如何统一？

---

## 四、待分析内容

### 4.1 需要读取的文档

- [ ] `.kiro/specs/物品放置系统/7_可放置物品开发规范/可放置物品开发规范.md`
- [ ] `.kiro/steering/placeable-items.md`
- [ ] 动态排序相关代码
- [ ] TreeControllerV2 的底部对齐实现
- [ ] ChestController 的底部对齐实现
- [ ] StoneController 的底部对齐实现（如果有）

### 4.2 需要回答的问题

1. **底部对齐的目的是什么？**
   - 为什么需要底部对齐？
   - 底部对齐解决了什么问题？

2. **Collider 中心对齐是否可行？**
   - 如果改为 Collider 中心对齐，会有什么影响？
   - 动态排序需要如何调整？

3. **两种方案是否可以共存？**
   - 底部对齐用于视觉显示
   - Collider 中心对齐用于放置位置计算

4. **如何统一规范？**
   - 如果采用用户方案，需要修改哪些文档？
   - 需要修改哪些代码？

---

## 五、用户方案的优势

1. **统一性**：所有物品使用同一套坐标系统
2. **简洁性**：不需要考虑"底部对齐"的复杂计算
3. **可预测性**：放置位置 = GridCell 中心 - Collider 本地中心
4. **对齐性**：不同大小的物品可以正确对齐到格子系统

---

## 六、潜在的挑战

1. **与现有底部对齐机制的冲突**
2. **动态排序可能需要调整**
3. **已放置物品的位置可能需要迁移**
4. **预制体可能需要调整**

---

**文档维护者**: Kiro  
**创建日期**: 2026-01-21

