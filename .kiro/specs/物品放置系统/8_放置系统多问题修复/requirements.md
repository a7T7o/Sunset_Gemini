# 放置系统多问题修复 - 需求文档

**版本**: 2.0  
**创建日期**: 2026-01-21  
**最后更新**: 2026-01-22  
**状态**: 🔴 需要重新设计

---

## 一、背景

用户在测试放置系统时发现多个问题。经过深入分析，发现之前的修复方案存在严重缺陷，需要重新设计。

### 1.1 之前修复为什么无效

| 问题 | 之前的修复 | 为什么无效 |
|------|-----------|-----------|
| P1 | 只对 SaplingData 调用 `ValidateSaplingPlacement()` | 箱子等其他物品仍使用 `ValidateCells()`，无法检测无碰撞体的树苗 |
| P1 | `ValidateSaplingPlacement()` 检测树木 | 只检测树木，不检测箱子等其他已放置物品 |
| P2 | 声称"验证通过" | 实际未分析 `GetOccupiedCellCenters()` 的计算逻辑问题 |

---

## 二、用户故事

### US-1：所有可放置物品的障碍物检测（重新定义）

**作为** 玩家  
**我希望** 在已有任何可放置物品的位置无法再放置新物品  
**以便** 避免物品重叠导致的游戏逻辑错误

**验收标准**：
- AC-1.1：在已有树苗（Stage 0，无碰撞体）的位置放置箱子，预览框显示红色
- AC-1.2：在已有箱子的位置放置树苗，预览框显示红色
- AC-1.3：在已有树木（Stage 1+，有碰撞体）的位置放置任何物品，预览框显示红色
- AC-1.4：点击红色预览框时，不执行放置操作
- AC-1.5：树苗间距检测使用 `SaplingData` 中配置的边距值

### US-2：多格子物品对齐（重新定义）

**作为** 玩家  
**我希望** 不同大小的物品（1x1、2x1 等）的预览格子都在整数+0.5的位置  
**以便** 放置的物品视觉上整齐一致

**验收标准**：
- AC-2.1：1x1 物品的预览格子中心在 (n+0.5, m+0.5) 位置（n, m 为整数）
- AC-2.2：2x1 物品的两个预览格子中心分别在 (n+0.5, m+0.5) 和 (n+1.5, m+0.5) 位置
- AC-2.3：放置后物品 Collider 中心与预览格子几何中心一致
- AC-2.4：不同大小的物品可以正确对齐到同一个格子系统

---

## 三、问题清单（修正版）

| 编号 | 问题 | 严重程度 | 根本原因 |
|------|------|---------|---------|
| P1 | 所有物品都可以放在无碰撞体物品上 | 🔴 严重 | `HasObstacle()` 只检测有碰撞体的物体 |
| P2 | 多格子物品格子不对齐 | 🔴 严重 | `GetOccupiedCellCenters()` 计算逻辑错误 |

### P1 详细分析

**当前代码**（`PlacementValidatorV3.HasObstacle()`）：
```csharp
Collider2D[] hits = Physics2D.OverlapBoxAll(cellCenter, boxSize, 0f);
```

**问题**：
1. 只检测有碰撞体的物体
2. 树苗（Stage 0）没有碰撞体，无法被检测
3. 之前的修复只对 SaplingData 做了特殊处理，但箱子等其他物品仍然无法检测树苗

### P2 详细分析

**当前代码**（`PlacementGridCalculator.GetOccupiedCellCenters()`）：
```csharp
float startX = center.x - (gridSize.x - 1) * 0.5f;
// ...
Vector3 cellCenter = new Vector3(startX + x, startY + y, center.z);
```

**问题**：
- 假设 `center = (1.5, 2.5)`（一个格子的中心）
- 对于 1x1 物品：格子中心 = (1.5, 2.5) ✅
- 对于 2x1 物品：格子中心 = (1.0, 2.5) 和 (2.0, 2.5) ❌

**正确的格子中心应该是**：(0.5, 2.5) 和 (1.5, 2.5)，或者 (1.5, 2.5) 和 (2.5, 2.5)

---

## 四、核心设计原则

### 4.1 用户提出的核心等式

```
预览 GridCell 几何中心 = 放置后物品 Collider 几何中心
```

### 4.2 格子坐标系统

所有格子中心必须在 **整数+0.5** 的位置：
- (0.5, 0.5), (1.5, 0.5), (2.5, 0.5), ...
- (0.5, 1.5), (1.5, 1.5), (2.5, 1.5), ...

### 4.3 两层设计

| 层级 | 目的 | 实现方式 |
|------|------|---------|
| **放置层** | Collider 中心对齐到格子中心 | `InstantiatePlacementPrefab` 计算偏移 |
| **视觉层** | Sprite 底部对齐到根物体位置 | `AlignSpriteBottom` 在 Start 时执行 |

---

## 五、修复范围

### 5.1 必须修复

| 问题 | 修复位置 | 修复内容 |
|------|---------|---------|
| P1 | `PlacementValidatorV3.HasObstacle()` | 添加无碰撞体物品检测（树苗、箱子等） |
| P2 | `PlacementGridCalculator.GetOccupiedCellCenters()` | 修复格子中心计算逻辑 |

### 5.2 可选优化

- 引入 `PlacedItemRegistry` 统一管理所有已放置物品

---

## 六、相关文件

| 文件 | 说明 |
|------|------|
| `PlacementValidatorV3.cs` | 验证器，需要修改 `HasObstacle()` |
| `PlacementGridCalculator.cs` | 格子计算器，需要修改 `GetOccupiedCellCenters()` |
| `PlacementManagerV3.cs` | 放置管理器（之前的修改可能需要调整） |
| `PlacementPreviewV3.cs` | 预览组件 |

---

## 七、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0 | 2026-01-21 | 初始版本 |
| 2.0 | 2026-01-22 | 重新分析问题，修正需求定义 |

---

**文档维护者**: Kiro  
**最后更新**: 2026-01-22
