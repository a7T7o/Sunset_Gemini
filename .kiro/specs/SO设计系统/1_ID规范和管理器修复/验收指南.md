# SO ID 规范和管理器修复 - 验收指南

## 概述

本文档用于验收 SO ID 规范完善和管理器修复的实施结果。

---

## 功能验收清单

### 1. DontDestroyOnLoad 修复

- [x] **代码修改完成**
  - [x] PersistentManagers.cs 已创建
  - [x] TimeManager.cs 已移除 DontDestroyOnLoad 调用
  - [x] SeasonManager.cs 已移除 DontDestroyOnLoad 调用
  - [x] WeatherSystem.cs 已移除 DontDestroyOnLoad 调用

- [x] **场景配置完成**
  - [x] 场景中存在 PersistentManagers 根物体
  - [x] PersistentManagers 组件已添加
  - [x] TimeManager 是 PersistentManagers 的子物体
  - [x] SeasonManager 是 PersistentManagers 的子物体
  - [x] WeatherSystem 是 PersistentManagers 的子物体

- [x] **运行时验证**
  - [x] 控制台无 "DontDestroyOnLoad only works for root GameObjects" 警告
  - [x] 控制台无其他错误和警告

---

### 2. 钥匙 ID 修复

- [x] **工具创建完成**
  - [x] Tool_FixKeyIDs.cs 已创建
  - [x] 菜单项 "Tools/Fix Key IDs" 可用

- [x] **ID 修复完成**
  - [x] 执行 "Tools/Fix Key IDs" 菜单项
  - [x] 控制台显示修复日志
  - [x] 所有钥匙 ID 已更新到 1420-1425 范围
  - [x] 修复了 2 个钥匙（1410 → 1420, 1411 → 1421）

- [x] **运行时验证**
  - [x] 控制台无 "钥匙ID建议在1420-1499范围内" 警告
  - [x] ItemDatabase 已同步更新

---

### 3. 文档更新

- [x] **SO 参数设计文档**
  - [x] 版本号已更新到 v1.2
  - [x] ID 分配规范包含 12XX（树苗）
  - [x] ID 分配规范包含 13XX（建筑材料）
  - [x] ID 分配规范包含 14XX（钥匙和锁，1420-1499）

- [x] **so-design.md steering 规则**
  - [x] ID 分配规范已更新
  - [x] 包含完整的 1XXX 范围定义

- [x] **工作区 memory.md**
  - [x] 会话 8 记录已添加
  - [x] 记录了所有修改的文件
  - [x] 记录了解决方案和遗留问题

---

## 测试步骤

### 测试 1：DontDestroyOnLoad 修复

1. 打开 Unity 编辑器
2. 打开 Primary 场景
3. 在场景层级中创建或找到 PersistentManagers 根物体：
   - 右键点击 Hierarchy → Create Empty
   - 命名为 "PersistentManagers"
   - 确保它是根物体（没有父物体）
4. 添加 PersistentManagers 组件：
   - 选中 PersistentManagers 物体
   - 在 Inspector 中点击 Add Component
   - 搜索并添加 "PersistentManagers"
5. 调整场景层级结构：
   - 将 TimeManager 拖到 PersistentManagers 下作为子物体
   - 将 SeasonManager 拖到 PersistentManagers 下作为子物体
   - 将 WeatherSystem 拖到 PersistentManagers 下作为子物体
6. 保存场景（Ctrl+S）
7. 启动游戏（Play Mode）
8. 检查控制台：
   - ✅ 应显示：`[PersistentManagers] 初始化完成，管理器将在场景切换时保持`
   - ❌ 不应显示：`DontDestroyOnLoad only works for root GameObjects`
9. 如果有多个场景，切换场景并验证管理器仍然存在

**预期结果**：
- 控制台无 DontDestroyOnLoad 警告
- 管理器在场景切换后仍然存在
- 时间、季节、天气状态保持不变

**预期场景层级**：
```
PersistentManagers (根物体)
├── TimeManager
├── SeasonManager
└── WeatherSystem
```

---

### 测试 2：钥匙 ID 修复

1. 打开 Unity 编辑器
2. 执行菜单：`Tools > Fix Key IDs`
3. 检查控制台输出：
   ```
   [FixKeyIDs] 开始扫描钥匙...
   [FixKeyIDs] 找到 X 个 KeyLockData 资产
   [FixKeyIDs] 找到 Y 个需要修复的钥匙
   [FixKeyIDs] Key_0_0: 100 → 1420
   [FixKeyIDs] Key_1_0: 101 → 1421
   ...
   [FixKeyIDs] 完成！修复了 Y 个钥匙
   [FixKeyIDs] 已同步到 ItemDatabase
   ```
4. 打开任意钥匙 SO 资产，检查 itemID 字段
5. 启动游戏（Play Mode）
6. 检查控制台：
   - ❌ 不应显示：`钥匙ID建议在1420-1499范围内`

**预期结果**：
- 所有钥匙 ID 在 1420-1425 范围内
- 控制台无钥匙 ID 警告
- ItemDatabase 已同步

---

### 测试 3：文档验证

1. 打开 `Docx/设计/SO/SO参数设计.md`
2. 检查版本号：应为 v1.2
3. 检查 ID 分配规范：
   ```
   1XXX: 种植类
       10XX: 种子
       11XX: 作物
       12XX: 树苗（Sapling）
       13XX: 建筑材料
       14XX: 钥匙和锁
           1420-1499: 钥匙/锁（KeyLockData）
   ```
4. 打开 `.kiro/steering/so-design.md`
5. 检查 ID 分配规范已更新
6. 打开 `.kiro/specs/SO设计系统/memory.md`
7. 检查会话 8 记录已添加

**预期结果**：
- 所有文档已更新
- ID 范围定义完整
- 工作区记录完整

---

## 已知限制

1. **场景配置需要手动完成**：
   - PersistentManagers 层级需要手动在场景中设置
   - 无法通过脚本自动完成（Unity 限制）

2. **钥匙 ID 修复需要手动执行**：
   - 需要手动执行 `Tools > Fix Key IDs` 菜单项
   - 工具无法自动运行

3. **SO 字段优化暂时搁置**：
   - equipmentType 和 consumableType 字段优化需要大量重构
   - 等待用户确认是否需要执行

---

## 注意事项

1. **备份项目**：
   - 在执行修复前，确保使用版本控制备份项目
   - 可以随时回滚到修复前的状态

2. **场景保存**：
   - 调整场景层级后，记得保存场景
   - 确保 PersistentManagers 配置正确

3. **测试顺序**：
   - 先测试 DontDestroyOnLoad 修复
   - 再测试钥匙 ID 修复
   - 最后验证文档更新

4. **控制台检查**：
   - 每次测试后检查控制台
   - 确保无警告和错误

---

## 问题排查

### 问题 1：控制台仍然显示 DontDestroyOnLoad 警告

**可能原因**：
- PersistentManagers 不是根物体
- 管理器不是 PersistentManagers 的子物体
- PersistentManagers 组件未添加

**解决方案**：
1. 检查场景层级结构
2. 确保 PersistentManagers 是根物体（没有父物体）
3. 确保三个管理器是 PersistentManagers 的子物体
4. 确保 PersistentManagers 组件已添加

---

### 问题 2：控制台仍然显示钥匙 ID 警告

**可能原因**：
- Fix Key IDs 工具未执行
- 工具执行失败
- ItemDatabase 未同步

**解决方案**：
1. 手动执行 `Tools > Fix Key IDs` 菜单项
2. 检查控制台输出，确认修复成功
3. 手动打开钥匙 SO，检查 ID 是否正确
4. 右键点击 MasterItemDatabase.asset，选择"自动收集所有物品数据"

---

### 问题 3：菜单项 "Tools/Fix Key IDs" 不存在

**可能原因**：
- 脚本编译失败
- 菜单项未注册

**解决方案**：
1. 检查控制台是否有编译错误
2. 重新编译脚本：`Assets > Reimport All`
3. 重启 Unity 编辑器

---

*验收指南结束*
