# 交互矩阵文档

**创建日期**: 2026-01-29
**最后更新**: 2026-01-29
**状态**: 持续维护

---

## 一、全局 UI 状态切换矩阵

### 1.1 面板状态定义

| 状态 | 说明 | 触发条件 |
|------|------|---------|
| `Closed` | 所有面板关闭 | ESC / 点击面板外 |
| `InventoryOpen` | 背包面板打开 | Tab / B |
| `BoxOpen` | 箱子 UI 打开 | E（靠近箱子） |
| `OtherPanelOpen` | 其他面板打开 | M/L/O 等快捷键 |

### 1.2 状态切换矩阵

| 当前状态 | 输入 | 目标状态 | 附加行为 |
|---------|------|---------|---------|
| `Closed` | Tab/B | `InventoryOpen` | 打开背包 |
| `Closed` | E（靠近箱子） | `BoxOpen` | 打开箱子 UI |
| `Closed` | M/L/O | `OtherPanelOpen` | 打开对应面板 |
| `InventoryOpen` | Tab | `Closed` | 关闭背包 |
| `InventoryOpen` | E（靠近箱子） | `BoxOpen` | 关闭背包，打开箱子 |
| `InventoryOpen` | ESC | `Closed` | 关闭背包 |
| `BoxOpen` | Tab | `InventoryOpen` | 关闭箱子，打开背包，**强制刷新背包数据** |
| `BoxOpen` | E | `Closed` | 关闭箱子 |
| `BoxOpen` | ESC | `Closed` | 关闭箱子 |
| `BoxOpen` | 右键世界 | `Closed` | 关闭箱子，触发自动导航 |
| `OtherPanelOpen` | Tab | `InventoryOpen` | 切换到背包 |
| `OtherPanelOpen` | ESC | `Closed` | 关闭面板 |

### 1.3 物品安全规则

**核心原则**：关闭任何 UI 时，手上物品必须安全归位，**绝对禁止销毁物品**。

| 场景 | 归位优先级 |
|------|-----------|
| 关闭背包（手上有物品） | 原槽位 → 背包空位 → 扔在脚下 |
| 关闭箱子（手上有物品） | 原槽位 → 背包空位 → 扔在脚下 |
| 切换面板（手上有物品） | 同上 |

---

## 二、槽位交互矩阵

### 2.1 状态定义

| 状态 | 说明 | 进入条件 |
|------|------|---------|
| `Idle` | 空闲状态 | 默认 / 放置完成 |
| `HeldByShift` | Shift 拿起状态 | Shift+左键点击有物品的槽位 |
| `HeldByCtrl` | Ctrl 拿起状态 | Ctrl+左键点击有物品的槽位 |
| `Dragging` | 拖拽状态 | 长按+移动 |

### 2.2 Idle 状态下的操作

| 输入 | 槽位状态 | 行为 | 目标状态 |
|------|---------|------|---------|
| 左键单击 | 有物品 | 选中槽位 | `Idle` |
| 左键单击 | 空 | 选中槽位 | `Idle` |
| Shift+左键 | 有物品 | 二分拿取（向上取整给手上） | `HeldByShift` |
| Shift+左键 | 空 | 无操作 | `Idle` |
| Ctrl+左键 | 有物品 | 单个拿取 | `HeldByCtrl` |
| Ctrl+左键 | 空 | 无操作 | `Idle` |
| 长按+移动 | 有物品 | 开始拖拽 | `Dragging` |
| 长按+移动 | 空 | 无操作 | `Idle` |

### 2.3 HeldByShift/HeldByCtrl 状态下的操作

| 输入 | 目标槽位 | 源槽位状态 | 行为 | 目标状态 |
|------|---------|-----------|------|---------|
| 左键单击 | 空槽位 | - | 放置 | `Idle` |
| 左键单击 | 相同物品 | - | 堆叠（可能溢出） | `Idle` 或保持 |
| 左键单击 | 不同物品 | **空** | 交换 | `Idle` |
| 左键单击 | 不同物品 | **非空** | **返回原位** | `Idle` |
| 左键单击 | 源槽位 | - | 合并回源槽位 | `Idle` |
| Shift+左键 | 源槽位 | - | 连续二分（仅 HeldByShift） | 保持 |
| 移动鼠标 | - | - | **不触发拖拽** | 保持 |
| ESC | - | - | 返回原位 | `Idle` |
| 点击面板外 | - | - | 丢弃 | `Idle` |
| 点击垃圾桶 | - | - | 丢弃 | `Idle` |

### 2.4 Dragging 状态下的操作

| 输入 | 目标槽位 | 源槽位状态 | 行为 | 目标状态 |
|------|---------|-----------|------|---------|
| 释放 | 空槽位 | - | 放置 | `Idle` |
| 释放 | 相同物品 | - | 堆叠 | `Idle` |
| 释放 | 不同物品 | - | **交换**（拖拽允许交换） | `Idle` |
| 释放 | 源槽位 | - | 返回原位 | `Idle` |
| 释放 | 面板外 | - | 丢弃 | `Idle` |
| 释放 | 垃圾桶 | - | 丢弃 | `Idle` |

### 2.5 长按 Ctrl 连续拿取

| 条件 | 行为 |
|------|------|
| 按住 Ctrl+左键 | 每 0.28 秒从源槽位拿取 1 个 |
| 源槽位空了 | 停止拿取 |
| 松开 Ctrl 或左键 | 停止拿取，保持 HeldByCtrl 状态 |

---

## 三、跨容器交互矩阵

### 3.1 容器类型

| 容器 | 说明 | 管理器 |
|------|------|--------|
| 背包（Down） | InventoryService | InventoryInteractionManager |
| 箱子（Up） | ChestInventory | SlotDragContext |
| 装备 | EquipmentService | InventoryInteractionManager |

### 3.2 跨容器拖拽矩阵

| 源 → 目标 | 目标空 | 目标相同物品 | 目标不同物品 |
|-----------|--------|-------------|-------------|
| 箱子 → 箱子 | 放置 | 堆叠 | 交换（拖拽）/ 返回（Held） |
| 箱子 → 背包 | 放置 | 堆叠 | 交换（拖拽）/ 返回（Held） |
| 背包 → 箱子 | 放置 | 堆叠 | 交换（拖拽）/ 返回（Held） |
| 背包 → 背包 | 放置 | 堆叠 | 交换（拖拽）/ 返回（Held） |

### 3.3 关键规则

1. **拖拽模式**（长按+移动）：允许与不同物品交换
2. **Held 模式**（Shift/Ctrl 拿起）：
   - 源槽位为空 → 允许交换
   - 源槽位非空 → **返回原位**（不允许交换）

---

## 四、背包 vs 箱子功能对照表

| 功能 | 背包 | 箱子 | 状态 |
|------|------|------|------|
| Shift+左键二分拿取 | ✅ | ✅ | 已实现 |
| Ctrl+左键单个拿取 | ✅ | ✅ | 已实现 |
| 长按 Ctrl 连续拿取 | ✅ | ✅ | 已实现 |
| Held 状态下 Shift 连续二分 | ✅ | ✅ | 已实现 |
| Held 状态下移动鼠标不触发拖拽 | ✅ | ✅ | 已实现 |
| 放置到空槽位 | ✅ | ✅ | 正常 |
| 放置到相同物品（堆叠） | ✅ | ✅ | 正常 |
| 放置到不同物品（源槽位空） | ✅ 交换 | ✅ 交换 | 正常 |
| 放置到不同物品（源槽位非空） | ✅ 返回原位 | ✅ 返回原位 | 已修复 |
| 放回原位（合并） | ✅ | ✅ | 已修复 |
| ESC 取消 | ✅ | ⏳ 待验证 | - |
| 关闭 UI 物品归位 | ✅ | ✅ | 已实现 |

---

## 五、问题追踪

### 5.1 已修复问题

| 问题 | 修复日期 | 说明 |
|------|---------|------|
| P0-3 放回原位覆盖 | 2026-01-29 | HandleSameContainerDrop 合并逻辑 |
| Held 状态移动鼠标进入拖拽 | 2026-01-29 | OnBeginDrag 入口检查 |

### 5.2 待修复问题

| 问题 | 优先级 | 说明 |
|------|--------|------|
| ~~P0-4 源槽位非空时错误交换~~ | ~~P0~~ | ✅ 已修复 (2026-01-29) |

---

## 六、更新日志

| 日期 | 更新内容 |
|------|---------|
| 2026-01-29 | 创建文档，定义全局状态切换矩阵、槽位交互矩阵、跨容器交互矩阵 |
| 2026-01-29 | 修复 P0-4：在 HandleSameContainerDrop、HandleChestToInventoryDrop、HandleInventoryToChestDrop 中添加源槽位检查 |
