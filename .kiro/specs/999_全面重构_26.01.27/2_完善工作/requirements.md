# 2_完善工作 - 需求文档

## 概述

本阶段是 Phase 2 数据核心重构的完善工作，修复 1_入门工作 中遗留的严重 Bug 和用户反馈的问题。

## 用户故事

### US-1: 箱子存档功能

**作为** 玩家
**我希望** 箱子中的物品能够正确保存和加载
**以便** 我的游戏进度不会丢失

**验收标准**:
- AC-1.1: 箱子放入物品后保存游戏，重新加载后物品仍在箱子中
- AC-1.2: 箱子中物品的数量、品质、耐久度等属性正确恢复
- AC-1.3: 多个箱子的内容互不干扰，各自独立保存

### US-2: 箱子 UI 交互

**作为** 玩家
**我希望** 箱子 UI 的所有区域都能正常交互
**以便** 我能顺畅地管理物品

**验收标准**:
- AC-2.1: BoxUI 的 Up 区域（箱子槽位）可以正常点击、拖拽
- AC-2.2: Ctrl + 左键可以正确拆分物品（拿起一半）
- AC-2.3: Shift + 左键可以正确拆分物品（拿起一个）
- AC-2.4: 拆分后放回同一格子，物品数量正确合并
- AC-2.5: 长按 Ctrl + 左键可以在箱子内连续拿起物品

### US-3: 背包 UI 刷新

**作为** 玩家
**我希望** 背包 UI 能实时反映最新数据
**以便** 我能准确了解当前物品状态

**验收标准**:
- AC-3.1: 从箱子操作物品后，按 Tab 打开背包，显示最新数据
- AC-3.2: 在 BoxUI 的背包区域进行 Sort 后，按 Tab 打开背包显示排序后的数据
- AC-3.3: 任何物品变动后，相关 UI 自动刷新

### US-4: 游戏时间恢复

**作为** 玩家
**我希望** 加载存档后游戏时间恢复到保存时的状态
**以便** 我的游戏进度连贯

**验收标准**:
- AC-4.1: 保存游戏时记录当前游戏时间（天、季节、年、小时、分钟）
- AC-4.2: 加载存档后游戏时间恢复到保存时的状态
- AC-4.3: 时间 UI 显示正确的恢复后时间

### US-5: 耐久度条样式优化

**作为** 玩家
**我希望** 耐久度条显示更美观
**以便** 我能清晰地看到工具状态

**验收标准**:
- AC-5.1: 耐久度条距离槽位底部 6px
- AC-5.2: 耐久度条贴着 4px 边框，左右各留出适当空隙
- AC-5.3: 耐久度条有 1px 黑色描边
- AC-5.4: 耐久度条长度适中，不要太满

### US-6: 物品安全（手持物品关闭 UI）

**作为** 玩家
**我希望** 关闭 UI 时手上的物品不会丢失
**以便** 我的物品始终安全

**验收标准**:
- AC-6.1: 手持物品时按 ESC 关闭 UI，物品退回原槽位
- AC-6.2: 原槽位已满时，物品放入背包空位
- AC-6.3: 背包也满时，物品掉落在玩家脚下（生成 WorldItemDrop）
- AC-6.4: **绝对禁止销毁物品**
- AC-6.5: 拆分中断时，取消拆分，原槽位恢复原数量

### US-7: UI 状态切换

**作为** 玩家
**我希望** UI 之间的切换流畅且数据正确
**以便** 我能顺畅地管理物品

**验收标准**:
- AC-7.1: 打开箱子时按 TAB，关闭箱子 UI 并打开背包 UI
- AC-7.2: 背包 UI 打开时显示最新数据（因为箱子操作可能改变了背包）
- AC-7.3: UI 切换时，如果鼠标上有物品，先执行物品归位逻辑
- AC-7.4: 打开背包时按 E（面前有箱子），关闭背包并打开箱子 UI

---

## 问题优先级

### P0 - 阻断性 Bug（必须修复）

| 编号 | 问题 | 影响 |
|------|------|------|
| P0-1 | 箱子内容未保存 | 玩家物品丢失，游戏进度无法保存 |
| P0-2 | BoxUI Up 区域无法交互 | 箱子功能完全失效 |
| P0-3 | Ctrl/Shift + 左键吞物品 | 玩家物品丢失 |

### P1 - 重要问题（影响体验）

| 编号 | 问题 | 影响 |
|------|------|------|
| P1-1 | 背包 UI 不刷新 | 显示过时数据，用户困惑 |
| P1-2 | 游戏时间未恢复 | 存档功能不完整 |

### P1+ - 安全性问题（影响数据完整性）

| 编号 | 问题 | 影响 |
|------|------|------|
| P1+-1 | 手持物品关闭 UI 时物品丢失 | 玩家物品丢失 |
| P1+-2 | UI 切换时数据不同步 | 显示错误数据 |

### P2 - 优化改进

| 编号 | 问题 | 影响 |
|------|------|------|
| P2-1 | 耐久度条样式 | 视觉体验 |

---

## 不在本次范围

- 树木/石头状态保存恢复（Phase 2 后续工作）
- 玩家 Tool 子物体处理（不需要，和玩家 0 偏移）
- 耐久度集成到工具系统（需要单独评估）

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `锐评001.md` | 锐评专家诊断报告 |
| `锐评002.md` | 锐评专家修复指令 |
| `锐评003.md` | 锐评专家交互矩阵与物品安全规范 |
| `memory.md` | 工作区记忆文档 |
