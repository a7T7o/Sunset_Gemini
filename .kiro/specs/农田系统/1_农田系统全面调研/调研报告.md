# 农田系统全面调研报告

**调研日期**: 2026-01-22  
**调研目的**: 为农田系统完整开发提供详细索引和参考

---

## 目录

1. [项目现状总览](#1-项目现状总览)
2. [文档资源索引](#2-文档资源索引)
3. [代码文件索引](#3-代码文件索引)
4. [数据结构分析](#4-数据结构分析)
5. [已完成功能评估](#5-已完成功能评估)
6. [待完成功能清单](#6-待完成功能清单)
7. [关键设计决策](#7-关键设计决策)
8. [开发建议](#8-开发建议)

---

## 1. 项目现状总览

### 1.1 完成度评估

| 模块 | 完成度 | 状态 | 说明 |
|------|--------|------|------|
| 数据结构 | 90% | ✅ 基本完成 | FarmTileData、CropInstance、SoilMoistureState 已定义 |
| FarmingManager | 80% | ⚠️ 需完善 | 核心逻辑已实现，但缺少背包/精力集成 |
| CropGrowthSystem | 85% | ⚠️ 需完善 | 生长逻辑完整，缺少成熟特效 |
| Tilemap 配置 | 30% | 🚧 进行中 | 需要用户配置 Rule Tile 和场景结构 |
| 工具集成 | 10% | ❌ 未开始 | 锄头、水壶工具交互未实现 |
| UI 集成 | 0% | ❌ 未开始 | 无农田相关 UI |
| 背包集成 | 0% | ❌ 未开始 | 种子消耗、作物收获未连接 |
| 精力系统 | 0% | ❌ 未开始 | 精力消耗逻辑已预留但未启用 |

### 1.2 整体评价

**优点**:
- 数据结构设计合理，支持多种土壤状态
- 时间系统集成正确（使用静态事件）
- 支持可重复收获作物
- 有完整的编辑器调试工具

**问题**:
- 缺少与现有系统的集成（背包、精力、工具）
- Tilemap 配置需要用户手动完成
- 缺少 Rule Tile 自动边界拼接
- 多楼层支持设计已有但未实现

---

## 2. 文档资源索引

### 2.1 Specs 文档

| 文件路径 | 内容概述 | 评价 |
|---------|---------|------|
| `.kiro/specs/农田系统/memory.md` | 工作区主记忆文档 | ⭐⭐⭐⭐ 信息完整，包含架构决策 |
| `.kiro/specs/农田系统/0_耕地系统重构/requirements.md` | 6 个需求定义 | ⭐⭐⭐⭐⭐ 需求清晰，验收标准明确 |
| `.kiro/specs/农田系统/0_耕地系统重构/design.md` | 架构设计、Rule Tile 配置 | ⭐⭐⭐⭐⭐ 设计详细，包含正确性属性 |
| `.kiro/specs/农田系统/0_耕地系统重构/tasks.md` | 分阶段实现计划 | ⭐⭐⭐⭐ 任务划分合理 |
| `.kiro/specs/农田系统/0_耕地系统重构/RuleTile配置指南.md` | Rule Tile 详细配置步骤 | ⭐⭐⭐⭐⭐ 非常详细，适合用户操作 |

### 2.2 Docx 设计文档

| 文件路径 | 内容概述 | 评价 |
|---------|---------|------|
| `Docx/Plan/农田系统-快速开始.md` | 快速开始指南 | ⭐⭐⭐⭐ 步骤清晰，适合快速上手 |
| `Docx/Plan/农田系统-超详细实施清单.md` | 超详细实施清单 | ⭐⭐⭐⭐⭐ 包含 Tilemap 原理详解 |
| `Docx/Plan/种田系统完整设计方案.md` | 完整设计方案 | ⭐⭐⭐⭐⭐ 最全面的设计文档 |
| `Docx/Plan/种田系统实施指南.md` | 实施指南 | ⭐⭐⭐⭐ 步骤详细，包含测试方法 |
| `Docx/分类/农田/000_农田系统完整文档.md` | 系统完整文档 | ⭐⭐⭐⭐ 合并了多个文档的内容 |
| `Docx/分类/农田/农田系统编译错误修复记录.md` | 编译错误修复记录 | ⭐⭐⭐ 历史问题记录，有参考价值 |
| `Docx/设计/SO/SO参数设计.md` | SO 参数设计规范 | ⭐⭐⭐⭐⭐ 包含 SeedData、CropData 定义 |

### 2.3 Steering 规则

| 文件路径 | 内容概述 | 评价 |
|---------|---------|------|
| `.kiro/steering/archive/farming.md` | 农田系统规范 | ⭐⭐⭐⭐ 核心规范，已归档 |
| `.kiro/steering/layers.md` | 层级设计规范 | ⭐⭐⭐⭐⭐ 包含农田 Tilemap 层级结构 |

---

## 3. 代码文件索引

### 3.1 核心脚本

| 文件路径 | 职责 | 代码行数 | 评价 |
|---------|------|---------|------|
| `Assets/YYY_Scripts/Farm/FarmingManager.cs` | 农田管理器核心 | ~450 行 | ⭐⭐⭐⭐ 功能完整，需集成 |
| `Assets/YYY_Scripts/Farm/FarmTileData.cs` | 耕地格子数据 | ~70 行 | ⭐⭐⭐⭐⭐ 简洁清晰 |
| `Assets/YYY_Scripts/Farm/CropInstance.cs` | 作物实例数据 | ~120 行 | ⭐⭐⭐⭐⭐ 功能完整 |
| `Assets/YYY_Scripts/Farm/CropGrowthSystem.cs` | 作物生长系统 | ~180 行 | ⭐⭐⭐⭐ 逻辑清晰 |
| `Assets/YYY_Scripts/Farm/CropController.cs` | 作物控制器 | ~90 行 | ⭐⭐⭐⭐ 包含成熟闪烁效果 |
| `Assets/YYY_Scripts/Farm/SoilMoistureState.cs` | 土壤湿度枚举 | ~10 行 | ⭐⭐⭐⭐⭐ 简洁 |

### 3.2 编辑器工具

| 文件路径 | 职责 | 评价 |
|---------|------|------|
| `Assets/Editor/FarmingSystemEditor.cs` | 农田系统调试工具 | ⭐⭐⭐⭐ 功能完整 |
| `Assets/Editor/FarmlandTileCreator.cs` | 农田 Tile 创建工具 | ⭐⭐⭐⭐ 支持纯色测试 Tile |

### 3.3 数据类（SO）

| 文件路径 | 职责 | 评价 |
|---------|------|------|
| `Assets/YYY_Scripts/Data/Items/SeedData.cs` | 种子数据定义 | 需确认是否存在 |
| `Assets/YYY_Scripts/Data/Items/CropData.cs` | 作物数据定义 | 需确认是否存在 |

---

## 4. 数据结构分析

### 4.1 FarmTileData（耕地格子数据）

```csharp
public class FarmTileData
{
    public Vector3Int position;           // 格子坐标
    public bool isTilled;                 // 是否已耕作
    public bool wateredToday;             // 今天是否浇水（记录参数）
    public bool wateredYesterday;         // 昨天是否浇水（影响生长）
    public float waterTime;               // 浇水时间（小时，用于视觉切换）
    public SoilMoistureState moistureState; // 当前湿度视觉状态
    public CropInstance crop;             // 作物实例
}
```

**评价**: ⭐⭐⭐⭐⭐ 设计合理，支持"当天浇水→第二天生效"的逻辑

### 4.2 SoilMoistureState（土壤湿度状态）

```csharp
public enum SoilMoistureState
{
    Dry = 0,            // 干燥（未浇水）
    WetWithPuddle = 1,  // 湿润+水渍（浇水后2小时内）
    WetDark = 2         // 湿润+深色（浇水2小时后）
}
```

**评价**: ⭐⭐⭐⭐⭐ 三种视觉状态，符合用户需求

### 4.3 CropInstance（作物实例）

```csharp
public class CropInstance
{
    public SeedData seedData;             // 种子数据引用
    public GameObject cropObject;         // 场景中的作物 GameObject
    public int currentStage;              // 当前生长阶段
    public int plantedDay;                // 种植时的游戏天数
    public int grownDays;                 // 实际生长天数
    public int daysWithoutWater;          // 连续未浇水天数
    public bool isWithered;               // 是否枯萎
    public int harvestCount;              // 已收获次数
    public ItemQuality quality;           // 作物品质
    public int lastHarvestDay;            // 上次收获天数
}
```

**评价**: ⭐⭐⭐⭐⭐ 支持可重复收获、枯萎、品质系统

### 4.4 SeedData（种子数据 - SO）

根据 `SO参数设计.md`：

| 字段 | 类型 | 说明 |
|------|------|------|
| growthDays | int | 生长所需天数（1-28） |
| season | Season | 适合种植的季节 |
| harvestCropID | int | 收获的作物ID（11XX） |
| harvestAmountRange | Vector2Int | 收获数量范围 |
| isReHarvestable | bool | 是否可重复收获 |
| reHarvestDays | int | 重复收获间隔天数 |
| maxHarvestCount | int | 最大收获次数（0=无限） |
| growthStageSprites | Sprite[] | 生长阶段图 |
| needsWatering | bool | 是否需要浇水 |
| plantingExp | int | 种植经验值 |
| harvestingExp | int | 收获经验值 |

**ID 范围**: 10XX

---

## 5. 已完成功能评估

### 5.1 FarmingManager 核心功能

| 功能 | 状态 | 说明 |
|------|------|------|
| TillSoil（锄地） | ✅ 完成 | 支持世界坐标和格子坐标 |
| PlantSeed（种植） | ✅ 完成 | 支持季节检查 |
| WaterTile（浇水） | ✅ 完成 | 支持 3 种视觉状态 |
| HarvestCrop（收获） | ⚠️ 部分完成 | 缺少 ItemDatabase 访问 |
| ClearCrop（清除作物） | ✅ 完成 | - |
| 时间事件订阅 | ✅ 完成 | 使用静态事件 |
| Gizmos 调试 | ✅ 完成 | 显示耕地和作物状态 |

### 5.2 CropGrowthSystem 功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 每日生长检查 | ✅ 完成 | 订阅 OnDayChanged |
| 浇水状态检查 | ✅ 完成 | 检查 wateredYesterday |
| 生长阶段更新 | ✅ 完成 | 线性分布计算 |
| 枯萎系统 | ✅ 完成 | 连续 3 天未浇水枯萎 |
| 生长停滞 | ✅ 完成 | 连续 2 天未浇水停滞 |
| 手动触发测试 | ✅ 完成 | ContextMenu |

### 5.3 编辑器工具

| 工具 | 状态 | 说明 |
|------|------|------|
| 农田系统调试工具 | ✅ 完成 | 统计、快捷操作、测试 |
| 农田 Tile 创建工具 | ✅ 完成 | 支持纯色测试 Tile |

---

## 6. 待完成功能清单

### 6.1 P0 - 核心功能（必须完成）

| 功能 | 优先级 | 预估工时 | 依赖 |
|------|--------|---------|------|
| Rule Tile 配置 | P0 | 用户操作 | 素材准备 |
| 场景 Tilemap 结构搭建 | P0 | 用户操作 | Rule Tile |
| 多楼层 Tilemap 支持 | P0 | 2h | 场景结构 |
| 锄头工具集成 | P0 | 2h | FarmingManager |
| 水壶工具集成 | P0 | 2h | FarmingManager |
| 背包系统集成（种子消耗） | P0 | 1h | InventoryService |
| 背包系统集成（作物收获） | P0 | 1h | InventoryService |
| ItemDatabase 访问实现 | P0 | 1h | - |

### 6.2 P1 - 重要功能

| 功能 | 优先级 | 预估工时 | 依赖 |
|------|--------|---------|------|
| 精力系统集成 | P1 | 1h | StaminaSystem |
| 开垦前置条件检查 | P1 | 1h | NavGrid2D |
| 开垦失败提示 UI | P1 | 1h | UI 系统 |
| 作物信息 UI | P1 | 2h | UI 系统 |
| 成熟作物特效 | P1 | 1h | - |

### 6.3 P2 - 扩展功能

| 功能 | 优先级 | 预估工时 | 依赖 |
|------|--------|---------|------|
| 肥料系统 | P2 | 4h | - |
| 品质影响 | P2 | 2h | - |
| 季节变化效果 | P2 | 2h | SeasonManager |
| 音效和粒子效果 | P2 | 2h | - |
| 保存/加载系统 | P2 | 4h | SaveSystem |

---

## 7. 关键设计决策

### 7.1 种子归属农田系统

**决策**: 种子（SeedData）由农田系统（FarmingSystem）管理，与树苗（SaplingData）分离。

**原因**:
- 种子需要耕地 Tilemap
- 种子需要浇水
- 树苗直接放置到世界坐标

**系统边界**:
```
农田系统 (FarmingSystem)
├── 耕地管理 - Tilemap 上的耕地状态
├── 种子种植 - SeedData 放置到耕地
├── 作物生长 - 每日检测浇水、更新生长天数
├── 浇水系统 - 土壤湿度管理
└── 收获系统 - 收获作物

放置系统 (PlacementManager)
├── 树苗放置 - SaplingData 放置到世界坐标
├── 工作台放置 - WorkstationData
├── 存储容器放置 - StorageData
└── 其他可放置物品
```

### 7.2 浇水逻辑

**决策**: 当天浇水 → 记录参数 → 第二天才生效作物生长

**数据流**:
```
第N天晚上：
  玩家浇水 → wateredToday = true
            waterTime = 当前时间
            视觉立即变为水渍

第N天+2小时：
  OnHourChanged → 检测时间差 ≥ 2小时
                → 视觉变为深色（无水渍）

第N+1天开始：
  OnDayChanged → wateredYesterday = wateredToday (true)
              → wateredToday = false
              → 视觉变为干燥
              
  CropGrowthSystem.OnDayChanged：
    if (wateredYesterday == true)
      → 作物生长 +1
    else
      → 连续未浇水天数 +1
      → 检查是否枯萎
```

### 7.3 多楼层支持

**决策**: 每个楼层有独立的 Farmland 和 WaterPuddle Tilemap

**结构**:
```
─── LAYER N ───
└── Tilemaps/
    ├── GroundBase        # 地面基础
    ├── Farmland          # 耕地 Tilemap（使用 Rule Tile）
    └── WaterPuddle       # 水渍叠加层
```

### 7.4 Rule Tile 自动边界拼接

**决策**: 使用 Unity Rule Tile 实现耕地边界自动拼接

**规则**:
- 单独一格 → 显示完整边界
- 相邻有耕地 → 自动切换为中心样式
- 中心有 2 种样式变体，随机选择

---

## 8. 开发建议

### 8.1 推荐开发顺序

1. **阶段 0: 素材准备**（用户操作）
   - 导入耕地边界 Sprite
   - 导入水渍 Sprite
   - 创建 Rule Tile
   - 创建水渍 Tile

2. **阶段 1: 场景配置**（用户操作）
   - 在每个 LAYER 下创建 Farmland Tilemap
   - 在每个 LAYER 下创建 WaterPuddle Tilemap
   - 手动测试 Rule Tile

3. **阶段 2: FarmingManager 重构**
   - 添加多楼层支持
   - 实现楼层检测逻辑
   - 重构 TillSoil 方法

4. **阶段 3: 工具集成**
   - 锄头工具交互
   - 水壶工具交互
   - 开垦前置条件检查

5. **阶段 4: 系统集成**
   - 背包系统集成
   - 精力系统集成
   - ItemDatabase 访问

6. **阶段 5: UI 和特效**
   - 作物信息 UI
   - 成熟特效
   - 音效和粒子

### 8.2 注意事项

1. **时间系统集成**
   - 必须使用静态事件：`TimeManager.OnDayChanged`
   - 事件签名：`void OnDayChanged(int year, int day, int totalDays)`

2. **季节判断**
   - ItemEnums.Season: Fall=2
   - SeasonManager.Season: Autumn=2
   - 需要整数比较

3. **ItemDatabase 访问**
   - 不能使用 `FindFirstObjectByType<ItemDatabase>()`
   - 需要从已有引用获取或创建 GameDataManager

4. **碰撞体用途**
   - 耕地不需要碰撞体
   - 作物可选添加 Trigger 用于交互检测

### 8.3 测试清单

- [ ] 锄地功能正常
- [ ] 种植功能正常
- [ ] 浇水视觉切换正常（3 种状态）
- [ ] 作物每日生长正常
- [ ] 未浇水停滞/枯萎正常
- [ ] 收获功能正常
- [ ] 可重复收获正常
- [ ] 多楼层独立操作正常
- [ ] Rule Tile 边界拼接正常

---

## 附录：文件路径快速索引

### Specs 文档
- `.kiro/specs/农田系统/memory.md`
- `.kiro/specs/农田系统/0_耕地系统重构/requirements.md`
- `.kiro/specs/农田系统/0_耕地系统重构/design.md`
- `.kiro/specs/农田系统/0_耕地系统重构/tasks.md`
- `.kiro/specs/农田系统/0_耕地系统重构/RuleTile配置指南.md`

### Docx 文档
- `Docx/Plan/农田系统-快速开始.md`
- `Docx/Plan/农田系统-超详细实施清单.md`
- `Docx/Plan/种田系统完整设计方案.md`
- `Docx/Plan/种田系统实施指南.md`
- `Docx/分类/农田/000_农田系统完整文档.md`
- `Docx/设计/SO/SO参数设计.md`

### 代码文件
- `Assets/YYY_Scripts/Farm/FarmingManager.cs`
- `Assets/YYY_Scripts/Farm/FarmTileData.cs`
- `Assets/YYY_Scripts/Farm/CropInstance.cs`
- `Assets/YYY_Scripts/Farm/CropGrowthSystem.cs`
- `Assets/YYY_Scripts/Farm/CropController.cs`
- `Assets/YYY_Scripts/Farm/SoilMoistureState.cs`

### 编辑器工具
- `Assets/Editor/FarmingSystemEditor.cs`
- `Assets/Editor/FarmlandTileCreator.cs`

### Steering 规则
- `.kiro/steering/archive/farming.md`
- `.kiro/steering/layers.md`

---

*调研报告完成 - 2026-01-22*
