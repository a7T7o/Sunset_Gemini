# 农田系统重构 - 验收指南

**创建日期**: 2026-01-24  
**版本**: 1.0  
**状态**: 待验收

---

## 一、已完成的代码文件

### 新建文件

| 文件路径 | 说明 |
|---------|------|
| `Assets/YYY_Scripts/Farm/Data/CropInstanceData.cs` | 作物实例数据（纯数据类） |
| `Assets/YYY_Scripts/Farm/Data/LayerTilemaps.cs` | 楼层 Tilemap 配置 |
| `Assets/YYY_Scripts/Farm/FarmTileManager.cs` | 耕地状态管理器 |
| `Assets/YYY_Scripts/Farm/CropManager.cs` | 作物生命周期管理器 |
| `Assets/YYY_Scripts/Farm/FarmVisualManager.cs` | 农田视觉管理器 |
| `Assets/YYY_Scripts/Farm/FarmingManagerNew.cs` | 农田管理器（重构版协调者） |

### 修改文件

| 文件路径 | 修改内容 |
|---------|---------|
| `Assets/YYY_Scripts/Farm/FarmTileData.cs` | 添加 layerIndex、puddleVariant、cropData 字段 |
| `Assets/YYY_Scripts/Farm/CropController.cs` | 重写为支持新版数据结构 |
| `Assets/YYY_Scripts/Farm/CropInstance.cs` | 标记为 [Obsolete] |

---

## 二、用户前置准备（必须完成）

在测试前，需要在 Unity 编辑器中完成以下配置：

### 2.1 创建 Tile 资源

- [ ] **耕地 Rule Tile**
  - 创建 Rule Tile，配置边界规则
  - 中心样式有 2 种变体，随机选择
  - 路径建议：`Assets/Art/Tiles/Farmland_RuleTile.asset`

- [ ] **水渍 Tile（3 种）**
  - 创建 3 种水渍 Tile 变体
  - 路径建议：`Assets/Art/Tiles/WaterPuddle_0.asset` 等

- [ ] **湿润深色 Tile**
  - 创建浇水 2 小时后的深色 Tile
  - 路径建议：`Assets/Art/Tiles/Farmland_WetDark.asset`

### 2.2 创建场景 Tilemap

在 `LAYER 1` 下创建以下 Tilemap：

- [ ] **Farmland Tilemap**
  - 路径：`LAYER 1/Tilemaps/Farmland`
  - Sorting Layer：Ground
  - Order in Layer：1

- [ ] **WaterPuddle Tilemap**
  - 路径：`LAYER 1/Tilemaps/WaterPuddle`
  - Sorting Layer：Ground
  - Order in Layer：2（在 Farmland 之上）

### 2.3 创建作物 Prefab

- [ ] **Crop Prefab**
  - 添加 SpriteRenderer 组件
  - 添加 CropController 组件
  - 路径建议：`Assets/Prefabs/Farm/Crop.prefab`

### 2.4 创建测试用 SO

- [ ] **SeedData SO**
  - 创建至少 1 个种子数据
  - 配置 growthStageSprites（至少 3 个阶段）
  - 配置 harvestCropID

- [ ] **CropData SO**
  - 创建对应的作物数据

### 2.5 配置管理器

在场景中创建 `FarmingSystem` 空物体，添加以下组件：

```
FarmingSystem (GameObject)
├── FarmingManagerNew (Component)
├── FarmTileManager (Component)
├── CropManager (Component)
└── FarmVisualManager (Component)
```

配置 FarmTileManager 的 `layerTilemaps` 数组：
- Element 0:
  - layerName: "LAYER 1"
  - farmlandTilemap: 拖入 Farmland Tilemap
  - waterPuddleTilemap: 拖入 WaterPuddle Tilemap
  - groundTilemap: 拖入 GroundBase Tilemap
  - propsContainer: 拖入 LAYER 1/Props

配置 FarmVisualManager 的 Tile 资源：
- dryFarmlandTile: 拖入耕地 Rule Tile
- wetDarkTile: 拖入湿润深色 Tile
- wetPuddleTiles: 拖入 3 种水渍 Tile

配置 CropManager：
- cropPrefab: 拖入 Crop Prefab

---

## 三、功能验收清单

### 3.1 耕地系统

- [ ] 装备锄头后，左键点击可耕作地面，创建耕地 Tile
- [ ] 耕地使用 Rule Tile 自动拼接边界
- [ ] 不可耕作的位置（无地面 Tile、已有耕地）无法创建耕地
- [ ] 锄地时播放音效和粒子效果

### 3.2 种植系统

- [ ] 选中种子后，左键点击已耕作的耕地，种植种子
- [ ] 种植成功后，从背包中移除 1 个种子
- [ ] 种植成功后，在耕地位置创建作物 GameObject
- [ ] 作物显示第一阶段的 Sprite
- [ ] 已有作物的耕地无法再次种植

### 3.3 浇水系统

- [ ] 装备水壶后，左键点击耕地，给该耕地浇水
- [ ] 浇水后立即显示水渍效果（WetWithPuddle 状态）
- [ ] 浇水 2 小时后，水渍消失，显示深色湿润效果（WetDark 状态）
- [ ] 第二天开始时，所有耕地恢复干燥状态（Dry 状态）
- [ ] 每块耕地每天只能浇水一次
- [ ] 浇水时播放音效和粒子效果

### 3.4 作物生长系统

- [ ] 每天开始时（OnDayChanged），检查所有作物的生长状态
- [ ] 昨天浇过水的作物，生长天数 +1
- [ ] 昨天未浇水的作物，连续未浇水天数 +1
- [ ] 连续 2 天未浇水的作物，生长停滞
- [ ] 连续 3 天未浇水的作物，枯萎
- [ ] 枯萎的作物显示枯萎颜色（黄褐色）
- [ ] 作物根据生长天数自动切换 Sprite

### 3.5 收获系统

- [ ] 右键点击成熟作物，收获作物
- [ ] 收获成功后，作物添加到背包
- [ ] 普通作物收获后，作物 GameObject 被销毁
- [ ] 枯萎的作物无法收获
- [ ] 未成熟的作物无法收获
- [ ] 收获时播放音效

---

## 四、测试步骤

### 测试 1：基础耕作流程

1. 进入游戏，装备锄头
2. 在有地面 Tile 的位置左键点击
3. **预期**：创建耕地 Tile，播放音效和粒子

### 测试 2：种植流程

1. 在背包中放入种子
2. 选中种子，在耕地上左键点击
3. **预期**：种子数量 -1，出现作物 Sprite

### 测试 3：浇水流程

1. 装备水壶，在有作物的耕地上左键点击
2. **预期**：显示水渍效果
3. 等待 2 小时（或使用时间调试器）
4. **预期**：水渍消失，显示深色湿润效果

### 测试 4：生长流程

1. 种植作物并浇水
2. 使用时间调试器跳到下一天
3. **预期**：作物 Sprite 变化（如果生长天数足够）
4. 连续 3 天不浇水
5. **预期**：作物枯萎，显示黄褐色

### 测试 5：收获流程

1. 等待作物成熟（或使用调试器）
2. 右键点击成熟作物
3. **预期**：作物添加到背包，作物 GameObject 消失

---

## 五、已知限制

1. **楼层检测**：当前 `GetCurrentLayerIndex()` 默认返回 0（LAYER 1），多楼层支持需要后续实现
2. **背包消耗**：种植时的背包消耗逻辑需要 InventoryService 实现 `RemoveItem()` 方法
3. **工具系统集成**：需要在 GameInputManager 中添加农田工具的处理逻辑
4. **旧代码兼容**：旧版 FarmingManager 仍然存在，新版使用 FarmingManagerNew

---

## 六、后续任务

以下任务尚未完成，需要后续处理：

1. **阶段 5：系统集成** ✅ 已完成
   - ✅ 在 GameInputManager 中添加农田工具处理
   - ✅ 在 PlacementManagerV3 中添加 SeedData 检查
   - ⏭️ 导航系统集成（可选，暂不需要）

2. **阶段 6：清理和测试**
   - 删除废弃的 CropGrowthSystem.cs
   - 删除废弃的 CropInstance.cs
   - 创建单元测试

---

## 七、调试开关

各组件都有 `showDebugInfo` 开关，可在 Inspector 中启用：

- `FarmTileManager.showDebugInfo` - 耕地操作日志
- `CropManager.showDebugInfo` - 作物生命周期日志
- `FarmVisualManager.showDebugInfo` - 视觉更新日志
- `FarmingManagerNew.showDebugInfo` - 协调者日志

---

**文档维护者**: Kiro  
**最后更新**: 2026-01-24
