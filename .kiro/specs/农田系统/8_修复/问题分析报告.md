# å†œç”°ç³»ç»Ÿé—®é¢˜åˆ†ææŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2026-01-27  
**çŠ¶æ€**: åˆ†æå®Œæˆï¼Œå¾…ä¿®å¤

---

## ä¸€ã€é—®é¢˜æ€»è§ˆ

| # | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ç±»å‹ | çŠ¶æ€ |
|---|------|---------|------|------|
| 1 | é‡å¤é”„åœ° | ğŸŸ  ä¸¥é‡ | é€»è¾‘é”™è¯¯ | å¾…ä¿®å¤ |
| 2 | ç¼ºå°‘è€•åœ°é¢„è§ˆ | ğŸŸ¡ ä¸­ç­‰ | åŠŸèƒ½ç¼ºå¤± | å¾…å®ç° |
| 3 | æµ‡æ°´åæ ‡é”™è¯¯ | ğŸ”´ è‡´å‘½ | åæ ‡ç³»ç»Ÿ | å¾…ä¿®å¤ |
| 4 | effectRadius èŒƒå›´é™åˆ¶ | ğŸŸ¡ ä¸­ç­‰ | é…ç½®é™åˆ¶ | å¾…ä¿®å¤ |
| 5 | SO å­—æ®µè®¾è®¡é—®é¢˜ | ğŸŸ¢ è½»å¾® | æŠ€æœ¯å€ºåŠ¡ | è·¨å·¥ä½œåŒº |

---

## äºŒã€é—®é¢˜è¯¦ç»†åˆ†æ

### é—®é¢˜ 1ï¼šé‡å¤é”„åœ°

#### ç°è±¡æè¿°
ç”¨æˆ·å¯ä»¥åœ¨åŒä¸€ä¸ªä½ç½®é‡å¤é”„åœ°ï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„äº¤äº’è¡Œä¸ºã€‚

#### ä»£ç è¿½è¸ª

**GameInputManager.TryTillSoil()**:
```csharp
// æ£€æŸ¥æ˜¯å¦å¯ä»¥è€•ä½œ
if (!farmTileManager.CanTillAt(layerIndex, cellPosition))
{
    if (showDebugInfo)
        Debug.Log($"[GameInputManager] æ— æ³•åœ¨ {cellPosition} è€•ä½œ");
    return false;
}

// åˆ›å»ºè€•åœ°
bool success = farmTileManager.CreateTile(layerIndex, cellPosition);
```

**FarmTileManager.CanTillAt()**:
```csharp
public bool CanTillAt(int layerIndex, Vector3Int cellPosition)
{
    // æ£€æŸ¥æ¥¼å±‚æ˜¯å¦æœ‰æ•ˆ
    if (!farmTilesByLayer.TryGetValue(layerIndex, out var layerTiles))
    {
        return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è€•åœ°
    if (layerTiles.TryGetValue(cellPosition, out var existingTile))
    {
        if (existingTile.isTilled)
        {
            return false;  // â† è¿™é‡Œåº”è¯¥é˜»æ­¢é‡å¤é”„åœ°
        }
    }
    
    // ... å…¶ä»–æ£€æŸ¥
}
```

#### é—®é¢˜æ ¹æºåˆ†æ

ä»£ç é€»è¾‘çœ‹èµ·æ¥æ­£ç¡®ï¼Œä½†å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å­—å…¸åˆå§‹åŒ–é—®é¢˜**ï¼š`farmTilesByLayer` å¯èƒ½æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–
2. **æ¥¼å±‚ç´¢å¼•é—®é¢˜**ï¼š`GetCurrentLayerIndex()` è¿”å›çš„æ¥¼å±‚å¯èƒ½ä¸ä¸€è‡´
3. **åæ ‡è½¬æ¢é—®é¢˜**ï¼šä¸¤æ¬¡é”„åœ°çš„åæ ‡è½¬æ¢ç»“æœå¯èƒ½ä¸åŒ

#### ä¿®å¤æ–¹æ¡ˆ

```csharp
// æ–¹æ¡ˆ Aï¼šåœ¨ CreateTile å¼€å¤´æ·»åŠ å¼ºåˆ¶æ£€æŸ¥
public bool CreateTile(int layerIndex, Vector3Int cellPosition)
{
    // ğŸ”´ å¼ºåˆ¶æ£€æŸ¥ï¼šå¦‚æœå·²å­˜åœ¨è€•åœ°ï¼Œç›´æ¥è¿”å› false
    var existingTile = GetTileData(layerIndex, cellPosition);
    if (existingTile != null && existingTile.isTilled)
    {
        Debug.LogWarning($"[FarmTileManager] é‡å¤é”„åœ°è¢«é˜»æ­¢: {cellPosition}");
        return false;
    }
    
    // ... åŸæœ‰é€»è¾‘
}
```

---

### é—®é¢˜ 2ï¼šç¼ºå°‘è€•åœ°é¢„è§ˆç³»ç»Ÿ

#### ç°è±¡æè¿°
é”„åœ°æ—¶æ²¡æœ‰é¢„è§ˆï¼Œç”¨æˆ·æ— æ³•æå‰çŸ¥é“èƒ½å¦è€•ä½œã€‚

#### ç”¨æˆ·æœŸæœ›
- å‚è€ƒæ”¾ç½®ç³»ç»Ÿ `PlacementPreviewV3` çš„å®ç°
- æ˜¾ç¤ºç»¿è‰²/çº¢è‰²é¢„è§ˆè¡¨ç¤ºå¯ä»¥/ä¸å¯ä»¥è€•ä½œ
- ç”¨æˆ·ä¼šæä¾›é¢„è§ˆ Sprite

#### è®¾è®¡æ–¹æ¡ˆ

**æ–°å»º FarmlandPreview.cs**:
```csharp
public class FarmlandPreview : MonoBehaviour
{
    [Header("é¢„è§ˆé…ç½®")]
    [SerializeField] private SpriteRenderer previewRenderer;
    [SerializeField] private Sprite validSprite;    // ç”¨æˆ·é…ç½®
    [SerializeField] private Sprite invalidSprite;  // ç”¨æˆ·é…ç½®
    
    [Header("é¢œè‰²é…ç½®")]
    [SerializeField] private Color validColor = new Color(0f, 1f, 0f, 0.6f);
    [SerializeField] private Color invalidColor = new Color(1f, 0f, 0f, 0.6f);
    
    private bool isValid = false;
    
    public void Show() { gameObject.SetActive(true); }
    public void Hide() { gameObject.SetActive(false); }
    
    public void UpdatePosition(Vector3 worldPosition)
    {
        // å¯¹é½åˆ°æ ¼å­ä¸­å¿ƒ
        Vector3 cellCenter = GetCellCenter(worldPosition);
        transform.position = cellCenter;
    }
    
    public void SetValid(bool valid)
    {
        isValid = valid;
        previewRenderer.sprite = valid ? validSprite : invalidSprite;
        previewRenderer.color = valid ? validColor : invalidColor;
    }
}
```

**ä¿®æ”¹ GameInputManager**:
```csharp
// åœ¨ Update ä¸­æ£€æµ‹é”„å¤´è£…å¤‡
void Update()
{
    // ... å…¶ä»–é€»è¾‘
    
    // é”„å¤´é¢„è§ˆ
    UpdateFarmlandPreview();
}

private void UpdateFarmlandPreview()
{
    // æ£€æŸ¥æ˜¯å¦è£…å¤‡é”„å¤´
    var tool = GetCurrentTool();
    if (tool == null || tool.toolType != ToolType.Hoe)
    {
        farmlandPreview?.Hide();
        return;
    }
    
    // æ˜¾ç¤ºé¢„è§ˆ
    farmlandPreview?.Show();
    
    // æ›´æ–°ä½ç½®
    Vector3 worldPos = GetMouseWorldPosition();
    farmlandPreview?.UpdatePosition(worldPos);
    
    // æ›´æ–°çŠ¶æ€
    int layerIndex = farmTileManager.GetCurrentLayerIndex(worldPos);
    var tilemaps = farmTileManager.GetLayerTilemaps(layerIndex);
    Vector3Int cellPos = tilemaps.WorldToCell(worldPos);
    bool canTill = farmTileManager.CanTillAt(layerIndex, cellPos);
    farmlandPreview?.SetValid(canTill);
}
```

---

### é—®é¢˜ 3ï¼šæµ‡æ°´åæ ‡é”™è¯¯ï¼ˆè‡´å‘½ï¼‰

#### ç°è±¡æè¿°
ç”¨æˆ·ç«™åœ¨è€•åœ°ä¸Šæ— æ³•æµ‡æ°´ï¼Œåæ ‡ä¸åŒ¹é…ã€‚

#### ä»£ç è¿½è¸ª

**åˆ›å»ºè€•åœ°æ—¶**:
```csharp
// GameInputManager.TryTillSoil()
Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);
bool success = farmTileManager.CreateTile(layerIndex, cellPosition);
```

**æµ‡æ°´æ—¶**:
```csharp
// GameInputManager.TryWaterTile()
Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);
bool success = farmTileManager.SetWatered(layerIndex, cellPosition, currentHour);
```

**LayerTilemaps.WorldToCell()**:
```csharp
public Vector3Int WorldToCell(Vector3 worldPosition)
{
    // ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆå­—æ®µ
    if (farmlandCenterTilemap != null)
        return farmlandCenterTilemap.WorldToCell(worldPosition);
    
    // å›é€€åˆ°æ—§ç‰ˆå­—æ®µ
    if (farmlandTilemap != null)
        return farmlandTilemap.WorldToCell(worldPosition);
    
    // æœ€åå°è¯•ä½¿ç”¨ groundTilemap
    if (groundTilemap != null)
        return groundTilemap.WorldToCell(worldPosition);
    
    return Vector3Int.zero;
}
```

#### é—®é¢˜æ ¹æºåˆ†æ

**å¯èƒ½çš„é—®é¢˜ 1ï¼šTilemap é…ç½®ä¸ä¸€è‡´**
- å¦‚æœ `farmlandCenterTilemap` æœªé…ç½®ï¼Œä¼šå›é€€åˆ° `groundTilemap`
- ä½† `CreateTile()` ä¸­æ£€æŸ¥çš„æ˜¯ `groundTilemap.GetTile()`
- ä¸¤ä¸ª Tilemap çš„ Grid è®¾ç½®å¯èƒ½ä¸åŒ

**å¯èƒ½çš„é—®é¢˜ 2ï¼šGrid è®¾ç½®ä¸åŒ**
- ä¸åŒ Tilemap å¯èƒ½ä½¿ç”¨ä¸åŒçš„ Grid
- å¯¼è‡´ `WorldToCell()` è¿”å›ä¸åŒçš„åæ ‡

**å¯èƒ½çš„é—®é¢˜ 3ï¼šTilemap ä½ç½®åç§»**
- Tilemap çš„ Transform ä½ç½®å¯èƒ½æœ‰åç§»
- å¯¼è‡´åæ ‡è½¬æ¢ç»“æœä¸ä¸€è‡´

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šç»Ÿä¸€ä½¿ç”¨ groundTilemap è¿›è¡Œåæ ‡è½¬æ¢**
```csharp
public Vector3Int WorldToCell(Vector3 worldPosition)
{
    // ğŸ”´ ç»Ÿä¸€ä½¿ç”¨ groundTilemap è¿›è¡Œåæ ‡è½¬æ¢
    // å› ä¸ºè€•åœ°æ£€æŸ¥ä½¿ç”¨çš„æ˜¯ groundTilemap
    if (groundTilemap != null)
    {
        return groundTilemap.WorldToCell(worldPosition);
    }
    
    // å›é€€é€»è¾‘
    if (farmlandCenterTilemap != null)
        return farmlandCenterTilemap.WorldToCell(worldPosition);
    
    if (farmlandTilemap != null)
        return farmlandTilemap.WorldToCell(worldPosition);
    
    return Vector3Int.zero;
}
```

**æ–¹æ¡ˆ Bï¼šç¡®ä¿æ‰€æœ‰ Tilemap ä½¿ç”¨åŒä¸€ä¸ª Grid**
- åœ¨ Unity ç¼–è¾‘å™¨ä¸­æ£€æŸ¥æ‰€æœ‰ Tilemap çš„ Grid è®¾ç½®
- ç¡®ä¿ Cell Sizeã€Cell Gapã€Cell Layout ä¸€è‡´

---

### é—®é¢˜ 4ï¼šeffectRadius èŒƒå›´é™åˆ¶

#### ç°è±¡æè¿°
`effectRadius` æœ€ä½åªèƒ½è®¾ç½®ä¸º 1ï¼Œæ— æ³•è®¾ç½® 0.4ã€‚

#### ä»£ç åˆ†æ
```csharp
// ToolData.cs
[Tooltip("ä½œç”¨èŒƒå›´ï¼ˆ1=å•æ ¼ï¼Œ3=3x3èŒƒå›´ï¼‰")]
[Range(1, 5)]
public int effectRadius = 1;
```

#### é—®é¢˜æ ¹æº
- `effectRadius` æ˜¯ `int` ç±»å‹
- `[Range(1, 5)]` é™åˆ¶äº†æœ€å°å€¼ä¸º 1

#### ä¿®å¤æ–¹æ¡ˆ

```csharp
// ä¿®æ”¹ ToolData.cs
[Tooltip("ä½œç”¨èŒƒå›´ï¼ˆ0.1=æå°èŒƒå›´ï¼Œ1=å•æ ¼ï¼Œ3=3x3èŒƒå›´ï¼‰")]
[Range(0.1f, 5f)]
public float effectRadius = 1f;
```

**éœ€è¦æ›´æ–°çš„ä»£ç **ï¼š
- æ‰€æœ‰ä½¿ç”¨ `effectRadius` çš„åœ°æ–¹éœ€è¦é€‚é… float ç±»å‹
- å¯èƒ½éœ€è¦æ›´æ–°æµ‡æ°´é€»è¾‘ï¼Œæ”¯æŒå°äº 1 æ ¼çš„èŒƒå›´

---

### é—®é¢˜ 5ï¼šSO å­—æ®µè®¾è®¡é—®é¢˜

#### ç°è±¡æè¿°
- ToolData æ˜¾ç¤º"æ”¾ç½®é…ç½®"ã€"æ¶ˆè€—å“é…ç½®"
- PlantData æ˜¾ç¤º"è£…å¤‡é…ç½®"ã€"æ¶ˆè€—å“é…ç½®"

#### é—®é¢˜æ ¹æº
åŸºç±» `ItemData` ä¸­åŒ…å«äº†æ‰€æœ‰å­ç±»çš„å­—æ®µï¼Œå¯¼è‡´å­ç±»æ˜¾ç¤ºä¸ç›¸å…³çš„é…ç½®åŒºåŸŸã€‚

#### è·¨å·¥ä½œåŒºå¤„ç†
æ­¤é—®é¢˜åœ¨ `.kiro/specs/SOè®¾è®¡ç³»ç»Ÿ/0_å­—æ®µä¼˜åŒ–é‡æ„/` å·¥ä½œåŒºå·²æœ‰è¯¦ç»†éœ€æ±‚æ–‡æ¡£ã€‚

#### ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
åœ¨å­ç±»ä¸­ä½¿ç”¨ `[HideInInspector]` éšè—ä¸éœ€è¦çš„å­—æ®µï¼š
```csharp
// ToolData.cs
[HideInInspector]
public new PlacementConfig placementConfig;

[HideInInspector]
public new ConsumableConfig consumableConfig;
```

---

## ä¸‰ã€SO å­—æ®µç°çŠ¶åˆ†æ

### å½“å‰ ItemData åŸºç±»å­—æ®µ

æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œéœ€è¦åˆ—å‡ºæ‰€æœ‰åˆ†ç±»çš„ SO ä¸­å­˜åœ¨çš„é…ç½®å±æ€§ï¼š

| å­—æ®µ/é…ç½®åŒºåŸŸ | ItemData | ToolData | WeaponData | SeedData | CropData | FoodData | MaterialData |
|--------------|----------|----------|------------|----------|----------|----------|--------------|
| åŸºç¡€å±æ€§ | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| å·¥å…·ä¸“å±å±æ€§ | âŒ | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| æ­¦å™¨ä¸“å±å±æ€§ | âŒ | âŒ | âœ… | âŒ | âŒ | âŒ | âŒ |
| ç§å­ä¸“å±å±æ€§ | âŒ | âŒ | âŒ | âœ… | âŒ | âŒ | âŒ |
| ä½œç‰©ä¸“å±å±æ€§ | âŒ | âŒ | âŒ | âŒ | âœ… | âŒ | âŒ |
| é£Ÿç‰©ä¸“å±å±æ€§ | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… | âŒ |
| æ”¾ç½®é…ç½® | âœ… | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— |
| æ¶ˆè€—å“é…ç½® | âœ… | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âœ… | âŒåº”éšè— |
| è£…å¤‡é…ç½® | âœ… | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— | âŒåº”éšè— |

### åº”è¯¥çš„è®¾è®¡

| å­—æ®µ/é…ç½®åŒºåŸŸ | åº”è¯¥æ˜¾ç¤ºåœ¨å“ªäº› SO |
|--------------|------------------|
| æ”¾ç½®é…ç½® | PlaceableItemDataï¼ˆæ ‘è‹—ã€ç®±å­ã€å·¥ä½œå°ç­‰ï¼‰ |
| æ¶ˆè€—å“é…ç½® | FoodData, PotionData |
| è£…å¤‡é…ç½® | ArmorData, AccessoryData |
| å·¥å…·ä¸“å±å±æ€§ | ToolData |
| æ­¦å™¨ä¸“å±å±æ€§ | WeaponData |

---

## å››ã€ä¿®å¤è®¡åˆ’

### é˜¶æ®µ 1ï¼šP0 è‡´å‘½é—®é¢˜ä¿®å¤ï¼ˆ1.5hï¼‰

1. **ä¿®å¤æµ‡æ°´åæ ‡é”™è¯¯**
   - ç»Ÿä¸€åæ ‡è½¬æ¢é€»è¾‘
   - æ·»åŠ è°ƒè¯•æ—¥å¿—å®šä½é—®é¢˜

2. **ä¿®å¤é‡å¤é”„åœ°**
   - åœ¨ CreateTile å¼€å¤´æ·»åŠ å¼ºåˆ¶æ£€æŸ¥
   - æ·»åŠ è­¦å‘Šæ—¥å¿—

### é˜¶æ®µ 2ï¼šP1 é‡è¦åŠŸèƒ½ï¼ˆ2.5hï¼‰

1. **å®ç°è€•åœ°é¢„è§ˆç³»ç»Ÿ**
   - åˆ›å»º FarmlandPreview ç»„ä»¶
   - é›†æˆåˆ° GameInputManager
   - ç”¨æˆ·é…ç½®é¢„è§ˆ Sprite

2. **ä¿®å¤ effectRadius èŒƒå›´**
   - ä¿®æ”¹ä¸º float ç±»å‹
   - æ›´æ–°ç›¸å…³ä»£ç 

### é˜¶æ®µ 3ï¼šP2 æŠ€æœ¯å€ºåŠ¡ï¼ˆ4hï¼‰

1. **SO å­—æ®µä¼˜åŒ–**
   - åœ¨ SO è®¾è®¡ç³»ç»Ÿå·¥ä½œåŒºå®Œæˆ
   - æˆ–ä¸´æ—¶ä½¿ç”¨ HideInInspector

---

## äº”ã€éªŒæ”¶æ ‡å‡†

### é—®é¢˜ 1 éªŒæ”¶
- [ ] åœ¨åŒä¸€ä½ç½®é”„åœ°ä¸¤æ¬¡ï¼Œç¬¬äºŒæ¬¡åº”è¯¥å¤±è´¥
- [ ] æ§åˆ¶å°åº”è¯¥è¾“å‡ºè­¦å‘Šæ—¥å¿—

### é—®é¢˜ 2 éªŒæ”¶
- [ ] è£…å¤‡é”„å¤´æ—¶æ˜¾ç¤ºé¢„è§ˆ
- [ ] é¢„è§ˆè·Ÿéšé¼ æ ‡ç§»åŠ¨
- [ ] å¯è€•ä½œä½ç½®æ˜¾ç¤ºç»¿è‰²
- [ ] ä¸å¯è€•ä½œä½ç½®æ˜¾ç¤ºçº¢è‰²

### é—®é¢˜ 3 éªŒæ”¶
- [ ] åœ¨è€•åœ°ä¸Šæµ‡æ°´æˆåŠŸ
- [ ] æµ‡æ°´åè€•åœ°çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] æ°´æ¸ Tile æ­£ç¡®æ˜¾ç¤º

### é—®é¢˜ 4 éªŒæ”¶
- [ ] effectRadius å¯ä»¥è®¾ç½®ä¸º 0.4
- [ ] æµ‡æ°´èŒƒå›´æ­£ç¡®åº”ç”¨

### é—®é¢˜ 5 éªŒæ”¶
- [ ] ToolData ä¸æ˜¾ç¤ºæ”¾ç½®é…ç½®å’Œæ¶ˆè€—å“é…ç½®
- [ ] SeedData ä¸æ˜¾ç¤ºè£…å¤‡é…ç½®å’Œæ¶ˆè€—å“é…ç½®
