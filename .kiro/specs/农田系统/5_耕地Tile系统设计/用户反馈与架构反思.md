# ç”¨æˆ·åé¦ˆä¸æ¶æ„åæ€

**æ—¥æœŸ**: 2026-01-26  
**è§¦å‘**: ç”¨æˆ·è¦æ±‚å…¨é¢å®¡æ ¸å†œç”°ç³»ç»Ÿè®¾è®¡çš„åˆç†æ€§

---

## ä¸€ã€ç”¨æˆ·åŸå§‹åé¦ˆ

### 1.1 ç”¨æˆ·çš„è§‚å¯Ÿ

> "æˆ‘çœ‹åˆ° FarmTileManager å’Œ FarmVisualManager å¥½åƒå‚æ•°æœ‰äº›é‡å è®¾è®¡æœ‰äº›ç›¸ä¼¼ï¼Œä½†æ˜¯ FarmVisualManager çš„å†…å®¹æ›´å…¨é¢"

> "å¯¹äº FarmVisualManager çš„ dryFarmlandTile æ˜¯éœ€è¦ RuleTileï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯ä»ä¸€å¼€å§‹å°±æ²¡æœ‰éœ€è¦è¿™ä¸ªå†…å®¹ï¼Ÿ"

> "CropManager è®¾è®¡æ˜¯å¦æ€ªå¼‚ï¼Ÿè¿™ä¸ªéš¾é“ä¸æ˜¯æ¯ä¸€ä¸ªä½œç‰©ä¸€ä¸ªç‹¬ç«‹çš„ manager å—ï¼Œå’Œ TreeController å’Œ StoneController ä¸€æ ·ï¼Œæ¯ä¸ªä½œç‰©çš„é˜¶æ®µå’Œå†…å®¹è®¾è®¡"

> "è¿˜æ˜¯è¯´è¿™ä¸ª CropManager åªæ˜¯ä¸€ä¸ªè¿‡æ¸¡å†…å®¹ï¼Œåç»­æˆ‘ä»¬å®Œæˆäº†å¯¹ä½œç‰©çš„ç”Ÿäº§å‘¨æœŸå’Œè¿‡ç¨‹è®¾è®¡å†è¿›è¡Œå®Œå–„ï¼Œå½“å‰å…ˆä¸»è¦å®Œæˆè€•åœ°çš„ç”Ÿæˆä»¥åŠè¾¹ç•Œå’Œæµ‡æ°´ç­‰æ“ä½œ"

### 1.2 ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜

1. **FarmTileManager vs FarmVisualManager èŒè´£é‡å **
2. **FarmVisualManager çš„ dryFarmlandTileï¼ˆRule Tileï¼‰æ˜¯å¦å¿…è¦**
3. **CropManager çš„è®¾è®¡æ¨¡å¼æ˜¯å¦åˆç†**
4. **å½“å‰é˜¶æ®µçš„ä¼˜å…ˆçº§æ˜¯ä»€ä¹ˆ**

---

## äºŒã€AI çš„åæ€ä¸åˆ†æ

### 2.1 å…³äº FarmTileManager å’Œ FarmVisualManager çš„é‡å 

**åœºæ™¯æˆªå›¾åˆ†æ**ï¼š

**FarmTileManager çš„ LayerTilemaps é…ç½®**ï¼š
```
Layer 1:
  - å±‚åç§°: Layer 1
  - Farmland... (farmlandTilemap): æ— 
  - Water Pud... (waterPuddleTilemap): æ— 
  - Farmland... (farmlandCenterTilemap): Layer 1 - Farmland_Center âœ…
  - Farmland... (farmlandBorderTilemap): Layer 1 - Farmland_Border âœ…
  - Ground Til... (groundTilemap): æ— 
  - Props Con... (propsContainer): Farm (Transform) âœ…
```

**FarmVisualManager çš„é…ç½®**ï¼š
```
è€•åœ° Tile:
  - Dry Farmland Tile: æ—  (TileBase)
  - Wet Dark Tile: æ—  (TileBase)
æ°´æ¸ Tile:
  - Wet Puddle Tiles: ç©ºåˆ—è¡¨ (0 ä¸ª)
éŸ³æ•ˆ:
  - Tilling Sound Clip: æ— 
  - Watering Sound Clip: æ— 
  - Harvest Sound Clip: æ— 
  - Planting Sound Clip: æ— 
ç²’å­æ•ˆæœ:
  - Tilling Particle Pre...: æ— 
  - Watering Particle...: æ— 
  - Harvest Particle Pr...: æ— 
```

**é—®é¢˜åˆ†æ**ï¼š

1. **FarmVisualManager.UpdateTileVisual()** ä½¿ç”¨çš„æ˜¯ `tilemaps.farmlandTilemap`ï¼ˆæ—§ç‰ˆå­—æ®µï¼‰
2. ä½†ç”¨æˆ·é…ç½®çš„æ˜¯ `farmlandCenterTilemap`ï¼ˆæ–°ç‰ˆå­—æ®µï¼‰
3. è¿™ä¸¤ä¸ªå­—æ®µä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯¼è‡´ä»£ç å’Œé…ç½®ä¸åŒ¹é…

**ä»£ç è¯æ®**ï¼š
```csharp
// FarmVisualManager.UpdateTileVisual()
public void UpdateTileVisual(LayerTilemaps tilemaps, Vector3Int cellPosition, FarmTileData tileData)
{
    if (tilemaps == null || tilemaps.farmlandTilemap == null) return;  // â† ä½¿ç”¨æ—§ç‰ˆå­—æ®µ
    
    // ...
    tilemaps.farmlandTilemap.SetTile(cellPosition, targetTile);  // â† ä½¿ç”¨æ—§ç‰ˆå­—æ®µ
}
```

**ç»“è®º**ï¼šFarmVisualManager æ˜¯ä¸º**æ—§ç‰ˆ Rule Tile ç³»ç»Ÿ**è®¾è®¡çš„ï¼Œä¸æ–°ç‰ˆ"ä¸­å¿ƒå— + è¾¹ç•Œ"ç³»ç»Ÿä¸å…¼å®¹ã€‚

### 2.2 å…³äº dryFarmlandTileï¼ˆRule Tileï¼‰æ˜¯å¦å¿…è¦

**ç”¨æˆ·çš„åˆ¤æ–­å®Œå…¨æ­£ç¡®**ã€‚

**æ–°ç³»ç»Ÿè®¾è®¡**ï¼š
- ä¸­å¿ƒå— C0/C1 ç”± `FarmlandBorderManager` ä»£ç æ§åˆ¶æ”¾ç½®
- è¾¹ç•Œè£…é¥°ç”± `FarmlandBorderManager` ä»£ç è®¡ç®—å¹¶æ”¾ç½®
- **ä¸éœ€è¦ Rule Tile è‡ªåŠ¨æ‹¼æ¥**

**æ—§ç³»ç»Ÿè®¾è®¡**ï¼ˆFarmVisualManager çš„è®¾è®¡ç›®æ ‡ï¼‰ï¼š
- ä½¿ç”¨ Rule Tile è‡ªåŠ¨æ‹¼æ¥è€•åœ°è¾¹ç•Œ
- `dryFarmlandTile` æ˜¯ Rule Tileï¼Œä¼šæ ¹æ®ç›¸é‚»æ ¼å­è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„è¾¹ç•Œæ ·å¼

**çŸ›ç›¾ç‚¹**ï¼š
- æˆ‘ä»¬é€‰æ‹©äº†"ä»£ç æ§åˆ¶è¾¹ç•Œ"çš„æ–°ç³»ç»Ÿ
- ä½† FarmVisualManager ä»ç„¶æœŸæœ›ä½¿ç”¨ Rule Tile
- è¿™æ˜¯è®¾è®¡ä¸Šçš„ä¸ä¸€è‡´

**ç»“è®º**ï¼š`dryFarmlandTile` åœ¨æ–°ç³»ç»Ÿä¸­**ä¸éœ€è¦**ï¼ŒFarmVisualManager çš„ Tile ç›¸å…³åŠŸèƒ½å¯ä»¥åˆ é™¤æˆ–é‡æ„ã€‚

### 2.3 å…³äº CropManager çš„è®¾è®¡æ¨¡å¼

**ç”¨æˆ·çš„è§‚å¯Ÿéå¸¸å‡†ç¡®**ã€‚

**å½“å‰è®¾è®¡**ï¼š
```
CropManagerï¼ˆå…¨å±€å•ä¾‹ï¼‰
  â”œâ”€â”€ ç®¡ç†æ‰€æœ‰ä½œç‰©å®ä¾‹çš„å­—å…¸
  â”‚     Dictionary<(layer, pos), CropController>
  â””â”€â”€ è´Ÿè´£ï¼š
        - åˆ›å»ºä½œç‰© GameObject
        - é”€æ¯ä½œç‰© GameObject
        - æ¯æ—¥ç”Ÿé•¿é€»è¾‘
        - æ”¶è·é€»è¾‘
```

**ç”¨æˆ·æœŸæœ›çš„è®¾è®¡**ï¼ˆç±»ä¼¼ TreeController/StoneControllerï¼‰ï¼š
```
æ¯ä¸ªä½œç‰© GameObject
  â””â”€â”€ CropControllerï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰
        - ç®¡ç†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸ
        - ç®¡ç†è‡ªå·±çš„ç”Ÿé•¿é˜¶æ®µ
        - ç®¡ç†è‡ªå·±çš„ Sprite åˆ‡æ¢
        - å“åº”å¤–éƒ¨äº‹ä»¶ï¼ˆæµ‡æ°´ã€æ”¶è·ï¼‰
```

**å¯¹æ¯”åˆ†æ**ï¼š

| æ–¹é¢ | å½“å‰ CropManager è®¾è®¡ | TreeController è®¾è®¡ |
|------|----------------------|---------------------|
| å®ä¾‹ç®¡ç† | å…¨å±€å­—å…¸é›†ä¸­ç®¡ç† | æ¯ä¸ªå®ä¾‹ç‹¬ç«‹å­˜åœ¨ |
| ç”Ÿé•¿é€»è¾‘ | CropManager ç»Ÿä¸€å¤„ç† | æ¯ä¸ª Controller è‡ªå·±å¤„ç† |
| æ•°æ®å­˜å‚¨ | CropInstanceData åœ¨ FarmTileData ä¸­ | æ•°æ®åœ¨ Controller ç»„ä»¶ä¸­ |
| é”€æ¯é€»è¾‘ | CropManager.DestroyCrop() | Destroy(gameObject) |

**é—®é¢˜**ï¼š
1. CropManager æ‰¿æ‹…äº†å¤ªå¤šèŒè´£ï¼ˆå·¥å‚ + ç”Ÿå‘½å‘¨æœŸç®¡ç† + æ•°æ®å­˜å‚¨ï¼‰
2. ä¸é¡¹ç›®ä¸­å…¶ä»–ç±»ä¼¼ç³»ç»Ÿï¼ˆTreeControllerã€StoneControllerï¼‰çš„è®¾è®¡æ¨¡å¼ä¸ä¸€è‡´
3. å¢åŠ äº†ç†è§£å’Œç»´æŠ¤çš„å¤æ‚åº¦

**ç»“è®º**ï¼šç”¨æˆ·çš„åˆ¤æ–­æ­£ç¡®ï¼ŒCropManager çš„è®¾è®¡ä¸é¡¹ç›®é£æ ¼ä¸ä¸€è‡´ã€‚åº”è¯¥è®© CropController ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼ŒCropManager åªä½œä¸ºå¯é€‰çš„"å·¥å‚"æˆ–"æ³¨å†Œè¡¨"ã€‚

### 2.4 å…³äºå½“å‰é˜¶æ®µçš„ä¼˜å…ˆçº§

**ç”¨æˆ·çš„æ€è·¯å®Œå…¨æ­£ç¡®**ï¼š

> "å½“å‰å…ˆä¸»è¦å®Œæˆè€•åœ°çš„ç”Ÿæˆä»¥åŠè¾¹ç•Œå’Œæµ‡æ°´ç­‰æ“ä½œ"

**å½“å‰é˜¶æ®µç›®æ ‡**ï¼š
1. âœ… é”„åœ° â†’ ç”Ÿæˆä¸­å¿ƒå— Tile
2. âœ… è¾¹ç•Œ â†’ è‡ªåŠ¨è®¡ç®—å¹¶æ”¾ç½®è¾¹ç•Œè£…é¥°
3. â³ æµ‡æ°´ â†’ æ›´æ–°è€•åœ°çŠ¶æ€ï¼ˆéœ€è¦ç®€åŒ–å®ç°ï¼‰
4. âŒ ä½œç‰©ç³»ç»Ÿ â†’ åç»­å†è®¾è®¡

**ä½œç‰©ç³»ç»Ÿåº”è¯¥åç»­å•ç‹¬è®¾è®¡**ï¼Œå‚è€ƒ TreeController çš„æ¨¡å¼ï¼š
- æ¯ä¸ªä½œç‰©æœ‰ç‹¬ç«‹çš„ CropController
- CropController ç®¡ç†è‡ªå·±çš„ç”Ÿé•¿é˜¶æ®µã€Spriteã€äº¤äº’
- å¯ä»¥æœ‰ä¸€ä¸ª CropRegistry ç”¨äºå…¨å±€æŸ¥è¯¢ï¼ˆç±»ä¼¼ ResourceNodeRegistryï¼‰

---

## ä¸‰ã€æ¶æ„é—®é¢˜æ€»ç»“

### 3.1 å‘ç°çš„é—®é¢˜

| # | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ |
|---|------|---------|------|
| 1 | FarmVisualManager ä½¿ç”¨æ—§ç‰ˆ Tilemap å­—æ®µ | ğŸ”´ é«˜ | ä»£ç æ— æ³•æ­£å¸¸å·¥ä½œ |
| 2 | FarmVisualManager çš„ dryFarmlandTile åœ¨æ–°ç³»ç»Ÿä¸­æ— ç”¨ | ğŸŸ¡ ä¸­ | é…ç½®æ··ä¹± |
| 3 | FarmingManagerNew è¿‡åº¦è®¾è®¡ | ğŸŸ¡ ä¸­ | å¢åŠ é…ç½®å¤æ‚åº¦ |
| 4 | CropManager è®¾è®¡ä¸é¡¹ç›®é£æ ¼ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | åç»­ç»´æŠ¤å›°éš¾ |
| 5 | LayerTilemaps æœ‰æ–°æ—§ä¸¤å¥—å­—æ®µ | ğŸŸ¡ ä¸­ | å®¹æ˜“æ··æ·† |

### 3.2 æ ¹æœ¬åŸå› 

1. **å†å²é—ç•™**ï¼šFarmVisualManager å’Œ FarmingManagerNew æ˜¯ä¸ºæ—§ç‰ˆ Rule Tile ç³»ç»Ÿè®¾è®¡çš„
2. **éœ€æ±‚å˜æ›´**ï¼šç”¨æˆ·é€‰æ‹©äº†"ä»£ç æ§åˆ¶è¾¹ç•Œ"çš„æ–°ç³»ç»Ÿï¼Œä½†æ—§ä»£ç æ²¡æœ‰åŒæ­¥æ›´æ–°
3. **è¿‡åº¦è®¾è®¡**ï¼š5 ä¸ªå•ä¾‹ç®¡ç†å™¨ï¼ˆFarmingManagerNewã€FarmTileManagerã€FarmVisualManagerã€CropManagerã€FarmlandBorderManagerï¼‰èŒè´£åˆ†æ•£

---

## å››ã€ç®€åŒ–æ–¹æ¡ˆ

### 4.1 å½“å‰é˜¶æ®µä¿ç•™çš„ç»„ä»¶

| ç»„ä»¶ | èŒè´£ | çŠ¶æ€ |
|------|------|------|
| FarmTileManager | è€•åœ°æ•°æ®ç®¡ç†ï¼ˆCRUDã€æµ‡æ°´çŠ¶æ€ï¼‰ | âœ… ä¿ç•™ |
| FarmlandBorderManager | è¾¹ç•Œè§†è§‰ç®¡ç†ï¼ˆä¸­å¿ƒå— + è¾¹ç•Œ Tileï¼‰ | âœ… ä¿ç•™ |

### 4.2 å½“å‰é˜¶æ®µåˆ é™¤/æš‚ä¸ä½¿ç”¨çš„ç»„ä»¶

| ç»„ä»¶ | åŸå›  | å¤„ç†æ–¹å¼ |
|------|------|---------|
| FarmingManagerNew | è¿‡åº¦è®¾è®¡çš„åè°ƒè€…ï¼Œå¢åŠ é…ç½®å¤æ‚åº¦ | æš‚ä¸ä½¿ç”¨ |
| FarmVisualManager | ä¸ºæ—§ç³»ç»Ÿè®¾è®¡ï¼Œæ–°ç³»ç»Ÿä¸éœ€è¦ | æš‚ä¸ä½¿ç”¨ |
| CropManager | ä½œç‰©ç³»ç»Ÿåç»­å†è®¾è®¡ | æš‚ä¸ä½¿ç”¨ |

### 4.3 éœ€è¦ä¿®æ”¹çš„ä»£ç 

1. **GameInputManager.TryTillSoil()**ï¼šç›´æ¥è°ƒç”¨ FarmTileManagerï¼Œä¸ç»è¿‡ FarmingManagerNew
2. **GameInputManager.TryWaterTile()**ï¼šç›´æ¥è°ƒç”¨ FarmTileManager
3. **LayerTilemaps.WorldToCell()**ï¼šä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆ farmlandCenterTilemap
4. **LayerTilemaps.IsValid()**ï¼šæ”¯æŒæ–°ç‰ˆé…ç½®

### 4.4 ç®€åŒ–åçš„è°ƒç”¨é“¾

```
GameInputManager.TryTillSoil()
  â†“ ç›´æ¥è°ƒç”¨
FarmTileManager.CreateTile()
  â†“ é€šçŸ¥
FarmlandBorderManager.OnCenterBlockPlaced()
  â†“ æ›´æ–°
Tilemap.SetTile() (Center + Border)
```

---

## äº”ã€åç»­è§„åˆ’

### 5.1 å½“å‰é˜¶æ®µï¼ˆè€•åœ°ç³»ç»Ÿ MVPï¼‰

- [x] é”„åœ°ç”Ÿæˆä¸­å¿ƒå—
- [x] è¾¹ç•Œè‡ªåŠ¨è®¡ç®—å’Œæ”¾ç½®
- [ ] æµ‡æ°´çŠ¶æ€æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸éœ€è¦è§†è§‰æ•ˆæœï¼‰
- [ ] ä¿®æ”¹ GameInputManager ç›´æ¥è°ƒç”¨ FarmTileManager

### 5.2 åç»­é˜¶æ®µï¼ˆä½œç‰©ç³»ç»Ÿï¼‰

- [ ] è®¾è®¡ CropControllerï¼ˆå‚è€ƒ TreeControllerï¼‰
- [ ] æ¯ä¸ªä½œç‰©ç‹¬ç«‹ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- [ ] å¯é€‰ï¼šCropRegistry ç”¨äºå…¨å±€æŸ¥è¯¢
- [ ] ç§æ¤ã€ç”Ÿé•¿ã€æ”¶è·é€»è¾‘

### 5.3 åç»­é˜¶æ®µï¼ˆè§†è§‰æ•ˆæœï¼‰

- [ ] é”„åœ°éŸ³æ•ˆå’Œç²’å­
- [ ] æµ‡æ°´éŸ³æ•ˆå’Œç²’å­
- [ ] æ”¶è·éŸ³æ•ˆå’Œç²’å­
- [ ] å¯ä»¥åœ¨ FarmTileManager æˆ–å•ç‹¬çš„ FarmEffectsManager ä¸­å®ç°

---

## å…­ã€æ•™è®­ä¸åæ€

### 6.1 AI çš„åæ€

1. **æ²¡æœ‰å……åˆ†ç†è§£æ–°æ—§ç³»ç»Ÿçš„å·®å¼‚**ï¼šåœ¨è®¾è®¡æ—¶æ²¡æœ‰æ„è¯†åˆ° FarmVisualManager æ˜¯ä¸ºæ—§ç³»ç»Ÿè®¾è®¡çš„
2. **è¿‡åº¦è®¾è®¡**ï¼šåˆ›å»ºäº†å¤ªå¤šå•ä¾‹ç®¡ç†å™¨ï¼Œå¢åŠ äº†é…ç½®å¤æ‚åº¦
3. **æ²¡æœ‰åŠæ—¶æ¸…ç†æ—§ä»£ç **ï¼šLayerTilemaps ä¸­ä¿ç•™äº†æ–°æ—§ä¸¤å¥—å­—æ®µï¼Œå®¹æ˜“æ··æ·†
4. **æ²¡æœ‰éµå¾ªé¡¹ç›®é£æ ¼**ï¼šCropManager çš„è®¾è®¡ä¸ TreeController/StoneController ä¸ä¸€è‡´

### 6.2 æ”¹è¿›æªæ–½

1. **å…ˆç†è§£ç°æœ‰ç³»ç»Ÿ**ï¼šåœ¨è®¾è®¡æ–°åŠŸèƒ½å‰ï¼Œå…ˆäº†è§£é¡¹ç›®ä¸­ç±»ä¼¼åŠŸèƒ½çš„å®ç°æ–¹å¼
2. **ä¿æŒç®€å•**ï¼šä¼˜å…ˆé€‰æ‹©ç®€å•çš„è®¾è®¡ï¼Œé¿å…è¿‡åº¦æŠ½è±¡
3. **åŠæ—¶æ¸…ç†**ï¼šéœ€æ±‚å˜æ›´åï¼ŒåŠæ—¶æ¸…ç†ä¸å†éœ€è¦çš„ä»£ç 
4. **ä¿æŒä¸€è‡´**ï¼šæ–°åŠŸèƒ½çš„è®¾è®¡åº”è¯¥ä¸é¡¹ç›®ç°æœ‰é£æ ¼ä¿æŒä¸€è‡´

---

## ä¸ƒã€ç”¨æˆ·ç¡®è®¤äº‹é¡¹

è¯·ç”¨æˆ·ç¡®è®¤ä»¥ä¸‹å†³ç­–ï¼š

1. **æ˜¯å¦åŒæ„ç®€åŒ–æ–¹æ¡ˆ**ï¼šåˆ é™¤/æš‚ä¸ä½¿ç”¨ FarmingManagerNewã€FarmVisualManagerã€CropManager
2. **æ˜¯å¦åŒæ„ä¿®æ”¹ GameInputManager**ï¼šç›´æ¥è°ƒç”¨ FarmTileManager
3. **ä½œç‰©ç³»ç»Ÿçš„è®¾è®¡æ–¹å‘**ï¼šåç»­å‚è€ƒ TreeController æ¨¡å¼ï¼Œæ¯ä¸ªä½œç‰©ç‹¬ç«‹ç®¡ç†

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2026-01-26
