# 需求文档

## 简介

本文档定义了工具-资源交互系统的需求，以砍树功能为核心，建立一套可扩展的工具命中检测和资源交互框架。该系统支持多种工具类型（斧头、镐子、锄头等）与多种资源类型（树木、矿石、农田等）的交互。

## 术语表

- **资源节点（ResourceNode）**: 可被工具交互的世界物体，如树木、矿石
- **命中发射器（ToolHitEmitter）**: 负责检测工具命中资源的组件
- **命中上下文（ToolHitContext）**: 包含命中时所有相关信息的数据结构
- **命中窗口（HitWindow）**: 动画中触发命中检测的帧范围（第3-4帧）
- **精灵边界（SpriteBounds）**: SpriteRenderer 的轴对齐包围盒
- **资源注册表（ResourceNodeRegistry）**: 管理所有可交互资源节点的全局注册表
- **材料等级（MaterialTier）**: 工具的材质等级，0=木，1=石，2=生铁，3=黄铜，4=钢，5=金

## 需求列表

### 需求 1: 命中检测系统

**用户故事:** 作为玩家，我希望用工具击中资源，以便收集材料并与世界互动。

#### 验收标准

1. 当工具动画到达第3-4帧时，系统应在玩家前方60度扇形范围内执行命中检测
2. 执行命中检测时，系统应使用 SpriteRenderer.bounds 相交检测，而非物理碰撞体
3. 当资源节点在命中扇形范围内时，系统应调用该资源节点的 OnHit 方法并传入命中上下文
4. 当玩家不在攻击动画状态时，系统不应执行任何命中检测
5. 当多个资源在命中扇形范围内时，系统应在同一帧内命中所有资源

### 需求 2: 资源节点注册系统

**用户故事:** 作为开发者，我希望有一个集中的资源节点注册表，以便命中检测能高效地找到附近的资源。

#### 验收标准

1. 当 TreeController 启动时，系统应将其注册到 ResourceNodeRegistry
2. 当 TreeController 被销毁时，系统应将其从 ResourceNodeRegistry 注销
3. 执行命中检测时，系统应从注册表查询范围内的节点
4. 查询注册表时，系统应支持基于距离的过滤以优化性能

### 需求 3: 工具-资源交互矩阵

**用户故事:** 作为玩家，我希望不同工具对不同资源有不同效果，以便游戏有有意义的工具选择。

#### 验收标准

1. 当斧头命中树木时，系统应造成伤害、播放抖动效果、生成树叶粒子、消耗精力
2. 当非斧头工具命中树木时，系统应只播放抖动效果，不造成伤害也不消耗精力
3. 当镐子命中矿石时，系统应造成伤害、播放抖动效果、生成碎石粒子、消耗精力
4. 当非镐子工具命中矿石时，系统应只播放抖动效果，不造成伤害也不消耗精力
5. 当正确的工具命中资源时，系统应根据工具的 energyCost 字段消耗精力

### 需求 4: 树木血量系统

**用户故事:** 作为玩家，我希望树木有血量，砍伐时会减少，以便我能看到进度。

#### 验收标准

1. 当树木处于小树阶段时，系统应将血量初始化为 chopCountSmall（默认3）
2. 当树木处于大树阶段时，系统应将血量初始化为 chopCountLarge（默认7）
3. 当斧头命中树木时，系统应根据工具的伤害值减少血量
4. 当树木血量归零时，系统应将树木转换为树桩状态
5. 当树木变成树桩时，系统应根据 dropTable 生成掉落物品

### 需求 5: 树木受击表现

**用户故事:** 作为玩家，我希望砍树时有视觉和音效反馈，以便交互感觉令人满意。

#### 验收标准

1. 当树木被命中时，系统应播放持续0.15秒的水平抖动动画
2. 当树木被斧头命中时，系统应从树木精灵顶部生成树叶粒子
3. 当树叶粒子生成时，系统应让它们向下飘落，到达树根高度时淡出消失
4. 当树木被命中时，系统应播放砍伐音效
5. 当树木转换为树桩时，系统应播放倒下音效

### 需求 6: 树叶飘落效果

**用户故事:** 作为玩家，我希望砍树时看到树叶飘落，以便世界感觉生动且有反应。

#### 验收标准

1. 当生成树叶粒子时，系统应将它们定位在树木精灵边界的顶部区域
2. 当树叶粒子飘落时，系统应应用随机的水平漂移和旋转
3. 当树叶粒子到达树根Y坐标时，系统应在0.3秒内将其淡出
4. 当生成树叶粒子时，系统应从配置的树叶精灵数组中随机选择
5. 当生成树叶粒子时，系统应每次命中生成3-5片树叶

### 需求 7: 精力消耗系统

**用户故事:** 作为玩家，我希望使用工具消耗精力，以便资源采集有成本。

#### 验收标准

1. 当斧头成功命中树木时，系统应消耗等于工具 energyCost 的精力
2. 当镐子成功命中矿石时，系统应消耗等于工具 energyCost 的精力
3. 当工具命中不匹配的资源时，系统不应消耗任何精力
4. 当玩家精力不足时，系统应阻止工具动作并显示警告

### 需求 8: 可扩展性

**用户故事:** 作为开发者，我希望系统易于扩展，以便将来可以添加新的工具类型和资源类型。

#### 验收标准

1. 当添加新资源类型时，开发者只需实现 IResourceNode 接口
2. 当添加新工具类型时，开发者只需在工具-资源交互配置中添加条目
3. 当系统处理命中时，系统应使用 ToolType 枚举来确定行为
4. 当系统处理命中时，系统应使用资源的标签或类型来确定有效交互

### 需求 9: 树木倒下动画

**用户故事:** 作为玩家，我希望砍倒树木时看到树木倒下的动画，以便获得满足感。

#### 验收标准

1. 当树木血量归零时，系统应立即在原位置生成树桩
2. 当树木倒下时，系统应创建临时的倒下 Sprite 播放动画
3. 当倒下动画播放时，系统不应影响物理碰撞（不推动玩家或其他物体）
4. 当倒下动画播放时，系统应使用 Collider 中心作为旋转轴心
5. 当倒下动画播放时，系统应使用先慢后快的加速曲线模拟重力

#### 倒下方向判定规则

| 玩家朝向 | FlipX | 倒下方向 |
|---------|-------|---------|
| Down (0) | false (0) | 向右倒 |
| Down (0) | true (1) | 向左倒 |
| Side (1) | false (0) | 向上倒 |
| Side (1) | true (1) | 向上倒 |
| Up (2) | false (0) | 向左倒 |
| Up (2) | true (1) | 向右倒 |

### 需求 10: 命中范围限制

**用户故事:** 作为玩家，我希望只有我面前的树木才会被砍到，而不是途径的树木。

#### 验收标准

1. WHEN 执行命中检测 THEN 系统 SHALL 只检测玩家朝向前方指定角度（60°）内的资源
2. WHEN 执行命中检测 THEN 系统 SHALL 只检测指定距离（1.5米）内的资源
3. WHEN 资源不在命中扇形范围内 THEN 系统 SHALL 不命中该资源
4. WHEN 玩家背对资源 THEN 系统 SHALL 不命中该资源

### 需求 13: 精确命中检测（Bug修复）

**用户故事:** 作为玩家，我希望命中检测更加精确，只有当树木的碰撞体实际进入攻击扇形时才被判定命中。

#### 验收标准

1. WHEN 执行命中检测 THEN 系统 SHALL 使用树木 Collider 的 bounds 而非 Sprite 的 bounds 进行检测
2. WHEN 树木 Collider 的任意部分未进入扇形区域 THEN 系统 SHALL 不判定为命中
3. WHEN 计算最近点 THEN 系统 SHALL 使用 Collider.bounds.ClosestPoint 而非 Sprite.bounds.ClosestPoint
4. WHEN 树木只有 Sprite 无 Collider THEN 系统 SHALL 回退使用 Sprite bounds 检测

### 需求 14: 玩家朝向与相对位置验证

**用户故事:** 作为玩家，我希望只有当我的位置和朝向符合逻辑时才能砍到树木，比如朝下砍树时我必须站在树的上方。

#### 验收标准

1. WHEN 玩家朝下（Direction=0）砍树 THEN 系统 SHALL 验证玩家Y坐标大于树木 Collider 顶部Y坐标
2. WHEN 玩家朝上（Direction=1）砍树 THEN 系统 SHALL 验证玩家Y坐标小于树木 Collider 底部Y坐标
3. WHEN 玩家朝右（Direction=2, FlipX=false）砍树 THEN 系统 SHALL 验证玩家X坐标小于树木 Collider 左侧X坐标
4. WHEN 玩家朝左（Direction=2, FlipX=true）砍树 THEN 系统 SHALL 验证玩家X坐标大于树木 Collider 右侧X坐标
5. WHEN 玩家位置与朝向不符合逻辑 THEN 系统 SHALL 不判定为命中
6. WHEN 验证位置关系 THEN 系统 SHALL 允许一定的容差值（0.1单位）以避免边界情况

#### 位置验证规则表

| 玩家朝向 | Direction | FlipX | 位置要求 | 说明 |
|---------|-----------|-------|---------|------|
| 朝下 | 0 | - | playerY > collider.max.y - tolerance | 玩家在树上方 |
| 朝上 | 1 | - | playerY < collider.min.y + tolerance | 玩家在树下方 |
| 朝右 | 2 | false | playerX < collider.min.x + tolerance | 玩家在树左侧 |
| 朝左 | 2 | true | playerX > collider.max.x - tolerance | 玩家在树右侧 |

### 需求 15: 单目标命中限制

**用户故事:** 作为玩家，我希望每次挥砍只能击中一棵树，而不是同时击中多棵树。

#### 验收标准

1. WHEN 命中范围内有多棵树木 THEN 系统 SHALL 只命中玩家 Collider 中心与树木 Collider 中心距离最近的一棵
2. WHEN 计算最近距离 THEN 系统 SHALL 使用玩家 Collider 中心到树木 Collider 中心的距离
3. WHEN 多棵树木距离相同 THEN 系统 SHALL 命中第一个检测到的树木
4. WHEN 选择命中目标时 THEN 系统 SHALL 先验证 Collider 在扇形内且相对位置正确，再比较距离

### 需求 11: 砍树经验获取

**用户故事:** 作为玩家，我希望砍伐树木获得砍树技能经验，以便提升砍树技能等级。

#### 验收标准

1. 当玩家砍倒阶段0树苗时，系统不应提供任何 Woodcutting 经验
2. 当玩家砍倒阶段1幼苗时，系统不应提供任何 Woodcutting 经验
3. 当玩家砍倒阶段2小树时，系统应提供2点 Woodcutting 经验
4. 当玩家砍倒阶段3中树时，系统应提供4点 Woodcutting 经验
5. 当玩家砍倒阶段4大树时，系统应提供6点 Woodcutting 经验
6. 当玩家砍倒阶段5巨树时，系统应提供20点 Woodcutting 经验
7. 当树木被砍倒（血量归零）时，系统应调用 SkillLevelService.AddExperience(SkillType.Woodcutting, xpAmount)

#### 经验配置表

| 树木阶段 | 经验值 | 说明 |
|----------|--------|------|
| 阶段 0 | 0 | 树苗，不提供经验 |
| 阶段 1 | 0 | 幼苗，不提供经验 |
| 阶段 2 | 2 | 小树 |
| 阶段 3 | 4 | 中树 |
| 阶段 4 | 6 | 大树 |
| 阶段 5 | 20 | 巨树，高经验奖励 |



### 需求 12: 斧头材料等级限制

**用户故事:** 作为玩家，我希望不同材质的斧头能砍伐不同阶段的树木，以便游戏有进度感。

#### 验收标准

1. WHEN 木斧或石斧命中阶段 0-3 树木 THEN 系统 SHALL 正常造成伤害
2. WHEN 木斧或石斧命中阶段 4 树木 THEN 系统 SHALL 不造成伤害但消耗精力和耐久
3. WHEN 木斧或石斧命中阶段 5 树木 THEN 系统 SHALL 不造成伤害但消耗精力和耐久
4. WHEN 生铁斧命中阶段 0-4 树木 THEN 系统 SHALL 正常造成伤害
5. WHEN 生铁斧命中阶段 5 树木 THEN 系统 SHALL 不造成伤害但消耗精力和耐久
6. WHEN 黄铜斧或更高等级斧头命中任何阶段树木 THEN 系统 SHALL 正常造成伤害
7. WHEN 斧头等级不足以砍伐树木 THEN 系统 SHALL 播放金属碰撞音效并显示"斧头等级不足"提示

#### 斧头等级限制表

| 斧头材质 | 材料等级 | 可砍伐阶段 | 说明 |
|---------|---------|-----------|------|
| 木斧 | 0 | 阶段 0-3 | 无法砍伐阶段 4-5 |
| 石斧 | 1 | 阶段 0-3 | 无法砍伐阶段 4-5 |
| 生铁斧 | 2 | 阶段 0-4 | 无法砍伐阶段 5 |
| 黄铜斧 | 3 | 阶段 0-5 | 可砍伐所有阶段 |
| 钢斧 | 4 | 阶段 0-5 | 可砍伐所有阶段 |
| 金斧 | 5 | 阶段 0-5 | 可砍伐所有阶段 |

#### 树木阶段所需斧头等级

| 树木阶段 | 所需最低斧头等级 | 说明 |
|---------|-----------------|------|
| 阶段 0-3 | 木斧 (0) | 任何斧头都能砍 |
| 阶段 4 | 生铁斧 (2) | 需要生铁或更高 |
| 阶段 5 | 黄铜斧 (3) | 需要黄铜或更高 |

