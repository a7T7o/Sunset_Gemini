# 导航系统重构 - 需求文档

## 简介

本文档定义了导航系统重构的需求，旨在解决现有系统在 Unity 6 环境下的性能问题、架构缺陷和功能缺失。重构将遵循 Unity 6 的最佳实践，实现零 GC 分配、连续物理检测和多层级支持。

## 术语表

- **NavGrid2D**: 导航网格系统，负责维护可行走区域的网格数据
- **PlayerAutoNavigator**: 玩家自动导航器，负责路径跟随和障碍物规避
- **A* 算法**: 启发式寻路算法，用于计算最优路径
- **GC (Garbage Collection)**: 垃圾回收，Unity 的内存管理机制
- **Tunneling**: 穿墙漏检，离散检测中物体穿过薄墙而未被检测到的现象
- **CircleCast**: 圆形投射，Unity 物理引擎的连续碰撞检测方法
- **Elevation/Layer**: 层级/高度，用于支持 2.5D 游戏的立体结构
- **BFS (Breadth-First Search)**: 广度优先搜索，一种图遍历算法
- **NonAlloc**: Unity API 的无分配版本，避免 GC 分配

---

## 需求 1：零 GC 内存分配

**用户故事**: 作为开发者，我希望导航系统在运行时不产生 GC 分配，以避免游戏卡顿和性能下降。

### 验收标准

1. WHEN 导航网格重建时 THEN 系统 SHALL 使用预分配的缓存数组进行物理查询，避免堆内存分配
2. WHEN 进行障碍物检测时 THEN 系统 SHALL 使用 `Physics2D.OverlapCircleNonAlloc` 替代 `Physics2D.OverlapCircleAll`
3. WHEN 系统运行时 THEN 所有物理查询 SHALL 复用同一个预分配的 `Collider2D[]` 数组
4. WHEN 网格重建完成后 THEN Unity Profiler SHALL 显示零 GC 分配（除首次初始化外）
5. WHEN 多个单位同时请求寻路时 THEN 系统 SHALL 保持零 GC 分配

---

## 需求 2：连续物理检测

**用户故事**: 作为玩家，我希望自动导航时不会穿过薄墙或栅栏，确保路径的准确性和可靠性。

### 验收标准

1. WHEN 检测视线可达性时 THEN 系统 SHALL 使用 `Physics2D.CircleCast` 进行连续碰撞检测
2. WHEN 路径中存在薄墙（厚度 < 0.3 单位）时 THEN 系统 SHALL 正确检测到障碍物并标记路径不可达
3. WHEN 进行视线检测时 THEN 系统 SHALL 只调用一次物理查询，而非多次循环检测
4. WHEN 检测到障碍物时 THEN 系统 SHALL 返回碰撞点的准确位置信息
5. WHEN 玩家移动速度较快时 THEN 连续检测 SHALL 确保不会出现穿墙现象

---

## 需求 3：输入向量分离

**用户故事**: 作为开发者，我希望移动向量和朝向向量分离，确保导航器不会篡改物理移动路径。

### 验收标准

1. WHEN 导航器计算朝向时 THEN 系统 SHALL 只修改角色的视觉朝向，不修改实际移动向量
2. WHEN 玩家沿斜向路径移动时 THEN 物理移动向量 SHALL 保持 A* 算法计算的原始方向
3. WHEN 导航器提供朝向建议时 THEN 系统 SHALL 通过独立的 `FacingInput` 接口传递，不影响 `MovementInput`
4. WHEN 角色需要转向时 THEN 视觉朝向 SHALL 平滑过渡，但移动路径 SHALL 保持不变
5. WHEN 路径需要绕过障碍物时 THEN 移动向量 SHALL 严格遵循 A* 规划的路径点

---

## 需求 4：智能起点查找优化

**用户故事**: 作为开发者，我希望智能起点查找算法简单高效，避免不必要的复杂度和性能开销。

### 验收标准

1. WHEN 起点不可行走时 THEN 系统 SHALL 使用 BFS 算法查找最近的可行走点
2. WHEN 进行 BFS 搜索时 THEN 系统 SHALL 按距离由近及远扩散，找到的第一个可行走点即为最优解
3. WHEN 搜索半径超过限制时 THEN 系统 SHALL 终止搜索并返回失败
4. WHEN 找到可行走点时 THEN 系统 SHALL 立即返回，不继续搜索其他点
5. WHEN 多个单位同时请求起点查找时 THEN 系统 SHALL 在 1ms 内完成单次查找

---

## 需求 5：架构解耦与接口设计

**用户故事**: 作为开发者，我希望导航系统职责清晰，与其他系统解耦，便于维护和扩展。

### 验收标准

1. WHEN 玩家点击可交互物体时 THEN 系统 SHALL 通过 `IInteractable` 接口调用交互逻辑，而非在输入管理器中硬编码
2. WHEN 输入管理器检测到点击事件时 THEN 系统 SHALL 只负责分发事件，不包含具体的业务逻辑
3. WHEN 添加新的可交互物体类型时 THEN 系统 SHALL 只需实现 `IInteractable` 接口，无需修改输入管理器
4. WHEN 导航器需要移动角色时 THEN 系统 SHALL 通过 `IMovementController` 接口传递移动指令
5. WHEN 系统需要检测 UI 遮挡时 THEN 系统 SHALL 使用统一的 UI 检测服务，而非在多处重复实现

---

## 需求 6：多层级支持

**用户故事**: 作为玩家，我希望在多层级场景（如桥上桥下）中正确寻路，不会出现穿墙飞天的现象。

### 验收标准

1. WHEN 场景包含多个层级（LAYER 1/2/3）时 THEN 导航系统 SHALL 为每个层级维护独立的导航网格
2. WHEN 玩家在某一层级时 THEN 寻路 SHALL 只在当前层级的网格中进行
3. WHEN 玩家需要跨层级移动时 THEN 系统 SHALL 通过特定的连接点（楼梯、梯子）进行层级切换
4. WHEN 计算路径距离时 THEN 系统 SHALL 考虑层级差异，不同层级的点视为不可直达
5. WHEN 玩家在桥下点击桥上的目标时 THEN 系统 SHALL 规划经过楼梯的路径，而非直线穿过

---

## 需求 7：性能监控与调试

**用户故事**: 作为开发者，我希望能够实时监控导航系统的性能指标，快速定位性能瓶颈。

### 验收标准

1. WHEN 开启性能监控时 THEN 系统 SHALL 记录每次网格重建的耗时
2. WHEN 进行寻路操作时 THEN 系统 SHALL 记录 A* 算法的执行时间和搜索节点数
3. WHEN 系统运行时 THEN 性能监控 SHALL 显示 GC 分配量、物理查询次数和帧率影响
4. WHEN 性能指标超过阈值时 THEN 系统 SHALL 在控制台输出警告信息
5. WHEN 开启调试模式时 THEN 系统 SHALL 在 Scene 视图中可视化导航网格、路径和障碍物

---

## 需求 8：网格重建优化

**用户故事**: 作为开发者，我希望网格重建尽可能快速，避免游戏加载或场景切换时的长时间卡顿。

### 验收标准

1. WHEN 场景加载时 THEN 网格重建 SHALL 在 200ms 内完成（100x80 网格规模）
2. WHEN 动态障碍物变化时 THEN 系统 SHALL 只重建受影响的局部区域，而非整个网格
3. WHEN 多个障碍物同时变化时 THEN 系统 SHALL 合并重建请求，避免重复计算
4. WHEN 网格重建时 THEN 系统 SHALL 使用多线程或协程分帧处理，避免主线程阻塞
5. WHEN 重建完成后 THEN 系统 SHALL 触发 `OnGridRebuilt` 事件，通知依赖系统

---

## 需求 9：路径平滑与优化

**用户故事**: 作为玩家，我希望自动导航的路径平滑自然，不会出现频繁的急转弯或抖动。

### 验收标准

1. WHEN A* 算法计算出路径后 THEN 系统 SHALL 对路径进行平滑处理，移除不必要的转折点
2. WHEN 路径包含连续的直线段时 THEN 系统 SHALL 合并为单一路径点
3. WHEN 角色接近路径点时 THEN 系统 SHALL 提前切换到下一个路径点，避免急转弯
4. WHEN 路径中存在可优化的捷径时 THEN 系统 SHALL 通过视线检测跳过中间点
5. WHEN 角色移动时 THEN 路径跟随 SHALL 使用预测算法，提前调整方向

---

## 需求 10：障碍物动态更新

**用户故事**: 作为开发者，我希望当场景中的障碍物发生变化时，导航网格能够自动更新。

### 验收标准

1. WHEN 树木生长或被砍伐时 THEN 导航系统 SHALL 自动更新对应区域的网格
2. WHEN 建筑物被放置或移除时 THEN 导航系统 SHALL 重新计算受影响的网格区域
3. WHEN 障碍物变化时 THEN 系统 SHALL 延迟 0.2 秒合并多个更新请求
4. WHEN 网格更新时 THEN 正在进行的寻路 SHALL 重新验证路径有效性
5. WHEN 路径被新障碍物阻挡时 THEN 系统 SHALL 自动重新规划路径

---

## 需求 11：边界检测与世界范围

**用户故事**: 作为开发者，我希望导航网格能够自动检测世界边界，覆盖整个可行走区域。

### 验收标准

1. WHEN 系统初始化时 THEN 导航网格 SHALL 基于 Tilemap 自动计算世界边界
2. WHEN 场景包含多个 Tilemap 时 THEN 系统 SHALL 计算所有 Tilemap 的联合边界
3. WHEN 检测边界时 THEN 系统 SHALL 只包含 LAYER 1/2/3 下的对象
4. WHEN 边界计算完成后 THEN 系统 SHALL 自动设置网格的起始位置和尺寸
5. WHEN 世界边界发生变化时 THEN 系统 SHALL 支持手动触发边界重新计算

---

## 需求 12：错误处理与容错

**用户故事**: 作为开发者，我希望导航系统在异常情况下能够优雅降级，不会导致游戏崩溃。

### 验收标准

1. WHEN 寻路起点或终点超出网格范围时 THEN 系统 SHALL 返回失败并输出警告信息
2. WHEN A* 算法无法找到路径时 THEN 系统 SHALL 返回空路径并通知调用者
3. WHEN 物理查询返回异常结果时 THEN 系统 SHALL 使用默认值并记录错误日志
4. WHEN 网格数据损坏时 THEN 系统 SHALL 自动触发重建并恢复正常状态
5. WHEN 系统资源不足时 THEN 导航功能 SHALL 降级为简单的直线移动

---

## 相关文档

- `memory.md` - 开发记忆和锐评反思
- `design.md` - 详细设计文档（待创建）
- `tasks.md` - 实施任务列表（待创建）

---

**文档版本**: v1.0  
**创建日期**: 2025-01-08  
**状态**: 待审核
