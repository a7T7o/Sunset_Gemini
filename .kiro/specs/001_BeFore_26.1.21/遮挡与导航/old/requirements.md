# 遮挡与导航系统优化需求文档

**版本**: v4.0  
**日期**: 2025-12-22  
**状态**: 进行中

---

## 简介

本文档定义了遮挡透明系统和导航系统的全面优化需求。核心目标：
1. **导航系统**：解决卡顿鬼畜、斜向移动抖动、树木根部附近导航失败的问题
2. **遮挡系统**：修复树林遮挡判定逻辑，确保内侧树触发时整林透明（保底机制）
3. **砍伐高亮**：被砍伐的树木透明度加深，场景内同时只有一棵树处于此状态

## 术语表

- **Sprite Bounds**: SpriteRenderer 的轴对齐矩形包围盒
- **树林边界**: 树林最外圈树木的 Collider 连线形成的区域（凸包）
- **树林内部**: 玩家完全进入树林边界内的状态
- **树林边缘**: 玩家被最外圈树木遮挡但尚未完全进入树林的状态
- **内侧树**: 不在凸包边界上的树木，位于树林内部
- **边界树**: 位于凸包边界上的树木，是树林最外圈
- **砍伐高亮**: 当前正在被砍伐的树木透明度加深的视觉效果
- **动态障碍物**: 运行时碰撞体状态会变化的物体（如成长后的树木）

---

## 需求列表

### 需求 1：导航系统终极优化

**用户故事**：作为玩家，我希望右键点击导航时能够流畅移动，不会出现卡顿、鬼畜、原地打转的情况，特别是在树木根部附近和斜向移动时。

#### 问题分析

当前导航系统存在以下问题：
1. **斜向移动鬼畜**：玩家斜向移动时频繁转向抖动
2. **树木根部导航失败**：在成长后的树木（从无碰撞体变为有碰撞体）附近导航经常失败
3. **起点/终点在障碍物附近**：当起点或终点靠近树木根部时，导航容易卡顿
4. **动态障碍物同步不及时**：树木成长后碰撞体启用，但导航网格未及时更新

#### 验收标准

1. WHEN 玩家斜向移动时 THEN 系统 SHALL 保持平滑的移动方向，不出现频繁转向抖动
2. WHEN 玩家在树木根部附近点击导航时 THEN 系统 SHALL 正确找到可走的起始点并规划路径
3. WHEN 导航目标点在树木根部附近时 THEN 系统 SHALL 找到最近的可达点并导航到该位置
4. WHEN 树木从树苗成长为小树/大树时 THEN 系统 SHALL 在 0.5 秒内更新导航网格
5. WHEN 玩家被卡在障碍物边缘时 THEN 系统 SHALL 在 0.5 秒内自动找到脱困方向并移动
6. WHEN 连续 3 次位置几乎不变时 THEN 系统 SHALL 尝试沿障碍物法线方向脱困
7. WHEN 脱困尝试 3 次后仍失败时 THEN 系统 SHALL 取消导航并输出详细调试信息
8. WHEN 导航失败时 THEN 系统 SHALL 输出详细的调试信息（起点、终点、周边障碍物、路径状态）
9. WHEN 玩家频繁点击同一位置时 THEN 系统 SHALL 忽略重复请求（去抖阈值 0.3 米）

---

### 需求 2：砍伐树木高亮显示

**用户故事**：作为玩家，我希望当前正在砍伐的树木能够有明显的视觉反馈，让我清楚知道正在砍哪棵树。

#### 验收标准

1. WHEN 玩家开始砍伐一棵树时 THEN 系统 SHALL 将该树的透明度增加 0.5（变得更深色更明显）
2. WHEN 玩家砍伐另一棵树时 THEN 系统 SHALL 恢复前一棵树的透明度并高亮新的树
3. WHEN 场景中有树木处于砍伐高亮状态时 THEN 系统 SHALL 确保同时只有一棵树处于此状态
4. WHEN 玩家停止砍伐超过 3 秒时 THEN 系统 SHALL 自动恢复被砍伐树木的正常透明度
5. WHEN 树木被砍倒时 THEN 系统 SHALL 立即清除砍伐高亮状态

#### 技术说明

- 砍伐高亮透明度偏移：+0.5（在遮挡透明度基础上增加，使树木更不透明）
- 高亮超时时间：3 秒
- 状态管理：由 OcclusionManager 或专门的 ChoppingHighlightManager 统一管理

---

### 需求 3：智能树林遮挡（修复版）

**用户故事**：作为玩家，我希望当我站在树林边缘被单棵树遮挡时，只有遮挡我的那棵树变透明；只有当我真正进入树林内部时，整片树林才变透明。同时，当内侧树触发遮挡时，必须触发整林透明作为保底机制。

#### 问题分析

当前系统的问题（根据用户反馈）：
1. **内侧树触发时未整林透明**：玩家被内侧树遮挡时，只有该树透明，但周围的树没有透明
2. **逻辑冲突**：当隐藏内侧树后，上方的树会自动隐藏；但放回内侧树后，外侧树又不能正常判断
3. **边界判定不准确**：凸包边界计算可能不够精确，导致内侧/边界树判定错误

#### 核心修复逻辑

**保底机制（最高优先级）**：
1. 如果触发遮挡的树是**内侧树**（不是边界树），直接整林透明
2. 如果有**多棵树同时遮挡**玩家，直接整林透明
3. 只有当**单棵边界树**遮挡玩家，且玩家在边界外时，才只透明该树

**判定顺序**：
1. 检查触发遮挡的树是否是边界树
2. 如果不是边界树 → 保底机制：整林透明
3. 如果是边界树 → 检查是否有多棵树同时遮挡
4. 如果多棵树遮挡 → 保底机制：整林透明
5. 如果单棵边界树遮挡 → 检查玩家是否在边界内
6. 玩家在边界内 → 整林透明
7. 玩家在边界外 → 只透明该树

#### 验收标准

1. WHEN 玩家被内侧树（非边界树）遮挡时 THEN 系统 SHALL 触发整片树林透明（保底机制）
2. WHEN 玩家同时被多棵树遮挡时 THEN 系统 SHALL 触发整片树林透明（保底机制）
3. WHEN 玩家被树林最外圈上方的单棵边界树遮挡且玩家在边界外时 THEN 系统 SHALL 只透明该树
4. WHEN 玩家被树林最外圈左侧的单棵边界树遮挡且玩家在边界外时 THEN 系统 SHALL 只透明该树
5. WHEN 玩家被树林最外圈右侧的单棵边界树遮挡且玩家在边界外时 THEN 系统 SHALL 只透明该树
6. WHEN 玩家位置完全在树林边界内部时 THEN 系统 SHALL 透明整片树林
7. WHEN 玩家从树林内部移动到边缘时 THEN 系统 SHALL 平滑过渡透明效果
8. WHEN 边界树判定失败（凸包计算异常）时 THEN 系统 SHALL 回退到整林透明模式

---

### 需求 4：精确遮挡检测（已实现）

**用户故事**：作为玩家，我希望只有当我真正站在树木/建筑的实际可见区域下方时，才触发遮挡透明效果。

#### 验收标准

1. WHEN 玩家站在 Sprite 的透明区域下方 THEN 系统 SHALL 不触发遮挡透明
2. WHEN 玩家站在 Sprite 的实际可见区域下方 THEN 系统 SHALL 触发遮挡透明

**状态**：✅ 已实现（像素采样方案）

---

### 需求 5：遮挡占比计算（已实现）

**用户故事**：作为玩家，我希望只有当我被遮挡很多（占比超过阈值）时才触发透明。

#### 验收标准

1. WHEN 玩家与遮挡物重叠面积占比 < 阈值（0.4）THEN 系统 SHALL 不触发遮挡透明
2. WHEN 玩家与遮挡物重叠面积占比 >= 阈值 THEN 系统 SHALL 触发遮挡透明
3. WHEN 玩家在树林中 THEN 系统 SHALL 无视占比阈值，直接触发透明

**状态**：✅ 已实现

---

### 需求 6：正确的攻击起点（已实现）

**用户故事**：作为玩家，我希望命中检测的起点是我的实际攻击位置。

#### 验收标准

1. WHEN 执行命中检测时 THEN 系统 SHALL 使用玩家 Collider 的中心（bounds.center）作为起点
2. WHEN 玩家没有 Collider 时 THEN 系统 SHALL 回退到 Transform 位置

**状态**：✅ 已实现

---

### 需求 7：智能防卡顿（已实现，待优化）

**用户故事**：作为玩家，我希望导航系统能智能处理卡顿情况。

#### 验收标准

1. WHEN 检测到卡顿 THEN 系统 SHALL 最多重试 3 次
2. WHEN 重试 3 次后仍然卡顿 THEN 系统 SHALL 取消导航并通知玩家
3. WHEN 重新规划路径成功 THEN 系统 SHALL 重置重试计数器
4. WHEN 正常移动时 THEN 系统 SHALL 重置重试计数器

**状态**：⚠️ 已实现基础版本，需要优化脱困逻辑

---

### 需求 8：动态障碍物导航同步

**用户故事**：作为玩家，我希望当树木成长（从树苗变为小树/大树）后，导航系统能够正确识别新的障碍物，不会导航到障碍物内部。

#### 问题分析

当前系统的问题：
1. **树木成长后导航失败**：树苗阶段无碰撞体，成长后启用碰撞体，但导航网格未及时更新
2. **起点在障碍物内**：玩家站在刚成长的树木根部附近时，起点可能被判定为不可走
3. **终点在障碍物内**：点击刚成长的树木根部附近时，终点可能在障碍物内

#### 验收标准

1. WHEN TreeController 的碰撞体状态从禁用变为启用时 THEN 系统 SHALL 在 0.3 秒内触发导航网格刷新
2. WHEN 导航起点在障碍物内时 THEN 系统 SHALL 智能查找朝向目标方向的最近可走点
3. WHEN 导航终点在障碍物内时 THEN 系统 SHALL 查找最近的可走点作为替代终点
4. WHEN 导航失败时 THEN 系统 SHALL 输出详细调试信息包括：起点、终点、周边障碍物列表、路径状态
5. WHEN 导航网格刷新时 THEN 系统 SHALL 正确检测所有启用的碰撞体（包括 CompositeCollider2D）

---

### 需求 9：斜向移动平滑优化

**用户故事**：作为玩家，我希望斜向移动时不会出现频繁转向抖动（鬼畜）。

#### 问题分析

当前系统的问题：
1. **方向调整过于敏感**：碰撞检测导致方向频繁微调
2. **缺少方向平滑**：没有对移动方向进行平滑处理
3. **偏转角度限制不足**：允许的偏转角度过大导致抖动

#### 验收标准

1. WHEN 玩家斜向移动时 THEN 系统 SHALL 使用方向平滑算法减少抖动
2. WHEN 碰撞调整方向时 THEN 系统 SHALL 限制单帧最大偏转角度为 30 度
3. WHEN 连续多帧需要调整方向时 THEN 系统 SHALL 使用渐进式调整而非突变
4. WHEN 玩家在开阔区域移动时 THEN 系统 SHALL 不进行任何方向调整

---

## 技术方案概述

### 导航系统优化方案

#### 核心改进

1. **智能起始点查找**：考虑目标方向，优先选择朝向目标的可走点
2. **方向平滑算法**：使用渐进式方向调整，避免突变
3. **动态障碍物同步**：TreeController 碰撞体变化时立即触发网格刷新
4. **详细调试输出**：导航失败时输出完整的诊断信息

#### 斜向移动优化

```
方向平滑算法：
1. 计算期望方向（朝向下一个路径点）
2. 检测前方障碍物，计算排斥力
3. 限制单帧最大偏转角度（30度）
4. 使用 Lerp 平滑过渡到新方向
5. 只在必要时调整方向（开阔区域不调整）
```

#### 动态障碍物同步

```
TreeController 碰撞体变化流程：
1. UpdateColliderState() 检测碰撞体状态变化
2. 如果 hadEnabledCollider != hasEnabledCollider
3. 调用 RequestNavGridRefresh()
4. 延迟 0.2 秒后触发 NavGrid2D.OnRequestGridRefresh
5. NavGrid2D.RebuildGrid() 重建网格
```

### 砍伐高亮方案

1. **状态管理**：OcclusionTransparency 添加 `isBeingChopped` 状态
2. **透明度计算**：`finalAlpha = occludedAlpha + 0.5`（更不透明）
3. **超时恢复**：3 秒无砍伐动作自动恢复
4. **单一高亮**：ChoppingHighlightManager 确保同时只有一棵树高亮

### 树林边缘遮挡方案（修复版）

#### 核心修复逻辑

```
HandleForestOcclusion() 判定流程：
1. 检查触发遮挡的树是否是边界树（IsBoundaryTree）
2. 如果不是边界树 → 保底机制：整林透明
3. 检查是否有多棵树同时遮挡玩家
4. 如果多棵树遮挡 → 保底机制：整林透明
5. 检查玩家是否在凸包边界内（IsPlayerInsideForest）
6. 玩家在边界内 → 整林透明
7. 玩家在边界外 → 只透明该树
```

#### 边界树判定改进

```
IsBoundaryTree() 改进：
1. 计算树木到凸包边界的距离
2. 距离 < 1.5m → 边界树
3. 距离 >= 1.5m → 内侧树
4. 凸包计算失败时 → 默认为边界树（安全回退）
```

---

## 相关文件

| 文件 | 修改内容 |
|------|---------|
| `Assets/YYY_Scripts/Service/Player/PlayerAutoNavigator.cs` | 导航优化、方向平滑、调试输出 |
| `Assets/YYY_Scripts/Service/Navigation/NavGrid2D.cs` | 智能起始点查找、网格刷新优化 |
| `Assets/YYY_Scripts/Service/Rendering/OcclusionManager.cs` | 树林边缘检测修复、保底机制 |
| `Assets/YYY_Scripts/Service/Rendering/OcclusionTransparency.cs` | 砍伐高亮状态 |
| `Assets/YYY_Scripts/Controller/TreeController.cs` | 碰撞体变化通知导航网格刷新 |
