# 箱子系统锐评修正 - 验收指南

> **版本**: 2026-01-14
> **修正内容**: Code Reaper 锐评 Ⅰ-Ⅵ

---

## 前置准备

### 1. 确保编辑器配置正确

在开始测试前，请确认以下配置：

**PackagePanelTabsUI 组件**（在 PackagePanel 上）：
- [ ] `panelRoot` 已指向 PackagePanel 根 GameObject
- [ ] `topParent` 已指向 6_Top  
- [ ] `pagesParent` 已指向 Main
- [ ] `boxUIRoot` 已指向 BoxUIRoot（如果没有，需要创建）

**StorageData 资产**（每种箱子类型）：
- [ ] `boxUiPrefab` 已指向对应的 Box UI 预制体（Box_12/Box_24/Box_36/Box_48）

**ChestController 组件**（箱子预制体上）：
- [ ] 有 `PolygonCollider2D` 组件
- [ ] 有 `SpriteRenderer` 组件
- [ ] 4 个 Sprite 字段已配置（UnlockedClosed/UnlockedOpen/LockedClosed/LockedOpen）

### 2. 创建 BoxUIRoot（如果不存在）

如果 PackagePanel 下没有 BoxUIRoot：
1. 在 PackagePanel 下创建空 GameObject，命名为 `BoxUIRoot`
2. 设置 RectTransform 为全屏拉伸（Stretch-Stretch）
3. 在 PackagePanelTabsUI 组件中，将 `boxUIRoot` 字段指向这个新建的 GameObject

---

## 测试 Ⅰ：UI 互斥逻辑

### 测试步骤

1. **运行游戏**
2. **在场景中放置一个箱子**（或使用已有的箱子）
3. **右键点击箱子**

### 预期结果

- [ ] Box UI 出现并可见
- [ ] 背包的 Tab 栏（6_Top）被隐藏
- [ ] 背包的页面区域（Main）被隐藏
- [ ] Console 输出：`[PackagePanelTabsUI] 打开 Box UI: Box_XX, panelRoot.active=True`

### 验证方法（Hierarchy 窗口）

打开箱子后，在 Hierarchy 中检查：
```
Canvas
└── PackagePanel ← activeSelf = true ✅
    ├── 6_Top ← activeSelf = false ✅
    ├── Main ← activeSelf = false ✅
    └── BoxUIRoot
        └── Box_XX(Clone) ← activeSelf = true ✅
```

### 失败排查

如果 Box UI 不可见：
1. 检查 `boxUIRoot` 是否正确配置
2. 检查 Box UI 预制体的 RectTransform 是否正确
3. 检查 Console 是否有错误日志

---

## 测试 Ⅱ：PackagePanel 初始化对称性

### 测试步骤

1. **运行游戏**
2. **确保背包面板是关闭的**（按 Tab 关闭）
3. **直接右键点击箱子**（不要先打开背包）

### 预期结果

- [ ] Box UI 正常显示
- [ ] Down 区域显示背包内容（不是空白）
- [ ] Console 输出：`[BoxPanelUI] RefreshInventorySlots: slotCount=XX, startIndex=12`

### 验证方法

检查 Console 日志，应该看到：
```
[PackagePanelTabsUI] 打开 Box UI: Box_XX, panelRoot.active=True
[BoxPanelUI] RefreshInventorySlots: slotCount=24, startIndex=12
```

### 失败排查

如果 Down 区域为空：
1. 检查 Console 是否有 `RefreshInventorySlots 失败` 警告
2. 确认 InventoryService 已在场景中
3. 确认 InventoryPanelUI.EnsureBuilt() 被调用

---

## 测试 Ⅲ：箱子 Sprite 底部对齐

### 测试步骤

1. **运行游戏**
2. **在场景中放置一个箱子**
3. **记录箱子底部的 Y 坐标**（在 Inspector 中查看 Transform.position.y）
4. **右键打开箱子**
5. **再次检查箱子底部的 Y 坐标**
6. **关闭箱子 UI**
7. **再次检查箱子底部的 Y 坐标**

### 预期结果

- [ ] 箱子打开/关闭时，视觉上底部位置不变
- [ ] 箱子不会"跳动"或"位移"

### 验证方法

1. 在 Scene 视图中观察箱子
2. 开关箱子多次，确认底部始终贴地

### 失败排查

如果箱子跳动：
1. 检查 4 个 Sprite 的 Pivot 设置是否一致
2. 检查 Console 是否有 `ApplySpriteWithBottomAlign` 日志
3. 确认 `_anchorInitialized` 在 Awake 时被设置为 true

---

## 测试 Ⅳ：Collider + NavGrid 同步

### 测试步骤

1. **运行游戏**
2. **启用 NavGrid 调试显示**（如果有的话）
3. **在场景中放置一个箱子**
4. **观察 NavGrid 阻挡区域**
5. **右键打开箱子**
6. **再次观察 NavGrid 阻挡区域**

### 预期结果

- [ ] 箱子放置后，NavGrid 显示正确的阻挡区域
- [ ] 箱子打开后，阻挡区域随 Collider 形状更新
- [ ] Console 输出：`[ChestController] UpdateColliderShape: shapeCount=X`

### 验证方法

1. 使用 NavGrid 的 Gizmos 显示
2. 或者尝试让 NPC 寻路绕过箱子

### 失败排查

如果 NavGrid 不更新：
1. 检查 `PolygonCollider2D` 是否存在
2. 检查 Sprite 是否有 Physics Shape
3. 确认 `NavGrid2D.OnRequestGridRefresh` 事件已注册

---

## 测试 Ⅴ：Down 区域背包镜像

### 测试步骤

1. **运行游戏**
2. **在背包中放入一些物品**（确保索引 12-35 有物品）
3. **右键打开箱子**
4. **检查 Down 区域显示的物品**

### 预期结果

- [ ] Down 区域显示背包索引 12-35 的物品
- [ ] 物品图标和数量正确
- [ ] 可以拖拽物品到箱子（Up 区域）

### 验证方法

1. 对比背包面板（Tab 打开）和 Box UI 的 Down 区域
2. 确认显示的物品一致

### 失败排查

如果物品不显示：
1. 检查 `showDebugInfo` 是否开启
2. 查看 Console 中的 `Down[X] -> idx=XX, item=XXxX` 日志
3. 确认 InventorySlotUI.Bind() 被正确调用

---

## 测试 Ⅵ：互斥切换

### 测试步骤

1. **运行游戏**
2. **右键打开箱子**
3. **按 Tab 键打开背包**

### 预期结果

- [ ] Box UI 被关闭
- [ ] 背包面板正常显示
- [ ] 6_Top 和 Main 恢复可见

### 反向测试

1. **按 Tab 打开背包**
2. **右键点击箱子**

### 预期结果

- [ ] 背包面板的 6_Top 和 Main 被隐藏
- [ ] Box UI 正常显示

---

## 快速检查清单

### 编辑器配置
- [ ] PackagePanelTabsUI.boxUIRoot 已配置
- [ ] StorageData.boxUiPrefab 已配置（所有箱子类型）
- [ ] ChestController 有 PolygonCollider2D
- [ ] 箱子 Sprite 有 Physics Shape

### 运行时行为
- [ ] 右键箱子 → Box UI 可见
- [ ] 背包 Tab/Main 被隐藏
- [ ] Down 区域显示背包内容
- [ ] 箱子开关时底部不跳动
- [ ] Tab 键可以切换回背包

### Console 日志（正常情况）
```
[PackagePanelTabsUI] 打开 Box UI: Box_XX, panelRoot.active=True
[BoxPanelUI] RefreshInventorySlots: slotCount=XX, startIndex=12
[ChestController] 设置打开状态: True, ownership=Player, isLocked=False
[ChestController] UpdateColliderShape: shapeCount=1
[ChestController] 已请求 NavGrid 刷新
```

---

## 常见问题

### Q: Box UI 不显示
A: 检查 `boxUIRoot` 配置，确保 PackagePanel 的 panelRoot 是 active 的

### Q: Down 区域为空
A: 确保 InventoryService 存在，检查 `EnsurePanelOpenForBox()` 是否被调用

### Q: 箱子跳动
A: 检查 Sprite 的 Pivot 设置，确保 `_anchorInitialized` 正确初始化

### Q: NavGrid 不更新
A: 确保 PolygonCollider2D 存在，Sprite 有 Physics Shape

---

## 测试完成后

如果所有测试通过，请在 memory.md 中更新状态为"已验证"。

如果有问题，请记录具体的失败现象和 Console 日志，以便进一步排查。
