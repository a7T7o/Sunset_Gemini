# 需求文档

## 介绍

箱子系统是游戏中的存储容器功能模块，允许玩家在世界中放置、使用和管理箱子。箱子具有特殊的掉落机制（掉落后自动放置而非变为可拾取物品）、上锁系统（锁与钥匙的材质匹配机制）、以及独立的交互逻辑（推动、挖取、打开）。

## 术语表

- **箱子（Chest）**：可放置的存储容器世界物体，具有血量、归属、上锁状态等属性
- **ChestController**：挂载在箱子预制体上的控制脚本，管理箱子的所有交互逻辑
- **StorageData**：箱子的 ScriptableObject 数据类，继承自 PlaceableItemData
- **ChestMaterial**：箱子材质枚举（木质/铁质/特殊）
- **ChestOwnership**：箱子归属枚举（玩家所有/世界所有）
- **Box**：箱子交互UI面板，与 PackagePanel 同级，互斥显示
- **自动放置**：箱子掉落后自动在附近空位放置，不经过可拾取状态
- **交互距离**：玩家与箱子交互所需的最小距离，与放置系统一致

## 需求

### 需求 1

**用户故事：** 作为开发者，我希望扩展 StorageData 的列数限制，以便支持更大容量的箱子。

#### 验收标准

1. WHEN StorageData SO 在编辑器中配置时 THEN 系统 SHALL 允许 storageCols 字段设置为 1 到 15 的范围
2. WHEN StorageData 验证时 THEN 系统 SHALL 确保 storageCapacity 等于 storageRows × storageCols

### 需求 2

**用户故事：** 作为开发者，我希望 StorageData 支持箱子材质和血量配置，以便区分不同类型的箱子。

#### 验收标准

1. WHEN StorageData SO 创建时 THEN 系统 SHALL 包含 chestMaterial 字段用于指定箱子材质（木质/铁质/特殊）
2. WHEN StorageData SO 创建时 THEN 系统 SHALL 包含 maxHealth 字段用于指定箱子血量
3. WHEN 小木箱 SO 配置时 THEN 系统 SHALL 设置血量为 2、容量为 1×12=12 格
4. WHEN 大木箱 SO 配置时 THEN 系统 SHALL 设置血量为 3、容量为 2×12=24 格
5. WHEN 小铁箱 SO 配置时 THEN 系统 SHALL 设置血量为 4、容量为 3×12=36 格
6. WHEN 大铁箱 SO 配置时 THEN 系统 SHALL 设置血量为 5、容量为 4×12=48 格

### 需求 3

**用户故事：** 作为玩家，我希望箱子被丢弃或掉落时自动放置到附近空位，以便箱子始终以世界物体形式存在。

#### 验收标准

1. WHEN 玩家从背包丢弃箱子时 THEN 系统 SHALL 在丢弃位置附近搜索无碰撞体的空位
2. WHEN 怪物掉落箱子时 THEN 系统 SHALL 在掉落位置附近搜索无碰撞体的空位
3. WHEN 箱子掉落动画播放完成（1秒后）THEN 系统 SHALL 在找到的空位实例化箱子预制体
4. WHILE 箱子处于掉落动画状态 THEN 系统 SHALL 阻止箱子变为可拾取状态
5. WHEN 空位搜索时 THEN 系统 SHALL 使用螺旋搜索算法从掉落点向外扩展查找

### 需求 4

**用户故事：** 作为玩家，我希望只有镐子能够挖取箱子，以便箱子具有合理的破坏机制。

#### 验收标准

1. WHEN 镐子命中箱子且箱子为空时 THEN 系统 SHALL 对箱子造成等于镐子伤害值的伤害
2. WHEN 箱子血量降至零或以下时 THEN 系统 SHALL 销毁箱子并生成可拾取的箱子掉落物
3. WHEN 非镐子工具命中箱子时 THEN 系统 SHALL 不对箱子造成任何伤害
4. WHEN 镐子命中箱子且箱子内有物品时 THEN 系统 SHALL 不对箱子造成伤害而是触发推动逻辑

### 需求 5

**用户故事：** 作为玩家，我希望用镐子挖有物品的箱子时箱子被推开，以便我可以移动箱子位置。

#### 验收标准

1. WHEN 镐子命中有物品的箱子时 THEN 系统 SHALL 计算玩家当前朝向作为推动方向
2. WHEN 推动方向确定后 THEN 系统 SHALL 检测目标位置（当前位置 + 朝向 × 1单位）是否有碰撞体
3. IF 目标位置存在任何碰撞体（包括可拾取物品）THEN 系统 SHALL 取消推动操作
4. IF 目标位置无碰撞体 THEN 系统 SHALL 播放跳动动画并将箱子移动到目标位置

### 需求 6

**用户故事：** 作为玩家，我希望能够用锁道具对箱子上锁，以便保护箱子内的物品。

#### 验收标准

1. WHEN 玩家手持锁道具右键点击未上锁的箱子时 THEN 系统 SHALL 检查锁与箱子的材质是否匹配
2. IF 锁与箱子材质匹配（木锁配木箱、铁锁配铁箱）THEN 系统 SHALL 消耗锁道具并将箱子标记为已上锁且归属为玩家
3. IF 锁与箱子材质不匹配 THEN 系统 SHALL 显示提示"锁与箱子材质不匹配"
4. IF 箱子已经上锁 THEN 系统 SHALL 显示提示"箱子已上锁"

### 需求 7

**用户故事：** 作为玩家，我希望能够用钥匙打开场景中预置的上锁箱子，以便获取箱子内的物品。

#### 验收标准

1. WHEN 玩家手持钥匙右键点击上锁且归属为世界的箱子时 THEN 系统 SHALL 检查钥匙与箱子的材质是否匹配
2. IF 钥匙与箱子材质匹配 THEN 系统 SHALL 消耗钥匙并将箱子归属变更为玩家
3. WHEN 钥匙成功使用后 THEN 系统 SHALL 打开箱子UI面板
4. WHEN 玩家对自己上锁的箱子交互时 THEN 系统 SHALL 允许直接打开无需钥匙

### 需求 8

**用户故事：** 作为玩家，我希望右键点击箱子时能够自动导航到箱子附近并打开箱子UI，以便方便地与箱子交互。

#### 验收标准

1. WHEN 玩家右键点击箱子且距离大于交互距离时 THEN 系统 SHALL 触发自动导航到箱子附近
2. WHEN 玩家到达箱子交互距离内时 THEN 系统 SHALL 自动打开箱子UI面板
3. WHEN 玩家右键点击箱子且已在交互距离内时 THEN 系统 SHALL 直接打开箱子UI面板
4. WHEN 箱子交互距离判断时 THEN 系统 SHALL 使用与放置系统相同的交互距离值

### 需求 9

**用户故事：** 作为玩家，我希望箱子UI与背包面板互斥显示，以便界面清晰不混乱。

#### 验收标准

1. WHEN 箱子UI（Box）打开时 THEN 系统 SHALL 确保 PackagePanel 处于隐藏状态
2. WHEN PackagePanel 打开时 THEN 系统 SHALL 确保箱子UI（Box）处于隐藏状态
3. WHEN 玩家按下 ESC 键且箱子UI打开时 THEN 系统 SHALL 关闭箱子UI
4. WHEN 玩家按下背包快捷键（Tab/B/M等）且箱子UI打开时 THEN 系统 SHALL 关闭箱子UI并打开对应的 PackagePanel 页面

### 需求 10

**用户故事：** 作为玩家，我希望箱子UI显示箱子格子和背包格子两个区域，以便方便地在箱子和背包之间转移物品。

#### 验收标准

1. WHEN 箱子UI打开时 THEN 系统 SHALL 在上方区域（Up）显示箱子的存储格子
2. WHEN 箱子UI打开时 THEN 系统 SHALL 在下方区域（Down）显示玩家背包格子
3. WHEN 不同容量的箱子打开时 THEN 系统 SHALL 加载对应的UI预制体
4. WHEN 箱子UI关闭时 THEN 系统 SHALL 保存箱子内容物的变更
