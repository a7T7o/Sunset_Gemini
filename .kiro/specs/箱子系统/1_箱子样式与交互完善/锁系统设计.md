# é”ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

é”æ˜¯ç®±å­ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºä¿æŠ¤ç®±å­å†…å®¹ç‰©ã€‚æœ¬æ–‡æ¡£æè¿°é”çš„æ•°æ®ç»“æ„ã€ä½¿ç”¨è§„åˆ™å’Œå®ç°ç»†èŠ‚ã€‚

## æ•°æ®ç»“æ„

### KeyLockData

é”ä½¿ç”¨ `KeyLockData` ScriptableObjectï¼Œé€šè¿‡ `keyLockType` å­—æ®µåŒºåˆ†é’¥åŒ™å’Œé”ï¼š

```csharp
public class KeyLockData : ItemData
{
    public KeyLockType keyLockType;  // Key æˆ– Lock
    public ChestMaterial material;   // æè´¨ç±»å‹
    public float unlockChance;       // å¼€é”æ¦‚ç‡ï¼ˆä»…é’¥åŒ™æœ‰æ•ˆï¼‰
    public bool isSpecial;           // æ˜¯å¦ä¸ºç‰¹æ®Šé’¥åŒ™/é”
    public int targetChestId;        // ç‰¹æ®Šé’¥åŒ™/é”å¯¹åº”çš„ç®±å­ID
}
```

## é”çš„ç±»å‹

| ç±»å‹ | æè´¨ | ID | è¯´æ˜ |
|------|------|-----|------|
| æœ¨é” | Wood | 1410 | ç”¨äºæœ¨è´¨ç®±å­ä¸Šé” |
| é“é” | Iron | 1411 | ç”¨äºé“è´¨ç®±å­ä¸Šé” |
| ç‰¹æ®Šé” | Special | 1412+ | é¢„ç•™ç‰¹æ®Šç®±å­ |

## é”çš„ä½¿ç”¨è§„åˆ™

### ä¸Šé”æ¡ä»¶

1. **æè´¨åŒ¹é…**ï¼šé”çš„æè´¨å¿…é¡»ä¸ç®±å­æè´¨åŒ¹é…
   - æœ¨é”åªèƒ½ç”¨äºæœ¨è´¨ç®±å­
   - é“é”åªèƒ½ç”¨äºé“è´¨ç®±å­
   - ç‰¹æ®Šé”ç”¨äºç‰¹æ®Šç®±å­

2. **ç®±å­çŠ¶æ€**ï¼š
   - ç®±å­å¿…é¡»æœªä¸Šé”
   - ç®±å­ä¸èƒ½æ›¾ç»è¢«ä¸Šè¿‡é”ï¼ˆhasBeenLocked=falseï¼‰

3. **æ¶ˆè€—å“**ï¼šä½¿ç”¨åé”æ¶ˆå¤±ï¼Œç®±å­å˜ä¸ºä¸Šé”çŠ¶æ€

### ä¸Šé”æ•ˆæœ

1. **ç©å®¶åˆ¶ä½œçš„ç®±å­**ï¼š
   - ä¸Šé”åä¸éœ€è¦é’¥åŒ™å³å¯æ‰“å¼€
   - ä»ç„¶å¯ä»¥æŒ–å–å’Œç§»åŠ¨
   - é˜²æ­¢æ„å¤–æ“ä½œï¼ˆæœªæ¥å¤šäººæ¨¡å¼é˜²æ­¢ä»–äººæ‰“å¼€ï¼‰

2. **é‡å¤–ç”Ÿæˆçš„ç®±å­**ï¼š
   - ä¸Šé”åå½’å±å˜ä¸ºç©å®¶ï¼ˆownership = Playerï¼‰
   - å¯ä»¥æŒ–å–å’Œç§»åŠ¨
   - ä¸éœ€è¦é’¥åŒ™å³å¯æ‰“å¼€

### é™åˆ¶è§„åˆ™

1. **ä¸å¯å–ä¸‹**ï¼šé”ä¸€æ—¦ä½¿ç”¨æ— æ³•å–ä¸‹
2. **ä¸å¯é‡å¤ä¸Šé”**ï¼šæ‰€æœ‰ä¸Šè¿‡é”çš„ç®±å­ï¼ˆhasBeenLocked=trueï¼‰ä¸èƒ½å†æ¬¡ä¸Šé”
3. **æè´¨ä¸åŒ¹é…æç¤º**ï¼šå°è¯•ç”¨ä¸åŒ¹é…çš„é”ä¸Šé”æ—¶æ˜¾ç¤ºæç¤º

## é”ä¸é’¥åŒ™çš„åŒºåˆ«

| ç‰¹æ€§ | é’¥åŒ™ | é” |
|------|------|-----|
| **ç±»å‹** | KeyLockType.Key | KeyLockType.Lock |
| **å¼€é”æ¦‚ç‡** | 0.1-0.4ï¼ˆæ ¹æ®æè´¨ï¼‰ | 0ï¼ˆå›ºå®šï¼Œä¸ä½¿ç”¨ï¼‰ |
| **æè´¨åŒ¹é…** | æ— é™åˆ¶ï¼ˆä»»æ„é’¥åŒ™å¯å¼€ä»»æ„ç®±ï¼‰ | å¿…é¡»åŒ¹é…ç®±å­æè´¨ |
| **ä½¿ç”¨æ•ˆæœ** | æ¦‚ç‡å¼€é”ï¼ŒæˆåŠŸä¿ç•™ï¼Œå¤±è´¥æ¶ˆè€— | æ¶ˆè€—å“ï¼Œç®±å­å˜ä¸ºä¸Šé”çŠ¶æ€ |
| **IDèŒƒå›´** | 1420-1499 | 1410-1419 |
| **å †å æ•°é‡** | 99 | 99 |

## å®ç°ç»†èŠ‚

### ChestController æ–¹æ³•

```csharp
public enum LockResult
{
    Success,           // æˆåŠŸä¸Šé”
    AlreadyLocked,     // å·²ç»ä¸Šè¿‡é”
    MaterialMismatch,  // æè´¨ä¸åŒ¹é…
    InvalidLock        // æ— æ•ˆçš„é”
}

public LockResult TryLockByPlayer(KeyLockData lockData)
{
    // æ£€æŸ¥æ˜¯å¦å·²ä¸Šè¿‡é”
    if (hasBeenLocked)
        return LockResult.AlreadyLocked;
    
    // æ£€æŸ¥æè´¨åŒ¹é…
    if (lockData.material != storageData.material)
        return LockResult.MaterialMismatch;
    
    // ä¸Šé”
    isLocked = true;
    hasBeenLocked = true;
    
    // é‡å¤–ç®±å­ä¸Šé”åå˜ä¸ºç©å®¶å½’å±
    if (origin == ChestOrigin.WorldSpawned)
        ownership = ChestOwnership.Player;
    
    return LockResult.Success;
}
```

### UI äº¤äº’é€»è¾‘ï¼ˆå¾…å®ç°ï¼‰

åœ¨ `GameInputManager.TryOpenChest()` ä¸­ï¼š

```csharp
// æ£€æµ‹æ‰‹æŒç‰©å“
ItemStack heldItem = inventory.GetHeldItem();
if (heldItem.IsEmpty) return;

ItemData itemData = database.GetItemData(heldItem.itemId);
if (itemData is KeyLockData keyLockData)
{
    if (keyLockData.keyLockType == KeyLockType.Lock)
    {
        // å°è¯•ä¸Šé”
        LockResult result = chest.TryLockByPlayer(keyLockData);
        
        switch (result)
        {
            case LockResult.Success:
                inventory.RemoveItem(heldItem.itemId, 1);
                ShowMessage("ç®±å­å·²ä¸Šé”");
                break;
            case LockResult.AlreadyLocked:
                ShowMessage("ç®±å­å·²ä¸Šè¿‡é”");
                break;
            case LockResult.MaterialMismatch:
                ShowMessage("é”çš„æè´¨ä¸ç®±å­ä¸åŒ¹é…");
                break;
        }
    }
}
```

## æ‰¹é‡ç”Ÿæˆå·¥å…·

### ä½¿ç”¨æ–¹æ³•

1. æ‰“å¼€å·¥å…·ï¼š`Tools â†’ ğŸ“¦ æ‰¹é‡ç”Ÿæˆç‰©å“ SO`
2. é€‰æ‹©å¤§ç±»ï¼šå·¥å…·è£…å¤‡
3. é€‰æ‹©å°ç±»ï¼šLockData
4. è®¾ç½®é”æè´¨ï¼šWood / Iron / Special
5. è®¾ç½®IDå’Œåç§°
6. æ‹–å…¥ Sprite
7. ç‚¹å‡»ç”Ÿæˆ

### è¾“å‡ºè·¯å¾„

- é»˜è®¤è·¯å¾„ï¼š`Assets/111_Data/Items/Locks/`
- å‘½åæ ¼å¼ï¼š`Lock_{id}_{materialName}.asset`

### ç¤ºä¾‹é…ç½®

**æœ¨é”**ï¼š
- ID: 1410
- åç§°: æœ¨é”
- æè´¨: Wood
- æè¿°: ç”¨äºæœ¨è´¨ç®±å­ä¸Šé”

**é“é”**ï¼š
- ID: 1411
- åç§°: é“é”
- æè´¨: Iron
- æè¿°: ç”¨äºé“è´¨ç®±å­ä¸Šé”

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

1. **æè´¨åŒ¹é…æµ‹è¯•**ï¼š
   - æœ¨é”èƒ½å¦ç”¨äºæœ¨ç®±
   - æœ¨é”ä¸èƒ½ç”¨äºé“ç®±
   - é“é”èƒ½å¦ç”¨äºé“ç®±
   - é“é”ä¸èƒ½ç”¨äºæœ¨ç®±

2. **é‡å¤ä¸Šé”æµ‹è¯•**ï¼š
   - ä¸Šè¿‡é”çš„ç®±å­ä¸èƒ½å†æ¬¡ä¸Šé”
   - æç¤ºä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

3. **å½’å±è½¬ç§»æµ‹è¯•**ï¼š
   - é‡å¤–ç®±å­ä¸Šé”åå½’å±å˜ä¸ºç©å®¶
   - ç©å®¶ç®±å­ä¸Šé”åå½’å±ä¸å˜

4. **æŒ–å–æµ‹è¯•**ï¼š
   - ç©å®¶ä¸Šé”ç®±å­å¯ä»¥æŒ–å–
   - é‡å¤–ä¸Šé”ç®±å­ï¼ˆæœªå¼€é”ï¼‰ä¸èƒ½æŒ–å–

### è¾¹ç•Œæµ‹è¯•

1. ç©ºæ‰‹å³é”®ç®±å­
2. æ‰‹æŒéé”ç‰©å“å³é”®ç®±å­
3. æ‰‹æŒé”å³é”®éç®±å­ç‰©ä½“
4. ç®±å­å†…æœ‰ç‰©å“æ—¶ä¸Šé”
5. ç®±å­ä¸ºç©ºæ—¶ä¸Šé”

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Assets/YYY_Scripts/Data/Items/KeyLockData.cs` | é’¥åŒ™/é”æ•°æ®ç±»å‹ |
| `Assets/YYY_Scripts/World/Placeable/ChestController.cs` | ç®±å­æ§åˆ¶å™¨ |
| `Assets/Editor/Tool_BatchItemSOGenerator.cs` | æ‰¹é‡ç”Ÿæˆå·¥å…· |
| `Assets/YYY_Scripts/Controller/Input/GameInputManager.cs` | è¾“å…¥ç®¡ç†ï¼ˆå¾…å®ç°ï¼‰ |

## åç»­æ‰©å±•

1. **æ›´å¤šæè´¨**ï¼šçŸ³ã€é“œã€é’¢ã€é‡‘ç­‰æè´¨çš„é”
2. **ç‰¹æ®Šé”**ï¼šç”¨äºç‰¹å®šç®±å­çš„å”¯ä¸€é”
3. **é”çš„è€ä¹…åº¦**ï¼šé”å¯ä»¥è¢«ç ´åï¼ˆå¯é€‰ï¼‰
4. **é”çš„å“è´¨**ï¼šä¸åŒå“è´¨çš„é”æœ‰ä¸åŒæ•ˆæœï¼ˆå¯é€‰ï¼‰
