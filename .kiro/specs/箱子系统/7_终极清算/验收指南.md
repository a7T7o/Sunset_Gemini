# 验收指南 - 箱子系统终极清算

## 概述

本文档用于验收箱子系统终极清算的四大需求修复。

**代码修改已完成**，请按以下清单逐项验证。

---

## 验收清单

### 需求 A：导航与交互（P0-1）

**核心修复**：navToken 机制 + CompleteArrival + 距离复核

| # | 测试项 | 操作步骤 | 预期结果 | 通过 |
|---|--------|---------|---------|------|
| A1 | 右键远处箱子 A | 右键点击远处箱子 A | 玩家导航到 A 附近，打开 A 的内容 | [ ] |
| A2 | 关闭后右键另一个箱子 | 关闭 A → 右键远处箱子 B | 玩家导航到 B 附近，打开 B 的内容 | [ ] |
| A3 | 导航中切换目标 | 导航去 B 途中右键 C | 立刻改为去 C，到达后只开 C | [ ] |
| A4 | 近距离右键 | 站在箱子旁边右键该箱子 | 不导航，直接打开该箱子 | [ ] |
| A5 | 卡顿取消 | 让玩家卡在障碍物上 | 卡顿取消后不打开任何箱子 | [ ] |
| A6 | 手动移动打断 | 导航中按 WASD | 导航取消，不打开任何箱子 | [ ] |

**关键代码变更**：
- `PlayerAutoNavigator.cs`：navToken 机制、CompleteArrival()、ForceCancel()
- `GameInputManager.cs`：HandleInteractable() 调用 ForceCancel、TryInteractWithDistanceCheck()

---

### 需求 B：日志治理（P1）

**核心修复**：删除逐格日志、添加 showDebugInfo 开关、警告去重

| # | 测试项 | 操作步骤 | 预期结果 | 通过 |
|---|--------|---------|---------|------|
| B1 | 打开箱子日志 | 右键打开箱子 | ≤ 3 条日志 | [ ] |
| B2 | 点击槽位日志 | 点击箱子/背包槽位 | ≤ 2 条日志 | [ ] |
| B3 | 拖拽物品日志 | 拖拽物品到其他槽位 | ≤ 3 条日志 | [ ] |
| B4 | 排序日志 | 点击 SortUp/SortDown | ≤ 2 条日志 | [ ] |
| B5 | 关闭箱子日志 | 按 ESC 关闭箱子 | ≤ 1 条日志 | [ ] |
| B6 | 完整流程日志 | 打开→操作→关闭 | ≤ 15 条日志 | [ ] |
| B7 | 无逐格绑定噪音 | 打开箱子 | 无 `[BoxPanelUI] Up[X] -> ...` 日志 | [ ] |

**关键代码变更**：
- `BoxPanelUI.cs`：删除逐格日志、添加 showDebugInfo 开关
- `GameInputManager.cs`：showDebugInfo 开关、LogWarningOnce 去重
- `InventoryInteractionManager.cs`：注释高频日志
- `UIItemIconScaler.cs`：showDebugInfo 开关

---

### 需求 C：排序与刷新（P0-2）

**核心修复**：SortDown 使用 InventorySortService、事件订阅

| # | 测试项 | 操作步骤 | 预期结果 | 通过 |
|---|--------|---------|---------|------|
| C1 | SortDown 排序 | 打开箱子 → 点击 SortDown | Down 区重排，与背包面板一致 | [ ] |
| C2 | SortUp 排序 | 打开箱子 → 点击 SortUp | Up 区重排 | [ ] |
| C3 | 排序后 UI 刷新 | 排序后观察 UI | 立即刷新，无需手动操作 | [ ] |
| C4 | 排序一致性 | 对比 Box UI 和背包面板排序结果 | 结果完全一致 | [ ] |

**关键代码变更**：
- `BoxPanelUI.cs`：OnSortDownClicked() 使用 InventorySortService
- `BoxPanelUI.cs`：订阅 InventoryService.OnInventoryChanged

---

### 需求 D：Held 状态（P0-3）

**核心修复**：统一图标入口、隐藏时机

| # | 测试项 | 操作步骤 | 预期结果 | 通过 |
|---|--------|---------|---------|------|
| D1 | 单击选中 | 左键单击槽位 | 只选中，不拿起物品 | [ ] |
| D2 | 长按拖拽拿起 | 长按槽位并拖动 | 进入 Held 状态，图标出现 | [ ] |
| D3 | 图标跟随鼠标 | 拖拽物品移动鼠标 | 图标跟随鼠标 | [ ] |
| D4 | 四象限拖拽 | Up↔Up、Up↔Down、Down↔Down | 全部可用 | [ ] |
| D5 | 丢弃后图标消失 | 拖拽到垃圾桶/面板外 | 图标消失 | [ ] |
| D6 | 关闭 UI 后图标消失 | 拖拽中按 ESC | 图标消失 | [ ] |
| D7 | 导航开始图标消失 | Held 状态下右键远处箱子 | 图标消失，开始导航 | [ ] |

**关键代码变更**：
- `InventoryInteractionManager.cs`：ShowHeldIcon()、HideHeldIcon() 统一入口
- `BoxPanelUI.cs`：Close() 调用 HideHeldIcon()
- `GameInputManager.cs`：HandleInteractable() 取消 Held 状态

---

## 验收结果

### 通过标准

- 需求 A：6/6 项通过
- 需求 B：7/7 项通过
- 需求 C：4/4 项通过
- 需求 D：7/7 项通过

### 验收状态

- [ ] 全部通过
- [ ] 部分通过（请在下方记录问题）
- [ ] 未通过

### 问题记录

（如有问题，请在此记录）

---

## 已知限制

1. **showDebugInfo 默认关闭**：如需调试，请在 Inspector 中开启对应组件的 showDebugInfo
2. **警告去重**：同类警告只首次打印，重启后重置
3. **Hotbar 是背包的一部分**：排序对全部 36 个槽位执行

---

## 修改文件清单

| 文件 | 修改内容 |
|------|---------|
| `PlayerAutoNavigator.cs` | navToken 机制、CompleteArrival、ForceCancel |
| `GameInputManager.cs` | ForceCancel、距离复核、showDebugInfo、警告去重 |
| `BoxPanelUI.cs` | SortDown 使用 InventorySortService、事件订阅、日志清理 |
| `InventoryInteractionManager.cs` | 统一 Held 图标接口、日志清理 |
| `UIItemIconScaler.cs` | showDebugInfo 开关 |

