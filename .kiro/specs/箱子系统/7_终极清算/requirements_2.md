# 需求文档 - 箱子系统终极清算（修订版 v2）

## 范围与不变项

**本轮目标**：修复导航错乱、日志噪音、排序不刷新/不一致、Held 不出现 四大问题，恢复稳定可用。

**不在本轮范围**：装备栏逻辑变更、UI 皮肤重做、物品规则变更。

---

## 术语表

| 术语 | 定义 |
|------|------|
| Navigator | 右键自动导航系统（PlayerAutoNavigator） |
| BoxPanelUI | 箱子 UI（位于 PackagePanel 内） |
| Held 状态 | 物品被"拿起/拖拽"并跟随鼠标显示 |
| Down | 箱子 UI 下半区，镜像背包全部 36 个槽位（0..35） |
| Up | 箱子 UI 上半区，箱子内容 |
| Hotbar | 快捷栏，UI 上引用背包第一行（0..11）进行展示，数据是背包的一部分 |
| IInteractable | 可交互物体接口 |
| 交互距离 | 目标碰撞体底部中心与玩家碰撞体中心的二维距离 |

---

## 前置规范：Down 区镜像

### Down-1 索引范围

Down 区镜像背包全部 36 个槽位（0..35）。Hotbar 只是 UI 上引用第一行内容进行展示，数据本身都是背包的一部分。

### Down-2 排序范围

背包排序对全部 36 个槽位（0..35）执行，包括 Hotbar 区域。

---

## 前置规范：距离度量

### 距离锚点

- **目标点**：目标碰撞体底部中心（`collider.bounds.center.x, bounds.min.y`）；无碰撞体时退化为 `Transform.position`
- **玩家点**：玩家碰撞体中心（`playerCollider.bounds.center`）

---

## 需求 A：右键导航与交互（无错箱、无越距）

### A-1 到达才可交互

系统**必须仅在**"玩家真实到达目标且玩家与目标的二维距离 ≤ 目标的交互距离"时才允许触发开箱/交互。

任何"被取消/被打断/卡顿重试失败/切换目标"等非到达场景，**必须不触发交互**。

### A-1a 禁止项（取消/失败场景）

**禁止**在以下任何情况下触发交互回调：
- 导航被取消（Cancel/ForceCancel）
- 卡顿检测失败（重试 N 次后放弃）
- 玩家移动打断
- 路径重建失败
- 终点不可走且无法找到替代点

### A-1b 终点不可走处理

若点击位置终点不可走，系统可选择最近可走点；若最终仍不可达，**必须不交互**。

### A-2 导航切换一致性

在导航途中右键新的箱子，系统**必须立即转向新目标**；到达后**只允许打开新目标**，不得执行旧目标的交互。

### A-3 统一入口

当点击命中 IInteractable 时，交互**必须统一经由**"导航→到达→交互"的同一入口完成。

**禁止**任何绕过统一入口的"直接开箱"，包括 Tag/Layer fallback 分支。

### A-4 Fallback 行为

若点击处没有 IInteractable，仅允许"导航到点击位置"，不得打开任何 UI。

### A-验收

- [ ] 右键远处 A → 导航到 A 后开 A；关闭 A → 右键远处 B → 导航到 B 后开 B
- [ ] 导航去 B 途中右键 C → 立刻改为去 C，到达后只开 C
- [ ] 近距离右键箱子 → 不导航，直接开该箱子
- [ ] 卡顿取消/玩家手动取消后 → 不打开任何箱子
- [ ] 终点不可走且无替代点 → 不打开任何箱子

---

## 需求 B：日志治理（默认安静，可开关）

### B-1 日志预算

一次"打开 → 操作 → 关闭"的完整流程，默认日志条数 **≤ 15**。

**预算统计口径**：
- 按"默认开关状态"统计（`showDebugInfo=false`）
- Debug/Info 级别计入预算
- Warning/Error 不计入预算，但必须去重（同类只首次打印）

### B-2 高频静默

高频函数（例如 Refresh/Bind/图标缩放）**默认禁止输出详细日志**。

**高频静默类（示例）**：
- `InventorySlotUI.Refresh`
- `UIItemIconScaler.UpdateScale`
- `BoxPanelUI.BindChestSlotData` 每格日志

### B-3 开关规范

仅在 `showDebugInfo=true`（或等效全局开关）时允许输出导航距离等诊断信息；**默认必须为 false**。

### B-4 禁止项

**禁止**逐格绑定日志（如 `[BoxPanelUI] Up[i] → item=-1x0` 这类输出）。

### B-验收

- [ ] 打开 ≤3、点击 ≤2、拖拽 ≤3、排序 ≤2、关闭 ≤1，完整流程 ≤15
- [ ] 无逐格绑定噪音
- [ ] Warning/Error 去重（同类只首次打印）

---

## 需求 C：排序与刷新一致性（Box 与背包一致）

### C-1 Down 排序一致

BoxPanelUI 的 SortDown **必须与"背包 UI 的排序结果"一致**：
- 对全部 36 个槽位（0..35）执行排序
- 合并相同物品堆叠
- 空位归尾
- 按优先级排序（工具 > 武器 > 可放置 > 种子 > 消耗品 > 材料 > 其他）

以"背包 UI 的排序规则与结果"为对齐基准，使用 `InventorySortService.SortInventory()`。

### C-2 即时刷新

SortDown/SortUp 完成后，系统**必须立即刷新对应区域 UI**；不得需要手动刷新。

### C-3 事件完整性

排序完成后**必须触发相应的库存变化事件**；BoxPanelUI 必须订阅背包与箱子各自事件并正确刷新。

### C-验收

- [ ] Box UI → SortDown 后 Down 区重排、与背包面板行为一致
- [ ] SortUp 重排 Up 区
- [ ] 操作后 UI 立即刷新

---

## 需求 D：Held 状态（单击选中、长按拖拽拿起、图标统一）

### D-1 触发模型

- **无修饰左键单击**：只选中，不拿起
- **长按并拖动**：当"按住时长 ≥ 0.15s 或移动距离 ≥ 5px"时进入 Held 状态

### D-2 图标统一

Held 图标显示/隐藏**必须通过单一统一的对外接口完成**（统一入口），禁止各自组件直接操作显示组件。

背包与箱子两条路径的图标样式与行为**必须一致**，随鼠标跟随。

### D-2a 隐藏时机规范

Held 图标**必须**在以下时机隐藏：
- EndDrag（拖拽结束）
- Cancel（取消操作）
- 丢弃成功
- UI 关闭/切换
- 导航开始（避免悬空图标）

### D-3 跨容器拖拽

四象限拖拽（Up↔Up、Up↔Down、Down↔Down）行为保持既有规则（空位放置、相同堆叠、不同交换）；垃圾桶/面板外丢弃保持既有规则。

### D-验收

- [ ] 单击仅选中
- [ ] 长按拖拽进入 Held，图标出现且跟随鼠标
- [ ] 四象限拖拽与丢弃全部可用

---

## 禁止与边界

1. **禁止**任何"取消/失败/切换"情况下触发开箱
2. **禁止**在无 IInteractable 的点击下打开 UI
3. **禁止**在默认模式下输出 per-slot 或 Refresh 细节日志

---

## 验收清单（汇总）

| 类别 | 验收项 |
|------|--------|
| 导航与交互 | A 全部通过 |
| 日志 | B 全部通过（逐格日志为 0） |
| 排序 | C 全部通过（与背包结果一致且即时刷新） |
| Held | D 全部通过（单击选中、长按拖拽、图标一致） |

---

## 交付要求

本轮仅提交：功能变更 + 验收结果（按 A/B/C/D 分项），以及日志开关默认值与预算计数截图或说明。

**不接受设计/代码细节写入本文件**；实现放入 `design.md` 与 `tasks.md`。
