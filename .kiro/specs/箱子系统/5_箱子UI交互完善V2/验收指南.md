# 箱子 UI 交互完善 V2 - 验收指南

## 功能验收清单

### P0-1 UI 互斥与导航闭环

- [ ] BoxOpen → Tab → 背包页面出现、Box 关闭
- [ ] BoxOpen → B/M/L/O → 对应页面出现、Box 关闭
- [ ] NoPanel → 右键远处箱子 → 先导航后开 UI
- [ ] BoxOpen → 右键另一个远处箱子 → 先关闭 Box，导航后切换 UI
- [ ] BoxOpen → ESC → 返回 NoPanel（不打开背包）

### P0-3 _database 防御性修复

- [ ] 打开任意箱子，控制台无 "BindChestSlotData 失败" 警告
- [ ] Up 区显示的是箱子内容，不是背包内容
- [ ] 箱子物品图标正常显示

### P0-2 跨容器拖拽

- [ ] Up → Up（箱子内拖拽）：物品交换/合并正常
- [ ] Up → Down（箱子到背包）：物品转移正常
- [ ] Down → Up（背包到箱子）：物品转移正常
- [ ] Down → Down（背包内拖拽）：物品交换/合并正常
- [ ] 拖拽到空槽位：直接放置
- [ ] 拖拽到相同物品：堆叠（不超过最大堆叠数）
- [ ] 拖拽到不同物品：交换
- [ ] 拖拽取消（拖到空白处）：返回源槽位

### P0-4 Sort 事件触发

- [ ] 点击 Sort Up → 箱子区域立即重排显示
- [ ] 点击 Sort Down → 背包区域立即重排显示

### P1 日志规范

- [ ] 打开箱子 UI：≤ 3 行日志
- [ ] 点击槽位：≤ 2 行日志
- [ ] 拖拽物品：≤ 3 行日志
- [ ] Sort 操作：≤ 2 行日志
- [ ] 关闭箱子 UI：≤ 1 行日志
- [ ] 无重复错误日志

---

## 测试步骤

### 测试 1：UI 互斥与导航

1. 进入游戏，确保场景中有多个箱子
2. 右键点击近处箱子 A，打开箱子 UI
3. 按 Tab 键，验证：Box 关闭，背包打开
4. 按 Tab 键关闭背包
5. 右键点击近处箱子 A，打开箱子 UI
6. 按 B 键，验证：Box 关闭，配方页面打开
7. 按 Tab 键关闭背包
8. 右键点击远处箱子 B，验证：先导航到箱子 B，到达后打开箱子 UI
9. 右键点击远处箱子 C，验证：关闭箱子 B 的 UI，导航到箱子 C，到达后打开箱子 C 的 UI
10. 按 ESC 键，验证：返回 NoPanel 状态

### 测试 2：跨容器拖拽

1. 打开箱子 UI
2. 在箱子中放入一些物品
3. 从箱子拖拽物品到背包空槽位，验证：物品转移成功
4. 从背包拖拽物品到箱子空槽位，验证：物品转移成功
5. 从箱子拖拽物品到背包相同物品槽位，验证：堆叠成功
6. 从箱子拖拽物品到背包不同物品槽位，验证：交换成功
7. 在箱子内拖拽物品到另一个槽位，验证：交换/堆叠成功
8. 拖拽物品到空白处释放，验证：返回源槽位

### 测试 3：Sort 功能

1. 打开箱子 UI
2. 在箱子中放入多种物品（乱序）
3. 点击 Sort Up 按钮，验证：箱子物品按 ID 排序
4. 在背包中放入多种物品（乱序）
5. 点击 Sort Down 按钮，验证：背包物品按 ID 排序

---

## 已知限制

1. **Shift/Ctrl 快速转移**：暂未实现，后续迭代
2. **背包→箱子拖拽（通过 Manager）**：当背包槽位使用 InventoryInteractionManager 拖拽时，无法直接拖到箱子槽位（会显示警告）。需要使用 SlotDragContext 方式拖拽。
3. **装备槽位**：装备槽位的拖拽逻辑保持不变，仍通过 InventoryInteractionManager 处理

---

## 修改文件清单

| 文件 | 修改内容 |
|------|---------|
| `BoxPanelUI.cs` | 新增 `EnsureDatabaseReference()` 方法 |
| `GameInputManager.cs` | 修改 `HandlePanelHotkeys()` 和 `HandleRightClickAutoNav()` |
| `SlotDragContext.cs` | 新建文件 |
| `InventorySlotInteraction.cs` | 重写，支持跨容器拖拽 |
| `UIItemIconScaler.cs` | 移除高频日志 |
| `InventorySlotUI.cs` | 移除点击日志 |
